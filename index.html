<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=1.0, minimum-scale=1.0, target-densitydpi=device-dpi">
  <title>ä¹ä¸ç”Ÿå­˜ - å¡ç‰Œç”Ÿå­˜æ¸¸æˆ</title>
  <!-- Tailwind CSS v3 - Production Build -->
  <!-- å·²ç§»é™¤å¤–éƒ¨CDNå¼•ç”¨ï¼Œæ”¹ä¸ºæœ¬åœ°ä½¿ç”¨ -->
  <style>
    /* Tailwind åŸºç¡€æ ·å¼æ›¿ä»£ */
    .flex { display: flex; }
    .justify-center { justify-content: center; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .flex-col { flex-direction: column; }
    .flex-wrap { flex-wrap: wrap; }
    .w-full { width: 100%; }
    .h-full { height: 100%; }
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .fixed { position: fixed; }
    .grid { display: grid; }
    .hidden { display: none; }
    .block { display: block; }
    .inline-block { display: inline-block; }
    .overflow-hidden { overflow: hidden; }
    .overflow-auto { overflow: auto; }
    .cursor-pointer { cursor: pointer; }
    .select-none { user-select: none; }
    .pointer-events-none { pointer-events: none; }
    .opacity-0 { opacity: 0; }
    .opacity-50 { opacity: 0.5; }
    .opacity-100 { opacity: 1; }
    .transition { transition: all 0.3s ease; }
    .transition-all { transition: all 0.3s ease; }
  </style>
  <!-- Font Awesome -->
  
  <!-- åŠ è½½è‡ªå®šä¹‰å­—ä½“ -->
  <style>
    @font-face {
      font-family: 'HuiWenMingChaoTi';
      src: url('å­—ä½“/æ±‡æ–‡æ˜æœä½“.otf') format('opentype');
    }
  </style>

  <!-- GSAP åŠ¨ç”»åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <!-- Tailwind é…ç½® -->
  <!-- Tailwindé…ç½® -->
  <script>
    // æ˜¾ç¤ºé’±å¸ä¸è¶³å¼¹çª—
    function showNoMoneyModal() {
      const modal = document.createElement('div');
      modal.className = 'no-money-modal active';
      modal.innerHTML = `
        <div class="no-money-modal-content ink-border">
          <h2 class="no-money-modal-title ink-text">é’±å¸ä¸è¶³</h2>
          <div class="ink-decoration">
            <p class="no-money-modal-text">ä½ è¿˜æ²¡æœ‰10ä¸ªé’±å¸ï¼Œæ— æ³•è·å¾—çº¿ç´¢</p>
          </div>
          <div class="no-money-modal-button ink-button ink-button-primary" id="closeNoMoneyModal">å…³é—­</div>
        </div>
      `;

      document.body.appendChild(modal);

      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .no-money-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

  .no-money-modal.active {
          opacity: 1;
          pointer-events: auto;
        }
        /* çº¢è‰²è¾¹æ¡†é˜´å½±è­¦ç¤ºæ ·å¼ */
        .garbage-grid-item.danger-tip {
          box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3);
          border: 3px solid red;
          animation: danger-pulse 1.5s infinite;
          z-index: 10;
        }

/* å±é™©è­¦ç¤ºåŠ¨ç”»æ•ˆæœ */
        @keyframes danger-pulse {
          0% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3); }
          50% { box-shadow: 0 0 15px 5px red, inset 0 0 15px 5px rgba(255, 0, 0, 0.5); }
          100% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3); }
        }

/* çŠ¶æ€æ¡†è­¦å‘Šè„‰å†²åŠ¨ç”» */
        @keyframes pulse {
          0% { box-shadow: 0 0 15px rgba(229, 62, 62, 0.8); }
          50% { box-shadow: 0 0 25px rgba(229, 62, 62, 1); }
          100% { box-shadow: 0 0 15px rgba(229, 62, 62, 0.8); }
        }

.no-money-modal-content {
          background-color: #FFFDF7;
          padding: 2rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          width: 300px;
          text-align: center;
          border-radius: 0.25rem;

.no-money-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #5D4037;
          margin-bottom: 1rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.no-money-modal-text {
          color: #7D6E63;
          margin-bottom: 1.5rem;
          line-height: 1.5;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.no-money-modal-button {
          background-color: #8D6E63;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          display: inline-block;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.no-money-modal-button:hover {
          background-color: #6D4C41;
        }
      `;

document.head.appendChild(style);

// å…³é—­æŒ‰é’®äº‹ä»¶
      const closeNoMoneyModal = document.getElementById('closeNoMoneyModal');
      if (closeNoMoneyModal) {
        closeNoMoneyModal.addEventListener('click', function() {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
            }
            if (style.parentNode) {
              if (style.parentNode === document.head) {
        style.parentNode.removeChild(style);
      }
            }
          }, 300);
        });
      }

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        }
      });
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
      }
      .card-border {
        border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4"><path d="M0 0h4v4H0z" fill="none" stroke="%23A0AEC0" stroke-width="1"/></svg>') 1 repeat;
      }
      .ink-splash {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="40" fill="rgba(160, 174, 192, 0.1)"/></svg>');
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
      }
      .scroll-bg {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path d="M0 0h20v20H0z" fill="none" stroke="%23A0AEC0" stroke-width="1" stroke-dasharray="2,2"/></svg>');
        background-repeat: repeat;
      }
      .card-drag {
        cursor: grab;
      }
      .card-drag:active {
        cursor: grabbing;
      }
      .card-stack {
        position: relative;
      }
      .card-stack > div {
        position: absolute;
        transition: all 0.3s ease;
      }
      .card-stack > div:nth-child(1) { transform: translate(0, 0) rotate(0deg); z-index: 1; }
      .card-stack > div:nth-child(2) { transform: translate(8px, 8px) rotate(2deg); z-index: 2; }
      .card-stack > div:nth-child(3) { transform: translate(16px, 16px) rotate(4deg); z-index: 3; }
      .card-stack > div:nth-child(4) { transform: translate(24px, 24px) rotate(6deg); z-index: 4; }
      .card-stack > div:nth-child(5) { transform: translate(32px, 32px) rotate(8deg); z-index: 5; }
      .card-stack > div:nth-child(n+6) { transform: translate(40px, 40px) rotate(10deg); z-index: 6; }
    }
  </style>
  <style>
    /* å…¨å±€æ‹–æ‹½ç‰¹æ•ˆæ ·å¼ - å†œç”°ç§å­æ‹–æ‹½ */
    /* æ‹–æ‹½ç‰¹æ•ˆæ ·å¼ */
    .drag-trail {
      position: fixed;
      pointer-events: none;
      border-radius: 50%;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 9998;
      animation: trail-fade 0.5s ease-out forwards;
    }

    @keyframes trail-fade {
      0% {
        opacity: 0.6;
        transform: scale(1);
      }
      100% {
        opacity: 0;
        transform: scale(0.3);
      }
    }

    /* å…‰ç‚¹ç²’å­æ•ˆæœ - å†œç”°æ‹–æ‹½ä¸“ç”¨ */
    .particle.drag-particle {
      position: fixed;
      pointer-events: none;
      border-radius: 50%;
      z-index: 9997;
      animation: particle-float 1s ease-out forwards;
    }

    @keyframes particle-float {
      0% {
        opacity: 0.8;
        transform: translate(0, 0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0.1);
      }
    }

    /* å¯æ”¾ç½®æç¤ºæ•ˆæœ */
    .can-place-hint {
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
      animation: can-place-pulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes can-place-pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
      }
      100% {
        transform: scale(1.1);
        box-shadow: 0 0 25px rgba(76, 175, 80, 0.8);
      }
    }

    /* å¸é™„æ•ˆæœ */
    .snap-indicator {
      position: fixed;
      pointer-events: none;
      border: 2px dashed rgba(76, 175, 80, 0.6);
      border-radius: 8px;
      z-index: 9996;
      animation: snap-pulse 1s ease-in-out infinite;
    }

    @keyframes snap-pulse {
      0%, 100% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
    }

    /* è‡ªå®šä¹‰æ‹–æ‹½å…‰æ ‡æ ·å¼ */
    .seed-drag-cursor {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transition: transform 0.1s ease;
    }

    /* å†œç”°æ”¾ç½®åŠ¨ç”»æ—¶çš„è¾¹æ¡†æ ·å¼ */
    .farmland-cell.placing .crop-image {
      border: 3px solid #6D4C41;
      border-radius: 8px;
    }

    /* å†œç”°äº¤äº’å¢å¼ºæ ·å¼ */
    .farmland-cell.highlight {
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.8), 0 0 40px rgba(76, 175, 80, 0.4) !important;
      transform: scale(1.05) !important;
      border-color: rgba(76, 175, 80, 0.8) !important;
      z-index: 1000 !important;
    }

    /* èƒŒåŒ…åˆ°åœ°é¢çš„å½±å­å½’æ‹¢ç‰¹æ•ˆ */
    .card-shadow-merge {
      position: fixed !important;
      pointer-events: none !important;
      z-index: 9999 !important;
      opacity: 0.9;
      animation: shadow-merge-animation 0.5s ease-out forwards;
      border: 2px solid #8D6E63 !important;
      border-radius: 12px !important;
      box-shadow:
        0 0 15px rgba(141, 110, 99, 0.3),
        0 4px 8px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.3) !important;
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%) !important;
    }

    @keyframes shadow-merge-animation {
      0% {
        opacity: 0.9;
        transform: translate(0, 0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(var(--target-x), var(--target-y)) scale(0.2);
      }
    }

    /* åœ°é¢åˆ°èƒŒåŒ…çš„å½±å­å½’æ‹¢ç‰¹æ•ˆ */
    .ground-shadow-merge {
      position: fixed !important;
      pointer-events: none !important;
      z-index: 9999 !important;
      opacity: 0.9;
      animation: ground-shadow-merge-animation 0.5s ease-out forwards;
      border: 2px solid #8D6E63 !important;
      border-radius: 12px !important;
      box-shadow:
        0 0 15px rgba(141, 110, 99, 0.3),
        0 4px 8px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.3) !important;
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%) !important;
    }

    @keyframes ground-shadow-merge-animation {
      0% {
        opacity: 0.9;
        transform: translate(0, 0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(var(--target-x), var(--target-y)) scale(0.2);
      }
    }

    /* è„‰å†²å…‰æ™•æ•ˆæœ */
    .farmland-cell.pulse-glow {
      animation: pulse-glow 1.5s infinite !important;
    }

    @keyframes pulse-glow {
      0% {
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.8), 0 0 40px rgba(76, 175, 80, 0.4) !important;
      }
      50% {
        box-shadow: 0 0 30px rgba(76, 175, 80, 1), 0 0 60px rgba(76, 175, 80, 0.6) !important;
      }
      100% {
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.8), 0 0 40px rgba(76, 175, 80, 0.4) !important;
      }
    }

    /* è‡ªå®šä¹‰æ‹–æ‹½å…‰æ ‡æ ·å¼ */
    .seed-drag-cursor {
      position: fixed !important;
      pointer-events: none !important;
      z-index: 9999 !important;
      transition: transform 0.1s ease !important;
      display: block !important;
    }
    
    /* æ•°é‡æŒ‡ç¤ºå™¨æ ·å¼ */
    .seed-count-indicator {
      position: absolute !important;
      bottom: -5px !important;
      left: -5px !important;
      background-color: #E53E3E !important;
      color: white !important;
      border-radius: 50% !important;
      width: 18px !important;
      height: 18px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 10px !important;
      font-weight: bold !important;
      border: 2px solid white !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
  </style>
  <style>
    /* ç§»é™¤å¤–éƒ¨å­—ä½“å¼•ç”¨ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“ */

body {
        font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif;
        background-color: #F7FAFC;
        /* ä½¿ç”¨ä¼ªå…ƒç´ åˆ›å»ºè™šåŒ–èƒŒæ™¯ */
        position: relative;
        overflow-x: hidden;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('UI/èƒŒæ™¯6.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: blur(1px); /* 10% è™šåŒ–æ•ˆæœ */
        z-index: -1;
    }

.card {
      transition: all 0.3s ease;
      border-radius: 12px; /* å¼§å½¢åœ†è§’ */
      overflow: visible;
      border: 2px solid #8D6E63; /* æ£•è‰²è¾¹æ¡† */
      box-shadow:
        0 0 15px rgba(141, 110, 99, 0.3), /* æŸ”å…‰å¤–å‘å…‰ */
        0 4px 8px rgba(139, 69, 19, 0.2), /* å¸¸è§„é˜´å½± */
        inset 0 1px 2px rgba(255, 255, 255, 0.3); /* å†…å‘å…‰ */
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%);
      /* ç¡®ä¿è§’è½å…ƒç´ ä¸è¢«è£å‰ª */
      clip-path: none;
      -webkit-mask-image: none;
      mask-image: none;
    }

.card:hover {
      transform: translateY(-5px);
      box-shadow: 
        0 0 20px rgba(141, 110, 99, 0.5), /* æ›´å¼ºçš„æŸ”å…‰ */
        0 6px 12px rgba(139, 69, 19, 0.3),
        inset 0 1px 3px rgba(255, 255, 255, 0.4);
      border-radius: 14px; /* æ‚¬åœæ—¶åœ†è§’ç¨å¾®å¢å¤§ */
    }

.card.resource {
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%);
      border: 2px solid #8D6E63;
    }

.card.location {
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%);
      border: 2px solid #8D6E63;
    }

.location-details {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }

.resource-type, .danger-level, .action-cost {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

.danger-level.low {
      color: #38A169;
    }

.danger-level.medium {
      color: #ECC94B;
    }

.danger-level.high {
      color: #E53E3E;
    }

.location-card.current {
      border-color: #38A169;
      box-shadow: 0 0 15px rgba(56, 161, 105, 0.5);
    }

.card.status {
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%);
      border: 2px solid #8D6E63;
    }

.card.action {
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%);
      border: 2px solid #8D6E63;
    }

.card-image {
      width: 100%;
      height: 120px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-color: #E2E8F0;
      display: block;
    }

    /* å½“æœ‰èƒŒæ™¯å›¾ç‰‡æ—¶ï¼Œç§»é™¤èƒŒæ™¯è‰² */
    .card-image[style*="background-image"],
    .card-image[style*="background:"] {
      background-color: transparent !important;
    }

.location-card .card-image {
      height: 60px;
    }

.action-card .card-image {
      height: 60px;
    }

    .action-card .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
      padding: 0.25rem;
      box-sizing: border-box;
    }

    .action-card .card-title {
      text-align: center;
      margin: 0;
      font-weight: normal;
      font-size: clamp(0.8rem, 2vw, 1.2rem); /* è‡ªé€‚åº”å­—ä½“å¤§å° */
      line-height: 1.2;
      width: 100%;
      display: -webkit-box;
      -webkit-line-clamp: 3; /* æœ€å¤šæ˜¾ç¤º3è¡Œ */
      -webkit-box-orient: vertical;
      line-clamp: 3; /* æ ‡å‡†å±æ€§ */
      display: -webkit-box; /* å…¼å®¹æ—§ç‰ˆæœ¬ */
      overflow: hidden;
      word-break: break-all; /* é•¿å•è¯æ¢è¡Œ */
    }

    /* æ ¹æ®å­—ç¬¦æ•°é‡è‡ªé€‚åº”å­—ä½“å¤§å° */
    .action-card .card-title[data-chars="1"] {
      font-size: clamp(1.2rem, 3vw, 1.8rem); /* å•å­—æ›´å¤§ */
    }
    .action-card .card-title[data-chars="2"] {
      font-size: clamp(1rem, 2.5vw, 1.5rem); /* ä¸¤å­—é€‚ä¸­ */
    }
    .action-card .card-title[data-chars="3"] {
      font-size: clamp(0.9rem, 2vw, 1.3rem); /* ä¸‰å­—æ­£å¸¸ */
    }
    .action-card .card-title[data-chars="4"] {
      font-size: clamp(0.8rem, 1.8vw, 1.1rem); /* å››å­—ç¨å° */
    }
    .action-card .card-title[data-chars="5"] {
      font-size: clamp(0.7rem, 1.6vw, 1rem); /* äº”å­—æ›´å° */
    }
    .action-card .card-title[data-chars="6"] {
      font-size: clamp(0.65rem, 1.4vw, 0.9rem); /* å…­å­—æœ€å° */
    }

.card-content {
      padding: 0.75rem;
    }

.card-title {
      font-weight: normal;
      font-size: 1.2rem;
      margin-bottom: 0.25rem;
    }

.map-card-title {
      font-weight: normal;
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
      text-align: center;
    }

/* èµ„æºå¡ç‰Œç‰¹å®šæ ·å¼ - ç¼©å°å°ºå¯¸ä»¥é€‚åº”æ›´å¤šå¡ç‰Œ */
    .resource-card {
      width: 90px;
      height: 120px;
      display: flex;
      flex-direction: column;
      position: relative;
    }

.resource-card .card-image {
      height: 90px;
      flex: none;
      position: relative;
    }

.resource-card .card-content {
      height: 25px;
      flex-shrink: 0;
      position: relative;
    }

.resource-card .card-title {
      font-size: 0.85rem;
      line-height: 1.2;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      text-align: left;
      padding-right: 40px; /* ä¸ºæ•°é‡å¾½ç« ç•™å‡ºç©ºé—´ */
    }

/* ç«–ç€æ˜¾ç¤ºçš„è€ä¹…åº¦æ¡ */
.resource-card .card-durability {
      position: absolute;
      right: 4px;
      top: 34px;
      width: 4px;
      height: 45px;
      background-color: #E2E8F0;
      border-radius: 2px;
      overflow: hidden;
      z-index: 10;
    }

.resource-card .card-durability .durability-bar {
      width: 100%;
      background-color: #38A169;
      position: absolute;
      left: 0;
      bottom: 0;
      border-radius: 0 0 2px 2px;
      transition: height 0.3s ease;
    }

.card-description {
      font-size: 0.75rem;
      color: #4A5568;
    }

.card-footer {
      padding: 0.25rem 0.5rem;
      border-top: 1px solid #E2E8F0;
      font-size: 0.75rem;
      color: #4A5568;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

.resource-count {
      background-color: #E2E8F0;
      border-radius: 9999px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: normal;
    }

.progress-bar {
      height: 4px;
      background-color: transparent;
      border-radius: 9999px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: #8D6E63;
      border-radius: 9999px;
      transition: width 0.3s ease;
    }

.location-card {
      cursor: pointer;
    }

    .resource-card {
      cursor: grab;
    }

    .resource-card:active {
      cursor: grabbing;
    }

    /* ç‰²å£æ æ ·å¼ - é»˜è®¤æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
    .livestock-stall {
      cursor: pointer;
    }

    /* æ‹–æ‹½åŠ¨ç‰©åˆ°ç©ºæ æœªæ¾æ‰‹æ”¾ç½®æ—¶å˜ä¸º grab */
    .livestock-stall.dragover {
      cursor: grab;
    }

    /* æ¾æ‰‹æ”¾ç½®åæ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
    .livestock-stall.has-animal {
      cursor: pointer;
    }

.resource-card.dragging {
      opacity: 0.9;
      transform: scale(1.15) rotate(3deg) translateY(-10px);
      z-index: 1000;
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.5),
        0 15px 30px rgba(141, 110, 99, 0.4),
        0 8px 16px rgba(141, 110, 99, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.5),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2);
      border-color: #8D6E63;
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.98) 0%, rgba(255, 253, 247, 0.9) 100%);
      animation: drag-hover 0.3s ease-out forwards;
      filter: brightness(1.1);
    }

    /* æ‹–æ‹½æ—¶çš„åŠ¨æ€å…‰æ™•æ•ˆæœ */
    .resource-card.dragging::before {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border-radius: 20px;
      background: radial-gradient(circle,
        rgba(141, 110, 99, 0.3) 0%,
        rgba(141, 110, 99, 0.1) 50%,
        transparent 70%);
      z-index: -1;
    }

    /* ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–æ‹½æ ·å¼ */
    .touch-dragging {
      transition: none !important;
      animation: none !important;
      pointer-events: none;
    }

    /* æ‹–æ‹½æ—¶çš„3Dæ‚¬æµ®åŠ¨ç”» */
    @keyframes drag-hover {
      0% {
        transform: scale(1.0) rotate(0deg) translateY(0);
        box-shadow: 0 0 0 rgba(0, 0, 0, 0);
      }
      50% {
        transform: scale(1.2) rotate(4deg) translateY(-8px);
      }
      100% {
        transform: scale(1.15) rotate(3deg) translateY(-10px);
      }
    }

    /* æ‹–æ‹½ç›®æ ‡åŒºåŸŸé«˜äº® */
    .drag-over-highlight {
      background-color: rgba(56, 161, 105, 0.15) !important;
      border: 3px solid #38A169 !important;
      border-radius: 12px !important;
      box-shadow: 0 0 20px rgba(56, 161, 105, 0.3), inset 0 0 30px rgba(56, 161, 105, 0.1) !important;
      transition: all 0.2s ease !important;
    }

    .drag-over-highlight.resource-grid,
    .drag-over-highlight.ground-grid {
      animation: highlight-pulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes highlight-pulse {
      0% {
        background-color: rgba(56, 161, 105, 0.15);
        box-shadow: 0 0 20px rgba(56, 161, 105, 0.3), inset 0 0 30px rgba(56, 161, 105, 0.1);
      }
      100% {
        background-color: rgba(56, 161, 105, 0.25);
        box-shadow: 0 0 30px rgba(56, 161, 105, 0.5), inset 0 0 40px rgba(56, 161, 105, 0.2);
      }
    }

    /* å…‰æ™•è„‰åŠ¨åŠ¨ç”» */
    @keyframes glow-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.8;
      }
      50% {
        transform: scale(1.15);
        opacity: 1;
      }
    }

    /* æ‹–æ‹½æ—¶çš„é¼ æ ‡è·Ÿéšå…‰æ™• */
    .drag-glow-follow {
      position: fixed;
      pointer-events: none;
      width: 140px;
      height: 160px;
      border-radius: 50%;
      background: radial-gradient(circle,
        rgba(141, 110, 99, 0.2) 0%,
        rgba(141, 110, 99, 0.1) 40%,
        transparent 70%);
      z-index: 9996;
      animation: glow-pulse 1s ease-in-out infinite;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 30px rgba(141, 110, 99, 0.3);
    }

    /* æ‹–æ‹½æ—¶çš„ç²’å­æ•ˆæœ */
    .drag-particle {
      position: fixed;
      pointer-events: none;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      z-index: 9997;
      animation: particle-float 0.8s ease-out forwards;
    }

    @keyframes particle-float {
      0% {
        opacity: 0.8;
        transform: translate(0, 0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0);
      }
    }

    /* æ‹–æ‹½æ—¶çš„é­”æ³•æ‹–å°¾ */
    .magic-trail {
      position: fixed;
      pointer-events: none;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: radial-gradient(circle,
        rgba(141, 110, 99, 0.9) 0%,
        rgba(141, 110, 99, 0.5) 50%,
        transparent 100%);
      z-index: 9997;
      animation: trail-fade 0.4s ease-out forwards;
    }

    @keyframes trail-fade {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      100% {
        opacity: 0;
        transform: scale(0.3);
      }
    }

    /* èƒŒåŒ…æ é«˜äº®æ•ˆæœ - æ£•è‰²ï¼ˆæ¥è‡ªåœ°é¢æ æ‹–æ‹½ï¼‰ */
    .resource-grid.drag-over-highlight.ground-source {
      border: 3px solid #8D6E63 !important;
      box-shadow: 0 0 20px rgba(141, 110, 99, 0.5), 0 0 40px rgba(141, 110, 99, 0.3) !important;
      background-color: rgba(141, 110, 99, 0.05) !important;
      transition: all 0.3s ease;
    }

    /* èƒŒåŒ…æ é«˜äº®æ•ˆæœ - ç»¿è‰²ï¼ˆæ¥è‡ªåœ°é¢æ æ‹–æ‹½ï¼‰ */
    .resource-grid.drag-over-highlight.from-ground {
      border: 3px solid #4CAF50 !important;
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.5), 0 0 40px rgba(76, 175, 80, 0.3) !important;
      background-color: rgba(76, 175, 80, 0.05) !important;
      transition: all 0.3s ease;
    }

    /* åœ°é¢æ é«˜äº®æ•ˆæœ - ç»¿è‰² */
    .ground-grid.drag-over-highlight {
      border: 3px solid #4CAF50 !important;
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.5), 0 0 40px rgba(76, 175, 80, 0.3) !important;
      background-color: rgba(76, 175, 80, 0.05) !important;
      transition: all 0.3s ease;
    }

    /* å›ºå®šå¡ç‰Œçš„è§†è§‰æ ·å¼ */
    .resource-card.pinned {
      border-color: #38A169;
      box-shadow: 
        0 0 15px rgba(56, 161, 105, 0.3),
        0 4px 8px rgba(56, 161, 105, 0.2),
        inset 0 0 0 2px rgba(56, 161, 105, 0.3);
    }

    .resource-card.pinned:hover {
      border-color: #38A169;
      box-shadow: 
        0 0 20px rgba(56, 161, 105, 0.5),
        0 6px 12px rgba(56, 161, 105, 0.3),
        inset 0 0 0 2px rgba(56, 161, 105, 0.5);
    }

.status-card {
      cursor: default;
    }

.action-card {
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      min-height: 120px; /* é€‚åº”è¡ŒåŠ¨æ é«˜åº¦ */
      max-height: 140px; /* æœ€å¤§é«˜åº¦é™åˆ¶ */
      padding: 0.5rem;
      box-sizing: border-box;
      text-align: center;
      word-wrap: break-word;
      overflow: hidden;
    }

    .action-card.locked {
      cursor: not-allowed;
      opacity: 0.6;
      filter: grayscale(80%);
      border-color: #A0AEC0 !important;
      position: relative;
    }

    .action-card.locked::after {
      content: 'ğŸ”’';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 16px;
    }

.dragging {
      opacity: 0.8;
      transform: scale(1.05);
      z-index: 100;
    }

.dropzone {
      border: 2px dashed #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      min-height: 100px;
      transition: all 0.3s ease;
    }

    /* é›¨æ»´æ ·å¼ - å‰æ™¯é›¨æ»´ï¼ˆè¿‘ã€å¤§ã€å¿«ï¼‰ */
    .raindrop.foreground {
      position: absolute;
      width: 3px;
      height: 25px;
      background: linear-gradient(to bottom, 
        rgba(174, 194, 224, 0.95) 0%, 
        rgba(174, 194, 224, 0.8) 50%,
        rgba(174, 194, 224, 0.95) 100%);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      opacity: 0.9;
      animation: fall linear infinite;
      z-index: 1000;
      filter: blur(0.5px);
    }

    /* é›¨æ»´æ ·å¼ - ä¸­æ™¯é›¨æ»´ï¼ˆä¸­ã€ä¸­ã€ä¸­ï¼‰ */
    .raindrop.midground {
      position: absolute;
      width: 2px;
      height: 18px;
      background: linear-gradient(to bottom, 
        rgba(174, 194, 224, 0.85) 0%, 
        rgba(174, 194, 224, 0.7) 50%,
        rgba(174, 194, 224, 0.85) 100%);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      opacity: 0.75;
      animation: fall linear infinite;
      z-index: 999;
      filter: blur(1px);
    }

    /* é›¨æ»´æ ·å¼ - èƒŒæ™¯é›¨æ»´ï¼ˆè¿œã€å°ã€æ…¢ï¼‰ */
    .raindrop.background {
      position: absolute;
      width: 1px;
      height: 12px;
      background: linear-gradient(to bottom, 
        rgba(174, 194, 224, 0.65) 0%, 
        rgba(174, 194, 224, 0.55) 50%,
        rgba(174, 194, 224, 0.65) 100%);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      opacity: 0.5;
      animation: fall linear infinite;
      z-index: 998;
      filter: blur(1.5px);
    }

    /* é›¨æ»´æ‹–å°¾æ•ˆæœ */
    .raindrop::after {
      content: '';
      position: absolute;
      top: -5px;
      left: 50%;
      width: 50%;
      height: 100%;
      background: linear-gradient(to top, 
        rgba(174, 194, 224, 0.3) 0%, 
        transparent 100%);
      transform: translateX(-50%);
      pointer-events: none;
    }

    /* é›¨æ»´è½åœ¨æ°´é¢ä¸Šçš„æ™•åœˆæ•ˆæœ - ä¸»æ™•åœˆ */
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, 
        rgba(174, 194, 224, 0.6) 0%, 
        rgba(174, 194, 224, 0.3) 30%,
        rgba(174, 194, 224, 0.1) 60%,
        transparent 70%);
      transform: scale(0);
      animation: ripple-animation 1.2s ease-out;
      pointer-events: none;
      z-index: 997;
      box-shadow: 
        0 0 5px rgba(174, 194, 224, 0.3),
        0 0 10px rgba(174, 194, 224, 0.2);
    }

    /* æ™•åœˆå†…åœˆæ•ˆæœ */
    .ripple::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60%;
      height: 60%;
      border-radius: 50%;
      border: 2px solid rgba(174, 194, 224, 0.4);
      transform: translate(-50%, -50%);
      animation: ripple-inner 0.8s ease-out;
    }

    /* æ™•åœˆå¤–åœˆæ•ˆæœ */
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 140%;
      height: 140%;
      border-radius: 50%;
      border: 1px solid rgba(174, 194, 224, 0.2);
      transform: translate(-50%, -50%);
      animation: ripple-outer 1s ease-out;
    }

    /* é›¨æ»´é£æº…æ•ˆæœ */
    .splash {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(174, 194, 224, 0.8);
      border-radius: 50%;
      pointer-events: none;
      z-index: 996;
    }

    /* é›¾æ°”æ•ˆæœ */
    .fog-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, 
        rgba(200, 215, 235, 0.15) 0%, 
        rgba(180, 195, 215, 0.1) 40%,
        rgba(160, 175, 195, 0.05) 70%,
        transparent 100%);
      pointer-events: none;
      z-index: 995;
      animation: fog-drift 8s ease-in-out infinite alternate;
    }

    /* é›¨æ»´ä¸‹è½åŠ¨ç”» */
    @keyframes fall {
      0% {
        transform: translateY(-20px) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 0.9;
      }
      85% {
        opacity: 0.9;
      }
      100% {
        transform: translateY(calc(100vh - 20px)) translateX(15px);
        opacity: 0;
      }
    }

    /* æ™•åœˆæ‰©æ•£åŠ¨ç”» */
    @keyframes ripple-animation {
      0% {
        transform: scale(0);
        opacity: 0.8;
      }
      30% {
        opacity: 0.6;
      }
      100% {
        transform: scale(3);
        opacity: 0;
      }
    }

    /* æ™•åœˆå†…åœˆåŠ¨ç”» */
    @keyframes ripple-inner {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0.6;
        border-width: 2px;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
        border-width: 0.5px;
      }
    }

    /* æ™•åœˆå¤–åœˆåŠ¨ç”» */
    @keyframes ripple-outer {
      0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0.4;
      }
      100% {
        transform: translate(-50%, -50%) scale(1.3);
        opacity: 0;
      }
    }

    /* é£æº…åŠ¨ç”» */
    @keyframes splash-up {
      0% {
        transform: translateY(0) scale(1);
        opacity: 0.8;
      }
      100% {
        transform: translateY(-20px) scale(0.5);
        opacity: 0;
      }
    }

    /* é›¾æ°”é£˜åŠ¨åŠ¨ç”» */
    @keyframes fog-drift {
      0% {
        transform: translateX(-2%);
        opacity: 0.6;
      }
      50% {
        transform: translateX(2%);
        opacity: 0.7;
      }
      100% {
        transform: translateX(-2%);
        opacity: 0.6;
      }
    }

    /* é›¨å¤©èƒŒæ™¯æ•ˆæœ - å¢å¼ºæ°›å›´ */
    .weather-rainy .main-content {
      backdrop-filter: blur(1px) brightness(0.94) saturate(0.85);
      transition: backdrop-filter 0.5s ease, brightness 0.5s ease, saturate 0.5s ease;
      position: relative;
    }

    /* é›¨å¤©æ•´ä½“è‰²è°ƒ */
    .weather-rainy::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, 
        rgba(100, 120, 140, 0.05) 0%, 
        rgba(130, 150, 170, 0.08) 50%,
        rgba(100, 120, 140, 0.05) 100%);
      pointer-events: none;
      z-index: 994;
      animation: weather-pulse 4s ease-in-out infinite;
    }

    /* å¤©æ°”è„‰å†²æ•ˆæœ */
    @keyframes weather-pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.85;
      }
    }

.dropzone.active {
      border-color: #805AD5;
      background-color: rgba(128, 90, 213, 0.05);
    }

.game-wrapper {
      display: block !important;
      width: auto !important;
      max-width: 1200px !important;
      min-height: 100vh !important;
      padding: 1rem 0 !important;
      position: relative !important;
      box-sizing: border-box !important;
    }

    .game-container {
      max-width: 100% !important;
      margin: 0 !important;
      padding: 1rem !important;
      width: 100% !important;
      box-sizing: border-box !important;
      position: relative !important;
    }

.header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #E2E8F0;
    }

.header-title {
      font-size: 1.5rem;
      font-weight: normal;
      color: #2D3748;
    }

.header-info {
        .info-item-value {
          font-weight: normal;
          color: #2D3748;
        }
        .sidebar-section-title {
          font-size: 1rem;
          font-weight: normal;
          margin-bottom: 0.75rem;
          color: #2D3748;
        }
      display: flex;
      gap: 1rem;
    }

.info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #4A5568;
    }

.info-item-value {
      font-weight: normal;
      color: #2D3748;
    }

.main-content {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 1rem;
    }

.sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 250px;
      max-width: 250px;
      overflow: hidden;
      overflow-x: hidden;
      position: relative;
    }

.sidebar-section {
      background-color: transparent;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      width: fit-content; /* é€‚åº”å†…å®¹å®½åº¦ */
      max-width: 100%;
      box-sizing: border-box;
      overflow: visible; /* æ”¹ä¸ºvisibleï¼Œå…è®¸å†…å®¹æº¢å‡º */
    }

.sidebar-section-title {
      font-size: 1rem;
      font-weight: normal;
      margin-bottom: 0.75rem;
      color: #2D3748;
    }

.status-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

.resource-container {
  width: 620px; /* å¢åŠ å®½åº¦ä»¥å®¹çº³5å¼ å¡ç‰Œ */
  max-width: 620px; /* å¢åŠ æœ€å¤§å®½åº¦ */
  position: relative;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

    .resource-grid {
      display: flex;
      gap: 1rem;
      padding: 0.5rem;
      height: 180px; /* å›ºå®šé«˜åº¦ */
      width: 100%;
      flex-wrap: wrap; /* è‡ªåŠ¨æ¢è¡Œ */
      box-sizing: border-box;
      align-items: center; /* å‚ç›´å±…ä¸­ */
      background-color: rgba(0, 0, 0, 0.02);
      border: 2px dashed #E2E8F0;
      border-radius: 0.5rem;
    }

    /* è¡ŒåŠ¨æ æ»šåŠ¨æ¡å®¹å™¨ */
    .action-scrollbar {
      width: 100%;
      height: 6px;
      background-color: #f7fafc;
      border-radius: 3px;
      margin-top: 0.5rem;
      position: relative;
      cursor: pointer;
    }

    /* è¡ŒåŠ¨æ æ»šåŠ¨æ¡æ»‘å— */
    .action-scrollbar-thumb {
      height: 100%;
      background-color: #cbd5e0;
      border-radius: 3px;
      position: absolute;
      left: 0;
      top: 0;
      cursor: grab;
      transition: background-color 0.2s ease;
    }

    .action-scrollbar-thumb:hover {
        background-color: #a0aec0;
    }
    
    .action-scrollbar-thumb.dragging {
        background-color: #718096;
        cursor: grabbing;
    }

    /* ç¡®ä¿è¡ŒåŠ¨å¡ç‰Œä¿æŒå›ºå®šå¤§å° */
    .action-grid .action-card {
      flex: 0 0 120px; /* ä»140pxç¼©å°åˆ°120px */
      width: 120px; /* ä»140pxç¼©å°åˆ°120px */
      min-width: 120px; /* ä»140pxç¼©å°åˆ°120px */
      max-width: 120px; /* ä»140pxç¼©å°åˆ°120px */
      height: 105px; /* ä»120pxç¼©å°åˆ°105px */
      min-height: 105px; /* ä»120pxç¼©å°åˆ°105px */
      max-height: 105px; /* ä»120pxç¼©å°åˆ°105px */
    }

    /* åœ°é¢åŒºåŸŸæ ·å¼ */
    .ground-container {
      width: 620px;
      max-width: 620px; /* å¢åŠ å®½åº¦ä»¥å®¹çº³5å¼ å¡ç‰Œ */
      position: relative;
      overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .ground-grid {
      display: flex;
      gap: 1rem; /* ä¸èƒŒåŒ…æ ä¿æŒä¸€è‡´ */
      padding: 0.5rem;
      min-height: 180px; /* ä½¿ç”¨min-heightè€Œä¸æ˜¯å›ºå®šheight */
      overflow-x: auto; /* æ”¹ä¸ºautoï¼Œåªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
      overflow-y: hidden;
      max-width: 100%; /* é™åˆ¶æœ€å¤§å®½åº¦ */
      flex-wrap: nowrap;
      box-sizing: border-box;
      align-items: center; /* å‚ç›´å±…ä¸­ï¼Œä¸èƒŒåŒ…æ ä¿æŒä¸€è‡´ */
      scrollbar-width: none;
      -ms-overflow-style: none;
      border: 2px dashed #E2E8F0;
      border-radius: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
    }

    /* éšè—WebKitæµè§ˆå™¨é»˜è®¤æ»šåŠ¨æ¡ */
    .ground-grid::-webkit-scrollbar {
      display: none;
    }

    /* åœ°é¢æ»šåŠ¨æ¡å®¹å™¨ */
    .ground-scrollbar {
      width: 100%;
      height: 6px;
      background-color: #f7fafc;
      border-radius: 3px;
      margin-top: 0.5rem;
      position: relative;
      cursor: pointer;
    }

    /* åœ°é¢æ»šåŠ¨æ¡æ»‘å— */
    .ground-scrollbar-thumb {
      height: 100%;
      background-color: #cbd5e0;
      border-radius: 3px;
      position: absolute;
      left: 0;
      top: 0;
      cursor: grab;
      transition: background-color 0.2s ease;
    }

    .ground-scrollbar-thumb:hover {
      background-color: #a0aec0;
    }

    .ground-scrollbar-thumb.dragging {
      background-color: #718096;
      cursor: grabbing;
    }

    /* ç¡®ä¿åœ°é¢å¡ç‰Œä¿æŒå›ºå®šå¤§å° - ä¸èƒŒåŒ…æ ä¿æŒä¸€è‡´ */
    .ground-grid .resource-card {
      flex: 0 0 100px;
      width: 100px;
      min-width: 100px;
      max-width: 100px;
      height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      position: relative;
      overflow: visible;
    }

    .ground-grid .resource-card .card-image {
      height: 95px !important;
      width: 85px !important;
      margin: -10px auto 0 auto !important;
      padding: 0 !important;
      flex: none;
      align-self: center;
      display: block;
      position: relative;
      max-height: 95px !important;
      overflow: hidden !important;
    }

    .ground-grid .resource-card .card-content {
      height: 5px;
      flex-shrink: 0;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    .ground-grid .resource-card .card-title {
      font-size: 0.75rem;
      line-height: 1.2;
      margin: 0;
      white-space: nowrap;
      position: absolute;
      top: -15px;
      left: -12px;
      background-color: rgba(93, 64, 55, 0.9);
      color: white;
      border: 2px solid #5D4037;
      border-radius: 9999px;
      padding: 4px 10px;
      z-index: 20;
      text-align: center;
      font-weight: normal;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      width: auto;
      max-width: none;
      display: inline-block;
    }

/* åœ°é¢å¡ç‰Œç«–ç€æ˜¾ç¤ºçš„è€ä¹…åº¦æ¡ - ä¸èƒŒåŒ…æ ä¿æŒä¸€è‡´ */
    .ground-grid .resource-card .card-durability {
      position: absolute;
      right: 4px;
      top: 34px;
      width: 4px;
      height: 45px;
      background-color: #E2E8F0;
      border-radius: 2px;
      overflow: hidden;
      z-index: 10;
    }

    .ground-grid .resource-card .card-durability .durability-bar {
      width: 100%;
      background-color: #38A169;
      position: absolute;
      left: 0;
      bottom: 0;
      border-radius: 0 0 2px 2px;
      transition: height 0.3s ease;
    }

/* ç¡®ä¿èµ„æºå¡ç‰Œä¿æŒå›ºå®šå¤§å° */
.resource-grid .resource-card {
      flex: 0 0 100px;
      width: 100px;
      min-width: 100px;
      max-width: 100px;
      height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      position: relative;
      overflow: visible;
    }

    .resource-grid .resource-card .card-image {
      height: 95px !important;
      width: 85px !important;
      margin: 10px auto 5px !important;
      padding: 0 !important;
      flex: none;
      align-self: center;
      display: block;
      position: relative;
    }

    .resource-grid .resource-card .card-content {
      height: 5px;
      flex-shrink: 0;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    .resource-grid .resource-card .card-title {
      font-size: 0.75rem;
      line-height: 1.2;
      margin: 0;
      white-space: nowrap;
      position: absolute;
      top: -15px;
      left: -12px;
      background-color: rgba(93, 64, 55, 0.9);
      color: white;
      border: 2px solid #5D4037;
      border-radius: 9999px;
      padding: 4px 10px;
      z-index: 20;
      text-align: center;
      font-weight: normal;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      width: auto;
      max-width: none;
      display: inline-block;
    }

/* èƒŒåŒ…å¡ç‰Œç«–ç€æ˜¾ç¤ºçš„è€ä¹…åº¦æ¡ */
    .resource-grid .resource-card .card-durability {
      position: absolute;
      right: 4px;
      top: 34px;
      width: 4px;
      height: 45px;
      background-color: #E2E8F0;
      border-radius: 2px;
      overflow: hidden;
      z-index: 10;
    }

    .resource-grid .resource-card .card-durability .durability-bar {
      width: 100%;
      background-color: #38A169;
      position: absolute;
      left: 0;
      bottom: 0;
      border-radius: 0 0 2px 2px;
      transition: height 0.3s ease;
    }

    /* å¼ºåˆ¶è®¾ç½®èƒŒåŒ…æ å¡ç‰Œå›¾ç‰‡çš„é«˜åº¦å’Œä½ç½® */
    .resource-grid .resource-card .card-image {
      height: 95px !important;
      width: 85px !important;
      margin: -10px auto 0 auto !important;
      padding: 0 !important;
      max-height: 95px !important;
      overflow: hidden !important;
    }

    .resource-grid .resource-card {
      height: 120px !important;
      max-height: 120px !important;
      overflow: visible !important;
    }


.main-area {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      max-width: 100%;
    }

.location-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

.action-grid-container {
      width: 620px; /* å¢åŠ å®½åº¦ä»¥ä¸èƒŒåŒ…æ å’Œåœ°é¢æ ä¸€è‡´ */
      max-width: 620px; /* å¢åŠ æœ€å¤§å®½åº¦ */
      position: relative;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .action-grid {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      height: 135px; /* å›ºå®šé«˜åº¦ï¼Œç¼©çŸ­ä»¥å®¹çº³æ»šåŠ¨æ¡ï¼ˆå¡ç‰Œ120px + paddingä¸Šä¸‹å„8px + æ»šåŠ¨æ¡6px = 134pxï¼‰*/
      overflow-x: scroll;
      overflow-y: hidden;
      width: 100%;
      flex-wrap: nowrap; /* ä¸€è¡Œæ’åˆ—ï¼Œè¶…å‡ºæ»šåŠ¨ */
      box-sizing: border-box;
      scrollbar-width: none; /* éšè—é»˜è®¤æ»šåŠ¨æ¡ */
      -ms-overflow-style: none; /* IEéšè—æ»šåŠ¨æ¡ */
    }

    /* éšè—WebKitæµè§ˆå™¨é»˜è®¤æ»šåŠ¨æ¡ */
    .action-grid::-webkit-scrollbar {
      display: none;
    }

.combination-area {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

.combination-title {
      font-size: 1rem;
      font-weight: normal;
      color: #2D3748;
    }

.combination-slots {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

.combination-slot {
      width: 80px;
      height: 120px;
      border: 2px dashed #E2E8F0;
      border-radius: 0.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
    }

.combination-slot.active {
      border-color: #805AD5;
      background-color: rgba(128, 90, 213, 0.05);
    }

/* åˆ¶ä½œçª—å£æ ·å¼ */
    .crafting-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

.crafting-modal.active {
      display: block;
    }

.crafting-modal-content {
      background-color: #F7FAFC;
      margin: 5% auto;
      padding: 0;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 800px;
      max-height: 50vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

.crafting-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

.crafting-modal-title {
      font-size: 1.4rem;
      font-weight: normal;
      margin: 0;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.crafting-modal-close {
      color: white;
      font-size: 1.75rem;
      font-weight: normal;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

.crafting-modal-close:hover,
    .crafting-modal-close:focus {
      color: #E2E8F0;
      text-decoration: none;
      cursor: pointer;
    }

.crafting-modal-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

.crafting-left,
    .crafting-right {
      padding: 1rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

.crafting-left {
      width: 50%;
      border-right: 1px solid #E2E8F0;
    }

.crafting-right {
      width: 50%;
    }

.crafting-section-title {
      font-size: 1.2rem;
      font-weight: normal;
      color: #2D3748;
      margin-bottom: 1rem;
    }

.crafting-inventory {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
    }

/* å¡ç‰Œå’Œæ’æ§½çš„åŸºç¡€å°ºå¯¸å˜é‡ */
    :root {
      --card-base-width: 100px;
      --card-base-height: 120px;
    }

.crafting-inventory-card {
      width: var(--card-base-width) !important;
      height: var(--card-base-height) !important;
      border: 2px solid #8D6E63 !important;
      border-radius: 12px !important; /* å¼§å½¢åœ†è§’ */
      background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.85) 100%) !important;
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      padding: 0.5rem !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      box-shadow: 
        0 0 15px rgba(141, 110, 99, 0.3), /* æŸ”å…‰å¤–å‘å…‰ */
        0 4px 8px rgba(139, 69, 19, 0.2), /* å¸¸è§„é˜´å½± */
        inset 0 1px 2px rgba(255, 255, 255, 0.3) !important; /* å†…å‘å…‰ */
    }

      .crafting-inventory-card:hover {
        transform: scale(1.05) !important;
        box-shadow: 
          0 0 20px rgba(141, 110, 99, 0.5), /* æ›´å¼ºçš„æŸ”å…‰ */
          0 6px 12px rgba(139, 69, 19, 0.3),
          inset 0 1px 3px rgba(255, 255, 255, 0.4) !important;
        border-radius: 14px !important; /* æ‚¬åœæ—¶åœ†è§’ç¨å¾®å¢å¤§ */
      }
      
      .crafting-inventory-card.dragging {
        opacity: 0.5 !important;
        transform: scale(0.95) !important;
        transition: all 0.2s ease !important;
      }

.crafting-card-image {
      width: 100% !important;
      height: 70px !important;
      background-size: cover !important;
      background-position: center !important;
      border-radius: 0.25rem !important;
      margin-bottom: 0.5rem !important;
      background-color: #E2E8F0 !important;
    }

    /* å½“æœ‰èƒŒæ™¯å›¾ç‰‡æ—¶ï¼Œç§»é™¤èƒŒæ™¯è‰² */
    .crafting-card-image[style*="background-image"],
    .crafting-card-image[style*="background:"] {
      background-color: transparent !important;
    }

.crafting-card-title {
      font-size: 0.75rem !important;
      font-weight: normal !important;
      color: #2D3748 !important;
      text-align: center !important;
      margin-bottom: 0.25rem !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
      width: 100% !important;
    }

    /* ç¡®ä¿å†œç”°çª—å£æ°´ä½æŒ‡ç¤ºæ¡å§‹ç»ˆå¯è§ */
    .crafting-inventory-card .water-level-indicator-backpack {
      opacity: 1 !important;
      display: flex !important;
      visibility: visible !important;
    }

    .crafting-inventory-card .water-level-indicator-backpack > div {
      opacity: 1 !important;
      visibility: visible !important;
    }

.crafting-card-count {
      font-size: 0.625rem !important;
      color: #4A5568 !important;
      font-weight: normal !important;
    }

.crafting-card-durability {
      font-size: 0.6rem !important;
      color: #ED8936 !important;
      font-weight: normal !important;
    }

.crafting-slots {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

.crafting-slot {
      width: var(--card-base-width);
      height: var(--card-base-height);
      border: 2px dashed #8D6E63;
      border-radius: 0.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
    }

.crafting-slot.active {
      border-color: #805AD5;
      background-color: rgba(128, 90, 213, 0.05);
    }

.crafting-slot .card {
      width: 100% !important;
      height: 100% !important;
      font-size: 0.75rem !important;
      display: flex !important;
      flex-direction: column !important;
    }

.crafting-slot .card .card-image {
      height: 70% !important;
    }

.crafting-slot .card .card-content {
      padding: 0.5rem !important;
      flex-grow: 1 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

.crafting-slot .card .card-title {
      font-size: 0.75rem !important;
      text-align: center !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }

/* å“åº”å¼è®¾è®¡ - å°å±å¹•é€‚é… */
    @media (max-width: 600px) {
      :root {
        --card-base-width: 80px;
        --card-base-height: 90px;
      }

.crafting-inventory-card {
        padding: 0.25rem !important;
      }

.crafting-card-title {
        font-size: 0.625rem !important;
      }

.crafting-card-count {
        font-size: 0.5rem !important;
      }
    }

.crafting-result {
      min-height: 100px;
      margin-bottom: 0.25rem;
      padding: 0.75rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
      text-align: center;
    }

.crafting-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .crafting-button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #8D6E63;
      color: white;
      font-weight: normal;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

.crafting-button:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
    }

    .event-result-modal-confirm {
      background-color: #8D6E63;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1.5rem;
      font-weight: normal;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .event-result-modal-confirm:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
        inset 0 1px 4px rgba(255, 255, 255, 0.5),
        inset 0 -3px 6px rgba(0, 0, 0, 0.3);
    }

.crafting-button:active {
      transform: translateY(0);
      box-shadow: 
        0 0 15px rgba(141, 110, 99, 0.3),
        0 2px 6px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.2),
        inset 0 -1px 3px rgba(0, 0, 0, 0.2);
    }

.crafting-button:disabled {
      background-color: #CBD5E0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

/* åœ°å›¾æ¨¡æ€æ¡†æ ·å¼ */
    .map-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

.map-modal.active {
      opacity: 1;
      visibility: visible;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

.map-modal-content {
      position: relative;
      width: 900px;
      height: 600px;
      background-image: url('UI/åœ°å›¾.jpg') !important;
      background-size: cover !important;
      background-repeat: no-repeat !important;
      background-position: center center !important;
      border: none !important;
      border-radius: 0;
      box-shadow: none !important;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    /* è¦†ç›–ink-borderç±»çš„èƒŒæ™¯è®¾ç½® */
    .map-modal-content.ink-border {
      background: url('UI/åœ°å›¾.jpg') center/cover no-repeat !important;
      border: none !important;
      border-radius: 0;
      box-shadow: none !important;
    }

    /* éšè—ink-borderçš„ä¼ªå…ƒç´  */
    .map-modal-content.ink-border::before,
    .map-modal-content.ink-border::after {
      display: none !important;
    }

.map-modal.active .map-modal-content {
      transform: translateY(0);
    }

.map-modal-header {
      position: absolute;
      top: 10px;
      right: 180px;
      z-index: 10;
    }

.map-modal-title {
      font-size: 1.8rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.map-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
    }

.tutorial-modal-title {
      font-size: 1.25rem;
    }

.event-result-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.event-result-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
    }

.game-over-modal-title {
      font-size: 1.5rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.recipe-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.recipe-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
    }

.event-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.event-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }

.map-modal-body {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #mapLocationGrid {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* åœ°ç‚¹å¡ç‰Œæ ·å¼ */
    .map-location-card {
      position: absolute;
      width: 100px; /* æ¢å¤åŸå°ºå¯¸100px */
      height: 50px; /* æ¢å¤åŸå°ºå¯¸50px */
      background-color: rgba(128, 0, 0, 0.8); /* çº¢è‰²ï¼Œå¸¦é€æ˜åº¦ */
      color: white;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 16px; /* æ¢å¤åŸå°ºå¯¸16px */
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      text-align: center;
      padding: 5px; /* æ¢å¤åŸå°ºå¯¸5px */
      border: 1px solid rgba(255, 255, 255, 0.3); /* æ·»åŠ æ·¡ç™½è‰²è¾¹æ¡†å¢å¼ºè§†è§‰æ•ˆæœ */
    }

    .map-location-card:hover {
      transform: scale(1.1);
      background-color: rgba(128, 0, 0, 1); /* ä¸é€æ˜çš„çº¢è‰² */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

.event-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

.event-modal.active {
      opacity: 1;
      visibility: visible;
    }

.event-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

.event-modal.active .event-modal-content {
      transform: translateY(0);
    }

.event-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

.event-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.event-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }

.event-modal-body {
      margin-bottom: 1.5rem;
    }

.event-modal-text {
      margin-bottom: 1rem;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.event-modal-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

.event-modal-option {
      background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
      border: 2px solid #5D4037 !important;
      border-radius: 16px !important;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0 0 25px rgba(141, 110, 99, 0.5),
        0 4px 12px rgba(139, 69, 19, 0.3),
        inset 0 1px 3px rgba(255, 255, 255, 0.4),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
      position: relative;
      overflow: hidden;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
      font-weight: normal !important;
      color: white !important;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .event-modal-option:hover {
      background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
        inset 0 1px 4px rgba(255, 255, 255, 0.5),
        inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
      border-radius: 18px !important;
    }

    .event-modal-option:active {
      transform: translateY(0) !important;
      box-shadow: 
        0 0 15px rgba(141, 110, 99, 0.3),
        0 2px 6px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.2),
        inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
    }

    .event-modal-option-text {
      font-weight: normal;
      margin-bottom: 0.25rem;
      color: white;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
      text-shadow: 1px 1px 2px rgba(93, 64, 55, 0.2);
    }

    .event-modal-option-description {
      font-size: 0.75rem;
      color: #f0f0f0;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
    }

.tooltip {
      position: relative;
      display: inline-block;
    }

.tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #2D3748;
      color: #fff;
      text-align: center;
      border-radius: 0.25rem;
      padding: 0.5rem;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
    }

.tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

.season-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      color: #4A5568;
    }

.season-icon {
      font-size: 1rem;
    }

.day-indicator {
      font-size: 1.5rem;
      color: #4A5568;
      text-align: center;
      font-weight: normal;
    }

.day-number {
      font-weight: 600;
      color: #2D3748;
    }

.notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1000;
      max-width: 300px;
      width: 90%;
    }

.notification.active {
      transform: translateY(0);
      opacity: 1;
    }

.notification.central {
      top: 50% !important;
      left: 50% !important;
      bottom: auto !important;
      right: auto !important;
      transform: translate(-50%, -50%) scale(0.9) !important;
      padding: 1.5rem;
      max-width: 400px;
      text-align: center;
    }

.notification.central.active {
      transform: translate(-50%, -50%) scale(1);
    }

/* Settings Modal Styles */
.settings-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.settings-modal.active {
  opacity: 1;
  visibility: visible;
}

.settings-modal-content {
  background-color: #F7FAFC;
  border-radius: 0.75rem;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.settings-modal.active .settings-modal-content {
  transform: scale(1);
}

.settings-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #E2E8F0;
}

.settings-modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
  color: #2D3748;
  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
}

.settings-close-button {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #718096;
  width: 2rem;
  height: 2rem;
  border-radius: 0.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.settings-close-button:hover {
  background-color: #EDF2F7;
  color: #2D3748;
}

.settings-modal-body {
  padding: 1.5rem;
}

.settings-section {
  margin-bottom: 2rem;
}

.settings-section h3 {
  margin: 0 0 1rem 0;
  font-size: 1.2rem;
  color: #2D3748;
  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
}

.setting-item {
  margin-bottom: 1.5rem;
}

.setting-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.setting-label span {
  font-size: 1rem;
  color: #4A5568;
  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #CBD5E0;
  transition: 0.4s;
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: #48BB78;
}

input:checked + .toggle-slider:before {
  transform: translateX(26px);
}

/* Volume Slider */
.setting-control {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.volume-slider {
  flex: 1;
  height: 6px;
  border-radius: 3px;
  background: #E2E8F0;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #48BB78;
  cursor: pointer;
}

.volume-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #48BB78;
  cursor: pointer;
  border: none;
}

.volume-value {
  font-size: 0.875rem;
  color: #718096;
  min-width: 3rem;
  text-align: center;
}

/* Save/Load Controls */
.save-load-controls {
  display: flex;
  gap: 1rem;
  margin-top: 0.5rem;
}

.save-load-controls .ink-button {
  flex: 1;
  padding: 0.75rem 1rem;
}

.notification-title {
      font-size: 1rem;
      font-weight: normal;
      margin-bottom: 0.25rem;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.notification-message {
      font-size: 0.875rem;
      color: #4A5568;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.notification-close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
    }

/* ç®€å•æ–‡å­—é€šçŸ¥æ ·å¼ */
.simple-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      text-align: center;
      max-width: 80%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

.simple-notification.show {
      opacity: 1;
      transform: translate(-50%, -50%);
    }

.simple-notification.hide {
      opacity: 0;
      transform: translate(-50%, -80%);
      transition: all 0.5s ease;
    }

    .notification-actions {
      margin-top: 1rem;
    }

    .notification-button {
      background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
      border: 2px solid #5D4037 !important;
      border-radius: 16px !important;
      padding: 0.5rem 1.5rem !important;
      font-size: 0.875rem !important;
      font-weight: normal !important;
      cursor: pointer !important;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
      color: white !important;
      text-shadow: none !important;
      letter-spacing: 1px !important;
      overflow: hidden !important;
      box-shadow: 
        0 0 25px rgba(141, 110, 99, 0.5),
        0 4px 12px rgba(139, 69, 19, 0.3),
        inset 0 1px 3px rgba(255, 255, 255, 0.4),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
      transition: all 0.3s ease !important;
    }

    .notification-button:hover {
      background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
        inset 0 1px 4px rgba(255, 255, 255, 0.5),
        inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
      border-radius: 18px !important;
    }

    .notification-button:active {
      transform: translateY(0) !important;
      box-shadow: 
        0 0 15px rgba(141, 110, 99, 0.3),
        0 2px 6px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.2),
        inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
    }

.recipe-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

.recipe-modal.active {
      opacity: 1;
      visibility: visible;
    }

.recipe-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

.recipe-modal.active .recipe-modal-content {
      transform: translateY(0);
    }

.recipe-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

.recipe-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.recipe-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }

.recipe-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }

.recipe-card {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      transition: all 0.3s ease;
    }

.recipe-card:hover {
      background-color: #EDF2F7;
      border-color: #CBD5E0;
    }

.recipe-card-title {
      font-size: 1rem;
      font-weight: normal;
      margin-bottom: 0.5rem;
      color: #2D3748;
    }

        .game-over-stats-title {
          font-size: 1rem;
          font-weight: normal;
          margin-bottom: 0.5rem;
          color: #2D3748;
        }

    .start-screen-title {
      font-size: 2rem;
      font-weight: normal;
      margin-bottom: 1rem;
      color: #2D3748;
    }

.recipe-card-ingredients {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

.recipe-card-ingredient {
      background-color: #EDF2F7;
      border-radius: 9999px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      color: #4A5568;
    }

.recipe-card-description {
      font-size: 0.75rem;
      color: #4A5568;
    }

.recipe-card-discovered {
      font-size: 0.75rem;
      color: #805AD5;
      font-weight: normal;
    }

.recipe-card-undiscovered {
      font-size: 0.75rem;
      color: #A0AEC0;
    }

/* äº‹ä»¶ç»“æœæ¨¡æ€æ¡†æ ·å¼ */
    .event-result-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

.event-result-modal.active {
      opacity: 1;
      visibility: visible;
    }

.event-result-modal.closing {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

.event-result-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

.event-result-modal.active .event-result-modal-content {
      transform: translateY(0);
    }

.event-result-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

.event-result-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.event-result-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
      transition: all 0.3s ease;
    }

.event-result-modal-close:hover {
      color: #2D3748;
    }

.event-result-modal-body {
      margin-bottom: 1rem;
    }

.event-result-modal-footer {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }

.event-result-modal-confirm {
      background-color: #805AD5;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1.5rem;
      font-weight: normal;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

.event-result-modal-confirm:hover {
      background-color: #6B46C1;
    }

.event-result-section {
      margin-bottom: 1rem;
    }

.event-result-section:last-child {
      margin-bottom: 0;
    }

.event-result-list {
      margin-top: 0.5rem;
      padding-left: 1.5rem;
      list-style-type: disc;
    }

.event-result-list li {
      margin-bottom: 0.25rem;
      color: #2D3748;
    }

.start-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #F7FAFC;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      transition: all 0.5s ease;
    }

.start-screen-content {
      text-align: center;
      max-width: 600px;
      padding: 2rem;
    }

.start-screen-title {
      font-size: 2rem;
      font-weight: normal;
      margin-bottom: 1rem;
      color: #2D3748;
    }

.start-screen-subtitle {
      font-size: 1.25rem;
      margin-bottom: 2rem;
      color: #4A5568;
    }

.start-screen-image {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

.start-screen-description {
      margin-bottom: 2rem;
      color: #4A5568;
    }

    .start-screen-button {
      background-color: #8D6E63;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s ease;
    }

.start-screen-button:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
        inset 0 1px 4px rgba(255, 255, 255, 0.5),
        inset 0 -3px 6px rgba(0, 0, 0, 0.3);
    }

    .tutorial-button {
      background-color: #8D6E63;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s ease;
    }

.tutorial-button:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
        inset 0 1px 4px rgba(255, 255, 255, 0.5),
        inset 0 -3px 6px rgba(0, 0, 0, 0.3);
    }

.start-screen-button:active {
      transform: translateY(0);
      box-shadow: 
        0 0 15px rgba(141, 110, 99, 0.3),
        0 2px 6px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.2),
        inset 0 -1px 3px rgba(0, 0, 0, 0.2);
    }

.tutorial-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

.tutorial-modal.active {
      opacity: 1;
      visibility: visible;
    }

.tutorial-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

.tutorial-modal.active .tutorial-modal-content {
      transform: translateY(0);
    }

.tutorial-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

.tutorial-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.tutorial-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }

.tutorial-step {
      margin-bottom: 1.5rem;
      display: block !important;
    }

.tutorial-step-title {
      font-size: 1rem;
      font-weight: normal;
      margin-bottom: 0.5rem;
      color: #2D3748;
    }

.tutorial-step-content {
      margin-bottom: 0.5rem;
      color: #4A5568;
    }

.tutorial-step-image {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .start-screen-button {
      background-color: #8D6E63;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s ease;
    }

.tutorial-navigation {
      display: flex;
      justify-content: center;
      margin-top: 1.5rem;
    }

    .tutorial-button {
      background-color: #8D6E63;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s ease;
    }

.tutorial-button:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
        inset 0 1px 4px rgba(255, 255, 255, 0.5),
        inset 0 -3px 6px rgba(0, 0, 0, 0.3);
    }

.tutorial-button:active {
      transform: translateY(0);
      box-shadow: 
        0 0 15px rgba(141, 110, 99, 0.3),
        0 2px 6px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.2),
        inset 0 -1px 3px rgba(0, 0, 0, 0.2);
    }

.tutorial-button:disabled {
      background-color: #A0AEC0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

.game-over-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 500;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

.game-over-modal.active {
      opacity: 1;
      visibility: visible;
    }

.game-over-modal-content {
      background-color: #FFFDF7;
      border-radius: 0.25rem;
      max-width: 600px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

.game-over-modal.active .game-over-modal-content {
      transform: translateY(0);
    }

.game-over-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

.game-over-modal-title {
      font-size: 1.5rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.game-over-modal-body {
      margin-bottom: 1.5rem;
    }

.game-over-modal-text {
      margin-bottom: 1rem;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

.game-over-stats {
      background-color: #EDF2F7;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

.game-over-stats-title {
      font-size: 1rem;
      font-weight: normal;
      margin-bottom: 0.5rem;
      color: #2D3748;
    }

.game-over-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

.game-over-stat {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: #4A5568;
    }

.game-over-stat-value {
      font-weight: normal;
      color: #2D3748;
    }

.game-over-modal-options {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

.game-over-button {
      background-color: #805AD5;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s ease;
    }

.game-over-button:hover {
      background-color: #6B46C1;
    }

.achievement-modal {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background-color: #FFFDF7;
      border-radius: 0.25rem;
      padding: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      max-width: 300px;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

.achievement-modal.active {
      transform: translateX(0);
      opacity: 1;
    }

.achievement-icon {
      font-size: 1.5rem;
      color: #805AD5;
    }

.achievement-content {
      flex: 1;
    }

.achievement-title {
      font-size: 1rem;
      font-weight: normal;
      margin-bottom: 0.25rem;
      color: #5D4037;
    }

.achievement-description {
      font-size: 0.875rem;
      color: #7D6E63;
    }

.achievement-close {
      background: none;
      border: none;
      font-size: 0.875rem;
      cursor: pointer;
      color: #4A5568;
    }

/* æ°´å¢¨ç”»é£æ ¼çš„ç‰¹æ®Šæ•ˆæœ */
    .ink-border {
      position: relative;
      border: 2px solid #8D6E63;
      border-radius: 0.25rem;
      box-shadow: 0 0 15px rgba(141, 110, 99, 0.2);
    }

    /* å…±äº«çš„ Tooltip æ ·å¼ - ç”¨äºç‰²å£æ ã€é©¬å©æ å’Œå†œç”° */
    .tooltip-header {
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      color: #F7FAFC;
    }
    
    .tooltip-status {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      align-items: center;
    }
    
    .tooltip-label {
      color: #CBD5E0;
      font-size: 0.75rem;
    }
    
    .tooltip-value {
      font-weight: normal;
      font-size: 0.75rem;
    }
    
    .tooltip-description {
      font-style: italic;
      font-size: 0.7rem;
      color: #E2E8F0;
      margin-top: 6px;
      text-align: center;
    }
    
    .tooltip-divider {
      height: 1px;
      background-color: rgba(255,255,255,0.1);
      margin: 8px 0;
    }
    
    .tooltip-resources {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 5px;
    }
    
    .tooltip-label {
      color: #CBD5E0;
      font-size: 0.75rem;
      min-width: 50px;
    }
    
    .tooltip-progress {
      flex: 1;
      max-width: 60px;
      height: 8px;
      background-color: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .tooltip-value {
      font-weight: normal;
      font-size: 0.75rem;
      min-width: 30px;
      text-align: right;
    }
    
    .tooltip-progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Tooltip æ·¡å…¥åŠ¨ç”» */
    @keyframes fadeInTooltip {
      0% { opacity: 0; transform: translateY(-5px); }
      100% { opacity: 1; transform: translateY(0); }
    }

.ink-border::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      border: 1px solid #8D6E63;
      border-radius: 0.375rem;
      z-index: -1;
      opacity: 0.5;
    }
    
.ink-border::after {
      content: 'â—†';
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      color: #8D6E63;
      font-size: 16px;
      background-color: #FFFDF7;
      padding: 0 8px;
      z-index: 1;
    }

.ink-bg {
      background-color: #FFFDF7;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="none" stroke="%238D6E63" stroke-width="0.3" stroke-dasharray="5,5" opacity="0.2"/></svg>');
      background-repeat: repeat;
    }

.ink-text {
      position: relative;
      display: inline-block;
      color: #5D4037;
      font-weight: normal;
      text-shadow: 1px 1px 2px rgba(93, 64, 55, 0.2);
    }

.ink-text::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #8D6E63;
      transform: scaleX(0.8) translateX(10%);
      opacity: 0.7;
    }

/* å¤é£è£…é¥°å…ƒç´  */
.ink-decoration {
      position: relative;
      padding: 1rem;
      margin: 0.5rem 0;
      border-left: 3px solid #8D6E63;
      background: linear-gradient(90deg, rgba(141, 110, 99, 0.1) 0%, rgba(141, 110, 99, 0) 100%);
    }

/* ç»Ÿä¸€ç®€çº¦é£æ ¼æŒ‰é’®æ ·å¼ */
.ink-button {
  background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
  border: 2px solid #5D4037 !important;
  border-radius: 16px !important;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: normal !important;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
  color: white !important;
  text-shadow: none !important;
  letter-spacing: 1px !important;
  overflow: hidden !important;
  box-shadow: 
    0 0 25px rgba(141, 110, 99, 0.5),
    0 4px 12px rgba(139, 69, 19, 0.3),
    inset 0 1px 3px rgba(255, 255, 255, 0.4),
    inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
}

.ink-button:hover {
  background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 
    0 0 35px rgba(141, 110, 99, 0.7),
    0 6px 16px rgba(139, 69, 19, 0.4),
    inset 0 1px 4px rgba(255, 255, 255, 0.5),
    inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
  border-radius: 18px !important;
}

.ink-button:active {
  transform: translateY(0) !important;
  box-shadow: 
    0 0 15px rgba(141, 110, 99, 0.3),
    0 2px 6px rgba(139, 69, 19, 0.2),
    inset 0 1px 2px rgba(255, 255, 255, 0.2),
    inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
}

.event-result-modal-confirm {
      background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
      border: 2px solid #5D4037 !important;
      border-radius: 16px !important;
      padding: 0.5rem 1.5rem;
      font-weight: normal !important;
      cursor: pointer;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
      color: white !important;
      text-shadow: none !important;
      letter-spacing: 1px !important;
      overflow: hidden !important;
      box-shadow: 
        0 0 25px rgba(141, 110, 99, 0.5),
        0 4px 12px rgba(139, 69, 19, 0.3),
        inset 0 1px 3px rgba(255, 255, 255, 0.4),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
      transition: all 0.3s ease !important;
    }

    .event-result-modal-confirm:hover {
      background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: 
        0 0 35px rgba(141, 110, 99, 0.7),
        0 6px 16px rgba(139, 69, 19, 0.4),
        inset 0 1px 4px rgba(255, 255, 255, 0.5),
        inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
      border-radius: 18px !important;
    }

    .event-result-modal-confirm:active {
      transform: translateY(0) !important;
      box-shadow: 
        0 0 15px rgba(141, 110, 99, 0.3),
        0 2px 6px rgba(139, 69, 19, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.2),
        inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
    }

/* å°å·æŒ‰é’® */
.ink-button-small {
  border-radius: 14px !important;
  padding: 0.4rem 0.9rem !important;
  font-size: 0.875rem !important;
}

.ink-button-small:hover {
  border-radius: 16px !important;
}

.ink-button-small:active {
  transform: translateY(0) !important;
  box-shadow: 
    0 0 15px rgba(141, 110, 99, 0.3),
    0 2px 6px rgba(139, 69, 19, 0.2),
    inset 0 1px 2px rgba(255, 255, 255, 0.2),
    inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
}

/* ä¸»è¦æŒ‰é’® */
.ink-button-primary {
  background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
  border: 2px solid #5D4037 !important;
  border-radius: 16px !important;
  box-shadow: 
    0 0 25px rgba(141, 110, 99, 0.5),
    0 4px 12px rgba(139, 69, 19, 0.3),
    inset 0 1px 3px rgba(255, 255, 255, 0.4),
    inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
  font-weight: normal !important;
  color: white !important;
}

.ink-button-primary:hover {
  background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 
    0 0 35px rgba(141, 110, 99, 0.7),
    0 6px 16px rgba(139, 69, 19, 0.4),
    inset 0 1px 4px rgba(255, 255, 255, 0.5),
    inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
  border-radius: 18px !important;
}

.ink-button-primary:active {
  transform: translateY(0) !important;
  box-shadow: 
    0 0 15px rgba(141, 110, 99, 0.3),
    0 2px 6px rgba(139, 69, 19, 0.2),
    inset 0 1px 2px rgba(255, 255, 255, 0.2),
    inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
}

/* æ¬¡è¦æŒ‰é’® */
.ink-button-secondary {
  background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
  border: 2px solid #5D4037 !important;
  border-radius: 16px !important;
  box-shadow: 
    0 0 25px rgba(141, 110, 99, 0.5),
    0 4px 12px rgba(139, 69, 19, 0.3),
    inset 0 1px 3px rgba(255, 255, 255, 0.4),
    inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
  font-weight: normal !important;
  color: white !important;
  text-shadow: none !important;
  letter-spacing: 1px !important;
  overflow: hidden !important;
}

.ink-button-secondary:hover {
  background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 
    0 0 35px rgba(141, 110, 99, 0.7),
    0 6px 16px rgba(139, 69, 19, 0.4),
    inset 0 1px 4px rgba(255, 255, 255, 0.5),
    inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
  border-radius: 18px !important;
}

.ink-button-secondary:active {
  transform: translateY(0) !important;
  box-shadow: 
    0 0 15px rgba(141, 110, 99, 0.3),
    0 2px 6px rgba(139, 69, 19, 0.2),
    inset 0 1px 2px rgba(255, 255, 255, 0.2),
    inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
}

/* ç®€çº¦é£æ ¼"ä¸‹ä¸€å¤©"æŒ‰é’®ï¼ˆä¿æŒä¸ä¸»æ ·å¼ä¸€è‡´ï¼‰ */
.ink-button-carved {
  background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
  border: 2px solid #5D4037 !important;
  border-radius: 16px !important;
  box-shadow: 
    0 0 25px rgba(141, 110, 99, 0.5),
    0 4px 12px rgba(139, 69, 19, 0.3),
    inset 0 1px 3px rgba(255, 255, 255, 0.4),
    inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
  font-weight: normal !important;
  color: white !important;
  text-shadow: none !important;
  letter-spacing: 1px !important;
  overflow: hidden !important;
}

.ink-button-carved:hover {
  background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 
    0 0 35px rgba(141, 110, 99, 0.7),
    0 6px 16px rgba(139, 69, 19, 0.4),
    inset 0 1px 4px rgba(255, 255, 255, 0.5),
    inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
  border-radius: 18px !important;
}

.ink-button-carved:active {
  transform: translateY(0) !important;
  box-shadow: 
    0 0 15px rgba(141, 110, 99, 0.3),
    0 2px 6px rgba(139, 69, 19, 0.2),
    inset 0 1px 2px rgba(255, 255, 255, 0.2),
    inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
}

.ink-button-carved.ink-button-small {
  border-radius: 14px !important;
  padding: 0.4rem 0.9rem !important;
}

.ink-button-carved.ink-button-small:hover {
  border-radius: 16px !important;
}

/* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .location-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

@media (max-width: 640px) {
      .location-grid {
        grid-template-columns: 1fr;
      }

.status-grid {
        grid-template-columns: 1fr;
      }

.header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

.header-info {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* ä»“åº“ç®¡ç†ç•Œé¢æ ·å¼ */
    .storage-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .storage-modal.active {
      opacity: 1;
      visibility: visible;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .storage-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 1200px;
      width: 90%;
      max-height: 85vh;
      overflow: hidden;
      padding: 0;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .storage-modal.active .storage-modal-content {
      transform: translateY(0);
    }

    .storage-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #E2E8F0;
    }

    .storage-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }

    .storage-modal-body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .storage-layout {
      display: flex;
      gap: 1.5rem;
      height: 550px;
    }

    .storage-left-panel,
    .storage-right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      background-color: #FFF;
    }

    .storage-panel-title {
      font-size: 1rem;
      font-weight: normal;
      color: #2D3748;
      padding: 1rem;
      margin: 0;
      border-bottom: 1px solid #E2E8F0;
      background-color: #EDF2F7;
    }

    .storage-inventory-container,
    .storage-warehouse-container {
      flex: 1;
      padding: 0.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .storage-resource-card {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border: 1px solid #E2E8F0;
      border-radius: 0.375rem;
      background-color: #FFF;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .storage-resource-card:hover {
      border-color: #CBD5E0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .storage-resource-card.double-clicked {
      transform: scale(0.95);
      box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.5);
      transition: all 0.2s ease;
    }

    .storage-resource-image {
      width: 40px;
      height: 40px;
      background-size: cover;
      background-position: center;
      border-radius: 0.25rem;
      margin-right: 0.75rem;
      background-color: #E2E8F0;
    }

    .storage-resource-info {
      flex: 1;
    }

    .storage-resource-name {
      font-size: 0.875rem;
      font-weight: normal;
      color: #2D3748;
      margin-bottom: 0.25rem;
    }

    .storage-resource-amount {
      font-size: 0.75rem;
      color: #4A5568;
    }



    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .storage-layout {
        flex-direction: column;
        height: auto;
      }
      
      .storage-left-panel,
      .storage-right-panel {
        min-height: 200px;
      }
    }

    /* æ•°é‡é€‰æ‹©çª—å£æ ·å¼ */
    .storage-amount-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .storage-amount-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .storage-amount-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 400px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .storage-amount-modal.active .storage-amount-modal-content {
      transform: translateY(0);
    }

    .storage-amount-modal-title {
      font-size: 1.1rem;
      font-weight: normal;
      color: #2D3748;
      margin-bottom: 0.5rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1.5rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .storage-amount-button {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-all {
      background-color: #805AD5;
      color: white;
    }

    .storage-amount-all:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
    }

    .storage-amount-custom {
      background-color: #38A169;
      color: white;
    }

    .storage-amount-custom:hover {
      background-color: #2F855A;
      transform: translateY(-2px);
    }

    .storage-amount-cancel {
      background-color: #CBD5E0;
      color: #4A5568;
    }

    .storage-amount-cancel:hover {
      background-color: #A0AEC0;
      transform: translateY(-2px);
    }

    /* æ•°é‡è¾“å…¥çª—å£æ ·å¼ */
    .storage-amount-input-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .storage-amount-input-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .storage-amount-input-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 400px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .storage-amount-input-modal.active .storage-amount-input-modal-content {
      transform: translateY(0);
    }

    .storage-amount-input-modal-title {
      font-size: 1.1rem;
      font-weight: normal;
      color: #2D3748;
      margin-bottom: 0.5rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-input-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-input-container {
      margin-bottom: 1.5rem;
    }

    .storage-amount-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #E2E8F0;
      border-radius: 0.375rem;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .storage-amount-input:focus {
      outline: none;
      border-color: #805AD5;
      box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.2);
    }

    .storage-amount-input-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .storage-amount-input-confirm {
      background-color: #805AD5;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .storage-amount-input-confirm:hover {
      background-color: #6B46C1;
    }

    .storage-amount-input-cancel {
      background-color: #CBD5E0;
      color: #4A5568;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .storage-amount-input-cancel:hover {
      background-color: #A0AEC0;
    }

    /* å†°çª–ç®¡ç†ç•Œé¢æ ·å¼ */
    .icehouse-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .icehouse-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .icehouse-modal-content {
      background-color: #F7FAFC;
      width: 90%;
      max-width: 900px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .icehouse-modal.active .icehouse-modal-content {
      transform: translateY(0);
    }

    .icehouse-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #E2E8F0;
    }

    .icehouse-modal-title {
      font-size: 1.4rem;
      font-weight: normal;
      margin: 0;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .icehouse-modal-close {
      background: none;
      border: none;
      font-size: 1.75rem;
      cursor: pointer;
      color: #4A5568;
      padding: 0;
      line-height: 1;
    }

    .icehouse-modal-close:hover {
      color: #2D3748;
    }

    .icehouse-modal-body {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .icehouse-layout {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      flex: 1;
      overflow: hidden;
    }

    .icehouse-left {
      width: 50%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .icehouse-right {
      width: 50%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .icehouse-section-title {
      font-size: 1.2rem;
      font-weight: normal;
      margin-bottom: 0.75rem;
      color: #2D3748;
    }

    .icehouse-inventory {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
    }

    .icehouse-storage {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
      min-height: 200px;
    }

    .icehouse-ice-block-section {
      margin-bottom: 1rem;
    }

    .icehouse-ice-block-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem;
      background-color: rgba(173, 216, 230, 0.1);
      border-radius: 0.5rem;
      border: 2px dashed #87CEEB;
      min-height: auto;
      gap: 1rem;
    }

    .icehouse-ice-block-drop-zone {
      text-align: center;
      color: #5D9EC0;
    }

    .drop-zone-hint {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .drop-zone-hint-small {
      font-size: 0.75rem;
      color: #7FA3B8;
    }

    .icehouse-ice-block-status {
      text-align: center;
      margin-top: 0.75rem;
      padding: 0.5rem;
      background-color: rgba(135, 206, 235, 0.1);
      border-radius: 0.375rem;
    }

    .icehouse-ice-block-status p {
      margin: 0.25rem 0;
      font-size: 0.875rem;
      color: #4A5568;
    }

    .status-active {
      color: #38A169 !important;
      font-weight: bold;
    }

    .status-inactive {
      color: #E53E3E !important;
      font-weight: bold;
    }

    .icehouse-inventory-card,
    .icehouse-stored-card,
    .icehouse-ice-block-card {
      width: 100px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
      background-color: #F7FAFC;
      border: 2px solid #E2E8F0;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icehouse-inventory-card:hover,
    .icehouse-stored-card:hover,
    .icehouse-ice-block-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-color: #87CEEB;
    }

    .icehouse-inventory-card:hover {
      border-color: #48BB78;
    }

    .icehouse-card-image {
      width: 70px;
      height: 70px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .icehouse-card-name {
      font-size: 0.75rem;
      color: #2D3748;
      text-align: center;
      word-break: break-all;
    }

    .icehouse-card-expiry {
      font-size: 0.625rem;
      color: #4A5568;
      text-align: center;
      margin-top: 0.25rem;
    }

    .icehouse-card-expiry.warning {
      color: #E53E3E;
      font-weight: bold;
    }

    .icehouse-amount-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .icehouse-amount-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .icehouse-amount-modal-content {
      background-color: #F7FAFC;
      width: 90%;
      max-width: 400px;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .icehouse-amount-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      margin: 0 0 1rem 0;
      color: #2D3748;
    }

    .icehouse-amount-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1rem;
    }

    .icehouse-amount-options {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .icehouse-amount-button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: normal;
      transition: background-color 0.2s ease;
    }

    .icehouse-amount-all {
      background-color: #48BB78;
      color: white;
    }

    .icehouse-amount-all:hover {
      background-color: #38A169;
    }

    .icehouse-amount-cancel {
      background-color: #CBD5E0;
      color: #4A5568;
    }

    .icehouse-amount-cancel:hover {
      background-color: #A0AEC0;
    }

    .icehouse-amount-custom {
      background-color: #4299E1;
      color: white;
    }

    .icehouse-amount-custom:hover {
      background-color: #3182CE;
    }

    /* å†°çª–æ•°é‡è¾“å…¥æ¨¡æ€æ¡†æ ·å¼ */
    .icehouse-amount-input-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .icehouse-amount-input-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .icehouse-amount-input-modal-content {
      background-color: #F7FAFC;
      width: 90%;
      max-width: 400px;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .icehouse-amount-input-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      margin: 0 0 0.5rem 0;
      color: #2D3748;
    }

    .icehouse-amount-input-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1rem;
    }

    .icehouse-amount-input-container {
      margin-bottom: 1.5rem;
    }

    .icehouse-amount-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #CBD5E0;
      border-radius: 0.375rem;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .icehouse-amount-input:focus {
      outline: none;
      border-color: #4299E1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .icehouse-amount-input-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .icehouse-amount-input-confirm {
      padding: 0.5rem 1rem;
      background-color: #48BB78;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: normal;
      transition: background-color 0.2s ease;
    }

    .icehouse-amount-input-confirm:hover {
      background-color: #38A169;
    }

    .icehouse-amount-input-cancel {
      padding: 0.5rem 1rem;
      background-color: #CBD5E0;
      color: #4A5568;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: normal;
      transition: background-color 0.2s ease;
    }

    .icehouse-amount-input-cancel:hover {
      background-color: #A0AEC0;
    }

    /* æ—¶æ•ˆæ€§é£Ÿç‰©å€’è®¡æ—¶æ ·å¼ */
    .expiry-timer {
      position: absolute;
      bottom: -8px;
      left: -8px;
      background-color: rgba(229, 62, 62, 0.9);
      color: white;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 100;
      border: 2px solid rgba(229, 62, 62, 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
      padding: 0 6px;
      min-width: 28px;
      white-space: nowrap;
    }

    .expiry-timer.warning {
      background-color: rgba(229, 62, 62, 1);
      animation: expiry-pulse 1s infinite;
    }

    /* å¢å¼ºè§’è½å…ƒç´ z-indexï¼Œç¡®ä¿ä¸è¢«è¾¹æ¡†é®æŒ¡ */
    .amount-badge {
      z-index: 150 !important;
    }
    
    .pin-button {
      z-index: 151 !important;
    }
    
    .expiry-timer {
      z-index: 152 !important;
    }
    
    .equipped-badge {
      z-index: 153 !important;
    }
    
    .fuel-indicator {
      z-index: 154 !important;
    }
    
    .water-level-indicator-backpack {
      z-index: 155 !important;
    }
    
    .card-durability {
      z-index: 156 !important;
    }

    /* ç¡®ä¿æ‰€æœ‰å¡ç‰Œå®¹å™¨å…è®¸è§’è½å…ƒç´ æº¢å‡º */
    .resource-card,
    .ground-grid .resource-card,
    .resource-grid .resource-card,
    .crafting-inventory-card {
      overflow: visible !important;
      position: relative;
      /* é˜²æ­¢è¾¹æ¡†è£å‰ªå¤–éƒ¨å…ƒç´  */
      isolation: isolate;
    }
    
    /* ç¡®ä¿å¡ç‰Œå®¹å™¨æœ¬èº«ä¸ä¼šé®æŒ¡è§’è½å…ƒç´  */
    .card-image {
      overflow: visible !important;
    }
    
    .card-content {
      overflow: visible !important;
    }

    @keyframes expiry-pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(229, 62, 62, 0.5);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(229, 62, 62, 0.8);
      }
    }
  </style>
<!-- æ·»åŠ iOSç‰¹å®šçš„æ—‹è½¬æ”¯æŒ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    /* é˜²æ­¢iOSä¸Šçš„åŒå‡»ç¼©æ”¾ */
    * {
      touch-action: manipulation;
    }

/* æ»‘å—å°æ¸¸æˆæ ·å¼ */
    .slider-game-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

.slider-game-modal.active {
      opacity: 1;
      visibility: visible;
    }

.slider-game-content {
      background-color: #FFFDF7;
      border-radius: 0.25rem;
      max-width: 600px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

.slider-game-modal.active .slider-game-content {
      transform: translateY(0);
    }

.slider-game-title {
      font-size: 1.5rem;
      font-weight: normal;
      color: #5D4037;
      text-align: center;
      margin-bottom: 1.5rem;
    }

.slider-game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

/* æ—¶é—´å€’æ•°æ¡ */
    .timer-bar-container {
      width: 100%;
      height: 10px;
      background-color: #E2E8F0;
      border-radius: 5px;
      margin-bottom: 2rem;
      overflow: hidden;
    }

.timer-bar {
      height: 100%;
      width: 100%;
      background-color: #E53E3E;
      transition: width 0.1s linear;
    }

/* æ»‘å—è½¨é“ */
    .slider-track {
      position: relative;
      width: 100%;
      height: 40px;
      background-color: #E2E8F0;
      border-radius: 0;
      overflow: hidden;
      margin-bottom: 1rem;
      display: flex;
    }

/* ç›®æ ‡åŒºåŸŸ */
    .target-area {
      position: absolute;
      background-color: #48BB78;
      height: 100%;
      border-radius: 0;
      transition: width 0.3s ease, left 0.3s ease;
    }

/* éç›®æ ‡åŒºåŸŸ */
    .non-target-area {
      background-color: #D69E2E;
      height: 100%;
      flex: 1;
    }

/* ä¸‰è§’å½¢æ»‘å— */
    .slider-triangle {
      position: absolute;
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 25px solid #2D3748;
      /* æ»‘å—è¦†ç›–ä¸€éƒ¨åˆ†è½¨é“ä¸Šæ–¹ï¼ŒåŸºäºå®¹å™¨å®šä½ */
      top: -25px; /* è¦†ç›–è½¨é“5px */
      left: 0;
      transition: left 0.1s linear;
      transform-origin: center bottom;
    }

/* æ§åˆ¶æŒ‰é’® */
    .slider-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 2rem;
    }

/* æ»‘å—æŒ‰é’®å·²ä½¿ç”¨å¤é£æ ·å¼ï¼Œæ— éœ€å•ç‹¬å®šä¹‰ */
.slider-button {
      margin-bottom: 1rem;
    }

.slider-instructions {
      font-size: 0.875rem;
      color: #4A5568;
      text-align: center;
    }

/* å“åº”å¼è®¾è®¡ */
    @media (max-width: 640px) {
      .slider-track {
        width: 300px;
      }
    }

/* æ¨ªå±æ¨¡å¼æ ·å¼è°ƒæ•´ */
    @media screen and (orientation: landscape) {
      /* è°ƒæ•´å¡ç‰‡ç½‘æ ¼åœ¨æ¨ªå±æ—¶çš„å¸ƒå±€ */
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }

/* è°ƒæ•´æ¸¸æˆå®¹å™¨åœ¨æ¨ªå±æ—¶çš„å¸ƒå±€ */
      .game-container {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 1rem !important;
        width: 100% !important;
        box-sizing: border-box !important;
        position: relative !important;
      }

/* ç¡®ä¿é‡è¦å…ƒç´ åœ¨æ¨ªå±æ—¶æœ‰åˆé€‚çš„å¤§å° */
      .card {
        max-height: 200px;
      }

/* è°ƒæ•´èµ„æºæ åœ¨æ¨ªå±æ—¶çš„å¸ƒå±€ */
      .resources-grid {
        max-width: 400px;
      }
    }

    /* ä»“åº“ç®¡ç†ç•Œé¢æ ·å¼ */
    .storage-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .storage-modal.active {
      opacity: 1;
      visibility: visible;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .storage-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 1200px;
      width: 90%;
      max-height: 85vh;
      overflow: hidden;
      padding: 0;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .storage-modal.active .storage-modal-content {
      transform: translateY(0);
    }

    .storage-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #E2E8F0;
    }

    .storage-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }

    .storage-modal-body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .storage-layout {
      display: flex;
      gap: 1.5rem;
      height: 550px;
    }

    .storage-left-panel,
    .storage-right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      background-color: #FFF;
    }

    .storage-panel-title {
      font-size: 1rem;
      font-weight: normal;
      color: #2D3748;
      padding: 1rem;
      margin: 0;
      border-bottom: 1px solid #E2E8F0;
      background-color: #EDF2F7;
    }

    .storage-inventory-container,
    .storage-warehouse-container {
      flex: 1;
      padding: 0.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .storage-resource-card {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border: 1px solid #E2E8F0;
      border-radius: 0.375rem;
      background-color: #FFF;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .storage-resource-card:hover {
      border-color: #CBD5E0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .storage-resource-card.double-clicked {
      transform: scale(0.95);
      box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.5);
      transition: all 0.2s ease;
    }

    .storage-resource-image {
      width: 40px;
      height: 40px;
      background-size: cover;
      background-position: center;
      border-radius: 0.25rem;
      margin-right: 0.75rem;
      background-color: #E2E8F0;
    }

    .storage-resource-info {
      flex: 1;
    }

    .storage-resource-name {
      font-size: 0.875rem;
      font-weight: normal;
      color: #2D3748;
      margin-bottom: 0.25rem;
    }

    .storage-resource-amount {
      font-size: 0.75rem;
      color: #4A5568;
    }



    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .storage-layout {
        flex-direction: column;
        height: auto;
      }
      
      .storage-left-panel,
      .storage-right-panel {
        min-height: 200px;
      }
    }

    /* æ•°é‡é€‰æ‹©çª—å£æ ·å¼ */
    .storage-amount-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .storage-amount-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .storage-amount-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 400px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .storage-amount-modal.active .storage-amount-modal-content {
      transform: translateY(0);
    }

    .storage-amount-modal-title {
      font-size: 1.1rem;
      font-weight: normal;
      color: #2D3748;
      margin-bottom: 0.5rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1.5rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .storage-amount-button {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-all {
      background-color: #805AD5;
      color: white;
    }

    .storage-amount-all:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
    }

    .storage-amount-custom {
      background-color: #38A169;
      color: white;
    }

    .storage-amount-custom:hover {
      background-color: #2F855A;
      transform: translateY(-2px);
    }

    .storage-amount-cancel {
      background-color: #CBD5E0;
      color: #4A5568;
    }

    .storage-amount-cancel:hover {
      background-color: #A0AEC0;
      transform: translateY(-2px);
    }

    /* æ•°é‡è¾“å…¥çª—å£æ ·å¼ */
    .storage-amount-input-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .storage-amount-input-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .storage-amount-input-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 400px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .storage-amount-input-modal.active .storage-amount-input-modal-content {
      transform: translateY(0);
    }

    .storage-amount-input-modal-title {
      font-size: 1.1rem;
      font-weight: normal;
      color: #2D3748;
      margin-bottom: 0.5rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-input-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1rem;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .storage-amount-input-container {
      margin-bottom: 1.5rem;
    }

    .storage-amount-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #E2E8F0;
      border-radius: 0.375rem;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .storage-amount-input:focus {
      outline: none;
      border-color: #805AD5;
      box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.2);
    }

    .storage-amount-input-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .storage-amount-input-confirm {
      background-color: #805AD5;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .storage-amount-input-confirm:hover {
      background-color: #6B46C1;
    }

    .storage-amount-input-cancel {
      background-color: #CBD5E0;
      color: #4A5568;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .storage-amount-input-cancel:hover {
      background-color: #A0AEC0;
    }

    /* å†°çª–ç®¡ç†ç•Œé¢æ ·å¼ */
    .icehouse-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .icehouse-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .icehouse-modal-content {
      background-color: #F7FAFC;
      width: 90%;
      max-width: 900px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .icehouse-modal.active .icehouse-modal-content {
      transform: translateY(0);
    }

    .icehouse-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #E2E8F0;
    }

    .icehouse-modal-title {
      font-size: 1.4rem;
      font-weight: normal;
      margin: 0;
      color: #2D3748;
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
    }

    .icehouse-modal-close {
      background: none;
      border: none;
      font-size: 1.75rem;
      cursor: pointer;
      color: #4A5568;
      padding: 0;
      line-height: 1;
    }

    .icehouse-modal-close:hover {
      color: #2D3748;
    }

    .icehouse-modal-body {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .icehouse-layout {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      flex: 1;
      overflow: hidden;
    }

    .icehouse-left {
      width: 50%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .icehouse-right {
      width: 50%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .icehouse-section-title {
      font-size: 1.2rem;
      font-weight: normal;
      margin-bottom: 0.75rem;
      color: #2D3748;
    }

    .icehouse-inventory {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
    }

    .icehouse-storage {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
      min-height: 200px;
    }

    .icehouse-ice-block-section {
      margin-bottom: 1rem;
    }

    .icehouse-ice-block-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem;
      background-color: rgba(173, 216, 230, 0.1);
      border-radius: 0.5rem;
      border: 2px dashed #87CEEB;
      min-height: auto;
      gap: 1rem;
    }

    .icehouse-ice-block-drop-zone {
      text-align: center;
      color: #5D9EC0;
    }

    .drop-zone-hint {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .drop-zone-hint-small {
      font-size: 0.75rem;
      color: #7FA3B8;
    }

    .icehouse-ice-block-status {
      text-align: center;
      margin-top: 0.75rem;
      padding: 0.5rem;
      background-color: rgba(135, 206, 235, 0.1);
      border-radius: 0.375rem;
    }

    .icehouse-ice-block-status p {
      margin: 0.25rem 0;
      font-size: 0.875rem;
      color: #4A5568;
    }

    .status-active {
      color: #38A169 !important;
      font-weight: bold;
    }

    .status-inactive {
      color: #E53E3E !important;
      font-weight: bold;
    }

    .icehouse-inventory-card,
    .icehouse-stored-card,
    .icehouse-ice-block-card {
      width: 100px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
      background-color: #F7FAFC;
      border: 2px solid #E2E8F0;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icehouse-inventory-card:hover,
    .icehouse-stored-card:hover,
    .icehouse-ice-block-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-color: #87CEEB;
    }

    .icehouse-inventory-card:hover {
      border-color: #48BB78;
    }

    .icehouse-card-image {
      width: 70px;
      height: 70px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .icehouse-card-name {
      font-size: 0.75rem;
      color: #2D3748;
      text-align: center;
      word-break: break-all;
    }

    .icehouse-card-expiry {
      font-size: 0.625rem;
      color: #4A5568;
      text-align: center;
      margin-top: 0.25rem;
    }

    .icehouse-card-expiry.warning {
      color: #E53E3E;
      font-weight: bold;
    }

    .icehouse-amount-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .icehouse-amount-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .icehouse-amount-modal-content {
      background-color: #F7FAFC;
      width: 90%;
      max-width: 400px;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .icehouse-amount-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      margin: 0 0 1rem 0;
      color: #2D3748;
    }

    .icehouse-amount-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1rem;
    }

    .icehouse-amount-options {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .icehouse-amount-button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: normal;
      transition: background-color 0.2s ease;
    }

    .icehouse-amount-all {
      background-color: #48BB78;
      color: white;
    }

    .icehouse-amount-all:hover {
      background-color: #38A169;
    }

    .icehouse-amount-cancel {
      background-color: #CBD5E0;
      color: #4A5568;
    }

    .icehouse-amount-cancel:hover {
      background-color: #A0AEC0;
    }

    .icehouse-amount-custom {
      background-color: #4299E1;
      color: white;
    }

    .icehouse-amount-custom:hover {
      background-color: #3182CE;
    }

    /* å†°çª–æ•°é‡è¾“å…¥æ¨¡æ€æ¡†æ ·å¼ */
    .icehouse-amount-input-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .icehouse-amount-input-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .icehouse-amount-input-modal-content {
      background-color: #F7FAFC;
      width: 90%;
      max-width: 400px;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .icehouse-amount-input-modal-title {
      font-size: 1.25rem;
      font-weight: normal;
      margin: 0 0 0.5rem 0;
      color: #2D3748;
    }

    .icehouse-amount-input-modal-description {
      font-size: 0.875rem;
      color: #4A5568;
      margin-bottom: 1rem;
    }

    .icehouse-amount-input-container {
      margin-bottom: 1.5rem;
    }

    .icehouse-amount-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #CBD5E0;
      border-radius: 0.375rem;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .icehouse-amount-input:focus {
      outline: none;
      border-color: #4299E1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .icehouse-amount-input-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .icehouse-amount-input-confirm {
      padding: 0.5rem 1rem;
      background-color: #48BB78;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: normal;
      transition: background-color 0.2s ease;
    }

    .icehouse-amount-input-confirm:hover {
      background-color: #38A169;
    }

    .icehouse-amount-input-cancel {
      padding: 0.5rem 1rem;
      background-color: #CBD5E0;
      color: #4A5568;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: normal;
      transition: background-color 0.2s ease;
    }

    .icehouse-amount-input-cancel:hover {
      background-color: #A0AEC0;
    }

    /* æ—¶æ•ˆæ€§é£Ÿç‰©å€’è®¡æ—¶æ ·å¼ */
    .expiry-timer {
      position: absolute;
      bottom: -8px;
      left: -8px;
      background-color: rgba(229, 62, 62, 0.9);
      color: white;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 100;
      border: 2px solid rgba(229, 62, 62, 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
      padding: 0 6px;
      min-width: 28px;
      white-space: nowrap;
    }

    .expiry-timer.warning {
      background-color: rgba(229, 62, 62, 1);
      animation: expiry-pulse 1s infinite;
    }

    /* å¢å¼ºè§’è½å…ƒç´ z-indexï¼Œç¡®ä¿ä¸è¢«è¾¹æ¡†é®æŒ¡ */
    .amount-badge {
      z-index: 150 !important;
    }
    
    .pin-button {
      z-index: 151 !important;
    }
    
    .expiry-timer {
      z-index: 152 !important;
    }
    
    .equipped-badge {
      z-index: 153 !important;
    }
    
    .fuel-indicator {
      z-index: 154 !important;
    }
    
    .water-level-indicator-backpack {
      z-index: 155 !important;
    }
    
    .card-durability {
      z-index: 156 !important;
    }

    /* ç¡®ä¿æ‰€æœ‰å¡ç‰Œå®¹å™¨å…è®¸è§’è½å…ƒç´ æº¢å‡º */
    .resource-card,
    .ground-grid .resource-card,
    .resource-grid .resource-card,
    .crafting-inventory-card {
      overflow: visible !important;
      position: relative;
      /* é˜²æ­¢è¾¹æ¡†è£å‰ªå¤–éƒ¨å…ƒç´  */
      isolation: isolate;
    }
    
    /* ç¡®ä¿å¡ç‰Œå®¹å™¨æœ¬èº«ä¸ä¼šé®æŒ¡è§’è½å…ƒç´  */
    .card-image {
      overflow: visible !important;
    }
    
    .card-content {
      overflow: visible !important;
    }

    @keyframes expiry-pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(229, 62, 62, 0.5);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(229, 62, 62, 0.8);
      }
    }
  </style>
</head>
<body class="ink-bg" onresize="checkOrientation()">
  <!-- æ·»åŠ å±å¹•æ–¹å‘æ£€æµ‹è„šæœ¬ -->
  <script>
    // æ£€æµ‹å±å¹•æ–¹å‘å˜åŒ–
    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      const gameContainer = document.querySelector('.game-container');

if (isLandscape) {
        document.body.classList.add('landscape-mode');
        document.body.classList.remove('portrait-mode');
      } else {
        document.body.classList.add('portrait-mode');
        document.body.classList.remove('landscape-mode');
      }

// é‡æ–°æ¸²æŸ“æ¸¸æˆå…ƒç´ ä»¥é€‚åº”æ–°çš„æ–¹å‘
      if (typeof renderLocations === 'function') renderLocations();
      if (typeof renderResources === 'function') renderResources();
      if (typeof renderActions === 'function') renderActions();
    }

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åˆå§‹æ–¹å‘
    window.addEventListener('load', checkOrientation);
    // è®¾å¤‡æ—‹è½¬æ—¶æ£€æŸ¥æ–¹å‘
    window.addEventListener('orientationchange', checkOrientation);
  </script>
  <!-- å¼€å§‹å±å¹• -->
  <div class="start-screen ink-bg" id="startScreen">
    <div class="start-screen-content ink-border">
      <h1 class="start-screen-title ink-text">è®ºä¸€ä¸ªä¹ä¸å¦‚ä½•åœ¨å¤ä»£æŒ£æ‰æ±‚ç”Ÿ</h1>
      <img src="UI/å°é¢.jpg" alt="æ¸¸æˆèƒŒæ™¯" class="start-screen-image">
      <p class="start-screen-description">
        å¼€å±€ä¸€åªç¢—ï¼Œå®å›¾éœ¸ä¸šä¸€æœæ½
      </p>
      <button class="start-screen-button ink-button ink-button-primary" id="startGameButton">å¼€å§‹æ¸¸æˆ</button>
      
      <div class="start-screen-save-load" style="display: flex; justify-content: center; flex-wrap: wrap; margin-top: 1.5rem;">

      </div>
      </div>
  </div>

  <!-- æ•™ç¨‹æ¨¡æ€æ¡† -->
  <div class="tutorial-modal" id="tutorialModal">
    <div class="tutorial-modal-content ink-border">
      <div class="tutorial-modal-header">
        <h2 class="tutorial-modal-title ink-text">æ¸¸æˆæ•™ç¨‹</h2>
        <button class="tutorial-modal-close ink-button ink-button-small" id="closeTutorialButton">&times;</button>
      </div>
      <div class="tutorial-steps">
        <div class="tutorial-step" id="tutorialStep1">
          <h3 class="tutorial-step-title">æ¬¢è¿æ¥åˆ°ä¹ä¸ç”Ÿå­˜</h3>
          <p class="tutorial-step-content">åœ¨è¿™ä¸ªæ¸¸æˆä¸­ï¼Œä½ å°†æ‰®æ¼”ä¸€åå¤ä»£ä¹ä¸ï¼Œé€šè¿‡æ”¶é›†èµ„æºã€åˆ¶ä½œå·¥å…·å’Œåº”å¯¹å„ç§äº‹ä»¶æ¥ç”Ÿå­˜ä¸‹å»ã€‚</p>
          <p class="tutorial-step-content">æ¸¸æˆçš„æ ¸å¿ƒæ˜¯å¡ç‰Œç³»ç»Ÿï¼Œæ‰€æœ‰çš„èµ„æºã€åœ°ç‚¹ã€çŠ¶æ€å’Œè¡ŒåŠ¨éƒ½ä»¥å¡ç‰Œå½¢å¼å‘ˆç°ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep2">
          <h3 class="tutorial-step-title">èƒŒåŒ…ç®¡ç†</h3>
          <p class="tutorial-step-content">ä½ éœ€è¦ç®¡ç†èƒŒåŒ…ä¸­çš„å¤šç§ç‰©å“ï¼ŒåŒ…æ‹¬é£Ÿç‰©ã€é’±å¸ã€ææ–™å’Œå·¥å…·ã€‚è¿™äº›ç‰©å“å¯ä»¥é€šè¿‡æ¢ç´¢åœ°ç‚¹ã€ä¹è®¨æˆ–åˆ¶ä½œè·å¾—ã€‚</p>
          <p class="tutorial-step-content">æ³¨æ„ï¼šé£Ÿç‰©ä¼šéšç€æ—¶é—´æ¶ˆè€—ï¼Œä½ éœ€è¦ä¿æŒè¶³å¤Ÿçš„é£Ÿç‰©æ¥ç»´æŒç”Ÿå­˜ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep3">
          <h3 class="tutorial-step-title">å¡ç‰Œç»„åˆ</h3>
          <p class="tutorial-step-content">å°†ä¸åŒçš„å¡ç‰Œæ‹–æ”¾åˆ°ç»„åˆåŒºåŸŸå¯ä»¥åˆ›å»ºæ–°çš„ç‰©å“æˆ–æ‰§è¡Œç‰¹å®šè¡ŒåŠ¨ã€‚ä¾‹å¦‚ï¼š</p>
          <ul class="tutorial-step-content">
            <li>å°†"ç ´ç¢—"å’Œ"ä¸œè¥¿å¸‚"ç»„åˆå¯ä»¥è¿›è¡Œä¹è®¨</li>
            <li>å°†"æ®‹ç¾¹å‰©é¥­"å’Œ"ç ´ç¢—"ç»„åˆå¯ä»¥é£Ÿç”¨</li>
            <li>å°†"ç ´å¸ƒ"å’Œ"æœ¨æ£"ç»„åˆå¯ä»¥åˆ¶ä½œç®€æ˜“æ‹æ–</li>
          </ul>
          <p class="tutorial-step-content">å°è¯•ä¸åŒçš„ç»„åˆæ¥å‘ç°æ–°çš„é…æ–¹ï¼</p>
        </div>
        <div class="tutorial-step" id="tutorialStep4">
          <h3 class="tutorial-step-title">çŠ¶æ€ç®¡ç†</h3>
          <p class="tutorial-step-content">ä½ çš„è§’è‰²æœ‰å¤šç§çŠ¶æ€éœ€è¦å…³æ³¨ï¼š</p>
          <ul class="tutorial-step-content">
            <li>é¥±é£Ÿï¼šéœ€è¦æ®‹ç¾¹å‰©é¥­æ¥å¢åŠ é¥±é£Ÿåº¦</li>
            <li>æ°´åˆ†ï¼šéœ€è¦é¥®ç”¨è¡¥å……æ°´åˆ†</li>
            <li>ä½“æ¸©ï¼šéœ€è¦ä¿æš–ç‰©å“ç»´æŒæ­£å¸¸ä½“æ¸©</li>
            <li>å¥åº·ï¼šé¿å…ç”Ÿç—…ï¼Œä¿æŒè‰¯å¥½çŠ¶æ€</li>
            <li>ç²¾ç¥ï¼šå½±å“ä½ çš„ä¹è®¨æ•ˆç‡å’Œå†³ç­–èƒ½åŠ›</li>
            <li>å£°æœ›ï¼šå½±å“NPCå¯¹ä½ çš„æ€åº¦å’Œå¯è®¿é—®çš„åœ°ç‚¹</li>
          </ul>
          <p class="tutorial-step-content">çŠ¶æ€è¿‡ä½ä¼šå½±å“ä½ çš„ç”Ÿå­˜èƒ½åŠ›ï¼Œç”šè‡³å¯¼è‡´æ­»äº¡ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep5">
          <h3 class="tutorial-step-title">æ¢ç´¢åœ°ç‚¹</h3>
          <p class="tutorial-step-content">ä¸åŒçš„åœ°ç‚¹æä¾›ä¸åŒçš„èµ„æºå’Œäº‹ä»¶ï¼š</p>
          <ul class="tutorial-step-content">
            <li>ä¸œè¥¿å¸‚ï¼šä¹è®¨çš„ä¸»è¦åœ°ç‚¹</li>
            <li>ç°å‘ï¼šå¯»æ‰¾é£Ÿç‰©æ®‹æ¸£å’Œææ–™</li>
            <li>ä¸‡ä½›å¯ºï¼šå¯ä»¥è·å¾—å…è´¹æ®‹ç¾¹å‰©é¥­å’Œä¼‘æ¯</li>
            <li>é”£é¼“å··ï¼šä¹è®¨æ•ˆç‡é«˜ä½†é£é™©å¤§</li>
            <li>é¸¡æ¯›æˆ¿ï¼šä¸å…¶ä»–ä¹ä¸äº’åŠ¨</li>
          </ul>
          <p class="tutorial-step-content">ç‚¹å‡»åœ°ç‚¹å¡ç‰Œå¯ä»¥æ¢ç´¢è¯¥åœ°ç‚¹ï¼Œè·å¾—èµ„æºæˆ–è§¦å‘äº‹ä»¶ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep6">
          <h3 class="tutorial-step-title">æ—¶é—´ä¸å­£èŠ‚</h3>
          <p class="tutorial-step-content">æ¸¸æˆä»¥å›åˆåˆ¶è¿›è¡Œï¼Œæ¯ä¸ªå›åˆä»£è¡¨ä¸€å¤©ã€‚æ—¶é—´çš„æµé€ä¼šå½±å“ï¼š</p>
          <ul class="tutorial-step-content">
            <li>èµ„æºæ¶ˆè€—ï¼šæ®‹ç¾¹å‰©é¥­å’Œä¿æš–ç‰©å“ä¼šéšæ—¶é—´æ¶ˆè€—</li>
            <li>å­£èŠ‚å˜åŒ–ï¼šä¸åŒå­£èŠ‚æœ‰ä¸åŒçš„ç”Ÿå­˜æŒ‘æˆ˜</li>
            <li>äº‹ä»¶è§¦å‘ï¼šæŸäº›äº‹ä»¶åªåœ¨ç‰¹å®šæ—¶é—´æˆ–å­£èŠ‚å‘ç”Ÿ</li>
          </ul>
          <p class="tutorial-step-content">åˆç†è§„åˆ’ä½ çš„æ—¶é—´ï¼Œä¸ºå³å°†åˆ°æ¥çš„å­£èŠ‚åšå¥½å‡†å¤‡ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep7">
          <h3 class="tutorial-step-title">ç›®æ ‡ä¸ç»“å±€</h3>
          <p class="tutorial-step-content">æ¸¸æˆæœ‰å¤šç§å¯èƒ½çš„ç»“å±€ï¼Œå–å†³äºä½ çš„é€‰æ‹©å’Œè¡ŒåŠ¨ï¼š</p>
          <ul class="tutorial-step-content">
            <li>ç”Ÿå­˜ç»“å±€ï¼šå°½å¯èƒ½é•¿æ—¶é—´åœ°æ´»ä¸‹å»</li>
            <li>è´¢å¯Œç»“å±€ï¼šç§¯ç´¯è¶³å¤Ÿçš„è´¢å¯Œæ‘†è„±ä¹ä¸èº«ä»½</li>
            <li>å£°æœ›ç»“å±€ï¼šè·å¾—è¶³å¤Ÿçš„å£°æœ›æˆä¸ºä¹ä¸ä¹‹ç‹</li>
            <li>çŸ¥è¯†ç»“å±€ï¼šå­¦ä¹ è¶³å¤Ÿçš„æŠ€èƒ½æ‰¾åˆ°å·¥ä½œ</li>
            <li>æ­»äº¡ç»“å±€ï¼šå› é¥±é£Ÿåº¦è¿‡ä½ã€ä½“æ¸©å¼‚å¸¸ã€ç–¾ç—…æˆ–å…¶ä»–åŸå› æ­»äº¡</li>
          </ul>
          <p class="tutorial-step-content">ä½ çš„æ¯ä¸€ä¸ªé€‰æ‹©éƒ½ä¼šå½±å“æœ€ç»ˆçš„ç»“å±€ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep8">
          <h3 class="tutorial-step-title">å¼€å§‹ä½ çš„ç”Ÿå­˜ä¹‹æ—…</h3>
          <p class="tutorial-step-content">ç°åœ¨ä½ å·²ç»äº†è§£äº†æ¸¸æˆçš„åŸºæœ¬æœºåˆ¶ï¼Œæ˜¯æ—¶å€™å¼€å§‹ä½ çš„ç”Ÿå­˜ä¹‹æ—…äº†ã€‚</p>
          <p class="tutorial-step-content">è®°ä½ï¼šåœ¨è¿™ä¸ªæ®‹é…·çš„ä¸–ç•Œä¸­ï¼Œæ¯ä¸€ä¸ªé€‰æ‹©éƒ½è‡³å…³é‡è¦ã€‚ç¥ä½ å¥½è¿ï¼</p>
        </div>
      </div>
      <div class="tutorial-navigation">
        <button class="tutorial-button ink-button ink-button-primary" id="closeTutorialBtn">å…³é—­</button>
      </div>
      </div>
  </div>

  <!-- æ¸¸æˆå®¹å™¨åŒ…è£…å™¨ -->
  <div class="game-wrapper" style="display: flex; justify-content: center; align-items: flex-start; width: 100%; min-height: 100vh; padding: 1rem 0;">
    <!-- æ¸¸æˆå®¹å™¨ -->
    <div class="game-container" id="gameContainer" style="display: none; width: 100%; max-width: 1200px; margin: 0 auto; padding: 1rem; box-sizing: border-box;">
    <!-- å¤©æ°”æ•ˆæœå®¹å™¨ -->
    <div id="weatherEffectsContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999;"></div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-content">
      <!-- å·¦ä¾§çŠ¶æ€æ  -->
      <div class="sidebar">
        <!-- å¸®åŠ©æŒ‰é’® -->
        <button class="help-button ink-button ink-button-small" id="helpButton" style="position: absolute; top: 0.5rem; left: 0.5rem; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; z-index: 1000;">?</button>
        <!-- è®¾ç½®æŒ‰é’® -->
        <button class="settings-button ink-button ink-button-small" id="settingsButton" style="position: absolute; top: 0.5rem; right: 0.5rem; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; z-index: 1000;">âš™ï¸</button>
        <div class="sidebar-section ink-border">
          <!-- å­£èŠ‚å’Œå¤©æ°”æ˜¾ç¤º -->
          <div class="season-weather-indicator" style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; font-size: 1.1rem;">
            <div class="season-indicator" style="display: flex; align-items: center; gap: 0.5rem;">
              <span class="season-icon" id="seasonIcon">ğŸŒ±</span>
              <span id="seasonName" style="font-weight: 600; color: #2D3748;">æ˜¥å­£</span>
            </div>
            <div class="weather-indicator" style="display: flex; align-items: center; gap: 0.5rem;">
              <span class="weather-icon" id="weatherIcon">â˜€ï¸</span>
              <span id="weatherName" style="font-weight: 600; color: #2D3748;">æ™´å¤©</span>
            </div>
          </div>
          
          <!-- æ—¶é—´å’Œå¤©æ•°æ˜¾ç¤º -->
          <div class="day-time-indicator" style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 600; color: #2D3748;">
            <div class="day-indicator" style="display: flex; align-items: center; gap: 0.5rem;">
              ç¬¬ <span class="day-number" id="dayNumber">1</span> å¤©
            </div>
            <div class="time-indicator" style="display: flex; align-items: center; gap: 0.5rem;">
              <span class="time-of-day" id="timeOfDay">æ¸…æ™¨</span>
            </div>
          </div>
          
          <!-- ä¸‹ä¸€å¤©æŒ‰é’® -->
          <div class="next-day-control" style="display: flex; justify-content: center; margin-bottom: 1rem;">
            <button id="nextDayButton" onclick="goToNextDay()" class="ink-button ink-button-primary" style="font-size: 0.9rem;">
              ä¸‹ä¸€å¤©
            </button>
          </div>
          
          <!-- çŠ¶æ€æ æ§åˆ¶æŒ‰é’® -->
          <div class="status-controls" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: center; font-size: 1.5rem;">
            <button id="equipmentButton" class="ink-button ink-button-small" style="margin: 0.25rem; font-size: 1.1rem;">
              è£…å¤‡
            </button>
            <button id="skillsButton" class="ink-button ink-button-small" style="margin: 0.25rem; font-size: 1.1rem;">
              æŠ€èƒ½
            </button>
            <button id="mapButton" class="ink-button ink-button-small" style="margin: 0.25rem; font-size: 1.1rem;">
              åœ°å›¾
            </button>
          </div>
          

          
          <div class="status-grid">
            <!-- è¡€é‡ -->
            <div class="card status" id="bloodCard">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  è¡€é‡
                  <span class="status-percentage" id="bloodPercentage" style="font-size: 0.875rem;">100%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="bloodBar" style="width: 100%; background-color: #E53E3E;"></div>
                </div>
              </div>
            </div>
            <!-- é¥±é£Ÿ -->
            <div class="card status" id="hungerCard">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  é¥±é£Ÿ
                  <span class="status-percentage" id="hungerPercentage" style="font-size: 0.875rem;">50%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="hungerBar" style="width: 50%; background-color: #48BB78;"></div>
                </div>
              </div>
            </div>
            <!-- æ°´åˆ† -->
            <div class="card status" id="thirstCard">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  æ°´åˆ†
                  <span class="status-percentage" id="thirstPercentage" style="font-size: 0.875rem;">100%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="thirstBar" style="width: 100%; background-color: #3182CE;"></div>
                </div>
              </div>
            </div>
            <!-- æ¶ˆåŒ– -->
            <div class="card status" id="digestionCard">
              <div class="card-content" style="position: relative;">
                <div class="card-title" style="font-size: 0.875rem;">
                  æ¶ˆåŒ–
                  <span class="status-percentage" id="digestionPercentage" style="font-size: 0.875rem;">0%</span>
                </div>
                <div class="progress-bar" style="height: 4px;">
                  <div class="progress-bar-fill" id="digestionBar" style="width: 0%; background-color: #D69E2E;"></div>
                </div>
                <button id="excreteButton" class="status-button" style="display: block; position: absolute; top: 5px; right: 10px; background: #A0AEC0; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem; cursor: not-allowed; opacity: 0.6; z-index: 10;" disabled>æ’æ³„</button>
              </div>
            </div>
            <!-- ç²¾ç¥ -->
            <div class="card status" id="spiritCard">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  ç²¾ç¥
                  <span class="status-percentage" id="spiritPercentage" style="font-size: 0.875rem;">70%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="spiritBar" style="width: 70%; background-color: #805AD5;"></div>
                </div>
              </div>
            </div>
            <!-- å¥åº· -->
            <div class="card status" id="healthCard">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  å¥åº·
                  <span class="status-percentage" id="healthPercentage" style="font-size: 0.875rem;">80%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="healthBar" style="width: 80%; background-color: #38A169;"></div>
                </div>
              </div>
            </div>
            <!-- ä½“æ¸© -->
            <div class="card status" id="coldCard">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  ä½“æ¸©
                  <span class="status-percentage" id="coldPercentage" style="font-size: 0.875rem;">36â„ƒ</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="coldBar" style="width: 31.25%; background-color: #3182CE;"></div>
                </div>
              </div>
            </div>
            <!-- å£°æœ› -->
            <div class="card status" id="reputationCard">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  å£°æœ›
                  <span class="status-percentage" id="reputationPercentage" style="font-size: 0.875rem;">20%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="reputationBar" style="width: 20%; background-color: #D69E2E;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸»è¦åŒºåŸŸ -->
      <div class="main-area">
        <!-- è¡ŒåŠ¨åŒºåŸŸ -->
        <div class="sidebar-section ink-border">
          <h2 class="sidebar-section-title ink-text">è¡ŒåŠ¨</h2>

          <div class="action-grid-container">
            <div class="action-grid" id="actionGrid">
              <!-- è¡ŒåŠ¨å¡ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="action-scrollbar" id="actionScrollbar">
              <div class="action-scrollbar-thumb" id="actionScrollbarThumb"></div>
            </div>
          </div>
        </div>

        <!-- åœ°é¢åŒºåŸŸ -->
        <div class="sidebar-section ink-border">
          <h2 class="sidebar-section-title ink-text">åœ°é¢</h2>

          <!-- åœ°é¢åˆ†ç±»æ ‡ç­¾ -->
          <div class="ground-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #E2E8F0; padding-bottom: 0.5rem; flex-wrap: wrap;">
            <button class="ground-tab ink-button ink-button-small ink-button-primary active" data-category="all" style="font-size: 1.1rem;">å…¨éƒ¨</button>
            <button class="ground-tab ink-button ink-button-small" data-category="food" style="font-size: 1.1rem;">é£Ÿç‰©</button>
            <button class="ground-tab ink-button ink-button-small" data-category="material" style="font-size: 1.1rem;">ææ–™</button>
            <button class="ground-tab ink-button ink-button-small" data-category="seed" style="font-size: 1.1rem;">ç§å­</button>
            <button class="ground-tab ink-button ink-button-small" data-category="animal" style="font-size: 1.1rem;">åŠ¨ç‰©</button>
            <button class="ground-tab ink-button ink-button-small" data-category="tool" style="font-size: 1.1rem;">å·¥å…·</button>
            <button class="ground-tab ink-button ink-button-small" data-category="equipment" style="font-size: 1.1rem;">è£…å¤‡</button>
            <button class="ground-tab ink-button ink-button-small" data-category="other" style="font-size: 1.1rem;">å…¶å®ƒ</button>
          </div>

          <div class="ground-container">
            <div class="ground-grid" id="groundGrid">
              <!-- åœ°é¢ç‰©å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="ground-scrollbar" id="groundScrollbar">
              <div class="ground-scrollbar-thumb" id="groundScrollbarThumb"></div>
            </div>
          </div>
        </div>

        <!-- èƒŒåŒ…åŒºåŸŸ -->
        <div class="sidebar-section ink-border">
          <div class="flex justify-between items-center">
            <h2 class="sidebar-section-title ink-text">èƒŒåŒ…</h2>
            <button id="craftingButton" class="ink-button ink-button-small" style="font-size: 1.1rem;">åˆ¶ä½œ</button>
          </div>





          <!-- èƒŒåŒ…å®¹å™¨ -->
          <div class="resource-container">
            <!-- èƒŒåŒ…ç½‘æ ¼ -->
            <div class="resource-grid" id="resourceGrid">
              <!-- èƒŒåŒ…ç‰©å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- åœ°å›¾æ¨¡æ€æ¡† -->
  <div class="map-modal" id="mapModal">
    <div class="map-modal-content ink-border">
      <div class="map-modal-header">
        <button class="map-modal-close ink-button ink-button-small" id="closeMapButton">&times;</button>
      </div>
      <div class="map-modal-body">
        <div id="mapLocationGrid">
          <!-- åœ°ç‚¹å¡ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <!-- äº‹ä»¶æ¨¡æ€æ¡† -->
  <div class="event-modal" id="eventModal">
    <div class="event-modal-content ink-border">
      <div class="event-modal-header">
        <h2 class="event-modal-title ink-text" id="eventTitle">äº‹ä»¶</h2>
        <button class="event-modal-close ink-button ink-button-small" id="closeEventButton">&times;</button>
      </div>
      <div class="event-modal-body">
        <p class="event-modal-text" id="eventText">äº‹ä»¶æè¿°å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
        <div class="event-modal-options" id="eventOptions">
          <!-- äº‹ä»¶é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      </div>
  </div>

  <!-- é…æ–¹æ¨¡æ€æ¡† -->
  <div class="recipe-modal" id="recipeModal">
    <div class="recipe-modal-content ink-border">
      <div class="recipe-modal-header">
        <h2 class="recipe-modal-title ink-text">å·²çŸ¥é…æ–¹</h2>
        <button class="recipe-modal-close ink-button ink-button-small" id="closeRecipeButton">&times;</button>
      </div>
      <div class="recipe-grid" id="recipeGrid">
        <!-- é…æ–¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
      </div>
  </div>

  <!-- åˆ¶ä½œçª—å£æ¨¡æ€æ¡† -->
  <div class="crafting-modal" id="craftingModal">
    <div class="crafting-modal-content ink-border">
      <div class="crafting-modal-header">
        <h2 class="crafting-modal-title ink-text" style="font-size: 1.6rem;">åˆ¶ä½œ</h2>
        <button class="crafting-modal-close ink-button ink-button-small" id="closeCraftingButton">&times;</button>
      </div>
      <div class="crafting-modal-body">
        <!-- å·¦ä¾§ï¼šèƒŒåŒ…å¡ç‰Œåˆ—è¡¨ -->
        <div class="crafting-left">
          <h3 class="crafting-section-title" style="font-size: 1.3rem;">èƒŒåŒ…å¡ç‰Œ</h3>
          <div class="crafting-inventory" id="craftingInventory">
            <!-- å¡ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <!-- åœ°é¢æ å¡ç‰Œåˆ—è¡¨ -->
          <h3 class="crafting-section-title" style="font-size: 1.3rem; margin-top: 1rem;">åœ°é¢å¡ç‰Œ</h3>
          <div class="crafting-inventory" id="craftingGroundInventory">
            <!-- åœ°é¢å¡ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

<!-- å³ä¾§ï¼šç»„åˆåŒºåŸŸ -->
        <div class="crafting-right">
          <h3 class="crafting-section-title" style="font-size: 1.3rem;">ç»„åˆåŒºåŸŸ</h3>
          <div class="crafting-buttons">
            <button class="crafting-button ink-button ink-button-small" id="craftButton" disabled style="font-size: 1.1rem;">ç»„åˆ</button>
            <button class="crafting-button ink-button ink-button-small" id="craftRecipeButton" style="font-size: 1.1rem;">é…æ–¹</button>
          </div>
          <div class="crafting-slots" id="craftingSlots">
            <div class="crafting-slot" data-slot="1"></div>
            <div class="crafting-slot" data-slot="2"></div>
            <div class="crafting-slot" data-slot="3"></div>
          </div>
        </div>
      </div>
      </div>
  </div>

  <!-- æ¸¸æˆç»“æŸæ¨¡æ€æ¡† -->
  <div class="game-over-modal" id="gameOverModal">
    <div class="game-over-modal-content ink-border">
      <div class="game-over-modal-header">
        <h2 class="game-over-modal-title ink-text" id="gameOverTitle">æ¸¸æˆç»“æŸ</h2>
      </div>
      <div class="game-over-modal-body">
        <div class="ink-decoration">
          <p class="game-over-modal-text" id="gameOverText">æ¸¸æˆç»“æŸåŸå› å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
        </div>
        <div class="game-over-stats">
          <h3 class="game-over-stats-title ink-text">ç”Ÿå­˜ç»Ÿè®¡</h3>
          <div class="game-over-stats-grid">
            <div class="game-over-stat">
              <span>ç”Ÿå­˜å¤©æ•°ï¼š</span>
              <span class="game-over-stat-value" id="daysSurvived">0</span>
            </div>
            <div class="game-over-stat">
              <span>æœ€é«˜å£°æœ›ï¼š</span>
              <span class="game-over-stat-value" id="maxReputation">0%</span>
            </div>
            <div class="game-over-stat">
              <span>æ”¶é›†èµ„æºï¼š</span>
              <span class="game-over-stat-value" id="resourcesCollected">0</span>
            </div>
            <div class="game-over-stat">
              <span>å‘ç°é…æ–¹ï¼š</span>
              <span class="game-over-stat-value" id="recipesDiscovered">0</span>
            </div>
          </div>
        </div>
        <div class="game-over-modal-options">
          <button class="game-over-button ink-button ink-button-primary" id="exitGameButton">è¿”å›ä¸»é¡µé¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥ç°åœ¨ä½¿ç”¨ç®€å•çš„æ–‡å­—æç¤ºï¼Œæ— éœ€HTMLç»“æ„ -->

  <!-- è¡ŒåŠ¨ç‚¹ä¸è¶³æç¤ºçª—å£ -->
  <div class="action-points-modal" id="actionPointsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="action-points-modal-content ink-border" style="padding: 2rem; max-width: 400px; text-align: center; background-color: #FFFDF7;">
      <div class="ink-decoration">
        <h3 class="action-points-modal-title ink-text">è¡ŒåŠ¨ç‚¹ä¸è¶³</h3>
        <p class="action-points-modal-message">
          è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼Œå¯ä»¥ç‚¹å‡»è¿›å…¥ä¸‹ä¸€å¤©å³å¯æ¢å¤æ»¡è¡ŒåŠ¨ç‚¹
        </p>
      </div>
      <div class="action-points-modal-actions" style="display: flex; gap: 1rem; justify-content: center;">
        <button class="action-points-modal-button ink-button ink-button-primary" id="closeActionPointsModal">
          å…³é—­
        </button>
        <button class="action-points-modal-button ink-button-carved ink-button-small" id="endDayActionPointsModal" style="position: relative; overflow: hidden;">
          <span class="button-text">è¿›å…¥ä¸‹ä¸€å¤©</span>
          <!-- ç¥¥äº‘èŠ±çº¹è£…é¥° -->
          <div class="carved-pattern carved-clouds"></div>
          <!-- æ¢…èŠ±èŠ±çº¹è£…é¥° -->
          <div class="carved-pattern carved-plum"></div>
          <!-- ç«¹å¶èŠ±çº¹è£…é¥° -->
          <div class="carved-pattern carved-bamboo"></div>
        </button>
      </div>
      </div>
  </div>

  <!-- æˆå°±é€šçŸ¥ -->
  <div class="achievement-modal ink-border" id="achievementModal">
    <div class="achievement-icon">
      <i class="fa fa-trophy" aria-hidden="true"></i>
    </div>
    <div class="achievement-content">
      <h3 class="achievement-title ink-text" id="achievementTitle">æˆå°±è§£é”</h3>
      <p class="achievement-description" id="achievementDescription">æˆå°±æè¿°å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
    </div>
    <button class="achievement-close ink-button ink-button-small" id="closeAchievementButton">&times;</button>
  </div>

  <!-- æ»‘å—å°æ¸¸æˆæ¨¡æ€æ¡† -->
  <div class="slider-game-modal" id="sliderGameModal">
    <div class="slider-game-content ink-border">
      <h2 class="slider-game-title ink-text">æ»‘å—å°æ¸¸æˆ</h2>
      <div class="slider-game-container">
        <!-- æ»‘å—è½¨é“å’ŒåŒºåŸŸ -->
        <div class="slider-track" id="sliderTrack">
          <div class="target-area" id="targetArea"></div>
          <div class="non-target-area" id="nonTargetArea1"></div>
          <div class="non-target-area" id="nonTargetArea2"></div>
        </div>

<!-- ä¸‰è§’å½¢æ»‘å— -->
        <div class="slider-triangle" id="sliderTriangle"></div>

        <!-- æ—¶é—´å€’æ•°æ¡ -->
        <div class="timer-bar-container">
          <div class="timer-bar" id="timerBar"></div>
        </div>

<!-- æ§åˆ¶æŒ‰é’® -->
        <div class="slider-controls">
          <button class="slider-button ink-button ink-button-primary" id="stopButton">åœæ­¢</button>
          <div class="slider-instructions">æŒ‰ç©ºæ ¼é”®æˆ–ç‚¹å‡»åœæ­¢æŒ‰é’®</div>
        </div>
      </div>
      </div>
  </div>

  <script>
    // å…¨å±€å˜é‡ - ä¸å¯æ¶ˆè€—çš„ç¢—ç±»å¡ç‰Œ
    const nonConsumableBowls = ['bowl', 'clay_bowl', 'pottery_bowl', 'silver_bowl', 'gold_bowl'];
    
    // 12ä¸ªæ—¶è¾°æ˜ å°„è¡¨ï¼ˆ24å°æ—¶åˆ¶ï¼‰
    const hourToShichen = [
      { hour: 23, name: 'å­æ—¶', range: '(23:00 - 01:00)' },  // å­æ—¶
      { hour: 1, name: 'ä¸‘æ—¶', range: '(01:00 - 03:00)' },   // ä¸‘æ—¶
      { hour: 3, name: 'å¯…æ—¶', range: '(03:00 - 05:00)' },   // å¯…æ—¶
      { hour: 5, name: 'å¯æ—¶', range: '(05:00 - 07:00)' },   // å¯æ—¶
      { hour: 7, name: 'è¾°æ—¶', range: '(07:00 - 09:00)' },   // è¾°æ—¶
      { hour: 9, name: 'å·³æ—¶', range: '(09:00 - 11:00)' },   // å·³æ—¶
      { hour: 11, name: 'åˆæ—¶', range: '(11:00 - 13:00)' },  // åˆæ—¶
      { hour: 13, name: 'æœªæ—¶', range: '(13:00 - 15:00)' },  // æœªæ—¶
      { hour: 15, name: 'ç”³æ—¶', range: '(15:00 - 17:00)' },  // ç”³æ—¶
      { hour: 17, name: 'é…‰æ—¶', range: '(17:00 - 19:00)' },  // é…‰æ—¶
      { hour: 19, name: 'æˆŒæ—¶', range: '(19:00 - 21:00)' },  // æˆŒæ—¶
      { hour: 21, name: 'äº¥æ—¶', range: '(21:00 - 23:00)' }   // äº¥æ—¶
    ];

    // æ ¹æ®å°æ—¶è·å–æ—¶è¾°ä¿¡æ¯çš„å‡½æ•°
    function getShichenByHour(hour) {
      // å¤„ç†è·¨å¤©çš„æƒ…å†µï¼ˆ23ç‚¹åå±äºå­æ—¶ï¼‰
      const adjustedHour = hour === 0 ? 23 : hour;
      for (let i = 0; i < hourToShichen.length; i++) {
        const shichen = hourToShichen[i];
        if (adjustedHour === shichen.hour || (i === 0 && hour >= 23) || (i > 0 && hour >= shichen.hour && hour < hourToShichen[(i + 1) % 12].hour)) {
          return shichen;
        }
      }
      // å¤„ç†23ç‚¹åˆ°24ç‚¹çš„æƒ…å†µ
      if (hour >= 23) {
        return hourToShichen[0]; // å­æ—¶
      }
      return hourToShichen[0]; // é»˜è®¤è¿”å›å­æ—¶
    }

    // æ ¹æ®å°æ—¶æ•°è®¡ç®—æ—¶é—´æ®µ
    function updateTimeOfDay(hour) {
      if (hour >= 5 && hour < 9) {
        return 'early_morning'; // æ¸…æ™¨ 05:00-08:59
      } else if (hour >= 9 && hour < 12) {
        return 'morning'; // ä¸Šåˆ 09:00-11:59
      } else if (hour >= 12 && hour < 18) {
        return 'afternoon'; // ä¸‹åˆ 12:00-17:59
      } else if (hour >= 18 && hour < 21) {
        return 'evening'; // å‚æ™š 18:00-20:59
      } else {
        return 'night'; // å¤œæ™š 21:00-04:59
      }
    }

    // æ¸¸æˆæ•°æ®
    const gameData = {
      day: 1,
      currentHour: 7, // å½“å‰å°æ—¶æ•° (0-24)ï¼Œæ¸¸æˆä»è¾°æ—¶(07:00)å¼€å§‹
      currentMinute: 0, // å½“å‰åˆ†é’Ÿæ•° (0-59)
      timeOfDay: 'morning', // å½“å‰æ—¶é—´æ®µï¼šearly_morning(æ¸…æ™¨), morning(ä¸Šåˆ), afternoon(ä¸‹åˆ), evening(å‚æ™š), night(å¤œæ™š)
      season: 'spring', // spring, summer, autumn, winter
      weather: 'sunny', // sunny, rainy, snowy
      currentScene: '', // å½“å‰åœºæ™¯ï¼ˆç”¨äºåœºæ™¯éŸ³æ•ˆï¼‰
      begging_chance: 0, // ä¹è®¨æˆåŠŸç‡åŠ æˆ
      fastingDayClaimed: false, // æ”¾æ–‹æ—¥æ˜¯å¦å·²ç»é¢†å–è¿‡ç‰©å“
      fastingDayNotified: false, // æ”¾æ–‹æ—¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡é€šçŸ¥
      divinationDoneToday: false, // ä»Šå¤©æ˜¯å¦å·²ç»åœå¦è¿‡
      combinationSlots: { 0: null, 1: null, 2: null, 3: null },
      backgroundMusicEnabled: true, // èƒŒæ™¯éŸ³ä¹æ˜¯å¦å¯ç”¨
      backgroundMusicVolume: 0.5, // èƒŒæ™¯éŸ³ä¹éŸ³é‡ (0-1)
      groundResources: {}, // åœ°é¢èµ„æºï¼ŒæŒ‰åœºæ™¯å­˜å‚¨åœ°é¢å¡ç‰Œï¼ˆæ ¼å¼ï¼š{ locationId: [{ resourceId, resource, amount }] }ï¼‰
      foodBatches: {}, // é£Ÿç‰©æ‰¹æ¬¡è¿½è¸ªç³»ç»Ÿï¼Œè®°å½•æ¯ä¸ªé£Ÿç‰©èµ„æºçš„æ‰¹æ¬¡ä¿¡æ¯ï¼ˆæ ¼å¼ï¼š{ resourceId: [{ amount, obtainDay, obtainHour, obtainMinute, expirationDays }] }ï¼‰
      resources: {
        'cangenshengfan': { name: 'æ®‹ç¾¹å‰©é¥­', description: 'ä¹è®¨æˆ–æœå¯»è·å¾—çš„é£Ÿç‰©æ®‹æ¸£ï¼Œè™½ç„¶èƒ½å¢åŠ é¥±é£Ÿåº¦ï¼Œä½†å¯èƒ½å½±å“å¥åº·', amount: 0, image: 'UI/æ®‹ç¾¹å‰©é¥­.jpg', type: 'consumable', category: 'food', expirationDays: 2, isPerishable: true },
        'money': { name: 'é’±å¸', amount: 0, image: 'UI/é’±å¸.jpg', category: 'material' },
        'cloth': { name: 'ç ´å¸ƒ', amount: 0, image: 'UI/ç ´å¸ƒ.jpg', category: 'material' },
        'stick': { name: 'æœ¨æ£', amount: 0, image: 'UI/æœ¨æ£.jpg', category: 'material' },
        'paper': { name: 'åºŸçº¸', amount: 0, image: 'UI/åºŸçº¸.jpg', category: 'material' },
        'bowl': { name: 'ç ´ç¢—', amount: 1, image: 'UI/ç ´ç¢—.jpg', category: 'material' },
        'medicine': { name: 'çµè¯', description: 'çè´µçš„è‰è¯ï¼Œèƒ½æ¢å¤å¤§é‡å¥åº·', amount: 0, image: 'UI/çµè¯.jpg', type: 'consumable', category: 'other' },
        'cornbread': { name: 'çªçªå¤´', description: 'ç²—ç²®åˆ¶æˆçš„å¹²ç²®ï¼Œèƒ½æœ‰æ•ˆè¡¥å……ä½“åŠ›', amount: 0, image: 'UI/çªçªå¤´.jpg', type: 'consumable', category: 'food', expirationDays: 3, isPerishable: true },
        'porridge': { name: 'ç¨€ç²¥', description: 'å¯ºåº™æ–½èˆçš„ç¨€ç²¥ï¼Œèƒ½ç¼“è§£é¥¥é¥¿', amount: 0, image: 'UI/ç¨€ç²¥.jpg', type: 'consumable', category: 'food', expirationDays: 1, isPerishable: true },
        // æ–°å¢èµ„æºå®šä¹‰
        'herb': { name: 'è‰è¯', description: 'å¯ä»¥ç”¨æ¥åˆ¶ä½œè¯å“çš„æ¤ç‰©', amount: 0, image: 'UI/è‰è¯.jpg', category: 'material' },
        'pill': { name: 'è¯ä¸¸', description: 'ç”±è‰è¯åˆ¶æˆçš„è¯å“ï¼Œå¯æ¢å¤å¤§é‡å¥åº·', amount: 0, image: 'UI/è¯ä¸¸.jpg', type: 'consumable', category: 'food', expirationDays: 15, isPerishable: true },
        'bamboo': { name: 'ç«¹å­', description: 'åšéŸ§çš„ç«¹å­ï¼Œå¯ç”¨äºåˆ¶ä½œå·¥å…·å’Œæ­¦å™¨', amount: 0, image: 'UI/ç«¹å­.jpg', category: 'material' },
        'bamboo_bow': { name: 'ç«¹å¼“', description: 'ç”¨ç«¹å­å’Œç‰›ç­‹åˆ¶æˆçš„å¼“ï¼Œæ”»å‡»åŠ›å¼º', amount: 0, image: 'UI/ç«¹å¼“.jpg', equipmentSlot: 'weapon', durability: 100, damage: 10, hitRate: 10, category: 'equipment' },
        'cow_tendon': { name: 'ç‰›ç­‹', description: 'åšéŸ§çš„ç‰›ç­‹ï¼Œç”¨äºåˆ¶ä½œå¼“å¼¦ç­‰', amount: 0, image: 'UI/ç‰›ç­‹.jpg', category: 'material' },
        'wild_buffalo': { name: 'é‡ç‰›', description: 'é‡ç”Ÿçš„æ°´ç‰›ï¼Œå¯ä»¥è·å–ç”Ÿè‚‰å’Œç‰›ç­‹', amount: 0, image: 'UI/é‡ç‰›.jpg', category: 'other' },
        'raw_meat': { name: 'ç”Ÿè‚‰', description: 'æœªåŠ å·¥çš„è‚‰ç±»ï¼Œéœ€è¦çƒ¹é¥ªåé£Ÿç”¨', amount: 0, image: 'UI/ç”Ÿè‚‰.jpg', type: 'consumable', category: 'food', isRaw: true, expirationDays: 1, isPerishable: true },
        'cooked_meat': { name: 'ç†Ÿè‚‰', description: 'çƒ¹é¥ªåçš„è‚‰ç±»ï¼Œæä¾›ä¸°å¯Œçš„è¥å…»', amount: 0, image: 'UI/ç†Ÿè‚‰.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 5, isPerishable: true },
        'grilled_fish': { name: 'çƒ¤é±¼', description: 'çƒ¤åˆ¶çš„é±¼ï¼Œç¾å‘³å¯å£', amount: 0, image: 'UI/çƒ¤é±¼.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 4, isPerishable: true },
        'grilled_egg': { name: 'çƒ¤è›‹', description: 'ç”¨ç¯ç«çƒ¤åˆ¶çš„è›‹ï¼Œè¥å…»ä¸°å¯Œ', amount: 0, image: 'UI/çƒ¤è›‹.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 2, isPerishable: true },
        'porcelain_bowl': { name: 'ç“·ç¢—', description: 'ç²¾è‡´çš„ç“·ç¢—ï¼Œå¤§å¹…æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/ç“·ç¢—.jpg', category: 'material' },

'pottery_bowl': { name: 'é™¶ç¢—', description: 'åšå›ºçš„é™¶ç¢—ï¼Œæé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é™¶ç¢—.jpg', category: 'material' },

        'silver_bowl': { name: 'é“¶ç¢—', description: 'çè´µçš„é“¶ç¢—ï¼Œæ˜¾è‘—æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é“¶ç¢—.jpg', category: 'material' },
        'gold_bowl': { name: 'é‡‘ç¢—', description: 'å¥¢åçš„é‡‘ç¢—ï¼Œæå¤§æé«˜ä¹è®¨æˆåŠŸç‡å’Œå£°æœ›', amount: 0, image: 'UI/é‡‘ç¢—.jpg', category: 'material' },
        'gold': { name: 'é‡‘å­', amount: 0, image: 'UI/é‡‘å­.jpg', category: 'material' },
        'animal_feed': { name: 'é€šç”¨é¥²æ–™', description: 'ç”¨äºå–‚å…»åŠ¨ç‰©çš„é¥²æ–™ï¼Œå¯ä»¥ç»´æŒåŠ¨ç‰©çš„å¥åº·', amount: 0, image: 'UI/é€šç”¨é¥²æ–™.jpg', category: 'material' },
        'grass_feed': { name: 'è‰æ–™', description: 'é©¬åŒ¹å–œçˆ±çš„è‰æ–™ï¼Œå¯ä»¥ç»´æŒé©¬åŒ¹çš„é¥±é£Ÿåº¦', amount: 0, image: 'UI/è‰æ–™.jpg', category: 'material' },
        'saltpeter': { name: 'ç¡çŸ³', description: 'ç™½è‰²ç»“æ™¶ç‰©è´¨ï¼Œå¯ç”¨äºåˆ¶ä½œå†°å—', amount: 0, image: 'UI/ç¡çŸ³.jpg', category: 'material' },
        'rotten_food': { name: 'è…çƒ‚ç‰©', description: 'è¿‡æœŸçš„é£Ÿç‰©ï¼Œå·²ç»å˜è´¨æ— æ³•é£Ÿç”¨ï¼Œä½†å¯èƒ½è¿˜æœ‰å…¶ä»–ç”¨é€”', amount: 0, image: 'UI/è…çƒ‚ç‰©.jpg', type: 'consumable', category: 'material' },
        'ice_block': { name: 'å†°å—', description: 'ç”¨äºå†°çª–ä¿é²œçš„å†°å—ï¼Œå…·æœ‰æ—¶æ•ˆæ€§', amount: 2, image: 'UI/å†°å—.jpg', type: 'consumable', category: 'food', expirationDays: 5, isPerishable: true, isIceBlock: true },
        'garbage': { name: 'åƒåœ¾', description: 'åœ¨ç°å‘ä¸­ç¿»æ‰¾è·å¾—çš„åƒåœ¾ï¼Œå¯èƒ½åŒ…å«æœ‰ä»·å€¼ç‰©å“', amount: 0, image: 'UI/åƒåœ¾.jpg', category: 'material' },
        'native_horse': { name: 'æœ¬åœŸé©¬', description: 'æ™®é€šçš„æœ¬åœŸé©¬åŒ¹ï¼Œé€‚åˆä½œä»£æ­¥å·¥å…·', amount: 0, image: 'UI/æœ¬åœŸé©¬.jpg', category: 'animal' },
        'mongolian_horse': { name: 'è’™å¤é©¬', description: 'è€åŠ›å‡ºè‰²çš„è’™å¤é©¬ï¼Œé€‚åˆé•¿é€”è·‹æ¶‰', amount: 0, image: 'UI/è’™å¤é©¬.jpg', category: 'animal' },
        'hequ_horse': { name: 'æ²³æ›²é©¬', description: 'å¼ºå£®çš„æ²³æ›²é©¬ï¼Œè´Ÿé‡èƒ½åŠ›å¼º', amount: 0, image: 'UI/æ²³æ›²é©¬.jpg', category: 'animal' },
        'ferghana_horse': { name: 'æ±—è¡€å®é©¬', description: 'çè´µçš„æ±—è¡€å®é©¬ï¼Œé€Ÿåº¦é£å¿«ï¼Œè€åŠ›æä½³', amount: 0, image: 'UI/æ±—è¡€å®é©¬.jpg', category: 'animal' },
        'super_ferghana_horse': { name: 'æå“æ±—è¡€å®é©¬', description: 'ä¸‡é‡ŒæŒ‘ä¸€çš„æå“æ±—è¡€å®é©¬ï¼Œä¼ è¯´èƒ½æ—¥è¡Œåƒé‡Œ', amount: 0, image: 'UI/æå“æ±—è¡€å®é©¬.jpg', category: 'animal' },
        'æ–§å¤´': { name: 'æ–§å¤´', description: 'é”‹åˆ©çš„æ–§å¤´ï¼Œå¯ä»¥æé«˜ç ä¼æ•ˆç‡', amount: 1, image: 'UI/æ–§å¤´.jpg', category: 'tool', equipmentSlot: 'weapon', durability: 100, damage: 15, hitRate: 80 },
        'broom': { name: 'æ‰«å¸š', description: 'ç”¨äºæ¸…æ´ç‰²å£æ å’Œé©¬å©æ ï¼Œæ¯ä½¿ç”¨ä¸€æ¬¡æ¶ˆè€—10è€ä¹…åº¦', amount: 0, image: 'UI/æ‰«å¸š.jpg', category: 'tool', durability: 100 },
        'wood': { name: 'æœ¨æ', amount: 0, image: 'UI/æœ¨æ.jpg', category: 'material' },
        'stone': { name: 'çŸ³å¤´', amount: 0, image: 'UI/çŸ³å¤´.jpg', category: 'material' },

      },
      status: {
        hunger: 50, // 0-100, è¶Šé«˜è¶Šé¥±ï¼Œè¶Šä½è¶Šé¥¿
        cold: 36.5,   // 30-50â„ƒ, ä½“æ¸©ï¼Œæ­£å¸¸èŒƒå›´36-37â„ƒ
        health: 80, // 0-100, è¶Šä½è¶Šä¸å¥åº·
        blood: 100, // 0-100, è¡€é‡ï¼Œè¶Šä½è¶Šå±é™©
        spirit: 70, // 0-100, è¶Šä½ç²¾ç¥è¶Šå·®
        reputation: 0, // 0-100, è¶Šé«˜å£°æœ›è¶Šå¥½
        thirst: 100, // 0-100, è¶Šé«˜æ°´åˆ†è¶Šå……è¶³ï¼Œè¶Šä½è¶Šç¼ºæ°´
        digestion: 0, // 0-100, æ¶ˆåŒ–å€¼ï¼Œè¾¾åˆ°100æ—¶å¯æ’æ³„è·å¾—è‚¥æ–™
      },
      skills: {
        steal: { level: 0, experience: 0, maxLevel: 10, name: 'å·çªƒ' },
        medicine: { level: 0, experience: 0, maxLevel: 10, name: 'åŒ»æœ¯' },
        martial: { level: 0, experience: 0, maxLevel: 10, name: 'æ­¦æœ¯', power: 10 }, // åŸºç¡€æ­¦åŠ›å€¼10
        search: { level: 0, experience: 0, maxLevel: 10, name: 'æœå¯»' } // æœå¯»æŠ€èƒ½
      },
      buffs: {},
      skillExpRequired: [0, 10, 30, 60, 100, 150, 210, 280, 360, 450, 550], // æ¯çº§å‡çº§æ‰€éœ€ç»éªŒ
      locations: [
        { 
          id: 'street', 
          name: 'ä¸œè¥¿å¸‚', 
          description: 'ä¹è®¨çš„ä¸»è¦åœ°ç‚¹ï¼Œäººæµé‡å¤§ä½†ç«äº‰æ¿€çƒˆã€‚', 
          image: 'UI/ä¸œè¥¿å¸‚.jpg', 
          available: true,
          resourceType: 'money,food',
          dangerLevel: 'low',
          timeCost: 30, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—30åˆ†é’Ÿ
          entryCondition: { reputation: { min: 0 } },
          currentLocation: true,
          actions: ['beg', 'search', 'rest', 'get_water'],
          nightActions: ['beg', 'search', 'rest', 'get_water', 'talk_mystery']
        },
        { 
          id: 'dump', 
          name: 'ç°å‘', 
          description: 'å¯»æ‰¾é£Ÿç‰©æ®‹æ¸£å’Œæœ‰ä»·å€¼åƒåœ¾çš„åœ°æ–¹ï¼Œä½†å«ç”Ÿæ¡ä»¶å·®ã€‚', 
          image: 'UI/ç°å‘.jpg', 
          available: true,
          resourceType: 'food,cloth,stick,paper,flint,mud,hide',
          dangerLevel: 'medium',
          timeCost: 30, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—30åˆ†é’Ÿ
          entryCondition: { health: { min: 30 } },
          actions: ['loot', 'rest']
        },
        { 
          id: 'temple', 
          name: 'ä¸‡ä½›å¯º', 
          description: 'å¯ä»¥è·å¾—å…è´¹çš„é£Ÿç‰©å’Œä½å®¿ï¼Œä½†éœ€è¦éµå®ˆå¯ºåº™çš„è§„çŸ©ã€‚', 
          image: 'UI/é»‘å¸‚.jpg', 
          available: true,
          resourceType: 'food,spirit',
          dangerLevel: 'low',
          timeCost: 30, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—30åˆ†é’Ÿ
          actions: ['pray', 'rest', 'fasting_day', 'divination']
        },
        { 
          id: 'rich_area', 
          name: 'é”£é¼“å··', 
          description: 'ä¹è®¨æ•ˆç‡é«˜ï¼Œä½†é£é™©ä¹Ÿé«˜ï¼Œå®¹æ˜“è¢«é©±èµ¶ã€‚', 
          image: 'UI/é»‘å¸‚.jpg', 
          available: true,
          resourceType: 'money,black_cloth,thread',
          dangerLevel: 'high',
          timeCost: 30, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—30åˆ†é’Ÿ
          entryCondition: { reputation: { min: 30 } },
          actions: ['beg', 'steal', 'search', 'rest']
        },
        { 
          id: 'black_market', 
          name: 'é»‘å¸‚', 
          description: 'å¯ä»¥ç”¨é‡‘æ¡è´­ä¹°ç¨€æœ‰ç‰©å“çš„ç§˜å¯†å¸‚åœºã€‚', 
          image: 'UI/é»‘å¸‚.jpg', 
          available: false,
          resourceType: 'gold_bar',
          dangerLevel: 'very_high',
          timeCost: 30, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—30åˆ†é’Ÿ
          entryCondition: {}, // ç§»é™¤é»‘è‰²æ–—ç¯·ä½œä¸ºè§£é”æ¡ä»¶
          actions: ['buy_goods', 'open_black_market_shelf', 'rest']
        },
        { 
          id: 'slum', 
          name: 'é¸¡æ¯›æˆ¿', 
          description: 'èšé›†ç€å…¶ä»–ä¹ä¸ï¼Œå¯ä»¥è¿›è¡Œäº¤æ˜“å’Œåˆä½œã€‚', 
          image: 'https://p26-doubao-search-sign.byteimg.com/labis/image/ca34eef8faf2eaaa278d2cc70942e1fe~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779775073&x-signature=8D1SWhJmDtjETZt3j6%2BXhlYMVbM%3D', 
          available: true,
          resourceType: 'cloth,stick',
          dangerLevel: 'medium',
          timeCost: 30, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—30åˆ†é’Ÿ
          entryCondition: { reputation: { min: 0 } },
          actions: ['learn', 'rest'] // æš‚æ—¶æ³¨é‡Šæ‰äº¤æ˜“åŠŸèƒ½ï¼ŒåæœŸå†è¡¥å……
        },
        { 
          id: 'prison', 
          name: 'ç‰¢æˆ¿', 
          description: 'ä½ å› çŠ¯ç½ªè¢«å…³æŠ¼åœ¨è¿™é‡Œï¼Œéœ€è¦é€šè¿‡åŠ³ä½œæ¥è·å¾—è‡ªç”±ã€‚', 
          image: 'https://p3-doubao-search-sign.byteimg.com/labis/981395494749454942549425~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779775073&x-signature=8D1SWhJmDtjETZt3j6%2BXhlYMVbM%3D', 
          available: false,
          resourceType: '',
          dangerLevel: 'high',
          timeCost: 30, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—30åˆ†é’Ÿ
          entryCondition: {},
          actions: ['work', 'gamble', 'rest', 'get_water'],
          sentenceDays: 0 // å‰©ä½™åˆ‘æœŸ
        },
        {
          id: 'wilderness',
          name: 'åŸå¤–å±±é‡',
          description: 'è¿œç¦»åŸå¸‚å–§åš£çš„éƒŠå¤–ï¼Œæœ‰æ¸…æ¾ˆçš„æºªæ°´å’ŒèŒ‚å¯†çš„å±±æ—ã€‚',
          image: '',
          available: true,
          resourceType: 'herb,raw_meat',
          dangerLevel: 'medium',
          timeCost: 60, // è¿›å…¥åœ°ç‚¹æ¶ˆè€—60åˆ†é’Ÿ
          entryCondition: { health: { min: 30 } },
          actions: ['stream_action', 'mountain_action', 'explore_map']
        }
      ],
      actions: [
        { id: 'beg', name: 'ä¹è®¨', description: 'å°è¯•å‘è·¯äººä¹è®¨ï¼Œå¯èƒ½è·å¾—æ®‹ç¾¹å‰©é¥­ã€çªçªå¤´æˆ–é’±å¸ã€‚æ‹¥æœ‰æ›´å¥½çš„ç¢—å¯ä»¥æé«˜æˆåŠŸç‡ã€‚', timeCost: 30, requires: {}, success: { cangenshengfan: 1, cornbread: 1, money: 1 }, failure: { spirit: -5 } },
        { id: 'search', name: 'æœå¯»', description: 'åœ¨é™„è¿‘æœå¯»æœ‰ç”¨çš„ç‰©å“ï¼Œå¯èƒ½è·å¾—ææ–™ã€‚', timeCost: 60, requires: {}, success: { cloth: 1, stick: 1, paper: 1, flint: 1, mud: 1, black_cloth: 1, thread: 1 }, failure: { health: -5 } },
        { id: 'loot', name: 'ç¿»åƒåœ¾', description: 'åœ¨åƒåœ¾æ¡¶å†…ç¿»æ‰¾ç‰©å“ï¼Œéœ€è¦ç©ä¸€ä¸ªå°æ¸¸æˆæ¥å†³å®šè·å¾—çš„ç‰©å“ã€‚', timeCost: 45, requires: {}, success: {}, failure: {} },
        { id: 'rest', name: 'ä¼‘æ¯', description: 'æ‰¾ä¸ªåœ°æ–¹ä¼‘æ¯ï¼Œæ¢å¤å¥åº·å’Œç²¾ç¥ã€‚', timeCost: 30, requires: {}, success: { health: 10, spirit: 10 } },
        { id: 'steal', name: 'å·çªƒ', description: 'å°è¯•å·çªƒä»–äººè´¢ç‰©ï¼Œé«˜é£é™©é«˜å›æŠ¥ã€‚', timeCost: 30, requires: {}, success: { money: 3 }, failure: { health: -15 } },
        { id: 'fasting_day', name: 'æ”¾æ–‹æ—¥', description: 'ä¸‡ä½›å¯ºå‘æ”¾æ–‹é¥­çš„æ—¥å­ï¼Œè·å¾—çªçªå¤´å’Œç¨€ç²¥ã€‚', timeCost: 15, requires: {}, success: { cornbread: 1, porridge: 1 }, failure: {} },
        { id: 'pray', name: 'ç¥ˆç¦', description: 'åœ¨å¯ºåº™ç¥ˆç¥·ï¼Œæå‡å£°æœ›ã€‚', timeCost: 60, requires: {}, success: { reputation: 5 }, failure: {} },
        { id: 'divination', name: 'åœå¦', description: 'åœ¨å¯ºåº™åœå¦ï¼Œé¢„æµ‹ä½ çš„å‘½è¿ã€‚', timeCost: 30, requires: {}, success: {}, failure: {} },
        { id: 'trade', name: 'äº¤æ˜“', description: 'ä¸å…¶ä»–ä¹ä¸äº¤æ¢ç‰©èµ„ã€‚', timeCost: 45, requires: {}, success: { cloth: 2, stick: 1 }, failure: { cloth: -1, stick: -1 } },
        { id: 'learn', name: 'è€ä¹ä¸', description: 'å‘è€ä¹ä¸å­¦ä¹ æ–°é…æ–¹ï¼Œæ¯å¤©åªèƒ½å­¦ä¹ ä¸€æ¬¡ã€‚', timeCost: 60, requires: {}, success: { reputation: 10 } },

        { id: 'work', name: 'åŠ³ä½œ', description: 'åœ¨ç‰¢æˆ¿ä¸­åŠ³åŠ¨ï¼Œè·å¾—æ®‹ç¾¹å‰©é¥­ã€‚', timeCost: 90, requires: {}, success: { cangenshengfan: 1 }, failure: {} },
        { id: 'gamble', name: 'èµŒåš', description: 'åœ¨ç‰¢æˆ¿ä¸­ä¸å…¶ä»–å›šçŠ¯èµŒåšï¼Œé«˜é£é™©é«˜å›æŠ¥ã€‚', timeCost: 60, requires: {}, success: { money: 5 }, failure: { money: -2, spirit: -10 } },
        { id: 'get_water', name: 'æ°´ç¼¸', description: 'æ°´ç¼¸é‡Œçš„æ°´å¯ä»¥è§£æ¸´ã€‚', timeCost: 30, requires: {}, success: {}, failure: {} },
        { id: 'buy_medicine', name: 'è´­ä¹°çµè¯', description: 'ç”¨é‡‘æ¡è´­ä¹°çè´µçš„çµè¯ï¼Œæ¢å¤å¤§é‡å¥åº·ã€‚', timeCost: 15, requires: { gold_bar: 1 }, success: { health: 50 }, failure: {} },
        { id: 'buy_goods', name: 'è´­ä¹°è´§ç‰©', description: 'æµè§ˆé»‘å¸‚è´§æ¶ï¼Œç”¨é‡‘æ¡è´­ä¹°å„ç§ç¨€æœ‰å•†å“ã€‚', timeCost: 30, requires: {}, success: {}, failure: {} },
        { id: 'buy_slave', name: 'è´­ä¹°å¥´éš¶', description: 'ç”¨é‡‘æ¡è´­ä¹°å¥´éš¶ï¼Œè‡ªåŠ¨å¸®ä½ æ”¶é›†èµ„æºã€‚', timeCost: 30, requires: { gold_bar: 3 }, success: { slave: 1 }, failure: {} },
        { id: 'talk_mystery', name: 'ä¸ç¥ç§˜äººå¯¹è¯', description: 'åœ¨å¤œæ™šçš„ä¸œè¥¿å¸‚ä¸ç¥ç§˜äººå¯¹è¯ï¼Œå¯èƒ½è·å¾—é»‘å¸‚çš„æ¶ˆæ¯ã€‚', timeCost: 30, requires: {}, success: {}, failure: {} },
        { id: 'stream_action', name: 'æºªè¾¹', description: 'æ¥åˆ°æ¸…æ¾ˆçš„æºªè¾¹ï¼Œå¯ä»¥å–æ°´ã€è£…æ°´æˆ–æ‘¸é±¼ã€‚', timeCost: 60, requires: {}, success: {}, failure: {} },
        { id: 'mountain_action', name: 'è¿›å±±', description: 'è¿›å…¥èŒ‚å¯†çš„å±±æ—ï¼Œæ¢ç´¢å¤§è‡ªç„¶çš„å®è—ã€‚', timeCost: 120, requires: {}, success: {}, failure: {} },
        { id: 'explore_map', name: 'æ¢ç´¢', description: 'æ¢ç´¢ç»¿åœ°åœ°å›¾ï¼Œä½¿ç”¨WASDé”®æ§åˆ¶äººç‰©ç§»åŠ¨ã€‚', timeCost: 0, requires: {}, success: {}, failure: {} },
        { id: 'sleep', name: 'ç¡è§‰', description: 'åœ¨å®…é‚¸ä¸­ç¡è§‰ï¼Œæ¢å¤å¤§é‡å¥åº·å’Œç²¾ç¥ã€‚', timeCost: 480, requires: {}, success: { health: 20, spirit: 20 } },
        { id: 'nap', name: 'å°æ†©', description: 'åœ¨å®…é‚¸ä¸­å°æ†©ï¼Œæ¢å¤15%çš„å¥åº·å’Œç²¾ç¥ã€‚', timeCost: 90, requires: {}, success: { health: 15, spirit: 15 } },
        { id: 'upgrade_house', name: 'å‡çº§æˆ¿å±‹', description: 'æ¶ˆè€—æœ¨æã€çŸ³å¤´å’Œé’±å¸æ¥å‡çº§ä½ çš„å®…é‚¸ï¼Œè·å¾—æ›´å¥½çš„æ•ˆæœã€‚', timeCost: 0, requires: { wood: 10, stone: 5, money: 50 }, success: { house_level: 1 }, failure: {} },
        { id: 'store_items', name: 'ä»“åº“', description: 'å°†ç‰©å“å­˜å…¥å®…é‚¸çš„ä»“åº“ï¼Œé˜²æ­¢ä¸¢å¤±ã€‚', timeCost: 30, requires: {}, success: {}, failure: {} },
        { id: 'water_well', name: 'æ°´äº•', description: 'æ¥åˆ°å®…é‚¸çš„æ°´äº•è¾¹ï¼Œå¯ä»¥å–æ°´æˆ–è£…æ°´ã€‚', timeCost: 30, requires: {}, success: {}, failure: {} },
        { id: 'icehouse', name: 'å†°çª–', description: 'è¿›å…¥å†°çª–ä¿é²œå…·æœ‰æ—¶æ•ˆæ€§çš„é£Ÿç‰©ï¼Œé˜²æ­¢é£Ÿç‰©è…çƒ‚ã€‚', timeCost: 30, requires: {}, success: {}, failure: {} },
        { id: 'farmland', name: 'å†œç”°', description: 'è¿›å…¥å†œç”°ç®¡ç†ç•Œé¢ï¼Œç§æ¤å’Œç®¡ç†ä½œç‰©ã€‚', timeCost: 60, requires: {}, success: {}, failure: {} },
        { id: 'livestock_shed', name: 'ç‰²å£æ£š', description: 'åœ¨å®…é‚¸çš„ç‰²å£æ£šä¸­é¥²å…»åŠ¨ç‰©ï¼Œå¯ä»¥è·å¾—è‚‰å’Œçš®æ¯›ã€‚', timeCost: 60, requires: {}, success: { raw_meat: 1, hide: 1 }, failure: {} },
        { id: 'stable', name: 'é©¬å©', description: 'åœ¨å®…é‚¸çš„é©¬å©ä¸­é¥²å…»é©¬åŒ¹ï¼Œå¯ä»¥è·å¾—é«˜çº§èµ„æºå’Œäº¤é€šå·¥å…·ã€‚', timeCost: 60, requires: {}, success: { horse: 1, hide: 2 }, failure: {} }
      ],
      recipes: [
        { id: 'pill', name: 'è¯ä¸¸', description: '3ä¸ªè‰è¯åˆæˆ1ä¸ªè¯ä¸¸ï¼Œæ¢å¤40%å¥åº·åº¦', ingredients: { herb: 3 }, result: { pill: 1 } },
        { id: 'bamboo_bow', name: 'ç«¹å¼“', description: '2ä¸ªç«¹å­åŠ 1ä¸ªç‰›ç­‹åˆæˆ1ä¸ªç«¹å¼“ï¼Œæ”»å‡»+10ï¼Œå‘½ä¸­ç‡+10%', ingredients: { bamboo: 2, cow_tendon: 1 }, result: { bamboo_bow: 1 } },
        { id: 'clay_bowl', name: 'æ³¥ç¢—', description: 'æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { bowl: 1, mud: 2 }, result: { clay_bowl: 1, reputation: 5, begging_chance: 10 } },
        { id: 'ceramic_bowl', name: 'é™¶ç¢—', description: 'è¿›ä¸€æ­¥æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { clay_bowl: 1, clay: 2 }, result: { ceramic_bowl: 1, reputation: 10, begging_chance: 20 } },
        { id: 'silver_bowl', name: 'é“¶ç¢—', description: 'å¤§å¹…æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { ceramic_bowl: 1, silver_coin: 2 }, result: { silver_bowl: 1, reputation: 20, begging_chance: 30 } },
        { id: 'gold_bowl', name: 'é‡‘ç¢—', description: 'æå¤§æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { silver_bowl: 1, gold: 2 }, result: { gold_bowl: 1, reputation: 30, begging_chance: 40 } },
        { id: 'simple_clothes', name: 'ç ´è¡£æœ', description: 'æä¾›åŸºæœ¬çš„ä¿æš–ï¼Œæé«˜ä½“æ¸©', ingredients: { cloth: 2, thread: 1 }, result: { simple_clothes: 1, cold: 2 } },
        { id: 'crutch', name: 'æ‹æ–', description: 'æé«˜ç§»åŠ¨èƒ½åŠ›å’Œå£°æœ›', ingredients: { stick: 1, cloth: 2 }, result: { crutch: 1, reputation: 10 } },
        { id: 'fire', name: 'ç¯ç«', description: 'æä¾›æ¸©æš–ï¼Œçƒ¹é¥ªé£Ÿç‰©ï¼Œæé«˜ä½“æ¸©', ingredients: { stick: 2, flint: 1 }, result: { fire: 1 } },
        { id: 'cook_meat', name: 'çƒ¤è‚‰', description: 'ç”¨ç¯ç«çƒ¤åˆ¶ç”Ÿè‚‰', ingredients: { fire: 1, raw_meat: 1 }, result: { fire: 1, cooked_meat: 1 } },
        { id: 'cook_fish', name: 'çƒ¤é±¼', description: 'ç”¨ç¯ç«çƒ¤åˆ¶é±¼', ingredients: { fire: 1, fish: 1 }, result: { fire: 1, grilled_fish: 1 } },
        { id: 'cook_egg', name: 'çƒ¤è›‹', description: 'ç”¨ç¯ç«çƒ¤åˆ¶è›‹', ingredients: { fire: 1, egg: 1 }, result: { fire: 1, grilled_egg: 1 } },
        { id: 'black_cloak', name: 'é»‘è‰²æ–—ç¯·', description: 'ç”¨äºè¿›å…¥é»‘å¸‚çš„ç‰¹æ®Šè¡£ç‰©', ingredients: { black_cloth: 2, thread: 1 }, result: { black_cloak: 1 } },
        { id: 'craft_bucket', name: 'åˆ¶ä½œæœ¨æ¡¶', description: 'ç”¨æœ¨å¤´åˆ¶ä½œä¸€ä¸ªæœ¨æ¡¶', ingredients: { wood: 3 }, result: { bucket: 1 } },
        // æ³¨æ„ï¼šè£…æ»¡æ°´è¢‹å’Œé¥®ç”¨æœ¨æ¡¶æ°´çš„æ“ä½œç°åœ¨é€šè¿‡å…¶ä»–æ–¹å¼å®ç°ï¼Œè€Œä¸æ˜¯é€šè¿‡åˆ¶ä½œé…æ–¹
        { id: 'axe', name: 'æ–§å¤´', description: '1ä¸ªçŸ³å¤´åŠ 2ä¸ªæœ¨æ£å¯ä»¥åˆ¶ä½œæ–§å¤´ï¼Œæé«˜ç ä¼æ•ˆç‡', ingredients: { stone: 1, stick: 2 }, result: { æ–§å¤´: 1 } },
        { id: 'broom_grass', name: 'æ‰«å¸šï¼ˆè‰æ–™ï¼‰', description: '2ä¸ªè‰æ–™åŠ 1ä¸ªæœ¨æ£åˆ¶ä½œæ‰«å¸šï¼Œç”¨äºæ¸…æ´ç‰²å£æ å’Œé©¬å©æ ', ingredients: { grass_feed: 2, stick: 1 }, result: { broom: 1 } },
        { id: 'broom_bamboo', name: 'æ‰«å¸šï¼ˆç«¹å­ï¼‰', description: '2ä¸ªç«¹å­åŠ 1ä¸ªæœ¨æ£åˆ¶ä½œæ‰«å¸šï¼Œç”¨äºæ¸…æ´ç‰²å£æ å’Œé©¬å©æ ', ingredients: { bamboo: 2, stick: 1 }, result: { broom: 1 } },
        { id: 'animal_feed', name: 'é€šç”¨é¥²æ–™', description: '3ä¸ªç‰ç±³æˆ–3ä¸ªå°éº¦å¯ä»¥åˆ¶ä½œ10ä¸ªé€šç”¨é¥²æ–™ï¼Œç”¨äºå–‚å…»åŠ¨ç‰©', ingredients: { corn: 3 }, result: { animal_feed: 10 } },
        { id: 'animal_feed_wheat', name: 'é€šç”¨é¥²æ–™ï¼ˆå°éº¦ï¼‰', description: '3ä¸ªç‰ç±³æˆ–3ä¸ªå°éº¦å¯ä»¥åˆ¶ä½œ10ä¸ªé€šç”¨é¥²æ–™ï¼Œç”¨äºå–‚å…»åŠ¨ç‰©', ingredients: { wheat: 3 }, result: { animal_feed: 10 } },
        { id: 'ice_block', name: 'å†°å—', description: '1ä»½ç¡çŸ³åˆ¶ä½œå†°å—ï¼Œå¯ç”¨äºå†°çª–ä¿é²œï¼Œæœ‰æ•ˆæœŸ5å¤©', ingredients: { saltpeter: 1 }, result: { ice_block: 1 } }
      ],
      events: [
        {
          id: 'kind_person',
          name: 'å–„è‰¯çš„è·¯äºº',
          text: 'ä¸€ä½çœ‹èµ·æ¥å–„è‰¯çš„è·¯äººæ³¨æ„åˆ°äº†ä½ ï¼Œæƒ³è¦å¸®åŠ©ä½ ã€‚',
          options: [
            { text: 'è¯·æ±‚æ®‹ç¾¹å‰©é¥­', result: { food: 2, reputation: 5 }, description: 'è·å¾—2ä»½æ®‹ç¾¹å‰©é¥­ï¼Œæé«˜å°‘é‡å£°æœ›' },
            { text: 'è¯·æ±‚é’±è´¢', result: { money: 2, reputation: -5 }, description: 'è·å¾—2æšé’±å¸ï¼Œä½†é™ä½å°‘é‡å£°æœ›' },
            { text: 'æ‹’ç»å¸®åŠ©', result: { spirit: 10, reputation: 10 }, description: 'ç»´æŠ¤å°Šä¸¥ï¼Œæé«˜ç²¾ç¥å’Œå£°æœ›' }
          ]
        },
        {
          id: 'bully',
          name: 'æ¶éœ¸',
          text: 'ä¸€ä¸ªæ¶éœ¸å‘ä½ èµ°æ¥ï¼Œçœ‹èµ·æ¥æƒ³è¦æ¬ºè´Ÿä½ å¹¶æŠ¢èµ°ä½ çš„ä¸œè¥¿ã€‚',
          options: [
            { text: 'åæŠ—', result: { health: -10, reputation: 10 }, description: 'å¯èƒ½å—ä¼¤ï¼Œä½†èµ¢å¾—å£°æœ›' },
            { text: 'é€ƒè·‘', result: { spirit: -5, money: -1 }, description: 'æŸå¤±1æšé’±å¸ï¼Œé™ä½ç²¾ç¥' },
            { text: 'å±ˆæœ', result: { money: -2, reputation: -10 }, description: 'æŸå¤±2æšé’±å¸ï¼Œé™ä½å£°æœ›' }
          ]
        },
        {
          id: 'temple_offer',
          name: 'ä¸‡ä½›å¯ºçš„é‚€è¯·',
          text: 'å¯ºåº™çš„åƒ§äººæ³¨æ„åˆ°äº†ä½ ï¼Œé‚€è¯·ä½ å»å¯ºåº™å¸®å¿™ï¼Œä»¥æ¢å–é£Ÿç‰©å’Œä½å®¿ã€‚',
          options: [
            { text: 'æ¥å—é‚€è¯·', result: { food: 3, health: 10, spirit: 10 }, description: 'è·å¾—æ®‹ç¾¹å‰©é¥­ï¼Œæ¢å¤å¥åº·å’Œç²¾ç¥' },
            { text: 'æ‹’ç»é‚€è¯·', result: { reputation: -5, money: 1 }, description: 'è·å¾—1æšé’±å¸ï¼Œä½†é™ä½å£°æœ›' }
          ]
        },
        {
          id: 'sick',
          name: 'ç”Ÿç—…',
          text: 'ä½ æ„Ÿè§‰å¾ˆä¸èˆ’æœï¼Œå¯èƒ½æ˜¯å› ä¸ºåƒäº†å˜è´¨çš„é£Ÿç‰©æˆ–æš´éœ²åœ¨å¯’å†·ä¸­ã€‚',
          options: [
            { text: 'ä¼‘æ¯', result: { health: 10, spirit: 10 }, description: 'ä¼‘æ¯ä¸€å¤©ï¼Œæ¢å¤å¥åº·å’Œç²¾ç¥' },
            { text: 'å¯»æ±‚å¸®åŠ©', result: { reputation: -5, health: 10 }, description: 'è·å¾—æ²»ç–—ï¼Œä½†é™ä½å£°æœ›' },
            { text: 'ç»§ç»­ä¹è®¨', result: { health: -15, money: 1 }, description: 'è·å¾—1æšé’±å¸ï¼Œä½†å¥åº·çŠ¶å†µæ¶åŒ–' }
          ]
        }
      ],
      discoveredRecipes: [],

      learnedFromOldBeggarToday: false,

      flags: {
        blackMarketUnlocked: false // é»‘å¸‚æ˜¯å¦å·²è§£é”
      },
      buffs: [], // è§’è‰²çŠ¶æ€æ•ˆæœï¼Œå¦‚"å…¨èº«æ¹¿é€"
      stats: {
        daysSurvived: 0,
        maxReputation: 0,
        resourcesCollected: 0,
        recipesDiscovered: 0
      },
      gameOver: false
    };

    // DOM å…ƒç´ 
    const elements = {
      startScreen: document.getElementById('startScreen'),
      startGameButton: document.getElementById('startGameButton'),
      backgroundMusicToggle: document.getElementById('backgroundMusicToggle'),
      tutorialModal: document.getElementById('tutorialModal'),
      closeTutorialButton: document.getElementById('closeTutorialButton'),
      tutorialStep1: document.getElementById('tutorialStep1'),
      tutorialStep2: document.getElementById('tutorialStep2'),
      tutorialStep3: document.getElementById('tutorialStep3'),
      tutorialStep4: document.getElementById('tutorialStep4'),
      tutorialStep5: document.getElementById('tutorialStep5'),
      tutorialStep6: document.getElementById('tutorialStep6'),
      tutorialStep7: document.getElementById('tutorialStep7'),
      tutorialStep8: document.getElementById('tutorialStep8'),
      prevTutorialButton: document.getElementById('prevTutorialButton'),
      nextTutorialButton: document.getElementById('nextTutorialButton'),
      gameContainer: document.getElementById('gameContainer'),
      dayNumber: document.getElementById('dayNumber'),
      timeOfDay: document.getElementById('timeOfDay'),
      seasonIcon: document.getElementById('seasonIcon'),
      seasonName: document.getElementById('seasonName'),
      weatherIcon: document.getElementById('weatherIcon'),
      weatherName: document.getElementById('weatherName'),

      hungerBar: document.getElementById('hungerBar'),
      coldBar: document.getElementById('coldBar'),
      healthBar: document.getElementById('healthBar'),
      bloodBar: document.getElementById('bloodBar'),
      spiritBar: document.getElementById('spiritBar'),
      reputationBar: document.getElementById('reputationBar'),
      thirstBar: document.getElementById('thirstBar'),
      digestionBar: document.getElementById('digestionBar'),
      actionPointsValue: document.getElementById('actionPointsValue'),
      hungerPercentage: document.getElementById('hungerPercentage'),
      coldPercentage: document.getElementById('coldPercentage'),
      healthPercentage: document.getElementById('healthPercentage'),
      bloodPercentage: document.getElementById('bloodPercentage'),
      spiritPercentage: document.getElementById('spiritPercentage'),
      reputationPercentage: document.getElementById('reputationPercentage'),
      thirstPercentage: document.getElementById('thirstPercentage'),
      digestionPercentage: document.getElementById('digestionPercentage'),
      // çŠ¶æ€æ¡†å…ƒç´ 
      bloodCard: document.getElementById('bloodCard'),
      hungerCard: document.getElementById('hungerCard'),
      thirstCard: document.getElementById('thirstCard'),
      digestionCard: document.getElementById('digestionCard'),
      spiritCard: document.getElementById('spiritCard'),
      healthCard: document.getElementById('healthCard'),
      coldCard: document.getElementById('coldCard'),
      reputationCard: document.getElementById('reputationCard'),
      // æ’æ³„æŒ‰é’®
      excreteButton: document.getElementById('excreteButton'),
      resourceGrid: document.getElementById('resourceGrid'),
      locationGrid: document.getElementById('mapLocationGrid'), // ä½¿ç”¨mapLocationGridæ›¿ä»£locationGrid
      actionGrid: document.getElementById('actionGrid'),
      actionScrollbar: document.getElementById('actionScrollbar'),
      actionScrollbarThumb: document.getElementById('actionScrollbarThumb'),
      groundGrid: document.getElementById('groundGrid'),
      groundScrollbar: document.getElementById('groundScrollbar'),
      groundScrollbarThumb: document.getElementById('groundScrollbarThumb'),
      mapButton: document.getElementById('mapButton'),
      mapModal: document.getElementById('mapModal'),
      closeMapButton: document.getElementById('closeMapButton'),
      mapLocationGrid: document.getElementById('mapLocationGrid'),

      eventModal: document.getElementById('eventModal'),
      closeEventButton: document.getElementById('closeEventButton'),
      eventTitle: document.getElementById('eventTitle'),
      eventText: document.getElementById('eventText'),
      eventOptions: document.getElementById('eventOptions'),
      recipeModal: document.getElementById('recipeModal'),
      closeRecipeButton: document.getElementById('closeRecipeButton'),
      recipeGrid: document.getElementById('recipeGrid'),
      gameOverModal: document.getElementById('gameOverModal'),
      gameOverTitle: document.getElementById('gameOverTitle'),
      gameOverText: document.getElementById('gameOverText'),
      daysSurvived: document.getElementById('daysSurvived'),
      maxReputation: document.getElementById('maxReputation'),
      resourcesCollected: document.getElementById('resourcesCollected'),
      recipesDiscovered: document.getElementById('recipesDiscovered'),

      exitGameButton: document.getElementById('exitGameButton'),
      craftButton: document.getElementById('craftButton'),
      notification: document.getElementById('notification'),
      closeNotificationButton: document.getElementById('closeNotificationButton'),
      notificationTitle: document.getElementById('notificationTitle'),
      notificationMessage: document.getElementById('notificationMessage'),
      notificationOKButton: document.getElementById('notificationOKButton'),
      // æ»‘å—æ¸¸æˆå…ƒç´ 
      sliderGameModal: document.getElementById('sliderGameModal'),
      sliderTrack: document.getElementById('sliderTrack'),
      sliderTriangle: document.getElementById('sliderTriangle'),
      targetArea: document.getElementById('targetArea'),
      timerBar: document.getElementById('timerBar'),
      stopButton: document.getElementById('stopButton')
    };

    // æ·»åŠ å¸®åŠ©æŒ‰é’®å…ƒç´ åˆ°elementså¯¹è±¡
    elements.helpButton = document.getElementById('helpButton');

    // å®šä¹‰èµ„æºå·¥å…·æç¤ºå‡½æ•° - å…¨å±€å‡½æ•°ï¼Œç¡®ä¿åœ¨createResourceCardä¹‹å‰å®šä¹‰
    window.showResourceTooltip = function(resourceCard, resource) {
      const tooltip = document.createElement('div');
      tooltip.id = 'resource-tooltip';
      tooltip.className = 'seed-tooltip';
      let tooltipContent = `
        <div class="tooltip-title">${resource.name}</div>
        <div class="tooltip-info">æ•°é‡: ${resource.amount}</div>
        <div class="tooltip-info">ç±»å‹: ${resource.category || 'å…¶ä»–'}</div>
      `;

      // å¦‚æœæ˜¯æœ¨æ¡¶ï¼Œæ˜¾ç¤ºæ°´é‡ä¿¡æ¯
      if (resource.id === 'bucket' && resource.waterLevel !== undefined) {
        tooltipContent += `<div class="tooltip-info">æ°´é‡: ${resource.waterLevel}/250</div>`;
      }

      tooltip.innerHTML = tooltipContent;

      document.body.appendChild(tooltip);

      // å®šä½å·¥å…·æç¤º
      const rect = resourceCard.getBoundingClientRect();
      tooltip.style.position = 'fixed';
      tooltip.style.left = rect.right + 10 + 'px';
      tooltip.style.top = rect.top + 'px';
      tooltip.style.zIndex = '2000';
    }
    
    // éšè—èµ„æºå·¥å…·æç¤º - å…¨å±€å‡½æ•°
    window.hideResourceTooltip = function() {
      const tooltip = document.getElementById('resource-tooltip');
      if (tooltip) {
        tooltip.remove();
      }
    }
    
    // åˆ›å»ºèµ„æºå¡ç‰Œå‡½æ•° - å…¨å±€å‡½æ•°
    window.createResourceCard = function(resourceKey, resource, enableTooltip = true) {
      const resourceCard = document.createElement('div');
      resourceCard.className = 'crafting-inventory-card';
      resourceCard.dataset.resourceType = resourceKey;
      
      // èµ„æºå›¾ç‰‡
      const resourceImage = document.createElement('div');
      resourceImage.className = 'crafting-card-image';
      resourceImage.style.setProperty('background-image', `url('${resource.image}')`, 'important');
      resourceImage.style.position = 'relative';
      resourceImage.style.overflow = 'visible';
      resourceCard.appendChild(resourceImage);
      
      // èµ„æºåç§°å’Œæ•°é‡
      const resourceName = document.createElement('div');
      resourceName.className = 'crafting-card-title';
      resourceName.textContent = `${resource.name}`;
      resourceCard.appendChild(resourceName);
      
      // ä¸ºè£…å¤‡ç±»èµ„æºæ·»åŠ è€ä¹…åº¦æ˜¾ç¤º
      if (resource.category === 'equipment' && resource.durability) {
        const durabilityBar = document.createElement('div');
        durabilityBar.className = 'durability-bar';
        durabilityBar.style.cssText = `
          width: 100%;
          height: 4px;
          background-color: #e2e8f0;
          border-radius: 2px;
          overflow: hidden;
          margin-top: 4px;
        `;

        const durabilityFill = document.createElement('div');
        durabilityFill.className = 'durability-fill';
        durabilityFill.style.cssText = `
          height: 100%;
          background-color: #38a169;
          border-radius: 2px;
          width: ${resource.durability}%;
          transition: width 0.3s ease;
        `;

        durabilityBar.appendChild(durabilityFill);
        resourceCard.appendChild(durabilityBar);

        // æ·»åŠ è£…å¤‡æ§½ä½ä¿¡æ¯
        if (resource.equipmentSlot) {
          const equipmentSlot = document.createElement('div');
          equipmentSlot.className = 'equipment-slot';
          equipmentSlot.style.cssText = `
            font-size: 0.6rem;
            color: #805ad5;
            text-align: center;
            margin-top: 2px;
          `;
          equipmentSlot.textContent = `è£…å¤‡: ${resource.equipmentSlot}`;
          resourceCard.appendChild(equipmentSlot);
        }
      }

      // ä¸ºæœ¨æ¡¶æ·»åŠ æ°´ä½æŒ‡ç¤ºæ¡
      if (resourceKey === 'bucket') {
        // è®¾ç½®æœ¨æ¡¶åç§°ï¼šç»Ÿä¸€æ˜¾ç¤º"æœ¨æ¡¶"
        resourceName.textContent = `æœ¨æ¡¶`;

        // æ›´æ–°å›¾ç‰‡ï¼ˆæ ¹æ®æ°´é‡æ˜¾ç¤ºä¸åŒçš„å›¾ç‰‡ï¼‰
        // æ›´æ–°æœ¨æ¡¶å›¾ç‰‡ï¼ˆæ ¹æ®æ°´é‡æ˜¾ç¤ºä¸åŒçš„å›¾ç‰‡ï¼‰
        let bucketImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
        if (resource.waterLevel >= 200) {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else if (resource.waterLevel > 0) {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        }
        resourceImage.style.setProperty('background-image', `url('${bucketImage}')`, 'important');

        // åˆ›å»ºæ°´ä½æŒ‡ç¤ºæ¡å®¹å™¨ï¼ˆåœ¨å›¾ç‰‡å†…éƒ¨ï¼‰
        const waterIndicator = document.createElement('div');
        waterIndicator.className = 'water-level-indicator-backpack';
        waterIndicator.style.cssText = `
          position: absolute;
          left: -4px;
          top: 50%;
          transform: translateY(-50%);
          width: 12px;
          height: 70px;
          display: flex;
          flex-direction: column;
          gap: 2px;
          z-index: 10;
        `;

        // åˆ›å»º5ä¸ªæ°´ä½æ ¼
        const waterLevel = resource.waterLevel || 0;
        const filledLevels = Math.floor(waterLevel / 50);

        for (let i = 0; i < 5; i++) {
          const waterCell = document.createElement('div');
          const isFilled = i >= (5 - filledLevels);

          waterCell.style.cssText = `
            flex: 1;
            border: 1px solid #8B4513;
            background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'};
            border-radius: 2px;
            transition: background-color 0.3s ease;
          `;

          waterIndicator.appendChild(waterCell);
        }

        resourceImage.appendChild(waterIndicator);

        // ä¸ºæœ¨æ¡¶æ·»åŠ ç«–ç€æ˜¾ç¤ºçš„è€ä¹…åº¦æ¡ï¼ˆå‚è€ƒèƒŒåŒ…æ æ ·å¼ï¼‰
        if (resourceKey === 'bucket' && resource.durability !== undefined) {
          const durabilityContainer = document.createElement('div');
          durabilityContainer.className = 'card-durability';
          durabilityContainer.style.cssText = `
            position: absolute;
            right: 4px;
            top: 34px;
            width: 4px;
            height: 45px;
            background-color: #E2E8F0;
            border-radius: 2px;
            overflow: hidden;
            z-index: 10;
          `;

          const durabilityBar = document.createElement('div');
          durabilityBar.className = 'durability-bar';
          durabilityBar.style.cssText = `
            width: 100%;
            background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'};
            position: absolute;
            left: 0;
            bottom: 0;
            border-radius: 0 0 2px 2px;
            transition: height 0.3s ease;
            height: ${resource.durability}%;
          `;

          durabilityContainer.appendChild(durabilityBar);
          resourceCard.appendChild(durabilityContainer);
        }
      }

      // ä¸ºæ°´è¢‹æ·»åŠ æ°´ä½æŒ‡ç¤ºæ¡
      if (resourceKey === 'water_bag' || resourceKey === 'empty_water_bag') {
        // è®¾ç½®æ°´è¢‹åç§°ï¼šç»Ÿä¸€æ˜¾ç¤º"æ°´è¢‹"
        // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæˆ–resource.waterLevelè®¡ç®—æ€»æ°´é‡
        let waterLevel = 0;
        if (resource.instances && resource.instances.length > 0) {
          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿè®¡ç®—æ€»æ°´é‡
          waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        } else {
          // ä½¿ç”¨resource.waterLevel
          waterLevel = resource.waterLevel || 0;
        }
        resourceName.textContent = `æ°´è¢‹ Ã— ${resource.amount}`;

        // æ›´æ–°å›¾ç‰‡ï¼ˆæ ¹æ®æ°´é‡æ˜¾ç¤ºä¸åŒçš„å›¾ç‰‡ï¼‰
        let waterBagImage = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
        if (waterLevel > 0) {
          waterBagImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
        }
        resourceImage.style.setProperty('background-image', `url('${waterBagImage}')`, 'important');

        // åˆ›å»ºæ°´ä½æŒ‡ç¤ºæ¡å®¹å™¨ï¼ˆåœ¨å›¾ç‰‡å†…éƒ¨ï¼‰
        const waterIndicator = document.createElement('div');
        waterIndicator.className = 'water-level-indicator-backpack';
        waterIndicator.style.cssText = `
          position: absolute;
          left: -4px;
          top: 50%;
          transform: translateY(-50%);
          width: 12px;
          height: 70px;
          display: flex;
          flex-direction: column;
          gap: 2px;
          z-index: 10;
        `;

        // åˆ›å»º5ä¸ªæ°´ä½æ ¼ï¼Œç”±ä¸‹è‡³ä¸Šå¡«å……ï¼ˆæ°´è¢‹ï¼šæ»¡æ°´é‡100ï¼Œæ¯æ ¼20ï¼‰
        const filledLevels = Math.floor(waterLevel / 20);

        for (let i = 0; i < 5; i++) {
          const waterCell = document.createElement('div');
          // è®¡ç®—å½“å‰æ ¼å­æ˜¯å¦åº”è¯¥å¡«å……ï¼ši >= (5 - filledLevels) è¡¨ç¤ºä»åº•éƒ¨å¼€å§‹å¡«å……
          const isFilled = i >= (5 - filledLevels);

          waterCell.style.cssText = `
            flex: 1;
            border: 1px solid #8B4513;
            background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'};
            border-radius: 2px;
            transition: background-color 0.3s ease;
          `;

          waterIndicator.appendChild(waterCell);
        }

        resourceImage.appendChild(waterIndicator);

        // æ ¹æ®æ°´é‡æ›´æ–°å›¾ç‰‡å’Œæè¿°ï¼ˆåç§°ä¿æŒä¸º"æ°´è¢‹"ï¼‰
        if (waterLevel === 0) {
          resource.description = 'ç©ºæ°´è¢‹ï¼Œå¯ä»¥è£…æ°´';
          resource.image = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
        } else {
          resource.description = 'è£…æ»¡çš„æ°´è¢‹ï¼Œå¯ä»¥é¥®ç”¨æˆ–æµ‡çŒ';
          resource.image = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
        }

        // ä¸ºæ°´è¢‹æ·»åŠ ç«–ç€æ˜¾ç¤ºçš„è€ä¹…åº¦æ¡ï¼ˆå‚è€ƒèƒŒåŒ…æ æ ·å¼ï¼‰
        if (resourceKey === 'water_bag' || resourceKey === 'empty_water_bag') {
          // è®¡ç®—å¹³å‡è€ä¹…åº¦
          let durability = resource.durability;
          if (resource.instances && resource.instances.length > 0) {
            const totalDurability = resource.instances.reduce((sum, inst) => sum + (inst.durability || 100), 0);
            durability = Math.round(totalDurability / resource.instances.length);
          }
          
          if (durability !== undefined) {
            const durabilityContainer = document.createElement('div');
            durabilityContainer.className = 'card-durability';
            durabilityContainer.style.cssText = `
              position: absolute;
              right: 4px;
              top: 34px;
              width: 4px;
              height: 45px;
              background-color: #E2E8F0;
              border-radius: 2px;
              overflow: hidden;
              z-index: 10;
            `;

            const durabilityBar = document.createElement('div');
            durabilityBar.className = 'durability-bar';
            durabilityBar.style.cssText = `
              width: 100%;
              background-color: ${durability > 50 ? '#38A169' : durability > 20 ? '#D69E2E' : '#E53E3E'};
              position: absolute;
              left: 0;
              bottom: 0;
              border-radius: 0 0 2px 2px;
              transition: height 0.3s ease;
              height: ${durability}%;
            `;

            durabilityContainer.appendChild(durabilityBar);
            resourceCard.appendChild(durabilityContainer);
          }
        }
      }

      // æ·»åŠ é¼ æ ‡æ‚¬åœæç¤ºï¼ˆåªåœ¨enableTooltipä¸ºtrueæ—¶ï¼‰
      if (enableTooltip) {
        resourceCard.title = `${resource.name}\næ•°é‡: ${resource.amount}`;

        // æ‚¬åœæ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        resourceCard.addEventListener('mouseenter', function() {
          showResourceTooltip(resourceCard, resource);
        });

        resourceCard.addEventListener('mouseleave', function() {
          hideResourceTooltip();
        });
      } else {
        // æ˜¾å¼ç¦ç”¨ title å±æ€§ï¼Œé˜²æ­¢æµè§ˆå™¨æ˜¾ç¤ºé»˜è®¤æ‚¬åœæç¤º
        resourceCard.removeAttribute('title');
      }
      
      // æ·»åŠ æ‹–æ‹½åŠŸèƒ½ï¼ˆå¯¹æ°´ã€è‚¥æ–™ã€æ°´è¢‹å’Œæœ¨æ¡¶ï¼‰
      if (resourceKey === 'water' || resourceKey === 'fertilizer' || resourceKey === 'bucket' || resourceKey === 'water_bag' || resourceKey === 'empty_water_bag') {
        resourceCard.draggable = true;
        
        resourceCard.addEventListener('dragstart', function(e) {
          if (resource.amount <= 0) {
            e.preventDefault();
            showNotification('èµ„æºä¸è¶³', `ä½ æ²¡æœ‰${resource.name}ï¼`);
            return;
          }
          
          // è®¾ç½®å…¨å±€å˜é‡ï¼Œç¡®ä¿æ‹–æ‹½æ—¶å¯ä»¥æ­£ç¡®è·å–
          window.selectedTool = resourceKey;
          window.selectedSeed = null;
          
          // è®¾ç½®æ‹–æ‹½æ•°æ®
          e.dataTransfer.setData('text/plain', resourceKey);
          e.dataTransfer.effectAllowed = 'move';
          
          // æ·»åŠ æ‹–æ‹½æ ·å¼ - é™ä½é€æ˜åº¦
          resourceCard.classList.add('dragging');
          resourceCard.style.opacity = '0.5';
          
          // è®¾ç½®è‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆ - æ ¹æ®èµ„æºç±»å‹è®¾ç½®ä¸åŒå…‰æ ‡
          const customCursor = document.createElement('div');
          customCursor.id = 'resource-drag-cursor';
          customCursor.className = 'resource-drag-cursor';
          
          // æ ¹æ®èµ„æºç±»å‹è®¾ç½®ä¸åŒçš„é¢œè‰²
          const glowColor = resourceKey === 'water' || resourceKey === 'water_bag' || resourceKey === 'empty_water_bag' ? 'rgba(59, 130, 246, 0.8)' : 
                          resourceKey === 'bucket' ? 'rgba(141, 110, 99, 0.8)' : 'rgba(34, 197, 94, 0.8)';
          
          customCursor.style.cssText = `
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            width: 40px;
            height: 40px;
            background-image: url('${resource.image}');
            background-size: cover;
            border-radius: 50%;
            box-shadow: 0 0 15px ${glowColor}, 0 4px 8px rgba(0,0,0,0.3);
            opacity: 0.9;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
          `;
          
          // æ·»åŠ èµ„æºå›¾æ ‡æ•ˆæœ
          const icon = document.createElement('div');
          icon.style.cssText = `
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238D6E63"><path d="M12.5 5.5C11.67 5.5 11 6.17 11 7V11C11 11.55 10.55 12 10 12S9 11.55 9 11V7C9 6.17 8.33 5.5 7.5 5.5S6 6.17 6 7V12C6 13.1 6.9 14 8 14H9.5C10.33 14 11 13.33 11 12.5V12C11 13.1 10.1 14 9 14H8C6.9 14 6 13.1 6 12V7C6 6.17 5.33 5.5 4.5 5.5S3 6.17 3 7V12C3 14.21 4.79 16 7 16H11.5C13.43 16 15 14.43 15 12.5V7C15 6.17 14.33 5.5 13.5 5.5S12 6.17 12 7V11.5C12 11.78 12.22 12 12.5 12Z"/></svg>');
          `;
          customCursor.appendChild(icon);
          document.body.appendChild(customCursor);
          
          // æ›´æ–°è‡ªå®šä¹‰å…‰æ ‡ä½ç½®
          const updateCursorPosition = (e) => {
            customCursor.style.left = e.clientX + 'px';
            customCursor.style.top = e.clientY + 'px';
            
            // æ·»åŠ è½»å¾®æ‘‡æ‘†æ•ˆæœ
            const swing = Math.sin(Date.now() / 100) * 2;
            customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg)`;
          };
          
          // ç«‹å³æ›´æ–°ä¸€æ¬¡å…‰æ ‡ä½ç½®
          updateCursorPosition(event);
          
          // æ·»åŠ å…¨å±€é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨
          window.resourceDragMouseMoveHandler = updateCursorPosition;
          document.addEventListener('mousemove', updateCursorPosition);
          
          // æ‹–æ‹½ç»“æŸæ—¶æ¸…ç†
          function dragEndHandler() {
            resourceCard.classList.remove('dragging');
            resourceCard.style.opacity = '';

            if (customCursor.parentNode) {
              customCursor.parentNode.removeChild(customCursor);
            }
            document.removeEventListener('mousemove', updateCursorPosition);
            resourceCard.removeEventListener('dragend', dragEndHandler);

            // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
            if (typeof clearDragEffects === 'function') {
              clearDragEffects();
            }

            // ç§»é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
            document.querySelectorAll('.farmland-cell').forEach(cell => {
              cell.classList.remove('highlight', 'pulse-glow');
            });
          }
          
          resourceCard.addEventListener('dragend', dragEndHandler);
        });
        
        // ç‚¹å‡»é€‰æ‹©äº‹ä»¶
        resourceCard.addEventListener('click', function() {
          // ç›´æ¥è®¾ç½®å…¨å±€å˜é‡ï¼Œè€Œä¸é€šè¿‡selectToolå‡½æ•°
          window.selectedTool = resourceKey;
          window.selectedSeed = null;
          resourceCard.classList.add('selected');
        });
      }
      
      // æ·»åŠ æ‹–æ‹½åŠŸèƒ½ï¼ˆå¯¹åŠ¨ç‰©é¥²æ–™ï¼‰
      if (resourceKey === 'animal_feed') {
        resourceCard.draggable = true;
        resourceCard.style.cursor = 'grab'; // ç¡®ä¿é»˜è®¤æ˜¾ç¤ºæŠ“å–å…‰æ ‡
        
        resourceCard.addEventListener('dragstart', function(e) {
          if (resource.amount <= 0) {
            e.preventDefault();
            showNotification('èµ„æºä¸è¶³', `ä½ æ²¡æœ‰${resource.name}ï¼`);
            return;
          }
          
          // è®¾ç½®æ‹–æ‹½æ•°æ®
          e.dataTransfer.setData('feedId', resourceKey);
          
          // å¢å¼ºæ‹–æ‹½çµæ•åº¦å’Œå“åº”é€Ÿåº¦
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.dropEffect = 'move';
          
          // æ·»åŠ æ‹–æ‹½æ ·å¼
          resourceCard.classList.add('dragging');
          resourceCard.style.opacity = '0.8';
          resourceCard.style.cursor = 'grabbing'; // æ‹–æ‹½æ—¶æ˜¾ç¤ºæŠ“å–ä¸­å…‰æ ‡
          
          // åˆ›å»ºè‡ªå®šä¹‰æ‹–æ‹½å›¾åƒï¼Œç¡®ä¿å¡ç‰Œè·Ÿéšé¼ æ ‡
          const dragImage = resourceCard.cloneNode(true);
          dragImage.style.transform = 'scale(0.8)';
          dragImage.style.opacity = '0.8';
          dragImage.style.position = 'absolute';
          dragImage.style.top = '-1000px'; // ç§»å‡ºå±å¹•
          dragImage.style.left = '-1000px';
          dragImage.style.zIndex = '9999';
          dragImage.style.transition = 'none';
          document.body.appendChild(dragImage);
          
          // è®¾ç½®è‡ªå®šä¹‰æ‹–æ‹½å›¾åƒ
          e.dataTransfer.setDragImage(dragImage, 50, 60);
          
          // æ‹–æ‹½ç»“æŸåç§»é™¤ä¸´æ—¶å…ƒç´ 
          setTimeout(() => {
            if (dragImage.parentNode) {
              dragImage.parentNode.removeChild(dragImage);
            }
          }, 0);
        });
        
        resourceCard.addEventListener('dragend', function() {
          resourceCard.classList.remove('dragging');
          resourceCard.style.opacity = '';
          resourceCard.style.cursor = 'grab'; // æ¢å¤åŸå§‹å…‰æ ‡

          // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
          if (typeof clearDragEffects === 'function') {
            clearDragEffects();
          }
        });
      }

      // ä¸ºæ—¶æ•ˆæ€§é£Ÿç‰©æ·»åŠ å€’è®¡æ—¶æ˜¾ç¤º
      if (resource.isPerishable && resource.expirationDays) {
        const expiryInfo = document.createElement('div');
        expiryInfo.className = 'expiry-timer';
        expiryInfo.style.cssText = `
          position: absolute;
          bottom: -8px;
          left: -8px;
          background-color: rgba(229, 62, 62, 0.9);
          color: white;
          border-radius: 50%;
          width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
          z-index: 100;
          border: 2px solid rgba(229, 62, 62, 0.3);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        `;

        // è®¡ç®—å‰©ä½™å¤©æ•°
        const remainingDays = resource.expirationDays - (resource.expirationStartDay ? (gameData.day - resource.expirationStartDay) : 0);
        expiryInfo.textContent = `${remainingDays}å¤©`;

        resourceCard.appendChild(expiryInfo);
      }

      return resourceCard;
    };

    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
      console.log('å¼€å§‹initGame()å‡½æ•°æ‰§è¡Œ');
      try {
        // åˆå§‹åŒ–åŠ¨ç”»ç‰¹æ•ˆCSSæ ·å¼ï¼Œç¡®ä¿æ ·å¼åœ¨æ¸¸æˆå¼€å§‹æ—¶å°±è¢«åŠ è½½
        initializeAnimationCSS();
        console.log('åŠ¨ç”»ç‰¹æ•ˆCSSæ ·å¼åˆå§‹åŒ–å®Œæˆ');
        
        // åˆå§‹åŒ–ç‰¹æ•ˆå‡½æ•°ï¼Œç¡®ä¿å®ƒä»¬åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨
        initializeAnimationEffects();
        console.log('åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°åˆå§‹åŒ–å®Œæˆ');
        
        // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
        setupButtonSoundEffects();
        console.log('æŒ‰é’®éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        
// åˆå§‹åŒ–å…¨å±€æ ‡å¿—å˜é‡
          window.visitLocationInProgress = false;
          
          // é‡ç½®æ¸¸æˆæ•°æ®ï¼Œç¡®ä¿æ¯æ¬¡å¼€å§‹æ–°æ¸¸æˆæ—¶éƒ½æ˜¯å…¨æ–°çš„çŠ¶æ€
          console.log('è°ƒç”¨resetGame()é‡ç½®æ¸¸æˆæ•°æ®');
        resetGame();
        console.log('resetGame()æ‰§è¡Œå®Œæˆ');
        
        console.log('è°ƒç”¨updateGameData()');
        updateGameData();
        console.log('updateGameData()æ‰§è¡Œå®Œæˆ');
        
        // ç¡®ä¿æ¶ˆåŒ–çŠ¶æ€çš„é¢œè‰²æ¡è¢«æ­£ç¡®åˆå§‹åŒ–
        if (elements.digestionBar && gameData.status.digestion !== undefined) {
          elements.digestionBar.style.width = `${gameData.status.digestion}%`;
          elements.digestionBar.style.backgroundColor = '#D69E2E'; // æ¶ˆåŒ–å€¼ï¼Œæ©™è‰²
        }

// ç¡®ä¿gameData.resourceså¯¹è±¡å­˜åœ¨
        if (!gameData.resources) {
          gameData.resources = {};
        }

// åˆå§‹åŒ–æµ‹è¯•å¡ç‰Œèµ„æºï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        const testResources = {
          'bowl': { name: 'ç ´ç¢—', amount: 0, image: 'UI/ç ´ç¢—.jpg', category: 'material' },
          'herb': { name: 'è‰è¯', description: 'å¯ä»¥ç”¨æ¥åˆ¶ä½œè¯å“çš„æ¤ç‰©', amount: 0, image: 'UI/è‰è¯.jpg', category: 'material' },
          'raw_meat': { name: 'ç”Ÿè‚‰', description: 'æœªåŠ å·¥çš„è‚‰ç±»ï¼Œéœ€è¦çƒ¹é¥ªåé£Ÿç”¨', amount: 0, image: 'UI/ç”Ÿè‚‰.jpg', type: 'consumable', category: 'food', isRaw: true, expirationDays: 0.5, isPerishable: true },
          'cooked_meat': { name: 'ç†Ÿè‚‰', description: 'çƒ¹é¥ªåçš„è‚‰ç±»ï¼Œæä¾›ä¸°å¯Œçš„è¥å…»', amount: 0, image: 'UI/ç†Ÿè‚‰.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 1, isPerishable: true },
        'grilled_fish': { name: 'çƒ¤é±¼', description: 'çƒ¤åˆ¶çš„é±¼ï¼Œç¾å‘³å¯å£', amount: 0, image: 'UI/çƒ¤é±¼.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 4, isPerishable: true },
          'porcelain_bowl': { name: 'ç“·ç¢—', description: 'ç²¾è‡´çš„ç“·ç¢—ï¼Œå¤§å¹…æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/ç“·ç¢—.jpg', durability: 100, category: 'material' },
          'clay_bowl_clean': { name: 'æ³¥ç¢—ï¼ˆå‡€æ°´ï¼‰', description: 'ç››æœ‰å¹²å‡€æ°´çš„æ³¥ç¢—ï¼Œå¯ä»¥å®‰å…¨åœ°è¡¥å……æ°´åˆ†', amount: 0, image: 'UI/æ³¥ç¢—ï¼ˆå‡€æ°´ï¼‰.jpg', type: 'consumable', category: 'tool' },
          'pottery_bowl': { name: 'é™¶ç¢—', description: 'åšå›ºçš„é™¶ç¢—ï¼Œæé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é™¶ç¢—.jpg', durability: 100, category: 'material' },
          'silver_bowl': { name: 'é“¶ç¢—', description: 'çè´µçš„é“¶ç¢—ï¼Œæ˜¾è‘—æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é“¶ç¢—.jpg', durability: 100, category: 'material' },
          'gold_bowl': { name: 'é‡‘ç¢—', description: 'å¥¢åçš„é‡‘ç¢—ï¼Œæå¤§æé«˜ä¹è®¨æˆåŠŸç‡å’Œå£°æœ›', amount: 0, image: 'UI/é‡‘ç¢—.jpg', durability: 100, category: 'material' },
          'wood': { name: 'æœ¨æ', amount: 0, image: 'UI/æœ¨æ.jpg', category: 'material' },
          'stone': { name: 'çŸ³å¤´', amount: 0, image: 'UI/çŸ³å¤´.jpg', category: 'material' }
        };

// åˆå§‹åŒ–èƒŒåŒ…æ ï¼šåªä¿ç•™ä¸€åªç¢—
        // æ¸…ç©ºæ‰€æœ‰èµ„æºæ•°é‡
        Object.keys(gameData.resources).forEach(resourceId => {
          if (gameData.resources[resourceId] && typeof gameData.resources[resourceId].amount === 'number') {
            gameData.resources[resourceId].amount = 0;
          }
        });

        // æ¸…ç†ä¸åº”è¯¥å‡ºç°åœ¨resourcesä¸­çš„çŠ¶æ€å±æ€§ï¼ˆé˜²æ­¢ä¹‹å‰çš„bugå¯¼è‡´çš„é”™è¯¯æ•°æ®ï¼‰
        const statusAttributes = ['thirst', 'hunger', 'health', 'spirit', 'cold', 'blood', 'digestion', 'actionPoints'];
        for (const attr of statusAttributes) {
          if (gameData.resources[attr]) {
            delete gameData.resources[attr];
            console.log(`å·²æ¸…ç†é”™è¯¯æ·»åŠ åˆ°resourcesä¸­çš„çŠ¶æ€å±æ€§: ${attr}`);
          }
        }

        // è®¾ç½®ä¸€åªç ´ç¢—
        gameData.resources['bowl'].amount = 1;

        // ç¡®ä¿å‡çº§æˆ¿å±‹æ‰€éœ€çš„èµ„æºå­˜åœ¨
        if (!gameData.resources['wood']) {
          gameData.resources['wood'] = {
            name: 'æœ¨æ',
            amount: 0,
            image: 'UI/æœ¨æ.jpg',
            category: 'material'
          };
        }
        if (!gameData.resources['stone']) {
          gameData.resources['stone'] = {
            name: 'çŸ³å¤´',
            amount: 0,
            image: 'UI/çŸ³å¤´.jpg',
            category: 'material'
          };
        }

        // ä¸è®¾ç½®æˆ¿å±‹åœ°å¥‘ï¼ˆä»…ä¿ç•™ä¸€åªç¢—ï¼‰

        // ç¡®ä¿å…¶ä»–ä¸éœ€è¦çš„åˆå§‹èµ„æºéƒ½è¢«æ¸…ç©º
        const initialResourcesToClear = ['stick', 'flint', 'hide', 'thread', 'æ–§å¤´', 'money', 'cloth', 'paper', 'mud', 'rotten_food'];
        initialResourcesToClear.forEach(resourceId => {
          if (gameData.resources[resourceId]) {
            gameData.resources[resourceId].amount = 0;
          }
        });

        // åˆå§‹åŒ–æ‰«å¸š
        if (!gameData.resources['broom']) {
          gameData.resources['broom'] = {
            name: 'æ‰«å¸š',
            description: 'ç”¨äºæ¸…æ´ç‰²å£æ å’Œé©¬å©æ ï¼Œæ¯ä½¿ç”¨ä¸€æ¬¡æ¶ˆè€—10è€ä¹…åº¦',
            amount: 0,
            image: 'UI/æ‰«å¸š.jpg',
            category: 'material',
            durability: 100
          };
        }
        
        // åˆå§‹åŒ–æˆ¿å±‹ç­‰çº§ä¸º0çº§ï¼Œéœ€è¦æˆ¿å±‹åœ°å¥‘è§£é”
        gameData.houseLevel = 0; // åˆå§‹è®¾ç½®ä¸º0çº§ï¼Œéœ€è¦åœ°å¥‘è§£é”
        
        // åªæœ‰åœ¨æˆ¿å±‹ç­‰çº§å¤§äº0æ—¶æ‰æ·»åŠ "æˆ‘çš„å®…é‚¸"åœ°ç‚¹
        if (gameData.houseLevel > 0) {
          addMyMansionLocation();
          
          // è®¾ç½®å½“å‰ä½ç½®ä¸ºæˆ‘çš„å®…é‚¸
          const mansionLocation = gameData.locations.find(loc => loc.id === 'my_mansion');
          if (mansionLocation) {
            // é‡ç½®æ‰€æœ‰åœ°ç‚¹çš„currentLocationå±æ€§
            gameData.locations.forEach(loc => {
              loc.currentLocation = false;
            });
            // è®¾ç½®æˆ‘çš„å®…é‚¸ä¸ºå½“å‰ä½ç½®
            mansionLocation.currentLocation = true;
          }
          
          // æ›´æ–°æˆ‘çš„å®…é‚¸åœ°ç‚¹çš„å¯ç”¨è¡ŒåŠ¨
          updateMyMansionActions();
        }
        
        // æ·»åŠ é©¬å©åœ°ç‚¹
        addStableLocation();

        // åˆå§‹åŒ–ç¯ç«èµ„æº - ç»Ÿä¸€ä¸ºä¸€ä¸ªç¯ç«èµ„æºï¼Œä½¿ç”¨fuelå±æ€§è¡¨ç¤ºç‡ƒæ–™ï¼ˆ0-100ï¼‰
        if (!gameData.resources.fire) {
          gameData.resources.fire = {
            name: 'ç¯ç«',
            amount: 0,
            image: 'UI/ç¯ç«ï¼ˆç­ï¼‰.jpg',
            durability: 100,
            fuel: 0,
            category: 'tool'
          };
        } else {
          // ç¡®ä¿fuelå’Œdurabilityå±æ€§å­˜åœ¨
          if (gameData.resources.fire.fuel === undefined) {
            gameData.resources.fire.fuel = 100;
          }
          if (gameData.resources.fire.durability === undefined) {
            gameData.resources.fire.durability = 100;
          }
          // ç¡®ä¿åˆ†ç±»ä¸ºtool
          gameData.resources.fire.category = 'tool';
        }

        // åˆå§‹åŒ–é©¬å©æ•°æ®
        if (!gameData.stableData) {
          gameData.stableData = {
            stalls: Array(4).fill(null).map(() => ({
              horse: null,
              health: 100,
              satiety: 100,
              cleanliness: 0,
              startDay: null,
              lastFedDay: null,
              lastCleanedDay: null
            })),
            horses: {
              native_horse: { 
                name: 'æœ¬åœŸé©¬', 
                image: 'UI/æœ¬åœŸé©¬.jpg', 
                maxHealth: 100,
                dailyHealthLoss: 2,
                dailySatietyLoss: 10,
                dailyCleanlinessIncrease: 5,
                produceInterval: 7
              },
              mongolian_horse: { 
                name: 'è’™å¤é©¬', 
                image: 'UI/è’™å¤é©¬.jpg', 
                maxHealth: 120,
                dailyHealthLoss: 2,
                dailySatietyLoss: 8,
                dailyCleanlinessIncrease: 4,
                produceInterval: 6
              },
              hequ_horse: { 
                name: 'æ²³æ›²é©¬', 
                image: 'UI/æ²³æ›²é©¬.jpg', 
                maxHealth: 140,
                dailyHealthLoss: 1,
                dailySatietyLoss: 12,
                dailyCleanlinessIncrease: 6,
                produceInterval: 8
              },
              ferghana_horse: { 
                name: 'æ±—è¡€å®é©¬', 
                image: 'UI/æ±—è¡€å®é©¬.jpg', 
                maxHealth: 150,
                dailyHealthLoss: 1,
                dailySatietyLoss: 9,
                dailyCleanlinessIncrease: 5,
                produceInterval: 5
              },
              super_ferghana_horse: { 
                name: 'æå“æ±—è¡€å®é©¬', 
                image: 'UI/æå“æ±—è¡€å®é©¬.jpg', 
                maxHealth: 180,
                dailyHealthLoss: 0,
                dailySatietyLoss: 7,
                dailyCleanlinessIncrease: 4,
                produceInterval: 4
              }
            }
          };
        }
        
        // åˆå§‹åŒ–æ°´è¢‹èµ„æº - ä½¿ç”¨å®ä¾‹æ•°ç»„æ”¯æŒå¤šä¸ªç‹¬ç«‹æ°´è¢‹
        if (!gameData.resources.water_bag) {
          gameData.resources.water_bag = {
            name: 'æ°´è¢‹',
            description: 'å¯ä»¥å‚¨å­˜æ°´åˆ†ï¼Œè¡¥å……èº«ä½“æ°´åˆ†',
            amount: 0,
            image: 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg',
            type: 'consumable',
            category: 'tool',
            id: 'water_bag',
            cannotDrop: false,
            instances: [], // å­˜å‚¨æ¯ä¸ªæ°´è¢‹å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æœ‰ç‹¬ç«‹çš„æ°´ä½
            waterLevel: 0, // ä¿ç•™å…¼å®¹æ€§ï¼Œå®é™…ä½¿ç”¨instancesæ•°ç»„
            durability: 100,
            useEffect: function() {
              // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹é¥®ç”¨
              const waterBag = gameData.resources.water_bag;
              if (waterBag.instances && waterBag.instances.length > 0) {
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹
                for (const instance of waterBag.instances) {
                  if (instance.waterLevel > 0) {
                    if (instance.waterLevel >= 20) {
                      instance.waterLevel -= 20;
                      gameData.status.thirst = Math.min(100, gameData.status.thirst + 20);
                      
                      // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
                      updateContainerImage('water_bag');
                      
                      return { thirst: 20 };
                    } else {
                      // æ°´é‡ä¸è¶³20æ—¶å…¨éƒ¨é¥®ç”¨
                      const thirst = instance.waterLevel;
                      instance.waterLevel = 0;
                      gameData.status.thirst = Math.min(100, gameData.status.thirst + thirst);
                      
                      // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
                      updateContainerImage('water_bag');
                      
                      return { thirst: thirst };
                    }
                  }
                }
              }
              return { thirst: 0 };
            }
          };
        } else {
          // ç¡®ä¿instancesæ•°ç»„å­˜åœ¨
          if (!gameData.resources.water_bag.instances) {
            gameData.resources.water_bag.instances = [];
          }
          // ç¡®ä¿waterLevelå’Œdurabilityå±æ€§å­˜åœ¨ï¼ˆå…¼å®¹æ€§ï¼‰
          if (gameData.resources.water_bag.waterLevel === undefined) {
            gameData.resources.water_bag.waterLevel = 0;
          }
          if (gameData.resources.water_bag.durability === undefined) {
            gameData.resources.water_bag.durability = 100;
          }
          // ç¡®ä¿åˆ†ç±»ä¸ºtool
          gameData.resources.water_bag.category = 'tool';
        }

// åˆå§‹åŒ–æœ¨æ¡¶èµ„æº - ä½¿ç”¨å®ä¾‹æ•°ç»„æ”¯æŒå¤šä¸ªç‹¬ç«‹æœ¨æ¡¶
        if (!gameData.resources.bucket) {
          gameData.resources.bucket = {
            name: 'æœ¨æ¡¶',
            description: 'ä¸€ä¸ªæœ¨æ¡¶ï¼Œå¯ä»¥ç”¨æ¥è£…æ°´',
            amount: 0,
            image: 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg', // åˆå§‹ä½¿ç”¨ç©ºæœ¨æ¡¶å›¾ç‰‡
            type: 'consumable',
            category: 'tool',
            id: 'bucket',
            cannotDrop: false,
            instances: [], // å­˜å‚¨æ¯ä¸ªæœ¨æ¡¶å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æœ‰ç‹¬ç«‹çš„æ°´ä½
            waterLevel: 0, // ä¿ç•™å…¼å®¹æ€§ï¼Œå®é™…ä½¿ç”¨instancesæ•°ç»„
            durability: 100, // è€ä¹…åº¦
            useEffect: function() {
              // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹é¥®ç”¨
              const bucket = gameData.resources.bucket;
              if (bucket.instances && bucket.instances.length > 0) {
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹
                for (const instance of bucket.instances) {
                  if (instance.waterLevel > 0) {
                    if (instance.waterLevel >= 50) {
                      instance.waterLevel -= 50;
                      gameData.status.thirst = Math.min(100, gameData.status.thirst + 50);
                      return { thirst: 50 };
                    } else {
                      // æ°´é‡ä¸è¶³50æ—¶å…¨éƒ¨é¥®ç”¨
                      const thirst = instance.waterLevel;
                      instance.waterLevel = 0;
                      gameData.status.thirst = Math.min(100, gameData.status.thirst + thirst);
                      return { thirst: thirst };
                    }
                  }
                }
              }
              return { thirst: 0 };
            }
          };
        } else {
          // ç¡®ä¿instancesæ•°ç»„å­˜åœ¨
          if (!gameData.resources.bucket.instances) {
            gameData.resources.bucket.instances = [];
          }
          // ç¡®ä¿waterLevelå’Œdurabilityå±æ€§å­˜åœ¨ï¼ˆå…¼å®¹æ€§ï¼‰
          if (gameData.resources.bucket.waterLevel === undefined) {
            gameData.resources.bucket.waterLevel = 0;
          }
          if (gameData.resources.bucket.durability === undefined) {
            gameData.resources.bucket.durability = 100;
          }
          // æ›´æ–°å›¾ç‰‡ä¸ºç©ºæœ¨æ¡¶å›¾ç‰‡
          gameData.resources.bucket.image = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
          gameData.resources.bucket.amount = 0;
          gameData.resources.bucket.category = 'tool';
        }

        // ä¿æŒempty_bucketçš„å…¼å®¹æ€§ï¼ˆç”¨äºå‘åå…¼å®¹ï¼‰
        gameData.resources.empty_bucket = gameData.resources.bucket;

        // åˆå§‹åŒ–ç§å­èµ„æºç”¨äºå†œç”°ç³»ç»Ÿï¼ˆä¸è®¾ç½®åˆå§‹æ•°é‡ï¼Œéœ€è¦ç©å®¶è‡ªå·±è·å¾—ï¼‰
        const seeds = ['corn_seed', 'wheat_seed', 'rice_seed', 'vegetable_seed', 'fruit_seed'];
        const seedNames = {
          'corn_seed': 'ç‰ç±³ç§å­',
          'wheat_seed': 'å°éº¦ç§å­',
          'rice_seed': 'æ°´ç¨»ç§å­',
          'vegetable_seed': 'è”¬èœç§å­',
          'fruit_seed': 'æ°´æœç§å­'
        };
        
        seeds.forEach(seedId => {
          if (!gameData.resources[seedId]) {
            gameData.resources[seedId] = {
              name: seedNames[seedId],
              description: `ç”¨äºç§æ¤çš„${seedNames[seedId]}`,
              amount: 0, // ä¸ç»™åˆå§‹ç§å­ï¼Œéœ€è¦ç©å®¶è‡ªå·±è·å¾—
              image: `UI/${seedNames[seedId]}.jpg`,
              category: 'seed'
            };
          } else {
            // å¦‚æœèµ„æºå·²å­˜åœ¨ï¼Œç¡®ä¿åˆ†ç±»ä¸ºseed
            gameData.resources[seedId].category = 'seed';
            // ç¡®ä¿æ•°é‡ä¸º0
            gameData.resources[seedId].amount = 0;
          }
        });

        // åˆå§‹åŒ–å…»æ®–ç›¸å…³èµ„æºï¼ˆä¸è®¾ç½®åˆå§‹æ•°é‡ï¼Œéœ€è¦ç©å®¶è‡ªå·±è·å¾—ï¼‰
        // é€šç”¨é¥²æ–™
        if (!gameData.resources.animal_feed) {
          gameData.resources.animal_feed = {
            name: 'é€šç”¨é¥²æ–™',
            description: 'å¯ç”¨äºå–‚å…»æ‰€æœ‰åŠ¨ç‰©ï¼Œç»´æŒå®ƒä»¬çš„å¥åº·å€¼',
            amount: 0, // ä¸ç»™åˆå§‹é¥²æ–™ï¼Œéœ€è¦ç©å®¶è‡ªå·±è·å¾—
            image: 'UI/é€šç”¨é¥²æ–™.jpg',
            category: 'material'
          };
        } else {
          // ç¡®ä¿æ•°é‡ä¸º0
          gameData.resources.animal_feed.amount = 0;
        }

        // å¹¼å¹´æœŸåŠ¨ç‰©ï¼ˆä¸ç»™åˆå§‹åŠ¨ç‰©ï¼Œéœ€è¦ç©å®¶è‡ªå·±è·å¾—ï¼‰
        const babyAnimals = ['chick', 'duckling', 'piglet'];
        const babyAnimalNames = {
          'chick': 'é¸¡å´½',
          'duckling': 'é¸­å´½',
          'piglet': 'çŒªå´½'
        };
        
        babyAnimals.forEach(animalId => {
          if (!gameData.resources[animalId]) {
            gameData.resources[animalId] = {
              name: babyAnimalNames[animalId],
              description: `å¹´å¹¼çš„${babyAnimalNames[animalId]}ï¼Œå¯ä»¥å…»æ®–é•¿å¤§`,
              amount: 0, // ä¸ç»™åˆå§‹åŠ¨ç‰©ï¼Œéœ€è¦ç©å®¶è‡ªå·±è·å¾—
              image: `UI/${babyAnimalNames[animalId]}.jpg`,
              category: 'animal'
            };
          } else {
            // ç¡®ä¿æ•°é‡ä¸º0
            gameData.resources[animalId].amount = 0;
          }
        });

        // æˆå¹´æœŸåŠ¨ç‰©äº§ç‰©
        const animalProducts = ['chicken', 'duck', 'pork'];
        const animalProductNames = {
          'chicken': 'é¸¡',
          'duck': 'é¸­',
          'pork': 'çŒª'
        };
        
        animalProducts.forEach(productId => {
          if (!gameData.resources[productId]) {
            gameData.resources[productId] = {
              name: animalProductNames[productId],
              description: `å¯ä»¥é£Ÿç”¨çš„${animalProductNames[productId]}`,
              amount: 0,
              image: `UI/${animalProductNames[productId]}.jpg`,
              category: 'animal'
            };
          }
        });

        // è›‹ç±»
        if (!gameData.resources.egg) {
          gameData.resources.egg = {
            name: 'è›‹',
            description: 'é¸¡æˆ–é¸­äº§ä¸‹çš„è›‹ï¼Œè¥å…»ä¸°å¯Œ',
            amount: 0,
            image: 'UI/è›‹.jpg',
            category: 'food'
          };
        }

renderResources();

renderLocations();

      // ç¡®ä¿æˆ‘çš„å®…é‚¸åœ°ç‚¹å­˜åœ¨å¹¶è®¾ç½®ä¸ºå½“å‰ä½ç½®
      const mansionLocation2 = gameData.locations.find(loc => loc.id === 'my_mansion');
      if (mansionLocation2 && !mansionLocation2.currentLocation) {
        // é‡ç½®æ‰€æœ‰åœ°ç‚¹çš„currentLocationå±æ€§
        gameData.locations.forEach(loc => {
          loc.currentLocation = false;
        });
        // è®¾ç½®æˆ‘çš„å®…é‚¸ä¸ºå½“å‰ä½ç½®
        mansionLocation2.currentLocation = true;
        
      }

renderActions();

renderGroundResources();

renderEquipmentSlots(); // åˆå§‹åŒ–è£…å¤‡æ 



setupGroundCategoryTabs(); // è®¾ç½®åœ°é¢åˆ†ç±»æ ‡ç­¾äº‹ä»¶
        loadPinnedState(); // åŠ è½½å›ºå®šçŠ¶æ€
        updateSkillDisplay(); // åˆå§‹åŒ–æŠ€èƒ½æ˜¾ç¤º

// ç”Ÿæˆåˆå§‹å¤©æ°”
        generateWeather();

// åˆå§‹åŒ–å¤©æ°”æ•ˆæœ
        updateWeatherEffects();
        
        // åˆå§‹åŒ–è®¾ç½®åŠŸèƒ½
        initSettings();
      } catch (error) {
        console.error('initGame()é”™è¯¯:', error);
        showErrorDisplay(`åˆå§‹åŒ–æ¸¸æˆé”™è¯¯: ${error.message}`);
        // è®°å½•è¯¦ç»†çš„é”™è¯¯å †æ ˆ
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
      }
    }

// è®¾ç½®çª—å£åŠŸèƒ½
    function initSettings() {
      const settingsButton = document.getElementById('settingsButton');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettingsButton = document.getElementById('closeSettingsButton');
      const backgroundMusicToggle = document.getElementById('backgroundMusicToggle');
      const soundEffectsToggle = document.getElementById('soundEffectsToggle');
      const backgroundMusicVolume = document.getElementById('backgroundMusicVolume');
      const soundEffectsVolume = document.getElementById('soundEffectsVolume');
      const backgroundMusicVolumeValue = document.getElementById('backgroundMusicVolumeValue');
      const soundEffectsVolumeValue = document.getElementById('soundEffectsVolumeValue');
      const settingsSaveButton = document.getElementById('settingsSaveButton');
      const settingsLoadButton = document.getElementById('settingsLoadButton');

      // åˆå§‹åŒ–è®¾ç½®å€¼
      if (!gameData.settings) {
        gameData.settings = {
          backgroundMusic: { enabled: true, volume: 0.5 },
          soundEffects: { enabled: true, volume: 0.5 }
        };
      }

      // è®¾ç½®åˆå§‹å€¼
      backgroundMusicToggle.checked = gameData.settings.backgroundMusic.enabled;
      soundEffectsToggle.checked = gameData.settings.soundEffects.enabled;
      backgroundMusicVolume.value = gameData.settings.backgroundMusic.volume * 100;
      soundEffectsVolume.value = gameData.settings.soundEffects.volume * 100;
      backgroundMusicVolumeValue.textContent = `${Math.round(gameData.settings.backgroundMusic.volume * 100)}%`;
      soundEffectsVolumeValue.textContent = `${Math.round(gameData.settings.soundEffects.volume * 100)}%`;

      // æ‰“å¼€è®¾ç½®çª—å£
      settingsButton.addEventListener('click', () => {
        settingsModal.classList.add('active');
        settingsModal.style.display = 'flex';
      });

      // å…³é—­è®¾ç½®çª—å£
      closeSettingsButton.addEventListener('click', closeSettingsModal);
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          closeSettingsModal();
        }
      });

      // èƒŒæ™¯éŸ³ä¹å¼€å…³
      backgroundMusicToggle.addEventListener('change', (e) => {
        gameData.settings.backgroundMusic.enabled = e.target.checked;
        updateBackgroundMusic();
      });

      // éŸ³æ•ˆå¼€å…³
      soundEffectsToggle.addEventListener('change', (e) => {
        gameData.settings.soundEffects.enabled = e.target.checked;
        updateSoundEffects();
      });

      // èƒŒæ™¯éŸ³ä¹éŸ³é‡æ§åˆ¶
      backgroundMusicVolume.addEventListener('input', (e) => {
        const volume = e.target.value / 100;
        gameData.settings.backgroundMusic.volume = volume;
        backgroundMusicVolumeValue.textContent = `${e.target.value}%`;
        updateBackgroundMusic();
      });

      // éŸ³æ•ˆéŸ³é‡æ§åˆ¶
      soundEffectsVolume.addEventListener('input', (e) => {
        const volume = e.target.value / 100;
        gameData.settings.soundEffects.volume = volume;
        soundEffectsVolumeValue.textContent = `${e.target.value}%`;
        updateSoundEffects();
      });

      // ä¿å­˜æ¸¸æˆæŒ‰é’®
      settingsSaveButton.addEventListener('click', () => {
        saveGameProgress();
        closeSettingsModal();
      });

      // åŠ è½½æ¸¸æˆæŒ‰é’®
      settingsLoadButton.addEventListener('click', () => {
        handleLoadGame();
        closeSettingsModal();
      });

      function closeSettingsModal() {
        settingsModal.classList.remove('active');
        setTimeout(() => {
          settingsModal.style.display = 'none';
        }, 300);
      }

      function updateBackgroundMusic() {
        // æ›´æ–°æ¸¸æˆæ•°æ®ä¸­çš„èƒŒæ™¯éŸ³ä¹è®¾ç½®
        gameData.backgroundMusicEnabled = gameData.settings.backgroundMusic.enabled;
        gameData.backgroundMusicVolume = gameData.settings.backgroundMusic.volume;
        
        if (backgroundMusic) {
          if (gameData.settings.backgroundMusic.enabled) {
            backgroundMusic.volume = gameData.settings.backgroundMusic.volume;
            if (backgroundMusic.paused) {
              backgroundMusic.play().catch(error => {
                console.warn('èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:', error);
              });
            }
          } else {
            backgroundMusic.pause();
          }
        } else if (gameData.settings.backgroundMusic.enabled) {
          // å¦‚æœèƒŒæ™¯éŸ³ä¹ä¸å­˜åœ¨ä½†éœ€è¦æ’­æ”¾ï¼Œåˆ™åˆ›å»ºå¹¶æ’­æ”¾
          playBackgroundMusic();
        }
      }

      function updateSoundEffects() {
        // æ›´æ–°æ‰€æœ‰éŸ³æ•ˆçš„éŸ³é‡å’ŒçŠ¶æ€
        Object.values(soundEffects).forEach(sound => {
          if (sound && sound.volume !== undefined) {
            if (gameData.settings.soundEffects.enabled) {
              sound.volume = gameData.settings.soundEffects.volume;
            } else {
              sound.volume = 0;
            }
          }
        });
        
        // åœæ­¢æ‰€æœ‰å¾ªç¯æ’­æ”¾çš„éŸ³æ•ˆï¼ˆå¦‚é›¨å£°ï¼‰
        if (!gameData.settings.soundEffects.enabled) {
          Object.keys(soundEffects).forEach(soundName => {
            if (soundEffects[soundName] && soundEffects[soundName].loop) {
              soundEffects[soundName].pause();
            }
          });
        } else {
          // é‡æ–°å¯ç”¨å¾ªç¯æ’­æ”¾çš„éŸ³æ•ˆ
          Object.keys(soundEffects).forEach(soundName => {
            if (soundEffects[soundName] && soundEffects[soundName].loop && soundEffects[soundName].paused) {
              soundEffects[soundName].play().catch(error => {
                console.warn(`éŸ³æ•ˆ ${soundName} æ’­æ”¾å¤±è´¥:`, error);
              });
            }
          });
        }
      }
    }

// æ¸²æŸ“è£…å¤‡æ 
    function renderEquipmentSlots() {
      const equipmentSlots = document.querySelectorAll('.equipment-slots .combination-slot');

equipmentSlots.forEach(slot => {
        const slotType = slot.getAttribute('data-slot');
        updateEquipmentSlot(slotType);
      });
    }

// æ›´æ–°å•ä¸ªè£…å¤‡æ§½
    function updateEquipmentSlot(slotType, resourceId = null) {
      const slot = document.querySelector(`.equipment-slots .combination-slot[data-slot="${slotType}"]`);

if (!slot) return;

// å¦‚æœæŒ‡å®šäº†èµ„æºIDï¼Œç›´æ¥ä½¿ç”¨è¯¥èµ„æº
      if (resourceId && gameData.resources[resourceId]) {
        const resource = gameData.resources[resourceId];

if (resource.equipmentSlot === slotType && resource.equipped) {
          // åœ¨æ§½ä½ä¸­æ˜¾ç¤ºè£…å¤‡ï¼Œç§»é™¤ç‚¹å‡»äº‹ä»¶å’Œæ‹–æ‹½åŠŸèƒ½
          slot.innerHTML = `
            <div class="equipment-item" data-resource="${resourceId}" data-slot="${slotType}" style="position: relative; width: 100%; height: 80px; cursor: not-allowed; pointer-events: none;">
              <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 0.25rem;">
              <div class="equipment-name" style="text-align: center; font-size: 0.75rem; margin-top: 0.25rem;">${resource.name}</div>
            </div>
          `;
          return;
        }
      }

// å¦‚æœæ²¡æœ‰æŒ‡å®šèµ„æºIDæˆ–èµ„æºä¸åŒ¹é…ï¼ŒæŸ¥æ‰¾è¯¥æ§½ä½çš„è£…å¤‡
      let hasEquipment = false;

// æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰å¯è£…å¤‡çš„ç‰©å“
      for (const [currentResourceId, resource] of Object.entries(gameData.resources)) {
        if (resource.equipmentSlot === slotType) {
          // æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦å·²ç»è£…å¤‡ï¼ˆå³ä½¿æ•°é‡ä¸º0ï¼Œå·²è£…å¤‡çš„ç‰©å“ä¹Ÿåº”æ˜¾ç¤ºï¼‰
          if (resource.equipped) {
            // åœ¨æ§½ä½ä¸­æ˜¾ç¤ºè£…å¤‡ï¼Œç§»é™¤ç‚¹å‡»äº‹ä»¶å’Œæ‹–æ‹½åŠŸèƒ½
            slot.innerHTML = `
              <div class="equipment-item" data-resource="${currentResourceId}" data-slot="${slotType}" style="position: relative; width: 100%; height: 80px; cursor: not-allowed; pointer-events: none;">
                <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 0.25rem;">
                <div class="equipment-name" style="text-align: center; font-size: 0.75rem; margin-top: 0.25rem;">${resource.name}</div>
              </div>
            `;

hasEquipment = true;
            break;
          }
        }
      }

// å¦‚æœæ²¡æœ‰è£…å¤‡ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
      if (!hasEquipment) {
        slot.innerHTML = `
          <div class="equipment-icon" style="text-align: center; font-size: 1.5rem; margin-bottom: 0.25rem;">${slotType === 'clothes' ? 'ğŸ‘•' : slotType === 'shoes' ? 'ğŸ‘¢' : slotType === 'weapon' ? 'ğŸ—¡ï¸' : 'âœ¨'}</div>
        `;
      }

// æ·»åŠ CSSæ ·å¼ç¦ç”¨æ‹–æ‹½åŠŸèƒ½
      slot.style.pointerEvents = 'none';
      slot.style.userSelect = 'none';
      slot.style.touchAction = 'none';
    }

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†å™¨
    // è¿™ä¸ªé”™è¯¯å¤„ç†å™¨å·²è¢«ç¦ç”¨ï¼Œä½¿ç”¨æ›´é«˜çº§çš„é”™è¯¯å¤„ç†å™¨ï¼ˆè§ä¸‹æ–¹ï¼‰


    

    // ç«‹å³åˆå§‹åŒ–åŠ¨ç”»ç‰¹æ•ˆï¼Œç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å¯ä»¥ä½¿ç”¨ï¼ˆåœ¨DOMContentLoadedä¹‹å‰ï¼‰
    try {
      initializeAnimationCSS();
      initializeAnimationEffects();
    } catch (error) {
      console.error('åˆå§‹åŒ–é”™è¯¯:', error);
    }

    document.addEventListener('DOMContentLoaded', () => {
      try {
        // å†æ¬¡åˆå§‹åŒ–åŠ¨ç”»ç‰¹æ•ˆCSSæ ·å¼ï¼Œç¡®ä¿æ ·å¼åœ¨é¡µé¢åŠ è½½æ—¶å°±è¢«åŠ è½½
        initializeAnimationCSS();
        
        // å†æ¬¡åˆå§‹åŒ–ç‰¹æ•ˆå‡½æ•°ï¼Œç¡®ä¿å®ƒä»¬åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨
        initializeAnimationEffects();
        
        setupEventListeners();
        setupResourceCardClickEvents();
        setupHelpButton();

        // åˆå§‹åŒ–å…¨å±€å…‰æ ‡æ¸…é™¤å‡½æ•°
        initializeGlobalCursorCleanup();
      } catch (error) {
        console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        showErrorDisplay(`åˆå§‹åŒ–é”™è¯¯: ${error.message}`);
      }
    });

    // å…¨å±€å…‰æ ‡æ¸…é™¤å‡½æ•° - ç¡®ä¿åœ¨ä»»ä½•æ‹–æ‹½ç»“æŸæ—¶éƒ½æ¸…é™¤è‡ªå®šä¹‰å…‰æ ‡
    function initializeGlobalCursorCleanup() {

      // åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰å…‰æ ‡
      window.clearAllCustomCursors = function() {
        // æ¢å¤é»˜è®¤å…‰æ ‡
        document.body.style.cursor = 'auto';

        // æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰å…‰æ ‡
        const cursorIds = [
          'seed-drag-cursor',
          'resource-drag-cursor',
          'livestock-drag-cursor',
          'stable-drag-cursor'
        ];

        cursorIds.forEach(id => {
          const cursor = document.getElementById(id);
          if (cursor && cursor.parentNode) {
            cursor.parentNode.removeChild(cursor);
          }
        });

        // æ¸…é™¤æ‰€æœ‰æ‹–å½±æ•ˆæœ
        document.querySelectorAll('.drag-trail').forEach(trail => {
          if (trail.parentNode) {
            trail.parentNode.removeChild(trail);
          }
        });

        // æ¸…é™¤æ‰€æœ‰ç²’å­æ•ˆæœ
        document.querySelectorAll('.particle').forEach(particle => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        });

        // æ¸…é™¤å¸é™„æŒ‡ç¤ºå™¨
        const snapIndicator = document.getElementById('snap-indicator');
        if (snapIndicator && snapIndicator.parentNode) {
          snapIndicator.parentNode.removeChild(snapIndicator);
        }

        // ç§»é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
        document.querySelectorAll('.farmland-cell, .livestock-stall, .stable-stall').forEach(cell => {
          cell.classList.remove('highlight', 'pulse-glow');
        });

        // ç§»é™¤æ‰€æœ‰mousemoveç›‘å¬å™¨ï¼Œé˜²æ­¢å…‰æ ‡è¢«é‡æ–°åˆ›å»º
        if (window.seedCursorMouseMoveHandler) {
          document.removeEventListener('mousemove', window.seedCursorMouseMoveHandler);
          window.seedCursorMouseMoveHandler = null;
        }
        if (window.resourceCursorMouseMoveHandler) {
          document.removeEventListener('mousemove', window.resourceCursorMouseMoveHandler);
          window.resourceCursorMouseMoveHandler = null;
        }
        if (window.livestockCursorMouseMoveHandler) {
          document.removeEventListener('mousemove', window.livestockCursorMouseMoveHandler);
          window.livestockCursorMouseMoveHandler = null;
        }
        if (window.stableCursorMouseMoveHandler) {
          document.removeEventListener('mousemove', window.stableCursorMouseMoveHandler);
          window.stableCursorMouseMoveHandler = null;
        }
      };

      // æ·»åŠ å…¨å±€mouseupäº‹ä»¶ç›‘å¬å™¨ - ç¡®ä¿é¼ æ ‡æ¾å¼€æ—¶æ¸…é™¤å…‰æ ‡å’Œæ‹–æ‹½ç‰¹æ•ˆ
      document.addEventListener('mouseup', function() {
        window.clearAllCustomCursors();
        // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
        if (typeof clearDragEffects === 'function') {
          clearDragEffects();
        }
      }, { passive: true });

      // æ·»åŠ å…¨å±€dragendäº‹ä»¶ç›‘å¬å™¨ - ç¡®ä¿æ‹–æ‹½ç»“æŸæ—¶æ¸…é™¤å…‰æ ‡å’Œæ‹–æ‹½ç‰¹æ•ˆ
      document.addEventListener('dragend', function() {
        window.clearAllCustomCursors();
        // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
        if (typeof clearDragEffects === 'function') {
          clearDragEffects();
        }
      }, { passive: true });

      console.log('å…¨å±€å…‰æ ‡æ¸…é™¤å‡½æ•°åˆå§‹åŒ–å®Œæˆ');
    }

    // åˆå§‹åŒ–åŠ¨ç”»ç‰¹æ•ˆCSSæ ·å¼
    function initializeAnimationCSS() {
      // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†CSSæ ·å¼
      if (document.getElementById('animation-effects-css')) {
        return;
      }

      const style = document.createElement('style');
      style.id = 'animation-effects-css';
      style.textContent = `
        /* æˆåŠŸæ”¾ç½®åçš„ç²’å­æ•ˆæœå®¹å™¨ */
        .particle-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          overflow: hidden;
          z-index: 200;
        }

        /* ç²’å­æ•ˆæœ */
        .particle {
          position: absolute;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          animation: particle-fly 1s ease-out forwards;
        }

        @keyframes particle-fly {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--tx), var(--ty)) scale(0);
            opacity: 0;
          }
        }

        /* æ˜Ÿæ˜Ÿç‰¹æ•ˆ */
        .star {
          position: absolute;
          width: 20px;
          height: 20px;
          background: radial-gradient(circle, #FFD700 0%, transparent 70%);
          animation: star-twinkle 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 150;
        }

        @keyframes star-twinkle {
          0% {
            transform: scale(0) rotate(0deg);
            opacity: 0;
          }
          30% {
            transform: scale(1.2) rotate(45deg);
            opacity: 1;
          }
          60% {
            transform: scale(1) rotate(90deg);
            opacity: 0.8;
          }
          100% {
            transform: scale(0.5) rotate(180deg);
            opacity: 0;
          }
        }

        /* æˆåŠŸå›¾æ ‡åŠ¨ç”» */
        .success-icon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 60px;
          animation: success-pop 1s ease-out forwards;
          pointer-events: none;
          z-index: 180;
        }

        @keyframes success-pop {
          0% {
            transform: translate(-50%, -50%) scale(0) rotate(-180deg);
            opacity: 0;
          }
          40% {
            transform: translate(-50%, -50%) scale(1.3) rotate(10deg);
            opacity: 1;
          }
          70% {
            transform: translate(-50%, -50%) scale(0.9) rotate(-5deg);
            opacity: 0.9;
          }
          100% {
            transform: translate(-50%, -50%) scale(1) rotate(0);
            opacity: 0;
          }
        }

        /* é¢å¤–çš„å…‰ç¯æ•ˆæœ */
        .halo-effect {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 100%;
          height: 100%;
          border-radius: 50%;
          border: 3px solid rgba(255, 215, 0, 0.8);
          animation: halo-expand 1s ease-out forwards;
          pointer-events: none;
          z-index: 150;
        }

        @keyframes halo-expand {
          0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
          }
          50% {
            opacity: 0.6;
          }
          100% {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
          }
        }

        /* æ¼‚æµ®æ–‡å­—æ•ˆæœ */
        .floating-text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translateX(-50%) translateY(-50%);
          font-size: 1.2rem;
          font-weight: bold;
          color: #FFD700;
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
          animation: float-up 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 1000;
          white-space: nowrap;
        }

        @keyframes float-up {
          0% {
            top: 50%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(0.5);
          }
          20% {
            opacity: 1;
            transform: translateX(-50%) translateY(-50%) scale(1.2);
          }
          100% {
            top: 10%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(1);
          }
        }

        /* å½©è™¹ç²’å­ */
        .rainbow-particle {
          position: absolute;
          width: 6px;
          height: 6px;
          border-radius: 50%;
          animation: rainbow-particle-fly 1.2s ease-out forwards;
        }

        @keyframes rainbow-particle-fly {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--tx), var(--ty)) scale(0);
            opacity: 0;
          }
        }

        /* å¿ƒå½¢è¡¨æƒ…æ•ˆæœ */
        .heart-particle {
          position: absolute;
          font-size: 20px;
          animation: heart-float 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 190;
        }

        @keyframes heart-float {
          0% {
            transform: translateY(0) scale(0) rotate(-20deg);
            opacity: 0;
          }
          30% {
            transform: translateY(-20px) scale(1.2) rotate(10deg);
            opacity: 1;
          }
          100% {
            transform: translateY(-60px) scale(0.5) rotate(0);
            opacity: 0;
          }
        }

        /* æ”¾ç½®åŠ¨ç‰©/ç§å­æ—¶çš„å¼¹è·³åŠ¨ç”» */
        .livestock-stall.placing, .farmland-cell.placing, .stable-stall.placing {
          animation: place-bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          overflow: visible !important;
          z-index: 1000;
        }

        /* æ”¾ç½®åŠ¨ç”»æ—¶ï¼Œå†œç”°æ ¼å­çš„ä½œç‰©å›¾ç‰‡è¾¹æ¡† */
        .farmland-cell.placing .crop-image {
          border: 3px solid #6D4C41;
          border-radius: 8px;
        }

        @keyframes place-bounce {
          0% {
            transform: scale(0.3) translateY(50px);
            opacity: 0;
          }
          25% {
            transform: scale(1.1) translateY(-10px);
            opacity: 1;
          }
          70% {
            transform: scale(0.95) translateY(5px);
          }
          100% {
            transform: scale(1) translateY(0);
          }
        }

        /* æ”¾ç½®æˆåŠŸæ—¶çš„é—ªå…‰ç‰¹æ•ˆ */
        .livestock-stall.flash, .farmland-cell.flash, .stable-stall.flash {
          position: relative;
        }

        .livestock-stall.flash::after, .farmland-cell.flash::after, .stable-stall.flash::after {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, transparent 70%);
          animation: flash-effect 0.8s ease-out forwards;
          pointer-events: none;
        }

        @keyframes flash-effect {
          0% {
            opacity: 1;
            transform: scale(0);
          }
          50% {
            opacity: 0.8;
          }
          100% {
            opacity: 0;
            transform: scale(1.5);
          }
        }

        /* æ˜Ÿæ˜Ÿå®¹å™¨ */
        .star-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          overflow: hidden;
          z-index: 150;
        }

        /* å½©è™¹ç²’å­å®¹å™¨ */
        .rainbow-particle-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          overflow: hidden;
          z-index: 150;
        }

        /* å¿ƒå½¢ç²’å­å®¹å™¨ */
        .heart-particle-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          overflow: hidden;
          z-index: 190;
        }

        /* æ°´æ»´ç²’å­æ•ˆæœ - æµ‡æ°´ç‰¹æ•ˆ */
        .water-drop {
          position: fixed;
          width: 10px;
          height: 15px;
          background: radial-gradient(ellipse at 50% 30%, rgba(135, 206, 250, 0.9), rgba(70, 130, 180, 0.7));
          border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
          animation: water-drop-fall 1.2s ease-in forwards;
          pointer-events: none;
          z-index: 9999998;
          transform: translate(0, 0);
        }

        @keyframes water-drop-fall {
          0% {
            transform: translate(0, -50px) scale(0);
            opacity: 0;
          }
          20% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          60% {
            transform: translate(0, 30px) scale(1.1);
            opacity: 0.8;
          }
          100% {
            transform: translate(0, 50px) scale(0.3);
            opacity: 0;
          }
        }

        /* æ°´æ³¢çº¹æ•ˆæœ */
        .water-ripple {
          position: fixed;
          border: 2px solid rgba(135, 206, 250, 0.8);
          border-radius: 50%;
          animation: water-ripple-expand 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 9999998;
          transform: translate(-50%, -50%);
        }

        @keyframes water-ripple-expand {
          0% {
            width: 10px;
            height: 10px;
            opacity: 1;
          }
          100% {
            width: 150px;
            height: 150px;
            opacity: 0;
          }
        }

        /* æ°´èŠ±ç²’å­ */
        .water-splash-particle {
          position: fixed;
          width: 8px;
          height: 8px;
          background: radial-gradient(circle, rgba(173, 216, 230, 0.9), transparent);
          border-radius: 50%;
          animation: water-splash 0.8s ease-out forwards;
          pointer-events: none;
          z-index: 9999998;
          transform: translate(0, 0);
        }

        @keyframes water-splash {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--sx), var(--sy)) scale(0);
            opacity: 0;
          }
        }

        /* è‚¥æ–™é¢—ç²’æ•ˆæœ */
        .fertilizer-particle {
          position: absolute;
          width: 12px;
          height: 12px;
          background: radial-gradient(circle, rgba(139, 90, 43, 0.95), rgba(101, 67, 33, 0.85));
          border-radius: 50%;
          animation: fertilizer-fall 1.8s ease-in-out forwards;
          pointer-events: none;
          z-index: 200;
          box-shadow: 0 0 12px rgba(139, 90, 43, 0.8);
        }

        @keyframes fertilizer-fall {
          0% {
            transform: translateY(-50px) rotate(0deg) scale(0);
            opacity: 0;
          }
          30% {
            transform: translateY(0) rotate(180deg) scale(1.1);
            opacity: 1;
          }
          70% {
            transform: translateY(25px) rotate(360deg) scale(0.9);
            opacity: 0.95;
          }
          100% {
            transform: translateY(50px) rotate(540deg) scale(0);
            opacity: 0;
          }
        }

        /* è‚¥æ–™å…‰ç¯æ•ˆæœ */
        .fertilizer-glow {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 100%;
          height: 100%;
          border-radius: 50%;
          background: radial-gradient(circle, rgba(139, 90, 43, 0.8) 0%, transparent 70%);
          box-shadow: 0 0 50px rgba(139, 90, 43, 1), inset 0 0 30px rgba(255, 200, 100, 0.5);
          animation: fertilizer-glow-pulse 2s ease-out forwards;
          pointer-events: none;
          z-index: 170;
        }

        @keyframes fertilizer-glow-pulse {
          0% {
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 1;
          }
          50% {
            transform: translate(-50%, -50%) scale(1.4);
            opacity: 0.8;
          }
          100% {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
          }
        }

        /* è‚¥æ–™çƒŸé›¾æ•ˆæœ */
        .fertilizer-smoke {
          position: absolute;
          width: 20px;
          height: 20px;
          background: radial-gradient(circle, rgba(139, 90, 43, 0.3), transparent);
          border-radius: 50%;
          animation: fertilizer-smoke-rise 2s ease-out forwards;
          pointer-events: none;
          z-index: 175;
        }

        @keyframes fertilizer-smoke-rise {
          0% {
            transform: translateY(0) scale(0.5);
            opacity: 0;
          }
          50% {
            transform: translateY(-20px) scale(1.2);
            opacity: 0.8;
          }
          100% {
            transform: translateY(-50px) scale(1.5);
            opacity: 0;
          }
        }

        /* å†œç”°æ ¼å­æµ‡æ°´åŠ¨ç”» */
        .farmland-cell.water-animation {
          animation: water-effect 0.6s ease-out;
        }

        /* ç‰²å£æ å’Œé©¬å©æ æµ‡æ°´åŠ¨ç”» - å¢å¼ºç‰ˆ */
        .livestock-stall.water-animation,
        .stable-stall.water-animation {
          animation: water-effect 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* ç‰²å£æ å’Œé©¬å©æ å–‚é£ŸåŠ¨ç”» - å¢å¼ºç‰ˆ */
        .livestock-stall.feed-animation,
        .stable-stall.feed-animation {
          animation: feed-effect 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes water-effect {
          0% {
            transform: scale(1) rotate(0deg);
            filter: brightness(1);
          }
          20% {
            transform: scale(1.15) rotate(-5deg);
            filter: brightness(1.3) hue-rotate(20deg) saturate(1.5);
            box-shadow: 0 0 25px rgba(59, 130, 246, 1), 0 0 50px rgba(59, 130, 246, 0.6), 0 0 80px rgba(59, 130, 246, 0.3);
          }
          40% {
            transform: scale(1.2) rotate(3deg);
            filter: brightness(1.5) hue-rotate(25deg) saturate(1.8);
            box-shadow: 0 0 30px rgba(59, 130, 246, 1), 0 0 60px rgba(59, 130, 246, 0.7), 0 0 100px rgba(59, 130, 246, 0.4);
          }
          60% {
            transform: scale(1.15) rotate(-2deg);
            filter: brightness(1.4) hue-rotate(15deg) saturate(1.6);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.9), 0 0 50px rgba(59, 130, 246, 0.5), 0 0 80px rgba(59, 130, 246, 0.3);
          }
          80% {
            transform: scale(1.08) rotate(1deg);
            filter: brightness(1.2) hue-rotate(10deg) saturate(1.3);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.3);
          }
          100% {
            transform: scale(1.05) rotate(0deg);
            filter: brightness(1) saturate(1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
          }
        }

        @keyframes feed-effect {
          0% {
            transform: scale(1) rotate(0deg);
            filter: brightness(1);
          }
          20% {
            transform: scale(1.15) rotate(5deg);
            filter: brightness(1.3) hue-rotate(40deg) saturate(1.5);
            box-shadow: 0 0 25px rgba(237, 137, 54, 1), 0 0 50px rgba(237, 137, 54, 0.6), 0 0 80px rgba(255, 193, 7, 0.3);
          }
          40% {
            transform: scale(1.2) rotate(-3deg);
            filter: brightness(1.5) hue-rotate(45deg) saturate(1.8);
            box-shadow: 0 0 30px rgba(237, 137, 54, 1), 0 0 60px rgba(237, 137, 54, 0.7), 0 0 100px rgba(255, 193, 7, 0.4);
          }
          60% {
            transform: scale(1.15) rotate(2deg);
            filter: brightness(1.4) hue-rotate(35deg) saturate(1.6);
            box-shadow: 0 0 25px rgba(237, 137, 54, 0.9), 0 0 50px rgba(237, 137, 54, 0.5), 0 0 80px rgba(255, 193, 7, 0.3);
          }
          80% {
            transform: scale(1.08) rotate(-1deg);
            filter: brightness(1.2) hue-rotate(25deg) saturate(1.3);
            box-shadow: 0 0 15px rgba(237, 137, 54, 0.6), 0 0 30px rgba(237, 137, 54, 0.3);
          }
          100% {
            transform: scale(1.05) rotate(0deg);
            filter: brightness(1) saturate(1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
          }
        }
      `;
      document.head.appendChild(style);
    }

    // åˆå§‹åŒ–åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°
    function initializeAnimationEffects() {
      // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
      if (!window.createParticleEffect) {
        window.createParticleEffect = function(stallElement) {
          const rect = stallElement.getBoundingClientRect();
          const container = document.createElement('div');
          container.className = 'particle-container';
          stallElement.appendChild(container);

          // ç²’å­é¢œè‰²æ•°ç»„
          const colors = ['#FFD700', '#FFA500', '#FF6347', '#FF69B4', '#87CEEB', '#98FB98'];

          // åˆ›å»ºå¤šä¸ªç²’å­
          for (let i = 0; i < 12; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

            // éšæœºè§’åº¦å’Œè·ç¦»
            const angle = (Math.PI * 2 * i) / 12 + (Math.random() - 0.5) * 0.5;
            const distance = 50 + Math.random() * 50;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;

            particle.style.setProperty('--tx', `${tx}px`);
            particle.style.setProperty('--ty', `${ty}px`);

            // éšæœºåˆå§‹ä½ç½®
            particle.style.left = '50%';
            particle.style.top = '50%';
            particle.style.transform = 'translate(-50%, -50%)';

            container.appendChild(particle);
          }

          // æ¸…ç†ç²’å­
          setTimeout(() => {
            if (container.parentNode) {
              container.parentNode.removeChild(container);
            }
          }, 1000);
        };
      }

      // åˆ›å»ºå½©è™¹ç²’å­æ•ˆæœ
      if (!window.createRainbowParticleEffect) {
        window.createRainbowParticleEffect = function(stallElement) {
          const rect = stallElement.getBoundingClientRect();
          const container = document.createElement('div');
          container.className = 'rainbow-particle-container';
          stallElement.appendChild(container);

          // å½©è™¹è‰²æ•°ç»„
          const rainbowColors = ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3'];

          // åˆ›å»ºå¤šä¸ªå½©è™¹ç²’å­
          for (let i = 0; i < 8; i++) {
            const particle = document.createElement('div');
            particle.className = 'rainbow-particle';
            particle.style.backgroundColor = rainbowColors[i % rainbowColors.length];

            // éšæœºè§’åº¦å’Œè·ç¦»
            const angle = (Math.PI * 2 * i) / 8;
            const distance = 60 + Math.random() * 40;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;

            particle.style.setProperty('--tx', `${tx}px`);
            particle.style.setProperty('--ty', `${ty}px`);

            // åˆå§‹ä½ç½®
            particle.style.left = '50%';
            particle.style.top = '50%';
            particle.style.transform = 'translate(-50%, -50%)';

            container.appendChild(particle);
          }

          // æ¸…ç†ç²’å­
          setTimeout(() => {
            if (container.parentNode) {
              container.parentNode.removeChild(container);
            }
          }, 1200);
        };
      }

      // åˆ›å»ºæ˜Ÿæ˜Ÿç‰¹æ•ˆ
      if (!window.createStarEffect) {
        window.createStarEffect = function(stallElement) {
          const rect = stallElement.getBoundingClientRect();
          const container = document.createElement('div');
          container.className = 'star-container';
          stallElement.appendChild(container);

          // åˆ›å»ºå¤šä¸ªæ˜Ÿæ˜Ÿ
          for (let i = 0; i < 6; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.innerHTML = 'â­';
            
            // éšæœºä½ç½®å’Œå¤§å°
            const size = 15 + Math.random() * 15;
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            
            star.style.left = `${x}%`;
            star.style.top = `${y}%`;
            star.style.fontSize = `${size}px`;
            star.style.opacity = '0';
            
            container.appendChild(star);
          }

          // æ¸…ç†æ˜Ÿæ˜Ÿ
          setTimeout(() => {
            if (container.parentNode) {
              container.parentNode.removeChild(container);
            }
          }, 1000);
        };
      }

      // åˆ›å»ºå…‰ç¯æ•ˆæœ
      if (!window.createHaloEffect) {
        window.createHaloEffect = function(stallElement) {
          const halo = document.createElement('div');
          halo.className = 'halo-effect';
          stallElement.appendChild(halo);

          // æ¸…ç†å…‰ç¯
          setTimeout(() => {
            if (halo.parentNode) {
              halo.parentNode.removeChild(halo);
            }
          }, 800);
        };
      }

      // åˆ›å»ºå¿ƒå½¢ç²’å­æ•ˆæœ
      if (!window.createHeartEffect) {
        window.createHeartEffect = function(stallElement) {
          const rect = stallElement.getBoundingClientRect();
          const container = document.createElement('div');
          container.className = 'heart-particle-container';
          stallElement.appendChild(container);

          // åˆ›å»ºå¤šä¸ªå¿ƒå½¢ç²’å­
          for (let i = 0; i < 5; i++) {
            const heart = document.createElement('div');
            heart.className = 'heart-particle';
            heart.innerHTML = 'â¤ï¸';
            
            // éšæœºä½ç½®å’Œå¤§å°
            const size = 15 + Math.random() * 10;
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            
            heart.style.left = `${x}%`;
            heart.style.top = `${y}%`;
            heart.style.fontSize = `${size}px`;
            heart.style.opacity = '0';
            
            container.appendChild(heart);
          }

          // æ¸…ç†å¿ƒå½¢ç²’å­
          setTimeout(() => {
            if (container.parentNode) {
              container.parentNode.removeChild(container);
            }
          }, 1200);
        };
      }

      // åˆ›å»ºæˆåŠŸå›¾æ ‡
      if (!window.createSuccessIcon) {
        window.createSuccessIcon = function(stallElement, type) {
          const icon = document.createElement('div');
          icon.className = 'success-icon';
          icon.innerHTML = 'âœ¨';
          icon.style.fontSize = '50px';
          stallElement.appendChild(icon);

          setTimeout(() => {
            if (icon.parentNode) {
              icon.parentNode.removeChild(icon);
            }
          }, 1000);
        };
      }

      // åˆ›å»ºæ¼‚æµ®æ–‡å­—
      if (!window.createFloatingText) {
        window.createFloatingText = function(stallElement, type) {
          const text = document.createElement('div');
          text.className = 'floating-text';
          text.textContent = type === 'animal' ? 'æ”¾ç½®æˆåŠŸ!' : type === 'seed' ? 'ç§æ¤æˆåŠŸ!' : 'å…¥é©»æˆåŠŸ!';
          stallElement.appendChild(text);

          setTimeout(() => {
            if (text.parentNode) {
              text.parentNode.removeChild(text);
            }
          }, 1500);
        };
      }
      
      // è§¦å‘æ”¾ç½®åŠ¨ç”»ç‰¹æ•ˆ
      if (!window.triggerPlaceAnimation) {
        window.triggerPlaceAnimation = function(stallElement, type) {
          // æ·»åŠ æ”¾ç½®åŠ¨ç”»ç±»
          stallElement.classList.add('placing');

          // æ·»åŠ é—ªå…‰ç‰¹æ•ˆ
          setTimeout(() => {
            stallElement.classList.add('flash');
          }, 300);

          // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
          window.createParticleEffect(stallElement);

          // åˆ›å»ºå½©è™¹ç²’å­æ•ˆæœ
          window.createRainbowParticleEffect(stallElement);

          // åˆ›å»ºæ˜Ÿæ˜Ÿç‰¹æ•ˆ
          window.createStarEffect(stallElement);

          // åˆ›å»ºå…‰ç¯æ•ˆæœ
          window.createHaloEffect(stallElement);

          // åˆ›å»ºæˆåŠŸå›¾æ ‡
          window.createSuccessIcon(stallElement, type);

          // åˆ›å»ºå¿ƒå½¢ç²’å­æ•ˆæœ
          window.createHeartEffect(stallElement);

          // åˆ›å»ºæ¼‚æµ®æ–‡å­—
          window.createFloatingText(stallElement, type);

          // åŠ¨ç”»ç»“æŸåæ¸…ç†ç±»
          setTimeout(() => {
            stallElement.classList.remove('placing', 'flash');
          }, 1500);
        };
      }

      // åˆ›å»ºæµ‡æ°´ç‰¹æ•ˆ
      if (!window.createWaterEffect) {
        window.createWaterEffect = function(cellElement) {
          console.log('createWaterEffect: å¼€å§‹åˆ›å»ºæµ‡æ°´ç‰¹æ•ˆ');

          // è·å–ç›®æ ‡å…ƒç´ çš„ä½ç½®ä¿¡æ¯
          const rect = cellElement.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;

          // åˆ›å»ºæ°´æ³¢çº¹æ•ˆæœ - æ·»åŠ åˆ°bodyï¼Œä½¿ç”¨fixedå®šä½
          for (let i = 0; i < 3; i++) {
            const ripple = document.createElement('div');
            ripple.className = 'water-ripple';
            ripple.style.position = 'fixed';
            ripple.style.left = `${centerX}px`;
            ripple.style.top = `${centerY}px`;
            ripple.style.transform = 'translate(-50%, -50%)';
            ripple.style.zIndex = '9999998';
            ripple.style.animationDelay = `${i * 0.3}s`;
            document.body.appendChild(ripple);
            setTimeout(() => {
              if (ripple.parentNode) {
                ripple.parentNode.removeChild(ripple);
              }
            }, 2000);
          }
          console.log('createWaterEffect: æ°´æ³¢çº¹æ•ˆæœå·²æ·»åŠ ');

          // åˆ›å»ºæ°´æ»´ç²’å­ - æ·»åŠ åˆ°bodyï¼Œä½¿ç”¨fixedå®šä½
          for (let i = 0; i < 8; i++) {
            const drop = document.createElement('div');
            drop.className = 'water-drop';
            drop.style.position = 'fixed';
            drop.style.left = `${rect.left + rect.width * (0.3 + Math.random() * 0.4)}px`;
            drop.style.top = `${rect.top + rect.height * (0.1 + Math.random() * 0.2)}px`;
            drop.style.transform = 'translate(0, 0)';
            drop.style.zIndex = '9999998';
            drop.style.animationDelay = `${i * 0.1}s`;
            drop.style.width = `${8 + Math.random() * 6}px`;
            drop.style.height = `${12 + Math.random() * 8}px`;
            document.body.appendChild(drop);
            setTimeout(() => {
              if (drop.parentNode) {
                drop.parentNode.removeChild(drop);
              }
            }, 2000);
          }
          console.log('createWaterEffect: æ°´æ»´ç²’å­å·²æ·»åŠ ');

          // åˆ›å»ºæ°´èŠ±æº…å°„æ•ˆæœ - æ·»åŠ åˆ°bodyï¼Œä½¿ç”¨fixedå®šä½
          for (let i = 0; i < 12; i++) {
            const splash = document.createElement('div');
            splash.className = 'water-splash-particle';
            splash.style.position = 'fixed';
            splash.style.left = `${centerX}px`;
            splash.style.top = `${rect.top + rect.height * 0.6}px`;
            splash.style.zIndex = '9999998';

            const angle = (Math.PI * 2 * i) / 12 + Math.random() * 0.3;
            const distance = 30 + Math.random() * 40;
            const sx = Math.cos(angle) * distance;
            const sy = Math.sin(angle) * distance - 20;

            splash.style.setProperty('--sx', `${sx}px`);
            splash.style.setProperty('--sy', `${sy}px`);
            splash.style.animationDelay = `${Math.random() * 0.3}s`;

            document.body.appendChild(splash);
            setTimeout(() => {
              if (splash.parentNode) {
                splash.parentNode.removeChild(splash);
              }
            }, 1500);
          }
          console.log('createWaterEffect: æ°´èŠ±æº…å°„æ•ˆæœå·²æ·»åŠ ');
        };
      }

      // åˆ›å»ºæ–½è‚¥ç‰¹æ•ˆ
      if (!window.createFertilizerEffect) {
        window.createFertilizerEffect = function(cellElement) {
          // åˆ›å»ºè‚¥æ–™é¢—ç²’è½ä¸‹æ•ˆæœ
          for (let i = 0; i < 18; i++) {
            const particle = document.createElement('div');
            particle.className = 'fertilizer-particle';
            particle.style.left = `${20 + Math.random() * 60}%`;
            particle.style.top = `${5 + Math.random() * 15}%`;
            particle.style.animationDelay = `${i * 0.08}s`;
            particle.style.width = `${10 + Math.random() * 8}px`;
            particle.style.height = `${10 + Math.random() * 8}px`;

            // éšæœºæ·±æµ…çš„æ£•è‰²
            const browns = ['rgba(139, 90, 43, 0.95)', 'rgba(101, 67, 33, 0.95)', 'rgba(160, 82, 45, 0.95)', 'rgba(210, 180, 140, 0.9)'];
            const randomColor = browns[Math.floor(Math.random() * browns.length)];
            particle.style.background = `radial-gradient(circle, ${randomColor}, transparent)`;

            cellElement.appendChild(particle);
            setTimeout(() => {
              if (particle.parentNode) {
                particle.parentNode.removeChild(particle);
              }
            }, 3200);
          }

          // åˆ›å»ºè‚¥æ–™å…‰ç¯æ•ˆæœ
          const glow = document.createElement('div');
          glow.className = 'fertilizer-glow';
          cellElement.appendChild(glow);
          setTimeout(() => {
            if (glow.parentNode) {
              glow.parentNode.removeChild(glow);
            }
          }, 2000);

          // åˆ›å»ºè‚¥æ–™çƒŸé›¾ä¸Šå‡æ•ˆæœ
          for (let i = 0; i < 6; i++) {
            const smoke = document.createElement('div');
            smoke.className = 'fertilizer-smoke';
            smoke.style.left = `${25 + Math.random() * 50}%`;
            smoke.style.top = `${60 + Math.random() * 20}%`;
            smoke.style.animationDelay = `${0.5 + i * 0.2}s`;
            smoke.style.width = `${15 + Math.random() * 10}px`;
            smoke.style.height = `${15 + Math.random() * 10}px`;
            cellElement.appendChild(smoke);
            setTimeout(() => {
              if (smoke.parentNode) {
                smoke.parentNode.removeChild(smoke);
              }
            }, 3000);
          }

          // åˆ›å»ºæ¼‚æµ®æ–‡å­—æ•ˆæœ
          const text = document.createElement('div');
          text.className = 'floating-text';
          text.textContent = 'æ–½è‚¥æˆåŠŸï¼';
          text.style.color = '#FFD700';
          text.style.fontSize = '1.2rem';
          text.style.fontWeight = 'bold';
          text.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
          cellElement.appendChild(text);
          setTimeout(() => {
            if (text.parentNode) {
              text.parentNode.removeChild(text);
            }
          }, 1500);
        };
      }

      // åˆ›å»ºæµ‡æ°´æ¼‚æµ®æ–‡å­—
      if (!window.createWaterFloatingText) {
        window.createWaterFloatingText = function(cellElement) {
          console.log('createWaterFloatingText: å¼€å§‹åˆ›å»ºæ¼‚æµ®æ–‡å­—');

          const text = document.createElement('div');
          text.className = 'floating-text';
          text.textContent = 'æµ‡æ°´æˆåŠŸï¼';
          text.id = 'water-floating-text-' + Date.now();

          cellElement.appendChild(text);

          console.log('createWaterFloatingText: æ¼‚æµ®æ–‡å­—å·²æ·»åŠ åˆ°DOMï¼Œå…ƒç´ ID:', text.id);

          // 1.5ç§’åç§»é™¤DOMå…ƒç´ 
          setTimeout(() => {
            if (text.parentNode) {
              text.parentNode.removeChild(text);
              console.log('createWaterFloatingText: è¶…æ—¶ï¼Œç§»é™¤å…ƒç´ ');
            }
          }, 1500);
        };
      }
    }

// æ‰“å¼€è£…å¤‡çª—å£
    function openEquipmentWindow() {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è£…å¤‡çª—å£
      let equipmentWindow = document.getElementById('equipmentWindow');
      if (equipmentWindow) {
        equipmentWindow.remove();
      }

// åˆ›å»ºè£…å¤‡çª—å£
      equipmentWindow = document.createElement('div');
      equipmentWindow.id = 'equipmentWindow';
      equipmentWindow.className = 'modal';
      equipmentWindow.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;

// åˆ›å»ºçª—å£å†…å®¹
      const windowContent = document.createElement('div');
      windowContent.className = 'modal-content ink-border';
      windowContent.style.cssText = `
        background-color: #FFFDF7;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      `;

// çª—å£æ ‡é¢˜
      const title = document.createElement('h2');
      title.textContent = 'è£…å¤‡';
      title.className = 'ink-text';
      title.style.cssText = `
        font-size: 1.5rem;
        font-weight: normal;
        color: #5D4037;
        margin-bottom: 1.5rem;
        text-align: center;
      `;
      windowContent.appendChild(title);

// è£…å¤‡æ§½å®¹å™¨
      const equipmentSlotsDiv = document.createElement('div');
      equipmentSlotsDiv.className = 'equipment-slots';
      equipmentSlotsDiv.style.cssText = `
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        border: 2px dashed #8D6E63;
        border-radius: 0.5rem;
        justify-content: center;
        background: linear-gradient(135deg, rgba(255, 253, 247, 0.9) 0%, rgba(255, 253, 247, 0.7) 100%);
      `;
      equipmentSlotsDiv.id = 'equipmentSlots';

// åˆ›å»ºå››ä¸ªè£…å¤‡æ§½
      const slotTypes = [
        { type: 'clothes', icon: 'ğŸ‘•', name: 'è¡£ç‰©' },
        { type: 'shoes', icon: 'ğŸ‘¢', name: 'é´å­' },
        { type: 'weapon', icon: 'ğŸ—¡ï¸', name: 'æ­¦å™¨' },
        { type: 'special', icon: 'âœ¨', name: 'ç‰¹æ®Š' }
      ];

slotTypes.forEach(slotInfo => {
        const slot = document.createElement('div');
        slot.className = 'combination-slot';
        slot.setAttribute('data-slot', slotInfo.type);
        slot.style.cssText = `
          width: 100px;
          height: 140px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          border: 2px dashed #8D6E63;
          border-radius: 12px;
          background: linear-gradient(135deg, rgba(255, 253, 247, 0.95) 0%, rgba(255, 253, 247, 0.8) 100%);
          padding: 0.5rem;
          box-shadow: 0 0 10px rgba(141, 110, 99, 0.2);
        `;

const icon = document.createElement('div');
        icon.className = 'equipment-icon';
        icon.style.cssText = `
          text-align: center;
          font-size: 2rem;
          margin-bottom: 0.5rem;
        `;
        icon.textContent = slotInfo.icon;

const slotName = document.createElement('div');
        slotName.className = 'slot-name';
        slotName.style.cssText = `
          font-size: 0.875rem;
          color: #4A5568;
          text-align: center;
          margin-bottom: 0.5rem;
        `;
        slotName.textContent = slotInfo.name;

slot.appendChild(icon);
        slot.appendChild(slotName);
        equipmentSlotsDiv.appendChild(slot);
      });

windowContent.appendChild(equipmentSlotsDiv);

// å…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.textContent = 'å…³é—­';
      closeButton.className = 'ink-button ink-button-small';
      closeButton.style.cssText = `
        margin-top: 1rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
      `;

closeButton.addEventListener('click', function() {
        equipmentWindow.remove();
      });

windowContent.appendChild(closeButton);
      equipmentWindow.appendChild(windowContent);

// ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      equipmentWindow.addEventListener('click', function(e) {
        if (e.target === equipmentWindow) {
          equipmentWindow.remove();
        }
      });

// æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(equipmentWindow);

// é‡æ–°æ¸²æŸ“è£…å¤‡æ§½å†…å®¹
      renderEquipmentSlots();
    }

// æ‰“å¼€æŠ€èƒ½çª—å£
    function openSkillsWindow() {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æŠ€èƒ½çª—å£
      let skillsWindow = document.getElementById('skillsWindow');
      if (skillsWindow) {
        skillsWindow.remove();
      }

// åˆ›å»ºæŠ€èƒ½çª—å£
      skillsWindow = document.createElement('div');
      skillsWindow.id = 'skillsWindow';
      skillsWindow.className = 'modal';
      skillsWindow.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;

// åˆ›å»ºçª—å£å†…å®¹
      const windowContent = document.createElement('div');
      windowContent.className = 'modal-content ink-border';
      windowContent.style.cssText = `
        background-color: #FFFDF7;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      `;

// çª—å£æ ‡é¢˜
      const title = document.createElement('h2');
      title.textContent = 'æŠ€èƒ½ä¸Buff';
      title.className = 'ink-text';
      title.style.cssText = `
        font-size: 1.5rem;
        font-weight: normal;
        color: #5D4037;
        margin-bottom: 1.5rem;
        text-align: center;
      `;
      windowContent.appendChild(title);

// æŠ€èƒ½éƒ¨åˆ†
      const skillsSection = document.createElement('div');
      skillsSection.className = 'skills-section';
      skillsSection.style.cssText = `
        margin-bottom: 2rem;
      `;

const skillsTitle = document.createElement('h3');
      skillsTitle.textContent = 'æŠ€èƒ½';
      skillsTitle.style.cssText = `
        font-size: 1.125rem;
        font-weight: normal;
        color: #4A5568;
        margin-bottom: 1rem;
      `;
      skillsSection.appendChild(skillsTitle);

// åˆ›å»ºæŠ€èƒ½åˆ—è¡¨
      const skillsList = document.createElement('div');
      skillsList.className = 'skills-list';
      skillsList.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      `;
      skillsSection.appendChild(skillsList);

// Bufféƒ¨åˆ†
      const buffsSection = document.createElement('div');
      buffsSection.className = 'buffs-section';

const buffsTitle = document.createElement('h3');
      buffsTitle.textContent = 'çŠ¶æ€æ•ˆæœ (Buff)';
      buffsTitle.style.cssText = `
        font-size: 1.125rem;
        font-weight: normal;
        color: #4A5568;
        margin-bottom: 1rem;
      `;
      buffsSection.appendChild(buffsTitle);

// åˆ›å»ºBuffåˆ—è¡¨
      const buffsList = document.createElement('div');
      buffsList.className = 'buffs-list';
      buffsList.style.cssText = `
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      `;
      buffsSection.appendChild(buffsList);

windowContent.appendChild(skillsSection);
      windowContent.appendChild(buffsSection);

// å…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.textContent = 'å…³é—­';
      closeButton.className = 'ink-button ink-button-primary';
      closeButton.style.cssText = `
        margin-top: 1rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
      `;

closeButton.addEventListener('click', function() {
        skillsWindow.remove();
      });

windowContent.appendChild(closeButton);
      skillsWindow.appendChild(windowContent);

// ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      skillsWindow.addEventListener('click', function(e) {
        if (e.target === skillsWindow) {
          skillsWindow.remove();
        }
      });

// æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(skillsWindow);

// æ¸²æŸ“æŠ€èƒ½å’ŒBuff
      renderSkillsInWindow(skillsList);
      renderBuffsInWindow(buffsList);
    }

// æ¸²æŸ“çª—å£ä¸­çš„æŠ€èƒ½
    function renderSkillsInWindow(container) {
      // éå†æ‰€æœ‰æŠ€èƒ½
      for (const [skillId, skill] of Object.entries(gameData.skills)) {
        const skillItem = document.createElement('div');
        skillItem.className = 'skill-item';
        skillItem.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem;
          background-color: #EDF2F7;
          border-radius: 0.5rem;
        `;

// æŠ€èƒ½åç§°å’Œç­‰çº§
        const skillInfo = document.createElement('div');
        skillInfo.style.cssText = `
          font-size: 0.875rem;
          color: #4A5568;
          flex: 1;
        `;
        skillInfo.textContent = `${skill.name} (ç­‰çº§ ${skill.level}/${skill.maxLevel})`;

// ç»éªŒæ¡
        const expContainer = document.createElement('div');
        expContainer.style.cssText = `
          width: 150px;
          height: 0.5rem;
          background-color: #E2E8F0;
          border-radius: 0.25rem;
          overflow: hidden;
          margin-left: 1rem;
        `;

const expBar = document.createElement('div');
        expBar.className = 'exp-bar';

// è®¡ç®—ç»éªŒç™¾åˆ†æ¯”
        let expPercentage = 0;

if (skill.level < skill.maxLevel) {
          // è·å–å‡åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„æ€»ç»éªŒå€¼
          const expNeededForNextLevel = gameData.skillExpRequired[skill.level + 1];

// ç»éªŒæ¡ç™¾åˆ†æ¯”=å½“å‰ç»éªŒå€¼/å‡çº§æ‰€éœ€ç»éªŒå€¼Ã—100%
          if (expNeededForNextLevel > 0) {
            expPercentage = (skill.experience / expNeededForNextLevel) * 100;
          } else {
            expPercentage = 0;
          }

// ç¡®ä¿ç™¾åˆ†æ¯”ä¸è¶…è¿‡100%
          expPercentage = Math.min(expPercentage, 100);
        } else if (skill.level >= skill.maxLevel) {
          // å·²ç»æ˜¯æœ€é«˜ç­‰çº§ï¼Œç»éªŒæ¡æ»¡
          expPercentage = 100;
        }

expBar.style.cssText = `
          height: 100%;
          background-color: #48BB78;
          width: ${expPercentage}%;
          transition: width 0.3s ease;
        `;

expContainer.appendChild(expBar);

// ç»éªŒå€¼æ–‡æœ¬
        const expText = document.createElement('span');
        expText.style.cssText = `
          margin-left: 0.5rem;
          font-size: 0.8rem;
          color: #4A5568;
        `;

// è®¾ç½®ç»éªŒå€¼æ–‡æœ¬
        if (skill.level < skill.maxLevel) {
          // è·å–å‡åˆ°ä¸‹ä¸€çº§éœ€è¦çš„æ€»ç»éªŒå€¼
          // å¯¹äºç­‰çº§ 0ï¼Œéœ€è¦ä½¿ç”¨ level + 1 çš„å€¼æ¥è·å–æ­£ç¡®çš„å‡çº§ç»éªŒ
          const expNeededForNextLevel = gameData.skillExpRequired[skill.level + 1];
          expText.textContent = `${skill.experience}/${expNeededForNextLevel}`;
        } else if (skill.level >= skill.maxLevel) {
          expText.textContent = 'MAX';
        } else {
          expText.textContent = '0/0';
        }

skillItem.appendChild(skillInfo);
        skillItem.appendChild(expContainer);
        skillItem.appendChild(expText);
        container.appendChild(skillItem);
      }
    }

// æ¸²æŸ“çª—å£ä¸­çš„Buff
    function renderBuffsInWindow(container) {
      // æ¸…ç©ºå®¹å™¨
      container.innerHTML = '';

      // å®šä¹‰Buffé…ç½®
      const buffConfigs = {
        'å…¨èº«æ¹¿é€': {
          icon: 'ğŸ’§',
          name: 'å…¨èº«æ¹¿é€',
          description: 'é›¨å¤©æˆ–é›ªå¤©å¯¼è‡´ï¼Œæ¯ä¸ªæ—¶é—´æ®µä½“æ¸©ä¸‹é™0.1â„ƒ',
          bgColor: '#EBF8FF',
          borderColor: '#90CDF4',
          textColor: '#2B6CB0'
        },
        'å°å¿ƒä¸€ç‚¹': {
          icon: 'âš ï¸',
          name: 'å°å¿ƒä¸€ç‚¹',
          description: 'åˆ‘æ»¡é‡Šæ”¾åçŠ¶æ€ï¼Œå·çªƒæˆåŠŸç‡-20%',
          bgColor: '#FEF5E7',
          borderColor: '#F5B7B1',
          textColor: '#D35400'
        },
        'å¹¸è¿å„¿': {
          icon: 'ğŸ€',
          name: 'å¹¸è¿å„¿',
          description: '3å¤©å†…é”£é¼“å··å·çªƒæˆåŠŸå¿…å®šè·å¾—é‡‘å­ã€é“¶å­æˆ–é‡‘æ¡',
          bgColor: '#F0FFF4',
          borderColor: '#68D391',
          textColor: '#22543D'
        },
        'è¢«ç½©äº†': {
          icon: 'â˜”',
          name: 'è¢«ç½©äº†',
          description: '3å¤©å†…æ— è®ºé›¨é›ªå¤©æ°”éƒ½ä¸ä¼šå…¨èº«æ¹¿é€',
          bgColor: '#EBF8FF',
          borderColor: '#90CDF4',
          textColor: '#2C5282'
        }
      };

      // æ¸²æŸ“æ‰€æœ‰Buff
      if (gameData.buffs) {
        // éå†buffså¯¹è±¡
        Object.keys(gameData.buffs).forEach(buffKey => {
          const config = buffConfigs[buffKey];
          if (config) {
            const buffItem = document.createElement('div');
            buffItem.className = 'buff-item';
            buffItem.style.cssText = `
              position: relative;
              width: 80px;
              height: 80px;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              background-color: ${config.bgColor};
              border: 2px solid ${config.borderColor};
              border-radius: 0.5rem;
              cursor: pointer;
              transition: transform 0.2s ease;
              margin-right: 0.5rem;
              margin-bottom: 0.5rem;
              float: left;
            `;

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            buffItem.addEventListener('mouseover', function() {
              this.style.transform = 'scale(1.05)';
            });

            buffItem.addEventListener('mouseout', function() {
              this.style.transform = 'scale(1)';
            });

            // Buffå›¾æ ‡
            const buffIcon = document.createElement('div');
            buffIcon.style.cssText = `
              font-size: 2rem;
              margin-bottom: 0.25rem;
            `;
            buffIcon.textContent = config.icon;

            // Buffåç§°
            const buffName = document.createElement('div');
            buffName.style.cssText = `
              font-size: 0.75rem;
              color: ${config.textColor};
              text-align: center;
            `;
            buffName.textContent = config.name;

            // åˆ›å»ºå·¥å…·æç¤º
            const tooltip = document.createElement('div');
            tooltip.className = 'buff-tooltip';
            tooltip.style.cssText = `
              position: absolute;
              bottom: 100%;
              left: 50%;
              transform: translateX(-50%);
              background-color: #2D3748;
              color: white;
              padding: 0.5rem;
              border-radius: 0.25rem;
              font-size: 0.75rem;
              white-space: nowrap;
              opacity: 0;
              pointer-events: none;
              transition: opacity 0.2s ease;
              margin-bottom: 0.5rem;
              z-index: 1001;
            `;

            // å¤„ç†ç‰¹æ®ŠBuffçš„åŠ¨æ€ä¿¡æ¯
            let tooltipText = config.description;
            if (buffKey === 'å°å¿ƒä¸€ç‚¹' && gameData.buffs['å°å¿ƒä¸€ç‚¹'] && gameData.buffs['å°å¿ƒä¸€ç‚¹'].endDay) {
              const remainingDays = Math.max(0, gameData.buffs['å°å¿ƒä¸€ç‚¹'].endDay - gameData.day);
              tooltipText += `ï¼Œå‰©ä½™${remainingDays}å¤©`;
            } else if ((buffKey === 'å¹¸è¿å„¿' || buffKey === 'è¢«ç½©äº†') && gameData.buffs[buffKey] && gameData.buffs[buffKey].days !== undefined) {
              tooltipText += `ï¼Œå‰©ä½™${gameData.buffs[buffKey].days}å¤©`;
            }

            tooltip.textContent = tooltipText;

            // æ·»åŠ å·¥å…·æç¤ºæ˜¾ç¤º/éšè—äº‹ä»¶
            buffItem.addEventListener('mouseover', function() {
              tooltip.style.opacity = '1';
            });

            buffItem.addEventListener('mouseout', function() {
              tooltip.style.opacity = '0';
            });

            buffItem.appendChild(tooltip);
            buffItem.appendChild(buffIcon);
            buffItem.appendChild(buffName);
            container.appendChild(buffItem);
            }
          });
      }

      // å¦‚æœæ²¡æœ‰Buffï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
      if (container.children.length === 0) {
        const noBuffText = document.createElement('div');
        noBuffText.textContent = 'å½“å‰æ²¡æœ‰çŠ¶æ€æ•ˆæœ';
        noBuffText.style.cssText = `
          color: #718096;
          font-size: 0.875rem;
          text-align: center;
          padding: 1rem;
          clear: both;
        `;
        container.appendChild(noBuffText);
      } else {
        // æ¸…é™¤æµ®åŠ¨
        const clearDiv = document.createElement('div');
        clearDiv.style.clear = 'both';
        container.appendChild(clearDiv);
      }
    }

// è®¾ç½®å¸®åŠ©æŒ‰é’®
    function setupHelpButton() {
      // éšè—æ‰€æœ‰æ•™ç¨‹æ­¥éª¤çš„æ˜¾ç¤ºæ§åˆ¶
      for (let i = 1; i <= 8; i++) {
        const step = document.getElementById(`tutorialStep${i}`);
        if (step) {
          step.style.display = 'block';
        }
      }

      // å®šä¹‰å…³é—­æ•™ç¨‹æ¨¡æ€æ¡†çš„å‡½æ•°
      const closeTutorialModal = () => {
        if (elements.tutorialModal) {
          elements.tutorialModal.classList.remove('active');
        }
      };

// æ·»åŠ å¸®åŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if (elements.helpButton) {
        elements.helpButton.addEventListener('click', () => {
          if (elements.tutorialModal) {
            elements.tutorialModal.classList.add('active');
          }
        });
      }

      // æ·»åŠ æ•™ç¨‹æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ - ä½¿ç”¨æœ€æ–°çš„é€‰æ‹©å™¨
      const closeButtons = [
        document.getElementById('closeTutorialButton'),
        document.getElementById('closeTutorialBtn')
      ];

      closeButtons.forEach(button => {
        if (button) {
          // ç§»é™¤å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
          button.replaceWith(button.cloneNode(true));
          const newButton = document.getElementById(button.id);
          newButton.addEventListener('click', closeTutorialModal);
        }
      });

      // æ·»åŠ ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­åŠŸèƒ½
      if (elements.tutorialModal) {
        elements.tutorialModal.addEventListener('click', (e) => {
          if (e.target === elements.tutorialModal) {
            closeTutorialModal();
          }
        });
      }
    }

// è®¾ç½®èµ„æºå¡ç‰Œç‚¹å‡»äº‹ä»¶
    function setupResourceCardClickEvents() {
      // ä¸ºèµ„æºå¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶
      document.addEventListener('click', function(e) {
        const resourceCard = e.target.closest('.resource-card');
        if (resourceCard) {
          const resourceId = resourceCard.getAttribute('data-resource');
          const resource = gameData.resources[resourceId];

// å¦‚æœæ˜¯æ®‹ç¾¹å‰©é¥­ï¼Œç›´æ¥æ¶ˆè€—
          if (resource && resourceId === 'cangenshengfan') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯çªçªå¤´ï¼Œç›´æ¥æ¶ˆè€—
          else if (resource && resourceId === 'cornbread') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯ç¨€ç²¥ï¼Œç›´æ¥æ¶ˆè€—
          else if (resource && resourceId === 'porridge') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯è¯ä¸¸ï¼Œç›´æ¥æ¶ˆè€—
          else if (resource && resourceId === 'pill') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯çµè¯ï¼Œæ˜¾ç¤ºä½¿ç”¨ç¡®è®¤çª—å£
          else if (resource && resourceId === 'medicine') {
            showMedicineWindow();
          }
          // å¦‚æœæ˜¯å¯å­¦ä¹ ç‰©å“ï¼Œæ˜¾ç¤ºå­¦ä¹ ç¡®è®¤çª—å£
          else if (resource && resource.type === 'learnable') {
            showLearnWindow(resourceId);
          }
          // å¦‚æœæ˜¯å¯è£…å¤‡ç‰©å“ï¼Œæ˜¾ç¤ºè£…å¤‡/å¸ä¸‹çª—å£
          else if (resource && resource.equipmentSlot) {
            showEquipmentWindow(resourceId);
          }
          // å¦‚æœæ˜¯ç¯ç«ï¼Œä½¿ç”¨çƒ¤ç«åŠŸèƒ½
          else if (resource && resourceId === 'fire') {
            // æ˜¾ç¤ºçƒ¤ç«ç¡®è®¤çª—å£
            showCampfireConfirmModal();
          }
          // å¦‚æœæ˜¯æˆ¿å±‹åœ°å¥‘ï¼Œæ˜¾ç¤ºæ‹¥æœ‰æˆ¿å±‹ç¡®è®¤çª—å£
          else if (resource && resourceId === 'house_deed') {
            // æ˜¾ç¤ºæ‹¥æœ‰æˆ¿å±‹ç¡®è®¤çª—å£
            showHouseDeedConfirmModal();
          }
        }
      });
    }

// æ¶ˆè€—é£Ÿç‰©
    function consumeFood(resourceId) {
      const resource = gameData.resources[resourceId];

// ä¼˜å…ˆä»åœ°é¢æ æ¶ˆè€—é£Ÿç‰©
      let consumedFromGround = false;
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      if (currentLocation) {
        const locationId = currentLocation.id;
        if (gameData.groundResources[locationId]) {
          // ä»åœ°é¢æ æŸ¥æ‰¾å¹¶æ¶ˆè€—é£Ÿç‰©
          for (let i = gameData.groundResources[locationId].length - 1; i >= 0; i--) {
            const groundItem = gameData.groundResources[locationId][i];
            if (groundItem.resourceId === resourceId && groundItem.amount > 0) {
              // æ¶ˆè€—åœ°é¢æ çš„é£Ÿç‰©
              groundItem.amount--;
              // å¦‚æœæ•°é‡ä¸º0ï¼Œä»åœ°é¢æ ç§»é™¤
              if (groundItem.amount <= 0) {
                gameData.groundResources[locationId].splice(i, 1);
              }
              consumedFromGround = true;
              break;
            }
          }
        }
      }

      // å¦‚æœåœ°é¢æ æ²¡æœ‰è¯¥é£Ÿç‰©ï¼Œåˆ™ä»èƒŒåŒ…æ æ¶ˆè€—
      if (!consumedFromGround) {
        if (resource.amount <= 0) {
          showNotification('æ— æ³•é£Ÿç”¨', `ä½ æ²¡æœ‰${resource.name}å¯ä»¥é£Ÿç”¨`);
          return;
        }

        // æ¶ˆè€—ä¸€ä¸ªé£Ÿç‰©ï¼ˆä½¿ç”¨æ‰¹æ¬¡ç³»ç»Ÿï¼‰
        if (resource.isPerishable) {
          consumeFoodFromBatches(resourceId, 1);
        } else {
          resource.amount--;
        }
      } else {
        // ä»åœ°é¢æ æ¶ˆè€—åï¼Œä¹Ÿéœ€è¦å‡å°‘å…¨å±€èµ„æºæ•°é‡
        resource.amount--;
      }

      // æ’­æ”¾åƒä¸œè¥¿éŸ³æ•ˆï¼ˆ2.0å€é€Ÿï¼‰
      playSoundEffectWithSpeed('eat', 'éŸ³æ•ˆ/åƒä¸œè¥¿.wav', 2.0, { volume: 0.6 });

      // åº”ç”¨æ•ˆæœ
      if (resourceId === 'cangenshengfan') {
        // é£Ÿç”¨æ®‹ç¾¹å‰©é¥­
        const hungerIncrease = 10;
        gameData.status.hunger = Math.min(100, gameData.status.hunger + hungerIncrease); // å¢åŠ é¥±é£Ÿåº¦
        gameData.status.health = Math.max(0, gameData.status.health - 8);   // å‡å°‘å¥åº·åº¦
        // æ¶ˆåŒ–å€¼è½¬æ¢ï¼šé¥±é£Ÿåº¦çš„1/3è½¬æ¢ä¸ºæ¶ˆåŒ–å€¼
        gameData.status.digestion = Math.min(100, gameData.status.digestion + Math.floor(hungerIncrease / 3));
        checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨æ®‹ç¾¹å‰©é¥­', 'ä½ åƒäº†ä¸€äº›æ®‹ç¾¹å‰©é¥­ï¼Œå¢åŠ äº†é¥±é£Ÿåº¦ï¼Œä½†é£Ÿç‰©ä¸å¤ªæ–°é²œï¼Œå¥åº·æœ‰æ‰€ä¸‹é™');

        // æ›´æ–°UI
        updateResourceCard('cangenshengfan');
      } else if (resourceId === 'cornbread') {
        // é£Ÿç”¨çªçªå¤´
        const hungerIncrease = 25;
        gameData.status.hunger = Math.min(100, gameData.status.hunger + hungerIncrease); // å¢åŠ è¾ƒå¤šé¥±é£Ÿåº¦
        // æ¶ˆåŒ–å€¼è½¬æ¢ï¼šé¥±é£Ÿåº¦çš„1/3è½¬æ¢ä¸ºæ¶ˆåŒ–å€¼
        gameData.status.digestion = Math.min(100, gameData.status.digestion + Math.floor(hungerIncrease / 3));

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨çªçªå¤´', 'ä½ åƒäº†ä¸€ä¸ªçªçªå¤´ï¼Œæ„Ÿè§‰é¥±å¤šäº†');

        // æ›´æ–°UI
        updateResourceCard('cornbread');
      } else if (resourceId === 'porridge') {
        // é£Ÿç”¨ç¨€ç²¥
        const hungerIncrease = 20;
        gameData.status.hunger = Math.min(100, gameData.status.hunger + hungerIncrease); // å¢åŠ 20é¥±é£Ÿåº¦
        // æ¶ˆåŒ–å€¼è½¬æ¢ï¼šé¥±é£Ÿåº¦çš„1/3è½¬æ¢ä¸ºæ¶ˆåŒ–å€¼
        gameData.status.digestion = Math.min(100, gameData.status.digestion + Math.floor(hungerIncrease / 3));

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨ç¨€ç²¥', 'ä½ å–äº†ä¸€ç¢—ç¨€ç²¥ï¼Œå¢åŠ äº†20é¥±é£Ÿåº¦');

        // æ›´æ–°UI
        updateResourceCard('porridge');
      } else if (resourceId === 'pill') {
        // é£Ÿç”¨è¯ä¸¸
        const healthIncrease = 40; // ç›´æ¥æ¢å¤40ç‚¹å¥åº·åº¦
        gameData.status.health = Math.min(100, gameData.status.health + healthIncrease);
        // è¯ä¸¸ä¸å¢åŠ æ¶ˆåŒ–å€¼

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨è¯ä¸¸', `ä½ åƒäº†ä¸€é¢—è¯ä¸¸ï¼Œå¥åº·åº¦æ¢å¤äº†${healthIncrease}ç‚¹ï¼ˆ40%ï¼‰ï¼`);

        // æ›´æ–°UI
        updateResourceCard('pill');
      } else if (resourceId === 'raw_meat') {
        // é£Ÿç”¨ç”Ÿè‚‰
        const hungerIncrease = 15;
        gameData.status.hunger = Math.min(100, gameData.status.hunger + hungerIncrease); // å¢åŠ é¥±é£Ÿåº¦
        gameData.status.health = Math.max(0, gameData.status.health - 5);   // å‡å°‘å¥åº·åº¦ï¼ˆç”Ÿè‚‰ä¸å¥åº·ï¼‰
        // æ¶ˆåŒ–å€¼è½¬æ¢ï¼šé¥±é£Ÿåº¦çš„1/3è½¬æ¢ä¸ºæ¶ˆåŒ–å€¼
        gameData.status.digestion = Math.min(100, gameData.status.digestion + Math.floor(hungerIncrease / 3));
        checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨ç”Ÿè‚‰', 'ä½ åƒäº†ä¸€äº›ç”Ÿè‚‰ï¼Œå¢åŠ äº†é¥±é£Ÿåº¦ï¼Œä½†ç”Ÿè‚‰å¯èƒ½ä¸å¤ªå«ç”Ÿï¼Œå¥åº·æœ‰æ‰€ä¸‹é™');

        // æ›´æ–°UI
        updateResourceCard('raw_meat');
      } else if (resourceId === 'cooked_meat') {
        // é£Ÿç”¨ç†Ÿè‚‰
        const hungerIncrease = 30;
        gameData.status.hunger = Math.min(100, gameData.status.hunger + hungerIncrease); // å¢åŠ è¾ƒå¤šé¥±é£Ÿåº¦
        // æ¶ˆåŒ–å€¼è½¬æ¢ï¼šé¥±é£Ÿåº¦çš„1/3è½¬æ¢ä¸ºæ¶ˆåŒ–å€¼
        gameData.status.digestion = Math.min(100, gameData.status.digestion + Math.floor(hungerIncrease / 3));

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨ç†Ÿè‚‰', 'ä½ åƒäº†ä¸€äº›ç†Ÿè‚‰ï¼Œè¥å…»ä¸°å¯Œï¼Œæ„Ÿè§‰é¥±å¤šäº†');

        // æ›´æ–°UI
        updateResourceCard('cooked_meat');
      } else if (resourceId === 'grilled_fish') {
        // é£Ÿç”¨çƒ¤é±¼
        const hungerIncrease = 25;
        gameData.status.hunger = Math.min(100, gameData.status.hunger + hungerIncrease); // å¢åŠ é¥±é£Ÿåº¦
        // æ¶ˆåŒ–å€¼è½¬æ¢ï¼šé¥±é£Ÿåº¦çš„1/3è½¬æ¢ä¸ºæ¶ˆåŒ–å€¼
        gameData.status.digestion = Math.min(100, gameData.status.digestion + Math.floor(hungerIncrease / 3));

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨çƒ¤é±¼', 'ä½ åƒäº†ä¸€æ¡çƒ¤é±¼ï¼Œç¾å‘³åˆè¥å…»');

        // æ›´æ–°UI
        updateResourceCard('grilled_fish');
      }

      // å¦‚æœæ˜¯ä»åœ°é¢æ æ¶ˆè€—çš„é£Ÿç‰©ï¼Œæ›´æ–°åœ°é¢æ æ˜¾ç¤º
      if (consumedFromGround) {
        renderGroundResources();
      }

updateGameData();
    }


// å¤„ç†èµ„æºç‚¹å‡»äº‹ä»¶
    function handleResourceClick(resourceId) {
      const resource = gameData.resources[resourceId];

if (!resource || resource.amount <= 0) {
        showNotification('æ— æ³•ä½¿ç”¨', `ä½ æ²¡æœ‰${resource?.name || 'è¯¥ç‰©å“'}å¯ä»¥ä½¿ç”¨`);
        return;
      }

      // å¤„ç†è¯ä¸¸
      if (resourceId === 'pill') {
        consumeFood(resourceId);
        return;
      }

// å¤„ç†æ°´ç±»å¡ç‰Œçš„é¥®ç”¨
      if (resourceId === 'dirty_water_bowl') {
        // é¥®ç”¨è„æ°´
        resource.amount--;
        gameData.status.thirst = Math.min(100, gameData.status.thirst + 30); // å¢åŠ 30ç‚¹æ°´åˆ†å€¼
        gameData.status.health = Math.max(0, gameData.status.health - 15);   // å‡å°‘15ç‚¹å¥åº·å€¼
        checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
        showNotification('é¥®ç”¨è„æ°´', 'ä½ å–äº†ä¸€å£è„æ°´ï¼Œè™½ç„¶è¡¥å……äº†æ°´åˆ†ä½†æ„Ÿè§‰ä¸å¤ªèˆ’æœï¼Œå¥åº·æœ‰æ‰€ä¸‹é™ã€‚');
        updateResourceCard(resourceId);
        return;
      }

// ä¸ºæ°´è¢‹æ·»åŠ ç‰¹æ®Šå¤„ç†
      if (resourceId === 'water_bag') {
        showWaterBagConfirmWindow(resourceId);
      }
      // å…¶ä»–èµ„æºç‚¹å‡»å¤„ç†...
    }

// æ˜¾ç¤ºæ°´è¢‹ç¡®è®¤ä½¿ç”¨çª—å£
    function showWaterBagConfirmWindow(resourceId) {
      const resource = gameData.resources[resourceId];

      // è®¡ç®—æ€»æ°´é‡
      let totalWaterLevel = 0;
      if (resource.instances && resource.instances.length > 0) {
        totalWaterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
      } else {
        totalWaterLevel = resource.waterLevel || 100;
      }

// ç›´æ¥é¥®ç”¨ï¼Œä¸éœ€è¦ç¡®è®¤å¯¹è¯æ¡†
      if (totalWaterLevel > 0) {
        drinkWaterBag(resourceId);
      } else if (totalWaterLevel <= 0) {
        showNotification('æ— æ³•ä½¿ç”¨', 'æ‰€æœ‰æ°´è¢‹éƒ½æ˜¯ç©ºçš„ï¼Œéœ€è¦å…ˆè£…æ°´ã€‚');
      }
      // å–æ¶ˆåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    }

// æ˜¾ç¤ºæ°´ç¼¸ç¡®è®¤å–æ°´çª—å£ï¼ˆè‡ªå®šä¹‰çª—å£ï¼‰

// å®ç°é¥®ç”¨è£…æ»¡æ°´çš„æ°´è¢‹åŠŸèƒ½
    function drinkWaterBag(resourceId) {
      const waterBag = gameData.resources[resourceId];

if (!waterBag || waterBag.amount <= 0) {
        showNotification('æ— æ³•ä½¿ç”¨', 'ä½ æ²¡æœ‰æ°´è¢‹å¯ä»¥ä½¿ç”¨');
        return;
      }

      // ä½¿ç”¨ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
      const result = useWaterFromContainer('water_bag', 20);

      if (!result.success) {
        showNotification('æ— æ³•ä½¿ç”¨', result.message);
        return;
      }

      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      updateGameData();

      // æ¢å¤å£æ¸´å€¼
      gameData.status.thirst = Math.min(100, gameData.status.thirst + result.usedAmount);

      // æ˜¾ç¤ºç»“æœ
      showNotification('å–æ°´æˆåŠŸ', `ä½ ä»æ°´è¢‹ä¸­å–äº†æ°´ï¼Œæ¢å¤äº†${result.usedAmount}ç‚¹å£æ¸´å€¼ã€‚`);

      // æ’­æ”¾å–æ°´éŸ³æ•ˆ
      playSoundEffect('drink', 'éŸ³æ•ˆ/å–æ°´.wav', { volume: 0.7 });
    }




// ä½¿ç”¨çµè¯
    function useMedicine(resourceId) {
      const resource = gameData.resources[resourceId];

if (!resource || resource.amount <= 0) {
        showNotification('æ— æ³•ä½¿ç”¨', `ä½ æ²¡æœ‰${resource?.name || 'è¯¥ç‰©å“'}å¯ä»¥ä½¿ç”¨`);
        return;
      }

// æ¶ˆè€—ä¸€ä¸ªçµè¯
      resource.amount--;

// åº”ç”¨æ•ˆæœ
      gameData.status.health = Math.min(100, gameData.status.health + 50); // æ¢å¤50ç‚¹å¥åº·å€¼

// æ˜¾ç¤ºé€šçŸ¥
      showNotification('ä½¿ç”¨çµè¯', 'ä½ ä½¿ç”¨äº†çµè¯ï¼Œæ¢å¤äº†50ç‚¹å¥åº·å€¼ï¼');

// æ›´æ–°UI
      updateResourceCard(resourceId);

updateGameData();
    }

// è·å–è£…å¤‡æè¿°
    function getEquipmentDescription(resourceId) {
      const resource = gameData.resources[resourceId];

// æ ¹æ®è£…å¤‡ç±»å‹æ·»åŠ å±æ€§åŠ æˆæè¿°
      switch(resourceId) {
        case 'simple_clothes': // ç ´è¡£æœ
          return 'æä¾›åŸºæœ¬çš„ä¿æš–ï¼Œè£…å¤‡åï¼š<br>ä¿æš–åº¦ +10';
        case 'shoes': // ç ´é‹
          return 'æä¾›åŸºæœ¬çš„è„šéƒ¨ä¿æŠ¤ï¼Œè£…å¤‡åï¼š<br>å¥åº·åº¦ +5<br>ä¿æš–åº¦ +5';
        case 'crutch': // æ‹æ–
          return 'æé«˜ç§»åŠ¨èƒ½åŠ›å’Œå£°æœ›ï¼Œè£…å¤‡åï¼š<br>å¥åº·åº¦ +10<br>å£°æœ› +10';
        case 'black_cloak': // é»‘è‰²æ–—ç¯·
          return 'ç”¨äºè¿›å…¥é»‘å¸‚çš„ç‰¹æ®Šè¡£ç‰©ï¼Œè£…å¤‡åï¼š<br>ç²¾ç¥çŠ¶æ€ +15<br>è§£é”é»‘å¸‚è®¿é—®æƒé™';
        case 'fire': // ç¯ç«
          return 'æä¾›æ¸©æš–ï¼Œçƒ¹é¥ªé£Ÿç‰©ï¼Œæ”¾ç½®åï¼š<br>ä¿æš–åº¦ +20<br>å¥åº·åº¦ +5';
        case 'clay_bowl': // æ³¥ç¢—
          return 'æé«˜ä¹è®¨æˆåŠŸç‡ï¼Œä½¿ç”¨åï¼š<br>ä¹è®¨æˆåŠŸç‡ +10%';
        case 'bamboo_bow': // ç«¹å¼“
          return 'ä¸´æ—¶æé«˜æˆ˜æ–—åŠ›ï¼Œè£…å¤‡åï¼š<br>æ”»å‡»åŠ› +10<br>å‘½ä¸­ç‡ +10%<br>è€ä¹…åº¦ï¼š' + (resource.durability || 100) + '/100';
        default:
          return resource.description || 'æ— ç‰¹æ®Šæ•ˆæœ';
      }
    }

// æ˜¾ç¤ºè£…å¤‡/å¸ä¸‹çª—å£
    function showEquipmentWindow(resourceId) {
      const resource = gameData.resources[resourceId];

// åˆ›å»ºè£…å¤‡çª—å£å…ƒç´ 
      const equipmentWindow = document.createElement('div');
      equipmentWindow.className = 'equipment-window ink-border';
      equipmentWindow.id = 'equipmentWindow';
      equipmentWindow.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #FFFDF7;
        border-radius: 0.25rem;
        padding: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 300px;
        text-align: center;
      `;

// çª—å£å†…å®¹
      const isBambooBow = resourceId === 'bamboo_bow';
      equipmentWindow.innerHTML = `
        <div class="equipment-window-header" style="margin-bottom: 1rem;">
          <h3 class="ink-text" style="font-size: 1.25rem; font-weight: 700; color: #5D4037;">${resource.name}</h3>
        </div>
        <div class="equipment-window-body" style="margin-bottom: 1.5rem;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1rem; background-color: #E2E8F0; border-radius: 0.25rem; overflow: hidden;">
            <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          <p style="color: #7D6E63; margin-bottom: 1rem;">${getEquipmentDescription(resourceId)}</p>
          <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <button class="equipment-button ink-button ink-button-primary" id="equipButton">
              ${resource.equipped ? 'å¸ä¸‹' : 'ç©¿æˆ´'}
            </button>
            ${isBambooBow ? `
            <button class="equipment-button ink-button ink-button-secondary" id="useButton">
              ä½¿ç”¨
            </button>
            ` : ''}
            <button class="equipment-button ink-button ink-button-secondary" id="cancelButton">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      `;

// æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(equipmentWindow);

// æ·»åŠ ç‚¹å‡»äº‹ä»¶
      const equipButton = equipmentWindow.querySelector('#equipButton');
      const cancelButton = equipmentWindow.querySelector('#cancelButton');

equipButton.addEventListener('click', function() {
        if (resource.equipped) {
          // å¸ä¸‹è£…å¤‡
          unequipItem(resource.equipmentSlot, resourceId);
        } else {
          // è£…å¤‡ç‰©å“
          equipItem(resourceId);
        }

// å…³é—­çª—å£
        closeEquipmentWindow();
      });

// ä¸ºç«¹å¼“æ·»åŠ ä½¿ç”¨æŒ‰é’®äº‹ä»¶
      if (isBambooBow) {
        const useButton = equipmentWindow.querySelector('#useButton');
        useButton.addEventListener('click', function() {
          // ä½¿ç”¨ç«¹å¼“ï¼Œæ¶ˆè€—è€ä¹…åº¦
          decreaseBambooBowDurability();

// é‡æ–°æ¸²æŸ“è£…å¤‡çª—å£ä»¥æ›´æ–°è€ä¹…åº¦æ˜¾ç¤º
          closeEquipmentWindow();
          showEquipmentWindow(resourceId);
        });
      }

cancelButton.addEventListener('click', function() {
        closeEquipmentWindow();
      });

// ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      equipmentWindow.addEventListener('click', function(e) {
        if (e.target === equipmentWindow) {
          closeEquipmentWindow();
        }
      });
    }

// å…³é—­è£…å¤‡çª—å£
    function closeEquipmentWindow() {
      const equipmentWindow = document.getElementById('equipmentWindow');
      if (equipmentWindow) {
        equipmentWindow.remove();
      }
    }

// æ˜¾ç¤ºå­¦ä¹ ç¡®è®¤çª—å£
    function showLearnWindow(resourceId) {
      const resource = gameData.resources[resourceId];

// åˆ›å»ºå­¦ä¹ çª—å£å…ƒç´ 
      const learnWindow = document.createElement('div');
      learnWindow.className = 'learn-window ink-border';
      learnWindow.id = 'learnWindow';
      learnWindow.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #FFFDF7;
        border-radius: 0.25rem;
        padding: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 300px;
        text-align: center;
      `;

// çª—å£å†…å®¹
      learnWindow.innerHTML = `
        <div class="learn-window-header" style="margin-bottom: 1rem;">
          <h3 class="ink-text" style="font-size: 1.25rem; font-weight: 700; color: #5D4037;">${resource.name}</h3>
        </div>
        <div class="learn-window-body" style="margin-bottom: 1.5rem;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1rem; background-color: #E2E8F0; border-radius: 0.25rem; overflow: hidden;">
            <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          <p style="color: #7D6E63; margin-bottom: 1rem;">${resource.description}</p>
          <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="learn-button ink-button ink-button-primary" id="learnButton">
              å­¦ä¹ 
            </button>
            <button class="learn-button ink-button ink-button-secondary" id="cancelLearnButton">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      `;

// æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(learnWindow);

// æ·»åŠ ç‚¹å‡»äº‹ä»¶
      const learnButton = learnWindow.querySelector('#learnButton');
      const cancelButton = learnWindow.querySelector('#cancelLearnButton');

learnButton.addEventListener('click', function() {
        // å­¦ä¹ ç‰©å“
        learnItem(resourceId);

// å…³é—­çª—å£
        closeLearnWindow();
      });

cancelButton.addEventListener('click', function() {
        closeLearnWindow();
      });

// ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      learnWindow.addEventListener('click', function(e) {
        if (e.target === learnWindow) {
          closeLearnWindow();
        }
      });
    }

// å…³é—­å­¦ä¹ çª—å£
    function closeLearnWindow() {
      const learnWindow = document.getElementById('learnWindow');
      if (learnWindow) {
        learnWindow.remove();
      }
    }

// æ£€æŸ¥æŠ€èƒ½æ˜¯å¦éœ€è¦å‡çº§
    function checkSkillLevelUp(skillId, eventResults) {
      const skill = gameData.skills[skillId];
      if (!skill) return;

// æ£€æŸ¥æŠ€èƒ½æ˜¯å¦å·²ç»è¾¾åˆ°æœ€é«˜ç­‰çº§
      if (skill.level >= skill.maxLevel) return;

// æ£€æŸ¥å½“å‰ç»éªŒæ˜¯å¦è¾¾åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„ç»éªŒ
      if (gameData.skillExpRequired[skill.level + 1] && skill.experience >= gameData.skillExpRequired[skill.level + 1]) {
        // æå‡æŠ€èƒ½ç­‰çº§
        skill.level++;

// æ­¦æœ¯æŠ€èƒ½å‡çº§æ—¶å¢åŠ æ­¦åŠ›å€¼ï¼šæ¯çº§+5
        if (skillId === 'martial') {
            if (!skill.power) {
                skill.power = 10; // ç¡®ä¿åŸºç¡€æ­¦åŠ›å€¼æ­£ç¡®
            } else {
                skill.power += 5;
                levelUpEffect += `\næ­¦åŠ›å€¼å¢åŠ 5ç‚¹ï¼Œå½“å‰æ­¦åŠ›å€¼ï¼š${skill.power}`;
            }
        }

// è·å–æŠ€èƒ½åç§°
        const skillName = skill.name || skillId;

// æ›´æ–°æ•ˆæœæè¿°
        let levelUpEffect = `${skillName}æŠ€èƒ½å‡çº§åˆ° ${skill.level} çº§ï¼`;

// æ·»åŠ åˆ°äº‹ä»¶ç»“æœï¼ˆå¦‚æœå½“å‰æ­£åœ¨å¤„ç†äº‹ä»¶ï¼‰
        if (eventResults) {
          eventResults.effects.push(levelUpEffect);
        }

// æ˜¾ç¤ºå‡çº§é€šçŸ¥
        showNotification('æŠ€èƒ½å‡çº§', levelUpEffect);

// æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºUI
        updateSkillDisplay();

// æ£€æŸ¥æ˜¯å¦å¯ä»¥ç»§ç»­å‡çº§
        checkSkillLevelUp(skillId, eventResults);
      }
    }

// æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
    function updateSkillDisplay() {
      // æŠ€èƒ½æ˜¾ç¤ºç°åœ¨é€šè¿‡æŠ€èƒ½æŒ‰é’®å’Œçª—å£å®Œæˆï¼Œä¸å†åœ¨çŠ¶æ€æ ä¸­æ˜¾ç¤º
      // ç§»é™¤ç°æœ‰çš„æŠ€èƒ½å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const existingSkillsContainer = document.getElementById('skillsContainer');
      if (existingSkillsContainer) {
        existingSkillsContainer.remove();
      }

// å¦‚æœæŠ€èƒ½çª—å£å·²æ‰“å¼€ï¼Œæ›´æ–°æŠ€èƒ½åˆ—è¡¨ä¸­çš„ç»éªŒæ¡
      const skillsWindow = document.getElementById('skillsWindow');
      if (skillsWindow) {
        const skillsList = skillsWindow.querySelector('.skills-list');
        if (skillsList) {
          skillsList.innerHTML = '';
          renderSkillsInWindow(skillsList);
        }
      }

return;
      // ä»¥ä¸‹æ˜¯åŸå‡½æ•°å†…å®¹ï¼Œå·²è¢«æ³¨é‡Šæ‰
      /*
      try {
        // åˆ›å»ºæˆ–è·å–æŠ€èƒ½æ˜¾ç¤ºå®¹å™¨
        let skillsContainer = document.getElementById('skillsContainer');
        if (!skillsContainer) {
          // åœ¨çŠ¶æ€æ ä¸­åˆ›å»ºæŠ€èƒ½æ˜¾ç¤ºåŒºåŸŸ - ä¿®æ­£é€‰æ‹©å™¨ä¸ºstatus-grid
          const statusDiv = document.querySelector('.status-grid');

// å¥å£®çš„é”™è¯¯æ£€æŸ¥
          if (!statusDiv) {
            console.warn('æ— æ³•æ‰¾åˆ°çŠ¶æ€å®¹å™¨å…ƒç´ (.status-grid)ï¼Œè·³è¿‡æŠ€èƒ½æ˜¾ç¤ºåˆ›å»º');
            return;
          }

skillsContainer = document.createElement('div');
          skillsContainer.id = 'skillsContainer';
          skillsContainer.className = 'skills-container';
          skillsContainer.style.cssText = `
            margin-top: 1rem;
            padding: 1rem;
            background-color: #F7FAFC;
            border-radius: 0.5rem;
            border: 1px solid #E2E8F0;
          `;

// æ·»åŠ æ ‡é¢˜
          const title = document.createElement('h3');
          title.textContent = 'æŠ€èƒ½';
          title.style.cssText = `
            font-size: 1rem;
            font-weight: normal;
            color: #2D3748;
            margin-bottom: 0.75rem;
          `;
          skillsContainer.appendChild(title);

statusDiv.appendChild(skillsContainer);
        }

// æ¸…ç©ºç°æœ‰å†…å®¹
      while (skillsContainer.children.length > 1) { // ä¿ç•™æ ‡é¢˜
        skillsContainer.removeChild(skillsContainer.lastChild);
      }

// åˆ›å»ºæŠ€èƒ½åˆ—è¡¨
      const skillsList = document.createElement('div');
      skillsList.className = 'skills-list';
      skillsList.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      `;

// éå†æ‰€æœ‰æŠ€èƒ½
      for (const [skillId, skill] of Object.entries(gameData.skills)) {
        const skillItem = document.createElement('div');
        skillItem.className = 'skill-item';
        skillItem.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem;
          background-color: #EDF2F7;
          border-radius: 0.25rem;
        `;

// æŠ€èƒ½åç§°å’Œç­‰çº§
        const skillInfo = document.createElement('div');
        skillInfo.style.cssText = `
          font-size: 0.875rem;
          color: #4A5568;
        `;
        skillInfo.textContent = `${skill.name} (ç­‰çº§ ${skill.level}/${skill.maxLevel})`;

// ç»éªŒæ¡
        const expContainer = document.createElement('div');
        expContainer.style.cssText = `
          width: 120px;
          height: 0.5rem;
          background-color: #E2E8F0;
          border-radius: 0.25rem;
          overflow: hidden;
        `;

const expBar = document.createElement('div');
        expBar.className = 'exp-bar';

// è®¡ç®—ç»éªŒè¿›åº¦ç™¾åˆ†æ¯”
        let expPercentage = 0;
        if (skill.level < skill.maxLevel) {
          const currentExp = skill.experience - (skill.level > 1 ? gameData.skillExpRequired[skill.level - 1] : 0);
          const requiredExp = gameData.skillExpRequired[skill.level] - (skill.level > 1 ? gameData.skillExpRequired[skill.level - 1] : 0);
          expPercentage = requiredExp > 0 ? (currentExp / requiredExp) * 100 : 100;
        }

expBar.style.cssText = `
          height: 100%;
          width: ${expPercentage}%;
          background-color: #805AD5;
          transition: width 0.3s ease;
        `;

expContainer.appendChild(expBar);
        skillItem.appendChild(skillInfo);
        skillItem.appendChild(expContainer);
        skillsList.appendChild(skillItem);
      }

skillsContainer.appendChild(skillsList);
      }
      catch (error) {
        console.error('æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
      }
      */
    }

// è£…å¤‡ç‰©å“
    function equipItem(resourceId) {
      const resource = gameData.resources[resourceId];

if (!resource || !resource.equipmentSlot) {
        showNotification('è£…å¤‡å¤±è´¥', 'è¿™ä¸æ˜¯å¯è£…å¤‡ç‰©å“');
        return;
      }

// æ£€æŸ¥ç‰©å“æ•°é‡
      if (resource.amount <= 0) {
        showNotification('è£…å¤‡å¤±è´¥', `ä½ æ²¡æœ‰${resource.name}å¯ä»¥è£…å¤‡`);
        return;
      }

// æ£€æŸ¥è¯¥æ§½ä½æ˜¯å¦å·²æœ‰è£…å¤‡
      const slotType = resource.equipmentSlot;
      const slot = document.querySelector(`.equipment-slots .combination-slot[data-slot="${slotType}"]`);

// æ£€æŸ¥è¯¥æ§½ä½æ˜¯å¦å·²æœ‰è£…å¤‡
      for (const [currentResourceId, currentResource] of Object.entries(gameData.resources)) {
        if (currentResource.equipmentSlot === slotType && currentResource.equipped) {
          // å¸ä¸‹å½“å‰è£…å¤‡
          unequipItem(slotType, currentResourceId);
          break;
        }
      }

// è£…å¤‡æ–°ç‰©å“
      resource.equipped = true;

// åº”ç”¨è£…å¤‡æ•ˆæœ
      applyEquipmentEffect(resourceId, 'equip');

// æ›´æ–°æ¸¸æˆæ•°æ®å’ŒçŠ¶æ€æ ï¼ˆç¡®ä¿ä½“æ¸©å˜åŒ–åŠæ—¶æ˜¾ç¤ºï¼‰
      updateGameData();

// æ›´æ–°å½“å‰è£…å¤‡æ§½
      updateEquipmentSlot(slotType, resourceId);

// æ›´æ–°èƒŒåŒ…
      updateResourceCard(resourceId);

// æ˜¾ç¤ºé€šçŸ¥
      showNotification('è£…å¤‡æˆåŠŸ', `æˆåŠŸè£…å¤‡äº†${resource.name}`);
    }

// å­¦ä¹ ç‰©å“
    function learnItem(resourceId) {
      const resource = gameData.resources[resourceId];

if (!resource || resource.type !== 'learnable') {
        showNotification('å­¦ä¹ å¤±è´¥', 'è¿™ä¸æ˜¯å¯å­¦ä¹ ç‰©å“');
        return;
      }

// æ£€æŸ¥ç‰©å“æ•°é‡
      if (resource.amount <= 0) {
        showNotification('å­¦ä¹ å¤±è´¥', `ä½ æ²¡æœ‰${resource.name}å¯ä»¥å­¦ä¹ `);
        return;
      }

// è·å–å…³è”çš„æŠ€èƒ½
      const skillType = resource.skill;
      if (!skillType || !gameData.skills[skillType]) {
        showNotification('å­¦ä¹ å¤±è´¥', 'æ­¤ç‰©å“æ²¡æœ‰å…³è”çš„æŠ€èƒ½');
        return;
      }

// æå‡æŠ€èƒ½ç­‰çº§ï¼ˆå­¦ä¹ æŠ€èƒ½ä¹¦ç›´æ¥æå‡1çº§ï¼‰
      const skill = gameData.skills[skillType];
      if (skill.level < skill.maxLevel) {
        // å¢åŠ 1çº§
        skill.level += 1;

// é‡ç½®ç»éªŒå€¼ä¸ºå½“å‰ç­‰çº§æ‰€éœ€çš„åŸºç¡€å€¼
        if (skill.level > 1) {
          skill.experience = gameData.skillExpRequired[skill.level - 1];
        }

// ç‰¹æ®Šæ•ˆæœå¤„ç†
        let specialEffect = '';
        switch(resourceId) {
          case 'day_stealing':
            specialEffect = 'å·çªƒæˆåŠŸç‡å¢åŠ 30%';
            gameData.skills.thievery.successRateBonus = 0.3; // 30%æˆåŠŸç‡åŠ æˆ
            break;
          case 'herbal_canon':
            specialEffect = 'è·å¾—è‰è¯è¯†åˆ«èƒ½åŠ›';
            // æ ‡è®°å·²å­¦ä¼šè¯†åˆ«è‰è¯
            gameData.skills.medicine.canIdentifyHerbs = true;
            break;
          case 'huangdi_canon':
            specialEffect = 'è·å¾—ç–¾ç—…æ²»ç–—èƒ½åŠ›ï¼ˆæˆåŠŸç‡40%ï¼‰';
            // æ ‡è®°å·²å­¦ä¼šæ²»ç–—ç–¾ç—…
            gameData.skills.medicine.canTreatDisease = true;
            gameData.skills.medicine.cureSuccessRate = 0.4; // 40%æ²»ç–—æˆåŠŸç‡

// æ·»åŠ æ²»ç–—ç–¾ç—…çš„åŠŸèƒ½ï¼ˆå¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ç›¸å…³æŒ‰é’®æˆ–åŠŸèƒ½ï¼‰
            if (!window.hasOwnProperty('handleDiseaseTreatment')) {
              window.handleDiseaseTreatment = function() {
                if (!gameData.skills.medicine.canTreatDisease) {
                  showNotification('æ— æ³•æ²»ç–—', 'ä½ è¿˜æ²¡æœ‰å­¦ä¼šæ²»ç–—ç–¾ç—…çš„æŠ€èƒ½');
                  return;
                }

// æ£€æŸ¥æ˜¯å¦ç”Ÿç—…
                if (!gameData.status.isSick) {
                  showNotification('æ— éœ€æ²»ç–—', 'ä½ ç›®å‰æ²¡æœ‰ç”Ÿç—…');
                  return;
                }

// è®¡ç®—æ²»ç–—æˆåŠŸç‡ï¼šåŸºç¡€40% + æ¯çº§5%
                const totalCureRate = Math.min(0.95, gameData.skills.medicine.cureSuccessRate + (gameData.skills.medicine.level * 0.05));
                // å°è¯•æ²»ç–—
                const success = Math.random() < totalCureRate;
                if (success) {
                  gameData.status.isSick = false;
                  gameData.status.health = Math.min(100, gameData.status.health + 10); // æ²»ç–—æˆåŠŸåæ¢å¤ä¸€äº›å¥åº·å€¼

showNotification('æ²»ç–—æˆåŠŸ', 'ä½ æˆåŠŸæ²»æ„ˆäº†ç–¾ç—…ï¼å¥åº·å€¼æ¢å¤äº†10ç‚¹ã€‚');

// æ²»ç–—æˆåŠŸå¢åŠ åŒ»æœ¯æŠ€èƒ½ç»éªŒå€¼
                  gameData.skills.medicine.experience += 2;
                  checkSkillLevelUp('medicine');
                } else {
                  showNotification('æ²»ç–—å¤±è´¥', 'æ²»ç–—å¤±è´¥äº†ï¼Œä½ éœ€è¦ä¼‘æ¯ä¸€ä¸‹å†å°è¯•ã€‚');
                }

    // æ¸…é™¤æ¸¸æˆå­˜æ¡£ï¼ˆç”¨äºä¿®å¤æ—§æ•°æ®é—®é¢˜ï¼‰
    function clearSavedGame() {
      try {
        localStorage.removeItem('beggarSurvivalGameSave');
        localStorage.removeItem('pinnedResources');
        localStorage.removeItem('inventoryOrder');
        showNotification('å­˜æ¡£å·²æ¸…é™¤', 'å·²æ¸…é™¤æ‰€æœ‰æ¸¸æˆå­˜æ¡£ï¼Œåˆ·æ–°é¡µé¢åç”Ÿæ•ˆ');
      } catch (error) {
        console.error('æ¸…é™¤å­˜æ¡£æ—¶å‡ºé”™:', error);
        showNotification('æ¸…é™¤å¤±è´¥', 'æ¸…é™¤å­˜æ¡£æ—¶å‡ºé”™');
      }
      
      // æ›´æ–°éŸ³æ•ˆç³»ç»Ÿ
      updateWeatherSoundEffects();
      updateTimeSoundEffects();
      updateSceneSoundEffects();
      updateBonfireSoundEffect();
    }

// æ›´æ–°æ¸¸æˆæ•°æ®
                updateGameData();
              };
            }
            break;
          case 'dog_beating_stick':
            specialEffect = 'å‡»ä¸­æ¦‚ç‡å¢åŠ 30%';
            // æ ‡è®°å·²å­¦ä¼šæ‰“ç‹—æ£’æ³•
            gameData.skills.martial.canUseDogStick = true;
            gameData.skills.martial.hitProbabilityBonus = 0.3; // 30%å‡»ä¸­æ¦‚ç‡åŠ æˆ
            // åˆå§‹åŒ–æ­¦æœ¯æ­¦åŠ›å€¼ï¼šåŸºç¡€10 + æ¯çº§5
            if (!gameData.skills.martial.power) {
                gameData.skills.martial.power = 10;
            }
            break;
        }

// æ˜¾ç¤ºé€šçŸ¥
        showNotification('å­¦ä¹ æˆåŠŸ', `æˆåŠŸå­¦ä¹ äº†${resource.name}ï¼\n${skill.name}æŠ€èƒ½æå‡è‡³${skill.level}çº§ï¼\n${specialEffect}`);
      } else {
        showNotification('å­¦ä¹ å¤±è´¥', 'è¯¥æŠ€èƒ½å·²ç»è¾¾åˆ°æœ€é«˜ç­‰çº§');
        return;
      }

// å¦‚æœæ˜¯ä¸€æ¬¡æ€§ä½¿ç”¨ç‰©å“ï¼Œæ¶ˆè€—ä¸€ä¸ª
      if (resource.oneTimeUse) {
        resource.amount--;

// å¦‚æœæ•°é‡ä¸º0ä¸”ä¸å¯ä¸¢å¼ƒï¼Œä¿æŒåœ¨èƒŒåŒ…ä¸­ä½†æ˜¾ç¤ºä¸º0
        if (resource.amount <= 0 && !resource.cannotDrop) {
          // å¯ä»¥ä»èƒŒåŒ…ä¸­ç§»é™¤
          // è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¿ç•™ï¼Œåªæ˜¯æ•°é‡ä¸º0
        }
      }

// æ›´æ–°UI
      updateResourceCard(resourceId);
      updateSkillDisplay(); // éœ€è¦å®ç°è¿™ä¸ªå‡½æ•°æ¥æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
      updateGameData();
    }

// æ˜¾ç¤ºæˆ¿å±‹åœ°å¥‘ç¡®è®¤å¼¹çª—
    function showHouseDeedConfirmModal() {
      // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æ¨¡æ€æ¡†ï¼Œé˜²æ­¢é‡å¤åˆ›å»º
      const existingModal = document.querySelector('.house-deed-modal');
      if (existingModal) {
        return; // å¦‚æœå·²ç»å­˜åœ¨ï¼Œç›´æ¥è¿”å›
      }

      // åˆ›å»ºç¡®è®¤å¼¹çª—
      const modal = document.createElement('div');
      modal.className = 'house-deed-modal';
      modal.innerHTML = `
        <div class="house-deed-modal-content ink-border">
          <h2 class="house-deed-modal-title ink-text">æ‹¥æœ‰æˆ¿å±‹</h2>
          <div class="ink-decoration">
            <p class="house-deed-modal-text">ä½ æ˜¯å¦å‡†å¤‡ä½¿ç”¨æˆ¿å±‹åœ°å¥‘ï¼Œæ‹¥æœ‰è‡ªå·±çš„å®…é‚¸ï¼Ÿ</p>
          </div>
          <div class="house-deed-modal-buttons">
            <button class="house-deed-modal-button ink-button ink-button-primary" id="confirmHouseDeed">ç¡®å®š</button>
            <button class="house-deed-modal-button ink-button ink-button-secondary" id="cancelHouseDeed">å–æ¶ˆ</button>
          </div>
        </div>
      `;

      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .house-deed-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

        .house-deed-modal.active {
          opacity: 1;
          pointer-events: auto;
        }

        .house-deed-modal-content {
          background-color: #FFFDF7;
          padding: 2rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          width: 350px;
          text-align: center;
          border-radius: 0.25rem;
        }

        .house-deed-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #5D4037;
          margin-bottom: 1rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .house-deed-modal-text {
          color: #7D6E63;
          margin-bottom: 1.5rem;
          line-height: 1.5;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .house-deed-modal-buttons {
          display: flex;
          gap: 1rem;
          justify-content: center;
        }

        .house-deed-modal-button {
          background-color: #8D6E63;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          display: inline-block;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
          border: none;
        }

        .house-deed-modal-button:hover {
          background-color: #6D4C41;
        }

        .house-deed-modal-button.ink-button-secondary {
          background-color: #A0AEC0;
        }

        .house-deed-modal-button.ink-button-secondary:hover {
          background-color: #718096;
        }
      `;

      document.head.appendChild(style);
      document.body.appendChild(modal);

      // æ˜¾ç¤ºå¼¹çª—
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);

      // åˆ›å»ºå…³é—­å‡½æ•°
      function closeModal() {
        modal.classList.remove('active');
        setTimeout(function() {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
          if (style.parentNode) {
            style.parentNode.removeChild(style);
          }
        }, 300);
      }

      // ç¡®å®šæŒ‰é’®äº‹ä»¶ - ä½¿ç”¨ä¸€æ¬¡æ€§äº‹ä»¶å¤„ç†
      const confirmButton = document.getElementById('confirmHouseDeed');
      const confirmHandler = function(e) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        
        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢å¤šæ¬¡è§¦å‘
        confirmButton.removeEventListener('click', confirmHandler);
        
        // ç§»é™¤æˆ¿å±‹åœ°å¥‘
        const houseDeed = gameData.resources.house_deed;
        if (houseDeed && houseDeed.amount > 0) {
          houseDeed.amount = 0;
          updateResourceCard('house_deed');
        }

        // æ·»åŠ "æˆ‘çš„å®…é‚¸"åœ°ç‚¹åˆ°æ¸¸æˆä¸­
        addMyMansionLocation();

        // å…³é—­å¼¹çª—
        closeModal();

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('æ‹¥æœ‰å®…é‚¸', 'ä½ ä½¿ç”¨æˆ¿å±‹åœ°å¥‘æ‹¥æœ‰äº†å±äºè‡ªå·±çš„å®…é‚¸ï¼Œåœ°å›¾ä¸Šå·²æ–°å¢"æˆ‘çš„å®…é‚¸"åœ°ç‚¹ã€‚');
      };
      confirmButton.addEventListener('click', confirmHandler);

      // å–æ¶ˆæŒ‰é’®äº‹ä»¶ - ä½¿ç”¨ä¸€æ¬¡æ€§äº‹ä»¶å¤„ç†
      const cancelButton = document.getElementById('cancelHouseDeed');
      const cancelHandler = function(e) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        
        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢å¤šæ¬¡è§¦å‘
        cancelButton.removeEventListener('click', cancelHandler);
        
        closeModal();
      };
      cancelButton.addEventListener('click', cancelHandler);

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      const modalClickHandler = function(e) {
        if (e.target === modal) {
          closeModal();
        }
      };
      modal.addEventListener('click', modalClickHandler);

      // é˜»æ­¢å¼¹çª—å†…å®¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
      const modalContent = modal.querySelector('.house-deed-modal-content');
      const contentClickHandler = function(e) {
        e.stopPropagation();
      };
      modalContent.addEventListener('click', contentClickHandler);
    }

// æ·»åŠ "æˆ‘çš„å®…é‚¸"åœ°ç‚¹åˆ°æ¸¸æˆä¸­
    function addMyMansionLocation() {
      // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨"æˆ‘çš„å®…é‚¸"åœ°ç‚¹
      const existingLocation = gameData.locations.find(loc => loc.id === 'my_mansion');
      console.log('æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æˆ‘çš„å®…é‚¸:', existingLocation ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
      if (!existingLocation) {
        // åˆ›å»ºæ–°åœ°ç‚¹
        const myMansionLocation = {
          id: 'my_mansion',
          name: 'æˆ‘çš„å®…é‚¸',
          description: 'ä½ è‡ªå·±çš„å®…é‚¸ï¼Œå¯ä»¥æä¾›èˆ’é€‚çš„ä¼‘æ¯ç¯å¢ƒå’Œå®‰å…¨ä¿éšœã€‚',
          image: 'UI/æˆ‘çš„å®…é‚¸.jpg',
          available: true,
          resourceType: '',
          dangerLevel: 'none',
          actionPointCost: 1,
          entryCondition: {},
          currentLocation: false,
          actions: ['nap', 'upgrade_house'] // åˆå§‹è¡ŒåŠ¨ï¼Œå…¶ä»–è¡ŒåŠ¨æ ¹æ®æˆ¿å±‹ç­‰çº§è§£é”
        };

        // æ·»åŠ åˆ°åœ°ç‚¹åˆ—è¡¨
        gameData.locations.push(myMansionLocation);

        // æ·»åŠ åœ°å›¾åæ ‡
        if (!gameData.mapPositions) {
          gameData.mapPositions = {};
        }
        gameData.mapPositions['my_mansion'] = { x: 400, y: 200 };

        // æ›´æ–°åœ°ç‚¹æ˜¾ç¤º
        renderLocations();
        // åœ°å›¾æ¨¡æ€æ¡†ä¼šåœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€å•ç‹¬è°ƒç”¨
      }
    }
    
    // æ·»åŠ é©¬å©åœ°ç‚¹
    function addStableLocation() {
      // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨é©¬å©åœ°ç‚¹
      const existingLocation = gameData.locations.find(loc => loc.id === 'stable');
      if (!existingLocation) {
        // åˆ›å»ºæ–°åœ°ç‚¹
        const stableLocation = {
          id: 'stable',
          name: 'é©¬å©',
          description: 'å®…é‚¸é™„å±çš„é©¬å©ï¼Œå¯ä»¥é¥²å…»é©¬åŒ¹ï¼Œè·å¾—é«˜çº§èµ„æºå’Œäº¤é€šå·¥å…·ã€‚',
          image: 'UI/æˆ‘çš„å®…é‚¸.jpg', // æš‚æ—¶ä½¿ç”¨æˆ‘çš„å®…é‚¸å›¾ç‰‡
          available: false, // åˆå§‹ä¸å¯ç”¨ï¼Œéœ€è¦å®…é‚¸5çº§è§£é”
          resourceType: '',
          dangerLevel: 'none',
          actionPointCost: 1,
          entryCondition: {},
          currentLocation: false,
          actions: ['stable'] // åªæœ‰ä¸€ä¸ªè¡ŒåŠ¨ï¼šé¥²å…»é©¬åŒ¹
        };
        
        // æ·»åŠ åˆ°åœ°ç‚¹åˆ—è¡¨
        gameData.locations.push(stableLocation);
        
        // æ·»åŠ åœ°å›¾åæ ‡
        if (!gameData.mapPositions) {
          gameData.mapPositions = {};
        }
        gameData.mapPositions['stable'] = { x: 450, y: 200 }; // æ”¾åœ¨å®…é‚¸é™„è¿‘
        
        // æ›´æ–°åœ°ç‚¹æ˜¾ç¤º
        renderLocations();
        
        console.log('æ·»åŠ é©¬å©åœ°ç‚¹å®Œæˆ');
      }
    }

// æ˜¾ç¤ºçƒ¤ç«ç¡®è®¤çª—å£
    function showCampfireConfirmModal() {
      const modal = document.createElement('div');
      modal.className = 'campfire-modal active';
      modal.innerHTML = `
        <div class="campfire-modal-content ink-border">
          <h2 class="campfire-modal-title ink-text">ç¯ç«å–æš–</h2>
          <div class="ink-decoration">
            <p class="campfire-modal-text">æ¸©æš–çš„ç«ç„°åœ¨ç‡ƒçƒ§ï¼Œæ˜¯å¦éœ€è¦ç¯ç«å–æš–ï¼Ÿ</p>
          </div>
          <div class="campfire-modal-buttons">
            <div class="campfire-modal-button ink-button ink-button-primary" id="confirmCampfire">ç¯ç«å–æš–</div>
            <div class="campfire-modal-button ink-button ink-button-secondary" id="cancelCampfire">å–æ¶ˆ</div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

// æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .campfire-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 500;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

        .campfire-modal.active {
          opacity: 1;
          pointer-events: auto;
        }

        .campfire-modal-content {
          background-color: #FFFDF7;
          padding: 30px;
          border-radius: 6px;
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
          max-width: 400px;
          width: 90%;
          text-align: center;
        }

        .campfire-modal-title {
          font-size: 24px;
          margin-bottom: 20px;
          color: #5D4037;
          font-weight: normal;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .campfire-modal-text {
          font-size: 18px;
          margin-bottom: 25px;
          line-height: 1.6;
          color: #7D6E63;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .campfire-modal-buttons {
          display: flex;
          justify-content: space-between;
          margin-top: 20px;
        }

        .campfire-modal-button {
          background-color: #8D6E63;
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 18px;
          font-weight: normal;
          transition: all 0.3s ease;
          flex: 1;
          margin: 0 5px;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .campfire-modal-button:hover {
          background-color: #6D4C41;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .campfire-modal-button:active {
          transform: translateY(0);
        }
      `;

      document.head.appendChild(style);

// æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      const confirmCampfire = document.getElementById('confirmCampfire');
      const cancelCampfire = document.getElementById('cancelCampfire');

      if (confirmCampfire) {
        confirmCampfire.addEventListener('click', () => {
          // è°ƒç”¨çƒ¤ç«å‡½æ•°æ‰§è¡Œæ­£ç¡®çš„çƒ¤ç«é€»è¾‘
          warmByFire();
          modal.classList.remove('active');
          setTimeout(() => modal.remove(), 300);
        });
      }

      if (cancelCampfire) {
        cancelCampfire.addEventListener('click', () => {
          modal.classList.remove('active');
          setTimeout(() => modal.remove(), 300);
        });
      }

// ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
          setTimeout(() => modal.remove(), 300);
        }
      });
    }

// å¸ä¸‹è£…å¤‡
    function unequipItem(slotType, resourceId) {
      const resource = gameData.resources[resourceId];

if (resource) {
        // ç§»é™¤è£…å¤‡æ•ˆæœ
        applyEquipmentEffect(resourceId, 'unequip');

// ç§»é™¤è£…å¤‡çŠ¶æ€
        resource.equipped = false;

// æ›´æ–°è£…å¤‡æ§½
        updateEquipmentSlot(slotType);

// æ›´æ–°èƒŒåŒ…
        updateResourceCard(resourceId);

// æ›´æ–°UI
        updateGameData();

// æ˜¾ç¤ºé€šçŸ¥
        showNotification('å¸ä¸‹è£…å¤‡', `æˆåŠŸå¸ä¸‹äº†${resource.name}`);
      }
    }

// åº”ç”¨è£…å¤‡æ•ˆæœ
    function applyEquipmentEffect(resourceId, action) {
      const resource = gameData.resources[resourceId];

// æ ¹æ®è£…å¤‡ç±»å‹åº”ç”¨ä¸åŒæ•ˆæœ
      switch(resourceId) {
        case 'simple_clothes': // ç ´è¡£æœ
          if (action === 'equip') {
            gameData.status.cold = Math.min(50, gameData.status.cold + 0.2); // ä½“æ¸©å¢åŠ ï¼ˆä¿æš–ï¼‰
            showNotification('è£…å¤‡æ•ˆæœ', 'ç ´è¡£æœæä¾›äº†åŸºæœ¬çš„ä¿æš–ï¼Œä½“æ¸©ä¸Šå‡0.2â„ƒ');
          } else {
            gameData.status.cold = Math.max(30, gameData.status.cold - 0.2); // ä½“æ¸©å‡å°‘ï¼ˆå¤±å»ä¿æš–ï¼‰
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç ´è¡£æœï¼Œä½“æ¸©ä¸‹é™0.2â„ƒ');
          }
          break;

case 'black_cloak': // é»‘è‰²æ–—ç¯·
          if (action === 'equip') {
            gameData.status.spirit += 15; // æé«˜ç²¾ç¥çŠ¶æ€
            // è§£é”é»‘å¸‚
            const blackMarket = gameData.locations.find(loc => loc.id === 'black_market');
            if (blackMarket) {
              blackMarket.available = true;
              showNotification('è£…å¤‡æ•ˆæœ', 'é»‘è‰²æ–—ç¯·è®©ä½ è·å¾—äº†è¿›å…¥é»‘å¸‚çš„èµ„æ ¼ï¼');
            }
            showNotification('è£…å¤‡æ•ˆæœ', 'é»‘è‰²æ–—ç¯·æå‡äº†ä½ çš„ç²¾ç¥çŠ¶æ€ï¼Œç²¾ç¥å¢åŠ 15ç‚¹');
          } else {
            gameData.status.spirit -= 15; // ç§»é™¤ç²¾ç¥æå‡
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–é»‘è‰²æ–—ç¯·
            if (gameData.resources.black_cloak.amount === 0) {
              // é”å®šé»‘å¸‚
              const blackMarket = gameData.locations.find(loc => loc.id === 'black_market');
              if (blackMarket) {
                blackMarket.available = false;
                showNotification('è£…å¤‡æ•ˆæœ', 'æ²¡æœ‰é»‘è‰²æ–—ç¯·ï¼Œæ— æ³•è¿›å…¥é»‘å¸‚');
              }
            }
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†é»‘è‰²æ–—ç¯·ï¼Œç²¾ç¥å‡å°‘15ç‚¹');
          }
          break;

case 'crutch': // æ‹æ–
          if (action === 'equip') {
            gameData.status.strength += 5; // æé«˜æ­¦åŠ›å€¼
            gameData.status.reputation += 10; // æé«˜å£°æœ›
            showNotification('è£…å¤‡æ•ˆæœ', 'æ‹æ–å¸®åŠ©ä½ è¡Œèµ°ï¼Œæ­¦åŠ›å¢åŠ 5ç‚¹ï¼Œå£°æœ›å¢åŠ 10ç‚¹');
          } else {
            gameData.status.strength -= 5; // ç§»é™¤æ­¦åŠ›æå‡
            gameData.status.reputation -= 10; // ç§»é™¤å£°æœ›æå‡
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†æ‹æ–ï¼Œæ­¦åŠ›å‡å°‘5ç‚¹ï¼Œå£°æœ›å‡å°‘10ç‚¹');
          }
          break;

case 'fine_clothes': // ç²¾ç¾åæœ
          if (action === 'equip') {
            gameData.status.reputation += 20; // å¤§å¹…æé«˜å£°æœ›
            gameData.status.cold = Math.min(50, gameData.status.cold + 0.3); // ä½“æ¸©å¢åŠ ï¼ˆä¿æš–ï¼‰
            showNotification('è£…å¤‡æ•ˆæœ', 'ç²¾ç¾åæœè®©ä½ çœ‹èµ·æ¥ä½“é¢ï¼Œå£°æœ›å¢åŠ 20ç‚¹ï¼Œä½“æ¸©ä¸Šå‡0.3â„ƒ');
          } else {
            gameData.status.reputation -= 20; // ç§»é™¤å£°æœ›æå‡
            gameData.status.cold = Math.max(30, gameData.status.cold - 0.3); // ä½“æ¸©å‡å°‘ï¼ˆå¤±å»ä¿æš–ï¼‰
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç²¾ç¾åæœï¼Œå£°æœ›å‡å°‘20ç‚¹ï¼Œä½“æ¸©ä¸‹é™0.3â„ƒ');
          }
          break;

case 'silk_shoes': // ç¼é‹
          if (action === 'equip') {
            gameData.status.health += 10; // æé«˜å¥åº·åº¦
            gameData.status.cold = Math.min(50, gameData.status.cold + 0.1); // ä½“æ¸©å¢åŠ ï¼ˆä¿æš–ï¼‰
            showNotification('è£…å¤‡æ•ˆæœ', 'ç¼é‹èˆ’é€‚ä¿æš–ï¼Œå¥åº·å¢åŠ 10ç‚¹ï¼Œä½“æ¸©ä¸Šå‡0.1â„ƒ');
          } else {
            gameData.status.health -= 10; // ç§»é™¤å¥åº·æå‡
            checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            gameData.status.cold = Math.max(34, gameData.status.cold - 0.1); // ä½“æ¸©å‡å°‘ï¼ˆå¤±å»ä¿æš–ï¼‰
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç¼é‹ï¼Œå¥åº·å‡å°‘10ç‚¹ï¼Œä½“æ¸©ä¸‹é™0.1â„ƒ');
          }
          break;

case 'dog_beating_stick': // æ‰“ç‹—æ£’æ³•
          if (action === 'equip') {
            gameData.status.reputation += 30; // å¤§å¹…æé«˜å£°æœ›
            gameData.status.health += 15; // æé«˜å¥åº·åº¦
            showNotification('è£…å¤‡æ•ˆæœ', 'æ‰“ç‹—æ£’æ³•è®©ä½ æˆä¸ºä¸å¸®ä¼ äººï¼Œå£°æœ›å¢åŠ 30ç‚¹ï¼Œå¥åº·å¢åŠ 15ç‚¹');
          } else {
            gameData.status.reputation -= 30; // ç§»é™¤å£°æœ›æå‡
            gameData.status.health -= 15; // ç§»é™¤å¥åº·æå‡
            checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†æ‰“ç‹—æ£’æ³•ï¼Œå£°æœ›å‡å°‘30ç‚¹ï¼Œå¥åº·å‡å°‘15ç‚¹');
          }
          break;

case 'bamboo_bow': // ç«¹å¼“
          if (action === 'equip') {
            // åˆå§‹åŒ–æ”»å‡»å’Œå‘½ä¸­ç‡å±æ€§ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (gameData.status.attack === undefined) gameData.status.attack = 0;
            if (gameData.status.accuracy === undefined) gameData.status.accuracy = 0;

gameData.status.attack += 10; // æ”»å‡»+10
            gameData.status.accuracy += 10; // å‘½ä¸­ç‡+10%
            showNotification('è£…å¤‡æ•ˆæœ', 'ç«¹å¼“å·²è£…å¤‡ï¼Œæ”»å‡»å¢åŠ 10ç‚¹ï¼Œå‘½ä¸­ç‡å¢åŠ 10%');
          } else {
            gameData.status.attack -= 10; // ç§»é™¤æ”»å‡»æå‡
            gameData.status.accuracy -= 10; // ç§»é™¤å‘½ä¸­ç‡æå‡
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç«¹å¼“ï¼Œæ”»å‡»å‡å°‘10ç‚¹ï¼Œå‘½ä¸­ç‡å‡å°‘10%');
          }
          break;
      }

// ç¡®ä¿çŠ¶æ€å€¼åœ¨åˆç†èŒƒå›´å†…
      for (const stat of ['cold', 'spirit', 'health', 'reputation', 'attack', 'accuracy']) {
        if (gameData.status[stat] !== undefined) {
          gameData.status[stat] = Math.max(0, Math.min(100, gameData.status[stat]));
        }
      }

// æ›´æ–°UI
      updateGameData();
      renderLocations(); // æ›´æ–°åœ°ç‚¹æ˜¾ç¤º
    }

    // ä¿å­˜æ¸¸æˆè¿›åº¦åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆsaveæ–‡ä»¶å¤¹ï¼‰
    function saveGameProgress() {
      try {
        // åˆ›å»ºä¸€ä¸ªæ·±æ‹·è´ä»¥é¿å…å­˜å‚¨å¾ªç¯å¼•ç”¨
        const gameDataToSave = JSON.parse(JSON.stringify(gameData));

// ç§»é™¤ä¸éœ€è¦ä¿å­˜çš„ä¸´æ—¶æ•°æ®
        delete gameDataToSave.uiState;
        delete gameDataToSave.tempData;

// ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
        const currentDate = new Date();
        const timestamp = `${currentDate.getFullYear()}${String(currentDate.getMonth() + 1).padStart(2, '0')}${String(currentDate.getDate()).padStart(2, '0')}_${String(currentDate.getHours()).padStart(2, '0')}${String(currentDate.getMinutes()).padStart(2, '0')}`;
        const fileName = `beggar_save_${timestamp}.json`;

// åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
        localStorage.setItem('beggarSurvivalGameSave', JSON.stringify(gameDataToSave));

// åˆ›å»ºå¯ä¸‹è½½çš„æ–‡ä»¶
        const jsonString = JSON.stringify(gameDataToSave, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

// åˆ›å»ºä¸‹è½½é“¾æ¥
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = fileName;

// è§¦å‘ä¸‹è½½
        document.body.appendChild(downloadLink);
        downloadLink.click();
        if (downloadLink.parentNode === document.body) {
        document.body.removeChild(downloadLink);
      }

// æ¸…ç†URLå¯¹è±¡
        URL.revokeObjectURL(url);

console.log('æ¸¸æˆè¿›åº¦å·²ä¿å­˜');
        showNotification('ä¿å­˜æˆåŠŸ', 'è¯·å°†æ–‡ä»¶ä¿å­˜åˆ°æ¸¸æˆç›®å½•ä¸‹çš„saveæ–‡ä»¶å¤¹ä¸­');

return true;
      } catch (error) {
        console.error('ä¿å­˜æ¸¸æˆè¿›åº¦å¤±è´¥:', error);
        showNotification('ä¿å­˜å¤±è´¥', 'æ— æ³•ä¿å­˜æ¸¸æˆè¿›åº¦ï¼Œè¯·é‡è¯•');
        return false;
      }
    }

// å¤„ç†å¼€å§‹ç•Œé¢çš„æ¸¸æˆåŠ è½½åŠŸèƒ½
    function handleLoadGame() {
      try {
        // å°è¯•ä½¿ç”¨Directory APIç›´æ¥é€‰æ‹©æ–‡ä»¶å¤¹
        if ('showDirectoryPicker' in window) {
          // ç›´æ¥è°ƒç”¨Directory APIé€‰æ‹©é»˜è®¤çš„saveæ–‡ä»¶å¤¹
          handleDirectorySelection('save').catch(error => {
            console.log('æ–‡ä»¶å¤¹é€‰æ‹©å¤±è´¥æˆ–å–æ¶ˆï¼Œåˆ‡æ¢åˆ°æ–‡ä»¶é€‰æ‹©æ¨¡å¼:', error);
            // é™çº§åˆ°ä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
            showTraditionalFilePicker();
          });
        } else {
          // ä¸æ”¯æŒDirectory APIï¼Œä½¿ç”¨ä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
          showTraditionalFilePicker();
        }
      } catch (error) {
        console.error('åŠ è½½æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
        showNotification('æ“ä½œå¤±è´¥', 'æ— æ³•åˆå§‹åŒ–æ¸¸æˆåŠ è½½åŠŸèƒ½');
        // ä½œä¸ºæœ€åçš„é™çº§æ–¹æ¡ˆï¼Œæ˜¾ç¤ºä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
        setTimeout(() => {
          showTraditionalFilePicker();
        }, 1000);
      }
    }

// ä½¿ç”¨Directory APIå¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©
    async function handleDirectorySelection(defaultFolderName = null) {
      try {
        // è¯·æ±‚è®¿é—®æ–‡ä»¶å¤¹æƒé™
        const options = {
          mode: 'read'
        };

// å¦‚æœæŒ‡å®šäº†é»˜è®¤æ–‡ä»¶å¤¹åç§°ï¼Œå°è¯•æ‰“å¼€è¯¥æ–‡ä»¶å¤¹
        if (defaultFolderName) {
          options.startIn = 'documents';
          options.suggestedName = defaultFolderName;
        } else {
          options.startIn = 'documents';
        }

const directoryHandle = await window.showDirectoryPicker(options);

console.log('å·²é€‰æ‹©æ–‡ä»¶å¤¹:', directoryHandle.name);
        showNotification('æ‰«æä¸­', 'æ­£åœ¨æ‰«ææ–‡ä»¶å¤¹ä¸­çš„å­˜æ¡£æ–‡ä»¶...');

// è·å–æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰JSONæ–‡ä»¶
        const saveFiles = [];
        for await (const [name, handle] of directoryHandle.entries()) {
          if (handle.kind === 'file' && name.endsWith('.json')) {
            saveFiles.push({ name, handle });
          }
        }

// æŒ‰æ–‡ä»¶åæ’åºï¼ˆå‡è®¾æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼Œæœ€æ–°çš„åº”è¯¥åœ¨æœ€åï¼‰
        saveFiles.sort((a, b) => a.name.localeCompare(b.name));

if (saveFiles.length === 0) {
          showNotification('æœªæ‰¾åˆ°å­˜æ¡£', 'åœ¨é€‰æ‹©çš„æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°JSONå­˜æ¡£æ–‡ä»¶');
          return;
        }

// æ„å»ºå­˜æ¡£é€‰æ‹©èœå•çš„HTML
        let saveOptions = '';
        saveFiles.forEach((file, index) => {
          saveOptions += `<option value="${index}">${file.name}</option>`;
        });

// åˆ›å»ºä¸´æ—¶è¡¨å•è¿›è¡Œå­˜æ¡£é€‰æ‹©
        const selectionHTML = `
          <div style="padding: 15px;">
            <h3>é€‰æ‹©å­˜æ¡£æ–‡ä»¶</h3>
            <p>åœ¨ ${directoryHandle.name} æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ° ${saveFiles.length} ä¸ªå­˜æ¡£æ–‡ä»¶ï¼š</p>
            <select id="saveFileSelect" style="width: 100%; padding: 10px; margin: 10px 0;">
              ${saveOptions}
            </select>
            <p style="font-size: 0.9em; color: gray;">æç¤ºï¼šå¦‚æœéœ€è¦æµè§ˆå…¶ä»–æ–‡ä»¶å¤¹ï¼Œè¯·ç‚¹å‡»å–æ¶ˆåé‡æ–°å°è¯•</p>
          </div>
        `;

// ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†é€‰æ‹©å­˜æ¡£
        const userChoice = await showCustomConfirm('é€‰æ‹©å­˜æ¡£', selectionHTML);

if (userChoice.confirmed && userChoice.selectedIndex >= 0) {
          const selectedIndex = userChoice.selectedIndex;
          const selectedFile = saveFiles[selectedIndex];

// è·å–æ–‡ä»¶å¯¹è±¡å¹¶ä¼ é€’ç»™processSaveFile
          const file = await selectedFile.handle.getFile();

// å¤„ç†é€‰ä¸­çš„å­˜æ¡£æ–‡ä»¶
          processSaveFile(file);

console.log('å·²æˆåŠŸåŠ è½½å­˜æ¡£:', selectedFile.name);
        }
      } catch (error) {
        // å¦‚æœæ˜¯ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œä¸è®°å½•ä¸ºé”™è¯¯
        if (error.name === 'AbortError') {
          console.log('ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶å¤¹é€‰æ‹©');
          showNotification('æ“ä½œå–æ¶ˆ', 'æ‚¨å·²å–æ¶ˆæ–‡ä»¶å¤¹é€‰æ‹©');
          return; // é™é»˜è¿”å›ï¼Œä¸è§¦å‘é™çº§
        }
        // å¯¹äºå…¶ä»–é”™è¯¯ï¼Œè®°å½•é”™è¯¯æ—¥å¿—
        console.error('å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©æ—¶å‡ºé”™:', error);
        // æ˜¾ç¤ºé€šçŸ¥å¹¶é‡æ–°æŠ›å‡ºä»¥è§¦å‘é™çº§
        showNotification('æ“ä½œå¤±è´¥', 'æ–‡ä»¶å¤¹é€‰æ‹©è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
        throw error;
      }
    }

// æ˜¾ç¤ºä¼ ç»Ÿçš„æ–‡ä»¶é€‰æ‹©å™¨
    function showTraditionalFilePicker() {
      // é¦–å…ˆæ˜¾ç¤ºæŒ‡å¼•ä¿¡æ¯ï¼Œå¸®åŠ©ç”¨æˆ·æ‰¾åˆ°saveæ–‡ä»¶å¤¹
      const saveFolderPath = 'beggar_survival_game\\save';
      const guidanceMessage = `è¯·åœ¨æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ä¸­å¯¼èˆªåˆ°ä»¥ä¸‹è·¯å¾„é€‰æ‹©å­˜æ¡£æ–‡ä»¶ï¼š

${saveFolderPath}

æ­¥éª¤ï¼š
1. åœ¨æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ä¸­å¯¼èˆªåˆ°æ¸¸æˆæ‰€åœ¨ç›®å½•
2. æ‰“å¼€"save"æ–‡ä»¶å¤¹
3. é€‰æ‹©ä¸€ä¸ª.jsonå­˜æ¡£æ–‡ä»¶

æç¤ºï¼šå¦‚æœä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½ã€‚`;

// æ˜¾ç¤ºæŒ‡å¼•ä¿¡æ¯
      showNotification('æ“ä½œæŒ‡å¼•', guidanceMessage, true, false);

// åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      // é™åˆ¶åªèƒ½é€‰æ‹©JSONæ–‡ä»¶
      fileInput.accept = '.json';
      // æ·»åŠ multipleå±æ€§ï¼Œå…è®¸é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼ˆè™½ç„¶æˆ‘ä»¬ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªï¼‰
      fileInput.multiple = false;

// æ·»åŠ æ–‡ä»¶é€‰æ‹©åçš„å¤„ç†é€»è¾‘
      fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          processSaveFile(file);
        }
      };

// è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨
      fileInput.click();
    }

// å¤„ç†é€‰ä¸­çš„å­˜æ¡£æ–‡ä»¶
    function processSaveFile(file) {
      console.log('é€‰æ‹©çš„æ–‡ä»¶:', file.name);
      // æ˜¾ç¤ºåŠ è½½ä¸­çš„æç¤º
      showNotification('åŠ è½½ä¸­', `æ­£åœ¨è¯»å–å­˜æ¡£æ–‡ä»¶: ${file.name}...`);

// è¯»å–æ–‡ä»¶å†…å®¹
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          // è§£æJSONå†…å®¹
          const loadedGameData = JSON.parse(e.target.result);

// éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
          if (!loadedGameData.day || !loadedGameData.resources || !loadedGameData.status) {
            throw new Error('å­˜æ¡£æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œç¼ºå°‘å¿…è¦å­—æ®µ');
          }

// æ¸…ç©ºå½“å‰gameDataå¹¶åŠ è½½ä¿å­˜çš„æ•°æ®ï¼ˆä¿ç•™uiStateå’ŒtempDataï¼‰
          Object.keys(gameData).forEach(key => {
            if (key !== 'uiState' && key !== 'tempData') {
              delete gameData[key];
            }
          });

// åˆå¹¶åŠ è½½çš„æ•°æ®åˆ°gameData
          Object.assign(gameData, loadedGameData);

// åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
          localStorage.setItem('beggarSurvivalGameSave', JSON.stringify(gameData));

// æ˜¾ç¤ºåŠ è½½æˆåŠŸæç¤º
          showNotification('åŠ è½½æˆåŠŸ', `æˆåŠŸåŠ è½½å­˜æ¡£: ${file.name}`);

// åˆ‡æ¢åˆ°æ¸¸æˆç•Œé¢
          switchToGameView();

// æ ¹æ®å½“å‰å¤©æ•°é‡æ–°è®¡ç®—å­£èŠ‚ï¼ˆä¿®å¤å­˜æ¡£ä¸­å­£èŠ‚å€¼å¯èƒ½ä¸æ­£ç¡®çš„é—®é¢˜ï¼‰
          gameData.season = calculateSeason(gameData.day);

// ç¡®ä¿ç¯ç«èµ„æºæœ‰æ­£ç¡®çš„ç‡ƒæ–™å±æ€§
          if (gameData.resources.fire && gameData.resources.fire.fuel === undefined) {
            gameData.resources.fire.fuel = 100;
          }

          
          // æ›´æ–°UIä»¥åæ˜ åŠ è½½çš„æ¸¸æˆçŠ¶æ€
          updateGameData();
          renderResources();
          renderLocations();
          renderActions();
          renderEquipmentSlots();
          updateSkillDisplay();
          updateWeatherEffects();

} catch (parseError) {
          console.error('è§£æå­˜æ¡£æ–‡ä»¶å¤±è´¥:', parseError);
          showNotification('åŠ è½½å¤±è´¥', 'æ— æ³•è§£æå­˜æ¡£æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
        }
      };

reader.onerror = function() {
        console.error('è¯»å–æ–‡ä»¶å¤±è´¥');
        showNotification('è¯»å–å¤±è´¥', 'æ— æ³•è¯»å–å­˜æ¡£æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå');
      };

reader.readAsText(file);
    }

// åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾å‡½æ•°
    function switchToGameView() {
      try {
        console.log('åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾');
        // å¦‚æœå¼€å§‹å±å¹•å­˜åœ¨ï¼Œéšè—å®ƒ
        if (elements.startScreen) {
          elements.startScreen.style.opacity = '0';
          elements.startScreen.style.display = 'none';
        }

// æ˜¾ç¤ºæ¸¸æˆå®¹å™¨
        if (elements.gameContainer) {
          elements.gameContainer.style.display = 'block';
        }

console.log('å·²åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾');
      } catch (error) {
        console.error('åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾æ—¶å‡ºé”™:', error);
        showNotification('åˆ‡æ¢å¤±è´¥', 'æ— æ³•åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾');
      }
    }

    // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
    function showCustomConfirm(title, contentHTML) {
      return new Promise((resolve) => {
        // åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #fff;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.2);
          z-index: 10000;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', Arial, sans-serif;
        `;

// åˆ›å»ºæ ‡é¢˜
        const dialogTitle = document.createElement('h2');
        dialogTitle.textContent = title;
        dialogTitle.style.cssText = 'margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;';

// åˆ›å»ºå†…å®¹å®¹å™¨
        const contentContainer = document.createElement('div');
        contentContainer.innerHTML = contentHTML;

// åˆ›å»ºæŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'margin-top: 20px; text-align: right;';

// åˆ›å»ºå–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.style.cssText = `
          padding: 10px 20px;
          margin-right: 10px;
          background-color: #f0f0f0;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 16px;
        `;

// åˆ›å»ºç¡®è®¤æŒ‰é’®
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®è®¤';
        confirmButton.style.cssText = `
          padding: 10px 20px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 16px;
        `;

// åˆ›å»ºèƒŒæ™¯é®ç½©
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 9999;
        `;

// æ·»åŠ äº‹ä»¶ç›‘å¬
        cancelButton.addEventListener('click', () => {
          if (dialog.parentNode === document.body) {
        document.body.removeChild(dialog);
      }
      if (overlay.parentNode === document.body) {
        document.body.removeChild(overlay);
      }
          resolve({ confirmed: false, selectedIndex: -1 });
        });

confirmButton.addEventListener('click', () => {
          const selectElement = document.getElementById('saveFileSelect');
          const selectedIndex = selectElement ? parseInt(selectElement.value, 10) : -1;
          if (dialog.parentNode === document.body) {
        document.body.removeChild(dialog);
      }
      if (overlay.parentNode === document.body) {
        document.body.removeChild(overlay);
      }
          resolve({ confirmed: true, selectedIndex });
        });

// æ·»åŠ é”®ç›˜äº‹ä»¶
        dialog.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            cancelButton.click();
          } else if (event.key === 'Enter') {
            confirmButton.click();
          }
        });

// ç»„è£…å¯¹è¯æ¡†
        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(confirmButton);
        dialog.appendChild(dialogTitle);
        dialog.appendChild(contentContainer);
        dialog.appendChild(buttonContainer);

// æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);

// èšç„¦åˆ°ç¡®è®¤æŒ‰é’®
        confirmButton.focus();
      });
    }

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆè¿›åº¦
    function loadGameProgress() {
      try {
        const savedGameData = localStorage.getItem('beggarSurvivalGameSave');

if (!savedGameData) {
          console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆè¿›åº¦');
          showNotification('æœªæ‰¾åˆ°å­˜æ¡£', 'æ²¡æœ‰æ£€æµ‹åˆ°å·²ä¿å­˜çš„æ¸¸æˆè¿›åº¦');
          return false;
        }

const parsedData = JSON.parse(savedGameData);

// éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
        if (!parsedData.day || !parsedData.resources || !parsedData.status) {
          throw new Error('ä¿å­˜çš„æ•°æ®æ ¼å¼æ— æ•ˆ');
        }

        // åˆ›å»ºå½“å‰èµ„æºå®šä¹‰çš„æ·±æ‹·è´ï¼Œä»¥ä¿ç•™æ–°æ·»åŠ çš„ç‰©å“
        const masterResources = JSON.parse(JSON.stringify(gameData.resources));
        const savedResources = parsedData.resources;

        // ä½¿ç”¨å­˜æ¡£ä¸­çš„æ•°é‡æ›´æ–°ä¸»èµ„æºåˆ—è¡¨ï¼ŒåŒæ—¶ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„åç§°å’Œå›¾ç‰‡
        for (const resourceId in masterResources) {
          if (savedResources && savedResources.hasOwnProperty(resourceId)) {
            masterResources[resourceId].amount = savedResources[resourceId].amount;
            // ç¡®ä¿ä½¿ç”¨å½“å‰ä»£ç ä¸­å®šä¹‰çš„åç§°å’Œå›¾ç‰‡ï¼ˆä¿®å¤"boom"é—®é¢˜ï¼‰
            // ä¸ä»å­˜æ¡£ä¸­è¦†ç›–nameå’Œimageç­‰å±æ€§
          }
        }

        // æ¸…é™¤è¿‡æ—¶çš„èµ„æºï¼ˆä»£ç ä¸­å·²åˆ é™¤çš„èµ„æºï¼‰
        const currentResourceIds = Object.keys(gameData.resources);
        const savedResourceIds = Object.keys(parsedData.resources || {});
        savedResourceIds.forEach(savedId => {
          if (!currentResourceIds.includes(savedId)) {
            delete parsedData.resources[savedId];
          }
        });

        // ç”¨å­˜æ¡£æ•°æ®è¦†ç›–æ•´ä¸ªgameData
        Object.keys(gameData).forEach(key => {
          if (key !== 'uiState' && key !== 'tempData') {
            delete gameData[key];
          }
        });
        Object.assign(gameData, parsedData);

        // å°†åˆå¹¶åçš„ã€æœ€æ–°çš„èµ„æºåˆ—è¡¨é‡æ–°èµ‹å€¼ç»™gameData
        gameData.resources = masterResources;
        
        // ç¡®ä¿é©¬å©æ•°æ®å­˜åœ¨
        if (!gameData.stableData) {
          gameData.stableData = {
            stalls: Array(4).fill(null).map(() => ({
              horse: null,
              health: 100,
              satiety: 100,
              cleanliness: 0,
              startDay: null,
              lastFedDay: null,
              lastCleanedDay: null
            })),
            horses: {
              native_horse: { 
                name: 'æœ¬åœŸé©¬', 
                image: 'UI/æœ¬åœŸé©¬.jpg', 
                maxHealth: 100,
                dailyHealthLoss: 2,
                dailySatietyLoss: 10,
                dailyCleanlinessIncrease: 5,
                produceInterval: 7
              },
              mongolian_horse: { 
                name: 'è’™å¤é©¬', 
                image: 'UI/è’™å¤é©¬.jpg', 
                maxHealth: 120,
                dailyHealthLoss: 2,
                dailySatietyLoss: 8,
                dailyCleanlinessIncrease: 4,
                produceInterval: 6
              },
              hequ_horse: { 
                name: 'æ²³æ›²é©¬', 
                image: 'UI/æ²³æ›²é©¬.jpg', 
                maxHealth: 140,
                dailyHealthLoss: 1,
                dailySatietyLoss: 12,
                dailyCleanlinessIncrease: 6,
                produceInterval: 8
              },
              ferghana_horse: { 
                name: 'æ±—è¡€å®é©¬', 
                image: 'UI/æ±—è¡€å®é©¬.jpg', 
                maxHealth: 150,
                dailyHealthLoss: 1,
                dailySatietyLoss: 9,
                dailyCleanlinessIncrease: 5,
                produceInterval: 5
              },
              super_ferghana_horse: { 
                name: 'æå“æ±—è¡€å®é©¬', 
                image: 'UI/æå“æ±—è¡€å®é©¬.jpg', 
                maxHealth: 180,
                dailyHealthLoss: 0,
                dailySatietyLoss: 7,
                dailyCleanlinessIncrease: 4,
                produceInterval: 4
              }
            }
          };
        }

        // æ•°æ®è¿ç§»ï¼šå°†æ—§æ ¼å¼çš„ groundResources æ•°ç»„è½¬æ¢ä¸ºæ–°æ ¼å¼çš„å¯¹è±¡
        if (Array.isArray(gameData.groundResources)) {
          const oldGroundResources = gameData.groundResources;
          gameData.groundResources = {};

          // è·å–å½“å‰åœºæ™¯
          const currentLocation = gameData.locations.find(loc => loc.currentLocation);
          if (currentLocation) {
            // å°†æ—§æ•°æ®æ”¾å…¥å½“å‰åœºæ™¯
            gameData.groundResources[currentLocation.id] = oldGroundResources;
          }

          console.log('åœ°é¢æ æ•°æ®å·²ä»æ—§æ ¼å¼è¿ç§»åˆ°æ–°æ ¼å¼');
        }

        console.log('æ¸¸æˆè¿›åº¦å·²åŠ è½½');
        showNotification('åŠ è½½æˆåŠŸ', 'æ¸¸æˆè¿›åº¦å·²æˆåŠŸåŠ è½½');

// æ ¹æ®å½“å‰å¤©æ•°é‡æ–°è®¡ç®—å­£èŠ‚ï¼ˆä¿®å¤å­˜æ¡£ä¸­å­£èŠ‚å€¼å¯èƒ½ä¸æ­£ç¡®çš„é—®é¢˜ï¼‰
        gameData.season = calculateSeason(gameData.day);

// æ›´æ–°UIä»¥åæ˜ åŠ è½½çš„æ¸¸æˆçŠ¶æ€
        updateGameData();
        renderResources();
        renderLocations();
        renderActions();
        renderGroundResources();
        renderEquipmentSlots();

return true;
      } catch (error) {
        console.error('åŠ è½½æ¸¸æˆè¿›åº¦å¤±è´¥:', error);
        showNotification('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½æ¸¸æˆè¿›åº¦ï¼Œå­˜æ¡£å¯èƒ½å·²æŸå');
        return false;
      }
    }

    // æ¸…é™¤æ¸¸æˆå­˜æ¡£ï¼ˆç”¨äºä¿®å¤æ—§æ•°æ®é—®é¢˜ï¼‰
    function clearSavedGame() {
      try {
        localStorage.removeItem('beggarSurvivalGameSave');
        localStorage.removeItem('pinnedResources');
        localStorage.removeItem('inventoryOrder');
        showNotification('å­˜æ¡£å·²æ¸…é™¤', 'å·²æ¸…é™¤æ‰€æœ‰æ¸¸æˆå­˜æ¡£ï¼Œåˆ·æ–°é¡µé¢åç”Ÿæ•ˆ');
      } catch (error) {
        console.error('æ¸…é™¤å­˜æ¡£æ—¶å‡ºé”™:', error);
        showNotification('æ¸…é™¤å¤±è´¥', 'æ¸…é™¤å­˜æ¡£æ—¶å‡ºé”™');
      }
      
      // æ›´æ–°éŸ³æ•ˆç³»ç»Ÿ
      updateWeatherSoundEffects();
      updateTimeSoundEffects();
      updateSceneSoundEffects();
      updateBonfireSoundEffect();
    }

// æ›´æ–°æ¸¸æˆæ•°æ®
    function updateGameData() {
      // ç¡®ä¿gameDataå’Œç›¸å…³å±æ€§å­˜åœ¨
      if (!gameData || !gameData.status || !gameData.stats) {
        console.log('updateGameData: gameDataæˆ–å…¶å­å±æ€§ä¸å­˜åœ¨');
        return;
      }

      // æ›´æ–°å¤©æ•°ï¼ˆå¸¦ç©ºå€¼æ£€æŸ¥ï¼‰
      if (elements.dayNumber && elements.dayNumber.textContent !== undefined) {
        elements.dayNumber.textContent = gameData.day;
      } else {
        console.log('updateGameData: dayNumberå…ƒç´ ä¸å­˜åœ¨');
      }

// æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼ˆæ—¶è¾° + å…·ä½“æ—¶é—´ï¼‰
      const shichenInfo = getShichenByHour(gameData.currentHour);
      const timeStr = `${String(gameData.currentHour).padStart(2, '0')}:${String(gameData.currentMinute).padStart(2, '0')}`;
      if (elements.timeOfDay && elements.timeOfDay.textContent !== undefined) {
        elements.timeOfDay.textContent = `${shichenInfo.name} ${timeStr}`;
      } else {
        console.log('updateGameData: timeOfDayå…ƒç´ ä¸å­˜åœ¨');
      }

      // æ›´æ–°çŠ¶æ€ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼ˆå¸¦ç©ºå€¼æ£€æŸ¥ï¼‰
      const statusUpdateMap = [
        { element: elements.hungerPercentage, value: `${gameData.status.hunger}%`, name: 'hungerPercentage' },
        { element: elements.coldPercentage, value: `${gameData.status.cold.toFixed(1)}â„ƒ`, name: 'coldPercentage' },
        { element: elements.healthPercentage, value: `${gameData.status.health}%`, name: 'healthPercentage' },
        { element: elements.bloodPercentage, value: `${gameData.status.blood}%`, name: 'bloodPercentage' },
        { element: elements.spiritPercentage, value: `${gameData.status.spirit}%`, name: 'spiritPercentage' },
        { element: elements.reputationPercentage, value: `${gameData.status.reputation}%`, name: 'reputationPercentage' },
        { element: elements.thirstPercentage, value: `${gameData.status.thirst}%`, name: 'thirstPercentage' },
        { element: elements.digestionPercentage, value: `${gameData.status.digestion}%`, name: 'digestionPercentage' }
      ];

      statusUpdateMap.forEach(({ element, value, name }) => {
        if (element && element.textContent !== undefined) {
          element.textContent = value;
        } else {
          console.log(`updateGameData: ${name}å…ƒç´ ä¸å­˜åœ¨`);
        }
      });

// æ›´æ–°å­£èŠ‚ï¼ˆå¸¦ç©ºå€¼æ£€æŸ¥ï¼‰
      const seasons = {
        spring: { icon: 'ğŸŒ±', name: 'æ˜¥å­£' },
        summer: { icon: 'â˜€ï¸', name: 'å¤å­£' },
        autumn: { icon: 'ğŸ‚', name: 'ç§‹å­£' },
        winter: { icon: 'â„ï¸', name: 'å†¬å­£' }
      };

      const currentSeason = seasons[gameData.season] || { icon: 'â“', name: 'æœªçŸ¥å­£èŠ‚' };
      
      if (elements.seasonIcon && elements.seasonIcon.textContent !== undefined) {
        elements.seasonIcon.textContent = currentSeason.icon;
      } else {
        console.log('updateGameData: seasonIconå…ƒç´ ä¸å­˜åœ¨');
      }
      
      if (elements.seasonName && elements.seasonName.textContent !== undefined) {
        elements.seasonName.textContent = currentSeason.name;
      } else {
        console.log('updateGameData: seasonNameå…ƒç´ ä¸å­˜åœ¨');
      }

// æ›´æ–°å¤©æ°”ï¼ˆå¸¦ç©ºå€¼æ£€æŸ¥ï¼‰
      const weathers = {
        sunny: { icon: 'â˜€ï¸', name: 'æ™´å¤©' },
        rainy: { icon: 'ğŸŒ§ï¸', name: 'é›¨å¤©' },
        snowy: { icon: 'â„ï¸', name: 'é›ªå¤©' }
      };

      const currentWeather = weathers[gameData.weather] || { icon: 'â“', name: 'æœªçŸ¥å¤©æ°”' };
      
      if (elements.weatherIcon && elements.weatherIcon.textContent !== undefined) {
        elements.weatherIcon.textContent = currentWeather.icon;
      } else {
        console.log('updateGameData: weatherIconå…ƒç´ ä¸å­˜åœ¨');
      }
      
      if (elements.weatherName && elements.weatherName.textContent !== undefined) {
        elements.weatherName.textContent = currentWeather.name;
      } else {
        console.log('updateGameData: weatherNameå…ƒç´ ä¸å­˜åœ¨');
      }

      // æ›´æ–°è¿›åº¦æ¡ï¼ˆå¸¦ç©ºå€¼æ£€æŸ¥ï¼‰
      const progressBarUpdateMap = [
        { element: elements.hungerBar, width: `${gameData.status.hunger}%`, name: 'hungerBar', cardName: 'hungerCard' },
        // ä½“æ¸©èŒƒå›´34-42ï¼Œè½¬æ¢ä¸º0-100%è¿›åº¦æ¡å®½åº¦
        { element: elements.coldBar, width: `${((gameData.status.cold - 34) / 8) * 100}%`, name: 'coldBar', cardName: 'coldCard' },
        { element: elements.healthBar, width: `${gameData.status.health}%`, name: 'healthBar', cardName: 'healthCard' },
        { element: elements.bloodBar, width: `${gameData.status.blood}%`, name: 'bloodBar', cardName: 'bloodCard' },
        { element: elements.spiritBar, width: `${gameData.status.spirit}%`, name: 'spiritBar', cardName: 'spiritCard' },
        { element: elements.reputationBar, width: `${gameData.status.reputation}%`, name: 'reputationBar', cardName: 'reputationCard' },
        { element: elements.thirstBar, width: `${gameData.status.thirst}%`, name: 'thirstBar', cardName: 'thirstCard' },
        { element: elements.digestionBar, width: `${gameData.status.digestion}%`, name: 'digestionBar', cardName: 'digestionCard' }
      ];

      progressBarUpdateMap.forEach(({ element, width, name, cardName }) => {
        if (element && element.style && element.style.width !== undefined) {
          element.style.width = width;
          
          // è®¾ç½®è¿›åº¦æ¡é¢œè‰²
          let color = '#48BB78'; // é»˜è®¤ç»¿è‰²
          let isWarning = false; // æ˜¯å¦è§¦å‘è­¦å‘Š
          
          switch(name) {
            case 'coldBar':
              if (gameData.status.cold >= 40) {
                color = '#E53E3E'; // ä½“æ¸©è¿‡é«˜ï¼Œçº¢è‰²è­¦å‘Š
                isWarning = true;
              } else if (gameData.status.cold < 35) {
                color = '#3182CE'; // ä½“æ¸©è¿‡ä½ï¼Œè“è‰²è­¦å‘Š
                isWarning = true;
              } else {
                color = '#48BB78'; // æ­£å¸¸ä½“æ¸©ï¼Œç»¿è‰²
              }
              break;
            case 'hungerBar':
              if (gameData.status.hunger < 50) {
                color = '#E53E3E'; // é¥±é£Ÿåº¦è¿‡ä½ï¼Œçº¢è‰²è­¦å‘Š
                isWarning = true;
              }
              break;
            case 'healthBar':
              if (gameData.status.health < 50) {
                color = '#E53E3E'; // å¥åº·åº¦è¿‡ä½ï¼Œçº¢è‰²è­¦å‘Š
                isWarning = true;
              }
              break;
            case 'bloodBar':
              if (gameData.status.blood < 50) {
                color = '#E53E3E'; // è¡€é‡è¿‡ä½ï¼Œçº¢è‰²è­¦å‘Š
                isWarning = true;
              }
              break;
            case 'spiritBar':
              if (gameData.status.spirit < 50) {
                color = '#E53E3E'; // ç²¾ç¥åº¦è¿‡ä½ï¼Œçº¢è‰²è­¦å‘Š
                isWarning = true;
              }
              break;
            case 'thirstBar':
              if (gameData.status.thirst < 50) {
                color = '#E53E3E'; // æ°´åˆ†è¿‡ä½ï¼Œçº¢è‰²è­¦å‘Š
                isWarning = true;
              } else {
                color = '#48BB78'; // æ°´åˆ†å……è¶³ï¼Œç»¿è‰²
              }
              break;
            case 'digestionBar':
              if (gameData.status.digestion >= 100) {
                color = '#D69E2E'; // æ¶ˆåŒ–å€¼æ»¡ï¼Œæ©™è‰²
                isWarning = true;
              } else {
                color = '#D69E2E'; // æ¶ˆåŒ–å€¼ï¼Œæ©™è‰²
              }
              break;
          }
          
          element.style.backgroundColor = color;
          
          // æ ¹æ®è­¦å‘ŠçŠ¶æ€è®¾ç½®è¾¹æ¡†å’Œé˜´å½±
          if (isWarning) {
            element.style.border = '2px solid #E53E3E';
            element.style.boxShadow = '0 0 10px rgba(229, 62, 62, 0.7)';
            // å¦‚æœæœ‰å¯¹åº”çš„çŠ¶æ€æ¡†ï¼Œä¹Ÿè®¾ç½®è­¦å‘Šæ ·å¼
            if (cardName && elements[cardName]) {
              const cardElement = elements[cardName];
              cardElement.style.border = '2px solid #E53E3E';
              cardElement.style.boxShadow = '0 0 15px rgba(229, 62, 62, 0.8)';
              cardElement.style.animation = 'pulse 1.5s infinite';
            }
          } else {
            element.style.border = 'none';
            element.style.boxShadow = 'none';
            // å¦‚æœæœ‰å¯¹åº”çš„çŠ¶æ€æ¡†ï¼Œä¹Ÿç§»é™¤è­¦å‘Šæ ·å¼
            if (cardName && elements[cardName]) {
              const cardElement = elements[cardName];
              cardElement.style.border = '';
              cardElement.style.boxShadow = '';
              cardElement.style.animation = '';
            }
          }
        } else {
          console.log(`updateGameData: ${name}å…ƒç´ ä¸å­˜åœ¨`);
        }
      });

// æ›´æ–°ç»Ÿè®¡æ•°æ®
      gameData.stats.daysSurvived = gameData.day - 1;
      gameData.stats.maxReputation = Math.max(gameData.stats.maxReputation, gameData.status.reputation);

      // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
      checkGameOver();

      // æ›´æ–°å¿ƒè·³éŸ³æ•ˆï¼ˆç¡®ä¿çŠ¶æ€å˜åŒ–æ—¶åŠæ—¶å“åº”ï¼‰
      updateHeartbeatSoundEffect();

      // æ§åˆ¶æ’æ³„æŒ‰é’®çš„å¯ç”¨/ç¦ç”¨
      if (elements.excreteButton) {
        if (gameData.status.digestion >= 100) {
          elements.excreteButton.disabled = false;
          elements.excreteButton.style.cursor = 'pointer';
          elements.excreteButton.style.background = '#E53E3E';
          elements.excreteButton.style.opacity = '1';
        } else {
          elements.excreteButton.disabled = true;
          elements.excreteButton.style.cursor = 'not-allowed';
          elements.excreteButton.style.background = '#A0AEC0';
          elements.excreteButton.style.opacity = '0.6';
        }
      }
    }

    // æ’æ³„æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
    function handleExcreteButtonClick() {
      if (gameData.status.digestion >= 100) {
        // æ’­æ”¾æ”¾å±éŸ³æ•ˆ
        playSoundEffect('fart', 'éŸ³æ•ˆ/æ”¾å±.wav', { volume: 0.6 });

        // æ¶ˆåŒ–å€¼å½’é›¶
        gameData.status.digestion = 0;

        // è·å¾—è‚¥æ–™å¡ç‰Œ
        if (!gameData.resources.fertilizer) {
          gameData.resources.fertilizer = { name: 'è‚¥æ–™', description: 'å¯ç”¨äºæ–½è‚¥æˆ–äº¤æ˜“', amount: 0, image: 'UI/è‚¥æ–™.jpg', category: 'material' };
        }
        gameData.resources.fertilizer.amount += 1;

        // æ˜¾ç¤ºé€šçŸ¥
        const fertilizerName = gameData.resources.fertilizer.name || 'è‚¥æ–™';
        showNotification('æ’æ³„æˆåŠŸ', `ä½ æ’æ³„äº†åºŸç‰©ï¼Œè·å¾—äº†1ä¸ª${fertilizerName}ï¼`);

        // æ›´æ–°UI
        updateGameData();
        updateResourceCard('fertilizer');
      }

      // æ›´æ–°éŸ³æ•ˆç³»ç»Ÿ
      updateWeatherSoundEffects();
      updateTimeSoundEffects();
    }

// ç”Ÿæˆå¤©æ°”å‡½æ•°
    function generateWeather() {
      // åˆå§‹åŒ–å­£èŠ‚å¤©æ°”ç»Ÿè®¡æ•°æ®
      if (!gameData.seasonWeatherStats) {
        gameData.seasonWeatherStats = {
          spring: { rainyDays: 0, totalDays: 0 },
          summer: { rainyDays: 0, totalDays: 0 },
          autumn: { rainyDays: 0, totalDays: 0 },
          winter: { snowyDays: 0, totalDays: 0 }
        };
      }

      const currentSeason = gameData.season;
      
      // ç¡®ä¿å½“å‰å­£èŠ‚çš„ç»Ÿè®¡æ•°æ®å­˜åœ¨
      if (!gameData.seasonWeatherStats[currentSeason]) {
        gameData.seasonWeatherStats[currentSeason] = { rainyDays: 0, totalDays: 0, snowyDays: 0 };
      }
      
      // å¢åŠ å½“å‰å­£èŠ‚çš„æ€»å¤©æ•°è®¡æ•°
      gameData.seasonWeatherStats[currentSeason].totalDays++;
      
      let weather;

      // æ ¹æ®å­£èŠ‚è®¾ç½®å¤©æ°”æ¦‚ç‡
      switch (currentSeason) {
        case 'spring':
          // æ˜¥å­£ï¼š10%å‡ ç‡ä¸‹é›¨ï¼Œç¡®ä¿è‡³å°‘æœ‰1å¤©é›¨å¤©
          if (gameData.seasonWeatherStats.spring.rainyDays < 1 && gameData.day % 7 === 0) {
            weather = 'rainy'; // æ¯å‘¨å¼ºåˆ¶ä¸‹é›¨ä¸€æ¬¡
          } else {
            weather = Math.random() < 0.1 ? 'rainy' : 'sunny';
          }
          break;
        case 'summer':
          // å¤å­£ï¼š20%å‡ ç‡ä¸‹é›¨ï¼Œç¡®ä¿è‡³å°‘æœ‰2å¤©é›¨å¤©
          if (gameData.seasonWeatherStats.summer.rainyDays < 2 && gameData.day % 5 === 0) {
            weather = 'rainy'; // æ¯5å¤©å¼ºåˆ¶ä¸‹é›¨ä¸€æ¬¡
          } else {
            weather = Math.random() < 0.2 ? 'rainy' : 'sunny';
          }
          break;
        case 'autumn':
          // ç§‹å­£ï¼š15%å‡ ç‡ä¸‹é›¨ï¼Œç¡®ä¿è‡³å°‘æœ‰1å¤©é›¨å¤©
          if (gameData.seasonWeatherStats.autumn.rainyDays < 1 && gameData.day % 6 === 0) {
            weather = 'rainy'; // æ¯6å¤©å¼ºåˆ¶ä¸‹é›¨ä¸€æ¬¡
          } else {
            weather = Math.random() < 0.15 ? 'rainy' : 'sunny';
          }
          break;
        case 'winter':
          // å†¬å­£ï¼š30%å‡ ç‡ä¸‹é›ªï¼Œç¡®ä¿è‡³å°‘æœ‰2å¤©é›ªå¤©
          if (gameData.seasonWeatherStats.winter.snowyDays < 2 && gameData.day % 4 === 0) {
            weather = 'snowy'; // æ¯4å¤©å¼ºåˆ¶ä¸‹é›ªä¸€æ¬¡
          } else {
            weather = Math.random() < 0.3 ? 'snowy' : 'sunny';
          }
          break;
        default:
          weather = 'sunny';
      }

      // æ›´æ–°å¤©æ°”ç»Ÿè®¡
      if (weather === 'rainy') {
        gameData.seasonWeatherStats[currentSeason].rainyDays++;
      } else if (weather === 'snowy') {
        gameData.seasonWeatherStats[currentSeason].snowyDays++;
      }

      // è®¾ç½®å¤©æ°”
      gameData.weather = weather;
      applyWeatherEffects();
      updateWeatherEffects(); // æ›´æ–°å¤©æ°”åŠ¨ç”»æ•ˆæœ
      updateWeatherSoundEffects(); // æ›´æ–°å¤©æ°”éŸ³æ•ˆ
      updateGameData(); // æ›´æ–°UIæ˜¾ç¤º
    }

// åº”ç”¨å¤©æ°”æ•ˆæœå‡½æ•°
    function applyWeatherEffects() {
      // è·å–å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);

      // æ£€æŸ¥æ˜¯å¦åœ¨"æˆ‘çš„å®…é‚¸"ä¸­ï¼Œå¦‚æœåœ¨å®…é‚¸ä¸­åˆ™å…ç–«å¤©æ°”è´Ÿé¢æ•ˆæœ
      const isInMyMansion = currentLocation && currentLocation.id === 'my_mansion';

      // åªåœ¨æ²¡æœ‰"å…¨èº«æ¹¿é€"BUFFæ—¶ï¼Œæ ¹æ®å¤©æ°”æ¡ä»¶æ·»åŠ 
      // "å…¨èº«æ¹¿é€"BUFFä¸€æ—¦è·å¾—ï¼Œåªèƒ½é€šè¿‡ç¯ç«æ¶ˆé™¤
      // å¦‚æœåœ¨"æˆ‘çš„å®…é‚¸"ä¸­ï¼Œåˆ™ä¸åº”ç”¨å¤©æ°”è´Ÿé¢æ•ˆæœ
      // æ£€æŸ¥æ˜¯å¦æœ‰"è¢«ç½©äº†"BUFF
      const hasProtectedBuff = gameData.buffs['è¢«ç½©äº†'] && gameData.buffs['è¢«ç½©äº†'].active;

      if (!gameData.buffs['å…¨èº«æ¹¿é€'] && !isInMyMansion && !hasProtectedBuff) {
        if (gameData.weather === 'rainy' || gameData.weather === 'snowy') {
          gameData.buffs['å…¨èº«æ¹¿é€'] = { active: true };
          // æ·»åŠ BUFFåæ›´æ–°BUFFæ˜¾ç¤º
          updateBuffDisplay();
        }
      }

      // ç¡®ä¿UIæ›´æ–°ï¼Œæ˜¾ç¤ºå½“å‰å¤©æ°”çŠ¶æ€
      const weatherIcon = document.getElementById('weatherIcon');
      const weatherName = document.getElementById('weatherName');

      if (weatherIcon && weatherName) {
        const weatherDisplayNames = {
          'sunny': { icon: 'â˜€ï¸', name: 'æ™´å¤©' },
          'rainy': { icon: 'ğŸŒ§ï¸', name: 'é›¨å¤©' },
          'snowy': { icon: 'â„ï¸', name: 'é›ªå¤©' }
        };

        weatherIcon.textContent = weatherDisplayNames[gameData.weather]?.icon || 'â˜€ï¸';
        weatherName.textContent = weatherDisplayNames[gameData.weather]?.name || 'æ™´å¤©';
      }
    }

    // æ›´æ–°BUFFæ˜¾ç¤º
    function updateBuffDisplay() {
      // æŸ¥æ‰¾æŠ€èƒ½çª—å£ä¸­çš„BUFFåˆ—è¡¨
      const buffsList = document.querySelector('.buffs-list');
      if (buffsList) {
        renderBuffsInWindow(buffsList);
      }
    }

    // å¤©æ°”æ•ˆæœåŠ¨ç”»ç³»ç»Ÿ
    let weatherAnimationInterval = null;
    let weatherParticles = [];
    
    // åˆ›å»ºé›¨æ»´å‡½æ•° - æ”¯æŒä¸åŒå±‚æ¬¡
    function createRaindrop(layer = 'midground') {
      const raindrop = document.createElement('div');
      raindrop.className = `raindrop ${layer}`;

      // æ ¹æ®å±‚æ¬¡è®¾ç½®é›¨æ»´å¤§å°
      let width, height, duration, opacity;
      switch(layer) {
        case 'foreground':
          width = Math.random() * 2 + 2; // 2-4px
          height = Math.random() * 10 + 20; // 20-30px
          duration = Math.random() * 0.5 + 0.6; // 0.6-1.1s
          opacity = Math.random() * 0.15 + 0.85; // 0.85-1.0
          break;
        case 'midground':
          width = Math.random() * 1.5 + 1.5; // 1.5-3px
          height = Math.random() * 8 + 12; // 12-20px
          duration = Math.random() * 0.8 + 0.8; // 0.8-1.6s
          opacity = Math.random() * 0.2 + 0.65; // 0.65-0.85
          break;
        case 'background':
          width = Math.random() * 1 + 0.5; // 0.5-1.5px
          height = Math.random() * 6 + 8; // 8-14px
          duration = Math.random() * 1.2 + 1.2; // 1.2-2.4s
          opacity = Math.random() * 0.15 + 0.35; // 0.35-0.5
          break;
      }

      raindrop.style.width = width + 'px';
      raindrop.style.height = height + 'px';
      raindrop.style.left = Math.random() * 100 + '%';
      raindrop.style.animationDuration = duration + 's';
      raindrop.style.animationDelay = Math.random() * 2 + 's';
      raindrop.style.opacity = opacity;

      // æ·»åŠ é›¨æ»´è½åœ°äº‹ä»¶ç›‘å¬
      raindrop.addEventListener('animationend', function() {
        // åªä¸ºå‰æ™¯å’Œä¸­æ™¯é›¨æ»´åˆ›å»ºæ™•åœˆæ•ˆæœ
        if (layer === 'foreground' || layer === 'midground') {
          createRipple(parseFloat(this.style.left));
        }
        // ä¸ºå‰æ™¯é›¨æ»´åˆ›å»ºé£æº…æ•ˆæœ
        if (layer === 'foreground' && Math.random() > 0.5) {
          createSplash(parseFloat(this.style.left));
        }
        // ç§»é™¤é›¨æ»´
        this.remove();
        // ä»ç²’å­æ•°ç»„ä¸­ç§»é™¤
        const index = weatherParticles.indexOf(this);
        if (index > -1) {
          weatherParticles.splice(index, 1);
        }
      });

      return raindrop;
    }
    
    // åˆ›å»ºæ™•åœˆæ•ˆæœå‡½æ•°
    function createRipple(xPosition) {
      const ripple = document.createElement('div');
      ripple.className = 'ripple';

      // å¢å¤§æ™•åœˆå°ºå¯¸
      const size = Math.random() * 25 + 15; // 15-40px
      ripple.style.width = size + 'px';
      ripple.style.height = size + 'px';
      ripple.style.left = xPosition + '%';

      // è®¡ç®—äººç‰©çŠ¶æ€æ ä¸‹ç•Œä½ç½®ï¼Œå¹¶æ·»åŠ ä¸Šä¸‹æµ®åŠ¨æ•ˆæœ
      const statusGrid = document.querySelector('.status-grid');
      if (statusGrid) {
        const statusGridRect = statusGrid.getBoundingClientRect();
        const containerRect = document.getElementById('weatherEffectsContainer').getBoundingClientRect();

        // è®¡ç®—çŠ¶æ€æ ç½‘æ ¼åº•éƒ¨ç›¸å¯¹äºå®¹å™¨çš„é«˜åº¦ç™¾åˆ†æ¯”
        if (statusGridRect.bottom > 0 && containerRect.height > 0) {
          const statusBottomPercent = ((statusGridRect.bottom - containerRect.top) / containerRect.height * 100);

          // åœ¨çŠ¶æ€æ åº•éƒ¨ä¸‹æ–¹æ·»åŠ éšæœºæµ®åŠ¨æ•ˆæœ (Â±5%)
          const floatOffset = (Math.random() * 10) - 5; // -5% åˆ° +5%
          const finalPosition = Math.min(Math.max(statusBottomPercent + floatOffset + 2, 0), 95);

          ripple.style.top = finalPosition + '%';
        } else {
          // å¤‡ç”¨ä½ç½®ï¼šå±å¹•åº•éƒ¨é™„è¿‘
          ripple.style.top = Math.min(Math.max(70 + (Math.random() * 10 - 5), 0), 95) + '%';
        }
      } else {
        // å¤‡ç”¨ä½ç½®ï¼šå±å¹•åº•éƒ¨é™„è¿‘
        ripple.style.top = Math.min(Math.max(70 + (Math.random() * 10 - 5), 0), 95) + '%';
      }

      const container = document.getElementById('weatherEffectsContainer');
      if (container) {
        container.appendChild(ripple);

        // åŠ¨ç”»ç»“æŸåç§»é™¤æ™•åœˆ
        setTimeout(function() {
          if (ripple.parentNode) {
            ripple.remove();
          }
        }, 1200);
      }
    }

    // åˆ›å»ºé£æº…æ•ˆæœå‡½æ•°
    function createSplash(xPosition) {
      // åˆ›å»º2-4ä¸ªé£æº…ç²’å­
      const particleCount = Math.floor(Math.random() * 3) + 2;

      for (let i = 0; i < particleCount; i++) {
        const splash = document.createElement('div');
        splash.className = 'splash';

        splash.style.left = xPosition + '%';

        // è®¡ç®—å‚ç›´ä½ç½®ï¼ˆä¸æ™•åœˆç›¸åŒï¼‰
        const statusGrid = document.querySelector('.status-grid');
        if (statusGrid) {
          const statusGridRect = statusGrid.getBoundingClientRect();
          const containerRect = document.getElementById('weatherEffectsContainer').getBoundingClientRect();

          if (statusGridRect.bottom > 0 && containerRect.height > 0) {
            const statusBottomPercent = ((statusGridRect.bottom - containerRect.top) / containerRect.height * 100);
            const floatOffset = (Math.random() * 10) - 5;
            const finalPosition = Math.min(Math.max(statusBottomPercent + floatOffset + 2, 0), 95);
            splash.style.top = finalPosition + '%';
          } else {
            splash.style.top = Math.min(Math.max(70 + (Math.random() * 10 - 5), 0), 95) + '%';
          }
        } else {
          splash.style.top = Math.min(Math.max(70 + (Math.random() * 10 - 5), 0), 95) + '%';
        }

        // éšæœºé£æº…æ–¹å‘å’Œè·ç¦»
        const offsetX = (Math.random() * 20 - 10) + '%'; // -10% åˆ° +10%
        splash.style.transform = `translateX(${offsetX})`;
        splash.style.animation = `splash-up ${Math.random() * 0.3 + 0.4}s ease-out forwards`;

        const container = document.getElementById('weatherEffectsContainer');
        if (container) {
          container.appendChild(splash);

          // åŠ¨ç”»ç»“æŸåç§»é™¤é£æº…
          setTimeout(function() {
            if (splash.parentNode) {
              splash.remove();
            }
          }, 700);
        }
      }
    }
    
    // æ¸…é™¤å¤©æ°”æ•ˆæœå‡½æ•°
    function clearWeatherEffects() {
      if (weatherAnimationInterval) {
        clearInterval(weatherAnimationInterval);
        weatherAnimationInterval = null;
      }

      // ç§»é™¤é›¾æ°”å±‚
      const fogLayer = document.getElementById('fogLayer');
      if (fogLayer && fogLayer.parentNode) {
        fogLayer.parentNode.removeChild(fogLayer);
      }

      // ç§»é™¤æ‰€æœ‰ç²’å­
      weatherParticles.forEach(particle => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      });
      weatherParticles = [];
    }
    
    // å¯åŠ¨ä¸‹é›¨æ•ˆæœ
    function startRainEffect() {
      const container = document.getElementById('weatherEffectsContainer');

      // åˆ›å»ºé›¾æ°”å±‚
      const fogLayer = document.createElement('div');
      fogLayer.className = 'fog-layer';
      fogLayer.id = 'fogLayer';
      container.appendChild(fogLayer);

      // åˆ›å»ºä¸åŒå±‚æ¬¡çš„åˆå§‹é›¨æ»´
      // å‰æ™¯é›¨æ»´ï¼ˆè¿‘ã€å¤§ã€å¿«ï¼‰- 20ä¸ª
      for (let i = 0; i < 20; i++) {
        const raindrop = createRaindrop('foreground');
        container.appendChild(raindrop);
        weatherParticles.push(raindrop);
      }

      // ä¸­æ™¯é›¨æ»´ï¼ˆä¸­ã€ä¸­ã€ä¸­ï¼‰- 40ä¸ª
      for (let i = 0; i < 40; i++) {
        const raindrop = createRaindrop('midground');
        container.appendChild(raindrop);
        weatherParticles.push(raindrop);
      }

      // èƒŒæ™¯é›¨æ»´ï¼ˆè¿œã€å°ã€æ…¢ï¼‰- 50ä¸ª
      for (let i = 0; i < 50; i++) {
        const raindrop = createRaindrop('background');
        container.appendChild(raindrop);
        weatherParticles.push(raindrop);
      }

      // å®šæœŸåˆ›å»ºæ–°é›¨æ»´ä»¥ç»´æŒæ•ˆæœ
      let counter = 0;
      weatherAnimationInterval = setInterval(function() {
        counter++;
        // è½®æµåˆ›å»ºä¸åŒå±‚æ¬¡çš„é›¨æ»´
        const layer = counter % 3;
        let raindrop;
        if (layer === 0) {
          // åˆ›å»ºå‰æ™¯é›¨æ»´
          if (countParticlesByLayer('foreground') < 30) {
            raindrop = createRaindrop('foreground');
          }
        } else if (layer === 1) {
          // åˆ›å»ºä¸­æ™¯é›¨æ»´
          if (countParticlesByLayer('midground') < 60) {
            raindrop = createRaindrop('midground');
          }
        } else {
          // åˆ›å»ºèƒŒæ™¯é›¨æ»´
          if (countParticlesByLayer('background') < 80) {
            raindrop = createRaindrop('background');
          }
        }

        if (raindrop) {
          container.appendChild(raindrop);
          weatherParticles.push(raindrop);
        }
      }, 80);
    }

    // ç»Ÿè®¡æŒ‡å®šå±‚æ¬¡çš„ç²’å­æ•°é‡
    function countParticlesByLayer(layer) {
      return weatherParticles.filter(p => p.classList.contains(layer)).length;
    }
    
    // æ›´æ–°å¤©æ°”æ•ˆæœå‡½æ•°
    function updateWeatherEffects() {
      // æ¸…é™¤ä¹‹å‰çš„å¤©æ°”æ•ˆæœ
      clearWeatherEffects();
      
      // æ ¹æ®å½“å‰å¤©æ°”ç±»å‹å¯åŠ¨ç›¸åº”çš„æ•ˆæœ
      if (gameData.weather === 'rainy') {
        startRainEffect();
        document.body.classList.add('weather-rainy');
      } else {
        document.body.classList.remove('weather-rainy');
      }
    }

// çƒ¤ç«å‡½æ•°
    function warmByFire() {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦çƒ¤ç«ï¼šä½“æ¸©ä½äº36â„ƒ æˆ–è€… å¤„äºå…¨èº«æ¹¿é€çŠ¶æ€
      if (gameData.status.cold >= 36 && !gameData.buffs['å…¨èº«æ¹¿é€']) {
        showNotification('çƒ¤ç«', 'ä½ ä¸éœ€è¦çƒ¤ç«ï¼Œå› ä¸ºä½ çš„ä½“æ¸©æ­£å¸¸ä¸”æ²¡æœ‰å…¨èº«æ¹¿é€ã€‚');
        return;
      }

      // ç§»é™¤å…¨èº«æ¹¿é€BUFF
      if (gameData.buffs['å…¨èº«æ¹¿é€']) {
        delete gameData.buffs['å…¨èº«æ¹¿é€'];
        // ç§»é™¤BUFFåæ›´æ–°BUFFæ˜¾ç¤º
        updateBuffDisplay();
      }

      // å¢åŠ ä½“æ¸©ï¼šåªè¦ä½“æ¸©ä½äº36â„ƒï¼Œå°±å¢åŠ 1â„ƒ
      if (gameData.status.cold < 36) {
        gameData.status.cold = Math.min(36, gameData.status.cold + 1); // ä½“æ¸©æœ€å¤šåˆ°36â„ƒ
      }

      // æ›´æ–°UI
      updateGameData();

      // æ˜¾ç¤ºé€šçŸ¥
      let notificationTitle = 'çƒ¤ç«æˆåŠŸ';
      let notificationText = '';

      if (gameData.status.cold < 36) {
        if (!gameData.buffs['å…¨èº«æ¹¿é€']) {
          notificationText = 'ä½ çš„ä½“æ¸©ä¸Šå‡äº†1â„ƒï¼';
        } else {
          notificationText = 'ä½ çƒ¤ç«å»é™¤äº†å…¨èº«æ¹¿é€çš„çŠ¶æ€ï¼Œä½“æ¸©ä¸Šå‡äº†1â„ƒï¼';
        }
      } else {
        if (!gameData.buffs['å…¨èº«æ¹¿é€']) {
          notificationText = 'ä½ çš„ä½“æ¸©å·²æ¢å¤æ­£å¸¸ï¼';
        } else {
          notificationText = 'ä½ çƒ¤ç«å»é™¤äº†å…¨èº«æ¹¿é€çš„çŠ¶æ€ï¼';
        }
      }

      showNotification(notificationTitle, notificationText);
    }

// æ£€æŸ¥ç¯ç«ä¿æš–å‡½æ•°
    function checkCampfireWarmth() {
      // åªæœ‰åœ¨å¤œæ™šï¼ˆäº¥æ—¶21:00-23:00æˆ–å­æ—¶23:00-01:00ï¼‰ä¸”ä¸æ˜¯å¤å­£æ—¶éœ€è¦ç¯ç«ä¿æš–
      const isNightTime = gameData.currentHour >= 21 || gameData.currentHour < 1;
      if (isNightTime && gameData.season !== 'summer') {
        // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰ç¯ç«å¡ç‰Œ
        const hasCampfire = gameData.resources['fire'] && gameData.resources['fire'].amount > 0;
        return hasCampfire;
      }
      return true; // å…¶ä»–æƒ…å†µä¸éœ€è¦ç¯ç«
    }

// å¤„ç†BUFFæ•ˆæœå‡½æ•°
    function processBuffs() {
      Object.keys(gameData.buffs).forEach(buff => {
        switch (buff) {
          case 'å…¨èº«æ¹¿é€':
            // å…¨èº«æ¹¿é€ï¼šæ¯ä¸ªæ—¶é—´æ®µä½“æ¸©ä¸‹é™0.1â„ƒ
            gameData.status.cold -= 0.1;
            break;
        }
      });

      // å¤„ç†å¤œæ™šé™æ¸©ï¼ˆäº¥æ—¶21:00-23:00æˆ–å­æ—¶23:00-01:00ï¼‰
      const isNightTime = gameData.currentHour >= 21 || gameData.currentHour < 1;
      if (isNightTime && gameData.season !== 'å¤å¤©') {
        const hasCampfire = gameData.resources['fire'] && gameData.resources['fire'].amount > 0;
        if (!hasCampfire) {
          // å¤œæ™šæ²¡æœ‰ç¯ç«ï¼šä½“æ¸©æ¯ä¸ªå›åˆä¸‹é™0.1â„ƒ
          gameData.status.cold -= 0.1;
        }
      }

      // ç¡®ä¿ä½“æ¸©åœ¨åˆç†èŒƒå›´å†…
      gameData.status.cold = Math.max(34, Math.min(42, gameData.status.cold));
    }

// æ›´æ–°å•ä¸ªèµ„æºå¡ç‰Œçš„æ˜¾ç¤º
    function updateResourceCard(resourceId) {
      const resource = gameData.resources[resourceId];

// å¦‚æœèµ„æºæ•°é‡ä¸º0ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥ä¸¢å¼ƒ
      if (resource.amount <= 0) {
        // ç‰¹æ®Šå­¦ä¹ ç‰©å“(type: 'learnable')å³ä½¿æ ‡è®°ä¸ºä¸å¯ä¸¢å¼ƒï¼Œä½¿ç”¨åä¹Ÿåº”ç§»é™¤
        // å…¶ä»–ä¸å¯ä¸¢å¼ƒç‰©å“(cannotDrop)å³ä½¿æ•°é‡ä¸º0ä¹Ÿä¸ç§»é™¤å¡ç‰Œ
        if (resource.type !== 'learnable' && resource.cannotDrop) {
          // ç»§ç»­æ‰§è¡Œåç»­ä»£ç ä»¥æ›´æ–°å¡ç‰Œæ˜¾ç¤ºä¸ºæ•°é‡0
        } else {
          // å¯ä¸¢å¼ƒç‰©å“å’Œå­¦ä¹ ç‰©å“æ•°é‡ä¸º0æ—¶ç§»é™¤å¡ç‰Œ
          const card = document.querySelector(`.resource-card[data-resource="${resourceId}"]`);
          if (card) {
            card.remove();
          }
          return;
        }
      }

// æŸ¥æ‰¾ç°æœ‰çš„å¡ç‰Œ
      let card = document.querySelector(`.resource-card[data-resource="${resourceId}"]`);

// å¦‚æœå¡ç‰Œä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
      if (!card) {
        card = document.createElement('div');
        card.className = 'card resource resource-card';
        card.setAttribute('draggable', 'true');
        card.setAttribute('data-resource', resourceId);
        elements.resourceGrid.appendChild(card);
      }

      // æ›´æ–°å¡ç‰Œå†…å®¹
      // å¦‚æœæ˜¯æœ¨æ¡¶ã€æ°´è¢‹æˆ–ç¯ç«ï¼Œæ ¹æ®waterLevelæˆ–fuelè®¾ç½®åç§°å’Œå›¾ç‰‡
      let bucketImage = resource.image;
      let displayWaterLevel = resource.waterLevel || 0;
      
      // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ï¼Œè®¡ç®—æ‰€æœ‰å®ä¾‹çš„æ€»æ°´é‡
      if (resourceId === 'bucket' && resource.instances && resource.instances.length > 0) {
        const totalWater = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        const maxWater = resource.instances.length * 250;
        displayWaterLevel = totalWater;
        // å¦‚æœæœ‰è£…æ°´çš„å®ä¾‹ï¼Œæ˜¾ç¤ºæ»¡æ¡¶å›¾ç‰‡
        if (totalWater >= 200) {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else if (totalWater > 0) {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
        }
      } else if (resourceId === 'bucket' && resource.waterLevel !== undefined) {
        // å…¼å®¹æ—§ä»£ç 
        if (resource.waterLevel >= 200) {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else if (resource.waterLevel > 0) {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else {
          bucketImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
        }
        displayWaterLevel = resource.waterLevel;
      } else if (resourceId === 'water_bag' && resource.instances && resource.instances.length > 0) {
        const totalWater = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        const maxWater = resource.instances.length * 100;
        displayWaterLevel = totalWater;
        // å¦‚æœæœ‰è£…æ°´çš„å®ä¾‹ï¼Œæ˜¾ç¤ºæ»¡æ°´è¢‹å›¾ç‰‡
        bucketImage = totalWater > 0 ? 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
      } else if (resourceId === 'water_bag' && resource.waterLevel !== undefined) {
        // å…¼å®¹æ—§ä»£ç 
        bucketImage = resource.waterLevel > 0 ? 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
        displayWaterLevel = resource.waterLevel;
      } else if (resourceId === 'fire' && resource.fuel !== undefined) {
        // æ ¹æ®fuelåŠ¨æ€è®¾ç½®ç¯ç«å›¾ç‰‡
        bucketImage = resource.fuel > 0 ? 'UI/ç¯ç«.jpg' : 'UI/ç¯ç«ï¼ˆç­ï¼‰.jpg';
      }
      const bucketName = (resourceId === 'bucket') ? 'æœ¨æ¡¶' :
        (resourceId === 'water_bag') ? 'æ°´è¢‹' :
        (resourceId === 'fire') ? 'ç¯ç«' : resource.name;

      card.innerHTML = `
        <div class="card-image" style="height: 95px !important; width: 85px !important; max-height: 95px !important; margin: 0 auto !important; padding: 0 !important; background-image: url('${bucketImage}'); background-size: 100% 100%; background-position: top left; background-repeat: no-repeat; position: relative; overflow: hidden !important;">
            <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
            <div class="image-fallback" style="display: none; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
          ${resource.equipped ? `
            <div class="equipped-badge" style="position: absolute; top: 0.25rem; right: 0.25rem; background-color: #805AD5; color: white; border-radius: 50%; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">
              å·²ç©¿
            </div>
          ` : ''}
          ${resourceId === 'fire' ? `
            <div class="fuel-indicator" style="position: absolute; top: 0.25rem; left: 0.25rem; background-color: rgba(220, 38, 38, 0.9); color: white; border-radius: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.9rem; font-weight: bold;">
              ${resource.fuel || 0}%
            </div>
          ` : ''}
          ${resourceId === 'bucket' && (resource.instances || resource.waterLevel !== undefined) ? `
            <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 70px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
              ${Array.from({length: 5}, (_, i) => {
                const isFilled = i >= (5 - Math.floor((displayWaterLevel || 0) / 50));
                return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
              }).join('')}
            </div>
          ` : ''}
          ${resourceId === 'water_bag' && (resource.instances || resource.waterLevel !== undefined) ? `
            <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 70px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
              ${Array.from({length: 5}, (_, i) => {
                const isFilled = i >= (5 - Math.floor((displayWaterLevel || 0) / 20));
                return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
              }).join('')}
            </div>
          ` : ''}
        </div>
        <div class="card-content">
          <div class="card-title">${resourceId === 'fire' ? 'ç¯ç«' : `${bucketName}Ã—${resource.amount}`}</div>
          ${resource.durability !== undefined ? `
            <div class="card-durability" style="margin-top: 0.25rem;">
              <div class="durability-bar-container" style="height: 4px; background-color: #E2E8F0; border-radius: 2px; overflow: hidden;">
                <div class="durability-bar" style="height: 100%; width: ${resource.durability}%; background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'};"></div>
              </div>
              <div class="durability-text" style="font-size: 0.75rem; text-align: right; margin-top: 0.125rem;">${resource.durability}%</div>
            </div>
          ` : ''}
        </div>
      `;

      // ä¸ºæ—¶æ•ˆæ€§é£Ÿç‰©æ·»åŠ å€’è®¡æ—¶æ˜¾ç¤º
      if (resource.isPerishable && resource.expirationDays && resource.amount > 0) {
        const expiryInfo = document.createElement('div');
        expiryInfo.className = 'expiry-timer';

        // ä½¿ç”¨æ‰¹æ¬¡ç³»ç»Ÿè·å–æœ€æ—©è¿‡æœŸçš„å‰©ä½™æ—¶é—´
        const remainingTime = getEarliestExpiryTime(resourceId);
        if (remainingTime) {
          expiryInfo.textContent = formatRemainingTime(remainingTime);
          
          // å¦‚æœå‰©ä½™æ—¶é—´å°äº60åˆ†é’Ÿï¼Œæ·»åŠ è­¦å‘Šæ ·å¼ï¼ˆçº¢è‰²å¾½ç« å¸¦è„‰å†²åŠ¨ç”»ï¼‰
          if (remainingTime.totalMinutes < 60) {
            expiryInfo.classList.add('warning');
          }
        } else {
          expiryInfo.textContent = 'è¿‡æœŸ';
          expiryInfo.classList.add('warning');
        }

        card.appendChild(expiryInfo);
      }

      // è°ƒç”¨é€šç”¨çš„å€’è®¡æ—¶æ›´æ–°å‡½æ•°
      updateExpiryTimer(card, resourceId);

// ä¸ºæ°´è¢‹æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
      if (resourceId === 'water_bag') {
        card.addEventListener('click', function() {
          showWaterBagConfirmWindow(resourceId);
        });
      } else if (resourceId === 'bucket') {
        // ä¸ºæœ¨æ¡¶æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        card.addEventListener('click', function() {
          showBucketConfirmWindow(resourceId);
        });
      } else if (resourceId === 'dirty_water_bowl' || resourceId === 'clean_water_bowl') {
        // ä¿ç•™åŸæœ‰çš„æ°´ç¢—ç‚¹å‡»é€»è¾‘
        card.addEventListener('click', function() {
          handleResourceClick(resourceId);
        });
      } else if (resourceId === 'fire') {
        // ä¸ºç¯ç«å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        card.addEventListener('click', function() {
          handleResourceClick(resourceId);
        });
      }
    }

    // æ˜¾ç¤ºæ°´è¢‹é¥®ç”¨ç¡®è®¤å¼¹çª—
    function showWaterBagConfirmWindow(resourceId) {
      const resource = gameData.resources[resourceId];

      if (!resource || resource.amount <= 0) return;

      // è·å–æ°´é‡ï¼ˆå¯¹äºæ°´è¢‹ï¼Œä¼˜å…ˆä½¿ç”¨water_bagçš„æ°´é‡ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰èµ„æºçš„æ°´é‡ï¼‰
      const waterBag = gameData.resources.water_bag;
      const waterLevel = waterBag && waterBag.amount > 0 ? (waterBag.waterLevel || 100) : (resource.waterLevel || 0);

      // åˆ›å»ºæ¨¡æ€çª—å£å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'modal-overlay';
      modalContainer.style.position = 'fixed';
      modalContainer.style.top = '0';
      modalContainer.style.left = '0';
      modalContainer.style.width = '100%';
      modalContainer.style.height = '100%';
      modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
      modalContainer.style.display = 'flex';
      modalContainer.style.alignItems = 'center';
      modalContainer.style.justifyContent = 'center';
      modalContainer.style.zIndex = '1000';

      // åˆ›å»ºæ¨¡æ€çª—å£å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.style.backgroundColor = 'white';
      modalContent.style.borderRadius = '8px';
      modalContent.style.padding = '1.5rem';
      modalContent.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
      modalContent.style.maxWidth = '300px';
      modalContent.style.width = '100%';

      // æ·»åŠ æ ‡é¢˜
      const title = document.createElement('h3');
      title.textContent = 'ç¡®è®¤é¥®ç”¨';
      title.style.marginTop = '0';
      title.style.marginBottom = '1rem';
      title.style.fontSize = '1.25rem';
      title.style.fontWeight = 'bold';
      title.style.color = '#1A202C';
      modalContent.appendChild(title);

      // æ·»åŠ å†…å®¹
      const content = document.createElement('p');
      if (waterLevel > 0) {
        content.textContent = `ä½ ç¡®å®šè¦é¥®ç”¨è¿™ä¸ªæ°´è¢‹é‡Œçš„æ°´å—ï¼Ÿ\nå½“å‰æ°´é‡ï¼š${waterLevel}\né¥®ç”¨å°†æ¶ˆè€—20æ°´é‡å¹¶è¡¥å……20ç‚¹æ°´åˆ†ã€‚`;
      } else {
        content.textContent = 'æ°´è¢‹é‡Œæ²¡æœ‰æ°´ï¼Œæ— æ³•é¥®ç”¨ã€‚';
      }
      content.style.marginBottom = '1.5rem';
      content.style.color = '#4A5568';
      modalContent.appendChild(content);

      // åˆ›å»ºæŒ‰é’®å®¹å™¨
      const buttonContainer = document.createElement('div');
      buttonContainer.style.display = 'flex';
      buttonContainer.style.justifyContent = 'flex-end';
      buttonContainer.style.gap = '0.75rem';
      modalContent.appendChild(buttonContainer);

      // åˆ›å»ºå–æ¶ˆæŒ‰é’®
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'å–æ¶ˆ';
      cancelButton.className = 'ink-button ink-button-secondary ink-button-small';
      cancelButton.style.marginRight = '0.5rem';

      cancelButton.addEventListener('click', function() {
        if (modalContainer.parentNode === document.body) {
          document.body.removeChild(modalContainer);
        }
      });

      buttonContainer.appendChild(cancelButton);

      // åˆ›å»ºç¡®è®¤æŒ‰é’®
      const confirmButton = document.createElement('button');
      confirmButton.textContent = 'ç¡®å®š';
      confirmButton.className = 'ink-button ink-button-primary ink-button-small';

      // å¦‚æœæ°´é‡ä¸º0ï¼Œç¦ç”¨ç¡®è®¤æŒ‰é’®
      if (waterLevel <= 0) {
        confirmButton.disabled = true;
        confirmButton.style.opacity = '0.5';
        confirmButton.style.cursor = 'not-allowed';
      } else {
        confirmButton.addEventListener('click', function() {
          if (modalContainer.parentNode === document.body) {
            document.body.removeChild(modalContainer);
          }
          drinkWaterBag();
        });
      }

      buttonContainer.appendChild(confirmButton);

      // æ·»åŠ æ¨¡æ€çª—å£åˆ°æ–‡æ¡£
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);
    }

// æ˜¾ç¤ºæœ¨æ¡¶é¥®ç”¨ç¡®è®¤å¼¹çª—
    function showBucketConfirmWindow(resourceId) {
      const resource = gameData.resources[resourceId];

      if (!resource || resource.amount <= 0) return;

      // åˆ›å»ºæ¨¡æ€çª—å£å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'modal-overlay';
      modalContainer.style.position = 'fixed';
      modalContainer.style.top = '0';
      modalContainer.style.left = '0';
      modalContainer.style.width = '100%';
      modalContainer.style.height = '100%';
      modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
      modalContainer.style.display = 'flex';
      modalContainer.style.alignItems = 'center';
      modalContainer.style.justifyContent = 'center';
      modalContainer.style.zIndex = '1000';

      // åˆ›å»ºæ¨¡æ€çª—å£å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.style.backgroundColor = 'white';
      modalContent.style.borderRadius = '8px';
      modalContent.style.padding = '1.5rem';
      modalContent.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
      modalContent.style.maxWidth = '300px';
      modalContent.style.width = '100%';

      // æ·»åŠ æ ‡é¢˜
      const title = document.createElement('h3');
      title.textContent = 'ç¡®è®¤é¥®ç”¨';
      title.style.marginTop = '0';
      title.style.marginBottom = '1rem';
      title.style.fontSize = '1.25rem';
      title.style.fontWeight = 'bold';
      title.style.color = '#1A202C';
      modalContent.appendChild(title);

      // æ·»åŠ å†…å®¹ - æ˜¾ç¤ºå½“å‰æ°´é‡
      const waterLevel = resource.waterLevel || 0;
      const content = document.createElement('p');
      if (waterLevel > 0) {
        content.textContent = `ä½ ç¡®å®šè¦é¥®ç”¨è¿™ä¸ªæœ¨æ¡¶é‡Œçš„æ°´å—ï¼Ÿå½“å‰æ°´é‡: ${waterLevel}/250ï¼Œé¥®ç”¨åæ°´é‡ä¼šå‡å°‘50ã€‚`;
      } else {
        content.textContent = 'æœ¨æ¡¶é‡Œæ²¡æœ‰æ°´ï¼Œæ— æ³•é¥®ç”¨ã€‚';
      }
      content.style.marginBottom = '1.5rem';
      content.style.color = '#4A5568';
      modalContent.appendChild(content);

      // åˆ›å»ºæŒ‰é’®å®¹å™¨
      const buttonContainer = document.createElement('div');
      buttonContainer.style.display = 'flex';
      buttonContainer.style.justifyContent = 'flex-end';
      buttonContainer.style.gap = '0.75rem';
      modalContent.appendChild(buttonContainer);

      // åˆ›å»ºå–æ¶ˆæŒ‰é’®
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'å–æ¶ˆ';
      cancelButton.className = 'ink-button ink-button-secondary ink-button-small';
      cancelButton.style.marginRight = '0.5rem';

      cancelButton.addEventListener('click', function() {
        if (modalContainer.parentNode === document.body) {
          document.body.removeChild(modalContainer);
        }
      });

      buttonContainer.appendChild(cancelButton);

      // åˆ›å»ºç¡®è®¤æŒ‰é’®
      const confirmButton = document.createElement('button');
      confirmButton.textContent = 'ç¡®å®š';
      confirmButton.className = 'ink-button ink-button-primary ink-button-small';

      // å¦‚æœæ°´é‡ä¸º0ï¼Œç¦ç”¨ç¡®è®¤æŒ‰é’®
      if (waterLevel <= 0) {
        confirmButton.disabled = true;
        confirmButton.style.opacity = '0.5';
        confirmButton.style.cursor = 'not-allowed';
      } else {
        confirmButton.addEventListener('click', function() {
          document.body.removeChild(modalContainer);
          drinkBucket();
        });
      }

      buttonContainer.appendChild(confirmButton);

      // æ·»åŠ æ¨¡æ€çª—å£åˆ°æ–‡æ¡£
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);
    }



// é¥®ç”¨æ»¡æ°´è¢‹
    function drinkWaterBag() {
      const waterBag = gameData.resources['water_bag'];

if (!waterBag || waterBag.amount <= 0) {
        showNotification('é”™è¯¯', 'ä½ æ²¡æœ‰å¯ä»¥é¥®ç”¨çš„æ°´è¢‹ã€‚');
        return;
      }

// ä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹å¹¶é¥®ç”¨
      let totalWaterLevel = 0;

      if (waterBag.instances && waterBag.instances.length > 0) {
        // è®¡ç®—æ€»æ°´é‡
        totalWaterLevel = waterBag.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);

        if (totalWaterLevel <= 0) {
          showNotification('é”™è¯¯', 'æ‰€æœ‰æ°´è¢‹éƒ½æ˜¯ç©ºçš„ï¼Œéœ€è¦å…ˆè£…æ°´ã€‚');
          return;
        }

        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹å¹¶é¥®ç”¨
        for (const instance of waterBag.instances) {
          if (instance.waterLevel > 0) {
            // æ¶ˆè€—20æ°´é‡ï¼ˆä¸€ä¸ªæ°´ä½æ ¼ï¼‰
            if (instance.waterLevel >= 20) {
              instance.waterLevel -= 20;
            } else {
              // æ°´é‡ä¸è¶³20æ—¶å…¨éƒ¨é¥®ç”¨
              instance.waterLevel = 0;
            }
            break;
          }
        }

        // åŒæ­¥æ›´æ–°resource.waterLevel
        syncWaterBagWaterLevel();

        // è¡¥å……æ°´åˆ†20ç‚¹
        gameData.status.thirst = Math.min(100, gameData.status.thirst + 20);

        // è®¡ç®—å‰©ä½™æ°´é‡
        const remainingWater = waterBag.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);

        if (remainingWater <= 0) {
          showNotification('é¥®ç”¨äº†æ°´è¢‹é‡Œçš„æ°´', 'ä½ å–äº†æ°´è¢‹é‡Œçš„æ°´ï¼Œæ°´åˆ†å¾—åˆ°äº†è¡¥å……ã€‚æ‰€æœ‰æ°´è¢‹ç°åœ¨æ˜¯ç©ºçš„ã€‚');
        } else {
          showNotification('é¥®ç”¨äº†æ°´è¢‹é‡Œçš„æ°´', `ä½ å–äº†æ°´è¢‹é‡Œçš„æ°´ï¼Œæ°´åˆ†å¾—åˆ°äº†è¡¥å……ã€‚å‰©ä½™æ€»æ°´é‡${remainingWater}ã€‚`);
        }
      } else {
        // å…¼å®¹æ—§ä»£ç 
        // æ£€æŸ¥æ°´é‡
        const waterLevel = waterBag.waterLevel || 100;
        if (waterLevel <= 0) {
          showNotification('é”™è¯¯', 'æ°´è¢‹çš„æ°´é‡ä¸º0ï¼Œéœ€è¦å…ˆè£…æ°´ã€‚');
          return;
        }

        // æ¶ˆè€—20æ°´é‡ï¼ˆä¸€ä¸ªæ°´ä½æ ¼ï¼‰
        waterBag.waterLevel -= 20;

        // è¡¥å……æ°´åˆ†20ç‚¹
        gameData.status.thirst = Math.min(100, gameData.status.thirst + 20); // å¢åŠ 20ç‚¹æ°´åˆ†å€¼

        // å¦‚æœæ°´é‡å˜ä¸º0ï¼Œåªè®¾ç½®æ°´é‡ä¸º0ï¼Œä¸è¿›è¡Œæ•°é‡è½¬ç§»
        if (waterBag.waterLevel <= 0) {
          waterBag.waterLevel = 0;
          showNotification('é¥®ç”¨äº†æ°´è¢‹é‡Œçš„æ°´', 'ä½ å–äº†æ°´è¢‹é‡Œçš„æ°´ï¼Œæ°´åˆ†å¾—åˆ°äº†è¡¥å……ã€‚æ°´è¢‹ç°åœ¨æ˜¯ç©ºçš„ã€‚');
        } else {
          showNotification('é¥®ç”¨äº†æ°´è¢‹é‡Œçš„æ°´', `ä½ å–äº†æ°´è¢‹é‡Œçš„æ°´ï¼Œæ°´åˆ†å¾—åˆ°äº†è¡¥å……ã€‚æ°´è¢‹å‰©ä½™æ°´é‡${waterBag.waterLevel}ã€‚`);
        }
      }

      // æ’­æ”¾å–æ°´éŸ³æ•ˆ
      playSoundEffect('drink', 'éŸ³æ•ˆ/å–æ°´.wav', { volume: 0.7 });

// æ€»æ˜¯å®Œå…¨é‡æ–°æ¸²æŸ“èµ„æºä»¥æ›´æ–°æ°´ä½æŒ‡ç¤ºæ¡å’Œå¡ç‰ŒçŠ¶æ€
      renderResources();

// ä¿å­˜æ¸¸æˆæ•°æ®
      updateGameData();
    }

// é¥®ç”¨æœ¨æ¡¶
    // ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
    function useWaterFromContainer(containerType, amount) {
      // containerType: 'water_bag' æˆ– 'bucket'
      // amount: è¦ä½¿ç”¨çš„æ°´é‡
      
      // æ£€æŸ¥å®¹å™¨ç±»å‹ï¼ŒåŒ…æ‹¬å¯èƒ½çš„å˜ä½“
      let resourceKey = containerType;
      if (containerType === 'water_bag_full' || containerType === 'empty_water_bag') {
        resourceKey = 'water_bag';
      }
      
      let container = gameData.resources[resourceKey];
      if (!container || container.amount <= 0) {
        return { success: false, message: `ä½ æ²¡æœ‰${resourceKey === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶'}ï¼` };
      }
      
      // ä¼˜å…ˆä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨æ—§çš„æ°´ä½ç³»ç»Ÿ
      if (container.instances && container.instances.length > 0) {
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹
        let usedAmount = 0;
        let usedInstance = null;
        
        for (const instance of container.instances) {
          if (instance.waterLevel > 0) {
            usedAmount = Math.min(amount, instance.waterLevel);
            instance.waterLevel -= usedAmount;
            usedInstance = instance;
            break;
          }
        }
        
        if (usedAmount <= 0) {
          return { success: false, message: `ä½ çš„${resourceKey === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶'}å·²ç»æ²¡æœ‰æ°´äº†ï¼` };
        }
        
        // å‡å°‘è€ä¹…åº¦
        const durabilityLoss = resourceKey === 'water_bag' ? 1 : 2;
        if (usedInstance.durability === undefined) {
          usedInstance.durability = 100;
        }
        usedInstance.durability = Math.max(0, usedInstance.durability - durabilityLoss);
        
        // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œåˆ é™¤è¿™ä¸ªå®ä¾‹
        if (usedInstance.durability <= 0) {
          container.instances = container.instances.filter(inst => inst.id !== usedInstance.id);
          container.amount--;
          return { 
            success: true, 
            usedAmount: usedAmount,
            containerDestroyed: true,
            message: `${resourceKey === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶'}å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼`
          };
        }
        
        // åŒæ­¥æ€»æ°´ä½åˆ°resource.waterLevelï¼ˆç”¨äºå…¼å®¹æ€§ï¼‰
        syncContainerWaterLevel(resourceKey);
        
        // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
        updateContainerImage(resourceKey);
        
        return { success: true, usedAmount: usedAmount };
      } else if (container.waterLevel !== undefined) {
        // å…¼å®¹æ—§ä»£ç ï¼šä½¿ç”¨å•ä¸€æ°´ä½ç³»ç»Ÿ
        if (container.waterLevel <= 0) {
          return { success: false, message: `ä½ çš„${resourceKey === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶'}å·²ç»æ²¡æœ‰æ°´äº†ï¼` };
        }
        
        const usedAmount = Math.min(amount, container.waterLevel);
        container.waterLevel -= usedAmount;
        
        // å‡å°‘è€ä¹…åº¦
        const durabilityLoss = resourceKey === 'water_bag' ? 1 : 2;
        if (container.durability === undefined) {
          container.durability = 100;
        }
        container.durability = Math.max(0, container.durability - durabilityLoss);
        
        // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œè‡ªåŠ¨é”€æ¯
        if (container.durability <= 0) {
          container.amount--;
          if (container.amount <= 0) {
            container.durability = undefined;
          } else {
            container.durability = 100;
          }
          return { 
            success: true, 
            usedAmount: usedAmount,
            containerDestroyed: true,
            message: `${resourceKey === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶'}å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼`
          };
        }
        
        // æ›´æ–°å›¾ç‰‡
        updateContainerImage(resourceKey);
        
        return { success: true, usedAmount: usedAmount };
      } else {
        return { success: false, message: `ä½ çš„${resourceKey === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶'}æ²¡æœ‰åˆå§‹åŒ–å®ä¾‹æˆ–æ°´ä½ï¼` };
      }
    }
    
    // åŒæ­¥å®¹å™¨æ°´ä½åˆ°resource.waterLevel
    function syncContainerWaterLevel(containerType) {
      const container = gameData.resources[containerType];
      if (!container) return;
      
      if (container.instances && container.instances.length > 0) {
        // è®¡ç®—æ‰€æœ‰å®ä¾‹çš„æ€»æ°´ä½
        const totalWater = container.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        container.waterLevel = totalWater;
      }
    }
    
    // æ›´æ–°å®¹å™¨å›¾ç‰‡
    function updateContainerImage(containerType) {
      const container = gameData.resources[containerType];
      if (!container) return;
      
      if (containerType === 'bucket') {
        const waterLevel = container.waterLevel || 0;
        if (waterLevel <= 0) {
          container.image = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
        } else if (waterLevel >= 250) {
          container.image = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else {
          container.image = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        }
      } else if (containerType === 'water_bag') {
        const waterLevel = container.waterLevel || 0;
        if (waterLevel <= 0) {
          container.image = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
        } else {
          container.image = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
        }
      }
    }
    
    // è·å–å®¹å™¨çš„æ€»æ°´ä½
    function getContainerTotalWater(containerType) {
      // æ£€æŸ¥å®¹å™¨ç±»å‹ï¼ŒåŒ…æ‹¬å¯èƒ½çš„å˜ä½“
      let resourceKey = containerType;
      if (containerType === 'water_bag_full' || containerType === 'empty_water_bag') {
        resourceKey = 'water_bag';
      }
      
      const container = gameData.resources[resourceKey];
      if (!container) return 0;
      
      if (container.instances && container.instances.length > 0) {
        // è®¡ç®—æ‰€æœ‰å®ä¾‹çš„æ€»æ°´ä½
        return container.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
      } else if (container.waterLevel !== undefined) {
        return container.waterLevel;
      }
      
      return 0;
    }

    // é¥®ç”¨æœ¨æ¡¶
    function drinkBucket() {
      const bucket = gameData.resources['bucket'];

      if (!bucket || bucket.amount <= 0) {
        showNotification('é”™è¯¯', 'ä½ æ²¡æœ‰å¯ä»¥é¥®ç”¨çš„æœ¨æ¡¶ã€‚');
        return;
      }

      // ä½¿ç”¨ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
      const result = useWaterFromContainer('bucket', 50);
      
      if (!result.success) {
        showNotification('é”™è¯¯', result.message);
        return;
      }
      
      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      updateGameData();
      
      // æ¢å¤å£æ¸´å€¼
      gameData.status.thirst = Math.min(100, gameData.status.thirst + result.usedAmount);
      
      // åŒæ­¥æ›´æ–°resource.waterLevel
      syncBucketWaterLevel();
      
      // è®¡ç®—å‰©ä½™æ°´é‡
      const remainingWater = bucket.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
      const waterStatus = remainingWater > 0 ? `å‰©ä½™æ€»æ°´é‡: ${remainingWater}/250` : 'æ‰€æœ‰æœ¨æ¡¶å·²ç©º';
      showNotification('é¥®ç”¨äº†æœ¨æ¡¶é‡Œçš„æ°´', `ä½ å–äº†æœ¨æ¡¶é‡Œçš„æ°´ï¼Œæ°´åˆ†å¾—åˆ°äº†è¡¥å……ã€‚${waterStatus}ã€‚`);

      // æ’­æ”¾å–æ°´éŸ³æ•ˆ
      playSoundEffect('drink', 'éŸ³æ•ˆ/å–æ°´.wav', { volume: 0.7 });

      // æ›´æ–°UIå’Œæ¸¸æˆæ•°æ®
      updateResourceCard('bucket');
      updateResourceCard('water_bag');
      updateGameData();

      // é‡æ–°æ¸²æŸ“èƒŒåŒ…æ ï¼Œç¡®ä¿å¡ç‰Œæ•°é‡å˜åŒ–ç«‹å³æ˜¾ç¤º
      renderResources();
    }

// å…¨å±€å˜é‡ç”¨äºè·Ÿè¸ªå½“å‰åˆ†ç±»
    let groundCurrentCategory = 'all';

    // è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½çš„å…¨å±€å˜é‡
    let autoScrollTimer = null;

    // åœæ­¢è‡ªåŠ¨æ»šåŠ¨çš„å‡½æ•°
    function stopAutoScroll() {
      if (autoScrollTimer) {
        cancelAnimationFrame(autoScrollTimer);
        autoScrollTimer = null;
      }
    }

// æ·»åŠ ç¼ºå¤±çš„åˆ†ç±»å±æ€§çš„å‡½æ•°
    function ensureResourceCategories() {
        for (const [id, resource] of Object.entries(gameData.resources)) {
            if (!resource.category) {
                // é»˜è®¤åˆ†ç±»ä¸ºææ–™
                gameData.resources[id].category = 'material';
            }
        }
    }

    // å›¾é’‰åŠŸèƒ½ï¼šåˆ‡æ¢å¡ç‰Œçš„å›ºå®šçŠ¶æ€
    function togglePinResource(resourceId) {
        const resource = gameData.resources[resourceId];
        if (!resource) return;
        
        // åˆå§‹åŒ–å›ºå®šçŠ¶æ€
        if (resource.pinned === undefined) {
            resource.pinned = false;
        }
        
        // åˆ‡æ¢å›ºå®šçŠ¶æ€
        resource.pinned = !resource.pinned;
        
        console.log(`å›¾é’‰åŠŸèƒ½: èµ„æº ${resourceId} (${resource.name}) å›ºå®šçŠ¶æ€åˆ‡æ¢ä¸º: ${resource.pinned}`);
        
        // æ›´æ–°å½“å‰å¡ç‰Œçš„UIçŠ¶æ€ï¼Œè€Œä¸æ˜¯é‡æ–°æ¸²æŸ“æ•´ä¸ªç½‘æ ¼
        updateCardPinState(resourceId, resource.pinned);
        
        // ä¿å­˜çŠ¶æ€åˆ°localStorage
        savePinnedState();
        
        // æ˜¾ç¤ºé€šçŸ¥
        const action = resource.pinned ? 'å›ºå®š' : 'å–æ¶ˆå›ºå®š';
        showNotification('å¡ç‰ŒçŠ¶æ€', `å¡ç‰Œ ${resource.name} å·²è¢«${action}`);
    }

    // æ›´æ–°å•ä¸ªå¡ç‰Œçš„å›ºå®šçŠ¶æ€
    function updateCardPinState(resourceId, pinned) {
        const card = document.querySelector(`.resource-card[data-resource="${resourceId}"]`);
        if (card) {
            if (pinned) {
                card.classList.add('pinned');
                card.setAttribute('draggable', 'false');
            } else {
                card.classList.remove('pinned');
                card.setAttribute('draggable', 'true');
            }
            
            // æ›´æ–°å›¾é’‰æŒ‰é’®çš„æ ·å¼
            const pinButton = card.querySelector('.pin-button');
            if (pinButton) {
                if (pinned) {
                    pinButton.style.backgroundColor = '#38A169';
                    pinButton.classList.add('pinned');
                } else {
                    pinButton.style.backgroundColor = '#CBD5E0';
                    pinButton.classList.remove('pinned');
                }
            }
        }
    }

    // ä¿å­˜å›ºå®šçŠ¶æ€åˆ°localStorage
    function savePinnedState() {
        const pinnedState = {};
        Object.keys(gameData.resources).forEach(resourceId => {
            // ç¯ç«ä¸èƒ½è¢«å›ºå®šï¼Œä¸ä¿å­˜å…¶çŠ¶æ€
            if (resourceId === 'fire') return;
            
            const resource = gameData.resources[resourceId];
            if (resource.pinned !== undefined) {
                pinnedState[resourceId] = resource.pinned;
            }
        });
        localStorage.setItem('pinnedResources', JSON.stringify(pinnedState));
    }

    // åŠ è½½å›ºå®šçŠ¶æ€
    function loadPinnedState() {
        const savedState = localStorage.getItem('pinnedResources');
        if (!savedState) return;
        
        const pinnedState = JSON.parse(savedState);
        Object.keys(pinnedState).forEach(resourceId => {
            if (gameData.resources[resourceId]) {
                // ç¯ç«ä¸èƒ½è¢«å›ºå®šï¼Œè·³è¿‡ç¯ç«çš„å›ºå®šçŠ¶æ€
                if (resourceId !== 'fire') {
                    gameData.resources[resourceId].pinned = pinnedState[resourceId];
                }
            }
        });
    }

// æ¸²æŸ“èµ„æº
    function renderResources() {
      // ç¡®ä¿æ‰€æœ‰èµ„æºéƒ½æœ‰åˆ†ç±»
      ensureResourceCategories();

// ä¿å­˜å½“å‰å¡ç‰Œçš„ä½ç½®é¡ºåº
      const resourceGrid = elements.resourceGrid;
      const currentOrder = [];
      const existingCards = resourceGrid.querySelectorAll('.resource-card');
      existingCards.forEach(card => {
        const resourceId = card.getAttribute('data-resource');
        if (resourceId) {
          currentOrder.push(resourceId);
        }
      });

elements.resourceGrid.innerHTML = '';

// ç­›é€‰èµ„æº - åªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„èµ„æº
      let filteredResources = [];
      for (const [id, resource] of Object.entries(gameData.resources)) {
        // è·³è¿‡empty_bucketã€empty_water_bagã€bucketå’Œwater_bagï¼Œå®ƒä»¬å°†åœ¨ä¸‹é¢å•ç‹¬å¤„ç†
        if (id === 'empty_bucket' || id === 'empty_water_bag' || id === 'bucket' || id === 'water_bag') {
          continue;
        }

        // åªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„èµ„æº
        if (resource.amount > 0) {
          filteredResources.push({ id, resource });
        }
      }

      // å¤„ç†æ°´æ¡¶å’Œæ°´è¢‹çš„åˆ†ç¦»æ˜¾ç¤º
      const processWaterContainer = (mainId, emptyId, containerType) => {
        const mainResource = gameData.resources[mainId];
        const emptyResource = gameData.resources[emptyId];

        if (!mainResource || mainResource.amount <= 0) {
          return;
        }

        // å¦‚æœæœ‰å®ä¾‹ç³»ç»Ÿï¼Œè®¡ç®—è£…äº†æ°´å’Œæ²¡è£…æ°´çš„æ•°é‡
        if (mainResource.instances && mainResource.instances.length > 0) {
          const withWaterInstances = mainResource.instances.filter(inst => inst.waterLevel > 0);
          const emptyInstances = mainResource.instances.filter(inst => inst.waterLevel <= 0);
          const withWaterCount = withWaterInstances.length;
          const emptyCount = emptyInstances.length;

          // æ˜¾ç¤ºè£…äº†æ°´çš„ï¼šåªæœ‰2ä¸ªæˆ–ä»¥ä¸Šæ‰å åŠ ï¼Œ1ä¸ªæ—¶æ˜¾ç¤ºæ•°é‡ä¸º1
          if (withWaterCount >= 1) {
            const firstInstance = withWaterInstances[0];
            const displayCount = withWaterCount >= 2 ? withWaterCount : 1;
            filteredResources.push({
              id: mainId + '_with_water',
              resource: {
                ...mainResource,
                amount: displayCount,
                originalId: mainId,
                waterLevel: firstInstance.waterLevel,
                name: containerType === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹'
              }
            });
          }

          // æ˜¾ç¤ºæ²¡è£…æ°´çš„ï¼ˆå¦‚æœæœ‰ç©ºå®ä¾‹ï¼Œæ˜¾ç¤ºæ•°é‡ï¼‰
          if (emptyCount > 0) {
            filteredResources.push({
              id: emptyId,
              resource: {
                ...mainResource,
                amount: emptyCount,
                originalId: mainId,
                waterLevel: 0,
                name: containerType === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹',
                image: containerType === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg',
                showWaterIndicator: true  // æ ‡è®°éœ€è¦æ˜¾ç¤ºæ°´ä½æŒ‡ç¤ºæ¡
              }
            });
          }
        } else {
          // æ²¡æœ‰å®ä¾‹ç³»ç»Ÿï¼Œä½¿ç”¨waterLevel
          const hasWater = mainResource.waterLevel > 0;
          const totalEmptyCount = (hasWater ? 0 : mainResource.amount) + (emptyResource?.amount || 0);

          // æ˜¾ç¤ºè£…äº†æ°´çš„ï¼šåªæ˜¾ç¤º1ä¸ªï¼Œä¸å åŠ 
          if (hasWater) {
            filteredResources.push({
              id: mainId + '_with_water',
              resource: {
                ...mainResource,
                amount: 1,
                originalId: mainId,
                waterLevel: mainResource.waterLevel,
                name: containerType === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹'
              }
            });
          }

          // æ˜¾ç¤ºæ²¡è£…æ°´çš„
          if (totalEmptyCount > 0) {
            filteredResources.push({
              id: emptyId,
              resource: {
                ...mainResource,
                amount: totalEmptyCount,
                originalId: mainId,
                waterLevel: 0,
                name: containerType === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹',
                image: containerType === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg',
                showWaterIndicator: true  // æ ‡è®°éœ€è¦æ˜¾ç¤ºæ°´ä½æŒ‡ç¤ºæ¡
              }
            });
          }
        }
      };

      // å¤„ç†æ°´æ¡¶
      if (gameData.resources.bucket && gameData.resources.bucket.amount > 0) {
        processWaterContainer('bucket', 'empty_bucket', 'bucket');
      }

      // å¤„ç†æ°´è¢‹
      if (gameData.resources.water_bag && gameData.resources.water_bag.amount > 0) {
        processWaterContainer('water_bag', 'empty_water_bag', 'water_bag');
      }

      // å¦‚æœæœ‰ä¿å­˜çš„ä½ç½®é¡ºåºï¼ŒæŒ‰ç…§ä¿å­˜çš„é¡ºåºé‡æ–°æ’åº
      if (currentOrder.length > 0) {
        filteredResources.sort((a, b) => {
          const indexA = currentOrder.indexOf(a.id);
          const indexB = currentOrder.indexOf(b.id);
          
          // å¦‚æœä¸¤ä¸ªéƒ½åœ¨å½“å‰é¡ºåºä¸­ï¼ŒæŒ‰ä¿å­˜çš„é¡ºåºæ’åº
          if (indexA !== -1 && indexB !== -1) {
            return indexA - indexB;
          }
          // å¦‚æœåªæœ‰aåœ¨å½“å‰é¡ºåºä¸­ï¼Œaæ’åœ¨å‰é¢
          if (indexA !== -1) {
            return -1;
          }
          // å¦‚æœåªæœ‰båœ¨å½“å‰é¡ºåºä¸­ï¼Œbæ’åœ¨å‰é¢
          if (indexB !== -1) {
            return 1;
          }
          // å¦‚æœéƒ½ä¸åœ¨å½“å‰é¡ºåºä¸­ï¼Œä¿æŒåŸé¡ºåº
          return 0;
        });
      }



      // é™åˆ¶èƒŒåŒ…æ æœ€å¤šåªæ˜¾ç¤º5ç§å¡ç‰Œ
      const maxBackpackSlots = 5;

      // æ˜¾ç¤ºæ‰€æœ‰ç­›é€‰åçš„èµ„æºï¼ˆæœ€å¤š5ç§ï¼‰
      for (let i = 0; i < Math.min(filteredResources.length, maxBackpackSlots); i++) {
        const { id, resource } = filteredResources[i];
        // åˆå§‹åŒ–å›ºå®šçŠ¶æ€
        if (resource.pinned === undefined) {
          resource.pinned = false;
        }

        // å¤„ç†æœ¨æ¡¶å’Œæ°´è¢‹çš„ç‰¹æ®Šæ˜¾ç¤ºé€»è¾‘
        let displayImage = resource.image;
        let displayName = resource.name;
        let actualResourceId = id; // å®é™…ä½¿ç”¨çš„èµ„æºID

        // å¤„ç†è£…äº†æ°´çš„æœ¨æ¡¶/æ°´è¢‹
        if (id === 'bucket_with_water' || id === 'water_bag_with_water') {
          actualResourceId = resource.originalId;
          displayImage = resource.originalId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
          displayName = resource.originalId === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹';
        }
        // å¤„ç†æ²¡è£…æ°´çš„æœ¨æ¡¶/æ°´è¢‹
        else if (id === 'empty_bucket' || id === 'empty_water_bag') {
          actualResourceId = resource.originalId || id.replace('empty_', '');
          displayImage = resource.originalId === 'bucket' || actualResourceId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
          displayName = resource.originalId === 'bucket' || actualResourceId === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹';
        }
        // å¤„ç†æ™®é€šæœ¨æ¡¶/æ°´è¢‹ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        else if (id === 'bucket' || id === 'water_bag') {
          if (resource.waterLevel !== undefined) {
            displayImage = resource.waterLevel > 0 ? (resource.originalId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg') : (resource.originalId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg');
            displayName = resource.originalId === 'bucket' ? (resource.waterLevel > 0 ? 'æœ¨æ¡¶' : 'æœ¨æ¡¶') : (resource.waterLevel > 0 ? 'æ°´è¢‹' : 'æ°´è¢‹');
          }
        }

        const resourceCard = document.createElement('div');
      resourceCard.className = `card resource resource-card ${resource.pinned ? 'pinned' : ''}`;
      resourceCard.setAttribute('draggable', 'true');
      resourceCard.setAttribute('data-resource', actualResourceId);
      resourceCard.setAttribute('data-display-id', id);

        resourceCard.innerHTML = `
          <div class="card-content">
            <div class="card-title">${displayName}</div>
          </div>
          <!-- æ•°é‡å¾½ç« ï¼šæ•´ä¸ªå¡ç‰Œçš„å³ä¸Šè§’ï¼Œéƒ¨åˆ†åœ¨å¡ç‰Œå¤– -->
          <div class="amount-badge" style="position: absolute; top: -10px; right: -8px; background-color: white; border: 2px solid #5D4037; border-radius: 12px; padding: 3px 8px; font-size: 0.75rem; font-weight: bold; color: #5D4037; min-width: 22px; text-align: center; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            ${resource.amount}
          </div>
          <div class="card-image" style="background-image: url('${displayImage}'); background-size: cover; background-position: center; position: relative; height: 95px; width: 85px; margin: 0 auto; display: block; align-self: center;">
            <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
            <div class="image-fallback" style="display: none; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
            <!-- è€ä¹…åº¦æ¡ - ç«–ç€æ˜¾ç¤ºåœ¨å›¾é’‰æŒ‰é’®æ­£ä¸‹æ–¹ -->
            ${resource.durability !== undefined ? `
              <div class="card-durability" style="position: absolute; right: 4px; top: 34px; width: 4px; height: 45px; background-color: #E2E8F0; border-radius: 2px; overflow: hidden; z-index: 10;">
                <div class="durability-bar" style="width: 100%; height: ${resource.durability}%; background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'}; position: absolute; left: 0; bottom: 0; border-radius: 0 0 2px 2px; transition: height 0.3s ease;"></div>
              </div>
            ` : ''}
            <!-- å›¾é’‰æŒ‰é’® -->
            <div class="pin-button ${resource.pinned ? 'pinned' : ''}" style="position: absolute; top: 4px; right: 4px; background-color: ${resource.pinned ? '#38A169' : '#CBD5E0'}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 100; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); pointer-events: auto; transition: all 0.2s ease; user-select: none;">
              ğŸ“Œ
            </div>
            ${resource.equipped ? `
              <div class="equipped-badge" style="position: absolute; bottom: 0.25rem; right: 0.25rem; background-color: #38A169; color: white; border-radius: 4px; padding: 0.1rem 0.3rem; font-size: 0.6rem; font-weight: normal; font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); z-index: 10;">
                å·²ç©¿æˆ´
              </div>
            ` : ''}
            ${id === 'fire' ? `
              <div class="fuel-indicator" style="position: absolute; top: 0.25rem; left: 0.25rem; background-color: rgba(220, 38, 38, 0.9); color: white; border-radius: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.9rem; font-weight: bold;">
                ${resource.fuel || 0}%
              </div>
            ` : ''}
            ${((id === 'bucket' || id === 'bucket_with_water' || id === 'empty_bucket') && resource.waterLevel !== undefined) ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${Array.from({length: 5}, (_, i) => {
                  const isFilled = i >= (5 - Math.floor((resource.waterLevel || 0) / 50));
                  return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                }).join('')}
              </div>
            ` : ''}
            ${((id === 'water_bag' || id === 'water_bag_with_water' || id === 'empty_water_bag') && resource.waterLevel !== undefined) ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${Array.from({length: 5}, (_, i) => {
                  const isFilled = i >= (5 - Math.floor((resource.waterLevel || 0) / 20));
                  return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                }).join('')}
              </div>
            ` : ''}
          </div>
        `;

elements.resourceGrid.appendChild(resourceCard);

        // ä¸ºæ—¶æ•ˆæ€§é£Ÿç‰©æ·»åŠ å€’è®¡æ—¶æ˜¾ç¤º
        // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„èµ„æºå®šä¹‰ï¼ˆä»å…¨å±€gameData.resourcesè·å–ï¼‰
        const actualResource = gameData.resources[actualResourceId];
        if (actualResource && actualResource.isPerishable && actualResource.expirationDays && resource.amount > 0) {
          const expiryInfo = document.createElement('div');
          expiryInfo.className = 'expiry-timer';

          // åœ°é¢æ é£Ÿç‰©æ²¡æœ‰æ‰¹æ¬¡ä¿¡æ¯ï¼Œä½¿ç”¨å½“å‰æ—¶é—´è®¡ç®—è¿‡æœŸæ—¶é—´
          const currentTimeInMinutes = Math.floor(Date.now() / 60000);
          const obtainTimeInMinutes = currentTimeInMinutes; // åœ°é¢é£Ÿç‰©é»˜è®¤ä»å½“å‰æ—¶é—´å¼€å§‹è®¡ç®—
          const expirationTimeInMinutes = obtainTimeInMinutes + (actualResource.expirationDays * 24 * 60);
          const remainingTimeInMinutes = expirationTimeInMinutes - currentTimeInMinutes;

          if (remainingTimeInMinutes > 0) {
            // è½¬æ¢ä¸ºå‰©ä½™æ—¶é—´å¯¹è±¡
            const remainingTime = {
              totalMinutes: remainingTimeInMinutes,
              days: Math.floor(remainingTimeInMinutes / (24 * 60)),
              hours: Math.floor((remainingTimeInMinutes % (24 * 60)) / 60),
              minutes: remainingTimeInMinutes % 60
            };

            expiryInfo.textContent = formatRemainingTime(remainingTime);

            // å¦‚æœå‰©ä½™æ—¶é—´å°äº60åˆ†é’Ÿï¼Œæ·»åŠ è­¦å‘Šæ ·å¼ï¼ˆçº¢è‰²å¾½ç« å¸¦è„‰å†²åŠ¨ç”»ï¼‰
            if (remainingTime.totalMinutes < 60) {
              expiryInfo.classList.add('warning');
            }
          } else {
            expiryInfo.textContent = 'è¿‡æœŸ';
            expiryInfo.classList.add('warning');
          }

          resourceCard.appendChild(expiryInfo);
        }

        // æ·»åŠ å›¾é’‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const pinButton = resourceCard.querySelector('.pin-button');
        if (pinButton) {
          pinButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¡ç‰Œç‚¹å‡»äº‹ä»¶
            e.stopImmediatePropagation(); // é˜»æ­¢å…¶ä»–äº‹ä»¶å¤„ç†ç¨‹åº
            console.log('å›¾é’‰æŒ‰é’®è¢«ç‚¹å‡»ï¼Œèµ„æºID:', id);
            togglePinResource(id);
            return false; // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
          }, true); // ä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿æœ€å…ˆå¤„ç†
        }

// å®Œå…¨é‡å†™çš„å›¾ç‰‡åŠ è½½æœºåˆ¶ï¼Œä¿®å¤å¼‚æ­¥é—®é¢˜å’Œæ·»åŠ æ›´å¤šå®¹é”™
        const imgUrl = displayImage;
        const img = new Image();

// ç«‹å³è®¾ç½®åˆå§‹å›¾ç‰‡è·¯å¾„ï¼ˆä¸å†ç­‰å¾…åŠ è½½æˆåŠŸï¼‰
        const cardImage = resourceCard.querySelector('.card-image');
        const fallback = resourceCard.querySelector('.image-fallback');

// ç›´æ¥è®¾ç½®èƒŒæ™¯å›¾ç‰‡ï¼Œè¿™æ ·å³ä½¿åŠ è½½å¤±è´¥ï¼Œåç»­ä»£ç ä»ä¼šå°è¯•ä¿®å¤
        cardImage.style.backgroundImage = `url('${imgUrl}')`;

// å°è¯•åŠ è½½å›¾ç‰‡
        img.onload = function() {
          console.log(`èƒŒåŒ…èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½æˆåŠŸ: ${imgUrl}`);
          if (fallback) fallback.style.display = 'none';
        };
        img.onerror = function() {
          console.log(`èƒŒåŒ…èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½å¤±è´¥: ${imgUrl}`);
          if (fallback) fallback.style.display = 'flex';
        };
        img.src = imgUrl;

// ä¸ºè£…å¤‡ç±»èµ„æºæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (resource.category === 'equipment') {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (resource.equipped) {
              // å¦‚æœå·²è£…å¤‡ï¼Œåˆ™å¸ä¸‹
              unequipItem(resource.equipmentSlot, id);
            } else {
              // å¦‚æœæœªè£…å¤‡ï¼Œåˆ™è£…å¤‡
              equipItem(id);
            }
          });
          
          // æ·»åŠ è£…å¤‡æ ·å¼çš„å…‰æ ‡æç¤º
          resourceCard.style.cursor = 'pointer';
          resourceCard.title = resource.name + (resource.equipped ? '\nç‚¹å‡»å¸ä¸‹' : '\nç‚¹å‡»è£…å¤‡');
        }

        // ä¸ºæ°´è¢‹å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (id === 'water_bag' || id === 'water_bag_with_water' || id === 'empty_water_bag') {
          resourceCard.addEventListener('click', function() {
            showWaterBagConfirmWindow(actualResourceId);
          });
        }

        // ä¸ºæœ¨æ¡¶å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (id === 'bucket' || id === 'bucket_with_water' || id === 'empty_bucket') {
          resourceCard.addEventListener('click', function() {
            showBucketConfirmWindow(actualResourceId);
          });
        }

        // ä¸ºé£Ÿç‰©ç±»èµ„æºæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (resource.category === 'food') {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            consumeFood(actualResourceId);
          });
          resourceCard.style.cursor = 'pointer';
          resourceCard.title = resource.name + '\nç‚¹å‡»é£Ÿç”¨';
        }

        // ä¸ºå…¶ä»–æ¶ˆè€—å“æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚è¯ä¸¸ç­‰ï¼‰
        if (resource.type === 'consumable' && resource.category !== 'food') {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            handleResourceClick(actualResourceId);
          });
          resourceCard.style.cursor = 'pointer';
          resourceCard.title = resource.name + '\nç‚¹å‡»ä½¿ç”¨';
        }

        // ä¸ºå†°å—æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆåœ¨å†°çª–çª—å£æ‰“å¼€æ—¶æ·»åŠ åˆ°å†°çª–ï¼‰
        if (resource.isIceBlock) {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // æ£€æŸ¥å†°çª–çª—å£æ˜¯å¦æ‰“å¼€
            const icehouseModal = document.getElementById('icehouseModal');
            if (icehouseModal && icehouseModal.classList.contains('active')) {
              handleAddIceBlock(resource.amount);
            } else {
              handleResourceClick(actualResourceId);
            }
          });
          resourceCard.style.cursor = 'pointer';
          resourceCard.title = resource.name + '\nç‚¹å‡»ä½¿ç”¨ï¼ˆå†°çª–çª—å£æ‰“å¼€æ—¶å¯æ·»åŠ åˆ°å†°çª–ï¼‰';
        }
        
        // ä¸ºç¯ç«å¡ç‰Œæ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬å™¨
        if (id === 'fire') {
          // æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬å™¨
          resourceCard.addEventListener('dragover', function(e) {
            e.preventDefault();
            // æ£€æŸ¥æ‹–æ‹½çš„ç‰©å“æ˜¯å¦ä¸ºç”Ÿé£Ÿæˆ–æœ¨æ£
            const draggedId = e.dataTransfer.getData('text/plain');
            if (canCookWithFire(draggedId) || draggedId === 'stick') {
              resourceCard.style.boxShadow = '0 0 15px rgba(128, 90, 213, 0.8)';
              resourceCard.style.transform = 'scale(1.05)';
            }
          });
          
          resourceCard.addEventListener('dragleave', function(e) {
            resourceCard.style.boxShadow = '';
            resourceCard.style.transform = '';
          });
          
          resourceCard.addEventListener('drop', function(e) {
            e.preventDefault();
            resourceCard.style.boxShadow = '';
            resourceCard.style.transform = '';
            
            const draggedId = e.dataTransfer.getData('text/plain');
            if (canCookWithFire(draggedId)) {
              cookWithFire(draggedId);
            } else if (draggedId === 'stick') {
              // æ·»åŠ ç‡ƒæ–™åŠŸèƒ½
              addFuelToFire();
            }
          });
        }
        
        // ä¸ºç¯ç«å¡ç‰Œæ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬å™¨
        if (id === 'fire' && resource && resource.fuel !== undefined && resource.fuel <= 0) {
          // æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬å™¨
          resourceCard.addEventListener('dragover', function(e) {
            e.preventDefault();
            // æ£€æŸ¥æ‹–æ‹½çš„ç‰©å“æ˜¯å¦ä¸ºç‡§çŸ³
            const draggedId = e.dataTransfer.getData('text/plain');
            if (draggedId === 'flint') {
              resourceCard.style.boxShadow = '0 0 15px rgba(255, 128, 0, 0.8)';
              resourceCard.style.transform = 'scale(1.05)';
            }
          });
          
          resourceCard.addEventListener('dragleave', function(e) {
            resourceCard.style.boxShadow = '';
            resourceCard.style.transform = '';
          });
          
          resourceCard.addEventListener('drop', function(e) {
            e.preventDefault();
            resourceCard.style.boxShadow = '';
            resourceCard.style.transform = '';
            
            const draggedId = e.dataTransfer.getData('text/plain');
            if (draggedId === 'flint') {
              // ç‚¹ç‡ƒç¯ç«åŠŸèƒ½
              relightFire();
            }
          });
        }

// å°è¯•åŠ è½½å›¾ç‰‡çš„å‡½æ•° - åŒæ­¥æ–¹å¼
        function tryLoadImageSync(url) {
          return new Promise((resolve) => {
            const testImg = new Image();
            testImg.onload = function() {
              console.log(`æˆåŠŸåŠ è½½å›¾ç‰‡: ${url} ä¸ºèµ„æº: ${resource.name}`);
              cardImage.style.backgroundImage = `url('${url}')`;
              if (fallback) fallback.style.display = 'none';
              resolve(true);
            };
            testImg.onerror = function() {
              console.log(`å°è¯•åŠ è½½å›¾ç‰‡å¤±è´¥: ${url}`);
              resolve(false);
            };
            testImg.src = url;
          });
        }

// å¤„ç†å›¾ç‰‡åŠ è½½å¤±è´¥çš„å‡½æ•°
        function handleImageLoadFailure() {
          console.log(`èµ„æº ${resource.name} çš„åŸå§‹å›¾ç‰‡ ${imgUrl} åŠ è½½å¤±è´¥ï¼Œå°è¯•å…¶ä»–è·¯å¾„...`);

// æ˜¾ç¤ºå¤‡ç”¨å†…å®¹
          if (fallback) {
            fallback.style.display = 'flex';
          }

// åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„è·¯å¾„å˜ä½“
          const allPossibleUrls = [];

// 1. è·å–åŸºç¡€ä¿¡æ¯
          const hasSlash = imgUrl.includes('/');
          let directory = '';
          let filename = imgUrl;
          let baseName = imgUrl;
          let extension = '';

// æå–ç›®å½•å’Œæ–‡ä»¶å
          if (hasSlash) {
            const lastSlashIndex = imgUrl.lastIndexOf('/');
            directory = imgUrl.substring(0, lastSlashIndex);
            filename = imgUrl.substring(lastSlashIndex + 1);
          }

// æå–åŸºç¡€åç§°å’Œæ‰©å±•å
          const lastDotIndex = filename.lastIndexOf('.');
          if (lastDotIndex > 0) {
            baseName = filename.substring(0, lastDotIndex);
            extension = filename.substring(lastDotIndex);
          }

// 2. å°è¯•ä¸åŒçš„æ–‡ä»¶æ‰©å±•å
          const possibleExtensions = ['.jpg', '.png', '.jpeg', '.gif'];
          possibleExtensions.forEach(ext => {
            if (directory) {
              allPossibleUrls.push(`${directory}/${baseName}${ext}`);
            } else {
              allPossibleUrls.push(`${baseName}${ext}`);
            }
          });

// 3. å¤§å°å†™å˜ä½“ - æ›´å…¨é¢çš„å®ç°
          const lowercaseFilename = filename.toLowerCase();
          const uppercaseFilename = filename.toUpperCase();
          const lowercaseDirectory = directory.toLowerCase();
          const uppercaseDirectory = directory.toUpperCase();

// æ·»åŠ æ‰€æœ‰å¯èƒ½çš„å¤§å°å†™ç»„åˆ
          if (directory) {
            allPossibleUrls.push(
              `${directory}/${lowercaseFilename}`,
              `${directory}/${uppercaseFilename}`,
              `${lowercaseDirectory}/${filename}`,
              `${uppercaseDirectory}/${filename}`,
              `${lowercaseDirectory}/${lowercaseFilename}`,
              `${uppercaseDirectory}/${uppercaseFilename}`
            );
          } else {
            allPossibleUrls.push(
              lowercaseFilename,
              uppercaseFilename
            );
          }

// 4. ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶å
          if (directory) {
            allPossibleUrls.push(`${directory}/${baseName}`);
          } else {
            allPossibleUrls.push(baseName);
          }

// 5. ç‰¹æ®Šå¤„ç†ï¼šæ£€æŸ¥èµ„æºåç§°ä¸æ–‡ä»¶åçš„ç›´æ¥å¯¹åº”
          // ç‰¹åˆ«æ˜¯é’ˆå¯¹"é»‘è‰²æ–—ç¯·"è¿™æ ·åç§°ä¸å›¾ç‰‡æ–‡ä»¶åä¸å®Œå…¨åŒ¹é…çš„æƒ…å†µ
          const resourceName = resource.name;
          allPossibleUrls.push(
            `UI/${resourceName}.jpg`,
            `UI/${resourceName}.png`,
            `UI/${resourceName}`
          );

// 6. æ£€æŸ¥"UIé«˜æ¸…ç‰ˆæœ¬"æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡
          if (baseName && directory === 'UI') {
            possibleExtensions.forEach(ext => {
              allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${baseName}${ext}`);
              allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${resourceName}${ext}`);
            });
            allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${baseName}`);
            allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${resourceName}`);
          }

// 7. å°è¯•åŸºç¡€æ–‡ä»¶åä¸èµ„æºåçš„å„ç§ç»„åˆ
          // ç‰¹åˆ«æ˜¯å¤„ç†"é»‘è‰²æ–—ç¯·"å¯¹åº”"é»‘è¡£æ–—ç¯·.jpg"çš„æƒ…å†µ
          const variations = [
            resourceName.replace(/é»‘è‰²/, 'é»‘è¡£'),  // é»‘è‰²æ–—ç¯· -> é»‘è¡£æ–—ç¯·
            resourceName.replace(/é»‘è¡£/, 'é»‘è‰²'),  // åå‘è½¬æ¢
            resourceName.replace(/ç ´/, ''),        // ç§»é™¤"ç ´"å­—
            resourceName.replace(/ /g, '')         // ç§»é™¤ç©ºæ ¼
          ];

variations.forEach(variation => {
            possibleExtensions.forEach(ext => {
              if (variation && variation !== resourceName) {
                allPossibleUrls.push(`UI/${variation}${ext}`);
              }
            });
          });

// å»é‡
          const uniqueUrls = [...new Set(allPossibleUrls)];

// å°è¯•æ‰€æœ‰å¯èƒ½çš„URLï¼ˆåŒæ­¥æ–¹å¼ï¼‰
          function tryNextUrl(index) {
            if (index >= uniqueUrls.length) {
              console.log(`å°è¯•äº†æ‰€æœ‰å¯èƒ½çš„URLï¼Œä»æ— æ³•åŠ è½½èµ„æº ${resource.name} çš„å›¾ç‰‡`);
              return;
            }

const url = uniqueUrls[index];
            tryLoadImageSync(url).then(success => {
              if (success) {
                console.log(`æˆåŠŸé€šè¿‡å¤‡ç”¨è·¯å¾„åŠ è½½å›¾ç‰‡: ${url}`);
              } else {
                tryNextUrl(index + 1); // å°è¯•ä¸‹ä¸€ä¸ªURL
              }
            });
          }

// å¼€å§‹å°è¯•å¤‡ç”¨URLs
          tryNextUrl(0);
        }

// è®¾ç½®å›¾ç‰‡åŠ è½½äº‹ä»¶
        img.onload = function() {
          console.log(`èµ„æº ${resource.name} çš„å›¾ç‰‡åŠ è½½æˆåŠŸ`);
          if (fallback) fallback.style.display = 'none';
        };

// è®¾ç½®å›¾ç‰‡åŠ è½½å¤±è´¥äº‹ä»¶
        img.onerror = function() {
          handleImageLoadFailure();
        };

// è§¦å‘å›¾ç‰‡åŠ è½½
        img.src = imgUrl;
      }
      
      // æ›´æ–°æ»šåŠ¨æ¡çŠ¶æ€
      updateScrollBar();
    }

    // æ›´æ–°ä¸»é¡µèƒŒåŒ…æ ä¸­çš„ç‰¹å®šèµ„æºå¡ç‰Œ
    function updateMainResourceCard(resourceId) {
      console.log('updateMainResourceCard è¢«è°ƒç”¨ï¼Œèµ„æºID:', resourceId);
      const resourceCard = document.querySelector(`.resource-card[data-resource="${resourceId}"]`);
      console.log('æ‰¾åˆ°çš„å¡ç‰Œå…ƒç´ :', resourceCard);
      
      if (resourceCard && gameData.resources[resourceId]) {
        const resource = gameData.resources[resourceId];
        console.log('èµ„æºæ•°æ®:', resource);
        
        // æ›´æ–°å¡ç‰Œæ ‡é¢˜ä¸­çš„æ•°é‡æ˜¾ç¤º
        const titleElement = resourceCard.querySelector('.card-title');
        console.log('æ‰¾åˆ°çš„æ ‡é¢˜å…ƒç´ :', titleElement);
        
        if (titleElement) {
          // æ³¨æ„ï¼šåŸå§‹åˆ›å»ºæ—¶ä½¿ç”¨çš„æ˜¯ 'x' è€Œä¸æ˜¯ ' Ã— '
          titleElement.textContent = `${resource.name}x${resource.amount}`;
          console.log('æ›´æ–°åçš„æ ‡é¢˜æ–‡æœ¬:', titleElement.textContent);
        }
        
        // æ›´æ–°å›¾é’‰çŠ¶æ€
        const pinButton = resourceCard.querySelector('.pin-button');
        if (pinButton) {
          if (resource.pinned) {
            pinButton.classList.add('pinned');
            pinButton.style.backgroundColor = '#38A169';
          } else {
            pinButton.classList.remove('pinned');
            pinButton.style.backgroundColor = '#CBD5E0';
          }
        }
        
        // æ›´æ–°è€ä¹…åº¦æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
        if (resource.durability !== undefined) {
          const durabilityBar = resourceCard.querySelector('.durability-bar');
          const durabilityText = resourceCard.querySelector('.durability-text');
          if (durabilityBar) {
            durabilityBar.style.width = `${resource.durability}%`;
            durabilityBar.style.backgroundColor = resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E';
          }
          if (durabilityText) {
            durabilityText.textContent = `${resource.durability}%`;
          }
        }
        
        // æ›´æ–°ç‡ƒæ–™æ˜¾ç¤ºï¼ˆå¦‚æœæ˜¯ç¯ç«ï¼‰
        if (resourceId === 'fire' && resource.fuel !== undefined) {
          const fuelIndicator = resourceCard.querySelector('.fuel-indicator');
          if (fuelIndicator) {
            fuelIndicator.textContent = `${resource.fuel || 0}%`;
          }
        }
        
        // æ›´æ–°è£…å¤‡çŠ¶æ€æ˜¾ç¤º
        const equippedBadge = resourceCard.querySelector('.equipped-badge');
        if (equippedBadge) {
          if (resource.equipped) {
            equippedBadge.style.display = 'block';
          } else {
            equippedBadge.style.display = 'none';
          }
        }
      }
    }



    // æ·»åŠ åœ°é¢åˆ†ç±»åˆ‡æ¢äº‹ä»¶
    function setupGroundCategoryTabs() {
        document.querySelectorAll('.ground-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                groundCurrentCategory = tab.dataset.category;
                renderGroundResources();
            });
        });
    }

// æ·»åŠ æ»šåŠ¨æ¡äº‹ä»¶
    function setupScrollBar() {
        const resourceGrid = document.getElementById('resourceGrid');

        // ç›‘å¬èµ„æºç½‘æ ¼çš„æ»šåŠ¨äº‹ä»¶ï¼Œæ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        if (resourceGrid) {
            resourceGrid.addEventListener('scroll', updateScrollBar);
        }
    }

// æ›´æ–°æ»šåŠ¨æ¡çŠ¶æ€
    // ç¼“å­˜DOMå…ƒç´ å¼•ç”¨ï¼Œæé«˜æ€§èƒ½
    let cachedResourceGrid = null;
    let cachedScrollBar = null;
    let cachedScrollBarThumb = null;

    function updateScrollBar() {
        // ä½¿ç”¨ç¼“å­˜çš„å…ƒç´ å¼•ç”¨ï¼Œé¿å…æ¯æ¬¡æ»šåŠ¨éƒ½æŸ¥è¯¢DOM
        if (!cachedResourceGrid) {
            cachedResourceGrid = document.getElementById('resourceGrid');
        }
        if (!cachedScrollBar) {
            cachedScrollBar = document.querySelector('.resource-scrollbar');
        }
        if (!cachedScrollBarThumb) {
            cachedScrollBarThumb = document.querySelector('.resource-scrollbar-thumb');
        }

        if (cachedResourceGrid && cachedScrollBar && cachedScrollBarThumb) {
            const maxScrollLeft = cachedResourceGrid.scrollWidth - cachedResourceGrid.clientWidth;
            if (maxScrollLeft > 0) {
                const scrollPercent = cachedResourceGrid.scrollLeft / maxScrollLeft;
                const thumbWidth = cachedScrollBar.clientWidth * (cachedResourceGrid.clientWidth / cachedResourceGrid.scrollWidth);

                cachedScrollBarThumb.style.width = `${thumbWidth}px`;
                cachedScrollBarThumb.style.left = `${scrollPercent * (cachedScrollBar.clientWidth - thumbWidth)}px`;
            }
        }
    }

    // è·å–åœ°ç‚¹åœ¨åœ°å›¾ä¸Šçš„å›ºå®šåæ ‡
    function generateLocationCoordinates(locationId) {
      // 8ä¸ªåœ°ç‚¹çš„é¢„è®¾åæ ‡ç‚¹
      const locationCoordinates = {
        'street': { x: 350, y: 150 },     // ä¸œè¥¿å¸‚ï¼Œä¸­å·¦ä¾§ä¸Šéƒ¨
        'temple': { x: 450, y: 100 },      // ä¸‡ä½›å¯ºï¼ŒåŒ—ä¾§ä¸­å¿ƒ
        'rich_area': { x: 650, y: 250 },   // é”£é¼“å··ï¼Œå³ä¾§åä¸Š
        'black_market': { x: 620, y: 450 }, // é»‘å¸‚ï¼Œå³ä¾§åä¸‹
        'slum': { x: 650, y: 100 },       // é¸¡æ¯›æˆ¿ï¼Œå³ä¾§ä¸Šéƒ¨
        'dump': { x: 200, y: 100 },       // ç°å‘ï¼Œå·¦ä¾§ä¸Šéƒ¨
        'prison': { x: 600, y: 300 },     // ç‰¢æˆ¿ï¼Œå³ä¾§ä¸­éƒ¨
        'wilderness': { x: 150, y: 300 }   // åŸå¤–å±±é‡ï¼Œå·¦ä¾§ä¸­éƒ¨
      };
      
      // è¿”å›å¯¹åº”åœ°ç‚¹çš„åæ ‡ï¼Œå¦‚æœæœªå®šä¹‰åˆ™è¿”å›é»˜è®¤ä¸­å¿ƒåæ ‡
      return locationCoordinates[locationId] || { x: 450, y: 300 };
    }

    // åˆ›å»ºåœ°å›¾ä¸Šçš„åœ°ç‚¹å¡ç‰Œ
    function createMapLocationCard(location) {
      const locationCard = document.createElement('div');
      locationCard.className = `map-location-card ${location.currentLocation ? 'current' : ''}`;
      locationCard.setAttribute('data-location', location.id);
      
      // å¦‚æœè¯¥åœ°ç‚¹è¿˜æ²¡æœ‰åæ ‡ï¼Œåˆ™ç”Ÿæˆéšæœºåæ ‡
      if (!location.mapCoordinates) {
        location.mapCoordinates = generateLocationCoordinates(location.id);
      }
      
      // è®¾ç½®å¡ç‰Œä½ç½®
      locationCard.style.left = `${location.mapCoordinates.x}px`;
      locationCard.style.top = `${location.mapCoordinates.y}px`;
      
      // è®¾ç½®å¡ç‰Œå†…å®¹
      locationCard.innerHTML = `${location.name}`;
      
      return locationCard;
    }

    // åˆ›å»ºåœ°ç‚¹å¡ç‰Œï¼ˆç”¨äºä¸»ç•Œé¢ï¼‰
    function createLocationCard(location) {
      const locationCard = document.createElement('div');
      locationCard.className = `card location location-card ${location.currentLocation ? 'current' : ''}`;
      locationCard.setAttribute('data-location', location.id);
      
      // å¯¹äºä¸‡ä½›å¯ºï¼Œä¸æ˜¾ç¤ºæ˜æ˜¾æ ‡è¯†
      const showLocationIcon = location.id !== 'temple';
      
      locationCard.innerHTML = `
        <div class="card-content">
          <div class="card-title map-card-title">${location.name}</div>
        </div>
      `;
      
      return locationCard;
    }

    // æ¸²æŸ“åœ°é¢èµ„æº
    function renderGroundResources() {
      const groundGrid = elements.groundGrid;
      if (!groundGrid) return;

      // æ¸…ç©ºåœ°é¢ç½‘æ ¼ - å½»åº•æ¸…ç©º
      groundGrid.innerHTML = '';
      groundGrid.style.display = 'none';

      // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜
      void groundGrid.offsetHeight;

      groundGrid.style.display = '';

      // è·å–å½“å‰åœºæ™¯ID
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      if (!currentLocation) {
        console.log('renderGroundResources: æœªæ‰¾åˆ°å½“å‰åœºæ™¯');
        return;
      }
      const locationId = currentLocation.id;

      console.log(`renderGroundResources: å½“å‰åœºæ™¯ID = ${locationId}, åœ°é¢èµ„æº =`, gameData.groundResources[locationId]);

      // åˆå§‹åŒ–å½“å‰åœºæ™¯çš„åœ°é¢èµ„æºæ•°ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      if (!gameData.groundResources[locationId]) {
        gameData.groundResources[locationId] = [];
      }

      // æ›´æ–°åœ°é¢åˆ†ç±»æ ‡ç­¾æ ·å¼
      document.querySelectorAll('.ground-tab').forEach(tab => {
          // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„èƒŒæ™¯è‰²ç±»å’Œå¼ºè°ƒæ ·å¼
          tab.classList.remove('bg-purple-600', 'bg-green-600', 'bg-blue-600', 'bg-yellow-600', 'bg-gray-100', 'text-white', 'text-gray-600', 'border-purple-700', 'border-green-700', 'border-blue-700', 'border-yellow-700');

// é‡ç½®å†…è”æ ·å¼
          tab.style.borderWidth = '';
          tab.style.fontWeight = '';
          tab.style.boxShadow = '';
          tab.style.transform = '';
          tab.style.backgroundColor = '';
          tab.style.color = '';

if (tab.dataset.category === groundCurrentCategory) {
              tab.classList.add('active');
              // é€‰ä¸­çš„æ ‡ç­¾ä½¿ç”¨ç´«è‰²èƒŒæ™¯å’Œç™½è‰²åŠ ç²—æ–‡å­—
              tab.classList.add('bg-purple-600', 'text-white', 'border-purple-700');
              // æ·»åŠ å¼ºè°ƒæ•ˆæœï¼Œä½¿ç”¨!importantç¡®ä¿è¦†ç›–å†…è”æ ·å¼
              tab.style.setProperty('border-width', '2px', 'important');
              tab.style.setProperty('font-weight', 'bold', 'important');
              tab.style.setProperty('box-shadow', '0 2px 4px rgba(0, 0, 0, 0.2)', 'important');
              tab.style.setProperty('transform', 'translateY(-1px) scale(1.05)', 'important');
              tab.style.setProperty('background-color', '#805AD5', 'important');
              tab.style.setProperty('color', 'white', 'important');
              tab.style.transition = 'all 0.2s ease';
          } else {
              tab.classList.remove('active');
              // æœªé€‰ä¸­çš„æ ‡ç­¾ä½¿ç”¨èƒŒæ™¯è‰²ä½œä¸ºå­—ä½“é¢œè‰²ï¼Œå­—ä½“ä¸åŠ ç²—
              tab.style.setProperty('background-color', '#F7FAFC', 'important');
              tab.style.setProperty('color', '#F7FAFC', 'important');
              tab.style.setProperty('font-weight', 'normal', 'important');
              tab.classList.add('text-gray-600');
          }
      });

      // åªæ˜¾ç¤ºå½“å‰åœºæ™¯çš„åœ°é¢èµ„æºï¼Œå¹¶æŒ‰åˆ†ç±»ç­›é€‰
      for (const groundItem of gameData.groundResources[locationId]) {
        const { resourceId, resource, amount = 1 } = groundItem;

        // æ ¹æ®å½“å‰åˆ†ç±»ç­›é€‰èµ„æº
        if (groundCurrentCategory !== 'all' && resource.category !== groundCurrentCategory) {
          continue;
        }
        const resourceCard = document.createElement('div');
        resourceCard.className = `card resource resource-card ${resource.pinned ? 'pinned' : ''}`;
        resourceCard.setAttribute('draggable', 'true');
        resourceCard.setAttribute('data-resource', resourceId);
        resourceCard.setAttribute('data-ground-index', gameData.groundResources[locationId].indexOf(groundItem));
        resourceCard.setAttribute('data-amount', amount);

        // å¤„ç†å›¾ç‰‡å’Œåç§° - ä½¿ç”¨updateContainerImageæ¥ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„å›¾ç‰‡
        // å…ˆç¡®ä¿å®¹å™¨çš„å›¾ç‰‡æ˜¯æœ€æ–°çš„
        if (resourceId === 'bucket' || resourceId === 'water_bag' || resourceId === 'empty_water_bag') {
          // åœ¨æ¸²æŸ“å‰æ›´æ–°å®¹å™¨å›¾ç‰‡ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„å›¾ç‰‡
          const containerType = resourceId === 'empty_water_bag' ? 'water_bag' : resourceId;
          updateContainerImage(containerType);
        }

        let displayImage = resource.image;
        let displayName = resource.name;

        // æœ¨æ¡¶å’Œæ°´è¢‹çš„å›¾ç‰‡å¤„ç†
        if (resourceId === 'bucket') {
          const waterLevel = getContainerTotalWater('bucket');
          if (waterLevel > 0) {
            displayImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            displayImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
          }
          displayName = 'æœ¨æ¡¶';
        } else if (resourceId === 'water_bag' || resourceId === 'empty_water_bag') {
          const waterLevel = getContainerTotalWater('water_bag');
          if (waterLevel > 0) {
            displayImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            displayImage = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
          }
          displayName = 'æ°´è¢‹';
        }

        resourceCard.innerHTML = `
          <div class="card-content">
            <div class="card-title">${displayName}</div>
          </div>
          <!-- æ•°é‡å¾½ç« ï¼šæ•´ä¸ªå¡ç‰Œçš„å³ä¸Šè§’ï¼Œéƒ¨åˆ†åœ¨å¡ç‰Œå¤– -->
          <div class="amount-badge" style="position: absolute; top: -10px; right: -8px; background-color: white; border: 2px solid #5D4037; border-radius: 12px; padding: 3px 8px; font-size: 0.75rem; font-weight: bold; color: #5D4037; min-width: 22px; text-align: center; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            ${amount}
          </div>
          <div class="card-image" style="background-image: url('${displayImage}'); background-size: cover; background-position: center; position: relative; height: 95px; width: 85px; margin: 0 auto; display: block; align-self: center;">
            <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
            <div class="image-fallback" style="display: none; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
            <!-- è€ä¹…åº¦æ¡ - ç«–ç€æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸Š -->
            ${resource.durability !== undefined ? `
              <div class="card-durability" style="position: absolute; right: 4px; top: 34px; width: 4px; height: 45px; background-color: #E2E8F0; border-radius: 2px; overflow: hidden; z-index: 10;">
                <div class="durability-bar" style="width: 100%; height: ${resource.durability}%; background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'}; position: absolute; left: 0; bottom: 0; border-radius: 0 0 2px 2px; transition: height 0.3s ease;"></div>
              </div>
            ` : ''}
            <!-- å›¾é’‰æŒ‰é’® - ä¸èƒŒåŒ…æ ä¿æŒä¸€è‡´ -->
            <div class="pin-button ${resource.pinned ? 'pinned' : ''}" data-resource="${resourceId}" style="position: absolute; top: 4px; right: 4px; background-color: ${resource.pinned ? '#38A169' : '#CBD5E0'}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 100; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); pointer-events: auto; transition: all 0.2s ease; user-select: none;">
              ğŸ“Œ
            </div>
            ${resource.equipped ? `
              <div class="equipped-badge" style="position: absolute; bottom: 0.25rem; right: 0.25rem; background-color: #38A169; color: white; border-radius: 4px; padding: 0.1rem 0.3rem; font-size: 0.6rem; font-weight: normal; font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); z-index: 10;">
                å·²ç©¿æˆ´
              </div>
            ` : ''}
            ${resourceId === 'fire' ? `
              <div class="fuel-indicator" style="position: absolute; top: 0.25rem; left: 0.25rem; background-color: rgba(220, 38, 38, 0.9); color: white; border-radius: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.9rem; font-weight: bold;">
                ${resource.fuel || 0}%
              </div>
            ` : ''}
            ${resourceId === 'bucket' ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${(() => {
                  const waterLevel = getContainerTotalWater('bucket');
                  return Array.from({length: 5}, (_, i) => {
                    const isFilled = i >= (5 - Math.floor(waterLevel / 50));
                    return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                  }).join('');
                })()}
              </div>
            ` : ''}
            ${(resourceId === 'water_bag' || resourceId === 'empty_water_bag') ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${(() => {
                  const waterLevel = getContainerTotalWater('water_bag');
                  return Array.from({length: 5}, (_, i) => {
                    const isFilled = i >= (5 - Math.floor(waterLevel / 20));
                    return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                  }).join('');
                })()}
              </div>
            ` : ''}
          </div>
        `;

        groundGrid.appendChild(resourceCard);

        // ä¸ºæ—¶æ•ˆæ€§é£Ÿç‰©æ·»åŠ å€’è®¡æ—¶æ˜¾ç¤º
        // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„èµ„æºå®šä¹‰ï¼ˆä»å…¨å±€gameData.resourcesè·å–ï¼‰
        // ä½†æ®‹ç¾¹å‰©é¥­åœ¨åœ°é¢æ ä¸æ˜¾ç¤ºæ—¶æ•ˆæœŸ
        const actualResource = gameData.resources[resourceId];
        // æ£€æŸ¥åœ°é¢èµ„æºçš„æ•°é‡è€Œä¸æ˜¯èƒŒåŒ…ä¸­çš„æ•°é‡
        if (actualResource && actualResource.isPerishable && actualResource.expirationDays && amount > 0) {
          const expiryInfo = document.createElement('div');
          expiryInfo.className = 'expiry-timer';

          // åœ°é¢æ é£Ÿç‰©ä½¿ç”¨æ¸¸æˆæ—¶é—´è®¡ç®—è¿‡æœŸæ—¶é—´
          const currentTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
          // åœ°é¢é£Ÿç‰©éœ€è¦ä»æ”¾ç½®æ—¶é—´è®¡ç®—ï¼Œå¦‚æœæ²¡æœ‰æ”¾ç½®æ—¶é—´è®°å½•ï¼Œåˆ™ä½¿ç”¨å½“å‰æ—¶é—´
          const obtainTimeInMinutes = groundItem.obtainTime || currentTimeInMinutes;
          const expirationTimeInMinutes = obtainTimeInMinutes + (actualResource.expirationDays * 24 * 60);
          const remainingTimeInMinutes = Math.max(0, expirationTimeInMinutes - currentTimeInMinutes);

          if (remainingTimeInMinutes > 0) {
            // è½¬æ¢ä¸ºå‰©ä½™æ—¶é—´å¯¹è±¡
            const remainingTime = {
              totalMinutes: remainingTimeInMinutes,
              days: Math.floor(remainingTimeInMinutes / (24 * 60)),
              hours: Math.floor((remainingTimeInMinutes % (24 * 60)) / 60),
              minutes: remainingTimeInMinutes % 60
            };

            expiryInfo.textContent = formatRemainingTime(remainingTime);

            // å¦‚æœå‰©ä½™æ—¶é—´å°äº60åˆ†é’Ÿï¼Œæ·»åŠ è­¦å‘Šæ ·å¼ï¼ˆçº¢è‰²å¾½ç« å¸¦è„‰å†²åŠ¨ç”»ï¼‰
            if (remainingTime.totalMinutes < 60) {
              expiryInfo.classList.add('warning');
            }
          } else {
            expiryInfo.textContent = 'è¿‡æœŸ';
            expiryInfo.classList.add('warning');
          }

          resourceCard.appendChild(expiryInfo);
        }

        // å›¾ç‰‡åŠ è½½å¤„ç†é€»è¾‘ - ä¸èƒŒåŒ…æ ä¿æŒä¸€è‡´
        const imgUrl = displayImage;
        const cardImage = resourceCard.querySelector('.card-image');
        const fallback = resourceCard.querySelector('.image-fallback');

        // ç›´æ¥è®¾ç½®èƒŒæ™¯å›¾ç‰‡
        cardImage.style.backgroundImage = `url('${imgUrl}')`;

        // å°è¯•åŠ è½½å›¾ç‰‡
        const img = new Image();
        img.onload = function() {
          console.log(`åœ°é¢èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½æˆåŠŸ: ${imgUrl}`);
          if (fallback) fallback.style.display = 'none';
        };
        img.onerror = function() {
          console.log(`åœ°é¢èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½å¤±è´¥: ${imgUrl}`);
          if (fallback) fallback.style.display = 'flex';
        };
        img.src = imgUrl;

        // ä¸ºé£Ÿç‰©ç±»èµ„æºæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (resource.category === 'food') {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            consumeFood(resourceId);
          });
          resourceCard.style.cursor = 'pointer';
          resourceCard.title = resource.name + '\nç‚¹å‡»é£Ÿç”¨';
        }

        // ä¸ºæ°´è¢‹å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (resourceId === 'water_bag' || resourceId === 'empty_water_bag') {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showWaterBagConfirmWindow(resourceId);
          });
        }

        // ä¸ºæœ¨æ¡¶å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (resourceId === 'bucket') {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showBucketConfirmWindow(resourceId);
          });
        }

        // ä¸ºç¯ç«å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (resourceId === 'fire') {
          resourceCard.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            handleResourceClick(resourceId);
          });
        }
      }

      // æ›´æ–°åœ°é¢æ»šåŠ¨æ¡ - å»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMå·²å®Œå…¨æ¸²æŸ“
      setTimeout(() => {
        if (typeof updateGroundScrollBarIfNeeded === 'function') {
          updateGroundScrollBarIfNeeded();
        }
      }, 50);

      // åŠ è½½åœ°é¢æ å¡ç‰Œæ’åº
      if (currentLocation) {
        loadGroundItemOrder(currentLocation.id);
      }

      // åœ°é¢èµ„æºæ‹–æ‹½åŠŸèƒ½
      const groundCards = groundGrid.querySelectorAll('.resource-card');
      groundCards.forEach(card => {
        // æ·»åŠ å›ºå®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const pinButton = card.querySelector('.pin-button');
        if (pinButton) {
          pinButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¡ç‰Œç‚¹å‡»äº‹ä»¶
            e.stopImmediatePropagation(); // é˜»æ­¢å…¶ä»–äº‹ä»¶å¤„ç†ç¨‹åº
            const resourceId = pinButton.getAttribute('data-resource');
            console.log('åœ°é¢å¡ç‰Œå›¾é’‰æŒ‰é’®è¢«ç‚¹å‡»ï¼Œèµ„æºID:', resourceId);
            togglePinResource(resourceId);
            return false; // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
          }, true); // ä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿æœ€å…ˆå¤„ç†
        }

        // dragstart äº‹ä»¶
        card.addEventListener('dragstart', function(e) {
          const resourceId = card.getAttribute('data-resource');
          const resource = gameData.resources[resourceId];

          e.dataTransfer.setData('text/plain', resourceId);
          e.dataTransfer.effectAllowed = 'move';
          card.classList.add('dragging');
          groundIsDragging = true;

          e.dataTransfer.setData('source', 'ground');

          // ä¸´æ—¶éšè—åŸå¡ç‰Œçš„æ•°é‡å¾½ç« 
          const amountBadge = card.querySelector('.amount-badge');
          const originalDisplay = amountBadge ? amountBadge.style.display : null;
          const originalOpacity = card.style.opacity;
          const originalTransform = card.style.transform;
          
          if (amountBadge) {
            amountBadge.style.setProperty('display', 'none', 'important');
            amountBadge.style.visibility = 'hidden';
          }

          // ä¸´æ—¶æ¢å¤é€æ˜åº¦å’Œå˜å½¢ï¼Œç¡®ä¿æ‹–æ‹½å›¾åƒæ­£å¸¸æ˜¾ç¤º
          card.style.opacity = '1';
          card.style.transform = 'none';

          // å¼ºåˆ¶æµè§ˆå™¨é‡æ–°æ¸²æŸ“ï¼Œç¡®ä¿æ ·å¼å·²åº”ç”¨
          void card.offsetWidth;

          // ç¡®ä¿å›¾ç‰‡å·²åŠ è½½ï¼Œå¹¶ä½¿ç”¨imgæ ‡ç­¾ä½œä¸ºæ‹–æ‹½å›¾åƒ
          const cardImage = card.querySelector('.card-image');
          let dragImage = null;

          if (cardImage) {
            const backgroundImage = cardImage.style.backgroundImage;
            if (backgroundImage && backgroundImage !== 'none') {
              // æå–å›¾ç‰‡URL
              const match = backgroundImage.match(/url\(['"]?(.*?)['"]?\)/);
              if (match && match[1]) {
                const imgUrl = match[1];

                // åˆ›å»ºä¸€ä¸ªéšè—çš„imgæ ‡ç­¾ç”¨äºæ‹–æ‹½å›¾åƒ
                dragImage = new Image();
                dragImage.src = imgUrl;
                dragImage.style.width = '85px';
                dragImage.style.height = '95px';
                dragImage.style.objectFit = 'cover';
                dragImage.style.borderRadius = '4px';
                dragImage.style.border = '2px solid #5D4037';

                // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                if (dragImage.complete) {
                  console.log(`æ‹–æ‹½å›¾ç‰‡å·²åŠ è½½: ${imgUrl}, å®½: ${dragImage.width}, é«˜: ${dragImage.height}`);
                } else {
                  dragImage.onload = function() {
                    console.log(`æ‹–æ‹½å›¾ç‰‡åŠ è½½å®Œæˆ: ${imgUrl}, å®½: ${dragImage.width}, é«˜: ${dragImage.height}`);
                  };
                }
              }
            }
          }

          // ä½¿ç”¨requestAnimationFrameç¡®ä¿åœ¨æ­£ç¡®çš„æ—¶æœºè®¾ç½®æ‹–æ‹½å›¾åƒ
          requestAnimationFrame(() => {
            // å†æ¬¡å¼ºåˆ¶æµè§ˆå™¨é‡æ–°æ¸²æŸ“
            void card.offsetWidth;

            // ä½¿ç”¨imgæ ‡ç­¾ä½œä¸ºæ‹–æ‹½å›¾åƒï¼ˆæ›´å¯é ï¼‰
            if (dragImage) {
              e.dataTransfer.setDragImage(dragImage, 42, 47);
            } else {
              // å¦‚æœæ²¡æœ‰åˆ›å»ºimgæ ‡ç­¾ï¼Œä½¿ç”¨åŸå…ƒç´ 
              e.dataTransfer.setDragImage(card, 50, 60);
            }
          });

          // å»¶è¿Ÿæ¢å¤æ‰€æœ‰æ ·å¼
          setTimeout(() => {
            // æ¢å¤æ•°é‡å¾½ç« æ˜¾ç¤º
            if (amountBadge) {
              amountBadge.style.removeProperty('display');
              amountBadge.style.visibility = '';
              if (originalDisplay) {
                amountBadge.style.display = originalDisplay;
              }
            }
            // æ¢å¤é€æ˜åº¦å’Œå˜å½¢
            if (originalOpacity) {
              card.style.opacity = originalOpacity;
            } else {
              card.style.opacity = '';
            }
            if (originalTransform) {
              card.style.transform = originalTransform;
            } else {
              card.style.transform = '';
            }
          }, 100);

          // è®°å½•æ‹–æ‹½å¼€å§‹æ—¶é—´
          window.dragStartTime = Date.now();
          window.dragResourceId = resourceId;
          window.dragSource = 'ground';
          console.log('åœ°é¢æ æ‹–æ‹½å¼€å§‹ï¼Œå¼€å§‹æ—¶é—´:', window.dragStartTime, 'èµ„æºID:', resourceId);
        });

        // åœ°é¢æ é˜²æŠ–å˜é‡
        let lastGroundTargetCard = null;
        let lastGroundMouseX = null;
        const GROUND_REARRANGE_THRESHOLD = 20; // é¼ æ ‡ç§»åŠ¨è¶…è¿‡20åƒç´ æ‰é‡æ–°æ’åˆ—
        
        // dragover äº‹ä»¶ - å®ç°åœ°é¢æ å¡ç‰Œä¹‹é—´çš„äº¤æ¢åŠŸèƒ½
        card.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          const draggingCard = document.querySelector('.dragging');
          if (!draggingCard) {
            return;
          }

          // åªå¤„ç†åœ°é¢æ å†…éƒ¨çš„æ‹–æ‹½
          if (draggingCard.parentElement !== groundGrid) {
            return;
          }

          // æ£€æŸ¥æ‹–æ‹½æ¥æºï¼Œå¦‚æœæ˜¯ä»èƒŒåŒ…æ æ‹–æ‹½è¿‡æ¥çš„ï¼Œä¸æ‰§è¡Œé‡æ–°æ’åˆ—
          if (window.dragSource === 'backpack') {
            return;
          }

          const container = groundGrid;
          const mousePosX = e.clientX;

          // é˜²æŠ–æ£€æŸ¥ï¼šå¦‚æœé¼ æ ‡ç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œä¸é‡æ–°æ’åˆ—
          if (lastGroundMouseX !== null && Math.abs(mousePosX - lastGroundMouseX) < GROUND_REARRANGE_THRESHOLD) {
            return;
          }
          lastGroundMouseX = mousePosX;

          // æ‰¾åˆ°é¼ æ ‡ä½ç½®ä¸‹çš„å¡ç‰‡ï¼Œæ’é™¤å›ºå®šå¡ç‰Œå’Œæ­£åœ¨æ‹–æ‹½çš„å¡ç‰‡
          const cards = container.querySelectorAll('.resource-card:not(.dragging)');
          let targetCard = null;

          cards.forEach(cardItem => {
            const resourceId = cardItem.getAttribute('data-resource');
            const resource = gameData.resources[resourceId];

            // è·³è¿‡å›ºå®šå¡ç‰Œ
            if (resource && resource.pinned) return;

            const cardRect = cardItem.getBoundingClientRect();
            const cardCenterX = cardRect.left + cardRect.width / 2;

            // ç¡®å®šåº”è¯¥æ’å…¥åˆ°å“ªä¸ªå¡ç‰‡å‰é¢
            if (mousePosX < cardCenterX && !targetCard) {
              targetCard = cardItem;
            }
          });

          // å¦‚æœç›®æ ‡å¡ç‰Œæ²¡æœ‰å˜åŒ–ï¼Œä¸æ‰§è¡Œé‡æ’
          if (targetCard === lastGroundTargetCard) {
            return;
          }
          lastGroundTargetCard = targetCard;

          // å¦‚æœæ‰¾åˆ°ç›®æ ‡å¡ç‰‡ï¼Œå°†æ‹–æ‹½çš„å¡ç‰‡æ’å…¥åˆ°ç›®æ ‡å¡ç‰‡å‰é¢
          if (targetCard) {
            container.insertBefore(draggingCard, targetCard);
          } else {
            // å¦åˆ™å°†æ‹–æ‹½çš„å¡ç‰‡æ”¾åˆ°æœ€å
            container.appendChild(draggingCard);
          }
        });

        // dragend äº‹ä»¶
        card.addEventListener('dragend', function(e) {
          console.log('åœ°é¢æ dragendè§¦å‘');
          card.classList.remove('dragging');
          groundIsDragging = false;

          // ç§»é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
          if (elements.groundGrid) {
            elements.groundGrid.classList.remove('drag-over-highlight');
          }
          if (elements.resourceGrid) {
            elements.resourceGrid.classList.remove('drag-over-highlight');
          }

          // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆ
          clearDragEffects();
          if (typeof groundStopAutoScroll === 'function') {
            groundStopAutoScroll();
          }
          // é‡ç½®èƒŒåŒ…æ çš„æ‹–æ‹½çŠ¶æ€ï¼Œé˜²æ­¢è‡ªåŠ¨æ»šåŠ¨å¼‚å¸¸
          window.isDragging = false;
          stopAutoScroll();

          // åœæ­¢è¿ç»­ç§»åŠ¨
          stopContinuousMove();

          // å¦‚æœå¡ç‰Œè¢«éšè—äº†ï¼ˆå› ä¸ºæ•°é‡ä¸º0ï¼‰ï¼Œåˆ™ç§»é™¤å®ƒ
          if (card.style.display === 'none') {
            card.remove();
          }

          // ä¿å­˜æ–°çš„æ’åºåˆ°localStorage
          saveGroundItemOrder();
        });

        // ============ ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–æ‹½æ”¯æŒ ============

        card.addEventListener('touchstart', function(e) {
          if (e.touches.length !== 1) return;

          // é˜²æ­¢é‡å¤æ‹–æ‹½ - æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ‹–æ‹½åœ¨è¿›è¡Œ
          if (window.isDragging || window.groundTouchDragClone || window.groundIsTouchDragging) {
            console.log('åœ°é¢æ :å·²æœ‰æ‹–æ‹½åœ¨è¿›è¡Œ,å¿½ç•¥æ­¤æ¬¡è§¦æ‘¸');
            return;
          }

          // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§çŠ¶æ€
          if (window.groundTouchStartTimer) {
            clearTimeout(window.groundTouchStartTimer);
            window.groundTouchStartTimer = null;
          }

          const touch = e.touches[0];
          window.groundTouchStartX = touch.clientX;
          window.groundTouchStartY = touch.clientY;

          // ä»å¡ç‰Œå±æ€§ä¸­è·å–resourceIdï¼ˆforEachå¾ªç¯ä¸­æ— æ³•è®¿é—®å¤–å±‚ä½œç”¨åŸŸçš„resourceIdï¼‰
          const resourceId = card.getAttribute('data-resource');

          // ä¿®å¤BUGï¼šåœ¨å¼€å§‹æ–°çš„æ‹–æ‹½å‰ï¼Œç¡®ä¿æ¸…ç†å¡ç‰Œä¸Šå¯èƒ½æ®‹ç•™çš„æ—¶é—´è®°å½•
          card.enteredBackpackTime = null;
          card.enteredGroundTime = null;

          // è®°å½•è§¦æ‘¸å¼€å§‹ä¿¡æ¯ï¼Œä½†ä¸ç«‹å³å¼€å§‹æ‹–æ‹½
          window.dragStartTime = Date.now();
          window.dragResourceId = resourceId;
          window.dragSource = 'ground';
          window.dragCard = card;
          window.isDragAction = false; // é‡ç½®æ‹–æ‹½æ“ä½œæ ‡å¿—

          console.log('åœ°é¢æ è§¦æ‘¸å¼€å§‹ï¼Œèµ„æºID:', resourceId);

          // è®¾ç½®200mså»¶è¿Ÿåæ‰å¼€å§‹æ‹–æ‹½
          window.groundTouchStartTimer = setTimeout(function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«touchmoveå–æ¶ˆå¹¶åˆ›å»ºå…‹éš†
            if (window.groundTouchStartTimer === null || window.groundTouchDragClone) {
              console.log('åœ°é¢æ setTimeout: æ‹–æ‹½å·²è¢«touchmoveå¯åŠ¨æˆ–å®šæ—¶å™¨å·²å–æ¶ˆï¼Œè·³è¿‡');
              return;
            }

            // é€šè¿‡resourceIdé‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼Œå› ä¸ºè¿ç»­ç§»åŠ¨æ—¶å¯èƒ½é‡æ–°æ¸²æŸ“ï¼‰
            let card = null;
            if (window.dragResourceId) {
              const allCards = elements.groundGrid.querySelectorAll('.resource-card');
              for (let i = 0; i < allCards.length; i++) {
                if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                  card = allCards[i];
                  break;
                }
              }
            }

            if (!card) {
              console.log('åœ°é¢æ setTimeout: æœªæ‰¾åˆ°å¡ç‰Œï¼Œå–æ¶ˆæ‹–æ‹½');
              // æ¸…ç†çŠ¶æ€
              window.groundTouchStartTimer = null;
              window.dragStartTime = null;
              window.dragResourceId = null;
              window.dragSource = null;
              window.dragCard = null;
              window.isDragAction = false;
              return;
            }

            // å†æ¬¡æ£€æŸ¥å…‹éš†å…ƒç´ ï¼ˆé˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰
            if (window.groundTouchDragClone) {
              console.log('åœ°é¢æ setTimeout: å…‹éš†å…ƒç´ å·²å­˜åœ¨ï¼Œè·³è¿‡');
              return;
            }

            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å…‹éš†å…ƒç´ 
            if (window.groundTouchDragClone) {
              window.groundTouchDragClone.remove();
            }

            // æ ‡è®°è¿™æ˜¯æ‹–æ‹½æ“ä½œï¼Œä¸æ˜¯å•å‡»
            window.isDragAction = true;

            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æ»šåŠ¨ï¼‰

            groundIsDragging = true;
            window.groundIsTouchDragging = true;
            window.isDragging = true;

            // åˆ›å»ºæ‹–æ‹½å…‹éš†å…ƒç´ 
            window.groundTouchDragClone = card.cloneNode(true);
            window.groundTouchDragClone.style.position = 'fixed';
            window.groundTouchDragClone.style.pointerEvents = 'none';
            window.groundTouchDragClone.style.zIndex = '10000';
            window.groundTouchDragClone.style.opacity = '0.8';
            window.groundTouchDragClone.style.transform = 'scale(1.1)';
            // åˆ é™¤å³ä¸Šè§’çš„æ•°é‡å¾½ç« 
            const groundAmountBadge = window.groundTouchDragClone.querySelector('.amount-badge');
            if (groundAmountBadge) {
              groundAmountBadge.remove();
            }
            // ä½¿ç”¨åŸå¡ç‰Œçš„å®é™…å°ºå¯¸
            window.groundTouchDragClone.style.width = card.offsetWidth + 'px';
            window.groundTouchDragClone.style.height = card.offsetHeight + 'px';
            // ç¡®ä¿å†…éƒ¨å…ƒç´ ä¿æŒæ­£ç¡®çš„å°ºå¯¸å’Œæ ·å¼ï¼ˆåœ°é¢æ å¡ç‰Œæ ·å¼ï¼‰
            const cardImage = window.groundTouchDragClone.querySelector('.card-image');
            if (cardImage) {
              cardImage.style.width = '85px';
              cardImage.style.height = '95px';
              cardImage.style.margin = '0 auto';
              cardImage.style.display = 'block';
              cardImage.style.alignSelf = 'center';
            }
            const cardContent = window.groundTouchDragClone.querySelector('.card-content');
            if (cardContent) {
              cardContent.style.height = '5px';
              cardContent.style.flexShrink = '0';
              cardContent.style.position = 'relative';
              cardContent.style.display = 'flex';
              cardContent.style.alignItems = 'center';
              cardContent.style.justifyContent = 'flex-start';
            }
            const cardTitle = window.groundTouchDragClone.querySelector('.card-title');
            if (cardTitle) {
              cardTitle.style.position = 'absolute';
              cardTitle.style.top = '-15px';
              cardTitle.style.left = '-12px';
              cardTitle.style.backgroundColor = 'rgba(93, 64, 55, 0.9)';
              cardTitle.style.color = 'white';
              cardTitle.style.border = '2px solid #5D4037';
              cardTitle.style.borderRadius = '9999px';
              cardTitle.style.padding = '4px 10px';
              cardTitle.style.zIndex = '20';
              cardTitle.style.textAlign = 'center';
              cardTitle.style.fontWeight = 'normal';
              cardTitle.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
              cardTitle.style.width = 'auto';
              cardTitle.style.maxWidth = 'none';
              cardTitle.style.display = 'inline-block';
              cardTitle.style.fontSize = '0.75rem';
              cardTitle.style.lineHeight = '1.2';
              cardTitle.style.margin = '0';
              cardTitle.style.whiteSpace = 'nowrap';
            }
            window.groundTouchDragClone.classList.add('touch-dragging');

            document.body.appendChild(window.groundTouchDragClone);
            updateTouchDragPosition(touch.clientX, touch.clientY);

            card.classList.add('dragging');
            console.log('åœ°é¢æ å¼€å§‹æ‹–æ‹½ï¼Œèµ„æºID:', resourceId);
          }, 200); // 200mså»¶è¿Ÿ
        }, { passive: false });

        card.addEventListener('touchmove', function(e) {
          // æ£€æŸ¥æ‹–æ‹½æ˜¯å¦å·²ç»å¼€å§‹ï¼ˆé€šè¿‡å»¶è¿Ÿå®šæ—¶å™¨è§¦å‘ï¼‰
          if (!window.groundTouchDragClone) {
            // å¦‚æœè¿˜æ²¡æœ‰å¼€å§‹æ‹–æ‹½ï¼Œæ£€æŸ¥æ˜¯å¦ç§»åŠ¨è·ç¦»è¶³å¤Ÿå¤§ï¼Œå¦‚æœæœ‰åˆ™å–æ¶ˆå»¶è¿Ÿï¼Œç«‹å³å¼€å§‹æ‹–æ‹½
            const touch = e.touches[0];
            const moveDistance = Math.sqrt(
              Math.pow(touch.clientX - window.groundTouchStartX, 2) +
              Math.pow(touch.clientY - window.groundTouchStartY, 2)
            );

            // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡10åƒç´ ï¼Œå–æ¶ˆå»¶è¿Ÿï¼Œç«‹å³å¼€å§‹æ‹–æ‹½
            if (moveDistance > 10 && window.groundTouchStartTimer) {
              clearTimeout(window.groundTouchStartTimer);
              window.groundTouchStartTimer = null;

              // æ ‡è®°è¿™æ˜¯æ‹–æ‹½æ“ä½œï¼Œä¸æ˜¯å•å‡»
              window.isDragAction = true;

              // å†æ¬¡æ£€æŸ¥å…‹éš†å…ƒç´ ï¼ˆé˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰
              if (window.groundTouchDragClone) {
                console.log('åœ°é¢æ touchmove: å…‹éš†å…ƒç´ å·²å­˜åœ¨ï¼Œè·³è¿‡');
                return;
              }

              // é‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼‰
              const card = e.currentTarget; // ä½¿ç”¨currentTargetè€Œä¸æ˜¯window.dragCard
              if (card) {
                e.preventDefault();
                groundIsDragging = true;
                window.groundIsTouchDragging = true;
                window.isDragging = true;

                // åˆ›å»ºæ‹–æ‹½å…‹éš†å…ƒç´ 
                window.groundTouchDragClone = card.cloneNode(true);
                window.groundTouchDragClone.style.position = 'fixed';
                window.groundTouchDragClone.style.pointerEvents = 'none';
                window.groundTouchDragClone.style.zIndex = '10000';
                window.groundTouchDragClone.style.opacity = '0.8';
                window.groundTouchDragClone.style.transform = 'scale(1.1)';
                // åˆ é™¤å³ä¸Šè§’çš„æ•°é‡å¾½ç« 
                const groundAmountBadge = window.groundTouchDragClone.querySelector('.amount-badge');
                if (groundAmountBadge) {
                  groundAmountBadge.remove();
                }
                // ä½¿ç”¨åŸå¡ç‰Œçš„å®é™…å°ºå¯¸
                window.groundTouchDragClone.style.width = card.offsetWidth + 'px';
                window.groundTouchDragClone.style.height = card.offsetHeight + 'px';
                // ç¡®ä¿å†…éƒ¨å…ƒç´ ä¿æŒæ­£ç¡®çš„å°ºå¯¸å’Œæ ·å¼ï¼ˆåœ°é¢æ å¡ç‰Œæ ·å¼ï¼‰
                const cardImage = window.groundTouchDragClone.querySelector('.card-image');
                if (cardImage) {
                  cardImage.style.width = '85px';
                  cardImage.style.height = '95px';
                  cardImage.style.margin = '0 auto';
                  cardImage.style.display = 'block';
                  cardImage.style.alignSelf = 'center';
                }
                const cardContent = window.groundTouchDragClone.querySelector('.card-content');
                if (cardContent) {
                  cardContent.style.height = '5px';
                  cardContent.style.flexShrink = '0';
                  cardContent.style.position = 'relative';
                  cardContent.style.display = 'flex';
                  cardContent.style.alignItems = 'center';
                  cardContent.style.justifyContent = 'flex-start';
                }
                const cardTitle = window.groundTouchDragClone.querySelector('.card-title');
                if (cardTitle) {
                  cardTitle.style.position = 'absolute';
                  cardTitle.style.top = '-15px';
                  cardTitle.style.left = '-12px';
                  cardTitle.style.backgroundColor = 'rgba(93, 64, 55, 0.9)';
                  cardTitle.style.color = 'white';
                  cardTitle.style.border = '2px solid #5D4037';
                  cardTitle.style.borderRadius = '9999px';
                  cardTitle.style.padding = '4px 10px';
                  cardTitle.style.zIndex = '20';
                  cardTitle.style.textAlign = 'center';
                  cardTitle.style.fontWeight = 'normal';
                  cardTitle.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
                  cardTitle.style.width = 'auto';
                  cardTitle.style.maxWidth = 'none';
                  cardTitle.style.display = 'inline-block';
                  cardTitle.style.fontSize = '0.75rem';
                  cardTitle.style.lineHeight = '1.2';
                  cardTitle.style.margin = '0';
                  cardTitle.style.whiteSpace = 'nowrap';
                }
                window.groundTouchDragClone.classList.add('touch-dragging');

                document.body.appendChild(window.groundTouchDragClone);
                updateTouchDragPosition(touch.clientX, touch.clientY);

                card.classList.add('dragging');
                console.log('åœ°é¢æ å› ç§»åŠ¨è¶…è¿‡10åƒç´ ç«‹å³å¼€å§‹æ‹–æ‹½');
              }
              return;
            }
            return;
          }

          e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æ»šåŠ¨ï¼‰

          const touch = e.touches[0];

          // æ›´æ–°å…‹éš†å…ƒç´ ä½ç½®
          updateTouchDragPosition(touch.clientX, touch.clientY);

          // æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡åŒºåŸŸå†…ï¼ˆåœ°é¢æ æˆ–èƒŒåŒ…æ ï¼‰
          const groundGrid = elements.groundGrid;
          const resourceGrid = elements.resourceGrid;

          if (groundGrid) {
            const groundRect = groundGrid.getBoundingClientRect();
            const isOverGround = touch.clientX >= groundRect.left &&
                                touch.clientX <= groundRect.right &&
                                touch.clientY >= groundRect.top &&
                                touch.clientY <= groundRect.bottom;
            groundGrid.classList.toggle('drag-over-highlight', isOverGround);
          }

          if (resourceGrid) {
            const resourceRect = resourceGrid.getBoundingClientRect();
            const isOverResource = touch.clientX >= resourceRect.left &&
                                   touch.clientX <= resourceRect.right &&
                                   touch.clientY >= resourceRect.top &&
                                   touch.clientY <= resourceRect.bottom;

            // æ£€æŸ¥æ˜¯å¦åœ¨èƒŒåŒ…æ åŒºåŸŸå†…
            if (isOverResource) {
              // é€šè¿‡resourceIdé‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼‰
              let card = null;
              if (window.dragResourceId) {
                const allCards = elements.groundGrid.querySelectorAll('.resource-card');
                for (let i = 0; i < allCards.length; i++) {
                  if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                    card = allCards[i];
                    break;
                  }
                }
              }

              if (card) {
                // å¦‚æœç¬¬ä¸€æ¬¡è¿›å…¥èƒŒåŒ…æ åŒºåŸŸï¼Œè®°å½•è¿›å…¥æ—¶é—´
                if (!card.enteredBackpackTime) {
                  card.enteredBackpackTime = Date.now();
                }

                // è®¡ç®—åœ¨èƒŒåŒ…æ åŒºåŸŸçš„åœç•™æ—¶é—´
                const stayDuration = Date.now() - card.enteredBackpackTime;

                // å¦‚æœåœç•™æ—¶é—´å¤§äº500msä¸”è¿˜æ²¡æœ‰å¯åŠ¨è¿ç»­ç§»åŠ¨
                if (stayDuration >= 500 && !window.isContinuousMoving) {
                  const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                  if (currentLocation) {
                    const locationId = currentLocation.id;
                    const resourceId = window.dragResourceId;
                    console.log('è§¦æ‘¸ç§»åŠ¨åœ¨èƒŒåŒ…æ åŒºåŸŸï¼Œåœç•™æ—¶é—´:', stayDuration, 'msï¼Œå¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°èƒŒåŒ…');
                    startContinuousMoveToBackpack(resourceId, locationId);
                  }
                }
              }
            } else {
              // ç¦»å¼€äº†èƒŒåŒ…æ åŒºåŸŸï¼Œåœæ­¢è¿ç»­ç§»åŠ¨
              if (window.isContinuousMoving) {
                console.log('ç¦»å¼€èƒŒåŒ…æ åŒºåŸŸï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
                stopContinuousMove();
              }
              // é‡ç½®è¿›å…¥æ—¶é—´ï¼ˆåªåœ¨è¿ç»­ç§»åŠ¨åœæ­¢åæ‰é‡ç½®ï¼‰
              if (!window.isContinuousMoving && window.dragResourceId) {
                const allCards = elements.groundGrid.querySelectorAll('.resource-card');
                for (let i = 0; i < allCards.length; i++) {
                  if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                    const card = allCards[i];
                    card.enteredBackpackTime = null;
                    break;
                  }
                }
              }
            }

            resourceGrid.classList.toggle('drag-over-highlight', isOverResource);
          } else {
            // resourceGridä¸å­˜åœ¨ï¼Œåœæ­¢è¿ç»­ç§»åŠ¨
            if (window.isContinuousMoving) {
              stopContinuousMove();
            }
            // é‡ç½®è¿›å…¥æ—¶é—´
            if (window.dragResourceId) {
              const allCards = elements.groundGrid.querySelectorAll('.resource-card');
              for (let i = 0; i < allCards.length; i++) {
                if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                  const card = allCards[i];
                  card.enteredBackpackTime = null;
                  break;
                }
              }
            }
          }
        });

        card.addEventListener('touchend', function(e) {
          // æ¸…ç†å»¶è¿Ÿå®šæ—¶å™¨
          if (window.groundTouchStartTimer) {
            clearTimeout(window.groundTouchStartTimer);
            window.groundTouchStartTimer = null;

            // å¦‚æœå®šæ—¶å™¨è¿˜åœ¨ï¼Œè¯´æ˜æ˜¯åœ¨200mså†…æ¾æ‰‹ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ‹–æ‹½æ“ä½œ
            if (!window.isDragAction) {
              // ä¸æ˜¯æ‹–æ‹½æ“ä½œï¼Œæ˜¯å•å‡»æ“ä½œï¼Œè§¦å‘å¡ç‰Œçš„å•å‡»äº‹ä»¶ï¼ˆé£Ÿç”¨/è£…å¤‡ç­‰ï¼‰
              console.log('åœ°é¢æ è§¦æ‘¸ç»“æŸï¼Œæ—¶é—´å°äº200msä¸”æœªç§»åŠ¨ï¼Œè§†ä¸ºå•å‡»æ“ä½œ');

              // é€šè¿‡resourceIdé‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼‰
              let card = null;
              if (window.dragResourceId) {
                const allCards = elements.groundGrid.querySelectorAll('.resource-card');
                for (let i = 0; i < allCards.length; i++) {
                  if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                    card = allCards[i];
                    break;
                  }
                }
              }

              if (card) {
                card.click();
              }
            } else {
              console.log('åœ°é¢æ è§¦æ‘¸ç»“æŸï¼Œæ—¶é—´å°äº200msä½†å·²å¼€å§‹æ‹–æ‹½ï¼Œä¸è§¦å‘å•å‡»');
            }

            // æ¸…ç†æ‰€æœ‰æ‹–æ‹½çŠ¶æ€ï¼ˆæ— è®ºæ˜¯å•å‡»è¿˜æ˜¯æ‹–æ‹½ï¼Œéƒ½éœ€è¦æ¸…ç†ï¼‰
            window.dragStartTime = null;
            window.dragResourceId = null;
            window.dragSource = null;
            window.dragCard = null;
            window.isDragAction = false;
            return;
          }

          // é€šè¿‡resourceIdé‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼Œå› ä¸ºè¿ç»­ç§»åŠ¨æ—¶å¯èƒ½é‡æ–°æ¸²æŸ“ï¼‰
          const resourceId = window.dragResourceId;
          let card = null;
          if (resourceId) {
            const allCards = elements.groundGrid.querySelectorAll('.resource-card');
            for (let i = 0; i < allCards.length; i++) {
              if (allCards[i].getAttribute('data-resource') === resourceId) {
                card = allCards[i];
                break;
              }
            }
          }

          if (!card) {
            console.log('åœ°é¢æ è§¦æ‘¸ç»“æŸï¼Œæœªæ‰¾åˆ°å¡ç‰Œï¼Œç›´æ¥æ¸…ç†çŠ¶æ€');
            // æ¸…ç†çŠ¶æ€å¹¶è¿”å›
            groundIsDragging = false;
            window.groundIsTouchDragging = false;
            window.isDragging = false;
            window.dragResourceId = null;
            window.dragSource = null;
            window.dragStartTime = null;
            window.dragCard = null;
            window.isDragAction = false;
            return;
          }

          const enteredBackpackTime = card.enteredBackpackTime;
          const touch = e.changedTouches[0];
          const touchEndX = touch.clientX;
          const touchEndY = touch.clientY;

          // ç«‹å³æ¸…ç†å…‹éš†å…ƒç´ ï¼Œé¿å…å¡é¡¿
          const cloneToCleanup = window.groundTouchDragClone;
          if (cloneToCleanup) {
            cloneToCleanup.remove();
            window.groundTouchDragClone = null;
          }

          e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º

          // æ£€æŸ¥æ”¾ç½®ä½ç½®
          const groundGrid = elements.groundGrid;
          const resourceGrid = elements.resourceGrid;

          let dropped = false;

          // æ£€æŸ¥æ˜¯å¦æ‹–åˆ°èƒŒåŒ…æ 
          if (resourceGrid) {
            const resourceRect = resourceGrid.getBoundingClientRect();
            const isOverResource = touchEndX >= resourceRect.left &&
                                   touchEndX <= resourceRect.right &&
                                   touchEndY >= resourceRect.top &&
                                   touchEndY <= resourceRect.bottom;

            if (isOverResource) {
              // è®¡ç®—åœ¨èƒŒåŒ…æ åŒºåŸŸçš„åœç•™æ—¶é—´
              const stayDuration = enteredBackpackTime ? Date.now() - enteredBackpackTime : 0;

              console.log('åœ°é¢æ è§¦æ‘¸ç»“æŸï¼Œåœ¨èƒŒåŒ…æ åœç•™æ—¶é—´:', stayDuration, 'ms');

              // åªåœ¨åœç•™æ—¶é—´å°äº500msæ—¶æ‰æ‰§è¡Œå•æ¬¡ç§»åŠ¨
              if (stayDuration < 500) {
                // æ‰§è¡Œä»åœ°é¢åˆ°èƒŒåŒ…çš„ç§»åŠ¨
                const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                if (currentLocation) {
                  const locationId = currentLocation.id;
                  console.log('æ‰§è¡Œå•æ¬¡ç§»åŠ¨åˆ°èƒŒåŒ…');
                  moveOneToBackpack(resourceId, locationId);
                  dropped = true;
                }
              } else {
                // åœç•™æ—¶é—´å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨touchmoveä¸­å¼€å§‹ï¼Œè¿™é‡Œéœ€è¦æ¸…ç†æ‹–æ‹½çŠ¶æ€
                console.log('åœç•™æ—¶é—´å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨è§¦æ‘¸ç§»åŠ¨è¿‡ç¨‹ä¸­å¼€å§‹ï¼Œæ¸…ç†æ‹–æ‹½çŠ¶æ€');
                dropped = true; // æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé¿å…åç»­é€»è¾‘è¯¯åˆ¤
              }
            }
          }

          // åœæ­¢è¿ç»­ç§»åŠ¨ï¼ˆåœ¨æ‰€æœ‰é€»è¾‘å¤„ç†å®Œä¹‹åå†è°ƒç”¨ï¼Œé¿å…cardè¢«é‡æ–°æ¸²æŸ“ï¼‰
          if (window.isContinuousMoving) {
            console.log('è§¦æ‘¸ç»“æŸï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
            stopContinuousMove();
          }

          // ç§»é™¤é«˜äº®
          if (groundGrid) {
            groundGrid.classList.remove('drag-over-highlight');
          }
          if (resourceGrid) {
            resourceGrid.classList.remove('drag-over-highlight');
          }

          // å°è¯•ç§»é™¤å¡ç‰Œæ‹–æ‹½ç±»ï¼ˆå¦‚æœcardè¿˜åœ¨DOMä¸­ï¼‰
          if (card && card.parentNode) {
            card.classList.remove('dragging');
          }

          // æ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™ç§»é™¤å¡ç‰Œ
          const currentLocation = gameData.locations.find(loc => loc.currentLocation);
          if (currentLocation) {
            const locationId = currentLocation.id;
            if (resourceId && gameData.groundResources[locationId]) {
              const groundItem = gameData.groundResources[locationId].find(item => item.resourceId === resourceId);
              if (!groundItem || groundItem.amount <= 0) {
                // æ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ
                console.log('åœ°é¢æ è§¦æ‘¸ç»“æŸï¼Œå¡ç‰Œæ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ');
                if (card && card.parentNode) {
                  card.remove();
                }
              }
            }
          }

          // é‡ç½®æ‹–æ‹½çŠ¶æ€ï¼ˆæ— è®ºæ˜¯å¦è¿ç»­ç§»åŠ¨ï¼Œéƒ½è¦æ¸…ç†çŠ¶æ€ï¼‰
          groundIsDragging = false;
          window.groundIsTouchDragging = false;
          window.isDragging = false;
          window.dragResourceId = null;
          window.dragSource = null;
          window.dragStartTime = null;
          window.dragCard = null;
          window.isDragAction = false;
          if (card && card.parentNode) {
            card.enteredBackpackTime = null;
          }

          console.log('åœ°é¢æ è§¦æ‘¸ç»“æŸ,æ¸…ç†å®Œæˆ');
        });

        // å¤„ç†æ‹–æ‹½è¢«å–æ¶ˆçš„æƒ…å†µ(å¦‚æ¥ç”µã€ç³»ç»Ÿé€šçŸ¥ç­‰)
        card.addEventListener('touchcancel', function(e) {
          // æ¸…ç†å»¶è¿Ÿå®šæ—¶å™¨
          if (window.groundTouchStartTimer) {
            clearTimeout(window.groundTouchStartTimer);
            window.groundTouchStartTimer = null;
          }

          // ç«‹å³æ¸…ç†å…‹éš†å…ƒç´ ï¼Œé¿å…å¡é¡¿
          const cloneToCleanup = window.groundTouchDragClone;
          if (cloneToCleanup) {
            cloneToCleanup.remove();
            window.groundTouchDragClone = null;
          }

          console.log('åœ°é¢æ è§¦æ‘¸è¢«å–æ¶ˆ,æ‰§è¡Œæ¸…ç†');

          // åœæ­¢è¿ç»­ç§»åŠ¨
          if (window.isContinuousMoving) {
            console.log('è§¦æ‘¸è¢«å–æ¶ˆï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
            stopContinuousMove();
          }

          // ç§»é™¤é«˜äº®
          const groundGrid = elements.groundGrid;
          const resourceGrid = elements.resourceGrid;
          if (groundGrid) {
            groundGrid.classList.remove('drag-over-highlight');
          }
          if (resourceGrid) {
            resourceGrid.classList.remove('drag-over-highlight');
          }

          // é€šè¿‡resourceIdé‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼‰
          let card = null;
          if (window.dragResourceId) {
            const allCards = elements.groundGrid.querySelectorAll('.resource-card');
            for (let i = 0; i < allCards.length; i++) {
              if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                card = allCards[i];
                break;
              }
            }
          }

          // ç§»é™¤å¡ç‰Œæ‹–æ‹½ç±»
          if (card) {
            card.classList.remove('dragging');
          }

          // æ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™ç§»é™¤å¡ç‰Œ
          const currentLocation = gameData.locations.find(loc => loc.currentLocation);
          if (currentLocation) {
            const locationId = currentLocation.id;
            const resourceId = window.dragResourceId;
            if (resourceId && gameData.groundResources[locationId]) {
              const groundItem = gameData.groundResources[locationId].find(item => item.resourceId === resourceId);
              if (!groundItem || groundItem.amount <= 0) {
                // æ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ
                console.log('åœ°é¢æ è§¦æ‘¸ç»“æŸï¼Œå¡ç‰Œæ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ');
                if (card) {
                  card.remove();
                }
              }
            }
          }

          // é‡ç½®æ‹–æ‹½çŠ¶æ€ï¼ˆæ— è®ºæ˜¯å¦è¿ç»­ç§»åŠ¨ï¼Œéƒ½è¦æ¸…ç†çŠ¶æ€ï¼‰
          groundIsDragging = false;
          window.groundIsTouchDragging = false;
          window.isDragging = false;
          window.dragResourceId = null;
          window.dragSource = null;
          window.dragStartTime = null;
          window.dragCard = null;
          window.isDragAction = false;
          if (card) {
            card.enteredBackpackTime = null;
          }
        });

        // æ›´æ–°è§¦æ‘¸æ‹–æ‹½å…ƒç´ ä½ç½®
        function updateTouchDragPosition(x, y) {
          if (window.groundTouchDragClone) {
            window.groundTouchDragClone.style.left = (x - 42) + 'px';
            window.groundTouchDragClone.style.top = (y - 47) + 'px';
          }
        }

        // æ¸…ç†è§¦æ‘¸æ‹–æ‹½ - ä»…ç”¨äºç´§æ€¥æ¸…ç†,æ­£å¸¸æƒ…å†µä¸‹åœ¨touchendä¸­ç›´æ¥å¤„ç†
        function cleanupTouchDrag() {
          if (window.groundTouchDragClone) {
            window.groundTouchDragClone.remove();
            window.groundTouchDragClone = null;
          }
          window.groundIsTouchDragging = false;
          groundIsDragging = false;
          window.isDragging = false;
          window.dragResourceId = null;
          window.dragSource = null;
          window.dragStartTime = null;
          console.log('åœ°é¢æ :å¼ºåˆ¶æ¸…ç†æ‹–æ‹½çŠ¶æ€');
        }
        // ============ ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–æ‹½æ”¯æŒç»“æŸ ============
      });
    }

    // ä¿å­˜åœ°é¢æ ç‰©å“æ’åºçš„å‡½æ•°
    function saveGroundItemOrder() {
      const groundGrid = elements.groundGrid;
      if (!groundGrid) return;
      
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      if (!currentLocation) return;
      const locationId = currentLocation.id;
      
      const cards = groundGrid.querySelectorAll('.resource-card');
      const itemOrder = Array.from(cards).map(card => card.getAttribute('data-resource'));
      
      // å°†æ’åºä¿å­˜åˆ°localStorageï¼ŒæŒ‰åœºæ™¯åŒºåˆ†
      localStorage.setItem(`groundInventoryOrder_${locationId}`, JSON.stringify(itemOrder));
    }
    
    // åŠ è½½åœ°é¢æ ç‰©å“æ’åºçš„å‡½æ•°ï¼ˆéœ€è¦åœ¨æ¸²æŸ“åœ°é¢èµ„æºæ—¶è°ƒç”¨ï¼‰
    function loadGroundItemOrder(locationId) {
      const savedOrder = localStorage.getItem(`groundInventoryOrder_${locationId}`);
      if (!savedOrder) return;
      
      const groundGrid = elements.groundGrid;
      if (!groundGrid) return;
      
      const itemOrder = JSON.parse(savedOrder);
      const cards = groundGrid.querySelectorAll('.resource-card');
      
      // åˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œå°†èµ„æºIDæ˜ å°„åˆ°å¯¹åº”çš„å¡ç‰‡å…ƒç´ 
      const cardMap = new Map();
      cards.forEach(card => {
        const resourceId = card.getAttribute('data-resource');
        cardMap.set(resourceId, card);
      });
      
      // æŒ‰ç…§ä¿å­˜çš„é¡ºåºé‡æ–°æ’åˆ—å¡ç‰‡
      itemOrder.forEach(resourceId => {
        const card = cardMap.get(resourceId);
        if (card) {
          // å°†å¡ç‰‡ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®
          groundGrid.appendChild(card);
        }
      });
    }

    // æ¸²æŸ“åœ°ç‚¹
    function renderLocations() {
      // æ£€æŸ¥locationGridæ˜¯å¦å­˜åœ¨
      if (!elements.locationGrid) {
        console.log('é”™è¯¯: locationGridå…ƒç´ ä¸å­˜åœ¨');
        return;
      }
      
      elements.locationGrid.innerHTML = '';

for (const location of gameData.locations) {
        let shouldShow = false;

        // æ ¹æ®åœ°ç‚¹ç±»å‹åˆ¤æ–­æ˜¯å¦æ˜¾ç¤º
        if (location.id === 'black_market') {
          // é»‘å¸‚éœ€è¦æ»¡è¶³å¤šä¸ªæ¡ä»¶ï¼š
          // 1. availableä¸ºtrueï¼ˆå·²é€šè¿‡ç¥ç§˜äººè§£é”ï¼‰
          // 2. è§£é”æ ‡å¿—ä¸ºtrueï¼ˆç¡®ä¿ç”¨æˆ·å·²å®Œæˆè§£é”æµç¨‹ï¼‰
          shouldShow = location.available && gameData.flags.blackMarketUnlocked === true;
        } else if (location.id === 'prison') {
          // ç‰¢æˆ¿åªæœ‰åœ¨æœåˆ‘æœŸé—´æ‰æ˜¾ç¤º
          shouldShow = location.sentenceDays > 0;
        } else if (location.id === 'stable') {
          // é©¬å©ä¸æ˜¾ç¤ºåœ¨ä¸»ç•Œé¢åœ°ç‚¹æ ï¼Œé€šè¿‡"æˆ‘çš„å®…é‚¸"çª—å£è¿›å…¥
          shouldShow = false;
        } else {
          // å…¶ä»–åœ°ç‚¹æ­£å¸¸æ˜¾ç¤º
          shouldShow = location.available;
        }

        if (shouldShow) {
          const locationCard = document.createElement('div');
          locationCard.className = `card location location-card ${location.currentLocation ? 'current' : ''}`;
          locationCard.setAttribute('data-location', location.id);

// å¯¹äºä¸‡ä½›å¯ºï¼Œä¸æ˜¾ç¤ºæ˜æ˜¾æ ‡è¯†
          const showLocationIcon = location.id !== 'temple';

locationCard.innerHTML = `
            <div class="card-content">
              <div class="card-title">${location.name}</div>
              <div class="card-description">${location.description}</div>
              <div class="location-details">
                <!-- å·²ç§»é™¤å±é™©ç­‰çº§æ˜¾ç¤º -->
              </div>
            </div>
          `;

elements.locationGrid.appendChild(locationCard);
        }
      }
    }

    // æ¸²æŸ“è¡ŒåŠ¨
    function renderActions() {
      elements.actionGrid.innerHTML = '';

// è·å–å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);

if (!currentLocation) {
        return;
      }

// æ ¹æ®æ—¶é—´å’Œåœ°ç‚¹é€‰æ‹©è¡ŒåŠ¨åˆ—è¡¨
      let actionsToRender = [...currentLocation.actions];

// å¦‚æœæ˜¯å¤œæ™šï¼ˆäº¥æ—¶21:00-23:00æˆ–å­æ—¶23:00-01:00ï¼‰ä¸”åœ¨ä¸œè¥¿å¸‚ï¼Œä½¿ç”¨å¤œæ™šè¡ŒåŠ¨åˆ—è¡¨
      const isNightTime = gameData.currentHour >= 21 || gameData.currentHour < 1;
      if (isNightTime && currentLocation.id === 'street' && currentLocation.nightActions) {
        actionsToRender = [...currentLocation.nightActions];

// å¦‚æœé»‘å¸‚å·²è§£é”ï¼Œç§»é™¤ä¸ç¥ç§˜äººå¯¹è¯è¡ŒåŠ¨
        const blackMarketLocation = gameData.locations.find(loc => loc.id === 'black_market');
        if (blackMarketLocation && blackMarketLocation.available) {
          actionsToRender = actionsToRender.filter(actionId => actionId !== 'talk_mystery');
        }
      }

// å¦‚æœæ˜¯ä¸‡ä½›å¯ºï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©å¼€å§‹ï¼Œæ¯4å¤©ä¸€æ¬¡ï¼‰
      if (currentLocation.id === 'temple') {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©ã€ç¬¬6å¤©ã€ç¬¬10å¤©...ï¼‰
        if (gameData.day < 2 || (gameData.day - 2) % 4 !== 0 || gameData.fastingDayClaimed) {
          // ä¸æ˜¯æ”¾æ–‹æ—¥ï¼ˆä»ç¬¬2å¤©å¼€å§‹æ¯4å¤©ä¸€æ¬¡ï¼‰ï¼Œæˆ–è€…å·²ç»é¢†å–è¿‡ï¼Œåˆ™ç§»é™¤æ”¾æ–‹æ—¥è¡ŒåŠ¨
          actionsToRender = actionsToRender.filter(actionId => actionId !== 'fasting_day');
        }

        // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»åœå¦è¿‡
        if (gameData.divinationDoneToday) {
          // å¦‚æœå·²ç»åœå¦è¿‡ï¼Œåˆ™ç§»é™¤åœå¦è¡ŒåŠ¨
          actionsToRender = actionsToRender.filter(actionId => actionId !== 'divination');
        }
      }

      // æ ¹æ®å½“å‰åœ°ç‚¹çš„è¡ŒåŠ¨åˆ—è¡¨æ¸²æŸ“è¡ŒåŠ¨å¡ç‰Œ
      for (const actionId of actionsToRender) {
        const action = gameData.actions.find(act => act.id === actionId);

        if (!action) continue;

        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³è¡ŒåŠ¨æ‰€éœ€çš„èµ„æº
        let canPerform = true;
        if (action.requires) {
          // ç‰¹æ®Šå¤„ç†ï¼šå‡çº§æˆ¿å±‹å’Œé©¬å©å§‹ç»ˆå…è®¸ç‚¹å‡»æ‰“å¼€çª—å£
          if (actionId !== 'upgrade_house' && actionId !== 'stable') {
            for (const [resource, amount] of Object.entries(action.requires)) {
              if (!gameData.resources[resource] || gameData.resources[resource].amount < amount) {
                canPerform = false;
                break;
              }
            }
          }
        }
        
        // æ£€æŸ¥æ˜¯å¦åœ¨å®…é‚¸ä¸­ï¼Œå¦‚æœæ˜¯åˆ™æ£€æŸ¥è¡ŒåŠ¨æ˜¯å¦å·²è§£é”
        let isUnlocked = true;
        if (currentLocation.id === 'my_mansion') {
          const houseLevel = gameData.houseLevel || 1;

          // æ ¹æ®æˆ¿å±‹ç­‰çº§æ£€æŸ¥è¡ŒåŠ¨æ˜¯å¦è§£é”
          switch(actionId) {
            case 'farmland':
              isUnlocked = houseLevel >= 2;  // 2çº§è§£é”å†œç”°
              break;
            case 'water_well':
              isUnlocked = houseLevel >= 2;  // 2çº§è§£é”æ°´äº•
              break;
            case 'store_items':
              // ä»“åº“ï¼šå§‹ç»ˆæ˜¾ç¤ºï¼Œä¸æ·»åŠ é”å®šçŠ¶æ€
              isUnlocked = true;
              break;
            case 'livestock_shed':
              isUnlocked = houseLevel >= 4;  // 4çº§è§£é”ç‰²å£æ£š
              break;
            case 'stable':
              isUnlocked = houseLevel >= 5;  // 5çº§è§£é”é©¬å©
              break;
            case 'icehouse':
              isUnlocked = houseLevel >= 6;  // 6çº§è§£é”å†°çª–
              break;
          }
        }

        const actionCard = document.createElement('div');
        // æ ¹æ®æ˜¯å¦è§£é”å’Œèµ„æºæ˜¯å¦è¶³å¤Ÿè®¾ç½®æ ·å¼
        let cardClass = 'card action action-card';
        if (!isUnlocked) {
          cardClass += ' locked'; // æœªè§£é”çš„æ ·å¼
        } else if (!canPerform) {
          cardClass += ' opacity-50'; // èµ„æºä¸è¶³çš„æ ·å¼
        }
        actionCard.className = cardClass;
        actionCard.setAttribute('data-action', action.id);
        actionCard.setAttribute('data-can-perform', canPerform && isUnlocked);
        actionCard.setAttribute('data-unlocked', isUnlocked);

        // è®¡ç®—è¡ŒåŠ¨åç§°çš„å­—ç¬¦æ•°é‡
        const charCount = action.name.replace(/[\s\n]/g, '').length; // å»é™¤ç©ºæ ¼å’Œæ¢è¡Œç¬¦
        
        actionCard.innerHTML = `
          <div class="card-content">
            <div class="card-title" data-chars="${charCount}">${action.name}</div>
          </div>
        `;

elements.actionGrid.appendChild(actionCard);
      }

      // æ¸²æŸ“å®Œæˆåæ›´æ–°æ»šåŠ¨æ¡
      updateActionScrollBarIfNeeded();
    }

    // æ¸²æŸ“é…æ–¹
    function renderRecipes() {
      elements.recipeGrid.innerHTML = '';

for (const recipe of gameData.recipes) {
        const isDiscovered = gameData.discoveredRecipes.includes(recipe.id);

const recipeCard = document.createElement('div');
        recipeCard.className = 'recipe-card';

if (!isDiscovered) {
          // æœªè§£é”çš„é…æ–¹æ˜¾ç¤ºä¸ºé—®å·
          recipeCard.innerHTML = `
            <h3 class="recipe-card-title">???</h3>
            <div class="recipe-card-ingredients">
              <span class="recipe-card-ingredient">???</span>
              <span class="recipe-card-ingredient">???</span>
            </div>
            <p class="recipe-card-description">æœªè§£é”çš„é…æ–¹</p>
            <p class="recipe-card-undiscovered">æœªå‘ç°</p>
          `;
        } else {
          // å·²è§£é”çš„é…æ–¹æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          let ingredientsHtml = '';
          for (const [resource, amount] of Object.entries(recipe.ingredients)) {
            const resourceName = gameData.resources[resource] ? gameData.resources[resource].name : resource;
            ingredientsHtml += `<span class="recipe-card-ingredient">${resourceName} x${amount}</span>`;
          }

recipeCard.innerHTML = `
            <h3 class="recipe-card-title">${recipe.name}</h3>
            <div class="recipe-card-ingredients">
              ${ingredientsHtml}
            </div>
            <p class="recipe-card-description">${recipe.description}</p>
            <p class="recipe-card-discovered">å·²å‘ç°</p>
          `;

          // ä¸ºå·²å‘ç°çš„é…æ–¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
          recipeCard.addEventListener('click', () => {
            // å…³é—­é…æ–¹çª—å£
            elements.recipeModal.classList.remove('active');
            // æ‰“å¼€åˆ¶ä½œçª—å£
            const craftingModal = document.getElementById('craftingModal');
            craftingModal.classList.add('active');
            renderCraftingInventory();
            updateCraftingSlots();
            // è‡ªåŠ¨å°†é…æ–¹æ‰€éœ€çš„æ‰€æœ‰ç‰©å“æ”¾å…¥åˆ¶ä½œæ§½
            autoFillCraftingSlots(recipe);
          });
        }

elements.recipeGrid.appendChild(recipeCard);
      }
    }

    // åˆ›å»ºæ‹–æ‹½ç‰¹æ•ˆ
    function createDragEffects() {
      // æ¸…ç†æ—§çš„ç‰¹æ•ˆ
      clearDragEffects();

      // åˆ›å»ºå…‰æ™•è·Ÿéšæ•ˆæœ
      const glowFollow = document.createElement('div');
      glowFollow.className = 'drag-glow-follow';
      glowFollow.id = 'dragGlowFollow';
      document.body.appendChild(glowFollow);
      window.dragGlowFollow = glowFollow;

      // åˆ›å»ºç²’å­ç”Ÿæˆå™¨
      const spawner = document.createElement('div');
      spawner.id = 'particleSpawner';
      spawner.style.cssText = 'position: fixed; pointer-events: none; z-index: 9997;';
      document.body.appendChild(spawner);
      window.dragParticleSpawner = spawner;

      // å¯åŠ¨ç²’å­ç”Ÿæˆ
      startParticleGeneration();

      // ç›‘å¬é¼ æ ‡ç§»åŠ¨ï¼Œæ›´æ–°å…‰æ™•ä½ç½®å’Œç”Ÿæˆç²’å­
      document.addEventListener('mousemove', handleDragMouseMove);
      window.handleDragMouseMove = handleDragMouseMove;
    }

    // å¤„ç†æ‹–æ‹½æ—¶çš„é¼ æ ‡ç§»åŠ¨
    function handleDragMouseMove(e) {
      if (!window.isDragging || !window.dragGlowFollow) return;

      const x = e.clientX;
      const y = e.clientY;

      // è®°å½•é¼ æ ‡ä½ç½®ä¾›ç²’å­ç”Ÿæˆå™¨ä½¿ç”¨
      window.lastMouseX = x;
      window.lastMouseY = y;

      // æ›´æ–°å…‰æ™•ä½ç½®
      window.dragGlowFollow.style.left = x + 'px';
      window.dragGlowFollow.style.top = y + 'px';

      // éšæœºç”Ÿæˆç²’å­
      if (Math.random() > 0.6) {
        createDragParticle(x, y);
      }

      // éšæœºç”Ÿæˆé­”æ³•æ‹–å°¾
      if (Math.random() > 0.7) {
        createMagicTrail(x, y);
      }
    }

    // åˆ›å»ºæ‹–æ‹½ç²’å­
    function createDragParticle(x, y) {
      if (!window.dragParticleSpawner) return;

      const particle = document.createElement('div');
      particle.className = 'drag-particle';
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';

      // éšæœºé¢œè‰²
      const colors = ['#8D6E63', '#6D4C41', '#5D4037', '#A1887F'];
      const color = colors[Math.floor(Math.random() * colors.length)];
      particle.style.background = `radial-gradient(circle, ${color} 0%, ${color}66 50%, transparent 100%)`;

      // éšæœºæ–¹å‘
      const angle = Math.random() * Math.PI * 2;
      const distance = 20 + Math.random() * 30;
      const tx = Math.cos(angle) * distance;
      const ty = Math.sin(angle) * distance;
      particle.style.setProperty('--tx', `${tx}px`);
      particle.style.setProperty('--ty', `${ty}px`);

      document.body.appendChild(particle);

      // åŠ¨ç”»ç»“æŸåç§»é™¤
      setTimeout(() => {
        particle.remove();
      }, 800);
    }

    // åˆ›å»ºé­”æ³•æ‹–å°¾
    function createMagicTrail(x, y) {
      const trail = document.createElement('div');
      trail.className = 'magic-trail';

      trail.style.left = (x + (Math.random() - 0.5) * 30) + 'px';
      trail.style.top = (y + (Math.random() - 0.5) * 40) + 'px';

      document.body.appendChild(trail);

      // åŠ¨ç”»ç»“æŸåç§»é™¤
      setTimeout(() => {
        trail.remove();
      }, 400);
    }

    // å¯åŠ¨ç²’å­ç”Ÿæˆ
    function startParticleGeneration() {
      if (window.particleGenerationInterval) {
        clearInterval(window.particleGenerationInterval);
      }

      window.particleGenerationInterval = setInterval(() => {
        if (!window.isDragging || !window.dragGlowFollow) {
          clearInterval(window.particleGenerationInterval);
          return;
        }

        // è·å–å½“å‰é¼ æ ‡ä½ç½®ï¼ˆéœ€è¦å­˜å‚¨é¼ æ ‡ä½ç½®ï¼‰
        if (window.lastMouseX && window.lastMouseY) {
          if (Math.random() > 0.5) {
            createDragParticle(window.lastMouseX, window.lastMouseY);
          }
          if (Math.random() > 0.6) {
            createMagicTrail(window.lastMouseX, window.lastMouseY);
          }
        }
      }, 50);
    }

    // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆ
    function clearDragEffects() {
      // ç§»é™¤å…‰æ™•è·Ÿéš
      if (window.dragGlowFollow && window.dragGlowFollow.parentNode) {
        window.dragGlowFollow.remove();
        window.dragGlowFollow = null;
      }

      // ç§»é™¤ç²’å­ç”Ÿæˆå™¨
      if (window.dragParticleSpawner && window.dragParticleSpawner.parentNode) {
        window.dragParticleSpawner.remove();
        window.dragParticleSpawner = null;
      }

      // åœæ­¢ç²’å­ç”Ÿæˆ
      if (window.particleGenerationInterval) {
        clearInterval(window.particleGenerationInterval);
        window.particleGenerationInterval = null;
      }

      // ç§»é™¤é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨
      if (window.handleDragMouseMove) {
        document.removeEventListener('mousemove', window.handleDragMouseMove);
        window.handleDragMouseMove = null;
      }

      // æ¸…ç†æ‰€æœ‰å‰©ä½™çš„æ‹–æ‹½ç‰¹æ•ˆå…ƒç´ 
      const particles = document.querySelectorAll('.drag-particle, .magic-trail');
      particles.forEach(p => {
        // ç§»é™¤å…ƒç´ çš„åŠ¨ç”»ï¼Œé˜²æ­¢ç»§ç»­æ’­æ”¾
        p.style.animation = 'none';
        p.style.display = 'none';
        p.remove();
      });

      // æ¸…ç†æ‰€æœ‰å…‰åœˆå…ƒç´ 
      const glowElements = document.querySelectorAll('.drag-glow-follow');
      glowElements.forEach(glow => {
        glow.style.animation = 'none';
        glow.style.display = 'none';
        if (glow.parentNode) {
          glow.remove();
        }
      });
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // é˜²æ­¢é‡å¤åˆå§‹åŒ–
      if (window.eventListenersSetup) {
        console.log('äº‹ä»¶ç›‘å¬å™¨å·²ç»è®¾ç½®è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
        return;
      }
      window.eventListenersSetup = true;

      // å…¨å±€æ‹–æ‹½çŠ¶æ€å˜é‡ - ä½¿ç”¨windowå¯¹è±¡ä½¿å…¶å¯ä»å…¶ä»–å‡½æ•°è®¿é—®
      if (typeof window.isDragging === 'undefined') {
        window.isDragging = false;
      }
      let isDragging = window.isDragging;
      
      // æ’æ³„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if (elements.excreteButton) {
        elements.excreteButton.addEventListener('click', handleExcreteButtonClick);
      }
      
      // å¸ä¸‹è£…å¤‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('unequip-button')) {
          const slot = e.target.getAttribute('data-slot');
          const resourceId = e.target.getAttribute('data-resource');
          unequipItem(slot, resourceId);
        }
      });

// è£…å¤‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const equipmentButton = document.getElementById('equipmentButton');
      if (equipmentButton) {
        equipmentButton.addEventListener('click', function() {
          openEquipmentWindow();
        });
      }

// æŠ€èƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const skillsButton = document.getElementById('skillsButton');
      if (skillsButton) {
        skillsButton.addEventListener('click', function() {
          openSkillsWindow();
        });
      }

// å¼€å§‹æ¸¸æˆæŒ‰é’®
      if (elements.startGameButton) {
        elements.startGameButton.addEventListener('click', () => {
        console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»');
        try {
          console.log('è®¾ç½®å¼€å§‹å±å¹•æ·¡å‡ºåŠ¨ç”»');
          elements.startScreen.style.opacity = '0';

setTimeout(() => {
            try {
              console.log('éšè—å¼€å§‹å±å¹•');
              elements.startScreen.style.display = 'none';

console.log('æ˜¾ç¤ºæ¸¸æˆå®¹å™¨');
              elements.gameContainer.style.display = 'block';

console.log('å¼€å§‹å®Œå…¨é‡ç½®æ¸¸æˆæ•°æ®...');
              
              // é¦–å…ˆå°è¯•è°ƒç”¨resetGameå‡½æ•°è¿›è¡Œå®Œå…¨é‡ç½®
              if (typeof resetGame === 'function') {
                try {
                  console.log('è°ƒç”¨resetGameå‡½æ•°é‡ç½®æ¸¸æˆ');
                  resetGame();
                  console.log('resetGameå‡½æ•°è°ƒç”¨æˆåŠŸ');
                } catch (resetFuncError) {
                  console.error('è°ƒç”¨resetGameå‡½æ•°å¤±è´¥:', resetFuncError);
                  // é‡ç½®å¤±è´¥æ—¶è¿›è¡Œæ‰‹åŠ¨é‡ç½®
                  performManualGameReset();
                }
              } else {
                console.log('resetGameå‡½æ•°ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨é‡ç½®åŸºæœ¬æ•°æ®');
                performManualGameReset();
              }
              
              console.log('è°ƒç”¨initGame()åˆå§‹åŒ–æ¸¸æˆ');
              initGame();
              console.log('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
              
              // æ¸²æŸ“èµ„æºåˆ—è¡¨
              renderResources();
              console.log('èµ„æºåˆ—è¡¨æ¸²æŸ“å®Œæˆ');
              
              // å¯åŠ¨æ—¶æ•ˆæ€§å€’è®¡æ—¶å®šæœŸæ›´æ–°å®šæ—¶å™¨
              startExpiryTimerUpdate();
              
              // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
              if (gameData.backgroundMusicEnabled) {
                playBackgroundMusic();
              }
            } catch (error) {
              console.error('å¼€å§‹æ¸¸æˆåŠ¨ç”»åé”™è¯¯:', error);
              showErrorDisplay(`å¼€å§‹æ¸¸æˆé”™è¯¯: ${error.message}`);
            }
          }, 500);
        } catch (error) {
          console.error('å¼€å§‹æ¸¸æˆæŒ‰é’®ç‚¹å‡»é”™è¯¯:', error);
          showErrorDisplay(`å¼€å§‹æ¸¸æˆæŒ‰é’®é”™è¯¯: ${error.message}`);
        }
      });
      } else {
        console.log('é”™è¯¯: startGameButtonå…ƒç´ ä¸å­˜åœ¨');
      }

// æ•™ç¨‹æ¨¡æ€æ¡†
      // æ•™ç¨‹å…³é—­æŒ‰é’®çš„äº‹ä»¶å¤„ç†å·²ç»åœ¨setupHelpButton()å‡½æ•°ä¸­è®¾ç½®ï¼Œè¿™é‡Œä¸å†é‡å¤ç»‘å®š

// åœ°ç‚¹å¡ç‰Œç‚¹å‡»
      if (elements.locationGrid) {
        elements.locationGrid.addEventListener('click', (e) => {
        const locationCard = e.target.closest('.location-card');
        if (locationCard) {
          const locationId = locationCard.getAttribute('data-location');
          visitLocation(locationId);
        }
      });
      } else {
        console.log('é”™è¯¯: locationGridå…ƒç´ ä¸å­˜åœ¨');
      }

// è¡ŒåŠ¨å¡ç‰Œç‚¹å‡»
      if (elements.actionGrid) {
        elements.actionGrid.addEventListener('click', (e) => {
        const actionCard = e.target.closest('.action-card');
        if (actionCard) {
          const actionId = actionCard.getAttribute('data-action');
          const canPerform = actionCard.getAttribute('data-can-perform') === 'true';
          const isUnlocked = actionCard.getAttribute('data-unlocked') === 'true';

if (canPerform && isUnlocked) {
            performAction(actionId);
          } else if (!isUnlocked) {
            showNotification('åŠŸèƒ½æœªè§£é”', 'æ­¤åŠŸèƒ½éœ€è¦å‡çº§å®…é‚¸ç­‰çº§æ‰èƒ½ä½¿ç”¨ã€‚');
          } else {
            showNotification('æ¡ä»¶ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºæ¥æ‰§è¡Œæ­¤è¡ŒåŠ¨ã€‚');
          }
        }
      });
      } else {
        console.log('é”™è¯¯: actionGridå…ƒç´ ä¸å­˜åœ¨');
      }

// é…æ–¹æŒ‰é’®ç‚¹å‡»
      const recipeButton = document.getElementById('recipeButton');
      if (recipeButton) {
        recipeButton.addEventListener('click', () => {
          renderRecipes();
          elements.recipeModal.classList.add('active');
        });
      }

// èµ„æºå¡ç‰Œæ‹–æ‹½
      if (elements.resourceGrid) {
        elements.resourceGrid.addEventListener('dragstart', (e) => {
          if (e.target.classList.contains('resource-card')) {
            const resourceId = e.target.getAttribute('data-resource');
            const resource = gameData.resources[resourceId];

            // æ£€æŸ¥å¡ç‰Œæ˜¯å¦è¢«å›ºå®š
            if (resource && resource.pinned) {
              e.preventDefault();
              showNotification('å¡ç‰Œå·²å›ºå®š', 'è¯¥å¡ç‰Œå·²è¢«å›ºå®šï¼Œæ— æ³•æ‹–æ‹½ç§»åŠ¨ã€‚');
              return;
            }

            e.dataTransfer.setData('text/plain', resourceId);
            e.dataTransfer.setData('source', 'backpack'); // è®¾ç½®æ¥æºä¸ºèƒŒåŒ…
            e.target.classList.add('dragging');
            // è®¾ç½®æ‹–æ‹½æ•ˆæœ
            e.dataTransfer.effectAllowed = 'move';

            // ä¸´æ—¶éšè—åŸå¡ç‰Œçš„æ•°é‡å¾½ç« 
            const amountBadge = e.target.querySelector('.amount-badge');
            const originalDisplay = amountBadge ? amountBadge.style.display : null;
            const originalOpacity = e.target.style.opacity;
            const originalTransform = e.target.style.transform;
            
            if (amountBadge) {
              amountBadge.style.setProperty('display', 'none', 'important');
              amountBadge.style.visibility = 'hidden';
            }

            // ä¸´æ—¶æ¢å¤é€æ˜åº¦å’Œå˜å½¢ï¼Œç¡®ä¿æ‹–æ‹½å›¾åƒæ­£å¸¸æ˜¾ç¤º
            e.target.style.opacity = '1';
            e.target.style.transform = 'none';

            // å¼ºåˆ¶æµè§ˆå™¨é‡æ–°æ¸²æŸ“ï¼Œç¡®ä¿æ ·å¼å·²åº”ç”¨
            void e.target.offsetWidth;

            // ç¡®ä¿å›¾ç‰‡å·²åŠ è½½ï¼Œå¹¶ä½¿ç”¨imgæ ‡ç­¾ä½œä¸ºæ‹–æ‹½å›¾åƒ
            const cardImage = e.target.querySelector('.card-image');
            let dragImage = null;

            if (cardImage) {
              const backgroundImage = cardImage.style.backgroundImage;
              if (backgroundImage && backgroundImage !== 'none') {
                // æå–å›¾ç‰‡URL
                const match = backgroundImage.match(/url\(['"]?(.*?)['"]?\)/);
                if (match && match[1]) {
                  const imgUrl = match[1];

                  // åˆ›å»ºä¸€ä¸ªéšè—çš„imgæ ‡ç­¾ç”¨äºæ‹–æ‹½å›¾åƒ
                  dragImage = new Image();
                  dragImage.src = imgUrl;
                  dragImage.style.width = '85px';
                  dragImage.style.height = '95px';
                  dragImage.style.objectFit = 'cover';
                  dragImage.style.borderRadius = '4px';
                  dragImage.style.border = '2px solid #5D4037';

                  // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                  if (dragImage.complete) {
                    console.log(`æ‹–æ‹½å›¾ç‰‡å·²åŠ è½½: ${imgUrl}, å®½: ${dragImage.width}, é«˜: ${dragImage.height}`);
                  } else {
                    dragImage.onload = function() {
                      console.log(`æ‹–æ‹½å›¾ç‰‡åŠ è½½å®Œæˆ: ${imgUrl}, å®½: ${dragImage.width}, é«˜: ${dragImage.height}`);
                    };
                  }
                }
              }
            }

            // ä½¿ç”¨requestAnimationFrameç¡®ä¿åœ¨æ­£ç¡®çš„æ—¶æœºè®¾ç½®æ‹–æ‹½å›¾åƒ
            requestAnimationFrame(() => {
              // å†æ¬¡å¼ºåˆ¶æµè§ˆå™¨é‡æ–°æ¸²æŸ“
              void e.target.offsetWidth;

              // ä½¿ç”¨imgæ ‡ç­¾ä½œä¸ºæ‹–æ‹½å›¾åƒï¼ˆæ›´å¯é ï¼‰
              if (dragImage) {
                e.dataTransfer.setDragImage(dragImage, 42, 47);
              } else {
                // å¦‚æœæ²¡æœ‰åˆ›å»ºimgæ ‡ç­¾ï¼Œä½¿ç”¨åŸå…ƒç´ 
                e.dataTransfer.setDragImage(e.target, 50, 60);
              }
            });

            // å»¶è¿Ÿæ¢å¤æ‰€æœ‰æ ·å¼
            setTimeout(() => {
              // æ¢å¤æ•°é‡å¾½ç« æ˜¾ç¤º
              if (amountBadge) {
                amountBadge.style.removeProperty('display');
                amountBadge.style.visibility = '';
                if (originalDisplay) {
                  amountBadge.style.display = originalDisplay;
                }
              }
              // æ¢å¤é€æ˜åº¦å’Œå˜å½¢
              if (originalOpacity) {
                e.target.style.opacity = originalOpacity;
              } else {
                e.target.style.opacity = '';
              }
              if (originalTransform) {
                e.target.style.transform = originalTransform;
              } else {
                e.target.style.transform = '';
              }
            }, 100);

            // åœæ­¢ä¹‹å‰çš„è¿ç»­ç§»åŠ¨ï¼ˆé¿å…çŠ¶æ€å†²çªï¼‰
            if (window.isContinuousMoving) {
              stopContinuousMove();
              console.log('èƒŒåŒ…æ æ‹–æ‹½å¼€å§‹ï¼Œåœæ­¢ä¹‹å‰çš„è¿ç»­ç§»åŠ¨');
            }

            // è®¾ç½®æ‹–æ‹½çŠ¶æ€
            window.isDragging = true;
            isDragging = true;

            // è®°å½•æ‹–æ‹½å¼€å§‹æ—¶é—´
            window.dragStartTime = Date.now();
            window.dragResourceId = resourceId;
            window.dragSource = 'backpack';
            console.log('èƒŒåŒ…æ æ‹–æ‹½å¼€å§‹ï¼Œå¼€å§‹æ—¶é—´:', window.dragStartTime, 'èµ„æºID:', resourceId);
          }
        });
        
        // æ‹–æ‹½æ’åºåŠŸèƒ½
        let draggedElement = null;
        let dragOverElement = null;

        // è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½

        function startAutoScroll(e) {
          // åªåœ¨æ‹–æ‹½å¡ç‰Œæ—¶æ‰è§¦å‘è‡ªåŠ¨æ»šåŠ¨
          if (!window.isDragging) {
            stopAutoScroll();
            return;
          }

          const container = elements.resourceGrid;
          if (!container) {
            stopAutoScroll();
            return;
          }

          // ç¡®ä¿é¼ æ ‡åœ¨èƒŒåŒ…å®¹å™¨å†…
          const containerRect = container.getBoundingClientRect();
          if (e.clientX < containerRect.left || e.clientX > containerRect.right ||
              e.clientY < containerRect.top || e.clientY > containerRect.bottom) {
            stopAutoScroll();
            return;
          }

          const mousePosX = e.clientX;

          // è¾¹ç•Œæ£€æµ‹å’Œè‡ªåŠ¨æ»šåŠ¨
          const scrollZoneWidth = 50; // è§¦å‘è‡ªåŠ¨æ»šåŠ¨çš„è¾¹ç•ŒåŒºåŸŸå®½åº¦
          const scrollSpeed = 15; // æ»šåŠ¨é€Ÿåº¦

          // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨å·¦è¾¹ç•Œ
          if (mousePosX < containerRect.left + scrollZoneWidth) {
            // å‘å·¦æ»šåŠ¨
            if (container.scrollLeft > 0) {
              container.scrollLeft = Math.max(0, container.scrollLeft - scrollSpeed);
              autoScrollTimer = requestAnimationFrame(() => startAutoScroll(e));
            } else {
              stopAutoScroll();
            }
          }
          // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨å³è¾¹ç•Œ
          else if (mousePosX > containerRect.right - scrollZoneWidth) {
            // å‘å³æ»šåŠ¨
            const maxScrollLeft = container.scrollWidth - container.clientWidth;
            if (container.scrollLeft < maxScrollLeft) {
              container.scrollLeft = Math.min(maxScrollLeft, container.scrollLeft + scrollSpeed);
              autoScrollTimer = requestAnimationFrame(() => startAutoScroll(e));
            } else {
              stopAutoScroll();
            }
          } else {
            // ä¸åœ¨è¾¹ç•ŒåŒºåŸŸï¼Œåœæ­¢è‡ªåŠ¨æ»šåŠ¨
            stopAutoScroll();
          }
        }



        // æ˜¾ç¤ºæ»šåŠ¨æ–¹å‘æç¤º
        // ç¼“å­˜æ ·å¼å·²æ·»åŠ æ ‡è®°ï¼Œé¿å…é‡å¤æ·»åŠ 
        let scrollIndicatorStyleAdded = false;

        function showScrollIndicator(direction) {
          if (!window.scrollIndicator) {
            window.scrollIndicator = document.createElement('div');
            window.scrollIndicator.className = 'scroll-indicator';
            window.scrollIndicator.textContent = direction;
            document.body.appendChild(window.scrollIndicator);

            // åªåœ¨ç¬¬ä¸€æ¬¡æ·»åŠ æ ·å¼
            if (!scrollIndicatorStyleAdded) {
              const style = document.createElement('style');
              style.id = 'scroll-indicator-style';
              style.textContent = `
                .scroll-indicator {
                  position: fixed;
                  bottom: 20px;
                  left: 50%;
                  transform: translateX(-50%);
                  background-color: rgba(0, 0, 0, 0.7);
                  color: white;
                  padding: 8px 16px;
                  border-radius: 20px;
                  font-size: 14px;
                  z-index: 1000;
                  opacity: 0;
                  transition: opacity 0.3s ease;
                  pointer-events: none;
                }
                .scroll-indicator.show {
                  opacity: 1;
                }
              `;
              document.head.appendChild(style);
              scrollIndicatorStyleAdded = true;
            }
          } else {
            window.scrollIndicator.textContent = direction;
          }
          
          window.scrollIndicator.textContent = direction;
          window.scrollIndicator.classList.add('show');
          
          // 1.5ç§’åéšè—æç¤º
          clearTimeout(window.scrollIndicatorTimeout);
          window.scrollIndicatorTimeout = setTimeout(() => {
            window.scrollIndicator.classList.remove('show');
          }, 1500);
        }
        
        // é˜²æŠ–å˜é‡ï¼Œé¿å…é¢‘ç¹é‡æ’å¯¼è‡´é—ªåŠ¨
        let lastTargetCard = null;
        let lastMouseX = null;
        const REARRANGE_THRESHOLD = 20; // é¼ æ ‡ç§»åŠ¨è¶…è¿‡20åƒç´ æ‰é‡æ–°æ’åˆ—
        
        elements.resourceGrid.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          const draggingCard = document.querySelector('.dragging');
          if (!draggingCard) {
            // å¦‚æœæ²¡æœ‰æ‹–æ‹½çš„å¡ç‰Œï¼Œåœæ­¢è‡ªåŠ¨æ»šåŠ¨
            stopAutoScroll();
            return;
          }

          const container = elements.resourceGrid;
          const mousePosX = e.clientX;

          // å¯åŠ¨è‡ªåŠ¨æ»šåŠ¨
          stopAutoScroll(); // åœæ­¢ä¹‹å‰çš„è‡ªåŠ¨æ»šåŠ¨
          startAutoScroll(e);

          // æ£€æŸ¥æ‹–æ‹½æ¥æºï¼Œå¦‚æœæ˜¯ä»åœ°é¢æ æ‹–æ‹½è¿‡æ¥çš„ï¼Œä¸æ‰§è¡Œé‡æ–°æ’åˆ—
          if (window.dragSource === 'ground') {
            // ä»åœ°é¢æ æ‹–æ‹½ï¼Œä¸æ‰§è¡Œå¡ç‰Œé‡æ–°æ’åˆ—
            return;
          }

          // é˜²æŠ–æ£€æŸ¥ï¼šå¦‚æœé¼ æ ‡ç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œä¸é‡æ–°æ’åˆ—
          if (lastMouseX !== null && Math.abs(mousePosX - lastMouseX) < REARRANGE_THRESHOLD) {
            return;
          }
          lastMouseX = mousePosX;

          // æ‰¾åˆ°é¼ æ ‡ä½ç½®ä¸‹çš„å¡ç‰‡ï¼Œæ’é™¤å›ºå®šå¡ç‰Œ
          const cards = container.querySelectorAll('.resource-card:not(.dragging)');
          let targetCard = null;

          cards.forEach(card => {
            const resourceId = card.getAttribute('data-resource');
            const resource = gameData.resources[resourceId];

            // è·³è¿‡å›ºå®šå¡ç‰Œ
            if (resource && resource.pinned) return;

            const cardRect = card.getBoundingClientRect();
            const cardCenterX = cardRect.left + cardRect.width / 2;

            // ç¡®å®šåº”è¯¥æ’å…¥åˆ°å“ªä¸ªå¡ç‰‡å‰é¢
            if (mousePosX < cardCenterX && !targetCard) {
              targetCard = card;
            }
          });

          // å¦‚æœç›®æ ‡å¡ç‰Œæ²¡æœ‰å˜åŒ–ï¼Œä¸æ‰§è¡Œé‡æ’
          if (targetCard === lastTargetCard) {
            return;
          }
          lastTargetCard = targetCard;

          // å¦‚æœæ‰¾åˆ°ç›®æ ‡å¡ç‰‡ï¼Œå°†æ‹–æ‹½çš„å¡ç‰‡æ’å…¥åˆ°ç›®æ ‡å¡ç‰‡å‰é¢
          if (targetCard) {
            container.insertBefore(draggingCard, targetCard);
          } else {
            // å¦åˆ™å°†æ‹–æ‹½çš„å¡ç‰‡æ”¾åˆ°æœ€å
            container.appendChild(draggingCard);
          }
        });

        elements.resourceGrid.addEventListener('dragend', (e) => {
          console.log('èƒŒåŒ…æ dragendè§¦å‘');
          if (e.target.classList.contains('resource-card')) {
            e.target.classList.remove('dragging');
          }

          // ç§»é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
          if (elements.groundGrid) {
            elements.groundGrid.classList.remove('drag-over-highlight');
          }
          if (elements.resourceGrid) {
            elements.resourceGrid.classList.remove('drag-over-highlight');
          }

          // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆ
          clearDragEffects();

          // æ¸…ç†èƒŒåŒ…æ çš„é‡å¤å¡ç‰Œ
          setTimeout(() => {
            const resourceGrid = elements.resourceGrid;
            if (resourceGrid) {
              const allCards = resourceGrid.querySelectorAll('.resource-card');
              const resourceIdMap = new Map();
              allCards.forEach(card => {
                const resourceId = card.getAttribute('data-resource');
                if (resourceIdMap.has(resourceId)) {
                  resourceIdMap.get(resourceId).push(card);
                } else {
                  resourceIdMap.set(resourceId, [card]);
                }
              });
              // ç§»é™¤é‡å¤çš„å¡ç‰Œ
              resourceIdMap.forEach((cards, resourceId) => {
                if (cards.length > 1) {
                  console.warn(`èƒŒåŒ…æ dragend: å‘ç°${cards.length}ä¸ª${resourceId}å¡ç‰Œï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–`);
                  for (let i = 1; i < cards.length; i++) {
                    cards[i].remove();
                  }
                }
              });
            }
          }, 50);

          // æ¸…é™¤æ‹–æ‹½çŠ¶æ€ï¼ˆæ— æ¡ä»¶æ‰§è¡Œï¼Œç¡®ä¿çŠ¶æ€é‡ç½®ï¼‰
          window.isDragging = false;
          isDragging = false;
          stopAutoScroll();

          // åœæ­¢è¿ç»­ç§»åŠ¨
          stopContinuousMove();

          // ä¿å­˜æ–°çš„æ’åºåˆ°localStorageæˆ–æ¸¸æˆæ•°æ®ä¸­
          saveItemOrder();
        });

        // å…¨å±€æ‹–æ‹½ç»“æŸäº‹ä»¶ï¼Œç¡®ä¿åœ¨ä»»ä½•æ‹–æ‹½ç»“æŸåéƒ½åœæ­¢è‡ªåŠ¨æ»šåŠ¨
        window.globalDragEndHandler = (e) => {
          console.log('å…¨å±€dragendè§¦å‘');
          window.isDragging = false;
          isDragging = false;
          stopAutoScroll();

          // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
          if (typeof clearDragEffects === 'function') {
            clearDragEffects();
          }

          // åœæ­¢è¿ç»­ç§»åŠ¨
          stopContinuousMove();
        };
        document.addEventListener('dragend', window.globalDragEndHandler);

        // å…¨å±€mousemoveäº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨äºè‡ªåŠ¨æ»šåŠ¨
        window.globalMouseMoveHandler = (e) => {
          if (window.isDragging) {
            startAutoScroll(e);
          }
        };
        document.addEventListener('mousemove', window.globalMouseMoveHandler);
        
        // é¼ æ ‡æ»šè½®äº‹ä»¶ç›‘å¬å™¨ï¼Œå°†å‚ç›´æ»šåŠ¨è½¬æ¢ä¸ºæ°´å¹³æ»šåŠ¨
        // ä¼˜åŒ–èƒŒåŒ…æ æ»šè½®äº‹ä»¶å¤„ç†
        let scrollAnimationFrame = null;
        let lastScrollIndicatorTime = 0;

        elements.resourceGrid.addEventListener('wheel', (e) => {
          // å¦‚æœæ­£åœ¨æ‹–æ‹½ï¼Œè®©æ‹–æ‹½çš„æ»šè½®äº‹ä»¶å¤„ç†
          if (window.isDragging) {
            e.preventDefault();
            e.stopPropagation();
            return;
          }

          e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
          e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢å½±å“å…¶ä»–å…ƒç´ 

          const container = elements.resourceGrid;
          const maxScrollLeft = container.scrollWidth - container.clientWidth;

          // è®¡ç®—æ»šåŠ¨è·ç¦»ï¼Œç®€åŒ–è®¡ç®—é¿å…æ¯æ¬¡éƒ½åŠ¨æ€è®¡ç®—
          const scrollAmount = Math.max(30, Math.min(Math.abs(e.deltaY) * 0.3, 100)); // 30-100pxä¹‹é—´

          // ç›´æ¥è®¡ç®—æ–°çš„æ»šåŠ¨ä½ç½®
          const direction = e.deltaY > 0 ? 1 : -1;
          const newScrollLeft = Math.max(0, Math.min(maxScrollLeft, container.scrollLeft + direction * scrollAmount));

          // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ»šåŠ¨åŠ¨ç”»
          if (scrollAnimationFrame !== null) {
            cancelAnimationFrame(scrollAnimationFrame);
          }

          scrollAnimationFrame = requestAnimationFrame(() => {
            container.scrollLeft = newScrollLeft;
            scrollAnimationFrame = null;
          });

          // èŠ‚æµæ›´æ–°æ»šåŠ¨æ¡ï¼ˆé¿å…é¢‘ç¹DOMæ“ä½œï¼‰
          requestAnimationFrame(() => {
            updateScrollBar();
          });
        }, { passive: false });

        // ============ ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–æ‹½æ”¯æŒï¼ˆèƒŒåŒ…æ ï¼‰ ============
        // èƒŒåŒ…æ è§¦æ‘¸æ‹–æ‹½å…¨å±€çŠ¶æ€å˜é‡
        window.backpackTouchDragClone = null;
        window.backpackTouchStartX = 0;
        window.backpackTouchStartY = 0;
        window.backpackIsTouchDragging = false;

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†èƒŒåŒ…æ å¡ç‰Œçš„è§¦æ‘¸äº‹ä»¶
        elements.resourceGrid.addEventListener('touchstart', function(e) {
          const card = e.target.closest('.resource-card');
          if (!card) return;
          if (e.touches.length !== 1) return;

          const resourceId = card.getAttribute('data-resource');
          const resource = gameData.resources[resourceId];

          // æ£€æŸ¥å¡ç‰Œæ˜¯å¦è¢«å›ºå®š
          if (resource && resource.pinned) {
            return;
          }

          // é˜²æ­¢é‡å¤æ‹–æ‹½ - æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ‹–æ‹½åœ¨è¿›è¡Œ
          if (window.isDragging || window.backpackTouchDragClone || window.groundTouchDragClone) {
            console.log('èƒŒåŒ…æ :å·²æœ‰æ‹–æ‹½åœ¨è¿›è¡Œ,å¿½ç•¥æ­¤æ¬¡è§¦æ‘¸');
            return;
          }

          // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§çŠ¶æ€
          if (window.backpackTouchStartTimer) {
            clearTimeout(window.backpackTouchStartTimer);
            window.backpackTouchStartTimer = null;
          }

          const touch = e.touches[0];
          window.backpackTouchStartX = touch.clientX;
          window.backpackTouchStartY = touch.clientY;

          // ä¿®å¤BUGï¼šåœ¨å¼€å§‹æ–°çš„æ‹–æ‹½å‰ï¼Œç¡®ä¿æ¸…ç†å¡ç‰Œä¸Šå¯èƒ½æ®‹ç•™çš„æ—¶é—´è®°å½•
          card.enteredBackpackTime = null;
          card.enteredGroundTime = null;

          // è®°å½•è§¦æ‘¸å¼€å§‹ä¿¡æ¯ï¼Œä½†ä¸ç«‹å³å¼€å§‹æ‹–æ‹½
          window.dragStartTime = Date.now();
          window.dragResourceId = resourceId;
          window.dragSource = 'backpack';
          window.dragCard = card;
          window.isDragAction = false; // é‡ç½®æ‹–æ‹½æ“ä½œæ ‡å¿—

          console.log('èƒŒåŒ…æ è§¦æ‘¸å¼€å§‹ï¼Œèµ„æºID:', resourceId);

          // è®¾ç½®200mså»¶è¿Ÿåæ‰å¼€å§‹æ‹–æ‹½
          window.backpackTouchStartTimer = setTimeout(function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«touchmoveå–æ¶ˆå¹¶åˆ›å»ºå…‹éš†
            if (window.backpackTouchStartTimer === null || window.backpackTouchDragClone) {
              console.log('èƒŒåŒ…æ setTimeout: æ‹–æ‹½å·²è¢«touchmoveå¯åŠ¨æˆ–å®šæ—¶å™¨å·²å–æ¶ˆï¼Œè·³è¿‡');
              return;
            }

            // é€šè¿‡resourceIdé‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼Œå› ä¸ºè¿ç»­ç§»åŠ¨æ—¶å¯èƒ½é‡æ–°æ¸²æŸ“ï¼‰
            let card = null;
            if (window.dragResourceId) {
              const allCards = elements.resourceGrid.querySelectorAll('.resource-card');
              for (let i = 0; i < allCards.length; i++) {
                if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                  card = allCards[i];
                  break;
                }
              }
            }

            if (!card) {
              console.log('èƒŒåŒ…æ setTimeout: æœªæ‰¾åˆ°å¡ç‰Œï¼Œå–æ¶ˆæ‹–æ‹½');
              // æ¸…ç†çŠ¶æ€
              window.backpackTouchStartTimer = null;
              window.dragStartTime = null;
              window.dragResourceId = null;
              window.dragSource = null;
              window.dragCard = null;
              window.isDragAction = false;
              return;
            }

            // å†æ¬¡æ£€æŸ¥å…‹éš†å…ƒç´ ï¼ˆé˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰
            if (window.backpackTouchDragClone) {
              console.log('èƒŒåŒ…æ setTimeout: å…‹éš†å…ƒç´ å·²å­˜åœ¨ï¼Œè·³è¿‡');
              return;
            }

            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å…‹éš†å…ƒç´ 
            if (window.backpackTouchDragClone) {
              window.backpackTouchDragClone.remove();
            }

            // æ ‡è®°è¿™æ˜¯æ‹–æ‹½æ“ä½œï¼Œä¸æ˜¯å•å‡»
            window.isDragAction = true;

            e.preventDefault();

            window.backpackIsTouchDragging = true;
            window.isDragging = true;

            // åˆ›å»ºæ‹–æ‹½å…‹éš†å…ƒç´ 
            window.backpackTouchDragClone = card.cloneNode(true);
            window.backpackTouchDragClone.style.position = 'fixed';
            window.backpackTouchDragClone.style.pointerEvents = 'none';
            window.backpackTouchDragClone.style.zIndex = '10000';
            window.backpackTouchDragClone.style.opacity = '0.8';
            window.backpackTouchDragClone.style.transform = 'scale(1.1)';
            // åˆ é™¤å³ä¸Šè§’çš„æ•°é‡å¾½ç« 
            const backpackAmountBadge = window.backpackTouchDragClone.querySelector('.amount-badge');
            if (backpackAmountBadge) {
              backpackAmountBadge.remove();
            }
            // ä½¿ç”¨åŸå¡ç‰Œçš„å®é™…å°ºå¯¸
            window.backpackTouchDragClone.style.width = card.offsetWidth + 'px';
            window.backpackTouchDragClone.style.height = card.offsetHeight + 'px';
            // ç¡®ä¿å†…éƒ¨å…ƒç´ ä¿æŒæ­£ç¡®çš„å°ºå¯¸å’Œæ ·å¼ï¼ˆèƒŒåŒ…æ å¡ç‰Œæ ·å¼ï¼‰
            const cardImage = window.backpackTouchDragClone.querySelector('.card-image');
            if (cardImage) {
              cardImage.style.width = '85px';
              cardImage.style.height = '95px';
              cardImage.style.margin = '0 auto';
              cardImage.style.display = 'block';
              cardImage.style.alignSelf = 'center';
            }
            const cardContent = window.backpackTouchDragClone.querySelector('.card-content');
            if (cardContent) {
              cardContent.style.height = '5px';
              cardContent.style.flexShrink = '0';
              cardContent.style.position = 'relative';
              cardContent.style.display = 'flex';
              cardContent.style.alignItems = 'center';
              cardContent.style.justifyContent = 'flex-start';
            }
            const cardTitle = window.backpackTouchDragClone.querySelector('.card-title');
            if (cardTitle) {
              cardTitle.style.position = 'absolute';
              cardTitle.style.top = '-15px';
              cardTitle.style.left = '-12px';
              cardTitle.style.backgroundColor = 'rgba(93, 64, 55, 0.9)';
              cardTitle.style.color = 'white';
              cardTitle.style.border = '2px solid #5D4037';
              cardTitle.style.borderRadius = '9999px';
              cardTitle.style.padding = '4px 10px';
              cardTitle.style.zIndex = '20';
              cardTitle.style.textAlign = 'center';
              cardTitle.style.fontWeight = 'normal';
              cardTitle.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
              cardTitle.style.width = 'auto';
              cardTitle.style.maxWidth = 'none';
              cardTitle.style.display = 'inline-block';
              cardTitle.style.fontSize = '0.75rem';
              cardTitle.style.lineHeight = '1.2';
              cardTitle.style.margin = '0';
              cardTitle.style.whiteSpace = 'nowrap';
            }
            window.backpackTouchDragClone.classList.add('touch-dragging');

            document.body.appendChild(window.backpackTouchDragClone);
            updateBackpackTouchDragPosition(touch.clientX, touch.clientY);

            card.classList.add('dragging');

            console.log('èƒŒåŒ…æ å¼€å§‹æ‹–æ‹½ï¼Œèµ„æºID:', resourceId);
          }, 200); // 200mså»¶è¿Ÿ
        }, { passive: false });

        elements.resourceGrid.addEventListener('touchmove', function(e) {
          // æ£€æŸ¥æ‹–æ‹½æ˜¯å¦å·²ç»å¼€å§‹ï¼ˆé€šè¿‡å»¶è¿Ÿå®šæ—¶å™¨è§¦å‘ï¼‰
          if (!window.backpackTouchDragClone) {
            // å¦‚æœè¿˜æ²¡æœ‰å¼€å§‹æ‹–æ‹½ï¼Œæ£€æŸ¥æ˜¯å¦ç§»åŠ¨è·ç¦»è¶³å¤Ÿå¤§ï¼Œå¦‚æœæœ‰åˆ™å–æ¶ˆå»¶è¿Ÿï¼Œç«‹å³å¼€å§‹æ‹–æ‹½
            const touch = e.touches[0];
            const moveDistance = Math.sqrt(
              Math.pow(touch.clientX - window.backpackTouchStartX, 2) +
              Math.pow(touch.clientY - window.backpackTouchStartY, 2)
            );

            // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡10åƒç´ ï¼Œå–æ¶ˆå»¶è¿Ÿï¼Œç«‹å³å¼€å§‹æ‹–æ‹½
            if (moveDistance > 10 && window.backpackTouchStartTimer) {
              clearTimeout(window.backpackTouchStartTimer);
              window.backpackTouchStartTimer = null;

              // æ ‡è®°è¿™æ˜¯æ‹–æ‹½æ“ä½œï¼Œä¸æ˜¯å•å‡»
              window.isDragAction = true;

              // å†æ¬¡æ£€æŸ¥å…‹éš†å…ƒç´ ï¼ˆé˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰
              if (window.backpackTouchDragClone) {
                console.log('èƒŒåŒ…æ touchmove: å…‹éš†å…ƒç´ å·²å­˜åœ¨ï¼Œè·³è¿‡');
                return;
              }

              // é€šè¿‡resourceIdé‡æ–°è·å–å¡ç‰Œå…ƒç´ ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„DOMå…ƒç´ ï¼‰
              let card = null;
              if (window.dragResourceId) {
                const allCards = elements.resourceGrid.querySelectorAll('.resource-card');
                for (let i = 0; i < allCards.length; i++) {
                  if (allCards[i].getAttribute('data-resource') === window.dragResourceId) {
                    card = allCards[i];
                    break;
                  }
                }
              }

              if (card) {
                e.preventDefault();
                window.backpackIsTouchDragging = true;
                window.isDragging = true;

                // åˆ›å»ºæ‹–æ‹½å…‹éš†å…ƒç´ 
                window.backpackTouchDragClone = card.cloneNode(true);
                window.backpackTouchDragClone.style.position = 'fixed';
                window.backpackTouchDragClone.style.pointerEvents = 'none';
                window.backpackTouchDragClone.style.zIndex = '10000';
                window.backpackTouchDragClone.style.opacity = '0.8';
                window.backpackTouchDragClone.style.transform = 'scale(1.1)';
                // åˆ é™¤å³ä¸Šè§’çš„æ•°é‡å¾½ç« 
                const backpackAmountBadge = window.backpackTouchDragClone.querySelector('.amount-badge');
                if (backpackAmountBadge) {
                  backpackAmountBadge.remove();
                }
                // ä½¿ç”¨åŸå¡ç‰Œçš„å®é™…å°ºå¯¸
                window.backpackTouchDragClone.style.width = card.offsetWidth + 'px';
                window.backpackTouchDragClone.style.height = card.offsetHeight + 'px';
                // ç¡®ä¿å†…éƒ¨å…ƒç´ ä¿æŒæ­£ç¡®çš„å°ºå¯¸å’Œæ ·å¼ï¼ˆèƒŒåŒ…æ å¡ç‰Œæ ·å¼ï¼‰
                const cardImage = window.backpackTouchDragClone.querySelector('.card-image');
                if (cardImage) {
                  cardImage.style.width = '85px';
                  cardImage.style.height = '95px';
                  cardImage.style.margin = '0 auto';
                  cardImage.style.display = 'block';
                  cardImage.style.alignSelf = 'center';
                }
                const cardContent = window.backpackTouchDragClone.querySelector('.card-content');
                if (cardContent) {
                  cardContent.style.height = '5px';
                  cardContent.style.flexShrink = '0';
                  cardContent.style.position = 'relative';
                  cardContent.style.display = 'flex';
                  cardContent.style.alignItems = 'center';
                  cardContent.style.justifyContent = 'flex-start';
                }
                const cardTitle = window.backpackTouchDragClone.querySelector('.card-title');
                if (cardTitle) {
                  cardTitle.style.position = 'absolute';
                  cardTitle.style.top = '-15px';
                  cardTitle.style.left = '-12px';
                  cardTitle.style.backgroundColor = 'rgba(93, 64, 55, 0.9)';
                  cardTitle.style.color = 'white';
                  cardTitle.style.border = '2px solid #5D4037';
                  cardTitle.style.borderRadius = '9999px';
                  cardTitle.style.padding = '4px 10px';
                  cardTitle.style.zIndex = '20';
                  cardTitle.style.textAlign = 'center';
                  cardTitle.style.fontWeight = 'normal';
                  cardTitle.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
                  cardTitle.style.width = 'auto';
                  cardTitle.style.maxWidth = 'none';
                  cardTitle.style.display = 'inline-block';
                  cardTitle.style.fontSize = '0.75rem';
                  cardTitle.style.lineHeight = '1.2';
                  cardTitle.style.margin = '0';
                  cardTitle.style.whiteSpace = 'nowrap';
                }
                window.backpackTouchDragClone.classList.add('touch-dragging');

                document.body.appendChild(window.backpackTouchDragClone);
                updateBackpackTouchDragPosition(touch.clientX, touch.clientY);

                card.classList.add('dragging');
                console.log('èƒŒåŒ…æ å› ç§»åŠ¨è¶…è¿‡10åƒç´ ç«‹å³å¼€å§‹æ‹–æ‹½');
              }
              return;
            }
            return;
          }

          e.preventDefault();

          const touch = e.touches[0];

          // æ›´æ–°å…‹éš†å…ƒç´ ä½ç½®
          updateBackpackTouchDragPosition(touch.clientX, touch.clientY);

          // æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡åŒºåŸŸå†…ï¼ˆåœ°é¢æ æˆ–èƒŒåŒ…æ ï¼‰
          const groundGrid = elements.groundGrid;
          const resourceGrid = elements.resourceGrid;

          if (groundGrid) {
            const groundRect = groundGrid.getBoundingClientRect();
            const isOverGround = touch.clientX >= groundRect.left &&
                                touch.clientX <= groundRect.right &&
                                touch.clientY >= groundRect.top &&
                                touch.clientY <= groundRect.bottom;

            // æ£€æŸ¥æ˜¯å¦åœ¨åœ°é¢æ åŒºåŸŸå†…
            if (isOverGround) {
              // è·å–å½“å‰æ‹–æ‹½çš„å¡ç‰Œå…ƒç´ 
              const draggedCard = elements.resourceGrid.querySelector('.resource-card.dragging');
              if (draggedCard) {
                // å¦‚æœç¬¬ä¸€æ¬¡è¿›å…¥åœ°é¢æ åŒºåŸŸï¼Œè®°å½•è¿›å…¥æ—¶é—´
                if (!draggedCard.enteredGroundTime) {
                  draggedCard.enteredGroundTime = Date.now();
                }

                // è®¡ç®—åœ¨åœ°é¢æ åŒºåŸŸçš„åœç•™æ—¶é—´
                const stayDuration = Date.now() - draggedCard.enteredGroundTime;

                // å¦‚æœåœç•™æ—¶é—´å¤§äº500msä¸”è¿˜æ²¡æœ‰å¯åŠ¨è¿ç»­ç§»åŠ¨
                if (stayDuration >= 500 && !window.isContinuousMoving) {
                  const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                  if (currentLocation) {
                    const locationId = currentLocation.id;
                    const resourceId = window.dragResourceId;
                    if (resourceId) {
                      console.log('è§¦æ‘¸ç§»åŠ¨åœ¨åœ°é¢æ åŒºåŸŸï¼Œåœç•™æ—¶é—´:', stayDuration, 'msï¼Œå¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°åœ°é¢');
                      startContinuousMoveToGround(resourceId, locationId);
                    }
                  }
                }
              }
            } else {
              // ç¦»å¼€äº†åœ°é¢æ åŒºåŸŸï¼Œåœæ­¢è¿ç»­ç§»åŠ¨
              if (window.isContinuousMoving) {
                console.log('ç¦»å¼€åœ°é¢æ åŒºåŸŸï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
                stopContinuousMove();
              }
              // é‡ç½®è¿›å…¥æ—¶é—´ï¼ˆåªåœ¨è¿ç»­ç§»åŠ¨åœæ­¢åæ‰é‡ç½®ï¼‰
              const draggedCard = elements.resourceGrid.querySelector('.resource-card.dragging');
              if (draggedCard && !window.isContinuousMoving) {
                draggedCard.enteredGroundTime = null;
              }
            }

            groundGrid.classList.toggle('drag-over-highlight', isOverGround);
          }

          if (resourceGrid) {
            const resourceRect = resourceGrid.getBoundingClientRect();
            const isOverResource = touch.clientX >= resourceRect.left &&
                                   touch.clientX <= resourceRect.right &&
                                   touch.clientY >= resourceRect.top &&
                                   touch.clientY <= resourceRect.bottom;
            resourceGrid.classList.toggle('drag-over-highlight', isOverResource);
          }
        }, { passive: false });

        elements.resourceGrid.addEventListener('touchend', function(e) {
          // æ¸…ç†å»¶è¿Ÿå®šæ—¶å™¨
          if (window.backpackTouchStartTimer) {
            clearTimeout(window.backpackTouchStartTimer);
            window.backpackTouchStartTimer = null;

            // å¦‚æœå®šæ—¶å™¨è¿˜åœ¨ï¼Œè¯´æ˜æ˜¯åœ¨200mså†…æ¾æ‰‹ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ‹–æ‹½æ“ä½œ
            if (!window.isDragAction) {
              // ä¸æ˜¯æ‹–æ‹½æ“ä½œï¼Œæ˜¯å•å‡»æ“ä½œï¼Œè§¦å‘å¡ç‰Œçš„å•å‡»äº‹ä»¶ï¼ˆé£Ÿç”¨/è£…å¤‡ç­‰ï¼‰
              console.log('èƒŒåŒ…æ è§¦æ‘¸ç»“æŸï¼Œæ—¶é—´å°äº200msä¸”æœªç§»åŠ¨ï¼Œè§†ä¸ºå•å‡»æ“ä½œ');
              const card = e.target.closest('.resource-card');
              if (card) {
                card.click();
              }
            } else {
              console.log('èƒŒåŒ…æ è§¦æ‘¸ç»“æŸï¼Œæ—¶é—´å°äº200msä½†å·²å¼€å§‹æ‹–æ‹½ï¼Œä¸è§¦å‘å•å‡»');
            }

            // æ¸…ç†æ‰€æœ‰æ‹–æ‹½çŠ¶æ€ï¼ˆæ— è®ºæ˜¯å•å‡»è¿˜æ˜¯æ‹–æ‹½ï¼Œéƒ½éœ€è¦æ¸…ç†ï¼‰
            window.dragStartTime = null;
            window.dragResourceId = null;
            window.dragSource = null;
            window.dragCard = null;
            window.isDragAction = false;
            return;
          }

          // ç«‹å³æ¸…ç†å…‹éš†å…ƒç´ ï¼Œé¿å…å¡é¡¿
          const cloneToCleanup = window.backpackTouchDragClone;
          if (cloneToCleanup) {
            cloneToCleanup.remove();
            window.backpackTouchDragClone = null;
          }

          e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º

          const touch = e.changedTouches[0];
          const touchEndX = touch.clientX;
          const touchEndY = touch.clientY;

          // æ£€æŸ¥æ”¾ç½®ä½ç½®
          const groundGrid = elements.groundGrid;
          const resourceGrid = elements.resourceGrid;

          // åœæ­¢è¿ç»­ç§»åŠ¨
          if (window.isContinuousMoving) {
            console.log('è§¦æ‘¸ç»“æŸï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
            stopContinuousMove();
          }

          let dropped = false;

          // æ£€æŸ¥æ˜¯å¦æ‹–åˆ°åœ°é¢æ 
          if (groundGrid) {
            const groundRect = groundGrid.getBoundingClientRect();
            const isOverGround = touchEndX >= groundRect.left &&
                                touchEndX <= groundRect.right &&
                                touchEndY >= groundRect.top &&
                                touchEndY <= groundRect.bottom;

            if (isOverGround) {
              // è·å–å½“å‰æ‹–æ‹½çš„å¡ç‰Œå…ƒç´ 
              const draggedCard = elements.resourceGrid.querySelector('.resource-card.dragging');
              // è®¡ç®—åœ¨åœ°é¢æ åŒºåŸŸçš„åœç•™æ—¶é—´
              const stayDuration = draggedCard && draggedCard.enteredGroundTime ? Date.now() - draggedCard.enteredGroundTime : 0;

              console.log('èƒŒåŒ…æ è§¦æ‘¸ç»“æŸï¼Œåœ¨åœ°é¢æ åœç•™æ—¶é—´:', stayDuration, 'ms');

              // åªåœ¨åœç•™æ—¶é—´å°äº500msæ—¶æ‰æ‰§è¡Œå•æ¬¡ç§»åŠ¨
              if (stayDuration < 500) {
                // æ‰§è¡Œä»èƒŒåŒ…åˆ°åœ°é¢çš„ç§»åŠ¨
                const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                if (currentLocation) {
                  const locationId = currentLocation.id;
                  const resourceId = window.dragResourceId;
                  if (resourceId) {
                    console.log('æ‰§è¡Œå•æ¬¡ç§»åŠ¨åˆ°åœ°é¢');
                    moveOneToGround(resourceId, locationId);
                    dropped = true;
                  }
                }
              } else {
                // åœç•™æ—¶é—´å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨touchmoveä¸­å¼€å§‹ï¼Œè¿™é‡Œéœ€è¦æ¸…ç†æ‹–æ‹½çŠ¶æ€
                console.log('åœç•™æ—¶é—´å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨è§¦æ‘¸ç§»åŠ¨è¿‡ç¨‹ä¸­å¼€å§‹ï¼Œæ¸…ç†æ‹–æ‹½çŠ¶æ€');
                dropped = true; // æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé¿å…åç»­é€»è¾‘è¯¯åˆ¤
              }
            }
          }

          // ç§»é™¤é«˜äº®
          if (groundGrid) {
            groundGrid.classList.remove('drag-over-highlight');
          }
          if (resourceGrid) {
            resourceGrid.classList.remove('drag-over-highlight');
          }

          // æŸ¥æ‰¾å¹¶ç§»é™¤æ‹–æ‹½çŠ¶æ€
          const draggedCard = elements.resourceGrid.querySelector('.resource-card.dragging');
          if (draggedCard) {
            draggedCard.classList.remove('dragging');
            draggedCard.enteredGroundTime = null;

            // æ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™ç§»é™¤å¡ç‰Œ
            const resourceId = draggedCard.getAttribute('data-resource');
            if (resourceId && gameData.resources[resourceId]) {
              if (gameData.resources[resourceId].amount <= 0) {
                // æ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ
                console.log('èƒŒåŒ…æ è§¦æ‘¸ç»“æŸï¼Œå¡ç‰Œæ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ');
                draggedCard.remove();
              }
            }
          }

          // é‡ç½®æ‹–æ‹½çŠ¶æ€ï¼ˆæ— è®ºæ˜¯å¦è¿ç»­ç§»åŠ¨ï¼Œéƒ½è¦æ¸…ç†çŠ¶æ€ï¼‰
          window.isDragging = false;
          window.backpackIsTouchDragging = false;
          window.dragResourceId = null;
          window.dragSource = null;
          window.dragStartTime = null;
          window.dragCard = null;
          window.isDragAction = false;

          console.log('èƒŒåŒ…æ è§¦æ‘¸ç»“æŸ,æ¸…ç†å®Œæˆ');
        });

        // å¤„ç†æ‹–æ‹½è¢«å–æ¶ˆçš„æƒ…å†µ(å¦‚æ¥ç”µã€ç³»ç»Ÿé€šçŸ¥ç­‰)
        elements.resourceGrid.addEventListener('touchcancel', function(e) {
          // æ¸…ç†å»¶è¿Ÿå®šæ—¶å™¨
          if (window.backpackTouchStartTimer) {
            clearTimeout(window.backpackTouchStartTimer);
            window.backpackTouchStartTimer = null;
          }

          // ç«‹å³æ¸…ç†å…‹éš†å…ƒç´ ï¼Œé¿å…å¡é¡¿
          const cloneToCleanup = window.backpackTouchDragClone;
          if (cloneToCleanup) {
            cloneToCleanup.remove();
            window.backpackTouchDragClone = null;
          }

          console.log('èƒŒåŒ…æ è§¦æ‘¸è¢«å–æ¶ˆ,æ‰§è¡Œæ¸…ç†');

          // åœæ­¢è¿ç»­ç§»åŠ¨
          if (window.isContinuousMoving) {
            console.log('è§¦æ‘¸è¢«å–æ¶ˆï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
            stopContinuousMove();
          }

          // ç§»é™¤é«˜äº®
          const groundGrid = elements.groundGrid;
          const resourceGrid = elements.resourceGrid;
          if (groundGrid) {
            groundGrid.classList.remove('drag-over-highlight');
          }
          if (resourceGrid) {
            resourceGrid.classList.remove('drag-over-highlight');
          }

          // æŸ¥æ‰¾å¹¶ç§»é™¤æ‹–æ‹½çŠ¶æ€
          const draggedCard = elements.resourceGrid.querySelector('.resource-card.dragging');
          if (draggedCard) {
            draggedCard.classList.remove('dragging');
            draggedCard.enteredGroundTime = null;

            // æ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™ç§»é™¤å¡ç‰Œ
            const resourceId = draggedCard.getAttribute('data-resource');
            if (resourceId && gameData.resources[resourceId]) {
              if (gameData.resources[resourceId].amount <= 0) {
                // æ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ
                console.log('èƒŒåŒ…æ è§¦æ‘¸ç»“æŸï¼Œå¡ç‰Œæ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ');
                draggedCard.remove();
              }
            }
          }

          // é‡ç½®æ‹–æ‹½çŠ¶æ€ï¼ˆæ— è®ºæ˜¯å¦è¿ç»­ç§»åŠ¨ï¼Œéƒ½è¦æ¸…ç†çŠ¶æ€ï¼‰
          window.isDragging = false;
          window.backpackIsTouchDragging = false;
          window.dragResourceId = null;
          window.dragSource = null;
          window.dragStartTime = null;
          window.dragCard = null;
          window.isDragAction = false;
        });

        // æ›´æ–°è§¦æ‘¸æ‹–æ‹½å…ƒç´ ä½ç½®
        function updateBackpackTouchDragPosition(x, y) {
          if (window.backpackTouchDragClone) {
            window.backpackTouchDragClone.style.left = (x - 42) + 'px';
            window.backpackTouchDragClone.style.top = (y - 47) + 'px';
          }
        }

        // æ¸…ç†è§¦æ‘¸æ‹–æ‹½ - ä»…ç”¨äºç´§æ€¥æ¸…ç†,æ­£å¸¸æƒ…å†µä¸‹åœ¨touchendä¸­ç›´æ¥å¤„ç†
        function cleanupBackpackTouchDrag() {
          if (window.backpackTouchDragClone) {
            window.backpackTouchDragClone.remove();
            window.backpackTouchDragClone = null;
          }
          window.isDragging = false;
          window.backpackIsTouchDragging = false;
          window.dragResourceId = null;
          window.dragSource = null;
          window.dragStartTime = null;
          console.log('èƒŒåŒ…æ :å¼ºåˆ¶æ¸…ç†æ‹–æ‹½çŠ¶æ€');
        }
        // ============ ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–æ‹½æ”¯æŒç»“æŸ ============
      }

      // ä¿å­˜ç‰©å“æ’åºçš„å‡½æ•°
      function saveItemOrder() {
        const container = elements.resourceGrid;
        if (!container) return;
        
        const cards = container.querySelectorAll('.resource-card');
        const itemOrder = Array.from(cards).map(card => card.getAttribute('data-resource'));
        
        // å°†æ’åºä¿å­˜åˆ°localStorage
        localStorage.setItem('inventoryOrder', JSON.stringify(itemOrder));
      }
      
      // åŠ è½½ç‰©å“æ’åºçš„å‡½æ•°ï¼ˆéœ€è¦åœ¨ç”ŸæˆèƒŒåŒ…æ—¶è°ƒç”¨ï¼‰
      function loadItemOrder() {
        const savedOrder = localStorage.getItem('inventoryOrder');
        if (!savedOrder) return;
        
        const container = elements.resourceGrid;
        if (!container) return;
        
        const itemOrder = JSON.parse(savedOrder);
        const cards = container.querySelectorAll('.resource-card');
        
        // åˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œå°†èµ„æºIDæ˜ å°„åˆ°å¯¹åº”çš„å¡ç‰‡å…ƒç´ 
        const cardMap = new Map();
        cards.forEach(card => {
          const resourceId = card.getAttribute('data-resource');
          cardMap.set(resourceId, card);
        });
        
        // æŒ‰ç…§ä¿å­˜çš„é¡ºåºé‡æ–°æ’åˆ—å¡ç‰‡
        itemOrder.forEach(resourceId => {
          const card = cardMap.get(resourceId);
          if (card && card.parentNode !== container) {
            container.appendChild(card);
          }
        });
      }

// ç»„åˆæ§½æ‹–æ”¾ - åªé€‰æ‹©å¡ç‰Œç»„åˆåŒºåŸŸçš„æ§½ä½
      const combinationSlots = document.querySelectorAll('#combinationSlots .combination-slot');
      combinationSlots.forEach(slot => {
        slot.addEventListener('dragover', (e) => {
          e.preventDefault();
          slot.classList.add('active');
        });

slot.addEventListener('dragleave', () => {
          slot.classList.remove('active');
        });

        slot.addEventListener('drop', (e) => {
          e.preventDefault();
          slot.classList.remove('active');

          const resourceId = e.dataTransfer.getData('text/plain');
          const source = e.dataTransfer.getData('source'); // è·å–æ‹–æ‹½æ¥æº
          
          // éªŒè¯æ‹–æ‹½æ¥æºçš„æœ‰æ•ˆæ€§
          if (source !== 'ground' && source !== 'backpack') {
            console.warn('æ— æ•ˆçš„æ‹–æ‹½æ¥æº:', source);
            return;
          }
          
          // æ£€æŸ¥èµ„æºæ˜¯å¦å¯ç”¨
          let isValidResource = false;
          if (source === 'ground') {
            // æ£€æŸ¥åœ°é¢æ æ˜¯å¦æœ‰è¯¥èµ„æº
            const currentLocation = gameData.locations.find(loc => loc.currentLocation);
            if (currentLocation) {
              const locationId = currentLocation.id;
              const groundItem = gameData.groundResources[locationId]?.find(item => item.resourceId === resourceId);
              isValidResource = groundItem && groundItem.amount > 0;
            }
          } else {
            // æ£€æŸ¥èƒŒåŒ…æ˜¯å¦æœ‰è¯¥èµ„æº
            isValidResource = resourceId && gameData.resources[resourceId] && gameData.resources[resourceId].amount > 0;
          }
          
          if (isValidResource) {
            const slotNumber = slot.getAttribute('data-slot');

            // å¦‚æœæ§½ä½å·²æœ‰èµ„æºï¼Œå°†å…¶è¿”å›åŸæ¥æº
            if (gameData.combinationSlots[slotNumber]) {
              const prevResourceId = gameData.combinationSlots[slotNumber];
              const prevSource = gameData.combinationSlotsSource[slotNumber];
              
              // å°†ä¹‹å‰çš„èµ„æºè¿”å›åˆ°åŸæ¥æº
              if (prevSource === 'ground') {
                // è¿”å›åˆ°åœ°é¢æ 
                const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                if (currentLocation) {
                  const locationId = currentLocation.id;
                  addResourceToGround(prevResourceId, 1);
                }
              } else {
                // è¿”å›åˆ°èƒŒåŒ…
                if (gameData.resources[prevResourceId]) {
                  gameData.resources[prevResourceId].amount++;
                }
              }
            }

            // æ”¾ç½®æ–°èµ„æºå¹¶å‡å°‘æ¥æºå¤„çš„æ•°é‡
            gameData.combinationSlots[slotNumber] = resourceId;
            gameData.combinationSlotsSource[slotNumber] = source; // è®°å½•æ¥æº
            
            if (source === 'ground') {
              // ä»åœ°é¢æ å‡å°‘æ•°é‡
              const currentLocation = gameData.locations.find(loc => loc.currentLocation);
              if (currentLocation) {
                const locationId = currentLocation.id;
                const groundIndex = gameData.groundResources[locationId]?.findIndex(item => item.resourceId === resourceId);
                if (groundIndex !== -1 && groundIndex !== undefined) {
                  gameData.groundResources[locationId][groundIndex].amount--;
                  // å¦‚æœåœ°é¢æ•°é‡ä¸º0ï¼Œä»åœ°é¢æ ç§»é™¤
                  if (gameData.groundResources[locationId][groundIndex].amount <= 0) {
                    gameData.groundResources[locationId].splice(groundIndex, 1);
                  }
                }
              }
            } else {
              // ä»èƒŒåŒ…å‡å°‘æ•°é‡
              if (gameData.resources[resourceId]) {
                gameData.resources[resourceId].amount--;
              }
            }

            // æ›´æ–°UI
            updateCombinationSlots();
            renderResources();
            checkCombination();
          }
        });

        slot.addEventListener('click', () => {
          const slotNumber = slot.getAttribute('data-slot');
          if (gameData.combinationSlots[slotNumber]) {
            const resourceId = gameData.combinationSlots[slotNumber];
            const source = gameData.combinationSlotsSource[slotNumber];
            
            // å°†èµ„æºè¿”å›åˆ°åŸæ¥æº
            if (source === 'ground') {
              // è¿”å›åˆ°åœ°é¢æ 
              const currentLocation = gameData.locations.find(loc => loc.currentLocation);
              if (currentLocation) {
                const locationId = currentLocation.id;
                addResourceToGround(resourceId, 1);
              }
            } else {
              // è¿”å›åˆ°èƒŒåŒ…
              if (gameData.resources[resourceId]) {
                gameData.resources[resourceId].amount++;
              }
            }
            
            // æ¸…ç©ºæ§½ä½
            gameData.combinationSlots[slotNumber] = null;
            gameData.combinationSlotsSource[slotNumber] = null;

            updateCombinationSlots();
            renderResources();
            checkCombination();
          }
        });
      });

// ç»„åˆæŒ‰é’®
      if (elements.craftButton) {
        elements.craftButton.addEventListener('click', () => {
          console.log('ç»„åˆæŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
          combineCards();
        });
      }

      // äº‹ä»¶æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
      elements.closeEventButton.addEventListener('click', () => {
        elements.eventModal.classList.remove('active');
        endTurn();
      });

      // åœ°å›¾æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
      elements.closeMapButton.addEventListener('click', () => {
        console.log('åœ°å›¾æ¨¡æ€æ¡†å…³é—­æŒ‰é’®è¢«ç‚¹å‡»');
        elements.mapModal.classList.remove('active');
      });

// äº‹ä»¶æ¨¡æ€æ¡†ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­
      elements.eventModal.addEventListener('click', (e) => {
        if (e.target === elements.eventModal) {
          console.log('äº‹ä»¶æ¨¡æ€æ¡†èƒŒæ™¯è¢«ç‚¹å‡»ï¼Œå…³é—­æ¨¡æ€æ¡†');
          elements.eventModal.classList.remove('active');
        }
      });

      // åœ°å›¾æ¨¡æ€æ¡†ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­
      elements.mapModal.addEventListener('click', (e) => {
        if (e.target === elements.mapModal) {
          console.log('åœ°å›¾æ¨¡æ€æ¡†èƒŒæ™¯è¢«ç‚¹å‡»ï¼Œå…³é—­æ¨¡æ€æ¡†');
          elements.mapModal.classList.remove('active');
        }
      });

      // åœ°å›¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      elements.mapButton.addEventListener('click', () => {
        console.log('åœ°å›¾æŒ‰é’®è¢«ç‚¹å‡»');
        try {
          // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“åœ°å›¾ä¸­çš„åœ°ç‚¹å¡ç‰Œ
          elements.mapLocationGrid.innerHTML = '';
          console.log('åœ°ç‚¹å¡ç‰Œå®¹å™¨å·²æ¸…ç©º');
          
          // ä½¿ç”¨gameData.locationsè€Œä¸æ˜¯æœªå®šä¹‰çš„locationså˜é‡
          const locations = gameData.locations;
          if (!locations) {
            console.error('é”™è¯¯: gameData.locations ä¸å­˜åœ¨');
            return;
          }
          
          locations.forEach(location => {
            console.log('æ­£åœ¨æ¸²æŸ“åœ°ç‚¹:', location.name);
            let shouldShow = false;

            // æ ¹æ®åœ°ç‚¹ç±»å‹åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºï¼ˆä¸ä¸»ç•Œé¢ä¿æŒä¸€è‡´ï¼‰
            if (location.id === 'black_market') {
              // é»‘å¸‚éœ€è¦æ»¡è¶³å¤šä¸ªæ¡ä»¶ï¼š
              // 1. availableä¸ºtrueï¼ˆå·²é€šè¿‡ç¥ç§˜äººè§£é”ï¼‰
              // 2. è§£é”æ ‡å¿—ä¸ºtrueï¼ˆç¡®ä¿ç”¨æˆ·å·²å®Œæˆè§£é”æµç¨‹ï¼‰
              shouldShow = location.available && gameData.flags.blackMarketUnlocked === true;
            } else if (location.id === 'prison') {
              // ç‰¢æˆ¿åªæœ‰åœ¨æœåˆ‘æœŸé—´æ‰æ˜¾ç¤º
              shouldShow = location.sentenceDays > 0;
            } else if (location.id === 'stable') {
              // é©¬å©ä¸æ˜¾ç¤ºåœ¨åœ°å›¾ä¸Šï¼Œé€šè¿‡"æˆ‘çš„å®…é‚¸"çª—å£è¿›å…¥
              shouldShow = false;
            } else {
              // å…¶ä»–åœ°ç‚¹æ­£å¸¸æ˜¾ç¤º
              shouldShow = location.available;
            }

            if (shouldShow) {
              const locationCard = createMapLocationCard(location);
              elements.mapLocationGrid.appendChild(locationCard);
            }
          });
          console.log('æ‰€æœ‰åœ°ç‚¹å¡ç‰Œæ¸²æŸ“å®Œæˆ');
          
          // ä¸ºåœ°å›¾æ¨¡æ€æ¡†ä¸­çš„åœ°ç‚¹å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œåªç»‘å®šä¸€æ¬¡ï¼‰
          if (!elements.mapLocationGrid.hasMapClickHandler) {
            elements.mapLocationGrid.addEventListener('click', (e) => {
              const locationCard = e.target.closest('.map-location-card');
              if (locationCard) {
                const locationId = locationCard.getAttribute('data-location');
                console.log('åœ°å›¾ä¸­åœ°ç‚¹å¡ç‰Œè¢«ç‚¹å‡»ï¼Œåœ°ç‚¹ID:', locationId);
                // å…³é—­åœ°å›¾æ¨¡æ€æ¡†
                elements.mapModal.classList.remove('active');
                // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´è®©åœ°å›¾æ¨¡æ€æ¡†å…³é—­åŠ¨ç”»å®Œæˆåï¼Œå†è°ƒç”¨ visitLocation æ˜¾ç¤ºåœ°ç‚¹å›¾ç‰‡å¼¹çª—
                setTimeout(() => {
                  visitLocation(locationId);
                }, 300);
              }
            });
            elements.mapLocationGrid.hasMapClickHandler = true;
          }
          
          // æ˜¾ç¤ºåœ°å›¾æ¨¡æ€æ¡†
          elements.mapModal.classList.add('active');
          console.log('åœ°å›¾æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
        } catch (error) {
          console.error('åœ°å›¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶ä¸­å‘ç”Ÿé”™è¯¯:', error);
        }
      });

// é…æ–¹æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
      elements.closeRecipeButton.addEventListener('click', () => {
        elements.recipeModal.classList.remove('active');
      });

// é…æ–¹æ¨¡æ€æ¡†ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­
      elements.recipeModal.addEventListener('click', (e) => {
        if (e.target === elements.recipeModal) {
          elements.recipeModal.classList.remove('active');
        }
      });

// æ¸¸æˆç»“æŸæ¨¡æ€æ¡†æŒ‰é’®


elements.exitGameButton.addEventListener('click', () => {
        // é‡ç½®æ¸¸æˆçŠ¶æ€ï¼Œç¡®ä¿ä¸‹æ¬¡å¼€å§‹æ¸¸æˆæ—¶æ˜¯å…¨æ–°çš„æ¸¸æˆ
        gameData.gameOver = false;
        // è°ƒç”¨è¿”å›å¼€å§‹é¡µé¢å‡½æ•°
        returnToStartPage();
      });

// é€šçŸ¥å…³é—­æŒ‰é’®
      if (elements.closeNotificationButton) {
        elements.closeNotificationButton.addEventListener('click', () => {
          elements.notification.classList.remove('active');
        });
      }

      // è¡ŒåŠ¨ç‚¹æç¤ºçª—å£äº‹ä»¶ç›‘å¬å™¨
      if (elements.closeActionPointsModal) {
        elements.closeActionPointsModal.addEventListener('click', closeActionPointsModal);
      }
      
    }

    // ç»„åˆå¡ç‰Œ
    function combineCards() {
      console.log('combineCardså‡½æ•°è¢«è°ƒç”¨äº†ï¼');
      const slots = Object.values(gameData.combinationSlots).filter(Boolean);
      console.log('ç»„åˆæ§½ä¸­çš„ç‰©å“:', slots);

if (slots.length < 2) {
        showNotification('ç»„åˆå¤±è´¥', 'éœ€è¦è‡³å°‘ä¸¤å¼ å¡ç‰Œæ‰èƒ½ç»„åˆã€‚');
        return;
      }

// æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•é…æ–¹
      let matchedRecipe = null;

for (const recipe of gameData.recipes) {
        const ingredients = Object.keys(recipe.ingredients);

// æ£€æŸ¥é…æ–¹æ‰€éœ€çš„æ‰€æœ‰èµ„æºæ˜¯å¦éƒ½åœ¨ç»„åˆæ§½ä¸­
        let hasAllIngredients = true;
        const slotCounts = {};

// è®¡ç®—ç»„åˆæ§½ä¸­æ¯ç§èµ„æºçš„æ•°é‡
        slots.forEach(resourceId => {
          slotCounts[resourceId] = (slotCounts[resourceId] || 0) + 1;
        });

// æ£€æŸ¥æ˜¯å¦æ»¡è¶³é…æ–¹è¦æ±‚
        for (const [resource, requiredAmount] of Object.entries(recipe.ingredients)) {
          if (!slotCounts[resource] || slotCounts[resource] < requiredAmount) {
            hasAllIngredients = false;
            break;
          }
        }

if (hasAllIngredients) {
          matchedRecipe = recipe;
          break;
        }
      }

if (matchedRecipe) {
        console.log('æ‰¾åˆ°åŒ¹é…çš„é…æ–¹:', matchedRecipe);
        // ä¿å­˜å½“å‰é…æ–¹å¼•ç”¨ï¼Œä»¥ä¾¿åœ¨å›è°ƒä¸­ä½¿ç”¨
        const currentRecipe = matchedRecipe;
        // æ»‘å—å°æ¸¸æˆé…ç½® - æ£€æŸ¥äº§ç‰©æ˜¯å¦ä¸ºè£…å¤‡ç±»ç‰©å“
        const hasEquipment = Object.keys(currentRecipe.result).some(resultId => gameData.resources[resultId] && gameData.resources[resultId].category === 'equipment');
        const gameConfig = {
          speed: hasEquipment ? 4 : 2, // è£…å¤‡ç±»ç‰©å“é€Ÿåº¦ä¸º4ï¼Œéè£…å¤‡ç±»ç‰©å“é€Ÿåº¦ä¸º2
          targetWidth: hasEquipment ? 0.08 : 0.1, // è£…å¤‡ç±»ç‰©å“ç›®æ ‡åŒºåŸŸå®½åº¦ä¸º0.08ï¼Œéè£…å¤‡ç±»ç‰©å“ç›®æ ‡åŒºåŸŸå®½åº¦ä¸º0.1
          timeLimit: 10 // 10ç§’æ—¶é—´é™åˆ¶
        };
        console.log('æ»‘å—æ¸¸æˆé…ç½®:', gameConfig);

// æ˜¾ç¤ºæ»‘å—å°æ¸¸æˆ
        console.log('å‡†å¤‡æ˜¾ç¤ºæ»‘å—å°æ¸¸æˆ...');
        console.log('elements.sliderGameModal:', elements.sliderGameModal);
        startSliderGame(gameConfig, (success) => {
          if (success) {
            // æ¸¸æˆæˆåŠŸï¼Œæ¶ˆè€—èµ„æºå¹¶åº”ç”¨é…æ–¹ç»“æœ
            const results = {
              resources: {},
              status: {},
              effects: []
            };

// æ¶ˆè€—èµ„æºï¼ˆèƒŒåŒ…å’Œåœ°é¢æ ï¼‰
            // å…ˆç»Ÿè®¡ç»„åˆæ§½ä¸­å„ç§èµ„æºçš„æ¥æº
            const sourceCounts = {};
            for (const slotNumber in gameData.combinationSlots) {
              const resourceId = gameData.combinationSlots[slotNumber];
              const source = gameData.combinationSlotsSource[slotNumber] || 'backpack';
              if (resourceId) {
                if (!sourceCounts[resourceId]) {
                  sourceCounts[resourceId] = { ground: 0, backpack: 0 };
                }
                sourceCounts[resourceId][source]++;
              }
            }
            
            // æ¶ˆè€—èµ„æº
            for (const [resource, requiredAmount] of Object.entries(currentRecipe.ingredients)) {
              if (resource in gameData.resources) {
                const counts = sourceCounts[resource];
                if (counts) {
                  // ä¼˜å…ˆæ¶ˆè€—åœ°é¢æ çš„èµ„æº
                  const groundConsume = Math.min(counts.ground, requiredAmount);
                  const backpackConsume = requiredAmount - groundConsume;
                  
                  // æ¶ˆè€—åœ°é¢æ èµ„æº
                  if (groundConsume > 0) {
                    const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                    if (currentLocation) {
                      const locationId = currentLocation.id;
                      let remainingConsume = groundConsume;
                      
                      // ä»åœ°é¢æ æ¶ˆè€—èµ„æº
                      for (let i = gameData.groundResources[locationId].length - 1; i >= 0 && remainingConsume > 0; i--) {
                        const groundItem = gameData.groundResources[locationId][i];
                        if (groundItem.resourceId === resource) {
                          const consumeAmount = Math.min(groundItem.amount, remainingConsume);
                          groundItem.amount -= consumeAmount;
                          remainingConsume -= consumeAmount;
                          
                          // å¦‚æœåœ°é¢æ•°é‡ä¸º0ï¼Œä»åœ°é¢æ ç§»é™¤
                          if (groundItem.amount <= 0) {
                            gameData.groundResources[locationId].splice(i, 1);
                          }
                        }
                      }
                    }
                  }
                  
                  // æ¶ˆè€—èƒŒåŒ…èµ„æº
                  if (backpackConsume > 0) {
                    const originalAmount = gameData.resources[resource].amount;
                    gameData.resources[resource].amount = Math.max(0, originalAmount - backpackConsume);

                    // æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦æ­£åœ¨è£…å¤‡ä¸­
                    if (gameData.resources[resource].equipped) {
                      // å¦‚æœç‰©å“æ•°é‡å˜ä¸º0ï¼Œè‡ªåŠ¨å¸ä¸‹è£…å¤‡
                      if (gameData.resources[resource].amount === 0) {
                        // ç§»é™¤è£…å¤‡æ•ˆæœ
                        applyEquipmentEffect(resource, 'unequip');
                        // ç§»é™¤è£…å¤‡çŠ¶æ€
                        gameData.resources[resource].equipped = false;
                        results.effects.push(`ä½ çš„${gameData.resources[resource].name}è¢«æ¶ˆè€—äº†ï¼Œå·²è‡ªåŠ¨å¸ä¸‹ã€‚`);
                      }
                    }
                  }
                }
              }
            }

// åº”ç”¨é…æ–¹ç»“æœ
            let resourceChanged = false;
            for (const [resource, amount] of Object.entries(currentRecipe.result)) {
              if (resource in gameData.resources) {
                // ç‰¹æ®Šå¤„ç†æ°´è¢‹å’Œæœ¨æ¡¶ï¼šåˆ›å»ºç‹¬ç«‹å®ä¾‹
                if ((resource === 'bucket' || resource === 'water_bag') && amount > 0) {
                  // ç¡®ä¿instancesæ•°ç»„å­˜åœ¨
                  if (!gameData.resources[resource].instances) {
                    gameData.resources[resource].instances = [];
                  }
                  // ä¸ºæ¯ä¸ªæ–°ç‰©å“åˆ›å»ºç‹¬ç«‹å®ä¾‹
                  for (let i = 0; i < amount; i++) {
                    const instanceId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    gameData.resources[resource].instances.push({
                      id: instanceId,
                      waterLevel: 0, // æ–°åˆ¶ä½œçš„å®¹å™¨éƒ½æ˜¯ç©ºçš„
                      durability: 100
                    });
                  }
                  // æ›´æ–°æ€»æ•°é‡
                  gameData.resources[resource].amount += amount;
                  resourceChanged = true;
                } else {
                  // æ£€æŸ¥æ˜¯å¦æ˜¯æ—¶æ•ˆæ€§é£Ÿç‰©
                  const resourceData = gameData.resources[resource];
                  if (resourceData.isPerishable && amount > 0) {
                    // ä½¿ç”¨æ‰¹æ¬¡ç³»ç»Ÿæ·»åŠ é£Ÿç‰©
                    addFoodWithBatches(resource, amount);
                    resourceChanged = true;
                  } else {
                    // æ™®é€šèµ„æºçš„å¤„ç†
                    const originalAmount = resourceData.amount;
                    if (originalAmount !== originalAmount + amount) {
                      resourceChanged = true;
                    }
                    resourceData.amount = originalAmount + amount;

                    // å¦‚æœæ˜¯ç¯ç«ä¸”æ˜¯é€šè¿‡"ç¯ç«"åˆ¶ä½œé…æ–¹ï¼ˆä¸æ˜¯çƒ¹é¥ªé…æ–¹ï¼‰ï¼Œé‡ç½®ç‡ƒæ–™ä¸º100%
                    if (resource === 'fire' && currentRecipe.id === 'fire' && amount > 0) {
                      resourceData.fuel = 100;
                    }
                  }
                }
              } else if (resource in gameData.status) {
                const newStatus = Math.min(100, Math.max(0, gameData.status[resource] + amount));
                if (gameData.status[resource] !== newStatus) {
                  resourceChanged = true;
                }
                gameData.status[resource] = newStatus;
              } else if (resource === 'begging_chance') {
                // å¤„ç†ä¹è®¨æˆåŠŸç‡åŠ æˆ
                gameData.begging_chance = (gameData.begging_chance || 0) + amount;
                resourceChanged = true;
                showNotification('åˆ¶ä½œæˆåŠŸ', `ä½ çš„ä¹è®¨æˆåŠŸç‡æé«˜äº†${amount}%ï¼`);
              } else {
                // å¦‚æœæ˜¯æ–°çš„èµ„æºï¼Œåˆ›å»ºå®ƒ
                gameData.resources[resource] = {
                  name: resource.charAt(0).toUpperCase() + resource.slice(1).replace('_', ' '),
                  amount: amount,
                  image: '' // é»˜è®¤ä¸ºç©ºå›¾ç‰‡ï¼Œå®é™…æ¸¸æˆä¸­åº”è¯¥è®¾ç½®æ­£ç¡®çš„å›¾ç‰‡
                };

// å¦‚æœæ˜¯å¯åˆ¶ä½œçš„ç‰©å“ï¼Œè®¾ç½®åˆå§‹è€ä¹…åº¦
                if (['simple_clothes', 'fire', 'clay_bowl', 'crutch', 'black_cloak'].includes(resource)) {
                  gameData.resources[resource].durability = 100;
                  // å¦‚æœæ˜¯ç¯ç«ï¼Œè®¾ç½®åˆå§‹ç‡ƒæ–™å€¼
                  if (resource === 'fire') {
                    gameData.resources[resource].fuel = 100;
                  }
                }
                
                // ä¸ºæ°´è¢‹å’Œæœ¨æ¡¶åˆå§‹åŒ–instancesæ•°ç»„
                if (resource === 'bucket' || resource === 'water_bag') {
                  gameData.resources[resource].instances = [];
                  for (let i = 0; i < amount; i++) {
                    const instanceId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    gameData.resources[resource].instances.push({
                      id: instanceId,
                      waterLevel: 0,
                      durability: 100
                    });
                  }
                }
                
                resourceChanged = true;
              }
            }

// æ ‡è®°é…æ–¹ä¸ºå·²å‘ç°
            if (!gameData.discoveredRecipes.includes(currentRecipe.id)) {
              gameData.discoveredRecipes.push(currentRecipe.id);
              gameData.stats.recipesDiscovered++;
              showAchievement('æ–°é…æ–¹å‘ç°', `ä½ å‘ç°äº†å¦‚ä½•åˆ¶ä½œ${currentRecipe.name}ï¼`);
            }

// å¦‚æœåˆ¶ä½œçš„æ˜¯æ³¥ç¢—ï¼Œç¡®ä¿èƒŒåŒ…ä¸­æ²¡æœ‰ç ´ç¢—
            if (currentRecipe.id === 'clay_bowl') {
              gameData.resources.bowl.amount = 0;
            }

// æ¸…ç©ºç»„åˆæ§½ï¼ˆä¿ç•™ç¢—ç±»å¡ç‰Œï¼‰
            for (const slot in gameData.combinationSlots) {
              const resourceId = gameData.combinationSlots[slot];
              if (resourceId && !nonConsumableBowls.includes(resourceId)) {
                gameData.combinationSlots[slot] = null;
              } else if (resourceId && nonConsumableBowls.includes(resourceId)) {
                console.log(`ç¢—ç±»å¡ç‰Œ ${resourceId} ä¿ç•™åœ¨ç»„åˆæ§½ä¸­`);
              }
            }

// æ›´æ–°UI
            updateCombinationSlots();
            updateGameData();
            checkCombination();

// å¦‚æœèµ„æºæœ‰å˜åŒ–ï¼Œæ›´æ–°ç›¸å…³èµ„æºå¡ç‰Œ
            if (resourceChanged) {
              // æ›´æ–°æ¶ˆè€—çš„èµ„æº
              for (const [resource, requiredAmount] of Object.entries(currentRecipe.ingredients)) {
                updateResourceCard(resource);
              }

// æ›´æ–°ç”Ÿæˆçš„èµ„æº
              for (const [resource, amount] of Object.entries(currentRecipe.result)) {
                if (resource in gameData.resources) {
                  updateResourceCard(resource);
                }
              }

// åªæœ‰å½“æœ‰è£…å¤‡ç‰©å“è¢«æ¶ˆè€—æ—¶æ‰æ›´æ–°è£…å¤‡æ 
              if (results.effects.length > 0) {
                renderEquipmentSlots(); // æ›´æ–°è£…å¤‡æ 
              }
            }

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            elements.combinationResult.innerHTML = `
              <div class="text-green-600">
                <i class="fa fa-check-circle" aria-hidden="true"></i>
                æˆåŠŸåˆ¶ä½œäº† ${currentRecipe.name}ï¼
              </div>
            `;

// å¦‚æœæœ‰è£…å¤‡ç‰©å“è¢«æ¶ˆè€—ï¼Œæ˜¾ç¤ºé€šçŸ¥
            if (results.effects.length > 0) {
              // showEventResult('ç»„åˆç»“æœ', results); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
            } else {
              showNotification('ç»„åˆæˆåŠŸ', `æˆåŠŸåˆ¶ä½œäº†${currentRecipe.name}ï¼`);
            }
          } else {
            // æ¸¸æˆå¤±è´¥ï¼Œæ¶ˆè€—å½“å‰ç»„åˆåŒºåŸŸçš„å¡ç‰Œ
            console.log('æ»‘å—æ¸¸æˆå¤±è´¥ï¼Œå¼€å§‹æ¶ˆè€—ç»„åˆåŒºåŸŸçš„å¡ç‰Œ');
            console.log('å½“å‰ç»„åˆæ§½:', gameData.combinationSlots);
            console.log('åŒ¹é…çš„é…æ–¹:', currentRecipe);
            
            // å…ˆç»Ÿè®¡ç»„åˆæ§½ä¸­å„ç§èµ„æºçš„æ¥æº
            const failureSourceCounts = {};
            for (const slotNumber in gameData.combinationSlots) {
              const resourceId = gameData.combinationSlots[slotNumber];
              const source = gameData.combinationSlotsSource[slotNumber] || 'backpack';
              if (resourceId) {
                if (!failureSourceCounts[resourceId]) {
                  failureSourceCounts[resourceId] = { ground: 0, backpack: 0 };
                }
                failureSourceCounts[resourceId][source]++;
              }
            }
            
            // æ¶ˆè€—èµ„æº
            for (const [resource, requiredAmount] of Object.entries(currentRecipe.ingredients)) {
              if (!nonConsumableBowls.includes(resource)) {
                const counts = failureSourceCounts[resource];
                if (counts) {
                  // ä¼˜å…ˆæ¶ˆè€—åœ°é¢æ çš„èµ„æº
                  const groundConsume = Math.min(counts.ground, requiredAmount);
                  const backpackConsume = requiredAmount - groundConsume;
                  
                  // æ¶ˆè€—åœ°é¢æ èµ„æº
                  if (groundConsume > 0) {
                    const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                    if (currentLocation) {
                      const locationId = currentLocation.id;
                      let remainingConsume = groundConsume;
                      
                      // ä»åœ°é¢æ æ¶ˆè€—èµ„æº
                      for (let i = gameData.groundResources[locationId].length - 1; i >= 0 && remainingConsume > 0; i--) {
                        const groundItem = gameData.groundResources[locationId][i];
                        if (groundItem.resourceId === resource) {
                          const consumeAmount = Math.min(groundItem.amount, remainingConsume);
                          groundItem.amount -= consumeAmount;
                          remainingConsume -= consumeAmount;
                          
                          // å¦‚æœåœ°é¢æ•°é‡ä¸º0ï¼Œä»åœ°é¢æ ç§»é™¤
                          if (groundItem.amount <= 0) {
                            gameData.groundResources[locationId].splice(i, 1);
                          }
                        }
                      }
                    }
                  }
                  
                  // æ¶ˆè€—èƒŒåŒ…èµ„æº
                  if (backpackConsume > 0) {
                    if (resource in gameData.resources) {
                      const originalAmount = gameData.resources[resource].amount;
                      gameData.resources[resource].amount = Math.max(0, originalAmount - backpackConsume);
                      console.log(`æ¶ˆè€—äº†${backpackConsume}ä¸ª${resource}ï¼Œå‰©ä½™${gameData.resources[resource].amount}ä¸ª`);

                      // æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦æ­£åœ¨è£…å¤‡ä¸­
                      if (gameData.resources[resource].equipped) {
                        // å¦‚æœç‰©å“æ•°é‡å˜ä¸º0ï¼Œè‡ªåŠ¨å¸ä¸‹è£…å¤‡
                        if (gameData.resources[resource].amount === 0) {
                          // ç§»é™¤è£…å¤‡æ•ˆæœ
                          applyEquipmentEffect(resource, 'unequip');
                          // ç§»é™¤è£…å¤‡çŠ¶æ€
                          gameData.resources[resource].equipped = false;
                        }
                      }
                    }
                  }
                }
              } else {
                console.log(`${resource}æ˜¯ç¢—ç±»å¡ç‰Œï¼Œä¸å¯æ¶ˆè€—`);
              }
            }

// æ¸…ç©ºç»„åˆæ§½ï¼ˆå°†æ‰€æœ‰å¡ç‰Œè¿”å›åˆ°åŸæ¥æºï¼‰
            for (const slot in gameData.combinationSlots) {
              const resourceId = gameData.combinationSlots[slot];
              const source = gameData.combinationSlotsSource[slot];
              if (resourceId) {
                if (nonConsumableBowls.includes(resourceId)) {
                  // ç¢—ç±»å¡ç‰Œè¿”å›åˆ°åŸæ¥æº
                  if (source === 'ground') {
                    const currentLocation = gameData.locations.find(loc => loc.currentLocation);
                    if (currentLocation) {
                      const locationId = currentLocation.id;
                      addResourceToGround(resourceId, 1);
                      console.log(`å°†ç¢—ç±»å¡ç‰Œ ${resourceId} æ”¾å›åœ°é¢æ `);
                    }
                  } else {
                    gameData.resources[resourceId].amount++;
                    console.log(`å°†ç¢—ç±»å¡ç‰Œ ${resourceId} æ”¾å›èƒŒåŒ…`);
                  }
                }
                // æ¸…ç©ºç»„åˆæ§½å’Œæ¥æºè®°å½•
                gameData.combinationSlots[slot] = null;
                gameData.combinationSlotsSource[slot] = null;
              }
            }

// æ›´æ–°UI
            updateCombinationSlots();
            updateGameData();
            checkCombination();

// æ›´æ–°ç›¸å…³èµ„æºå¡ç‰Œ
            for (const [resource, requiredAmount] of Object.entries(currentRecipe.ingredients)) {
              updateResourceCard(resource);
            }

// å¼¹å‡ºæ¸¸æˆå¤±è´¥æç¤ºçª—å£
            showNotification('æ¸¸æˆå¤±è´¥', 'æ¸¸æˆå¤±è´¥ï¼Œæœªèƒ½åˆ¶ä½œå‡ºæ–°çš„å¡ç‰Œ', 'error');
            
// æ˜¾ç¤ºå¤±è´¥æ¶ˆæ¯
            elements.combinationResult.innerHTML = `
              <div class="text-red-600">
                <i class="fa fa-times-circle" aria-hidden="true"></i>
                æ¸¸æˆå¤±è´¥ï¼Œæœªèƒ½åˆ¶ä½œå‡ºæ–°çš„å¡ç‰Œ
              </div>
            `;
          }
        });
      } else {
        // æ˜¾ç¤ºå¤±è´¥æ¶ˆæ¯
        elements.combinationResult.innerHTML = `
          <div class="text-red-600">
            <i class="fa fa-times-circle" aria-hidden="true"></i>
            è¿™äº›å¡ç‰Œæ— æ³•ç»„åˆã€‚
          </div>
        `;

showNotification('ç»„åˆå¤±è´¥', 'è¿™äº›å¡ç‰Œæ— æ³•ç»„åˆï¼Œè¯·å°è¯•å…¶ä»–ç»„åˆã€‚');
      }
    }

    // æ»‘å—å°æ¸¸æˆå®ç°
    function startSliderGame(config, callback) {
      console.log('startSliderGameå‡½æ•°è¢«è°ƒç”¨äº†ï¼');
      console.log('ä¼ å…¥çš„é…ç½®:', config);
      // é…ç½®é»˜è®¤å€¼
      const speed = config.speed || 2;
      const targetWidth = config.targetWidth || 0.3;
      const timeLimit = config.timeLimit || 10;

// è·å–DOMå…ƒç´ 
      const modal = elements.sliderGameModal;
      const track = elements.sliderTrack;
      const slider = elements.sliderTriangle;
      const target = elements.targetArea;
      const timer = elements.timerBar;
      const stopButton = elements.stopButton;

console.log('è·å–çš„DOMå…ƒç´ :', {
        modal: !!modal,
        track: !!track,
        slider: !!slider,
        target: !!target,
        timer: !!timer,
        stopButton: !!stopButton
      });

// åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
      let isPlaying = true;
      let isMovingRight = true;
      let sliderPosition;
      // æ‰‹åŠ¨è®¾ç½®æ»‘å—å®½åº¦ï¼ˆborder-left + border-right = 30pxï¼‰
      const sliderWidth = 30;
      let trackWidth, targetSize, targetX;
      let leftYellowStart, leftYellowEnd, rightYellowStart, rightYellowEnd;
      let yellowAreaStart, yellowAreaEnd;
      let gameLoop; // æ¸¸æˆå¾ªç¯å˜é‡æå‡åˆ°å¤–éƒ¨ä½œç”¨åŸŸ
      
      // è®¾ç½®è®¡æ—¶å™¨åˆå§‹çŠ¶æ€
      let timeRemaining = timeLimit;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      console.log('å°è¯•æ˜¾ç¤ºæ¨¡æ€æ¡†...');
      console.log('æ¨¡æ€æ¡†æ˜¯å¦å·²å­˜åœ¨:', !!modal);
      if (modal) {
        console.log('æ¨¡æ€æ¡†å½“å‰ç±»:', modal.className);
        modal.classList.add('active');
        console.log('æ·»åŠ activeç±»åçš„ç±»:', modal.className);
        console.log('æ¨¡æ€æ¡†æ˜¯å¦å¯è§:', modal.classList.contains('active'));
        console.log('æ¨¡æ€æ¡†è®¡ç®—æ ·å¼:', {
          opacity: window.getComputedStyle(modal).opacity,
          visibility: window.getComputedStyle(modal).visibility
        });
        
        // æ¨¡æ€æ¡†æ˜¾ç¤ºåå†è®¡ç®—å°ºå¯¸ï¼Œç¡®ä¿DOMå·²ç»æ¸²æŸ“
        setTimeout(() => {
          trackWidth = track.offsetWidth;
          targetSize = trackWidth * targetWidth;
          
          // è°ƒè¯•æ—¥å¿—ï¼šéªŒè¯è½¨é“å’Œæ»‘å—å°ºå¯¸
          console.log('æ»‘å—æ¸¸æˆå°ºå¯¸ä¿¡æ¯:', {
            trackWidth: trackWidth,
            sliderWidth: sliderWidth,
            targetSize: targetSize
          });

          // è®¾ç½®ç»¿è‰²åŒºåŸŸä½ç½®å’Œå¤§å°
          // ç»¿è‰²åŒºåŸŸéšæœºå‡ºç°åœ¨é»„è‰²åŒºåŸŸå†…
          const yellowAreaWidth = trackWidth - targetSize;
          targetX = Math.random() * yellowAreaWidth;
          target.style.width = targetSize + 'px';
          target.style.left = targetX + 'px';
          
          // è®¡ç®—åŒºåŸŸèŒƒå›´ï¼ˆåŸºäºCSSå¸ƒå±€ï¼šé»„è‰²åŒºåŸŸ + ç»¿è‰²åŒºåŸŸ + é»„è‰²åŒºåŸŸï¼‰
          // å·¦é»„è‰²åŒºåŸŸï¼š0 åˆ° ç»¿è‰²åŒºåŸŸå¼€å§‹ä½ç½®
          leftYellowStart = 0;
          leftYellowEnd = targetX;
          // ç»¿è‰²åŒºåŸŸï¼štargetX åˆ° targetX + targetSize
          // å³é»„è‰²åŒºåŸŸï¼šç»¿è‰²åŒºåŸŸç»“æŸä½ç½® åˆ° è½¨é“æœ€å³ç«¯
          rightYellowStart = targetX + targetSize;
          rightYellowEnd = trackWidth;
          
          // æ»‘å—ç§»åŠ¨èŒƒå›´ï¼šå·¦é»„è‰²åŒºåŸŸ + ç»¿è‰²åŒºåŸŸ + å³é»„è‰²åŒºåŸŸï¼ˆæ•´ä¸ªè½¨é“ï¼‰
          yellowAreaStart = leftYellowStart;      // å·¦é»„è‰²åŒºåŸŸæœ€å·¦ç«¯
          yellowAreaEnd = rightYellowEnd;         // å³é»„è‰²åŒºåŸŸæœ€å³ç«¯
          
          // åˆå§‹åŒ–æ»‘å—ä½ç½®åœ¨æ•´ä¸ªç§»åŠ¨èŒƒå›´çš„ä¸­å¿ƒï¼ˆå·¦é»„è‰² + ç»¿è‰² + å³é»„è‰²ï¼‰
          // æ»‘å—æ˜¯å‘ä¸‹çš„ä¸‰è§’å½¢ï¼Œå°–ç«¯åœ¨åº•éƒ¨ä¸­å¿ƒ
          sliderPosition = yellowAreaStart + (yellowAreaEnd - yellowAreaStart)/2 - sliderWidth/2;
          
          // åº”ç”¨åˆå§‹ä½ç½®
          slider.style.left = `${sliderPosition}px`;
          
          // è®¾ç½®è®¡æ—¶å™¨å®½åº¦
          timer.style.width = '100%';
          
          // å¼€å§‹æ¸¸æˆå¾ªç¯
          startGameLoop();
        }, 100); // ç­‰å¾…100msç¡®ä¿æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤ºå’Œæ¸²æŸ“
      } else {
        console.error('modalå…ƒç´ ä¸å­˜åœ¨ï¼');
      }

// æ¸¸æˆå¾ªç¯å‡½æ•°
      function startGameLoop() {
        gameLoop = setInterval(() => {
          if (!isPlaying) return;

          // æ›´æ–°æ»‘å—ä½ç½®
          if (isMovingRight) {
            sliderPosition += speed;
            // æ»‘å—å°–ç«¯åˆ°è¾¾å³é»„è‰²åŒºåŸŸæœ€å³ç«¯æ—¶åå‘ï¼ˆè½¨é“æœ€å³ç«¯ï¼‰
            if (sliderPosition + sliderWidth/2 >= yellowAreaEnd) {
              sliderPosition = yellowAreaEnd - sliderWidth/2;
              isMovingRight = false;
            }
          } else {
            sliderPosition -= speed;
            // æ»‘å—å°–ç«¯åˆ°è¾¾å·¦é»„è‰²åŒºåŸŸæœ€å·¦ç«¯æ—¶åå‘ï¼ˆè½¨é“æœ€å·¦ç«¯ï¼‰
            if (sliderPosition + sliderWidth/2 <= yellowAreaStart) {
              sliderPosition = yellowAreaStart - sliderWidth/2;
              isMovingRight = true;
            }
          }

          // åº”ç”¨æ»‘å—ä½ç½®
          slider.style.left = `${sliderPosition}px`;

          // æ›´æ–°è®¡æ—¶å™¨
          timeRemaining -= 0.016; // å‡è®¾60fps
          const timerPercentage = (timeRemaining / timeLimit) * 100;
          timer.style.width = `${Math.max(0, timerPercentage)}%`;

          // æ£€æŸ¥è¶…æ—¶
          if (timeRemaining <= 0) {
            isPlaying = false;
            clearInterval(gameLoop);
            modal.classList.remove('active');
            callback(false); // æ¸¸æˆå¤±è´¥
          }
        }, 16); // çº¦60fps
      }

// åœæ­¢æ¸¸æˆçš„å‡½æ•°
      const stopGame = () => {
        if (!isPlaying) return;

        isPlaying = false;
        clearInterval(gameLoop);

        // åœæ­¢æ»‘å—ç§»åŠ¨ï¼Œä½†ä¸ç«‹å³åˆ¤å®šç»“æœ
        // æ·»åŠ 1ç§’å»¶è¿Ÿåå†åˆ¤å®š
        setTimeout(() => {
          // æ£€æŸ¥æ»‘å—å°–ç«¯æ˜¯å¦åœ¨ç›®æ ‡åŒºåŸŸå†…
          // æ»‘å—æ˜¯ä¸‰è§’å½¢ï¼Œå°–ç«¯åœ¨ä¸­é—´ä½ç½®
          const sliderTip = sliderPosition + sliderWidth/2;
          const targetLeft = targetX;
          const targetRight = targetX + targetSize;

          // å¢åŠ å®¹é”™èŒƒå›´ï¼Œè§£å†³æ‰‹æœºè§¦æ‘¸ç²¾åº¦é—®é¢˜
          const tolerance = 5; // 5åƒç´ çš„å®¹é”™èŒƒå›´
          const isSuccess = sliderTip >= (targetLeft - tolerance) && sliderTip <= (targetRight + tolerance);

          // å…³é—­æ¨¡æ€æ¡†å¹¶å›è°ƒç»“æœ
          modal.classList.remove('active');
          callback(isSuccess);
        }, 1000); // 1ç§’å»¶è¿Ÿ
      };

// ç»‘å®šåœæ­¢æŒ‰é’®äº‹ä»¶
      stopButton.addEventListener('click', stopGame);

// ç»‘å®šæ‰‹æœºè§¦æ‘¸äº‹ä»¶
      stopButton.addEventListener('touchend', (e) => {
        e.preventDefault(); // é˜²æ­¢è§¦æ‘¸äº‹ä»¶è§¦å‘å…¶ä»–è¡Œä¸º
        stopGame();
      });

// ç»‘å®šç©ºæ ¼é”®äº‹ä»¶
      const handleKeyPress = (e) => {
        if (e.code === 'Space') {
          e.preventDefault();
          stopGame();
        }
      };

document.addEventListener('keydown', handleKeyPress);

// æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
      const cleanup = () => {
        stopButton.removeEventListener('click', stopGame);
        document.removeEventListener('keydown', handleKeyPress);
      };

// åœ¨æ¨¡æ€æ¡†å…³é—­æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
      modal.addEventListener('transitionend', () => {
        if (!modal.classList.contains('active')) {
          cleanup();
        }
      }, { once: true });
    }

    // æ›´æ–°ç»„åˆæ§½ - åªæ›´æ–°å¡ç‰Œç»„åˆåŒºåŸŸçš„æ§½ä½

// æ£€æŸ¥åœ°ç‚¹è¿›å…¥æ¡ä»¶
    function checkEntryConditions(location) {
      // ç‰¹æ®Šæ£€æŸ¥ï¼šé»‘å¸‚éœ€è¦é»‘è‰²æ–—ç¯·
      if (location.id === 'black_market') {
        // æ£€æŸ¥æ˜¯å¦ç©¿æˆ´äº†é»‘è‰²æ–—ç¯·
        let hasBlackCloakEquipped = false;

// æ–¹æ³•1ï¼šé€šè¿‡DOMæ£€æŸ¥ç‰¹æ®Šæ§½ä½æ˜¯å¦æœ‰é»‘è‰²æ–—ç¯·
        const specialSlot = document.querySelector('.equipment-slots .combination-slot[data-slot="special"]');
        if (specialSlot) {
          const equipmentItem = specialSlot.querySelector('.equipment-item');
          if (equipmentItem && (equipmentItem.getAttribute('data-resource') === 'black_cloak' || 
              equipmentItem.innerHTML.includes('é»‘è‰²æ–—ç¯·'))) {
            hasBlackCloakEquipped = true;
          }
        }

// æ–¹æ³•2ï¼šé€šè¿‡æ¸¸æˆæ•°æ®æ£€æŸ¥é»‘è‰²æ–—ç¯·æ˜¯å¦å·²è£…å¤‡
        if (gameData.resources.black_cloak && gameData.resources.black_cloak.equipped) {
          hasBlackCloakEquipped = true;
        }

if (!hasBlackCloakEquipped) {
          // æ˜¾ç¤ºæç¤ºï¼šä¸ç¬¦åˆè¿›å…¥æ¡ä»¶
          showNotification('ä¸ç¬¦åˆè¿›å…¥æ¡ä»¶', 'è¿›å…¥é»‘å¸‚éœ€è¦ç©¿æˆ´é»‘è‰²æ–—ç¯·ï¼Œä½ ç›®å‰æ²¡æœ‰ç©¿æˆ´ã€‚', true);
          return false;
        }
      }

if (!location.entryCondition) return true;

for (const [status, condition] of Object.entries(location.entryCondition)) {
        if (condition.min !== undefined && gameData.status[status] < condition.min) {
          // å¯¹äºå£°æœ›ä¸è¶³çš„æƒ…å†µï¼Œä½¿ç”¨ä¸æ”¾æ–‹é¥­æ—¥ç›¸åŒçš„æ¨¡æ€æ¡†æ ·å¼
          if (status === 'reputation') {
            showReputationModal(location.name, condition.min, gameData.status[status]);
          } else {
            showNotification('æ¡ä»¶ä¸è¶³', `è¿›å…¥${location.name}éœ€è¦${status}è‡³å°‘${condition.min}%ï¼Œä½ ç›®å‰åªæœ‰${gameData.status[status]}%ã€‚`, true);
          }
          return false;
        }
        if (condition.max !== undefined && gameData.status[status] > condition.max) {
          showNotification('æ¡ä»¶ä¸ç¬¦', `è¿›å…¥${location.name}éœ€è¦${status}ä¸è¶…è¿‡${condition.max}%ï¼Œä½ ç›®å‰æœ‰${gameData.status[status]}%ã€‚`, true);
          return false;
        }
      }

return true;
    }

// æ˜¾ç¤ºåœ°ç‚¹å›¾ç‰‡å¼¹çª—
    function showLocationImageModal(locationName, locationImage, callback) {
      // åˆ›å»ºå¸¦æœ‰éšæœºå¼¹è·³åŠ¨ç”»çš„æ–‡å­—
      const text = 'ç§»åŠ¨ä¸­........';
      let animatedText = '';
      for (let i = 0; i < text.length; i++) {
        // ä¸ºæ¯ä¸ªå­—ç¬¦åˆ›å»ºspanå…ƒç´ ï¼Œè®¾ç½®éšæœºå»¶è¿Ÿå’Œå¼¹è·³é«˜åº¦
        const delay = (i * 0.1) + (Math.random() * 0.3);
        const height = 10 + (Math.random() * 15);
        animatedText += `<span class="bounce-char" style="--delay: ${delay}s; --height: ${height}px;">${text[i]}</span>`;
      }
      
      // åˆ›å»ºæ¨¡æ€æ¡†å…ƒç´ 
      const modal = document.createElement('div');
      modal.className = 'location-image-modal active';
      modal.innerHTML = `
        <div class="location-image-modal-content">
          <img src="${locationImage}" alt="${locationName}" class="location-image-modal-image">
          <div class="location-image-modal-text">${animatedText}</div>
        </div>
      `;

      document.body.appendChild(modal);

      // è®¾ç½®å›ºå®šçª—å£å¤§å°ï¼Œä¸å…¶ä»–åœ°ç‚¹ä¿æŒä¸€è‡´
      const image = modal.querySelector('.location-image-modal-image');
      const content = modal.querySelector('.location-image-modal-content');
      
      const onImageLoad = () => {
        // ä½¿ç”¨å›¾ç‰‡çš„è‡ªç„¶å°ºå¯¸ï¼Œè®©çª—å£å®½åº¦ä¸å›¾ç‰‡å®½åº¦ä¸€è‡´
        // å›¾ç‰‡ä½¿ç”¨è‡ªç„¶å®½åº¦ï¼Œçª—å£è‡ªåŠ¨é€‚åº”
      };
      
      if (image.complete) {
        onImageLoad();
      } else {
        image.addEventListener('load', onImageLoad);
      }

      // å®šä¹‰å…³é—­æ¨¡æ€æ¡†çš„å‡½æ•°
      const closeModal = () => {
        modal.classList.remove('active');
        setTimeout(() => {
          if (document.body.contains(modal)) {
            document.body.removeChild(modal);
          }
          if (callback) {
            callback();
          }
        }, 300); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      };

      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .location-image-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

        .location-image-modal.active {
          opacity: 1;
          pointer-events: auto;
        }

        .location-image-modal-content {
          background-color: #FFFFFF;
          border: 2px solid #8B4513;
          border-radius: 8px;
          padding: 0;
          box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
          text-align: center;
          display: inline-block;
          margin: auto;
        }

        .location-image-modal-image {
          max-width: 60vw;
          max-height: 80vh;
          border-radius: 0;
          box-shadow: none;
          width: auto;
          height: auto;
        }

        .location-image-modal-text {
          margin-top: 15px;
          font-size: 18px;
          font-weight: normal;
          color: #8B4513;
          letter-spacing: 2px;
          width: 100%;
          box-sizing: border-box;
          padding: 0 10px 10px 10px;
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 2px;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .bounce-char {
          display: inline-block;
          animation: bounce 1s ease-in-out infinite;
          animation-delay: var(--delay);
          transform-origin: bottom center;
        }

        @keyframes bounce {
          0%, 100% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(calc(-1 * var(--height)));
          }
        }
      `;
      document.head.appendChild(style);

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ç‚¹å‡»å›¾ç‰‡å†…å®¹åŒºåŸŸå¯ä»¥ç«‹å³å…³é—­
      content.addEventListener('click', () => {
        closeModal();
      });

      // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­äº‹ä»¶
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // æ’­æ”¾åœºæ™¯åˆ‡æ¢éŸ³æ•ˆ
      playWalkingSound();
      
      // 1ç§’åè‡ªåŠ¨å…³é—­æ¨¡æ€æ¡†å¹¶æ‰§è¡Œå›è°ƒå‡½æ•°
      setTimeout(() => {
        closeModal();
        // åœæ­¢åœºæ™¯åˆ‡æ¢éŸ³æ•ˆ
        stopWalkingSound();
      }, 1000);
    }

// é€€å‡ºåœ°ç‚¹
    function exitLocation() {
      // è·å–å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);

if (!currentLocation) return;

// æ£€æŸ¥æ˜¯å¦åœ¨ç‰¢æˆ¿ä¸­ä¸”è¿˜æœ‰åˆ‘æœŸ
      if (currentLocation.id === 'prison') {
        const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
        if (prisonLocation && prisonLocation.sentenceDays > 0) {
          showNotification('æ— æ³•ç¦»å¼€', 'ä½ è¿˜åœ¨æœåˆ‘æœŸé—´ï¼Œæ— æ³•ç¦»å¼€ç‰¢æˆ¿ï¼');
          return;
        }
      }

// æ›´æ–°UI
      renderLocations();
      updateGameData();

// æ¨è¿›æ—¶é—´ï¼ˆç¦»å¼€åœ°ç‚¹ä¸æ¶ˆè€—æ—¶é—´ï¼‰
      // advanceTime(); // æ³¨é‡Šæ‰ï¼Œå› ä¸ºç¦»å¼€åœ°ç‚¹æœ¬èº«ä¸æ¶ˆè€—æ—¶é—´
    }

      // è®¿é—®åœ°ç‚¹
    function visitLocation(locationId) {
      // ç¡®ä¿æ ‡å¿—åˆå§‹åŒ–
      if (window.visitLocationInProgress === undefined) {
        window.visitLocationInProgress = false;
      }

      // é˜²é‡å¤è°ƒç”¨æ£€æŸ¥
      if (window.visitLocationInProgress) {
        console.log('visitLocationå‡½æ•°æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
        return;
      }

      // è®¾ç½®é˜²é‡å¤è°ƒç”¨æ ‡å¿—
      window.visitLocationInProgress = true;

      // æ ¹æ®åœ°ç‚¹IDè·å–åœ°ç‚¹æ•°æ®
      const location = gameData.locations.find(loc => loc.id === locationId);

      if (!location) {
        window.visitLocationInProgress = false;
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²åœ¨å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      if (currentLocation && currentLocation.id === locationId) {
        showNotification('å·²åœ¨è¯¥åœ°ç‚¹', `ä½ å·²ç»åœ¨${location.name}äº†ã€‚`);
        window.visitLocationInProgress = false;
        return;
      }

      // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¢æˆ¿ä¸­ä¸”è¿˜æœ‰åˆ‘æœŸï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å…è®¸åˆ‡æ¢åˆ°å…¶ä»–åœ°ç‚¹
      if (currentLocation && currentLocation.id === 'prison') {
        const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
        if (prisonLocation && prisonLocation.sentenceDays > 0 && locationId !== 'prison') {
          showNotification('æ— æ³•ç¦»å¼€', 'ä½ è¿˜åœ¨æœåˆ‘æœŸé—´ï¼Œæ— æ³•ç¦»å¼€ç‰¢æˆ¿ï¼');
          window.visitLocationInProgress = false;
          return;
        }
      }

      // æ£€æŸ¥æ˜¯å¦æ»¡è¶³è¿›å…¥æ¡ä»¶
      if (!checkEntryConditions(location)) {
        window.visitLocationInProgress = false;
        return;
      }

      // å®šä¹‰åœ°ç‚¹åç§°åˆ°å›¾ç‰‡æ–‡ä»¶çš„æ˜ å°„
      const locationImageMap = {
        'ä¸œè¥¿å¸‚': 'UI/ä¸œè¥¿å¸‚.jpg',
        'ç°å‘': 'UI/ç°å‘.jpg',
        'ä¸‡ä½›å¯º': 'UI/ä¸‡ä½›å¯º.jpg',
        'é”£é¼“å··': 'UI/é”£é¼“å··.jpg',
        'é¸¡æ¯›æˆ¿': 'UI/é¸¡æ¯›æˆ¿.jpg',
        'åŸå¤–å±±é‡': 'UI/åŸå¤–å±±é‡.jpg',
        'é»‘å¸‚': 'UI/é»‘å¸‚.jpg',
        'ç‰¢æˆ¿': 'UI/ç‰¢æˆ¿.jpg',
        'æˆ‘çš„å®…é‚¸': 'UI/æˆ‘çš„å®…é‚¸.jpg'
      };

      // è·å–å½“å‰åœ°ç‚¹å›¾ç‰‡
      const locationImage = locationImageMap[location.name];

      // æ›´æ–°å½“å‰åœ°ç‚¹ï¼ˆç«‹å³åˆ‡æ¢åœ°ç‚¹ï¼‰
      if (currentLocation) {
        currentLocation.currentLocation = false;
      }
      location.currentLocation = true;

      // æ›´æ–°UI
      renderResources();
      renderLocations(); // ç¡®ä¿åœ°ç‚¹æ ‡è¯†æ­£ç¡®æ›´æ–°
      renderActions(); // æ›´æ–°è¡ŒåŠ¨åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ–°åœ°ç‚¹çš„è¡ŒåŠ¨
      renderGroundResources(); // æ›´æ–°åœ°é¢èµ„æºï¼Œåªæ˜¾ç¤ºå½“å‰åœºæ™¯çš„å¡ç‰Œ
      updateGameData();

      // æ¶ˆè€—æ—¶é—´ï¼ˆæ ¹æ®åœ°ç‚¹çš„timeCostï¼‰
      const timeCost = location.timeCost || 30; // é»˜è®¤æ¶ˆè€—30åˆ†é’Ÿ
      advanceTime(timeCost);

      // æ›´æ–°å½“å‰åœºæ™¯å¹¶æ’­æ”¾åœºæ™¯éŸ³æ•ˆ
      gameData.currentScene = location.name;
      updateSceneSoundEffects();

      // æ¸…é™¤é˜²é‡å¤è°ƒç”¨æ ‡å¿—
      setTimeout(() => {
        window.visitLocationInProgress = false;
      }, 100);

      // æ˜¾ç¤ºåœ°ç‚¹å›¾ç‰‡å¼¹çª—ï¼ˆä»…ä½œä¸ºè§†è§‰åé¦ˆï¼Œä¸å½±å“åœ°ç‚¹åˆ‡æ¢ï¼‰
      showLocationImageModal(location.name, locationImage, () => {
        // åœºæ™¯åˆ‡æ¢çª—å£å…³é—­åæ˜¾ç¤ºè¿›å…¥é€šçŸ¥
        showNotification('è¿›å…¥åœ°ç‚¹', `ä½ è¿›å…¥äº†${location.name}ã€‚`);
        
        // å¦‚æœæ˜¯ä¸‡ä½›å¯ºï¼Œæ’­æ”¾å¯ºåº™æ•²é’ŸéŸ³æ•ˆ
        if (locationId === 'temple') {
          playTempleBellSound();
        }
      });
    }

    // æ‰§è¡Œè¡ŒåŠ¨
    function performAction(actionId) {

// æ ¹æ®è¡ŒåŠ¨IDè·å–è¡ŒåŠ¨æ•°æ®
      const action = gameData.actions.find(act => act.id === actionId);

if (!action) return;

// è·å–å½“å‰åœºæ™¯ID
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      const locationId = currentLocation ? currentLocation.id : 'slum';

// æ¶ˆè€—è¡ŒåŠ¨æ‰€éœ€çš„æ—¶é—´
      const timeCost = action.timeCost || 30; // é»˜è®¤æ¶ˆè€—30åˆ†é’Ÿ

// æ¶ˆè€—æ‰€éœ€èµ„æº
      if (action.requires) {
        for (const [resource, amount] of Object.entries(action.requires)) {
          // æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
          if (gameData.resources[resource] && typeof gameData.resources[resource].amount === 'number') {
            gameData.resources[resource].amount -= amount;
          } else {
            console.warn(`èµ„æº ${resource} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§`);
          }
        }
      }

// æ ¹æ®è¡ŒåŠ¨ç±»å‹ç”Ÿæˆä¸åŒçš„ç»“æœ
      switch (actionId) {
        // æ”¾æ–‹æ—¥è¡ŒåŠ¨åœ¨åé¢çš„switchè¯­å¥ä¸­å¤„ç†
        case 'beg':
          // ä¹è®¨
          let baseChance = 0.3; // åŸºç¡€å¤±è´¥æ¦‚ç‡ä¸º30%ï¼ŒæˆåŠŸç‡70%
          const begResults = {
            resources: {},
            status: {},
            effects: []
          };

// æ ¹æ®ç©å®¶æ‹¥æœ‰çš„ç¢—ç±»å‹è‡ªåŠ¨è°ƒæ•´ä¹è®¨æˆåŠŸç‡
          // ç¢—çš„ç­‰çº§ä»ä½åˆ°é«˜: ç ´ç¢—(bowl)ã€æ³¥ç¢—(clay_bowl)ã€é™¶ç¢—(pottery_bowl)ã€é“¶ç¢—(silver_bowl)ã€é‡‘ç¢—(gold_bowl)
          let bowlBonus = 0;
          let bowlName = '';

if (gameData.resources.gold_bowl && gameData.resources.gold_bowl.amount > 0) {
            bowlBonus = 50; // é‡‘ç¢—æä¾›50%æˆåŠŸç‡åŠ æˆ
            bowlName = 'é‡‘ç¢—';
          } else if (gameData.resources.silver_bowl && gameData.resources.silver_bowl.amount > 0) {
            bowlBonus = 30; // é“¶ç¢—æä¾›30%æˆåŠŸç‡åŠ æˆ
            bowlName = 'é“¶ç¢—';
          } else if (gameData.resources.pottery_bowl && gameData.resources.pottery_bowl.amount > 0) {
            bowlBonus = 20; // é™¶ç¢—æä¾›20%æˆåŠŸç‡åŠ æˆ
            bowlName = 'é™¶ç¢—';
          } else if (gameData.resources.clay_bowl.amount > 0) {
            bowlBonus = 10; // æ³¥ç¢—æä¾›10%æˆåŠŸç‡åŠ æˆ
            bowlName = 'æ³¥ç¢—';
          } else if (gameData.resources.bowl.amount > 0) {
            bowlBonus = 5; // ç ´ç¢—æä¾›5%æˆåŠŸç‡åŠ æˆ
            bowlName = 'ç ´ç¢—';
          }

// åˆå¹¶åŸºç¡€åŠ æˆå’Œç¢—åŠ æˆ
          const totalBeggingChance = gameData.begging_chance + bowlBonus;

if (totalBeggingChance > 0) {
            // æ¯10ç‚¹ä¹è®¨æˆåŠŸç‡é™ä½10%çš„å¤±è´¥æ¦‚ç‡
            baseChance = Math.max(0.1, 0.3 - (totalBeggingChance / 100));
            begResults.effects.push(`ä½¿ç”¨${bowlName}ï¼Œä¹è®¨æˆåŠŸç‡æå‡${totalBeggingChance}%`);
          }

const begSuccess = Math.random() > baseChance;

if (begSuccess) {
            if (action.success) {
              // 50%çš„æ¦‚ç‡è·å¾—é’±å¸ï¼Œ50%çš„æ¦‚ç‡è·å¾—æ®‹ç¾¹å‰©é¥­
              const getMoney = Math.random() < 0.5;

            if (getMoney) {
                // è·å¾—é’±å¸
                const moneyAmount = Math.max(1, Math.round(action.success.money));
                // å°†é’±å¸åªæ·»åŠ åˆ°åœ°é¢æ 
                addResourceToGround('money', moneyAmount, locationId);
                begResults.resources.money = moneyAmount;
                const moneyName = gameData.resources.money.name || 'é’±å¸';
                showNotification('ä¹è®¨æˆåŠŸ', `ä½ æˆåŠŸä¹è®¨åˆ°äº† ${moneyAmount} ä¸ª ${moneyName}ã€‚${gameData.begging_chance ? `(æˆåŠŸç‡æå‡${gameData.begging_chance}%)` : ''}`);
                // æ’­æ”¾ä¸¢ç¡¬å¸éŸ³æ•ˆ
                playSoundEffect('dropCoin', 'éŸ³æ•ˆ/ä¸¢ç¡¬å¸.wav', { volume: 0.7 });
              } else {
                // è·å¾—æ®‹ç¾¹å‰©é¥­
                const adjustedAmount = Math.max(1, Math.round(action.success.cangenshengfan || 1));
                // ç›´æ¥å°†æ®‹ç¾¹å‰©é¥­æ·»åŠ åˆ°åœ°é¢æ ï¼ˆä¸æ·»åŠ åˆ°èƒŒåŒ…æ ï¼‰
                addResourceToGround('cangenshengfan', adjustedAmount, locationId);
                begResults.resources.cangenshengfan = adjustedAmount;
                const cangenshengfanName = gameData.resources.cangenshengfan.name || 'æ®‹ç¾¹å‰©é¥­';
                showNotification('ä¹è®¨æˆåŠŸ', `ä½ æˆåŠŸä¹è®¨åˆ°äº† ${adjustedAmount} ä¸ª ${cangenshengfanName}ã€‚${gameData.begging_chance ? `(æˆåŠŸç‡æå‡${gameData.begging_chance}%)` : ''}`);
              }
            }
          } else {
            if (action.failure) {
              for (const [status, amount] of Object.entries(action.failure)) {
                gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                begResults.status[status] = amount;
              }
            }
            showNotification('ä¹è®¨å¤±è´¥', 'æ²¡æœ‰äººæ„¿æ„æ–½èˆä½ ï¼Œä½ çš„ç²¾ç¥çŠ¶æ€ä¸‹é™äº†ã€‚');
          }
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;

case 'rest':
          // ä¼‘æ¯ - æ¢å¤å¥åº·å’Œç²¾ç¥
          const restResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          // æ ¹æ®è¡ŒåŠ¨å®šä¹‰çš„æ¢å¤å€¼æ¢å¤çŠ¶æ€
          if (action.success) {
            for (const [status, amount] of Object.entries(action.success)) {
              gameData.status[status] = Math.min(100, gameData.status[status] + amount);
              restResults.status[status] = amount;
            }
            restResults.effects.push('ä½ æ‰¾äº†ä¸ªåœ°æ–¹ä¼‘æ¯ï¼Œæ„Ÿè§‰å¥½å¤šäº†ã€‚');
          }
          
          showNotification('ä¼‘æ¯æˆåŠŸ', 'ä½ æ‰¾äº†ä¸ªåœ°æ–¹ä¼‘æ¯ï¼Œæ„Ÿè§‰å¥½å¤šäº†ã€‚', true);
          // åˆ·æ–°èƒŒåŒ…UI
          renderResources();
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;
          
        case 'search':
          // æœå¯»
          // åŸºç¡€æˆåŠŸç‡60%ï¼Œæ¯çº§æœå¯»æŠ€èƒ½å¢åŠ 3%æˆåŠŸç‡
          const baseSearchChance = 0.4; // åŸºç¡€å¤±è´¥æ¦‚ç‡
          const searchLevelBonus = (gameData.skills.search && gameData.skills.search.level) ? gameData.skills.search.level * 0.03 : 0;
          const adjustedFailureChance = Math.max(0.1, baseSearchChance - searchLevelBonus); // æœ€ä½å¤±è´¥æ¦‚ç‡10%
          const searchSuccess = Math.random() > adjustedFailureChance;
          const searchResults = {
            resources: {},
            status: {},
            effects: []
          };

          if (searchSuccess) {
            if (action.success) {
              let itemsFound = 0;
              const maxItems = 1;

              // åˆ›å»ºèµ„æºæ•°ç»„å¹¶éšæœºæ’åºï¼Œç¡®ä¿ç‰©å“è·å¾—çš„éšæœºæ€§
              const resourcesArray = Object.entries(action.success);
              for (let i = resourcesArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [resourcesArray[i], resourcesArray[j]] = [resourcesArray[j], resourcesArray[i]];
              }

              // å­˜å‚¨è·å¾—çš„èµ„æºä¿¡æ¯ç”¨äºé€šçŸ¥
              let foundResourceName = '';
              
              // éå†éšæœºæ’åºåçš„èµ„æºï¼Œè·å¾—1ç§ç‰©å“
              for (const [resource, amount] of resourcesArray) {
                if (itemsFound < maxItems) { // 100% å‡ ç‡è·å¾—1ç§èµ„æº
                  // æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
                  if (gameData.resources[resource]) {
                    // ç›´æ¥å°†èµ„æºæ·»åŠ åˆ°åœ°é¢æ ï¼ˆä¸æ·»åŠ åˆ°èƒŒåŒ…æ ï¼‰
                    addResourceToGround(resource, 1, locationId);
                    gameData.stats.resourcesCollected++;
                    searchResults.resources[resource] = 1;
                    itemsFound++;
                    
                    // è®°å½•è·å¾—çš„èµ„æºåç§°
                    foundResourceName = gameData.resources[resource].name || resource;
                  } else {
                    console.warn(`èµ„æº ${resource} ä¸å­˜åœ¨`);
                  }
                }
              }

              // æœå¯»æˆåŠŸï¼Œå¢åŠ æœå¯»æŠ€èƒ½ç»éªŒå€¼
              if (gameData.skills.search) {
                const experienceGain = 1;
                gameData.skills.search.experience = (gameData.skills.search.experience || 0) + experienceGain;
                searchResults.effects.push(`æœå¯»æŠ€èƒ½ç»éªŒ +${experienceGain}`);

                // æ£€æŸ¥æ˜¯å¦å‡çº§
                checkSkillLevelUp('search', searchResults);
              }

              showNotification('æœå¯»æˆåŠŸ', `ä½ æ‰¾åˆ°äº†ä¸€äº›æœ‰ç”¨çš„ç‰©å“ï¼Œè·å¾—äº† ${foundResourceName}ã€‚` + (searchResults.effects.includes('è¯†åˆ«åˆ°è‰è¯') ? 'ä½ è¯†åˆ«å‡ºäº†ä¸€äº›è‰è¯ï¼' : ''));
              // showEventResult('æœå¯»ç»“æœ', searchResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
            }
          } else {
            if (action.failure) {
              for (const [status, amount] of Object.entries(action.failure)) {
                gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                searchResults.status[status] = amount;
              }
            }
            showNotification('æœå¯»å¤±è´¥', 'ä½ åœ¨æœå¯»è¿‡ç¨‹ä¸­å—ä¼¤äº†ã€‚');
            // showEventResult('æœå¯»ç»“æœ', searchResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          }
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;

        case 'loot':
          // ç¿»åƒåœ¾
          // æ˜¾ç¤ºç¿»åƒåœ¾æ¸¸æˆçª—å£
          showGarbageGame();
          // ä¸æ¶ˆè€—æ—¶é—´ï¼Œç­‰å¾…æ¸¸æˆç»“æŸ
          return;
          break;

        case 'nap':
          // å°æ†© (å¢åŠ 10%-20%éšæœºè¡€é‡å’Œç²¾ç¥å€¼)
          const napResults = {
            resources: {},
            status: {}
          };

          // å¢åŠ éšæœº10%-20%è¡€é‡å’Œç²¾ç¥å€¼ï¼Œç¡®ä¿è‡³å°‘æ¢å¤1ç‚¹
          const healthPercentage = 0.10 + Math.random() * 0.10; // 10%åˆ°20%ä¹‹é—´çš„éšæœºå€¼
          const spiritPercentage = 0.10 + Math.random() * 0.10; // 10%åˆ°20%ä¹‹é—´çš„éšæœºå€¼
          const healthIncrease = Math.max(1, Math.floor(gameData.status.health * healthPercentage));
          const spiritIncrease = Math.max(1, Math.floor(gameData.status.spirit * spiritPercentage));
          
          gameData.status.health = Math.min(100, gameData.status.health + healthIncrease);
          gameData.status.spirit = Math.min(100, gameData.status.spirit + spiritIncrease);
          napResults.status.health = healthIncrease;
          napResults.status.spirit = spiritIncrease;
          
          showNotification('å°æ†©æˆåŠŸ', `ä½ åœ¨å®…é‚¸ä¸­å°æ†©ï¼Œå¥åº·æ¢å¤${Math.floor(healthPercentage * 100)}%(${healthIncrease}ç‚¹)ï¼Œç²¾ç¥æ¢å¤${Math.floor(spiritPercentage * 100)}%(${spiritIncrease}ç‚¹)ã€‚`);
          // showEventResult('å°æ†©ç»“æœ', napResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          // åˆ·æ–°èƒŒåŒ…UI
          renderResources();
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;

case 'upgrade_house':
          // å‡çº§æˆ¿å±‹ - æ˜¾ç¤ºå‡çº§å¼¹çª—
          showHouseUpgradeModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          break;

        case 'farmland':
          // è°ƒç”¨æ–°çš„å†œç”°ç³»ç»Ÿ
          showFarmlandModal();
          break;

        case 'livestock_shed':
          // ç‰²å£æ£šç®¡ç†
          showLivestockShedModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          break;

        case 'fasting_day':
          // æ”¾æ–‹æ—¥è¡ŒåŠ¨ - æ€»æ˜¯æˆåŠŸè·å¾—æ–‹é¥­
          const fastingResults = {
            resources: {
              cornbread: 1,
              porridge: 1
            },
            status: {},
            effects: []
          };

// åº”ç”¨èµ„æºè·å¾—
          // ç›´æ¥å°†é£Ÿç‰©æ·»åŠ åˆ°åœ°é¢æ ï¼ˆä¸æ·»åŠ åˆ°èƒŒåŒ…æ ï¼‰
          addResourceToGround('cornbread', 1, locationId);
          addResourceToGround('porridge', 1, locationId);

// æ ‡è®°æ”¾æ–‹æ—¥å·²é¢†å–
          gameData.fastingDayClaimed = true;

// æ”¾æ–‹æ—¥è¡ŒåŠ¨ä¼šåœ¨renderActionså‡½æ•°ä¸­è‡ªåŠ¨éšè—ï¼Œæ— éœ€æ‰‹åŠ¨ç§»é™¤

// æ˜¾ç¤ºè·å¾—ç‰©å“çš„ç»“æœ
          // showEventResult('æ”¾æ–‹æ—¥', fastingResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          // é‡æ–°æ¸²æŸ“è¡ŒåŠ¨ä»¥éšè—å·²é¢†å–çš„æŒ‰é’®
          renderActions();
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;

case 'steal':
          // å·çªƒ
          const stealResults = {
            resources: {},
            status: {},
            effects: []
          };

          // è·å–å½“å‰ä½ç½®
          const currentLocation = gameData.locations.find(loc => loc.currentLocation);
          const isRichArea = currentLocation && currentLocation.id === 'rich_area'; // ä»ä½¿ç”¨IDåˆ¤æ–­ï¼Œä½†æ˜¾ç¤ºåç§°å·²æ”¹ä¸º"é”£é¼“å··"

          // é”£é¼“å··å·çªƒé€»è¾‘ - æ˜¾ç¤ºæ’¬é”å°æ¸¸æˆ
          if (isRichArea) {
            // æ˜¾ç¤ºæ’¬é”å°æ¸¸æˆ
            showLockpickGame();
            return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘
          }

          // éé”£é¼“å··çš„æ™®é€šå·çªƒé€»è¾‘
          // è®¡ç®—å·çªƒæˆåŠŸç‡ï¼ˆåŸºç¡€40%ï¼‰
          const baseStealChance = 0.4;
          // æŠ€èƒ½åŠ æˆï¼šæ¯çº§+5%æˆåŠŸç‡
          const skillBonus = gameData.skills.steal.level * 0.05;
          // å·å¤©æ¢æ—¥å­¦ä¹ åé¢å¤–+30%æˆåŠŸç‡
          const dayStealingBonus = gameData.skills.steal.specialAbilities?.includes('dayStealing') ? 0.3 : 0;
           // "å°å¿ƒä¸€ç‚¹"buffæƒ©ç½šï¼š-20%æˆåŠŸç‡
           const carefulBuffPenalty = gameData.buffs?.['å°å¿ƒä¸€ç‚¹']?.active ? 0.2 : 0;
          // è®¡ç®—æœ€ç»ˆæˆåŠŸç‡ï¼Œç¡®ä¿ä¸ä½äº0.1
          let totalStealChance = Math.min(0.95, baseStealChance + skillBonus + dayStealingBonus - carefulBuffPenalty);
          totalStealChance = Math.max(0.1, totalStealChance);

          const stealSuccess = Math.random() < totalStealChance;

if (isRichArea) {
            // é”£é¼“å··å·çªƒé€»è¾‘ - åªæœ‰æˆåŠŸå’Œå¤±è´¥ä¸¤ç§ç»“æœ
            if (stealSuccess) {
              // å·çªƒæˆåŠŸï¼Œè·å¾—ç‰©å“ - ç¡®ä¿è‡³å°‘è·å¾—1ä»¶ç‰©å“

// é”£é¼“å··å¯èƒ½å‡ºç°çš„ç‰©å“åŠå…¶æƒé‡ï¼ˆåªèƒ½è·å¾—é‡‘æ¡ã€ç¢é“¶å­æˆ–é‡‘å­ï¼‰
              const richAreaLootTable = [
                { resource: 'gold_bar', minAmount: 1, maxAmount: 1, weight: 1 },
                { resource: 'silver_piece', minAmount: 1, maxAmount: 1, weight: 2 },
                { resource: 'gold', minAmount: 1, maxAmount: 1, weight: 1 }
              ];

// åŠ æƒéšæœºé€‰æ‹©ç‰©å“
              let totalWeight = richAreaLootTable.reduce((sum, item) => sum + item.weight, 0);
              let random = Math.random() * totalWeight;
              let selectedItem = null;

for (const item of richAreaLootTable) {
                random -= item.weight;
                if (random <= 0) {
                  selectedItem = item;
                  break;
                }
              }

// ç¡®ä¿è‡³å°‘è·å¾—1ä»¶ç‰©å“
              if (selectedItem && selectedItem.resource in gameData.resources) {
                // è®¡ç®—ç‰©å“æ•°é‡ï¼ˆå›ºå®šä¸º1ä¸ªï¼‰
                const amount = 1;

// æ£€æŸ¥èµ„æºå¯¹è±¡å’Œamountå±æ€§æ˜¯å¦å­˜åœ¨
                if (gameData.resources[selectedItem.resource] && typeof gameData.resources[selectedItem.resource].amount === 'number') {
                  // å¢åŠ ç©å®¶èµ„æº
                  gameData.resources[selectedItem.resource].amount += amount;
                  // å°†ç‰©å“æ·»åŠ åˆ°åœ°é¢æ 
                  addResourceToGround(selectedItem.resource, amount, locationId);
                  stealResults.resources[selectedItem.resource] = amount;

                  // è·å–ç‰©å“åç§°ç”¨äºé€šçŸ¥
                  const itemName = gameData.resources[selectedItem.resource].name || selectedItem.resource;
                  showNotification('å·çªƒæˆåŠŸ', `ä½ åœ¨é”£é¼“å··æˆåŠŸå·åˆ°äº† ${amount} ä¸ª ${itemName}ï¼`);
                } else {
                  console.warn(`èµ„æº ${selectedItem.resource} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§`);
                }
              } else {
                // ä¿åº•é€»è¾‘ - å¦‚æœä»¥ä¸Šé€»è¾‘å¤±è´¥ï¼Œè‡³å°‘ç»™1ä¸ªé‡‘å¸
                if (gameData.resources.money && typeof gameData.resources.money.amount === 'number') {
                  gameData.resources.money.amount += 5;
                  // å°†é‡‘å¸æ·»åŠ åˆ°åœ°é¢æ 
                  addResourceToGround('money', 5, locationId);
                  stealResults.resources.money = 5;
                  showNotification('å·çªƒæˆåŠŸ', 'ä½ åœ¨é”£é¼“å··æˆåŠŸå·åˆ°äº† 5 ä¸ªé‡‘å¸ï¼');
                } else {
                  showNotification('å·çªƒæˆåŠŸ', 'ä½ åœ¨é”£é¼“å··æˆåŠŸå·åˆ°äº†ä¸€äº›è´µé‡ç‰©å“ï¼');
                }
              }

// æˆåŠŸå¥–åŠ±å·²ç»åœ¨å‰é¢çš„é€»è¾‘ä¸­å¤„ç†

              // æ£€æŸ¥æ˜¯å¦æœ‰"å¹¸è¿å„¿"BUFF
              if (gameData.buffs['å¹¸è¿å„¿'] && gameData.buffs['å¹¸è¿å„¿'].active) {
                // ç¡®ä¿è·å¾—é‡‘å­ã€é“¶å­æˆ–é‡‘æ¡
                const luckyLootTable = [
                  { resource: 'gold_bar', weight: 1 },
                  { resource: 'silver_piece', weight: 2 },
                  { resource: 'gold', weight: 1 }
                ];

                let totalWeight = luckyLootTable.reduce((sum, item) => sum + item.weight, 0);
                let random = Math.random() * totalWeight;
                let luckyItem = null;

                for (const item of luckyLootTable) {
                  random -= item.weight;
                  if (random <= 0) {
                    luckyItem = item;
                    break;
                  }
                }

                if (luckyItem && gameData.resources[luckyItem.resource]) {
                  gameData.resources[luckyItem.resource].amount += 1;
                  addResourceToGround(luckyItem.resource, 1, locationId);
                  stealResults.resources[luckyItem.resource] = (stealResults.resources[luckyItem.resource] || 0) + 1;

                  // ç§»é™¤"å¹¸è¿å„¿"BUFF
                  gameData.buffs['å¹¸è¿å„¿'].active = false;
                  delete gameData.buffs['å¹¸è¿å„¿'];
                  showNotification('å¹¸è¿ç”Ÿæ•ˆ', `å¹¸è¿å„¿BUFFç”Ÿæ•ˆï¼é¢å¤–è·å¾—äº†1ä¸ª${gameData.resources[luckyItem.resource].name}ï¼BUFFå·²æ¶ˆå¤±ã€‚`);
                }
              }

// å¢åŠ å·çªƒæŠ€èƒ½ç»éªŒ - æˆåŠŸæ—¶å¢åŠ 2ç‚¹
              if (gameData.skills.steal) {
                const experienceGain = 2;
                gameData.skills.steal.experience = (gameData.skills.steal.experience || 0) + experienceGain;

// æ·»åŠ ç»éªŒå¢åŠ åˆ°ç»“æœä¸­
                stealResults.effects = stealResults.effects || [];
                stealResults.effects.push(`å·çªƒæŠ€èƒ½ç»éªŒ +${experienceGain}`);

// æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§
                checkSkillLevelUp('steal', stealResults);

updateSkillDisplay(); // æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºUI
              }
            } else {
              // é”£é¼“å··å·çªƒå¤±è´¥ - ç›´æ¥è¢«æŠ“
              showNotification('å·çªƒå¤±è´¥', 'ä½ åœ¨é”£é¼“å··å·çªƒæ—¶è¢«å‘ç°å¹¶è¢«å·¡é€»é˜ŸæŠ“ä½äº†ï¼');

// æ·»åŠ å…³æŠ¼ä¿¡æ¯åˆ°äº‹ä»¶ç»“æœ
              stealResults.effects.push('è¢«å·¡é€»é˜ŸæŠ“ä½é€è¿›ç‰¢æˆ¿ï¼Œå…³æŠ¼4å¤©');

// å°†ç©å®¶é€å¾€ç‰¢æˆ¿
              sendToPrison();
              return; // ä¸ç»§ç»­æ‰§è¡Œåç»­ä»£ç 
            }
          } else {
            // éå¯ŒäººåŒºçš„æ™®é€šå·çªƒé€»è¾‘
            if (stealSuccess) {
              // å·çªƒæˆåŠŸï¼Œä¸å‡å°‘å£°æœ›

// æ™®é€šåŒºåŸŸå¯èƒ½å‡ºç°çš„ç‰©å“åŠå…¶æƒé‡ï¼ˆåªèƒ½è·å¾—é‡‘æ¡ã€ç¢é“¶å­æˆ–é‡‘å­ï¼‰
              const commonAreaLootTable = [
                { resource: 'gold_bar', minAmount: 1, maxAmount: 1, weight: 1 },
                { resource: 'silver_piece', minAmount: 1, maxAmount: 1, weight: 2 },
                { resource: 'gold', minAmount: 1, maxAmount: 1, weight: 1 }
              ];

// åŠ æƒéšæœºé€‰æ‹©ç‰©å“
              let totalWeight = commonAreaLootTable.reduce((sum, item) => sum + item.weight, 0);
              let random = Math.random() * totalWeight;
              let selectedItem = null;

for (const item of commonAreaLootTable) {
                random -= item.weight;
                if (random <= 0) {
                  selectedItem = item;
                  break;
                }
              }

// ç¡®ä¿è‡³å°‘è·å¾—1ä»¶ç‰©å“
              if (selectedItem && selectedItem.resource in gameData.resources) {
                // è®¡ç®—ç‰©å“æ•°é‡ï¼ˆå›ºå®šä¸º1ä¸ªï¼‰
                const amount = 1;

// æ£€æŸ¥èµ„æºå¯¹è±¡å’Œamountå±æ€§æ˜¯å¦å­˜åœ¨
                if (gameData.resources[selectedItem.resource] && typeof gameData.resources[selectedItem.resource].amount === 'number') {
                  // å¢åŠ ç©å®¶èµ„æº
                  gameData.resources[selectedItem.resource].amount += amount;
                  // å°†ç‰©å“æ·»åŠ åˆ°åœ°é¢æ 
                  addResourceToGround(selectedItem.resource, amount, locationId);
                  stealResults.resources[selectedItem.resource] = amount;
                } else {
                  console.warn(`èµ„æº ${selectedItem.resource} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§`);
                }
              }

// å¢åŠ å·çªƒæŠ€èƒ½ç»éªŒ - æˆåŠŸæ—¶å¢åŠ 2ç‚¹
              if (gameData.skills.steal) {
                const experienceGain = 2;
                gameData.skills.steal.experience = (gameData.skills.steal.experience || 0) + experienceGain;

// æ·»åŠ ç»éªŒå¢åŠ åˆ°ç»“æœä¸­
                stealResults.effects = stealResults.effects || [];
                stealResults.effects.push(`å·çªƒæŠ€èƒ½ç»éªŒ +${experienceGain}`);

// æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§
                checkSkillLevelUp('steal', stealResults);

updateSkillDisplay(); // æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºUI
              }

// è·å–ç‰©å“åç§°ç”¨äºé€šçŸ¥
              const itemName = selectedItem ? (gameData.resources[selectedItem.resource].name || selectedItem.resource) : 'é‡‘æ¡';
              showNotification('å·çªƒæˆåŠŸ', `ä½ æˆåŠŸå·åˆ°äº† ${itemName}ï¼`);
              // showNotification('å·çªƒæˆåŠŸ', 'ä½ æˆåŠŸå·åˆ°äº†ä¸€äº›ç‰©å“ï¼', true); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
            } else {
              // å·çªƒå¤±è´¥ï¼Œæœ‰æ¦‚ç‡è¢«æŠ“
              const caughtChance = 0.7; // 70%æ¦‚ç‡è¢«æŠ“
              const isCaught = Math.random() < caughtChance;

if (isCaught) {
                // è¢«æŠ“ä½ï¼Œé€è¿›ç‰¢æˆ¿
                showNotification('å·çªƒå¤±è´¥', 'ä½ åœ¨å·çªƒæ—¶è¢«å·¡é€»å£«å…µå‘ç°å¹¶è¢«æŠ“ä½äº†ï¼');

// æ·»åŠ å…³æŠ¼ä¿¡æ¯åˆ°äº‹ä»¶ç»“æœ
                stealResults.effects.push('è¢«å·¡é€»é˜ŸæŠ“ä½é€è¿›ç‰¢æˆ¿ï¼Œå…³æŠ¼4å¤©');

// showNotification('å·çªƒå¤±è´¥', 'ä½ è¢«æŠ“ä½å¹¶é€è¿›äº†ç‰¢æˆ¿ï¼', true); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º

// å°†ç©å®¶é€å¾€ç‰¢æˆ¿
                sendToPrison();
                return; // ä¸ç»§ç»­æ‰§è¡Œåç»­ä»£ç 
              } else {
                // æ²¡è¢«æŠ“ä½ï¼Œä½†å£°æœ›é™ä½
                if (action.failure) {
                  for (const [status, amount] of Object.entries(action.failure)) {
                    if (status !== 'reputation') { // ä¸å‡å°‘å£°æœ›
                      gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                      stealResults.status[status] = amount;
                    }
                  }
                }
                // é¢å¤–å‡å°‘å£°æœ›
                const reputationLoss = -15;
                gameData.status.reputation = Math.max(-49, gameData.status.reputation + reputationLoss);
                stealResults.status.reputation = reputationLoss;

showNotification('å·çªƒå¤±è´¥', 'ä½ åœ¨å·çªƒæ—¶å·®ç‚¹è¢«å‘ç°ï¼Œä¾¥å¹¸é€ƒè„±ï¼Œä½†å£°æœ›é™ä½äº†ã€‚');
                // showNotification('å·çªƒå¤±è´¥', 'ä½ è¢«æŠ“ä½å¹¶é€è¿›äº†ç‰¢æˆ¿ï¼', true); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
              }
            }
          }
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;

case 'donate':
          // æ•‘æµ
          const donateSuccess = Math.random() > 0.1; // 90% æˆåŠŸç‡
          const donateResults = {
            resources: {},
            status: {},
            effects: []
          };

if (donateSuccess) {
            if (action.success) {
              for (const [resource, amount] of Object.entries(action.success)) {
                if (resource in gameData.resources) {
                  gameData.resources[resource].amount += amount;
                  // å°†èµ„æºæ·»åŠ åˆ°åœ°é¢æ 
                  addResourceToGround(resource, amount, locationId);
                  donateResults.resources[resource] = amount;
                } else if (resource in gameData.status) {
                  gameData.status[resource] = Math.min(100, gameData.status[resource] + amount);
                  donateResults.status[resource] = amount;
                }
              }
            }
            showNotification('æ•‘æµæˆåŠŸ', 'ä¸‡ä½›å¯ºä¸ºä½ æä¾›äº†é£Ÿç‰©å’Œä½å®¿ï¼Œä½ çš„å¥åº·å’Œç²¾ç¥éƒ½æœ‰æ‰€æ¢å¤ã€‚');
            // showEventResult('æ•‘æµç»“æœ', donateResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          } else {
            showNotification('æ•‘æµå¤±è´¥', 'ä»Šå¤©ä¸‡ä½›å¯ºæ²¡æœ‰æä¾›æ•‘æµã€‚');
            // showEventResult('æ•‘æµç»“æœ', donateResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          }
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;

case 'pray':
          // ç¥ˆç¦ - æ€»æ˜¯æˆåŠŸ
          const prayResults = {
            resources: {},
            status: {},
            effects: []
          };

// ç¥ˆç¦æ€»æ˜¯æˆåŠŸï¼Œç›´æ¥åº”ç”¨æˆåŠŸæ•ˆæœ
          if (action.success) {
            for (const [status, amount] of Object.entries(action.success)) {
              gameData.status[status] = Math.min(100, gameData.status[status] + amount);
              prayResults.status[status] = amount;
            }
          }
          showNotification('ç¥ˆç¦æˆåŠŸ', 'ä½ çš„ç¥ˆç¥·å¾—åˆ°äº†å›åº”ï¼Œèº«å¿ƒå¾—åˆ°äº†æ…°è—‰ã€‚');
          // showEventResult('ç¥ˆç¦ç»“æœ', prayResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          // æ¶ˆè€—æ—¶é—´
          advanceTime(timeCost);
          break;

        case 'divination':
          // åœå¦ - æ˜¾ç¤ºåœå¦ç•Œé¢
          showDivinationModal();
          return; // ä¸æ¶ˆè€—æ—¶é—´ï¼Œç­‰å¾…æŠ½ç­¾å®Œæˆ
          break;

/* case 'trade':
          // äº¤æ˜“ - æš‚æ—¶æ³¨é‡Šæ‰ï¼ŒåæœŸå†è¡¥å……
          const tradeSuccess = Math.random() > 0.4; // 60% æˆåŠŸç‡
          const tradeResults = {
            resources: {},
            status: {},
            effects: []
          };

if (tradeSuccess) {
            if (action.success) {
              for (const [resource, amount] of Object.entries(action.success)) {
                if (gameData.resources[resource] && typeof gameData.resources[resource].amount === 'number') {
                  gameData.resources[resource].amount += amount;
                  tradeResults.resources[resource] = amount;
                } else {
                  console.warn(`èµ„æº ${resource} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§`);
                }
              }
            }
            showNotification('äº¤æ˜“æˆåŠŸ', 'ä½ æˆåŠŸä¸å…¶ä»–ä¹ä¸äº¤æ¢äº†ç‰©èµ„ã€‚');
            showEventResult('äº¤æ˜“ç»“æœ', tradeResults);
          } else {
            if (action.failure) {
              for (const [resource, amount] of Object.entries(action.failure)) {
                if (gameData.resources[resource] && typeof gameData.resources[resource].amount === 'number') {
                  gameData.resources[resource].amount = Math.max(0, gameData.resources[resource].amount + amount);
                  tradeResults.resources[resource] = amount;
                } else {
                  console.warn(`èµ„æº ${resource} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§`);
                }
              }
            }
            showNotification('äº¤æ˜“å¤±è´¥', 'ä½ åœ¨äº¤æ˜“ä¸­è¢«éª—ï¼ŒæŸå¤±äº†ä¸€äº›ç‰©èµ„ã€‚');
            showEventResult('äº¤æ˜“ç»“æœ', tradeResults);
          }
          break; */

case 'learn':
          // å‘è€ä¹ä¸å­¦ä¹ æ–°é…æ–¹
          const learnResults = {
            resources: {},
            status: {},
            effects: []
          };

          // æ£€æŸ¥å½“å¤©æ˜¯å¦å·²ç»å­¦ä¹ è¿‡
          if (gameData.learnedFromOldBeggarToday) {
            showNotification('ä¸è¦è´ªå¿ƒ', 'ä¸è¦è´ªå¿ƒï¼Œæ˜å¤©å†æ¥ï¼');
            // showEventResult('å­¦ä¹ ç»“æœ', learnResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          } else {
            // æ¯å¤©åªèƒ½å­¦ä¹ ä¸€æ¬¡ï¼Œå¿…å®šæˆåŠŸ
            if (action.success) {
              for (const [status, amount] of Object.entries(action.success)) {
                gameData.status[status] = Math.min(100, gameData.status[status] + amount);
                learnResults.status[status] = amount;
              }
            }

            // éšæœºè§£é”ä¸€ä¸ªæœªè§£é”çš„é…æ–¹
            const undiscoveredRecipes = gameData.recipes.filter(recipe => !gameData.discoveredRecipes.includes(recipe.id));
            if (undiscoveredRecipes.length > 0) {
              const recipeToDiscover = undiscoveredRecipes[Math.floor(Math.random() * undiscoveredRecipes.length)];
              gameData.discoveredRecipes.push(recipeToDiscover.id);
              gameData.stats.recipesDiscovered++;
              learnResults.effects.push(`è§£é”äº†æ–°é…æ–¹: ${recipeToDiscover.name}`);
              showNotification('å­¦ä¹ æˆåŠŸ', `ä½ å‘è€ä¹ä¸å­¦ä¼šäº†æ–°çš„åˆ¶ä½œæŠ€èƒ½ï¼Œè§£é”äº†${recipeToDiscover.name}çš„é…æ–¹ï¼`);
            } else {
              showNotification('å­¦ä¹ æˆåŠŸ', 'ä½ å‘è€ä¹ä¸å­¦ä¹ äº†æ–°çš„æŠ€èƒ½ï¼Œå£°æœ›æœ‰æ‰€æå‡ã€‚');
            }

            // æ ‡è®°å½“å¤©å·²ç»å­¦ä¹ è¿‡
            gameData.learnedFromOldBeggarToday = true;

            // showEventResult('å­¦ä¹ ç»“æœ', learnResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          }
          break;

case 'work':
          // åŠ³ä½œï¼ˆæ¶ˆè€—åŠå¤©æ—¶é—´ï¼Œå¿…å®šæˆåŠŸï¼‰
          const workResults = {
            resources: {},
            status: {},
            effects: []
          };

// æ¶ˆè€—åŠå¤©æ—¶é—´ï¼ˆå¢åŠ 1.5ä¸ªå›åˆï¼‰
          gameData.timeTurns += 1.5;
          advanceTime(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¨è¿›æ—¶é—´æ®µ

          // åŠ³ä½œå¿…å®šæˆåŠŸ
          if (action.success) {
            for (const [resource, amount] of Object.entries(action.success)) {
              if (resource in gameData.resources) {
                // ä½¿ç”¨æ‰¹æ¬¡ç³»ç»Ÿæ·»åŠ é£Ÿç‰©ï¼ˆç‰¢æˆ¿ä¸­çš„é£Ÿç‰©éœ€è¦æ·»åŠ æ‰¹æ¬¡ä¿¡æ¯ï¼‰
                const resourceData = gameData.resources[resource];
                if (resourceData.isPerishable) {
                  addFoodWithBatches(resource, amount);
                }
                
                // åªå°†èµ„æºæ·»åŠ åˆ°åœ°é¢æ ï¼Œä¸æ·»åŠ åˆ°èƒŒåŒ…
                addResourceToGround(resource, amount, locationId);
                workResults.resources[resource] = amount;
              }
            }
          }

          const foodName = gameData.resources.cangenshengfan.name || 'æ®‹ç¾¹å‰©é¥­';
          showNotification('åŠ³ä½œæˆåŠŸ', `ä½ é€šè¿‡åŠ³ä½œè·å¾—äº†ä¸€äº›${foodName}ã€‚`, true);
          // åˆ·æ–°èƒŒåŒ…UIï¼Œæ˜¾ç¤ºæ–°å¢çš„èµ„æºå’Œæ—¶æ•ˆæ€§å€’è®¡æ—¶
          renderResources();
          break;

      case 'gamble':
          // èµŒåš
          const gambleSuccess = Math.random() > 0.6; // 40% æˆåŠŸç‡
          const gambleResults = {
            resources: {},
            status: {},
            effects: []
          };

if (gambleSuccess) {
            if (action.success) {
              for (const [resource, amount] of Object.entries(action.success)) {
                if (gameData.resources[resource] && typeof gameData.resources[resource].amount === 'number') {
                  gameData.resources[resource].amount += amount;
                  // å°†èµ„æºæ·»åŠ åˆ°åœ°é¢æ 
                  addResourceToGround(resource, amount, locationId);
                  gambleResults.resources[resource] = amount;
                } else {
                  console.warn(`èµ„æº ${resource} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§`);
                }
              }
            }

showNotification('èµŒåšæˆåŠŸ', 'ä½ åœ¨èµŒåšä¸­èµ¢äº†ï¼', true);
          } else {
            if (action.failure) {
              for (const [resource, amount] of Object.entries(action.failure)) {
                if (gameData.resources[resource] && typeof gameData.resources[resource].amount === 'number') {
                  gameData.resources[resource].amount = Math.max(0, gameData.resources[resource].amount + amount);
                  gambleResults.resources[resource] = amount;
                } else if (resource in gameData.status) {
                  gameData.status[resource] = Math.max(0, gameData.status[resource] + amount);
                  gambleResults.status[resource] = amount;
                }
              }
            }

showNotification('èµŒåšå¤±è´¥', 'ä½ åœ¨èµŒåšä¸­è¾“äº†ï¼ŒæŸå¤±äº†ä¸€äº›é’±å¸ï¼Œç²¾ç¥çŠ¶æ€ä¹Ÿä¸‹é™äº†ã€‚');
            // showEventResult('èµŒåšç»“æœ', gambleResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          }
          break;

case 'buy_goods':
          // æ‰“å¼€é»‘å¸‚è´§æ¶
          openBlackMarketShelf();
          return; // ä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼Œä¸ç»“æŸå›åˆ
          break;

case 'buy_slave':
          // è´­ä¹°å¥´éš¶
          const buySlaveResults = {
            resources: {},
            status: {},
            effects: []
          };

// æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘æ¡
          if (gameData.resources.gold_bar.amount >= 3) {
            // æ¶ˆè€—é‡‘æ¡
            gameData.resources.gold_bar.amount -= 3;
            buySlaveResults.resources.gold_bar = -3;

// æ·»åŠ å¥´éš¶
            gameData.resources.slave.amount += 1;
            // å°†å¥´éš¶æ·»åŠ åˆ°åœ°é¢æ 
            addResourceToGround('slave', 1, locationId);
            buySlaveResults.resources.slave = 1;

showNotification('è´­ä¹°æˆåŠŸ', 'ä½ ç”¨3å¼ é»„é‡‘å¡ç‰Œè´­ä¹°äº†ä¸€ä¸ªå¥´éš¶ï¼å¥´éš¶æ¯å¤©ä¼šè‡ªåŠ¨å¸®ä½ æ”¶é›†èµ„æºã€‚');
            // showEventResult('è´­ä¹°ç»“æœ', buySlaveResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          } else {
            showNotification('è´­ä¹°å¤±è´¥', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„é»„é‡‘å¡ç‰Œï¼éœ€è¦3å¼ æ‰èƒ½è´­ä¹°å¥´éš¶ã€‚');
            // showEventResult('è´­ä¹°ç»“æœ', buySlaveResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
          }
          break;

case 'open_black_market_shelf':
          // æ‰“å¼€é»‘å¸‚è´§æ¶
          openBlackMarketShelf();
          return; // ä¸ç»“æŸå›åˆ

case 'talk_mystery':
          // ä¸ç¥ç§˜äººå¯¹è¯
          const talkMysteryResults = {
            resources: {},
            status: {},
            effects: []
          };

// æ£€æŸ¥æ˜¯å¦å·²ç»è§£é”é»‘å¸‚
          const blackMarketLocation = gameData.locations.find(loc => loc.id === 'black_market');
          if (blackMarketLocation && blackMarketLocation.available && gameData.flags.blackMarketUnlocked) {
            showNotification('å·²è§£é”é»‘å¸‚', 'ä½ å·²ç»çŸ¥é“äº†é»‘å¸‚çš„æ¶ˆæ¯ï¼Œå¯ä»¥éšæ—¶å‰å¾€ã€‚');
            // showEventResult('å¯¹è¯ç»“æœ', talkMysteryResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
            break;
          }

// åˆ›å»ºå¯¹è¯æ¡†ï¼Œè¯¢é—®æ˜¯å¦æ„¿æ„èŠ±è´¹10ä¸ªé’±å¸è·å¾—é»‘å¸‚æ¶ˆæ¯
          elements.eventTitle.textContent = 'ç¥ç§˜äººçš„æè®®';
          elements.eventText.textContent = 'ã€Œæƒ³è¦çŸ¥é“é»‘å¸‚çš„ä½ç½®å—ï¼Ÿè¿™å¯æ˜¯ä¸ªç§˜å¯†ï¼Œéœ€è¦èŠ±è´¹10ä¸ªé’±å¸æ‰èƒ½å‘Šè¯‰ä½ ...ã€';

// æ¸…ç©ºå¹¶æ·»åŠ é€‰é¡¹
          elements.eventOptions.innerHTML = '';

// åŒæ„é€‰é¡¹
          const agreeOption = document.createElement('div');
          agreeOption.className = 'event-modal-option';
          agreeOption.innerHTML = `
            <div class="event-modal-option-text">åŒæ„èŠ±è´¹10ä¸ªé’±å¸</div>
            <div class="event-modal-option-description">æ”¯ä»˜10ä¸ªé’±å¸ä»¥è·å–é»‘å¸‚ä½ç½®</div>
          `;

agreeOption.addEventListener('click', () => {
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é’±å¸
            if (gameData.resources.money && typeof gameData.resources.money.amount === 'number' && gameData.resources.money.amount >= 10) {
              // æ¶ˆè€—10ä¸ªé’±å¸
              gameData.resources.money.amount -= 10;
              talkMysteryResults.resources.money = -10;

// è§£é”é»‘å¸‚
              if (blackMarketLocation) {
                blackMarketLocation.available = true;
                // è®¾ç½®é»‘å¸‚è§£é”æ ‡å¿—
                gameData.flags.blackMarketUnlocked = true;
                talkMysteryResults.effects.push('è§£é”äº†é»‘å¸‚åœ°ç‚¹');
              }

// é‡æ–°æ¸²æŸ“åœ°ç‚¹æ ï¼Œæ˜¾ç¤ºé»‘å¸‚
              renderLocations();

showNotification('äº¤æ˜“æˆåŠŸ', 'ä½ æ”¯ä»˜äº†10ä¸ªé’±å¸ï¼Œç¥ç§˜äººå‘Šè¯‰ä½ äº†é»‘å¸‚çš„ä½ç½®ã€‚');
              showEventResult('å¯¹è¯ç»“æœ', talkMysteryResults);

// æ›´æ–°UI
              renderResources();
              updateGameData();

// æ¶ˆè€—æ—¶é—´
              advanceTime();
            } else {
              // æ˜¾ç¤ºé’±å¸ä¸è¶³çš„å¼¹çª—æç¤º
              showNoMoneyModal();
              // ä¸å†æ˜¾ç¤ºå¯¹è¯ç»“æœçª—å£ï¼Œé¿å…ä¸¤ä¸ªçª—å£åŒæ—¶å¼¹å‡º
            }

elements.eventModal.classList.remove('active');
          });

// æ·»åŠ æ‹’ç»æè®®æŒ‰é’®
          const closeButton = document.createElement('div');
          closeButton.className = 'event-modal-option';
          closeButton.style.backgroundColor = 'white'; // ç™½è‰²èƒŒæ™¯
          closeButton.innerHTML = `
            <div class="event-modal-option-text">æ‹’ç»æè®®</div>
            <div class="event-modal-option-description">ä¸æ”¯ä»˜é’±å¸ï¼Œç»“æŸå¯¹è¯</div>
          `;

closeButton.addEventListener('click', () => {
            // ç›´æ¥å…³é—­å¯¹è¯çª—å£ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
            closeEventModal();
          });

// æ·»åŠ åŒæ„é€‰é¡¹å’Œå…³é—­æŒ‰é’®åˆ°é€‰é¡¹å®¹å™¨
          elements.eventOptions.appendChild(agreeOption);
          elements.eventOptions.appendChild(closeButton);

// æ˜¾ç¤ºäº‹ä»¶æ¨¡æ€æ¡†
          elements.eventModal.classList.add('active');
          return; // ä¸ç»“æŸå›åˆ
          break;

case 'craft':
          // åˆ¶ä½œ
          renderRecipes();
          elements.recipeModal.classList.add('active');
          return; // ä¸ç»“æŸå›åˆ

        case 'get_water':
          // æ‰“æ°´å–è¡ŒåŠ¨ - æ˜¾ç¤ºé€‰æ‹©çª—å£
          showGetWaterModal();
          break;

        case 'stream_action':
          // æ˜¾ç¤ºæºªè¾¹é€‰é¡¹å¼¹çª—
          showStreamOptionsModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©

        case 'mountain_action':
          // æ˜¾ç¤ºå±±é‡é€‰é¡¹å¼¹çª—
          showMountainOptionsModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©

        case 'explore_map':
          // æ˜¾ç¤ºæ¢ç´¢åœ°å›¾çª—å£
          showExplorationModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ

        case 'farmland':
          // å†œç”°è¡ŒåŠ¨
          console.log('å†œç”°è¡ŒåŠ¨è¢«è§¦å‘');
          showFarmlandModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          break;

        case 'store_items':
          // ä»“åº“è¡ŒåŠ¨ - æ˜¾ç¤ºä»“åº“ç®¡ç†ç•Œé¢
          showStorageModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          break;

        case 'water_well':
          // æ°´äº•è¡ŒåŠ¨ - æ˜¾ç¤ºæ°´äº•é€‰é¡¹
          showWellModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          break;

        case 'icehouse':
          // å†°çª–è¡ŒåŠ¨ - æ˜¾ç¤ºå†°çª–ç®¡ç†ç•Œé¢
          showIcehouseModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          break;

        case 'stable':
          // é©¬å©è¡ŒåŠ¨ - æ‰“å¼€çª—å£
          showStableModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          break;

// ä»“åº“ç®¡ç†ç•Œé¢å‡½æ•°
      function showStorageModal() {
        // åˆ›å»ºä»“åº“æ¨¡æ€æ¡†å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'storage-modal';
        modalContainer.id = 'storageModal';
        
        // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
        const modalContent = document.createElement('div');
        modalContent.className = 'storage-modal-content ink-border';
        
        // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
        const modalHeader = document.createElement('div');
        modalHeader.className = 'storage-modal-header';
        
        // åˆ›å»ºæ ‡é¢˜
        const title = document.createElement('h2');
        title.className = 'storage-modal-title ink-text';
        title.textContent = 'ä»“åº“ç®¡ç†';
        modalHeader.appendChild(title);
        
        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.className = 'storage-modal-close';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        modalHeader.appendChild(closeButton);
        
        modalContent.appendChild(modalHeader);
        
        // åˆ›å»ºä¸»ä½“å†…å®¹åŒºåŸŸ
        const modalBody = document.createElement('div');
        modalBody.className = 'storage-modal-body';
        
        // åˆ›å»ºå·¦å³ä¸¤æ å¸ƒå±€
        const layoutContainer = document.createElement('div');
        layoutContainer.className = 'storage-layout';
        
        // å·¦ä¾§æ ï¼šèƒŒåŒ…èµ„æºå’Œåœ°é¢æ  - ä½¿ç”¨å‚ç›´å¸ƒå±€
        const leftPanel = document.createElement('div');
        leftPanel.className = 'crafting-left';
        leftPanel.style.padding = '1rem';
        leftPanel.style.display = 'flex';
        leftPanel.style.flexDirection = 'column';
        leftPanel.style.gap = '1rem';
        leftPanel.style.height = '100%';
        
        // èƒŒåŒ…èµ„æºéƒ¨åˆ†
        const inventorySection = document.createElement('div');
        inventorySection.style.display = 'flex';
        inventorySection.style.flexDirection = 'column';
        inventorySection.style.flex = '1';
        inventorySection.style.minHeight = '0';
        
        const leftTitle = document.createElement('h3');
        leftTitle.className = 'crafting-section-title';
        leftTitle.textContent = 'èƒŒåŒ…èµ„æº';
        leftTitle.style.marginBottom = '0.5rem';
        inventorySection.appendChild(leftTitle);
        
        const inventoryContainer = document.createElement('div');
        inventoryContainer.className = 'crafting-inventory';
        inventoryContainer.id = 'storageInventory';
        inventoryContainer.style.display = 'flex';
        inventoryContainer.style.flexWrap = 'wrap';
        inventoryContainer.style.gap = '0.5rem';
        inventoryContainer.style.padding = '0.5rem';
        inventoryContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
        inventoryContainer.style.borderRadius = '0.5rem';
        inventoryContainer.style.flex = '1';
        inventoryContainer.style.overflowY = 'auto';
        inventorySection.appendChild(inventoryContainer);
        
        // åœ°é¢æ éƒ¨åˆ†
        const groundSection = document.createElement('div');
        groundSection.style.display = 'flex';
        groundSection.style.flexDirection = 'column';
        groundSection.style.flex = '1';
        groundSection.style.minHeight = '0';
        
        const groundTitle = document.createElement('h3');
        groundTitle.className = 'crafting-section-title';
        groundTitle.textContent = 'åœ°é¢èµ„æºï¼ˆå®…é‚¸ï¼‰';
        groundTitle.style.marginBottom = '0.5rem';
        groundSection.appendChild(groundTitle);
        
        const groundContainer = document.createElement('div');
        groundContainer.className = 'crafting-inventory';
        groundContainer.id = 'storageGround';
        groundContainer.style.display = 'flex';
        groundContainer.style.flexWrap = 'wrap';
        groundContainer.style.gap = '0.5rem';
        groundContainer.style.padding = '0.5rem';
        groundContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
        groundContainer.style.borderRadius = '0.5rem';
        groundContainer.style.flex = '1';
        groundContainer.style.overflowY = 'auto';
        groundSection.appendChild(groundContainer);
        
        leftPanel.appendChild(inventorySection);
        leftPanel.appendChild(groundSection);
        
        // å³ä¾§æ ï¼šä»“åº“å­˜å‚¨åŒºåŸŸ - ä½¿ç”¨ä¸å†œç”°å·¦ä¾§æ ç›¸åŒçš„å¸ƒå±€
        const rightPanel = document.createElement('div');
        rightPanel.className = 'crafting-left';
        rightPanel.style.padding = '1rem';
        
        const rightTitle = document.createElement('h3');
        rightTitle.className = 'crafting-section-title';
        rightTitle.textContent = 'ä»“åº“å­˜å‚¨';
        rightPanel.appendChild(rightTitle);
        
        const warehouseContainer = document.createElement('div');
        warehouseContainer.className = 'crafting-inventory';
        warehouseContainer.id = 'storageWarehouse';
        warehouseContainer.style.display = 'flex';
        warehouseContainer.style.flexWrap = 'wrap';
        warehouseContainer.style.gap = '0.5rem';
        warehouseContainer.style.padding = '0.5rem';
        warehouseContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
        warehouseContainer.style.borderRadius = '0.5rem';
        warehouseContainer.style.flex = '1';
        warehouseContainer.style.overflowY = 'auto';
        rightPanel.appendChild(warehouseContainer);
        
        // ç»„è£…å¸ƒå±€
        layoutContainer.appendChild(leftPanel);
        layoutContainer.appendChild(rightPanel);
        modalBody.appendChild(layoutContainer);
        
        modalContent.appendChild(modalBody);
        modalContainer.appendChild(modalContent);
        
        document.body.appendChild(modalContainer);
        
        // å¡«å……æ•°æ®
        populateStorageModal();
        
        // è§¦å‘åŠ¨ç”»
        setTimeout(() => modalContainer.classList.add('active'), 10);
        
        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

      // å¡«å……ä»“åº“æ¨¡æ€æ¡†æ•°æ®
      function populateStorageModal() {
        const inventoryContainer = document.getElementById('storageInventory');
        const groundContainer = document.getElementById('storageGround');
        const warehouseContainer = document.getElementById('storageWarehouse');

        if (!inventoryContainer || !groundContainer || !warehouseContainer) return;

        // æ¸…ç©ºå®¹å™¨
        inventoryContainer.innerHTML = '';
        groundContainer.innerHTML = '';
        warehouseContainer.innerHTML = '';

        // åˆå§‹åŒ–ä»“åº“æ•°æ®ç»“æ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (!gameData.warehouse) {
          gameData.warehouse = {};
        }

        // æ˜¾ç¤ºèƒŒåŒ…èµ„æºï¼ˆæ•°é‡å¤§äº0çš„èµ„æºï¼Œæ’é™¤empty_bucketï¼Œå®ƒåªæ˜¯bucketçš„å¼•ç”¨ï¼‰
        Object.entries(gameData.resources).forEach(([resourceId, resourceData]) => {
          if (resourceData.amount > 0 && resourceId !== 'slave' && resourceId !== 'empty_bucket') {
            const resourceCard = createStorageResourceCard(resourceId, resourceData, 'inventory');
            inventoryContainer.appendChild(resourceCard);
          }
        });

        // æ˜¾ç¤ºå®…é‚¸åœ°é¢èµ„æº
        if (gameData.groundResources && gameData.groundResources['my_mansion']) {
          gameData.groundResources['my_mansion'].forEach((groundItem, index) => {
            if (groundItem.amount > 0 && gameData.resources[groundItem.resourceId]) {
              const resourceCard = createStorageResourceCard(groundItem.resourceId, gameData.resources[groundItem.resourceId], 'ground', groundItem.amount, index);
              groundContainer.appendChild(resourceCard);
            }
          });
        }

        // æ˜¾ç¤ºä»“åº“èµ„æº
        Object.entries(gameData.warehouse).forEach(([resourceId, amount]) => {
          if (amount > 0 && gameData.resources[resourceId]) {
            const resourceCard = createStorageResourceCard(resourceId, gameData.resources[resourceId], 'warehouse', amount);
            warehouseContainer.appendChild(resourceCard);
          }
        });
      }

      // åˆ›å»ºå­˜å‚¨èµ„æºå¡ç‰‡
      function createStorageResourceCard(resourceId, resourceData, type, amount = 0, groundIndex = -1) {
        const card = document.createElement('div');
        card.className = 'crafting-inventory-card';
        card.dataset.resourceId = resourceId;
        card.dataset.type = type;
        if (groundIndex >= 0) {
          card.dataset.groundIndex = groundIndex;
        }

        // æ·»åŠ åŒå‡»æç¤ºæ–‡æœ¬
        if (type === 'inventory') {
          card.title = 'åŒå‡»å­˜å‚¨åˆ°ä»“åº“';
        } else if (type === 'ground') {
          card.title = 'åŒå‡»å­˜å‚¨åˆ°ä»“åº“';
        } else {
          card.title = 'åŒå‡»å–å›åˆ°èƒŒåŒ…';
        }

        // æ·»åŠ åŒå‡»äº‹ä»¶å¤„ç†
        card.addEventListener('dblclick', function() {
          // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
          this.classList.add('double-clicked');
          setTimeout(() => this.classList.remove('double-clicked'), 300);

          if (type === 'inventory') {
            // åŒå‡»å·¦ä¾§èƒŒåŒ…èµ„æº - å­˜å‚¨åˆ°ä»“åº“
            handleStoreResource(resourceId, resourceData.amount);
          } else if (type === 'ground') {
            // åŒå‡»åœ°é¢æ èµ„æº - å­˜å‚¨åˆ°ä»“åº“
            handleStoreGroundResource(resourceId, amount, groundIndex);
          } else {
            // åŒå‡»å³ä¾§ä»“åº“èµ„æº - å–å›åˆ°èƒŒåŒ…
            handleRetrieveResource(resourceId, amount);
          }
        });

        // å¤„ç†æœ¨æ¡¶çš„ç‰¹æ®Šæ˜¾ç¤ºé€»è¾‘
        let displayImage = resourceData.image;
        let displayName = resourceData.name;
        if (resourceId === 'bucket') {
          // æ ¹æ®waterLevelåŠ¨æ€è®¾ç½®å›¾ç‰‡
          if (resourceData.waterLevel >= 200) {
            displayImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
          } else if (resourceData.waterLevel > 0) {
            displayImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            displayImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
          }
          displayName = 'æœ¨æ¡¶';
        }

        const image = document.createElement('div');
        image.className = 'crafting-card-image';
        image.style.backgroundImage = `url('${displayImage}')`;
        image.style.position = 'relative';
        image.style.overflow = 'visible';

        // ä¸ºæœ¨æ¡¶æ·»åŠ æ°´ä½æŒ‡ç¤ºæ¡ï¼ˆåœ¨å›¾ç‰‡å·¦ä¾§ï¼‰
        if (resourceId === 'bucket' && resourceData.waterLevel !== undefined) {
          const waterIndicator = document.createElement('div');
          waterIndicator.className = 'water-level-indicator-backpack';
          waterIndicator.style.cssText = `
            position: absolute;
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 70px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            z-index: 10;
          `;

          // åˆ›å»º5ä¸ªæ°´ä½æ ¼
          const waterLevel = resourceData.waterLevel;
          const filledLevels = Math.floor(waterLevel / 50);

          for (let i = 0; i < 5; i++) {
            const waterCell = document.createElement('div');
            const isFilled = i >= (5 - filledLevels);

            waterCell.style.cssText = `
              flex: 1;
              border: 1px solid #8B4513;
              background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'};
              border-radius: 2px;
              transition: background-color 0.3s ease;
            `;

            waterIndicator.appendChild(waterCell);
          }

          image.appendChild(waterIndicator);
        }

        const name = document.createElement('div');
        name.className = 'crafting-card-title';

        if (type === 'inventory') {
          name.textContent = `${displayName} Ã— ${resourceData.amount}`;
        } else {
          name.textContent = `${displayName} Ã— ${amount}`;
        }

        // ä¸ºæœ¨æ¡¶æ·»åŠ è€ä¹…åº¦æ˜¾ç¤º
        if (resourceId === 'bucket' && resourceData.durability !== undefined) {
          const durabilityDiv = document.createElement('div');
          durabilityDiv.className = 'crafting-card-durability';
          durabilityDiv.style.cssText = `
            font-size: 0.6rem;
            color: ${resourceData.durability > 50 ? '#38A169' : resourceData.durability > 20 ? '#D69E2E' : '#E53E3E'};
            text-align: center;
            margin-top: 2px;
          `;
          durabilityDiv.textContent = `è€ä¹…: ${resourceData.durability}%`;
          name.appendChild(durabilityDiv);
        }

        card.appendChild(image);
        card.appendChild(name);

        return card;
      }

      // å¤„ç†å­˜å‚¨èµ„æºåˆ°ä»“åº“
      function handleStoreResource(resourceId, currentAmount) {
        if (currentAmount <= 0) return;
        
        // å¦‚æœæ•°é‡å¤§äº1ï¼Œæ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£
        if (currentAmount > 1) {
          showStorageAmountModal(resourceId, currentAmount, 'store');
        } else {
          // ç›´æ¥å­˜å‚¨å•ä¸ªèµ„æº
          storeResource(resourceId, 1);
        }
      }

      // å¤„ç†ä»ä»“åº“å–å›èµ„æº
      function handleRetrieveResource(resourceId, warehouseAmount) {
        if (warehouseAmount <= 0) return;

        // å¦‚æœæ•°é‡å¤§äº1ï¼Œæ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£
        if (warehouseAmount > 1) {
          showStorageAmountModal(resourceId, warehouseAmount, 'retrieve');
        } else {
          // ç›´æ¥å–å›å•ä¸ªèµ„æº
          retrieveResource(resourceId, 1);
        }
      }

      // å¤„ç†ä»åœ°é¢æ å­˜å‚¨åˆ°ä»“åº“
      function handleStoreGroundResource(resourceId, groundAmount, groundIndex) {
        if (groundAmount <= 0) return;

        // å¦‚æœæ•°é‡å¤§äº1ï¼Œæ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£
        if (groundAmount > 1) {
          showStorageGroundAmountModal(resourceId, groundAmount, groundIndex, 'store');
        } else {
          // ç›´æ¥å­˜å‚¨å•ä¸ªèµ„æº
          storeGroundResource(resourceId, 1, groundIndex);
        }
      }

      // æ˜¾ç¤ºå­˜å‚¨/å–å›æ•°é‡é€‰æ‹©çª—å£
      function showStorageAmountModal(resourceId, maxAmount, actionType) {
        const resourceName = gameData.resources[resourceId].name;
        
        // åˆ›å»ºæ•°é‡é€‰æ‹©æ¨¡æ€æ¡†
        const modalContainer = document.createElement('div');
        modalContainer.className = 'storage-amount-modal active';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'storage-amount-modal-content ink-border';
        
        const title = document.createElement('h3');
        title.className = 'storage-amount-modal-title';
        title.textContent = actionType === 'store' ? `å­˜å‚¨ ${resourceName}` : `å–å› ${resourceName}`;
        
        const description = document.createElement('p');
        description.className = 'storage-amount-modal-description';
        description.textContent = `è¯·é€‰æ‹©è¦${actionType === 'store' ? 'å­˜å‚¨' : 'å–å›'}çš„æ•°é‡ (æœ€å¤§: ${maxAmount})`;
        
        // åˆ›å»ºé€‰é¡¹æŒ‰é’®
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'storage-amount-options';
        
        // å…¨éƒ¨æŒ‰é’®
        const allButton = document.createElement('button');
        allButton.className = 'storage-amount-button storage-amount-all';
        allButton.textContent = 'å…¨éƒ¨';
        allButton.onclick = function() {
          if (actionType === 'store') {
            storeResource(resourceId, maxAmount);
          } else {
            retrieveResource(resourceId, maxAmount);
          }
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        
        // è‡ªå®šä¹‰æ•°é‡æŒ‰é’®
        const customButton = document.createElement('button');
        customButton.className = 'storage-amount-button storage-amount-custom';
        customButton.textContent = 'è¾“å…¥æ•°é‡';
        customButton.onclick = function() {
          showCustomAmountInput(resourceId, maxAmount, actionType);
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        
        // å–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.className = 'storage-amount-button storage-amount-cancel';
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        
        optionsContainer.appendChild(allButton);
        optionsContainer.appendChild(customButton);
        optionsContainer.appendChild(cancelButton);
        
        modalContent.appendChild(title);
        modalContent.appendChild(description);
        modalContent.appendChild(optionsContainer);
        modalContainer.appendChild(modalContent);
        
        document.body.appendChild(modalContainer);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

      // æ˜¾ç¤ºè‡ªå®šä¹‰æ•°é‡è¾“å…¥çª—å£
      function showCustomAmountInput(resourceId, maxAmount, actionType) {
        const resourceName = gameData.resources[resourceId].name;
        
        const modalContainer = document.createElement('div');
        modalContainer.className = 'storage-amount-input-modal active';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'storage-amount-input-modal-content ink-border';
        
        const title = document.createElement('h3');
        title.className = 'storage-amount-input-modal-title';
        title.textContent = actionType === 'store' ? `å­˜å‚¨ ${resourceName}` : `å–å› ${resourceName}`;
        
        const description = document.createElement('p');
        description.className = 'storage-amount-input-modal-description';
        description.textContent = `è¯·è¾“å…¥è¦${actionType === 'store' ? 'å­˜å‚¨' : 'å–å›'}çš„æ•°é‡ (1-${maxAmount})`;
        
        // è¾“å…¥æ¡†
        const inputContainer = document.createElement('div');
        inputContainer.className = 'storage-amount-input-container';
        
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'storage-amount-input';
        input.min = '1';
        input.max = maxAmount;
        input.value = '1';
        input.placeholder = `è¾“å…¥æ•°é‡ (1-${maxAmount})`;
        
        inputContainer.appendChild(input);
        
        // æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'storage-amount-input-buttons';
        
        const confirmButton = document.createElement('button');
        confirmButton.className = 'storage-amount-input-confirm';
        confirmButton.textContent = 'ç¡®è®¤';
        confirmButton.onclick = function() {
          const amount = parseInt(input.value);
          if (amount >= 1 && amount <= maxAmount) {
            if (actionType === 'store') {
              storeResource(resourceId, amount);
            } else {
              retrieveResource(resourceId, amount);
            }
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          } else {
            showNotification('æç¤º', `è¯·è¾“å…¥1-${maxAmount}ä¹‹é—´çš„æ•°é‡`);
          }
        };
        
        const cancelButton = document.createElement('button');
        cancelButton.className = 'storage-amount-input-cancel';
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        
        buttonContainer.appendChild(confirmButton);
        buttonContainer.appendChild(cancelButton);
        
        modalContent.appendChild(title);
        modalContent.appendChild(description);
        modalContent.appendChild(inputContainer);
        modalContent.appendChild(buttonContainer);
        modalContainer.appendChild(modalContent);
        
        document.body.appendChild(modalContainer);
        
        // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
        setTimeout(() => input.focus(), 100);
        
        // å›è½¦é”®ç¡®è®¤
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            confirmButton.click();
          }
        });
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

      // å®é™…å­˜å‚¨èµ„æºåˆ°ä»“åº“
      function storeResource(resourceId, amount) {
        const resourceData = gameData.resources[resourceId];
        
        if (resourceData && resourceData.amount >= amount) {
          // åˆå§‹åŒ–ä»“åº“æ•°æ®
          if (!gameData.warehouse[resourceId]) {
            gameData.warehouse[resourceId] = 0;
          }
          
          // ç§»åŠ¨èµ„æºåˆ°ä»“åº“
          gameData.warehouse[resourceId] += amount;
          resourceData.amount -= amount;
          
          // æ›´æ–°UI
          populateStorageModal();
          renderResources();
          updateGameData();
          
          showNotification('å­˜å‚¨æˆåŠŸ', `å·²å­˜å‚¨ ${amount} ä¸ª ${resourceData.name} åˆ°ä»“åº“`);
        }
      }

      // å®é™…ä»ä»“åº“å–å›èµ„æº
      function retrieveResource(resourceId, amount) {
        const warehouseAmount = gameData.warehouse[resourceId];
        const resourceData = gameData.resources[resourceId];

        if (warehouseAmount >= amount) {
          // ç§»åŠ¨èµ„æºä»ä»“åº“åˆ°èƒŒåŒ…
          resourceData.amount += amount;
          gameData.warehouse[resourceId] -= amount;

          // å¦‚æœä»“åº“æ•°é‡ä¸º0ï¼Œç§»é™¤è¯¥èµ„æºé¡¹
          if (gameData.warehouse[resourceId] <= 0) {
            delete gameData.warehouse[resourceId];
          }

          // æ›´æ–°UI
          populateStorageModal();
          renderResources();
          updateGameData();

          showNotification('å–å›æˆåŠŸ', `å·²ä»ä»“åº“å–å› ${amount} ä¸ª ${resourceData.name}`);
        }
      }

// å†°çª–ç®¡ç†ç•Œé¢å‡½æ•°
      function showIcehouseModal() {
        // åˆå§‹åŒ–å†°çª–æ•°æ®
        if (!gameData.icehouse) {
          gameData.icehouse = {
            items: {}, // å­˜å‚¨çš„æ—¶æ•ˆæ€§é£Ÿç‰© { resourceId: [{ amount, expirationDay, originalExpirationDays }] }
            iceBlock: null // å†°å—å¡ç‰Œä¿¡æ¯ { amount, expirationDay, remainingDays }
          };
        }

        // åˆ›å»ºå†°çª–æ¨¡æ€æ¡†å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'icehouse-modal active';
        modalContainer.id = 'icehouseModal';

        // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.className = 'icehouse-modal-content ink-border';

        // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
        const modalHeader = document.createElement('div');
        modalHeader.className = 'icehouse-modal-header';

        // åˆ›å»ºæ ‡é¢˜
        const title = document.createElement('h2');
        title.className = 'icehouse-modal-title ink-text';
        title.textContent = 'å†°çª–ä¿é²œ';
        modalHeader.appendChild(title);

        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.className = 'icehouse-modal-close';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        modalHeader.appendChild(closeButton);

        modalContent.appendChild(modalHeader);

        // åˆ›å»ºä¸»ä½“å†…å®¹åŒºåŸŸ
        const modalBody = document.createElement('div');
        modalBody.className = 'icehouse-modal-body';

        // åˆ›å»ºå·¦å³ä¸¤æ å¸ƒå±€
        const layoutContainer = document.createElement('div');
        layoutContainer.className = 'icehouse-layout';

        // å·¦ä¾§æ ï¼šæ—¶æ•ˆæ€§é£Ÿç‰©
        const leftPanel = document.createElement('div');
        leftPanel.className = 'icehouse-left';

        const leftTitle = document.createElement('h3');
        leftTitle.className = 'icehouse-section-title';
        leftTitle.textContent = 'æ—¶æ•ˆæ€§é£Ÿç‰©';
        leftPanel.appendChild(leftTitle);

        const perishableContainer = document.createElement('div');
        perishableContainer.className = 'icehouse-inventory';
        perishableContainer.id = 'icehousePerishable';
        leftPanel.appendChild(perishableContainer);

        // å³ä¾§æ ï¼šå†°çª–å­˜å‚¨åŒºåŸŸ
        const rightPanel = document.createElement('div');
        rightPanel.className = 'icehouse-right';

        // å†°å—æ”¾ç½®åŒºåŸŸ
        const iceBlockSection = document.createElement('div');
        iceBlockSection.className = 'icehouse-ice-block-section';

        const iceBlockTitle = document.createElement('h3');
        iceBlockTitle.className = 'icehouse-section-title';
        iceBlockTitle.textContent = 'å†°å—æ”¾ç½®åŒº';
        iceBlockSection.appendChild(iceBlockTitle);

        const iceBlockContainer = document.createElement('div');
        iceBlockContainer.className = 'icehouse-ice-block-container';
        iceBlockContainer.id = 'icehouseIceBlock';
        iceBlockContainer.style.position = 'relative';
        iceBlockContainer.style.minHeight = 'auto';
        iceBlockContainer.style.display = 'flex';
        iceBlockContainer.style.justifyContent = 'center';
        iceBlockContainer.style.alignItems = 'center';
        iceBlockContainer.style.padding = '0.5rem';
        iceBlockContainer.style.gap = '1rem';
        iceBlockSection.appendChild(iceBlockContainer);

        rightPanel.appendChild(iceBlockSection);

        const rightTitle = document.createElement('h3');
        rightTitle.className = 'icehouse-section-title';
        rightTitle.textContent = 'å†°çª–å­˜å‚¨ï¼ˆä¿é²œåŒºåŸŸï¼‰';
        rightPanel.appendChild(rightTitle);

        const storageContainer = document.createElement('div');
        storageContainer.className = 'icehouse-storage';
        storageContainer.id = 'icehouseStorage';
        rightPanel.appendChild(storageContainer);

        // ç»„è£…å¸ƒå±€
        layoutContainer.appendChild(leftPanel);
        layoutContainer.appendChild(rightPanel);
        modalBody.appendChild(layoutContainer);

        modalContent.appendChild(modalBody);
        modalContainer.appendChild(modalContent);

        document.body.appendChild(modalContainer);

        // å¡«å……æ•°æ®
        populateIcehouseModal();

        // è§¦å‘åŠ¨ç”»
        setTimeout(() => modalContainer.classList.add('active'), 10);

        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

      // å¡«å……å†°çª–æ¨¡æ€æ¡†æ•°æ®
      function populateIcehouseModal() {
        const perishableContainer = document.getElementById('icehousePerishable');
        const storageContainer = document.getElementById('icehouseStorage');
        const iceBlockContainer = document.getElementById('icehouseIceBlock');

        if (!perishableContainer || !storageContainer || !iceBlockContainer) return;

        // æ¸…ç©ºå®¹å™¨
        perishableContainer.innerHTML = '';
        storageContainer.innerHTML = '';
        iceBlockContainer.innerHTML = '';

        // æ˜¾ç¤ºèƒŒåŒ…ä¸­çš„æ—¶æ•ˆæ€§é£Ÿç‰©ï¼ˆåŒ…æ‹¬å†°å—ï¼‰
        Object.entries(gameData.resources).forEach(([resourceId, resourceData]) => {
          if (resourceData.amount > 0 && resourceData.isPerishable) {
            // è·å–æœ€æ–°çš„æ—¶æ•ˆæ€§ä¿¡æ¯
            let expirationInfo = resourceData.expirationDays;
            let remainingDays = resourceData.expirationDays;

            // ä½¿ç”¨è½»é‡çº§æ—¶æ•ˆæ€§ç³»ç»Ÿè·å–å‰©ä½™æ—¶é—´
            if (gameData.foodExpiry && gameData.foodExpiry[resourceId]) {
              const remainingTime = getEarliestExpiryTime(resourceId);
              if (remainingTime) {
                remainingDays = remainingTime.totalMinutes / (24 * 60);
              }
            }

            const resourceCard = createIcehouseResourceCard(resourceId, resourceData, 'inventory', null, null, expirationInfo, remainingDays);
            perishableContainer.appendChild(resourceCard);
          }
        });

        // æ˜¾ç¤ºå½“å‰åœ°ç‚¹ï¼ˆå®…é‚¸ï¼‰ä¸­çš„æ—¶æ•ˆæ€§é£Ÿç‰©
        const currentLocationId = gameData.currentLocation || 'my_mansion';
        if (gameData.groundResources && gameData.groundResources[currentLocationId]) {
          gameData.groundResources[currentLocationId].forEach((groundItem, index) => {
            if (groundItem.amount > 0 && gameData.resources[groundItem.resourceId] &&
                gameData.resources[groundItem.resourceId].isPerishable) {
              const resourceData = gameData.resources[groundItem.resourceId];

              // ä½¿ç”¨åœ°é¢èµ„æºçš„è·å¾—æ—¶é—´è®¡ç®—å‰©ä½™æ—¶æ•ˆæœŸ
              let expirationInfo = resourceData.expirationDays;
              let remainingDays = resourceData.expirationDays;

              if (groundItem.obtainTime !== undefined) {
                // ä½¿ç”¨åœ°é¢èµ„æºçš„è·å¾—æ—¶é—´
                const currentTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
                const obtainTimeInMinutes = groundItem.obtainTime;
                const expirationTimeInMinutes = obtainTimeInMinutes + (resourceData.expirationDays * 24 * 60);
                const remainingTimeInMinutes = Math.max(0, expirationTimeInMinutes - currentTimeInMinutes);
                remainingDays = Math.ceil(remainingTimeInMinutes / (24 * 60));
              } else if (gameData.foodExpiry && gameData.foodExpiry[groundItem.resourceId]) {
                // ä½¿ç”¨è½»é‡çº§æ—¶æ•ˆæ€§ç³»ç»Ÿè·å–å‰©ä½™æ—¶é—´
                const remainingTime = getEarliestExpiryTime(groundItem.resourceId);
                if (remainingTime) {
                  remainingDays = remainingTime.totalMinutes / (24 * 60);
                  expirationInfo = gameData.resources[groundItem.resourceId].expirationDays;
                }
              }

              const resourceCard = createIcehouseResourceCard(groundItem.resourceId,
                resourceData, 'ground', groundItem.amount, index, expirationInfo, remainingDays);
              perishableContainer.appendChild(resourceCard);
            }
          });
        }

        // æ˜¾ç¤ºå†°çª–ä¸­å­˜å‚¨çš„é£Ÿç‰©ï¼ˆæŒ‰èµ„æºIDåˆå¹¶æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºæ—¶æ•ˆæœŸæœ€çŸ­çš„æ‰¹æ¬¡ï¼‰
        Object.entries(gameData.icehouse.items).forEach(([resourceId, items]) => {
          if (items.length > 0 && gameData.resources[resourceId]) {
          // æ‰¾åˆ°æ—¶æ•ˆæœŸæœ€çŸ­çš„æ‰¹æ¬¡ï¼ˆå‰©ä½™å¤©æ•°æœ€å°‘çš„æ‰¹æ¬¡ï¼‰
          let earliestItem = items[0];
          let totalAmount = 0;

          items.forEach(item => {
            totalAmount += item.amount;
            const remainingDays = Math.max(0, Math.floor(item.expirationDay - gameData.day));
            const earliestRemainingDays = Math.max(0, Math.floor(earliestItem.expirationDay - gameData.day));
            if (remainingDays < earliestRemainingDays) {
              earliestItem = item;
            }
          });

            // åˆ›å»ºåˆå¹¶åçš„å¡ç‰‡ï¼Œæ˜¾ç¤ºæ€»æ•°é‡å’Œæœ€çŸ­æ—¶æ•ˆæœŸ
            const mergedItem = {
              amount: totalAmount,
              expirationDay: earliestItem.expirationDay,
              originalExpirationDays: earliestItem.originalExpirationDays,
              obtainDay: earliestItem.obtainDay,
              obtainHour: earliestItem.obtainHour,
              obtainMinute: earliestItem.obtainMinute
            };
            
            const resourceCard = createIcehouseStoredCard(resourceId, gameData.resources[resourceId], mergedItem, -1);
            storageContainer.appendChild(resourceCard);
          }
        });

        // æ˜¾ç¤ºå†°å—æ”¾ç½®åŒº
        if (gameData.icehouse.iceBlock && gameData.icehouse.iceBlock.amount > 0) {
          const iceBlockCard = createIceBlockCard();
          iceBlockContainer.appendChild(iceBlockCard);

          // åœ¨å†°å—å¡ç‰‡å†…éƒ¨å³ä¾§æ·»åŠ çŠ¶æ€ä¿¡æ¯
          const remainingDays = Math.floor(gameData.icehouse.iceBlock.remainingDays);
          const statusInfo = document.createElement('div');
          statusInfo.className = 'icehouse-ice-block-status';
          statusInfo.style.position = 'absolute';
          statusInfo.style.right = '10px';
          statusInfo.style.top = '50%';
          statusInfo.style.transform = 'translateY(-50%)';
          statusInfo.style.textAlign = 'left';
          statusInfo.style.fontSize = '0.9rem';
          statusInfo.style.color = '#2D3748';
          statusInfo.style.lineHeight = '1.5';
          statusInfo.innerHTML = `
            <p>ä¿é²œåŠŸèƒ½ï¼š<span class="status-active" style="color: #48BB78;">âœ“ å·²æ¿€æ´»</span></p>
            <p>å‰©ä½™ä¿é²œæ—¶é—´ï¼š<strong>${remainingDays}</strong> å¤©</p>
            <p>å†°å—æ•°é‡ï¼š${gameData.icehouse.iceBlock.amount} å¼ </p>
          `;
          iceBlockContainer.appendChild(statusInfo);
        } else {
          // æ˜¾ç¤ºæ”¾ç½®å†°å—çš„è™šçº¿æ¡†
          const dropZone = document.createElement('div');
          dropZone.className = 'icehouse-ice-block-drop-zone';
          dropZone.style.position = 'relative';
          dropZone.innerHTML = `
            <div class="drop-zone-hint">
              <p>æ‹–æ‹½å†°å—åˆ°æ­¤å¤„</p>
              <p class="drop-zone-hint-small">æˆ–åŒå‡»èƒŒåŒ…ä¸­çš„å†°å—</p>
            </div>
          `;
          iceBlockContainer.appendChild(dropZone);

          // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨åˆ°å†°å—æ”¾ç½®åŒº
          iceBlockContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedResource = gameData.resources[draggedId];
            // åªå…è®¸æ‹–æ‹½å†°å—
            if (draggedResource && draggedResource.isIceBlock) {
              iceBlockContainer.style.backgroundColor = 'rgba(135, 206, 235, 0.2)';
              dropZone.style.boxShadow = '0 0 15px rgba(135, 206, 235, 0.8)';
            }
          });

          iceBlockContainer.addEventListener('dragleave', function(e) {
            iceBlockContainer.style.backgroundColor = 'rgba(173, 216, 230, 0.1)';
            if (dropZone) {
              dropZone.style.boxShadow = '';
            }
          });

          iceBlockContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            iceBlockContainer.style.backgroundColor = 'rgba(173, 216, 230, 0.1)';
            if (dropZone) {
              dropZone.style.boxShadow = '';
            }

            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedResource = gameData.resources[draggedId];

            // åªå¤„ç†å†°å—çš„æ‹–æ‹½
            if (draggedResource && draggedResource.isIceBlock) {
              handleAddIceBlock(draggedResource.amount);
            }
          });

          // åœ¨è™šçº¿æ¡†å†…éƒ¨å³ä¾§æ·»åŠ çŠ¶æ€ä¿¡æ¯
          const statusInfo = document.createElement('div');
          statusInfo.className = 'icehouse-ice-block-status';
          statusInfo.style.position = 'absolute';
          statusInfo.style.right = '10px';
          statusInfo.style.top = '50%';
          statusInfo.style.transform = 'translateY(-50%)';
          statusInfo.style.textAlign = 'left';
          statusInfo.style.fontSize = '0.9rem';
          statusInfo.style.color = '#2D3748';
          statusInfo.style.lineHeight = '1.5';
          statusInfo.innerHTML = `
            <p>ä¿é²œåŠŸèƒ½ï¼š<span class="status-inactive" style="color: #E53E3E;">âœ— æœªæ¿€æ´»</span></p>
            <p>è¯·æ”¾ç½®å†°å—ä»¥æ¿€æ´»ä¿é²œåŠŸèƒ½</p>
          `;
          iceBlockContainer.appendChild(statusInfo);
        }

        // ä¸ºä¿é²œå­˜å‚¨åŒºåŸŸæ·»åŠ æ‹–æ‹½åŠŸèƒ½
        storageContainer.addEventListener('dragover', function(e) {
          e.preventDefault();
          const draggedId = e.dataTransfer.getData('text/plain');
          const draggedResource = gameData.resources[draggedId];
          // åªå…è®¸æ‹–æ‹½é£Ÿç‰©ï¼ˆä¸åŒ…æ‹¬å†°å—ï¼‰
          if (draggedResource && draggedResource.isPerishable && !draggedResource.isIceBlock) {
            storageContainer.style.backgroundColor = 'rgba(144, 238, 144, 0.2)';
            storageContainer.style.border = '2px dashed #48BB78';
          }
        });

        storageContainer.addEventListener('dragleave', function(e) {
          storageContainer.style.backgroundColor = '';
          storageContainer.style.border = '';
        });

        storageContainer.addEventListener('drop', function(e) {
          e.preventDefault();
          storageContainer.style.backgroundColor = '';
          storageContainer.style.border = '';

          const draggedId = e.dataTransfer.getData('text/plain');
          const draggedResource = gameData.resources[draggedId];

          // åªå¤„ç†é£Ÿç‰©çš„æ‹–æ‹½ï¼ˆä¸åŒ…æ‹¬å†°å—ï¼‰
          if (draggedResource && draggedResource.isPerishable && !draggedResource.isIceBlock) {
            handleStoreToIcehouse(draggedId, draggedResource.amount);
          }
        });
      }

      // åˆ›å»ºå†°çª–æ—¶æ•ˆæ€§é£Ÿç‰©å¡ç‰‡
      function createIcehouseResourceCard(resourceId, resourceData, type, amount = null, groundIndex = null, expirationInfo = null, remainingDays = null) {
        const card = document.createElement('div');
        card.className = 'icehouse-inventory-card';
        card.dataset.resourceId = resourceId;
        card.dataset.type = type;
        
        // å¦‚æœæ˜¯åœ°ç‚¹æ é£Ÿç‰©ï¼Œå­˜å‚¨é¢å¤–ä¿¡æ¯
        if (type === 'ground' && groundIndex !== null) {
          card.dataset.groundIndex = groundIndex;
        }

        // è®¡ç®—å®é™…æ˜¾ç¤ºçš„æ•°é‡
        const displayAmount = amount !== null ? amount : resourceData.amount;

        // æ·»åŠ åŒå‡»äº‹ä»¶
        card.addEventListener('dblclick', function() {
          if (type === 'ground') {
            // å¤„ç†åœ°ç‚¹æ é£Ÿç‰©çš„å­˜å‚¨
            handleStoreToIcehouseFromGround(resourceId, displayAmount, groundIndex);
          } else {
            handleStoreToIcehouse(resourceId, displayAmount);
          }
        });

        const image = document.createElement('div');
        image.className = 'icehouse-card-image';
        image.style.backgroundImage = `url('${resourceData.image}')`;
        card.appendChild(image);

        const name = document.createElement('div');
        name.className = 'icehouse-card-name';
        name.textContent = `${resourceData.name} Ã— ${displayAmount}`;
        card.appendChild(name);

        // æ·»åŠ æ—¶æ•ˆæ€§ä¿¡æ¯
        if (expirationInfo !== null && remainingDays !== null) {
          const expiryInfo = document.createElement('div');
          expiryInfo.className = 'icehouse-card-expiry';
          const displayDays = Math.floor(remainingDays);
          expiryInfo.textContent = `å‰©ä½™: ${displayDays} å¤©`;
          if (displayDays <= 2) {
            expiryInfo.classList.add('warning');
          }
          if (displayDays === 0) {
            expiryInfo.textContent = 'å·²è¿‡æœŸ';
            expiryInfo.classList.add('expired');
          }
          card.appendChild(expiryInfo);
        } else if (resourceData.expirationDays) {
          const expiryInfo = document.createElement('div');
          expiryInfo.className = 'icehouse-card-expiry';
          const displayDays = Math.floor(resourceData.expirationDays);
          expiryInfo.textContent = `æœ‰æ•ˆæœŸ: ${displayDays} å¤©`;
          card.appendChild(expiryInfo);
        }

        // è®¾ç½®å¡ç‰Œå¯æ‹–æ‹½
        card.setAttribute('draggable', 'true');
        card.style.cursor = 'grab';

        // æ·»åŠ æ‹–æ‹½å¼€å§‹äº‹ä»¶
        card.addEventListener('dragstart', function(e) {
          e.dataTransfer.setData('text/plain', resourceId);
          e.dataTransfer.effectAllowed = 'move';
          card.style.opacity = '0.5';
        });

        card.addEventListener('dragend', function(e) {
          card.style.opacity = '1';

          // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
          if (typeof clearDragEffects === 'function') {
            clearDragEffects();
          }
        });

        return card;
      }

      // åˆ›å»ºå†°çª–å­˜å‚¨å¡ç‰‡
      function createIcehouseStoredCard(resourceId, resourceData, item, index) {
        const card = document.createElement('div');
        card.className = 'icehouse-stored-card';
        card.dataset.resourceId = resourceId;
        card.dataset.index = index;

        // æ·»åŠ åŒå‡»äº‹ä»¶
        card.addEventListener('dblclick', function() {
          if (index === -1) {
            // åˆå¹¶æ˜¾ç¤ºçš„æƒ…å†µï¼Œç‰¹æ®Šå¤„ç†
            handleRetrieveFromMergedIcehouse(resourceId, item.amount);
          } else {
            handleRetrieveFromIcehouse(resourceId, item.amount, index);
          }
        });

        const image = document.createElement('div');
        image.className = 'icehouse-card-image';
        image.style.backgroundImage = `url('${resourceData.image}')`;
        card.appendChild(image);

        const name = document.createElement('div');
        name.className = 'icehouse-card-name';
        name.textContent = `${resourceData.name} Ã— ${item.amount}`;
        card.appendChild(name);

        // æ·»åŠ æ—¶æ•ˆæ€§ä¿¡æ¯
        const remainingDays = Math.max(0, Math.ceil(item.expirationDay - gameData.day));
        const expiryInfo = document.createElement('div');
        expiryInfo.className = 'icehouse-card-expiry';
        expiryInfo.textContent = `å‰©ä½™: ${remainingDays} å¤©`;
        if (remainingDays <= 2) {
          expiryInfo.classList.add('warning');
        }
        if (remainingDays === 0) {
          expiryInfo.textContent = 'å·²è¿‡æœŸ';
          expiryInfo.classList.add('expired');
        }
        card.appendChild(expiryInfo);

        return card;
      }

      // åˆ›å»ºå†°å—å¡ç‰‡
      function createIceBlockCard() {
        const card = document.createElement('div');
        card.className = 'icehouse-ice-block-card';
        card.addEventListener('dblclick', function() {
          handleRemoveIceBlock();
        });

        const image = document.createElement('div');
        image.className = 'icehouse-card-image';
        image.style.backgroundImage = `url('UI/å†°å—.jpg')`;
        card.appendChild(image);

        const name = document.createElement('div');
        name.className = 'icehouse-card-name';
        name.textContent = `å†°å— Ã— ${gameData.icehouse.iceBlock.amount}`;
        card.appendChild(name);

        return card;
      }

      // å¤„ç†å­˜å‚¨åˆ°å†°çª–
      function handleStoreToIcehouse(resourceId, currentAmount) {
        if (currentAmount <= 0) return;

        const resourceData = gameData.resources[resourceId];

        // æ£€æŸ¥èµ„æºæ˜¯å¦å…·æœ‰æ—¶æ•ˆæ€§
        if (!resourceData.isPerishable) {
          showNotification('æ— æ³•å­˜å‚¨', 'è¯¥ç‰©å“ä¸å…·æœ‰æ—¶æ•ˆæ€§ï¼Œä¸èƒ½å­˜å…¥å†°çª–');
          return;
        }

        // æ£€æŸ¥èµ„æºæ˜¯å¦ä¸ºå†°å—
        if (resourceData.isIceBlock) {
          handleAddIceBlock(currentAmount);
          return;
        }

        // æ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£
        if (currentAmount > 1) {
          showIcehouseAmountModal(resourceId, currentAmount, 'store');
        } else {
          storeToIcehouse(resourceId, 1);
        }
      }

      // å¤„ç†ä»åœ°ç‚¹æ å­˜å‚¨åˆ°å†°çª–
      function handleStoreToIcehouseFromGround(resourceId, currentAmount, groundIndex) {
        if (currentAmount <= 0) return;

        const resourceData = gameData.resources[resourceId];

        // æ£€æŸ¥èµ„æºæ˜¯å¦å…·æœ‰æ—¶æ•ˆæ€§
        if (!resourceData.isPerishable) {
          showNotification('æ— æ³•å­˜å‚¨', 'è¯¥ç‰©å“ä¸å…·æœ‰æ—¶æ•ˆæ€§ï¼Œä¸èƒ½å­˜å…¥å†°çª–');
          return;
        }

        // æ£€æŸ¥èµ„æºæ˜¯å¦ä¸ºå†°å—
        if (resourceData.isIceBlock) {
          showNotification('å†°å—å¤„ç†', 'å†°å—éœ€è¦ä»èƒŒåŒ…æ æ”¾å…¥å†°å—æ”¾ç½®åŒº');
          return;
        }

        // æ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£
        if (currentAmount > 1) {
          showIcehouseAmountModal(resourceId, currentAmount, 'store-ground', groundIndex);
        } else {
          storeToIcehouseFromGround(resourceId, 1, groundIndex);
        }
      }

      // å¤„ç†ä»å†°çª–å–å›
      function handleRetrieveFromIcehouse(resourceId, amount, index) {
        if (amount <= 0) return;

        // æ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£
        if (amount > 1) {
          showIcehouseAmountModal(resourceId, amount, 'retrieve', index);
        } else {
          retrieveFromIcehouse(resourceId, 1, index);
        }
      }

      // å¤„ç†ä»åˆå¹¶æ˜¾ç¤ºçš„å†°çª–ç‰©å“å–å›
      function handleRetrieveFromMergedIcehouse(resourceId, totalAmount) {
        if (totalAmount <= 0) return;

        // æ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£
        if (totalAmount > 1) {
          showIcehouseAmountModal(resourceId, totalAmount, 'retrieve-merged', -1);
        } else {
          retrieveFromMergedIcehouse(resourceId, 1);
        }
      }

      // å­˜å‚¨åˆ°å†°çª–
      function storeToIcehouse(resourceId, amount) {
        const resourceData = gameData.resources[resourceId];

        // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°é‡
        if (resourceData.amount < amount) {
          showNotification('æ•°é‡ä¸è¶³', 'èƒŒåŒ…ä¸­æ•°é‡ä¸è¶³');
          return;
        }

        // åˆå§‹åŒ–å†°çª–ç‰©å“æ•°ç»„
        if (!gameData.icehouse.items[resourceId]) {
          gameData.icehouse.items[resourceId] = [];
        }

        // ä»è½»é‡çº§æ—¶æ•ˆæ€§ç³»ç»Ÿä¸­ç§»é™¤å¯¹åº”æ•°é‡çš„é£Ÿç‰©
        if (gameData.foodExpiry && gameData.foodExpiry[resourceId]) {
          const expiryInfo = gameData.foodExpiry[resourceId];
          
          // è®¡ç®—å­˜å‚¨æ—¶çš„å‰©ä½™å¤©æ•°
          const currentTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
          const remainingMinutes = expiryInfo.earliestExpiry - currentTimeInMinutes;
          const remainingDays = Math.max(0, Math.ceil(remainingMinutes / (24 * 60)));

          // å†°çª–ä¿é²œåŠŸèƒ½ï¼šåœ¨å†°çª–ä¸­è¿‡æœŸæ—¶é—´å†»ç»“ï¼Œå–å›æ—¶ç»§ç»­è®¡ç®—
          gameData.icehouse.items[resourceId].push({
            amount: amount,
            expirationDay: expiryInfo.obtainDay + expiryInfo.earliestDays, // ä½¿ç”¨åŸå§‹è¿‡æœŸæ—¥æœŸ
            originalExpirationDays: expiryInfo.earliestDays,
            obtainDay: expiryInfo.obtainDay,
            obtainHour: gameData.currentHour,
            obtainMinute: gameData.currentMinute
          });

          // è°ƒç”¨è½»é‡çº§æ¶ˆè€—å‡½æ•°
          consumeFoodFromBatches(resourceId, amount);
        } else {
          // æ²¡æœ‰æ—¶æ•ˆæ€§ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨å½“å‰æ—¶é—´
          const expirationDay = gameData.day + resourceData.expirationDays;
          gameData.icehouse.items[resourceId].push({
            amount: amount,
            expirationDay: expirationDay,
            originalExpirationDays: resourceData.expirationDays,
            obtainDay: gameData.day,
            obtainHour: gameData.currentHour,
            obtainMinute: gameData.currentMinute
          });

          // ç›´æ¥ä»èƒŒåŒ…ä¸­æ‰£é™¤
          gameData.resources[resourceId].amount -= amount;
        }

        // æ›´æ–°UI
        populateIcehouseModal();
        renderResources();
        updateGameData();

        showNotification('å­˜å‚¨æˆåŠŸ', `å·²å°† ${amount} ä¸ª ${resourceData.name} å­˜å…¥å†°çª–`);
      }

      // ä»åœ°ç‚¹æ å­˜å‚¨åˆ°å†°çª–
      function storeToIcehouseFromGround(resourceId, amount, groundIndex) {
        const resourceData = gameData.resources[resourceId];
        const currentLocationId = gameData.currentLocation || 'my_mansion';
        
        // æ£€æŸ¥åœ°ç‚¹æ ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°é‡
        if (!gameData.groundResources[currentLocationId] || 
            !gameData.groundResources[currentLocationId][groundIndex] ||
            gameData.groundResources[currentLocationId][groundIndex].amount < amount) {
          showNotification('æ•°é‡ä¸è¶³', 'åœ°ç‚¹æ ä¸­æ•°é‡ä¸è¶³');
          return;
        }

        const groundItem = gameData.groundResources[currentLocationId][groundIndex];

        // åˆå§‹åŒ–å†°çª–ç‰©å“æ•°ç»„
        if (!gameData.icehouse.items[resourceId]) {
          gameData.icehouse.items[resourceId] = [];
        }

        // ä½¿ç”¨å½“å‰æ—¶é—´è®¡ç®—è¿‡æœŸæ—¶é—´ï¼ˆå› ä¸ºåœ°ç‚¹æ é£Ÿç‰©æ²¡æœ‰æ‰¹æ¬¡ä¿¡æ¯ï¼‰
        const expirationDay = gameData.day + resourceData.expirationDays;
        gameData.icehouse.items[resourceId].push({
          amount: amount,
          expirationDay: expirationDay,
          originalExpirationDays: resourceData.expirationDays,
          obtainDay: gameData.day,
          obtainHour: gameData.currentHour,
          obtainMinute: gameData.currentMinute
        });

        // ä»åœ°ç‚¹æ ä¸­æ‰£é™¤æ•°é‡
        groundItem.amount -= amount;

        // å¦‚æœåœ°ç‚¹æ ä¸­æ•°é‡ä¸º0ï¼Œç§»é™¤è¯¥ç‰©å“
        if (groundItem.amount <= 0) {
          gameData.groundResources[currentLocationId].splice(groundIndex, 1);
        }

        // æ›´æ–°UI
        populateIcehouseModal();
        renderResources();
        renderGroundResources();
        updateGameData();

        showNotification('å­˜å‚¨æˆåŠŸ', `å·²å°† ${amount} ä¸ª ${resourceData.name} ä»åœ°ç‚¹æ å­˜å…¥å†°çª–`);
      }

      // ä»å†°çª–å–å›
      function retrieveFromIcehouse(resourceId, amount, index) {
        const items = gameData.icehouse.items[resourceId];
        const item = items[index];

        if (!item || item.amount < amount) {
          showNotification('æ•°é‡ä¸è¶³', 'å†°çª–ä¸­æ•°é‡ä¸è¶³');
          return;
        }

        const resourceData = gameData.resources[resourceId];

        // æ£€æŸ¥é£Ÿç‰©åœ¨å†°çª–ä¸­æ˜¯å¦å·²ç»è¿‡æœŸï¼ˆåŸºäºexpirationDayï¼‰
        if (gameData.day >= item.expirationDay) {
          // é£Ÿç‰©å·²è¿‡æœŸ
          showNotification('é£Ÿç‰©è¿‡æœŸ', 'è¯¥é£Ÿç‰©å·²è¿‡æœŸï¼Œæ— æ³•å–å›');
          return;
        }

        // è®¡ç®—å‰©ä½™å¤©æ•°ï¼ˆä»ç°åœ¨åˆ°è¿‡æœŸæ—¶é—´ï¼‰
        const remainingDays = Math.max(0, Math.ceil(item.expirationDay - gameData.day));

        // æ·»åŠ åˆ°èƒŒåŒ…
        resourceData.amount += amount;

        // åˆ›å»ºæ–°çš„è½»é‡çº§æ—¶æ•ˆæ€§è®°å½•ï¼Œä½¿ç”¨å–å›æ—¶çš„æ—¶é—´
        if (!gameData.foodExpiry) {
          gameData.foodExpiry = {};
        }
        if (!gameData.foodExpiry[resourceId]) {
          gameData.foodExpiry[resourceId] = {
            totalAmount: 0,
            earliestExpiry: null,
            lastUpdateDay: gameData.day
          };
        }

        const expiryInfo = gameData.foodExpiry[resourceId];
        const obtainTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
        const expirationTimeInMinutes = obtainTimeInMinutes + remainingDays * 24 * 60;

        // æ›´æ–°æ€»æ•°é‡
        expiryInfo.totalAmount += amount;

        // æ›´æ–°æœ€æ—©è¿‡æœŸæ—¶é—´
        if (!expiryInfo.earliestExpiry || expirationTimeInMinutes < expiryInfo.earliestExpiry) {
          expiryInfo.earliestExpiry = expirationTimeInMinutes;
          expiryInfo.earliestDays = remainingDays;
          expiryInfo.obtainDay = gameData.day;
        }

        expiryInfo.lastUpdateDay = gameData.day;

        // ä»å†°çª–ä¸­ç§»é™¤
        item.amount -= amount;
        if (item.amount <= 0) {
          items.splice(index, 1);
          if (items.length === 0) {
            delete gameData.icehouse.items[resourceId];
          }
        }

        // æ›´æ–°UI
        populateIcehouseModal();
        renderResources();
        updateGameData();

        showNotification('å–å›æˆåŠŸ', `å·²ä»å†°çª–å–å› ${amount} ä¸ª ${resourceData.name}`);
      }

      // ä»åˆå¹¶æ˜¾ç¤ºçš„å†°çª–ç‰©å“ä¸­å–å›
      function retrieveFromMergedIcehouse(resourceId, amount) {
        const resourceData = gameData.resources[resourceId];
        const items = gameData.icehouse.items[resourceId];
        
        if (!items || items.length === 0) {
          showNotification('å–å›å¤±è´¥', 'å†°çª–ä¸­è¯¥ç‰©å“ä¸å­˜åœ¨');
          return;
        }

        // æ£€æŸ¥å†°çª–ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°é‡
        let totalAmount = 0;
        items.forEach(item => totalAmount += item.amount);
        
        if (totalAmount < amount) {
          showNotification('æ•°é‡ä¸è¶³', 'å†°çª–ä¸­æ•°é‡ä¸è¶³');
          return;
        }

        // è®¡ç®—å–å›çš„å¹³å‡å‰©ä½™å¤©æ•°
        let totalRemainingDays = 0;
        let totalWeight = 0;
        items.forEach(item => {
          const remainingDays = Math.max(0, Math.floor(item.expirationDay - gameData.day));
          totalRemainingDays += remainingDays * item.amount;
          totalWeight += item.amount;
        });
        const avgRemainingDays = Math.floor(totalRemainingDays / totalWeight);

        // æ·»åŠ åˆ°èƒŒåŒ…
        resourceData.amount += amount;

        // åˆ›å»ºæ–°çš„è½»é‡çº§æ—¶æ•ˆæ€§è®°å½•ï¼Œä½¿ç”¨å–å›æ—¶çš„æ—¶é—´å’Œå¹³å‡å‰©ä½™å¤©æ•°
        if (!gameData.foodExpiry) {
          gameData.foodExpiry = {};
        }
        if (!gameData.foodExpiry[resourceId]) {
          gameData.foodExpiry[resourceId] = {
            totalAmount: 0,
            earliestExpiry: null,
            lastUpdateDay: gameData.day
          };
        }

        const expiryInfo = gameData.foodExpiry[resourceId];
        const obtainTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
        const expirationTimeInMinutes = obtainTimeInMinutes + avgRemainingDays * 24 * 60;

        // æ›´æ–°æ€»æ•°é‡
        expiryInfo.totalAmount += amount;

        // æ›´æ–°æœ€æ—©è¿‡æœŸæ—¶é—´
        if (!expiryInfo.earliestExpiry || expirationTimeInMinutes < expiryInfo.earliestExpiry) {
          expiryInfo.earliestExpiry = expirationTimeInMinutes;
          expiryInfo.earliestDays = avgRemainingDays;
          expiryInfo.obtainDay = gameData.day;
        }

        expiryInfo.lastUpdateDay = gameData.day;

        // ä»å†°çª–ä¸­æŒ‰æ¯”ä¾‹æ‰£é™¤
        let remainingAmount = amount;
        for (let i = items.length - 1; i >= 0; i--) {
          if (remainingAmount <= 0) break;
          
          const item = items[i];
          const deductAmount = Math.min(remainingAmount, item.amount);
          item.amount -= deductAmount;
          remainingAmount -= deductAmount;
          
          if (item.amount <= 0) {
            items.splice(i, 1);
          }
        }

        // å¦‚æœæ‰€æœ‰æ‰¹æ¬¡éƒ½ä¸ºç©ºï¼Œåˆ é™¤è¯¥èµ„æº
        if (items.length === 0) {
          delete gameData.icehouse.items[resourceId];
        }

        // æ›´æ–°UI
        populateIcehouseModal();
        renderResources();
        updateGameData();

        showNotification('å–å›æˆåŠŸ', `å·²ä»å†°çª–å–å› ${amount} ä¸ª ${resourceData.name}`);
      }

      // æ·»åŠ å†°å—åˆ°å†°çª–
      function handleAddIceBlock(currentAmount) {
        if (currentAmount <= 0) return;

        const iceBlockData = gameData.resources.ice_block;

        // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°é‡
        if (iceBlockData.amount < currentAmount) {
          showNotification('æ•°é‡ä¸è¶³', 'èƒŒåŒ…ä¸­æ•°é‡ä¸è¶³');
          return;
        }

        // æ˜¾ç¤ºæ•°é‡é€‰æ‹©çª—å£ï¼ˆæ”¯æŒä»»æ„æ•°é‡ï¼‰
        showIcehouseAmountModal('ice_block', currentAmount, 'add_ice');
      }

      // æ·»åŠ å†°å—
      function addIceBlock(amount) {
        const iceBlockData = gameData.resources.ice_block;

        // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°é‡
        if (iceBlockData.amount < amount) {
          showNotification('æ•°é‡ä¸è¶³', 'èƒŒåŒ…ä¸­æ•°é‡ä¸è¶³');
          return;
        }

        // ä»èƒŒåŒ…ä¸­æ‰£é™¤
        iceBlockData.amount -= amount;

        // æ·»åŠ åˆ°å†°çª–
        if (gameData.icehouse.iceBlock) {
          const oldAmount = gameData.icehouse.iceBlock.amount;
          const oldRemainingDays = gameData.icehouse.iceBlock.remainingDays;
          gameData.icehouse.iceBlock.amount += amount;
          
          // æ ¹æ®å†°å—æ•°é‡è®¡ç®—æ€»ä¿é²œå¤©æ•°ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡ç½®ä¸º5å¤©
          // æ¯ä¸ªå†°å—æä¾›5å¤©ä¿é²œï¼Œæ€»ä¿é²œå¤©æ•° = å†°å—æ•°é‡ Ã— 5å¤©
          const totalDays = gameData.icehouse.iceBlock.amount * iceBlockData.expirationDays;
          gameData.icehouse.iceBlock.expirationDay = gameData.day + totalDays;
          
          // è®¡ç®—å‰©ä½™å¤©æ•°ï¼šæ–°å†°å—çš„æ€»ä¿é²œå¤©æ•°å‡å»å·²ä½¿ç”¨çš„å¤©æ•°
          if (oldRemainingDays > 0) {
            // å¦‚æœè¿˜æœ‰å‰©ä½™ä¿é²œæ—¶é—´ï¼Œç´¯åŠ æ–°å†°å—çš„ä¿é²œæ—¶é—´
            gameData.icehouse.iceBlock.remainingDays = oldRemainingDays + (amount * iceBlockData.expirationDays);
          } else {
            // å¦‚æœä¿é²œæ—¶é—´å·²ç”¨å®Œï¼Œè®¾ç½®æ–°å†°å—çš„ä¿é²œæ—¶é—´
            gameData.icehouse.iceBlock.remainingDays = amount * iceBlockData.expirationDays;
          }
        } else {
          gameData.icehouse.iceBlock = {
            amount: amount,
            expirationDay: gameData.day + (amount * iceBlockData.expirationDays),
            remainingDays: amount * iceBlockData.expirationDays
          };
        }

        // æ›´æ–°UI
        populateIcehouseModal();
        renderResources();
        updateGameData();

        showNotification('å†°å—å·²æ·»åŠ ', `å·²æ·»åŠ  ${amount} å¼ å†°å—ï¼Œä¿é²œåŠŸèƒ½å·²æ¿€æ´»`);
      }

      // ç§»é™¤å†°å—
      function handleRemoveIceBlock() {
        if (!gameData.icehouse.iceBlock) return;

        const iceBlockData = gameData.resources.ice_block;
        const amount = gameData.icehouse.iceBlock.amount;

        // æ·»åŠ å›èƒŒåŒ…
        iceBlockData.amount += amount;

        // ä»å†°çª–ä¸­ç§»é™¤
        gameData.icehouse.iceBlock = null;

        // æ›´æ–°UI
        populateIcehouseModal();
        renderResources();
        updateGameData();

        showNotification('å†°å—å·²ç§»é™¤', `å·²ç§»é™¤ ${amount} å¼ å†°å—ï¼Œä¿é²œåŠŸèƒ½å·²åœæ­¢`);
      }

      // æ˜¾ç¤ºå†°çª–æ•°é‡é€‰æ‹©çª—å£
      function showIcehouseAmountModal(resourceId, maxAmount, actionType, index = -1) {
        const resourceName = gameData.resources[resourceId].name;

        // åˆ›å»ºæ•°é‡é€‰æ‹©æ¨¡æ€æ¡†
        const modalContainer = document.createElement('div');
        modalContainer.className = 'icehouse-amount-modal active';

        const modalContent = document.createElement('div');
        modalContent.className = 'icehouse-amount-modal-content ink-border';

        const title = document.createElement('h3');
        title.className = 'icehouse-amount-modal-title';

        let actionText = '';
        if (actionType === 'store') {
          actionText = `å­˜å‚¨ ${resourceName}`;
        } else if (actionType === 'store-ground') {
          actionText = `ä»åœ°ç‚¹æ å­˜å‚¨ ${resourceName}`;
        } else if (actionType === 'retrieve') {
          actionText = `å–å› ${resourceName}`;
        } else if (actionType === 'add_ice') {
          actionText = 'æ·»åŠ å†°å—';
        }
        title.textContent = actionText;

        const description = document.createElement('p');
        description.className = 'icehouse-amount-modal-description';
        if (actionType === 'add_ice') {
          description.textContent = `è¯·é€‰æ‹©è¦æ·»åŠ çš„å†°å—æ•°é‡ï¼ˆå½“å‰èƒŒåŒ…ä¸­æœ‰ ${maxAmount} å¼ ï¼‰`;
        } else {
          description.textContent = `è¯·é€‰æ‹©æ•°é‡ (æœ€å¤§: ${maxAmount})`;
        }

        // åˆ›å»ºé€‰é¡¹æŒ‰é’®
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'icehouse-amount-options';

        // å…¨éƒ¨æŒ‰é’®
        const allButton = document.createElement('button');
        allButton.className = 'icehouse-amount-button icehouse-amount-all';
        allButton.textContent = 'å…¨éƒ¨';
        allButton.onclick = function() {
          if (actionType === 'store') {
            storeToIcehouse(resourceId, maxAmount);
          } else if (actionType === 'store-ground') {
            storeToIcehouseFromGround(resourceId, maxAmount, index);
          } else if (actionType === 'retrieve') {
            retrieveFromIcehouse(resourceId, maxAmount, index);
          } else if (actionType === 'retrieve-merged') {
            retrieveFromMergedIcehouse(resourceId, maxAmount);
          } else if (actionType === 'add_ice') {
            addIceBlock(maxAmount);
          }
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        // è‡ªå®šä¹‰æ•°é‡æŒ‰é’®
        const customButton = document.createElement('button');
        customButton.className = 'icehouse-amount-button icehouse-amount-custom';
        customButton.textContent = 'è¾“å…¥æ•°é‡';
        customButton.onclick = function() {
          showCustomIcehouseAmountInput(resourceId, maxAmount, actionType, index);
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        // å–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.className = 'icehouse-amount-button icehouse-amount-cancel';
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        optionsContainer.appendChild(allButton);
        optionsContainer.appendChild(customButton);
        optionsContainer.appendChild(cancelButton);

        modalContent.appendChild(title);
        modalContent.appendChild(description);
        modalContent.appendChild(optionsContainer);
        modalContainer.appendChild(modalContent);

        document.body.appendChild(modalContainer);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

      // æ˜¾ç¤ºåœ°é¢èµ„æºå­˜å‚¨æ•°é‡é€‰æ‹©çª—å£
      function showStorageGroundAmountModal(resourceId, maxAmount, groundIndex, actionType) {
        const resourceName = gameData.resources[resourceId].name;

        // åˆ›å»ºæ•°é‡é€‰æ‹©æ¨¡æ€æ¡†
        const modalContainer = document.createElement('div');
        modalContainer.className = 'storage-amount-modal active';

        const modalContent = document.createElement('div');
        modalContent.className = 'storage-amount-modal-content ink-border';

        const title = document.createElement('h3');
        title.className = 'storage-amount-modal-title';
        title.textContent = `å­˜å‚¨ ${resourceName}`;

        const description = document.createElement('p');
        description.className = 'storage-amount-modal-description';
        description.textContent = `è¯·é€‰æ‹©è¦å­˜å‚¨çš„æ•°é‡ (æœ€å¤§: ${maxAmount})`;

        // åˆ›å»ºé€‰é¡¹æŒ‰é’®
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'storage-amount-options';

        // å…¨éƒ¨æŒ‰é’®
        const allButton = document.createElement('button');
        allButton.className = 'storage-amount-button storage-amount-all';
        allButton.textContent = 'å…¨éƒ¨';
        allButton.onclick = function() {
          storeGroundResource(resourceId, maxAmount, groundIndex);
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        // è‡ªå®šä¹‰æ•°é‡æŒ‰é’®
        const customButton = document.createElement('button');
        customButton.className = 'storage-amount-button storage-amount-custom';
        customButton.textContent = 'è¾“å…¥æ•°é‡';
        customButton.onclick = function() {
          showCustomGroundAmountInput(resourceId, maxAmount, groundIndex);
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        // å–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.className = 'storage-amount-button storage-amount-cancel';
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        optionsContainer.appendChild(allButton);
        optionsContainer.appendChild(customButton);
        optionsContainer.appendChild(cancelButton);

        modalContent.appendChild(title);
        modalContent.appendChild(description);
        modalContent.appendChild(optionsContainer);
        modalContainer.appendChild(modalContent);

        document.body.appendChild(modalContainer);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

      // æ˜¾ç¤ºåœ°é¢èµ„æºè‡ªå®šä¹‰æ•°é‡è¾“å…¥çª—å£
      function showCustomGroundAmountInput(resourceId, maxAmount, groundIndex) {
        const resourceName = gameData.resources[resourceId].name;

        const modalContainer = document.createElement('div');
        modalContainer.className = 'storage-amount-input-modal active';

        const modalContent = document.createElement('div');
        modalContent.className = 'storage-amount-input-modal-content ink-border';

        const title = document.createElement('h3');
        title.className = 'storage-amount-input-modal-title';
        title.textContent = `å­˜å‚¨ ${resourceName}`;

        const description = document.createElement('p');
        description.className = 'storage-amount-input-modal-description';
        description.textContent = `è¯·è¾“å…¥è¦å­˜å‚¨çš„æ•°é‡ (1-${maxAmount})`;

        // è¾“å…¥æ¡†
        const inputContainer = document.createElement('div');
        inputContainer.className = 'storage-amount-input-container';

        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'storage-amount-input';
        input.min = '1';
        input.max = maxAmount;
        input.value = '1';
        input.placeholder = `è¾“å…¥æ•°é‡ (1-${maxAmount})`;

        inputContainer.appendChild(input);

        // æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'storage-amount-input-buttons';

        const confirmButton = document.createElement('button');
        confirmButton.className = 'storage-amount-input-confirm';
        confirmButton.textContent = 'ç¡®è®¤';
        confirmButton.onclick = function() {
          const amount = parseInt(input.value);
          if (amount >= 1 && amount <= maxAmount) {
            storeGroundResource(resourceId, amount, groundIndex);
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          } else {
            showNotification('æç¤º', `è¯·è¾“å…¥1-${maxAmount}ä¹‹é—´çš„æ•°é‡`);
          }
        };

        const cancelButton = document.createElement('button');
        cancelButton.className = 'storage-amount-input-cancel';
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        buttonContainer.appendChild(confirmButton);
        buttonContainer.appendChild(cancelButton);

        modalContent.appendChild(title);
        modalContent.appendChild(description);
        modalContent.appendChild(inputContainer);
        modalContent.appendChild(buttonContainer);
        modalContainer.appendChild(modalContent);

        document.body.appendChild(modalContainer);

        // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
        setTimeout(() => input.focus(), 100);

        // å›è½¦é”®ç¡®è®¤
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            confirmButton.click();
          }
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

      // å®é™…ä»åœ°é¢æ å­˜å‚¨èµ„æºåˆ°ä»“åº“
      function storeGroundResource(resourceId, amount, groundIndex) {
        const resourceData = gameData.resources[resourceId];
        const locationId = 'my_mansion';

        // ç¡®ä¿å®…é‚¸åœ°é¢èµ„æºå­˜åœ¨
        if (!gameData.groundResources[locationId]) {
          gameData.groundResources[locationId] = [];
        }

        // æ‰¾åˆ°å¯¹åº”çš„åœ°é¢èµ„æºé¡¹
        const groundItem = gameData.groundResources[locationId][groundIndex];
        if (!groundItem || groundItem.resourceId !== resourceId || groundItem.amount < amount) {
          showNotification('é”™è¯¯', 'åœ°é¢èµ„æºæ•°é‡ä¸è¶³');
          return;
        }

        // åˆå§‹åŒ–ä»“åº“æ•°æ®
        if (!gameData.warehouse[resourceId]) {
          gameData.warehouse[resourceId] = 0;
        }

        // ç§»åŠ¨èµ„æºä»åœ°é¢æ åˆ°ä»“åº“
        gameData.warehouse[resourceId] += amount;
        groundItem.amount -= amount;

        // å¦‚æœåœ°é¢æ•°é‡ä¸º0ï¼Œç§»é™¤è¯¥é¡¹
        if (groundItem.amount <= 0) {
          gameData.groundResources[locationId].splice(groundIndex, 1);
        }

        // æ›´æ–°UI
        populateStorageModal();
        renderGroundResources(locationId);
        updateGameData();

        showNotification('å­˜å‚¨æˆåŠŸ', `å·²å­˜å‚¨ ${amount} ä¸ª ${resourceData.name} åˆ°ä»“åº“`);
      }

      // æ˜¾ç¤ºå†°çª–è‡ªå®šä¹‰æ•°é‡è¾“å…¥çª—å£
      function showCustomIcehouseAmountInput(resourceId, maxAmount, actionType, index = -1) {
        const resourceName = gameData.resources[resourceId].name;
        
        let actionText = '';
        if (actionType === 'store') {
          actionText = `å­˜å‚¨ ${resourceName}`;
        } else if (actionType === 'store-ground') {
          actionText = `ä»åœ°ç‚¹æ å­˜å‚¨ ${resourceName}`;
        } else if (actionType === 'retrieve') {
          actionText = `å–å› ${resourceName}`;
        } else if (actionType === 'retrieve-merged') {
          actionText = `å–å› ${resourceName}`;
        } else if (actionType === 'add_ice') {
          actionText = 'æ·»åŠ å†°å—';
        }

        const modalContainer = document.createElement('div');
        modalContainer.className = 'icehouse-amount-input-modal active';

        const modalContent = document.createElement('div');
        modalContent.className = 'icehouse-amount-input-modal-content ink-border';

        const title = document.createElement('h3');
        title.className = 'icehouse-amount-input-modal-title';
        title.textContent = actionText;

        const description = document.createElement('p');
        description.className = 'icehouse-amount-input-modal-description';
        if (actionType === 'add_ice') {
          description.textContent = `è¯·è¾“å…¥è¦æ·»åŠ çš„å†°å—æ•°é‡ï¼ˆ1-${maxAmount}ï¼‰`;
        } else {
          description.textContent = `è¯·è¾“å…¥æ•°é‡ (1-${maxAmount})`;
        }

        // è¾“å…¥æ¡†
        const inputContainer = document.createElement('div');
        inputContainer.className = 'icehouse-amount-input-container';

        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'icehouse-amount-input';
        input.min = '1';
        input.max = maxAmount;
        input.value = '1';
        if (actionType === 'add_ice') {
          input.placeholder = `è¾“å…¥è¦æ·»åŠ çš„å†°å—æ•°é‡ï¼ˆ1-${maxAmount}ï¼‰`;
        } else {
          input.placeholder = `è¾“å…¥æ•°é‡ (1-${maxAmount})`;
        }

        inputContainer.appendChild(input);

        // æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'icehouse-amount-input-buttons';

        const confirmButton = document.createElement('button');
        confirmButton.className = 'icehouse-amount-input-confirm';
        confirmButton.textContent = 'ç¡®è®¤';
        confirmButton.onclick = function() {
          const amount = parseInt(input.value);
          if (amount >= 1 && amount <= maxAmount) {
            // æ ¹æ®æ“ä½œç±»å‹è°ƒç”¨ç›¸åº”çš„å‡½æ•°
            if (actionType === 'store') {
              storeToIcehouse(resourceId, amount);
            } else if (actionType === 'store-ground') {
              storeToIcehouseFromGround(resourceId, amount, index);
            } else if (actionType === 'retrieve') {
              retrieveFromIcehouse(resourceId, amount, index);
            } else if (actionType === 'retrieve-merged') {
              retrieveFromMergedIcehouse(resourceId, amount);
            } else if (actionType === 'add_ice') {
              addIceBlock(amount);
            }
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          } else {
            showNotification('æç¤º', `è¯·è¾“å…¥1-${maxAmount}ä¹‹é—´çš„æ•°é‡`);
          }
        };

        const cancelButton = document.createElement('button');
        cancelButton.className = 'icehouse-amount-input-cancel';
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };

        buttonContainer.appendChild(confirmButton);
        buttonContainer.appendChild(cancelButton);

        modalContent.appendChild(title);
        modalContent.appendChild(description);
        modalContent.appendChild(inputContainer);
        modalContent.appendChild(buttonContainer);
        modalContainer.appendChild(modalContent);

        document.body.appendChild(modalContainer);

        // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
        setTimeout(() => input.focus(), 100);

        // å›è½¦é”®ç¡®è®¤
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            confirmButton.click();
          }
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

// å®…é‚¸æ°´äº•é€‰é¡¹å¼¹çª—å‡½æ•°
      function showWellModal() {
        showWaterOptionsModal();
      }

// æ‰“æ°´é€‰é¡¹å¼¹çª—å‡½æ•°
      function showWaterOptionsModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨ï¼Œä½¿ç”¨æ ‡å‡†æ ·å¼
        const modalContainer = document.createElement('div');
        modalContainer.className = 'event-modal';
        
        // åˆ›å»ºå¼¹çª—å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
        const modalContent = document.createElement('div');
        modalContent.className = 'event-modal-content ink-border';
        
        // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
        const modalHeader = document.createElement('div');
        modalHeader.className = 'event-modal-header';
        
        // åˆ›å»ºæ ‡é¢˜ï¼Œä½¿ç”¨ink-textæ ·å¼
        const title = document.createElement('h2');
        title.className = 'event-modal-title ink-text';
        title.textContent = 'é€‰æ‹©å–æ°´æ–¹å¼';
        modalHeader.appendChild(title);
        
        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.className = 'event-modal-close';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        modalHeader.appendChild(closeButton);
        
        modalContent.appendChild(modalHeader);
        
        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const modalBody = document.createElement('div');
        modalBody.className = 'event-modal-body';
        
        // æ·»åŠ æè¿°
        const description = document.createElement('p');
        description.className = 'event-modal-text';
        description.textContent = 'ä½ æ¥åˆ°æ°´äº•è¾¹ï¼Œæƒ³è¦å–ç‚¹æ°´...';
        modalBody.appendChild(description);

        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'event-modal-options';

        // åˆ›å»ºç”¨æ‰‹æ§ç€å–æŒ‰é’®
        const handDrinkButton = document.createElement('button');
        handDrinkButton.className = 'event-modal-option';
        handDrinkButton.innerHTML = `
          <div class="event-modal-option-text">ç”¨æ‰‹æ§ç€å–</div>
          <div class="event-modal-option-description">ç›´æ¥ç”¨æ‰‹æ§æ°´å–ï¼Œå¯èƒ½ä¼šå¼„æ¹¿è¡£æœ</div>
        `;
        
        handDrinkButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
          drinkWaterWithHands();
        };

        // åˆ›å»ºç”¨æ°´è¢‹è£…æŒ‰é’®
        const waterBagButton = document.createElement('button');
        waterBagButton.className = 'event-modal-option';
        waterBagButton.innerHTML = `
          <div class="event-modal-option-text">ç”¨æ°´è¢‹è£…</div>
          <div class="event-modal-option-description">ä½¿ç”¨æ°´è¢‹è£…æ°´ï¼Œéœ€è¦å…ˆæœ‰æ°´è¢‹</div>
        `;
        
        waterBagButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
          
          // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
          ensureWaterBagResources();

          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæ£€æŸ¥æ°´è¢‹çŠ¶æ€
          const waterBag = gameData.resources.water_bag;
          const emptyWaterBag = gameData.resources.empty_water_bag;
          const hasWaterBag = waterBag && waterBag.amount > 0;
          const hasEmptyWaterBag = emptyWaterBag && emptyWaterBag.amount > 0;
          let hasFullWaterBag = false;
          let hasPartialWaterBag = false;
          let hasEmptyWaterBagInstance = false;
          
          if (waterBag && waterBag.amount > 0) {
            if (waterBag.instances && waterBag.instances.length > 0) {
              hasFullWaterBag = waterBag.instances.some(inst => inst.waterLevel >= 100);
              hasPartialWaterBag = waterBag.instances.some(inst => inst.waterLevel > 0 && inst.waterLevel < 100);
              hasEmptyWaterBagInstance = waterBag.instances.some(inst => inst.waterLevel <= 0);
            } else {
              hasFullWaterBag = waterBag.waterLevel >= 100;
              hasPartialWaterBag = waterBag.waterLevel > 0 && waterBag.waterLevel < 100;
              hasEmptyWaterBagInstance = waterBag.waterLevel <= 0;
            }
          }

          // å¦‚æœæœ‰ç©ºæ°´è¢‹ï¼ˆempty_water_bagèµ„æºï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹
          if (hasEmptyWaterBag && waterBag.amount === 0) {
            waterBag.amount += emptyWaterBag.amount;
            emptyWaterBag.amount = 0;
            showNotification('æ°´è¢‹è½¬æ¢', `å·²å°†${waterBag.amount}ä¸ªç©ºæ°´è¢‹è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹`);
          }

          // é‡æ–°æ£€æŸ¥æ°´è¢‹çŠ¶æ€
          const hasWaterBagAfter = waterBag && waterBag.amount > 0;

          if (hasWaterBagAfter && !hasFullWaterBag) {
            // æœ‰ç©ºæ°´è¢‹æˆ–éƒ¨åˆ†æ°´è¢‹ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
            fillWaterBag();
          } else if (hasFullWaterBag) {
            // æ°´è¢‹æ°´é‡å·²æ»¡ï¼Œæ˜¾ç¤ºæç¤º
            showWaterBagFullModal();
          } else {
            // æ²¡æœ‰æ°´è¢‹ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
            showNoWaterBagModal();
          }
        };

        // åˆ›å»ºç”¨æœ¨æ¡¶è£…æŒ‰é’®
        const bucketButton = document.createElement('button');
        bucketButton.className = 'event-modal-option';
        bucketButton.innerHTML = `
          <div class="event-modal-option-text">ç”¨æœ¨æ¡¶è£…</div>
          <div class="event-modal-option-description">ä½¿ç”¨æœ¨æ¡¶è£…æ°´ï¼Œéœ€è¦å…ˆæœ‰ç©ºæœ¨æ¡¶</div>
        `;
        
        bucketButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
          
          // ç¡®ä¿æœ¨æ¡¶èµ„æºæ­£ç¡®åˆå§‹åŒ–
          ensureBucketResources();

          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæ£€æµ‹èƒŒåŒ…ä¸­æœ¨æ¡¶çŠ¶æ€
          const bucket = gameData.resources.bucket;
          const hasBucket = bucket && bucket.amount > 0;
          let isFull = false;
          if (bucket && bucket.amount > 0) {
            if (bucket.instances && bucket.instances.length > 0) {
              // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ»¡çš„å®ä¾‹
              isFull = bucket.instances.every(inst => inst.waterLevel >= 250);
            } else {
              isFull = bucket.waterLevel >= 250;
            }
          }

          if (hasBucket) {
            // æœ‰æœ¨æ¡¶
            if (isFull) {
              // æœ¨æ¡¶å·²æ»¡ï¼Œæ˜¾ç¤ºæœ¨æ¡¶å·²æ»¡æç¤º
              showBucketFullModal();
            } else {
              // æœ¨æ¡¶æœªæ»¡ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
              fillBucket();
            }
          } else {
            // æ²¡æœ‰æœ¨æ¡¶ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
            showNoBucketModal();
          }
        };

        buttonContainer.appendChild(handDrinkButton);
        buttonContainer.appendChild(waterBagButton);
        buttonContainer.appendChild(bucketButton);
        
        modalBody.appendChild(buttonContainer);
        modalContent.appendChild(modalBody);
        modalContainer.appendChild(modalContent);
        
        document.body.appendChild(modalContainer);
        
        // è§¦å‘åŠ¨ç”»
        setTimeout(() => modalContainer.classList.add('active'), 10);
        
        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
      }

// å®…é‚¸æ°´äº•é€‰é¡¹å¼¹çª—å‡½æ•°
// æºªè¾¹é€‰é¡¹å¼¹çª—å‡½æ•°
      function showStreamOptionsModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨ï¼Œä½¿ç”¨æ ‡å‡†æ ·å¼
        const modalContainer = document.createElement('div');
        modalContainer.className = 'event-modal';
        
        // åˆ›å»ºå¼¹çª—å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
        const modalContent = document.createElement('div');
        modalContent.className = 'event-modal-content ink-border';
        
        // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
        const modalHeader = document.createElement('div');
        modalHeader.className = 'event-modal-header';
        
        // åˆ›å»ºæ ‡é¢˜ï¼Œä½¿ç”¨ink-textæ ·å¼
        const title = document.createElement('h2');
        title.className = 'event-modal-title ink-text';
        title.textContent = 'æ¸…æ¾ˆçš„æºªæ°´';
        modalHeader.appendChild(title);
        
        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.className = 'event-modal-close';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        };
        modalHeader.appendChild(closeButton);
        
        modalContent.appendChild(modalHeader);
        
        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const modalBody = document.createElement('div');
        modalBody.className = 'event-modal-body';
        
        // æ·»åŠ æè¿°
        const description = document.createElement('p');
        description.className = 'event-modal-text';
        description.textContent = 'ä½ æ¥åˆ°ä¸€æ¡æ¸…æ¾ˆçš„å°æºªè¾¹ï¼Œæºªæ°´æ½ºæ½ºæµåŠ¨...';
        modalBody.appendChild(description);

        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'event-modal-options';

        // åˆ›å»ºç”¨æ‰‹æ§ç€å–æŒ‰é’®
        const handDrinkButton = document.createElement('button');
        handDrinkButton.className = 'event-modal-option';
        handDrinkButton.innerHTML = `
          <div class="event-modal-option-text">ç”¨æ‰‹æ§ç€å–</div>
          <div class="event-modal-option-description">ç›´æ¥ç”¨æ‰‹æ§æ°´å–ï¼Œå¯èƒ½ä¼šå¼„æ¹¿è¡£æœ</div>
        `;
        
        handDrinkButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
          drinkWaterWithHands();
        };

        // åˆ›å»ºç”¨æ°´è¢‹è£…æŒ‰é’®
        const waterBagButton = document.createElement('button');
        waterBagButton.className = 'event-modal-option';
        waterBagButton.innerHTML = `
          <div class="event-modal-option-text">ç”¨æ°´è¢‹è£…</div>
          <div class="event-modal-option-description">ä½¿ç”¨æ°´è¢‹è£…æ°´ï¼Œéœ€è¦å…ˆæœ‰æ°´è¢‹</div>
        `;
        
        waterBagButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
          
          // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
          ensureWaterBagResources();

          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæ£€æµ‹èƒŒåŒ…ä¸­æ°´è¢‹çŠ¶æ€
          const waterBag = gameData.resources.water_bag;
          const emptyWaterBag = gameData.resources.empty_water_bag;
          const hasWaterBag = waterBag && waterBag.amount > 0;
          const hasEmptyWaterBag = emptyWaterBag && emptyWaterBag.amount > 0;
          let hasFullWaterBag = false;
          let hasPartialWaterBag = false;
          let hasEmptyWaterBagInstance = false;
          
          if (waterBag && waterBag.amount > 0) {
            if (waterBag.instances && waterBag.instances.length > 0) {
              hasFullWaterBag = waterBag.instances.some(inst => inst.waterLevel >= 100);
              hasPartialWaterBag = waterBag.instances.some(inst => inst.waterLevel > 0 && inst.waterLevel < 100);
              hasEmptyWaterBagInstance = waterBag.instances.some(inst => inst.waterLevel <= 0);
            } else {
              hasFullWaterBag = waterBag.waterLevel >= 100;
              hasPartialWaterBag = waterBag.waterLevel > 0 && waterBag.waterLevel < 100;
              hasEmptyWaterBagInstance = waterBag.waterLevel <= 0;
            }
          }

          // å¦‚æœæœ‰ç©ºæ°´è¢‹ï¼ˆempty_water_bagèµ„æºï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹
          if (hasEmptyWaterBag && waterBag.amount === 0) {
            waterBag.amount += emptyWaterBag.amount;
            emptyWaterBag.amount = 0;
            showNotification('æ°´è¢‹è½¬æ¢', `å·²å°†${waterBag.amount}ä¸ªç©ºæ°´è¢‹è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹`);
          }

          // é‡æ–°æ£€æŸ¥æ°´è¢‹çŠ¶æ€
          const hasWaterBagAfter = waterBag && waterBag.amount > 0;

          if (hasWaterBagAfter && !hasFullWaterBag) {
            // æœ‰ç©ºæ°´è¢‹æˆ–éƒ¨åˆ†æ°´è¢‹ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
            fillWaterBag();
          } else if (hasFullWaterBag) {
            // æ°´è¢‹æ°´é‡å·²æ»¡ï¼Œæ˜¾ç¤ºæç¤º
            showWaterBagFullModal();
          } else {
            // æ²¡æœ‰æ°´è¢‹ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
            showNoWaterBagModal();
          }
        };

        // åˆ›å»ºä¸‹æ°´æ‘¸é±¼æŒ‰é’®
        const fishButton = document.createElement('button');
        fishButton.className = 'event-modal-option';
        fishButton.innerHTML = `
          <div class="event-modal-option-text">ä¸‹æ°´æ‘¸é±¼</div>
          <div class="event-modal-option-description">ä¸‹æ°´å°è¯•æ‘¸é±¼ï¼Œå¯èƒ½ä¼šæœ‰æ”¶è·</div>
        `;
        
        fishButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
          catchFishInStream();
        };

        // åˆ›å»ºç”¨æœ¨æ¡¶è£…æŒ‰é’®
        const bucketButton = document.createElement('button');
        bucketButton.className = 'event-modal-option';
        bucketButton.innerHTML = `
          <div class="event-modal-option-text">ç”¨æœ¨æ¡¶è£…</div>
          <div class="event-modal-option-description">ä½¿ç”¨æœ¨æ¡¶è£…æ°´ï¼Œéœ€è¦å…ˆæœ‰ç©ºæœ¨æ¡¶</div>
        `;
        
        bucketButton.onclick = function() {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
          
          // ç¡®ä¿æœ¨æ¡¶èµ„æºæ­£ç¡®åˆå§‹åŒ–
          ensureBucketResources();

          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæ£€æµ‹èƒŒåŒ…ä¸­æœ¨æ¡¶çŠ¶æ€
          const bucket = gameData.resources.bucket;
          const hasBucket = bucket && bucket.amount > 0;
          let isFull = false;
          if (bucket && bucket.amount > 0) {
            if (bucket.instances && bucket.instances.length > 0) {
              // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ»¡çš„å®ä¾‹
              isFull = bucket.instances.every(inst => inst.waterLevel >= 250);
            } else {
              isFull = bucket.waterLevel >= 250;
            }
          }

          if (hasBucket) {
            // æœ‰æœ¨æ¡¶
            if (isFull) {
              // æœ¨æ¡¶å·²æ»¡ï¼Œæ˜¾ç¤ºæœ¨æ¡¶å·²æ»¡æç¤º
              showBucketFullModal();
            } else {
              // æœ¨æ¡¶æœªæ»¡ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
              fillBucket();
            }
          } else {
            // æ²¡æœ‰æœ¨æ¡¶ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
            showNoBucketModal();
          }
        };

        buttonContainer.appendChild(handDrinkButton);
        buttonContainer.appendChild(waterBagButton);
        buttonContainer.appendChild(bucketButton);
        buttonContainer.appendChild(fishButton);
        
        modalBody.appendChild(buttonContainer);
        modalContent.appendChild(modalBody);
        modalContainer.appendChild(modalContent);
        
        document.body.appendChild(modalContainer);
        
        // è§¦å‘åŠ¨ç”»
        setTimeout(() => modalContainer.classList.add('active'), 10);
        
        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function(e) {
          if (e.target === modalContainer) {
            modalContainer.classList.remove('active');
            setTimeout(() => modalContainer.remove(), 300);
          }
        };
        
        // æ›´æ–°UI
        renderResources();
        renderActions();
        updateGameData();

        // æ¶ˆè€—æ—¶é—´
        advanceTime();
      }
    }

    // æ˜¾ç¤ºæ‰“æ°´å–é€‰æ‹©çª—å£
    function showGetWaterModal() {
      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'modal';
      modalContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;

      // åˆ›å»ºå¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background-color: #f0e6d6;
        padding: 2rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        min-width: 400px;
      `;

      // æ·»åŠ æ ‡é¢˜
      const title = document.createElement('h3');
      title.textContent = 'æ‰“æ°´å–';
      title.style.marginBottom = '1.5rem';
      modalContent.appendChild(title);

      // æ·»åŠ æŒ‰é’®å®¹å™¨
      const buttonContainer = document.createElement('div');
      buttonContainer.style.display = 'flex';
      buttonContainer.style.flexDirection = 'column';
      buttonContainer.style.gap = '1rem';
      buttonContainer.style.alignItems = 'center';

      // åˆ›å»ºç”¨æ‰‹æ§ç€å–æŒ‰é’®
      const drinkWithHandsBtn = document.createElement('button');
      drinkWithHandsBtn.textContent = 'ç”¨æ‰‹æ§ç€å–';
      drinkWithHandsBtn.className = 'ink-button ink-button-primary';
      drinkWithHandsBtn.addEventListener('click', function() {
        if (modalContainer.parentNode === document.body) {
          document.body.removeChild(modalContainer);
        }
        drinkWaterWithHands();
      });

      // åˆ›å»ºç”¨æ°´è¢‹è£…æŒ‰é’®
      const fillWaterBagBtn = document.createElement('button');
      fillWaterBagBtn.textContent = 'ç”¨æ°´è¢‹è£…';
      fillWaterBagBtn.className = 'ink-button ink-button-primary';
      fillWaterBagBtn.addEventListener('click', function() {
        if (modalContainer.parentNode === document.body) {
          document.body.removeChild(modalContainer);
        }

        // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
        ensureWaterBagResources();

        // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæ£€æŸ¥æ°´è¢‹çŠ¶æ€
        const waterBag = gameData.resources.water_bag;
        const emptyWaterBag = gameData.resources.empty_water_bag;
        const hasWaterBag = waterBag && waterBag.amount > 0;
        const hasEmptyWaterBag = emptyWaterBag && emptyWaterBag.amount > 0;
        let hasFullWaterBag = false;
        let hasPartialWaterBag = false;
        let hasEmptyWaterBagInstance = false;

        if (waterBag && waterBag.amount > 0) {
          if (waterBag.instances && waterBag.instances.length > 0) {
            hasFullWaterBag = waterBag.instances.some(inst => inst.waterLevel >= 100);
            hasPartialWaterBag = waterBag.instances.some(inst => inst.waterLevel > 0 && inst.waterLevel < 100);
            hasEmptyWaterBagInstance = waterBag.instances.some(inst => inst.waterLevel <= 0);
          } else {
            hasFullWaterBag = waterBag.waterLevel >= 100;
            hasPartialWaterBag = waterBag.waterLevel > 0 && waterBag.waterLevel < 100;
            hasEmptyWaterBagInstance = waterBag.waterLevel <= 0;
          }
        }

        // å¦‚æœæœ‰ç©ºæ°´è¢‹ï¼ˆempty_water_bagèµ„æºï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹
        if (hasEmptyWaterBag && waterBag.amount === 0) {
          waterBag.amount += emptyWaterBag.amount;
          emptyWaterBag.amount = 0;
          showNotification('æ°´è¢‹è½¬æ¢', `å·²å°†${waterBag.amount}ä¸ªç©ºæ°´è¢‹è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹`);
        }

        // é‡æ–°æ£€æŸ¥æ°´è¢‹çŠ¶æ€
        const hasWaterBagAfter = waterBag && waterBag.amount > 0;

        if (hasWaterBagAfter && !hasFullWaterBag) {
          // æœ‰ç©ºæ°´è¢‹æˆ–éƒ¨åˆ†æ°´è¢‹ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
          fillWaterBag();
        } else if (hasFullWaterBag) {
          // æ°´è¢‹æ°´é‡å·²æ»¡ï¼Œæ˜¾ç¤ºæç¤º
          showWaterBagFullModal();
        } else {
          // æ²¡æœ‰æ°´è¢‹ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
          showNoWaterBagModal();
        }
      });

      // åˆ›å»ºç”¨æœ¨æ¡¶è£…æŒ‰é’®
      const fillBucketBtn = document.createElement('button');
      fillBucketBtn.textContent = 'ç”¨æœ¨æ¡¶è£…';
      fillBucketBtn.className = 'ink-button ink-button-primary';
      fillBucketBtn.addEventListener('click', function() {
        if (modalContainer.parentNode === document.body) {
          document.body.removeChild(modalContainer);
        }

        // ç¡®ä¿æœ¨æ¡¶èµ„æºæ­£ç¡®åˆå§‹åŒ–
        ensureBucketResources();

        // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæ£€æµ‹èƒŒåŒ…ä¸­æœ¨æ¡¶çŠ¶æ€
        const bucket = gameData.resources.bucket;
        const hasBucket = bucket && bucket.amount > 0;
        let isFull = false;
        if (bucket && bucket.amount > 0) {
          if (bucket.instances && bucket.instances.length > 0) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ»¡çš„å®ä¾‹
            isFull = bucket.instances.every(inst => inst.waterLevel >= 250);
          } else {
            isFull = bucket.waterLevel >= 250;
          }
        }

        if (hasBucket) {
          // æœ‰æœ¨æ¡¶
          if (isFull) {
            // æœ¨æ¡¶å·²æ»¡ï¼Œæ˜¾ç¤ºæœ¨æ¡¶å·²æ»¡æç¤º
            showBucketFullModal();
          } else {
            // æœ¨æ¡¶æœªæ»¡ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
            fillBucket();
          }
        } else {
          // æ²¡æœ‰æœ¨æ¡¶ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
          showNoBucketModal();
        }
      });

      // åˆ›å»ºå–æ¶ˆæŒ‰é’®
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'å–æ¶ˆ';
      cancelBtn.className = 'ink-button ink-button-secondary';
      cancelBtn.addEventListener('click', function() {
        if (modalContainer.parentNode === document.body) {
          document.body.removeChild(modalContainer);
        }
      });

      buttonContainer.appendChild(drinkWithHandsBtn);
      buttonContainer.appendChild(fillWaterBagBtn);
      buttonContainer.appendChild(fillBucketBtn);
      buttonContainer.appendChild(cancelBtn);
      modalContent.appendChild(buttonContainer);

      // æ·»åŠ æ¨¡æ€çª—å£åˆ°æ–‡æ¡£
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);

      // æ¶ˆè€—æ—¶é—´
      advanceTime(30); // æ‰“æ°´å–æ¶ˆè€—30åˆ†é’Ÿ
    }

    // ç”¨æ‰‹æ§ç€å–çš„é€»è¾‘
      function drinkWaterWithHands() {
        const getWaterResults = {
          resources: {},
          status: {},
          effects: []
        };

// è¡¥å……å°‘é‡æ°´åˆ†ï¼Œæ¯”ç”¨ç¢—å°‘ä¸€äº›
        gameData.status.thirst = Math.min(100, gameData.status.thirst + 15); // å¢åŠ 15ç‚¹æ°´åˆ†å€¼
        getWaterResults.status.thirst = 15;

// æ·»åŠ è¡ŒåŠ¨æ•ˆæœè¯´æ˜
        getWaterResults.effects.push('ç”¨æ‰‹æ§ç€å–äº†ä¸€äº›æ°´');

// ä¿å­˜æ¸¸æˆæ•°æ®
        updateGameData();

showNotification('å–æ°´æˆåŠŸ', 'ä½ ç”¨æ‰‹æ§ç€å–äº†ä¸€äº›æ°´ï¼Œæ„Ÿè§‰ç¨å¾®æ²¡é‚£ä¹ˆæ¸´äº†ã€‚');
        // showEventResult('å–æ°´ç»“æœ', getWaterResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º
// æ›´æ–°UI
        renderResources();
        renderActions();

// æ’­æ”¾å–æ°´éŸ³æ•ˆ
        playSoundEffect('drink', 'éŸ³æ•ˆ/å–æ°´.wav', { volume: 0.7 });

// æ›´æ–°ç‰²å£æ£šçª—å£
        const livestockModal = document.getElementById('livestockModal');
        if (livestockModal && livestockModal.classList.contains('active')) {
          updateFeedDisplay();
        }
        // æ›´æ–°é©¬å©çª—å£
        const stableModal = document.getElementById('stableModal');
        if (stableModal && stableModal.classList.contains('active')) {
          if (window.updateStableFeedCards) {
            window.updateStableFeedCards();
          }
          if (window.updateFeedCards) {
            window.updateFeedCards();
          }
        }

// æ¶ˆè€—æ—¶é—´
        advanceTime();
      }

// ç”¨æ°´è¢‹è£…æ°´çš„é€»è¾‘
      function fillWaterBag() {
        const getWaterResults = {
          resources: {},
          status: {},
          effects: []
        };

          // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
        ensureWaterBagResources();

// ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæ£€æŸ¥æ°´è¢‹çŠ¶æ€
        const waterBag = gameData.resources.water_bag;
        const emptyWaterBag = gameData.resources.empty_water_bag;
        const hasWaterBag = waterBag && waterBag.amount > 0;
        const hasEmptyWaterBag = emptyWaterBag && emptyWaterBag.amount > 0;
        let isFull = false;
        let hasWater = false;
        let isEmpty = false;

        // å¦‚æœæœ‰ç©ºæ°´è¢‹ï¼ˆempty_water_bagèµ„æºï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹
        if (hasEmptyWaterBag && waterBag.amount === 0) {
          waterBag.amount += emptyWaterBag.amount;
          emptyWaterBag.amount = 0;
          showNotification('æ°´è¢‹è½¬æ¢', `å·²å°†${waterBag.amount}ä¸ªç©ºæ°´è¢‹è½¬æ¢ä¸ºæ™®é€šæ°´è¢‹`);
        }

        // é‡æ–°æ£€æŸ¥æ°´è¢‹çŠ¶æ€
        const hasWaterBagAfter = waterBag && waterBag.amount > 0;

        if (waterBag && waterBag.amount > 0) {
          if (waterBag.instances && waterBag.instances.length > 0) {
            isFull = waterBag.instances.every(inst => inst.waterLevel >= 100);
            hasWater = waterBag.instances.some(inst => inst.waterLevel > 0 && inst.waterLevel < 100);
            isEmpty = waterBag.instances.every(inst => inst.waterLevel <= 0);
          } else {
            isFull = waterBag.waterLevel >= 100;
            hasWater = waterBag.waterLevel > 0 && waterBag.waterLevel < 100;
            isEmpty = waterBag.waterLevel <= 0;
          }
        }

        if (hasWaterBagAfter && !isFull) {
          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼šè£…æ»¡ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹
          if (waterBag.instances && waterBag.instances.length > 0) {
            if (hasWater) {
              // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´ä½†æœªæ»¡çš„å®ä¾‹å¹¶è£…æ»¡
              for (const instance of waterBag.instances) {
                if (instance.waterLevel > 0 && instance.waterLevel < 100) {
                  instance.waterLevel = 100;
                  break;
                }
              }
            } else if (isEmpty) {
              // æ‰€æœ‰å®ä¾‹éƒ½æ˜¯ç©ºçš„ï¼Œè£…æ»¡ç¬¬ä¸€ä¸ªå®ä¾‹
              if (waterBag.instances.length > 0) {
                waterBag.instances[0].waterLevel = 100;
              }
            }

            // åŒæ­¥æ›´æ–°resource.waterLevel
            syncWaterBagWaterLevel();
          } else {
            // å…¼å®¹æ—§ä»£ç ï¼šè£…æ»¡æ°´è¢‹åˆ°100
            waterBag.waterLevel = Math.min(100, waterBag.waterLevel + (isEmpty ? 100 : (100 - waterBag.waterLevel)));
          }

          // ç¡®ä¿æ°´è¢‹æ²¡æœ‰è¢«æ ‡è®°ä¸ºè£…å¤‡çŠ¶æ€
          if (waterBag.equipped) {
            waterBag.equipped = false;
          }

// æ·»åŠ è¡ŒåŠ¨æ•ˆæœè¯´æ˜
          getWaterResults.effects.push('å°†æ°´è¢‹è£…æ»¡äº†æ°´');

// ä¿å­˜æ¸¸æˆæ•°æ®
          updateGameData();

// æ˜¾ç¤ºè£…æ°´æˆåŠŸå¼¹çª—
          showWaterBagFillSuccessModal();
        } else if (isFull) {
          // æ˜¾ç¤ºæ°´è¢‹å·²æ»¡æç¤º
          showWaterBagFullModal();
          return;
        } else {
          // æ²¡æœ‰æ°´è¢‹
          showNotification('è£…æ°´å¤±è´¥', 'ä½ æ²¡æœ‰æ°´è¢‹ï¼Œæ— æ³•è£…æ°´ã€‚');
        }


// æ›´æ–°UI
        renderResources();
        renderActions();

// æ›´æ–°ç‰²å£æ£šçª—å£
        const livestockModal = document.getElementById('livestockModal');
        if (livestockModal && livestockModal.classList.contains('active')) {
          updateFeedDisplay();
        }
        // æ›´æ–°é©¬å©çª—å£
        const stableModal = document.getElementById('stableModal');
        if (stableModal && stableModal.classList.contains('active')) {
          if (window.updateStableFeedCards) {
            window.updateStableFeedCards();
          }
          if (window.updateFeedCards) {
            window.updateFeedCards();
          }
        }

// æ¶ˆè€—æ—¶é—´
        advanceTime();
      }

// ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
      function ensureWaterBagResources() {
        // åˆå§‹åŒ–æ°´è¢‹
        if (!gameData.resources.water_bag) {
          gameData.resources.water_bag = {
            name: 'æ°´è¢‹',
            description: 'å¯ä»¥å‚¨å­˜æ°´åˆ†ï¼Œè¡¥å……èº«ä½“æ°´åˆ†',
            amount: 0,
            image: 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg',
            type: 'consumable',
            category: 'tool',
            id: 'water_bag',
            cannotDrop: false,
            waterLevel: 0, // åˆå§‹æ°´é‡
            durability: 100, // è€ä¹…åº¦
            // é¥®ç”¨æ•ˆæœ
            useEffect: function() {
              gameData.status.thirst = Math.min(100, gameData.status.thirst + 20); // å¢åŠ 20ç‚¹æ°´åˆ†å€¼
              return { thirst: 20 }; // å¢åŠ 20ç‚¹æ°´åˆ†å€¼
            }
          };
        } else {
          // ç¡®ä¿water_bagæœ‰waterLevelå’Œdurabilityå±æ€§
          if (gameData.resources.water_bag.waterLevel === undefined) {
            gameData.resources.water_bag.waterLevel = 0;
          }
          if (gameData.resources.water_bag.durability === undefined) {
            gameData.resources.water_bag.durability = 100;
          }
        }

// ç¡®ä¿æ°´è¢‹çš„å±æ€§æ­£ç¡®è®¾ç½®
        gameData.resources.water_bag.name = 'æ°´è¢‹';
        gameData.resources.water_bag.category = 'tool';
        gameData.resources.water_bag.type = 'consumable';
        // ç¡®ä¿ä¸å…·æœ‰è£…å¤‡å±æ€§
        delete gameData.resources.water_bag.equipmentSlot;

// ç¡®ä¿amountæ˜¯æ•°å­—ç±»å‹
        if (typeof gameData.resources.water_bag.amount !== 'number') {
          gameData.resources.water_bag.amount = 0;
        }
      }

// åŒæ­¥æ°´è¢‹å®ä¾‹ç³»ç»Ÿåˆ°resource.waterLevel
      function syncWaterBagWaterLevel() {
        const waterBag = gameData.resources.water_bag;
        if (!waterBag) return;

        if (waterBag.instances && waterBag.instances.length > 0) {
          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿè®¡ç®—æ€»æ°´é‡
          const totalWater = waterBag.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          waterBag.waterLevel = totalWater;
        }
        // å¦‚æœæ²¡æœ‰å®ä¾‹ç³»ç»Ÿï¼Œä¿æŒwaterLevelä¸å˜
      }

      // åŒæ­¥æ°´æ¡¶å®ä¾‹ç³»ç»Ÿåˆ°resource.waterLevel
      function syncBucketWaterLevel() {
        const bucket = gameData.resources.bucket;
        if (!bucket) return;

        if (bucket.instances && bucket.instances.length > 0) {
          // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿè®¡ç®—æ€»æ°´é‡
          const totalWater = bucket.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          bucket.waterLevel = totalWater;
        }
        // å¦‚æœæ²¡æœ‰å®ä¾‹ç³»ç»Ÿï¼Œä¿æŒwaterLevelä¸å˜
      }

// ä¸‹æ°´æ‘¸é±¼çš„é€»è¾‘
      function catchFishInStream() {
        // æ’­æ”¾è·³æ°´éŸ³æ•ˆ
        playDiveSound();
        
        const fishResults = {
          resources: {},
          status: {},
          effects: []
        };

// ç¡®ä¿é±¼èµ„æºå­˜åœ¨
        ensureFishResource();

// éšæœºåˆ¤æ–­æ˜¯å¦æ‘¸åˆ°é±¼ï¼ˆ50%å‡ ç‡ï¼‰
        const catchSuccess = Math.random() < 0.5;

if (catchSuccess) {
          // æˆåŠŸæ‘¸åˆ°é±¼
          const currentLocation = gameData.locations.find(loc => loc.currentLocation);
          const locationId = currentLocation ? currentLocation.id : 'wilderness';
          addResourceToGround('fish', 1, locationId);
          fishResults.resources.fish = 1;
          fishResults.effects.push('æˆåŠŸæ‘¸åˆ°ä¸€æ¡é±¼ï¼');

showNotification('æ‘¸é±¼æˆåŠŸ', 'ä½ æˆåŠŸä»æºªæ°´ä¸­æ‘¸åˆ°ä¸€æ¡é±¼ï¼');
        } else {
          // æ²¡æœ‰æ‘¸åˆ°é±¼
          fishResults.effects.push('è¿™æ¬¡æ²¡æœ‰æ‘¸åˆ°é±¼');
          showNotification('æ‘¸é±¼å¤±è´¥', 'ä½ åœ¨æ°´ä¸­æ‘¸ç´¢äº†åŠå¤©ï¼Œä½†æ²¡æœ‰æ‘¸åˆ°é±¼ã€‚');
        }

// ä¸‹æ°´æ‘¸é±¼ä¼šæ¶ˆè€—ä½“åŠ›
        gameData.status.health = Math.max(0, gameData.status.health - 3);
        checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
        fishResults.status.health = -3;

// ä¸‹æ°´æ‘¸é±¼æ— è®ºæˆåŠŸä¸å¦éƒ½ä¼šå…¨èº«æ¹¿é€ï¼ˆé™¤éåœ¨"æˆ‘çš„å®…é‚¸"ä¸­ï¼‰
        const currentLocation = gameData.locations.find(loc => loc.currentLocation);
        const isInMyMansion = currentLocation && currentLocation.id === 'my_mansion';
        
        if (!gameData.buffs['å…¨èº«æ¹¿é€'] && !isInMyMansion) {
          gameData.buffs['å…¨èº«æ¹¿é€'] = { active: true };
          fishResults.effects.push('ä½ æµ‘èº«æ¹¿é€äº†ï¼');
          showNotification('æµ‘èº«æ¹¿é€', 'ä½ çš„è¡£æœè¢«æ°´æµ¸é€äº†ï¼Œéœ€è¦çƒ¤ç«å–æš–ã€‚');
        }

// ä¿å­˜æ¸¸æˆæ•°æ®
        updateGameData();

// æ›´æ–°UI
        renderResources();
        renderActions();

// æ›´æ–°ç‰²å£æ£šçª—å£
        const livestockModal = document.getElementById('livestockModal');
        if (livestockModal && livestockModal.classList.contains('active')) {
          updateFeedDisplay();
        }
        // æ›´æ–°é©¬å©çª—å£
        const stableModal = document.getElementById('stableModal');
        if (stableModal && stableModal.classList.contains('active')) {
          if (window.updateStableFeedCards) {
            window.updateStableFeedCards();
          }
          if (window.updateFeedCards) {
            window.updateFeedCards();
          }
        }

// æ¶ˆè€—æ—¶é—´
        advanceTime();
      }

// ç¡®ä¿é±¼èµ„æºæ­£ç¡®åˆå§‹åŒ–
      function ensureFishResource() {
        if (!gameData.resources.fish) {
          gameData.resources.fish = {
            name: 'é±¼',
            description: 'æ–°é²œçš„é±¼ï¼Œå¯ä»¥çƒ¹é¥ªåé£Ÿç”¨',
            amount: 0,
            image: 'UI/é±¼.jpg',
            isRaw: true,
            type: 'consumable',
            category: 'food',
            expirationDays: 1,
            isPerishable: true,
            id: 'fish',
            cannotDrop: false,
            // ç›´æ¥é£Ÿç”¨ç”Ÿé±¼çš„æ•ˆæœ
            useEffect: function() {
              gameData.status.hunger = Math.min(100, gameData.status.hunger + 15);
              gameData.status.health = Math.max(0, gameData.status.health - 10); // ç”Ÿåƒæœ‰é£é™©
              checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
              return { hunger: 15, health: -10 };
            }
          };
        }

// ç¡®ä¿amountæ˜¯æ•°å­—ç±»å‹
        if (typeof gameData.resources.fish.amount !== 'number') {
          gameData.resources.fish.amount = 0;
        }
      }

// æ²¡æœ‰æ°´è¢‹æç¤ºå¼¹çª—
      function showNoWaterBagModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;

        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 300px;
        `;

        // æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'æ— æ³•è£…æ°´';
        title.style.marginBottom = '15px';
        modalContent.appendChild(title);

        // æ·»åŠ æç¤ºä¿¡æ¯
        const message = document.createElement('p');
        message.textContent = 'ä½ è¿˜æ²¡æœ‰æ°´è¢‹ï¼Œæ— æ³•æ‰“æ°´';
        message.style.marginBottom = '20px';
        modalContent.appendChild(message);

        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.textContent = 'å…³é—­';
        closeButton.style.cssText = `
          padding: 8px 16px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        closeButton.onclick = function() {
          modalContainer.remove();
        };

        modalContent.appendChild(closeButton);
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);

        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function() {
          modalContainer.remove();
        };

        // é˜²æ­¢ç‚¹å‡»å¼¹çª—å†…å®¹æ—¶è§¦å‘å…³é—­
        modalContent.onclick = function(e) {
          e.stopPropagation();
        };
      }

// æ°´è¢‹æ°´é‡å·²æ»¡æç¤ºå¼¹çª—
      function showWaterBagFullModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1001; /* æ¯”ä¹‹å‰çš„å¼¹çª—å±‚çº§æ›´é«˜ */
        `;

// åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 280px;
        `;

// æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'æç¤º';
        title.style.marginBottom = '15px';
        modalContent.appendChild(title);

// æ·»åŠ æç¤ºä¿¡æ¯
        const message = document.createElement('p');
        message.textContent = 'æ°´è¢‹å·²ç»è£…æ»¡äº†ï¼Œæ— æ³•ç»§ç»­è£…æ°´ã€‚';
        message.style.marginBottom = '20px';
        modalContent.appendChild(message);

// åˆ›å»ºç¡®å®šæŒ‰é’®
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®å®š';
        confirmButton.style.cssText = `
          padding: 10px 30px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;

confirmButton.onclick = function() {
          // ç§»é™¤æ‰€æœ‰æ¨¡æ€çª—å£
          const allModals = document.querySelectorAll('.modal');
          allModals.forEach(modal => modal.remove());

// æ›´æ–°UIå¹¶æ¶ˆè€—æ—¶é—´
          renderResources();
          renderActions();
          advanceTime();
        };

        modalContent.appendChild(confirmButton);
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
      }

// æ°´è¢‹è£…æ°´æˆåŠŸå¼¹çª—
      function showWaterBagFillSuccessModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1001;
        `;

// åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 280px;
        `;

// æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'è£…æ°´æˆåŠŸ';
        title.style.marginBottom = '15px';
        modalContent.appendChild(title);

// æ·»åŠ æç¤ºä¿¡æ¯
        const message = document.createElement('p');
        message.textContent = 'ä½ æˆåŠŸå°†æ°´è¢‹è£…æ»¡äº†æ°´ã€‚';
        message.style.marginBottom = '20px';
        modalContent.appendChild(message);

// åˆ›å»ºç¡®å®šæŒ‰é’®
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®å®š';
        confirmButton.style.cssText = `
          padding: 10px 30px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;

        confirmButton.onclick = function() {
          modalContainer.remove();
        };

        modalContent.appendChild(confirmButton);
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
      }

// ç¡®ä¿æœ¨æ¡¶èµ„æºæ­£ç¡®åˆå§‹åŒ–
      function ensureBucketResources() {
        // åˆå§‹åŒ–æœ¨æ¡¶ - ä¿æŒå‘åå…¼å®¹
        if (!gameData.resources.empty_bucket) {
          gameData.resources.empty_bucket = {
            name: 'æœ¨æ¡¶',
            description: 'ä¸€ä¸ªæœ¨æ¡¶ï¼Œå¯ä»¥ç”¨æ¥è£…æ°´',
            amount: 0,
            image: 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg',
            type: 'tool',
            category: 'material',
            id: 'empty_bucket',
            cannotDrop: false
          };
        }

        // ç¡®ä¿æœ¨æ¡¶çš„å±æ€§æ­£ç¡®è®¾ç½®
        gameData.resources.empty_bucket.name = 'æœ¨æ¡¶';
        gameData.resources.empty_bucket.category = 'tool';
        gameData.resources.empty_bucket.type = 'container';

        // åˆå§‹åŒ–æœ¨æ¡¶ - ç»Ÿä¸€ä¸ºä¸€ä¸ªæœ¨æ¡¶èµ„æº
        if (!gameData.resources.bucket) {
          gameData.resources.bucket = {
            name: 'æœ¨æ¡¶', // ç»Ÿä¸€åç§°ï¼Œä¼šæ ¹æ®waterLevelåŠ¨æ€æ˜¾ç¤ºä¸åŒå›¾ç‰‡
            description: 'ä¸€ä¸ªæœ¨æ¡¶ï¼Œå¯ä»¥ç”¨æ¥è£…æ°´',
            amount: 0,
            image: 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg',
            type: 'container',
            category: 'tool',
            id: 'bucket',
            cannotDrop: false,
            instances: [], // å­˜å‚¨æ¯ä¸ªæœ¨æ¡¶å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æœ‰ç‹¬ç«‹çš„æ°´ä½
            waterLevel: 0, // ä¿ç•™å…¼å®¹æ€§ï¼Œå®é™…ä½¿ç”¨instancesæ•°ç»„
            durability: 100, // è€ä¹…åº¦
            useEffect: function() {
              const bucket = gameData.resources.bucket;
              if (bucket.instances && bucket.instances.length > 0) {
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹
                for (const instance of bucket.instances) {
                  if (instance.waterLevel > 0) {
                    if (instance.waterLevel >= 50) {
                      instance.waterLevel -= 50;
                      gameData.status.thirst = Math.min(100, gameData.status.thirst + 50);
                      
                      // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
                      updateContainerImage('bucket');
                      
                      return { thirst: 50 };
                    } else {
                      // æ°´é‡ä¸è¶³50æ—¶å…¨éƒ¨é¥®ç”¨
                      const thirst = instance.waterLevel;
                      instance.waterLevel = 0;
                      gameData.status.thirst = Math.min(100, gameData.status.thirst + thirst);
                      
                      // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
                      updateContainerImage('bucket');
                      
                      return { thirst: thirst };
                    }
                  }
                }
              }
              return { thirst: 0 };
            }
          };
        }

        // ç¡®ä¿waterLevelå±æ€§å­˜åœ¨
        if (gameData.resources.bucket.waterLevel === undefined) {
          gameData.resources.bucket.waterLevel = 0;
        }

        // ç¡®ä¿amountæ˜¯æ•°å­—ç±»å‹
        if (typeof gameData.resources.empty_bucket.amount !== 'number') {
          gameData.resources.empty_bucket.amount = 0;
        }
        if (typeof gameData.resources.bucket.amount !== 'number') {
          gameData.resources.bucket.amount = 0;
        }

        // ä¿æŒempty_bucketä¸ºbucketçš„å¼•ç”¨ï¼ˆå‘åå…¼å®¹ï¼‰
        gameData.resources.empty_bucket = gameData.resources.bucket;
      }

// ç”¨æœ¨æ¡¶è£…æ°´çš„é€»è¾‘
      function fillBucket() {
        const getWaterResults = {
          resources: {},
          status: {},
          effects: []
        };

        // ç¡®ä¿æœ¨æ¡¶èµ„æºæ­£ç¡®åˆå§‹åŒ–
        ensureBucketResources();

        const bucket = gameData.resources.bucket;

        // æ£€æŸ¥æ˜¯å¦æœ‰æœ¨æ¡¶ä¸”æœªæ»¡
        if (!bucket || bucket.amount <= 0) {
          // æ²¡æœ‰æœ¨æ¡¶
          showNotification('è£…æ°´å¤±è´¥', 'ä½ æ²¡æœ‰æœ¨æ¡¶ï¼Œæ— æ³•è£…æ°´ã€‚');
          return;
        }

        // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªæ»¡çš„å®ä¾‹å¹¶è£…æ»¡
        if (bucket.instances && bucket.instances.length > 0) {
          let foundUnfilled = false;
          for (const instance of bucket.instances) {
            if (instance.waterLevel < 250) {
              instance.waterLevel = 250; // è£…æ»¡è¿™ä¸ªå®ä¾‹
              foundUnfilled = true;
              getWaterResults.resources.bucket_water = 250;
              getWaterResults.effects.push(`å°†ä¸€ä¸ªæœ¨æ¡¶è£…æ»¡æ°´ï¼Œå½“å‰æ°´é‡: ${instance.waterLevel}/250`);
              break;
            }
          }
          if (!foundUnfilled) {
            // æ‰€æœ‰å®ä¾‹éƒ½å·²æ»¡
            showBucketFullModal();
            return;
          }
        } else if (bucket.waterLevel >= 250) {
          // å…¼å®¹æ—§ä»£ç ï¼šæœ¨æ¡¶å·²æ»¡
          showBucketFullModal();
          return;
        } else {
          // å…¼å®¹æ—§ä»£ç ï¼šç›´æ¥è£…æ»¡
          bucket.waterLevel = 250;
          getWaterResults.resources.bucket_water = 250;
          getWaterResults.effects.push(`å°†æœ¨æ¡¶è£…æ°´ï¼Œå½“å‰æ°´é‡: ${bucket.waterLevel}/250`);
        }
        
        // æ›´æ–°æœ¨æ¡¶å›¾ç‰‡ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°ï¼‰
        updateContainerImage('bucket');

        // åˆå§‹åŒ–æœ¨æ¡¶è€ä¹…åº¦ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (bucket.durability === undefined) {
          bucket.durability = 100;
        }

        // ä¿å­˜æ¸¸æˆæ•°æ®
        updateGameData();

        // æ›´æ–°æ‰€æœ‰çª—å£ä¸­çš„èµ„æºå¡ç‰Œæ˜¾ç¤º
        updateResourceCard('bucket');
        // æ›´æ–°ä»“åº“çª—å£
        const storageModal = document.getElementById('storageModal');
        if (storageModal && storageModal.classList.contains('active')) {
          populateStorageModal();
        }
        // æ›´æ–°ç‰²å£æ£šçª—å£
        const livestockModal = document.getElementById('livestockModal');
        if (livestockModal && livestockModal.classList.contains('active')) {
          updateFeedDisplay();
        }
        // æ›´æ–°é©¬å©çª—å£
        const stableModal = document.getElementById('stableModal');
        if (stableModal && stableModal.classList.contains('active')) {
          if (window.updateStableFeedCards) {
            window.updateStableFeedCards();
          }
          if (window.updateFeedCards) {
            window.updateFeedCards();
          }
        }
        // æ›´æ–°å†œç”°çª—å£
        if (window.updateFarmlandRelatedResources) {
          window.updateFarmlandRelatedResources();
        }

        // é‡æ–°æ¸²æŸ“èƒŒåŒ…æ ï¼Œç¡®ä¿å¡ç‰Œæ•°é‡å˜åŒ–ç«‹å³æ˜¾ç¤º
        renderResources();

        // æ˜¾ç¤ºè£…æ°´æˆåŠŸå¼¹çª—
        showBucketFillSuccessModal();
      }

// æ²¡æœ‰æœ¨æ¡¶æç¤ºå¼¹çª—
      function showNoBucketModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;

        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 300px;
        `;

        // æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'æ— æ³•è£…æ°´';
        title.style.marginBottom = '15px';
        modalContent.appendChild(title);

        // æ·»åŠ æç¤ºä¿¡æ¯
        const message = document.createElement('p');
        message.textContent = 'ä½ è¿˜æ²¡æœ‰æœ¨æ¡¶ï¼Œæ— æ³•æ‰“æ°´';
        message.style.marginBottom = '20px';
        modalContent.appendChild(message);

        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.textContent = 'å…³é—­';
        closeButton.style.cssText = `
          padding: 8px 16px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        closeButton.onclick = function() {
          modalContainer.remove();
        };

        modalContent.appendChild(closeButton);
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);

        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function() {
          modalContainer.remove();
        };

        // é˜²æ­¢ç‚¹å‡»å¼¹çª—å†…å®¹æ—¶è§¦å‘å…³é—­
        modalContent.onclick = function(e) {
          e.stopPropagation();
        };
      }

// æœ¨æ¡¶å·²æ»¡æç¤ºå¼¹çª—
      function showBucketFullModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1001; /* æ¯”ä¹‹å‰çš„å¼¹çª—å±‚çº§æ›´é«˜ */
        `;

        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 280px;
        `;

        // æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'æç¤º';
        title.style.marginBottom = '15px';
        modalContent.appendChild(title);

      // æ·»åŠ æç¤ºä¿¡æ¯
      const message = document.createElement('p');
      message.textContent = 'æœ¨æ¡¶æ°´é‡å·²æ»¡ï¼ˆ250ï¼‰ï¼Œæ— æ³•ç»§ç»­è£…æ°´ã€‚è¯·å…ˆé¥®ç”¨ä¸€äº›æ°´ï¼Œç„¶åå†è£…æ°´ã€‚';
      message.style.marginBottom = '20px';
      modalContent.appendChild(message);

        // åˆ›å»ºç¡®å®šæŒ‰é’®
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®å®š';
        confirmButton.style.cssText = `
          padding: 10px 30px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;

        confirmButton.onclick = function() {
          // ç§»é™¤æ‰€æœ‰æ¨¡æ€çª—å£
          const allModals = document.querySelectorAll('.modal');
          allModals.forEach(modal => modal.remove());

          // æ›´æ–°UIå¹¶æ¶ˆè€—æ—¶é—´
          renderResources();
          renderActions();
          advanceTime();
        };

        modalContent.appendChild(confirmButton);
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
      }

// æœ¨æ¡¶è£…æ°´æˆåŠŸå¼¹çª—
      function showBucketFillSuccessModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1001;
        `;

// åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 280px;
        `;

// æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'è£…æ°´æˆåŠŸ';
        title.style.marginBottom = '15px';
        modalContent.appendChild(title);

// æ·»åŠ æç¤ºä¿¡æ¯
        const message = document.createElement('p');
        message.textContent = 'ä½ æˆåŠŸå°†æœ¨æ¡¶è£…æ»¡äº†æ°´ã€‚';
        message.style.marginBottom = '20px';
        modalContent.appendChild(message);

// åˆ›å»ºç¡®å®šæŒ‰é’®
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®å®š';
        confirmButton.style.cssText = `
          padding: 10px 30px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;

        confirmButton.onclick = function() {
          modalContainer.remove();
        };

        modalContent.appendChild(confirmButton);
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
      }

      // æ›´æ–°UI
      renderResources();
      renderActions();
      updateGameData();

      // æ¶ˆè€—æ—¶é—´
      advanceTime();
    }

    // å†œç”°ç³»ç»Ÿåˆå§‹åŒ–å°†åœ¨showFarmlandModalå‡½æ•°ä¸­å®Œæˆ
    
    // ç¡®ä¿å†œç”°æ•°æ®å­˜åœ¨
    if (!gameData.farmlandData) {
      gameData.farmlandData = {
        level: 1, // å†œç”°ç­‰çº§ï¼š1-3çº§
        cells: Array(9).fill(null).map(() => ({
          crop: null,
          growthStage: 0, // 0:æœªç§æ¤, 1:æ—©æœŸ, 2:ä¸­æœŸ, 3:æˆç†ŸæœŸ
          moisture: 0,    // æ¹¿æ¶¦åº¦: 0-100
          fertility: 50,  // è‚¥æ²ƒåº¦: 0-100
          plantedDay: null // ç§æ¤æ—¥æœŸ
        })),
        seeds: {
          corn_seed: { name: 'ç‰ç±³ç§å­', growthTime: 6, image: 'UI/ç‰ç±³ç§å­.jpg',
            stages: ['UI/ç‰ç±³æ—©æœŸ.jpg', 'UI/ç‰ç±³ä¸­æœŸ.jpg', 'UI/ç‰ç±³æˆç†ŸæœŸ.jpg'],
            reward: 'corn', rewardCount: [2, 4, 6] },
          wheat_seed: { name: 'å°éº¦ç§å­', growthTime: 5, image: 'UI/å°éº¦ç§å­.jpg',
            stages: ['UI/å°éº¦æ—©æœŸ.jpg', 'UI/å°éº¦ä¸­æœŸ.jpg', 'UI/å°éº¦æˆç†ŸæœŸ.jpg'],
            reward: 'wheat', rewardCount: [3, 5, 8] },
          rice_seed: { name: 'æ°´ç¨»ç§å­', growthTime: 6, image: 'UI/æ°´ç¨»ç§å­.jpg',
            stages: ['UI/æ°´ç¨»æ—©æœŸ.jpg', 'UI/æ°´ç¨»ä¸­æœŸ.jpg', 'UI/æ°´ç¨»æˆç†ŸæœŸ.jpg'],
            reward: 'rice', rewardCount: [4, 6, 9] },
          vegetable_seed: { name: 'è”¬èœç§å­', growthTime: 4, image: 'UI/è”¬èœç§å­.jpg',
            stages: ['UI/è”¬èœæ—©æœŸ.jpg', 'UI/è”¬èœä¸­æœŸ.jpg', 'UI/è”¬èœæˆç†ŸæœŸ.jpg'],
            reward: 'vegetable', rewardCount: [2, 3, 5] },
          fruit_seed: { name: 'æ°´æœç§å­', growthTime: 7, image: 'UI/æ°´æœç§å­.jpg',
            stages: ['UI/æ°´æœæ—©æœŸ.jpg', 'UI/æ°´æœä¸­æœŸ.jpg', 'UI/æ°´æœæˆç†ŸæœŸ.jpg'],
            reward: 'fruit', rewardCount: [3, 5, 8] }
        }
      };
    }
    // ç¡®ä¿å†œç”°ç­‰çº§å­˜åœ¨ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
    if (gameData.farmlandData && typeof gameData.farmlandData.level === 'undefined') {
      gameData.farmlandData.level = 1;
    }

    // ç¡®ä¿ç‰²å£æ£šæ•°æ®å­˜åœ¨
    if (!gameData.livestockData) {
      gameData.livestockData = {
        level: 1,  // ç‰²å£æ£šç­‰çº§ï¼Œåˆå§‹ä¸º1çº§
        stalls: Array(4).fill(null).map(() => ({
          animal: null,          // å½“å‰å…»æ®–çš„åŠ¨ç‰©ç±»å‹
          growthStage: 0,        // 0:ç©ºæ , 1:å¹¼å¹´æœŸ, 2:æˆå¹´æœŸ
          health: 70,            // å¥åº·å€¼: 0-100
          productivity: 70,      // ç”Ÿäº§æ•ˆç‡: 0-100
          cleanliness: 0,        // æ±¡æµŠåº¦: 0-100
          startDay: null,        // å¼€å§‹å…»æ®–æ—¥æœŸ
          lastFedDay: null,      // ä¸Šæ¬¡å–‚å…»æ—¥æœŸ
          lastProducedDay: null, // ä¸Šæ¬¡ç”Ÿäº§æ—¥æœŸ
          produceCount: 0,       // ç´¯è®¡ç”Ÿäº§æ¬¡æ•°
          specialState: null     // ç‰¹æ®ŠçŠ¶æ€: null, "high_production", "fast_growth"
        })),
        animals: {
          chick: { 
            name: 'é¸¡', 
            babyName: 'é¸¡å´½',
            adultName: 'é¸¡æˆå¹´æœŸ',
            growthTime: 3, 
            babyImage: 'UI/é¸¡å¹¼å¹´æœŸ.jpg', 
            adultImage: 'UI/é¸¡æˆå¹´æœŸ.jpg', 
            product: 'egg', 
            maxProduction: 15,   // æœ€å¤šä¸‹è›‹15æ¬¡
            fertilityBonus: 1     // äº§ç”Ÿçš„è‚¥æ–™æ•°é‡
          },
          duckling: { 
            name: 'é¸­', 
            babyName: 'é¸­å´½',
            adultName: 'é¸­æˆå¹´æœŸ',
            growthTime: 5, 
            babyImage: 'UI/é¸­å¹¼å¹´æœŸ.jpg', 
            adultImage: 'UI/é¸­æˆå¹´æœŸ.jpg', 
            product: 'egg', 
            maxProduction: 12,   // æœ€å¤šä¸‹è›‹12æ¬¡
            fertilityBonus: 1     // äº§ç”Ÿçš„è‚¥æ–™æ•°é‡
          },
          piglet: { 
            name: 'çŒª', 
            babyName: 'çŒªå´½',
            adultName: 'çŒªæˆå¹´æœŸ',
            growthTime: 10, 
            babyImage: 'UI/çŒªå¹¼å¹´æœŸ.jpg', 
            adultImage: 'UI/çŒªæˆå¹´æœŸ.jpg', 
            product: null,       // çŒªä¸äº§è›‹
            maxProduction: 0,    // ä¸é€‚ç”¨
            fertilityBonus: 2     // äº§ç”Ÿçš„è‚¥æ–™æ•°é‡
          }
        }
      };
    }

    // ç¡®ä¿é©¬å©æ•°æ®å­˜åœ¨
    if (!gameData.stableData) {
      gameData.stableData = {
        level: 1,  // é©¬å©ç­‰çº§ï¼Œåˆå§‹ä¸º1çº§
        stalls: Array(4).fill(null).map(() => ({
          horse: null,           // å½“å‰å…»æ®–çš„é©¬åŒ¹ç±»å‹
          health: 100,           // å¥åº·å€¼: 0-100
          satiety: 100,         // é¥±é£Ÿåº¦: 0-100
          cleanliness: 0,       // æ±¡æµŠåº¦: 0-100
          startDay: null,        // å¼€å§‹å…»æ®–æ—¥æœŸ
          lastFedDay: null,      // ä¸Šæ¬¡å–‚å…»æ—¥æœŸ
          lastCleanedDay: null  // ä¸Šæ¬¡æ¸…æ´æ—¥æœŸ
        })),
        horses: {
          native_horse: { 
            name: 'æœ¬åœŸé©¬', 
            image: 'UI/æœ¬åœŸé©¬.jpg', 
            maxHealth: 100,      // æœ€å¤§å¥åº·å€¼
            dailyHealthLoss: 2,  // æ¯æ—¥å¥åº·å€¼æŸå¤±
            dailySatietyLoss: 10, // æ¯æ—¥é¥±é£Ÿåº¦æŸå¤±
            dailyCleanlinessIncrease: 5, // æ¯æ—¥æ±¡æµŠåº¦å¢åŠ 
            produceInterval: 7   // äº§å‡ºå‘¨æœŸ(å¤©)
          },
          mongolian_horse: { 
            name: 'è’™å¤é©¬', 
            image: 'UI/è’™å¤é©¬.jpg', 
            maxHealth: 120,
            dailyHealthLoss: 2,
            dailySatietyLoss: 8,
            dailyCleanlinessIncrease: 4,
            produceInterval: 6
          },
          hequ_horse: { 
            name: 'æ²³æ›²é©¬', 
            image: 'UI/æ²³æ›²é©¬.jpg', 
            maxHealth: 140,
            dailyHealthLoss: 1,
            dailySatietyLoss: 12,
            dailyCleanlinessIncrease: 6,
            produceInterval: 8
          },
          ferghana_horse: { 
            name: 'æ±—è¡€å®é©¬', 
            image: 'UI/æ±—è¡€å®é©¬.jpg', 
            maxHealth: 150,
            dailyHealthLoss: 1,
            dailySatietyLoss: 9,
            dailyCleanlinessIncrease: 5,
            produceInterval: 5
          },
          super_ferghana_horse: { 
            name: 'æå“æ±—è¡€å®é©¬', 
            image: 'UI/æå“æ±—è¡€å®é©¬.jpg', 
            maxHealth: 180,
            dailyHealthLoss: 0,
            dailySatietyLoss: 7,
            dailyCleanlinessIncrease: 4,
            produceInterval: 4
          }
        }
      };
    }
    
    // è·å–å½“å‰çš„å†œç”°æ•°æ®
    const farmlandData = gameData.farmlandData;
    
    // æ˜¾ç¤ºå†œç”°æ ¼å­æ‚¬åœæç¤ºæ¡†
    function showFarmlandTooltip(farmlandCell, cellData, index) {
      // å…ˆç§»é™¤å·²å­˜åœ¨çš„æç¤ºæ¡†ï¼Œé¿å…é‡å¤åˆ›å»º
      hideFarmlandTooltip();
      
      // ç›´æ¥ä» gameData è·å–æœ€æ–°çš„å†œç”°æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°å€¼
      const farmlandData = gameData.farmlandData;
      if (!farmlandData || !farmlandData.cells) return;
      const latestCellData = farmlandData.cells[index];
      
      const tooltip = document.createElement('div');
      tooltip.id = 'farmland-tooltip';
      tooltip.className = 'farmland-tooltip';
      
      // è·å–æ ¼å­ä½ç½®ä¿¡æ¯
      const rect = farmlandCell.getBoundingClientRect();
      const tooltipWidth = 220;
      const tooltipHeight = 150;
      let left = rect.left + rect.width + 10;
      let top = rect.top;
      
      // å¦‚æœæç¤ºæ¡†è¶…å‡ºçª—å£å³ä¾§ï¼Œåˆ™æ˜¾ç¤ºåœ¨å·¦ä¾§
      if (left + tooltipWidth > window.innerWidth) {
        left = rect.left - tooltipWidth - 10;
      }
      
      // å¦‚æœæç¤ºæ¡†è¶…å‡ºçª—å£åº•éƒ¨ï¼Œåˆ™å‘ä¸Šè°ƒæ•´
      if (top + tooltipHeight > window.innerHeight) {
        top = window.innerHeight - tooltipHeight - 10;
      }
      
      // æ„å»ºçŠ¶æ€ä¿¡æ¯ï¼ˆä½¿ç”¨æœ€æ–°çš„ cellDataï¼‰
      let statusInfo = '';
      if (latestCellData.crop === null) {
        statusInfo = `
          <div class="tooltip-status">
            <div class="tooltip-label">çŠ¶æ€ï¼š</div>
            <div class="tooltip-value" style="color: #4CAF50;">æœªç§æ¤</div>
          </div>
          <div class="tooltip-description">å¯ä»¥åœ¨æ­¤å¤„æ’­ç§</div>
        `;
      } else {
        // è®¡ç®—ç”Ÿé•¿é˜¶æ®µ
        const currentDay = gameData.day || 1;
        const daysSincePlanted = latestCellData.plantedDay ? currentDay - latestCellData.plantedDay : 0;
        const seed = farmlandData.seeds[latestCellData.crop];
        let stageText = 'æœªçŸ¥';
        let stageColor = '#666';
        
        if (daysSincePlanted <= 2) {
          stageText = 'æ—©æœŸ';
          stageColor = '#8BC34A';
        } else if (daysSincePlanted <= 4) {
          stageText = 'ä¸­æœŸ';
          stageColor = '#FFC107';
        } else if (daysSincePlanted >= 5) {
          stageText = 'æˆç†ŸæœŸ';
          stageColor = '#F44336';
        }
        
        statusInfo = `
          <div class="tooltip-status">
            <div class="tooltip-label">ä½œç‰©ï¼š</div>
            <div class="tooltip-value">${seed.name.replace('ç§å­', '')}</div>
          </div>
          <div class="tooltip-status">
            <div class="tooltip-label">çŠ¶æ€ï¼š</div>
            <div class="tooltip-value" style="color: ${stageColor};">${stageText}</div>
          </div>
          <div class="tooltip-status">
            <div class="tooltip-label">ç§æ¤å¤©æ•°ï¼š</div>
            <div class="tooltip-value">${daysSincePlanted}å¤©</div>
          </div>
          ${latestCellData.growthStage === 3 ? '<div class="tooltip-description" style="color: #FFD700;">ç‚¹å‡»æ”¶è·</div>' : '<div class="tooltip-description">ç»§ç»­ç”Ÿé•¿ä¸­...</div>'}
        `;
      }
      
      // æ·»åŠ èµ„æºçŠ¶æ€ä¿¡æ¯ï¼ˆä½¿ç”¨æœ€æ–°çš„ cellDataï¼‰
      const resourceInfo = `
        <div class="tooltip-resources">
          <div class="tooltip-label">æ¹¿æ¶¦åº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${latestCellData.moisture}%; background-color: #2196F3;"></div>
          </div>
          <div class="tooltip-value">${latestCellData.moisture}%</div>
        </div>
        <div class="tooltip-resources">
          <div class="tooltip-label">è‚¥æ²ƒåº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${latestCellData.fertility}%; background-color: #4CAF50;"></div>
          </div>
          <div class="tooltip-value">${latestCellData.fertility}%</div>
        </div>
      `;
      
      // æ ¼å­ç¼–å·
      const gridPosition = Math.floor(index / 3) + 1; // è¡Œå· (1-3)
      const cellPosition = (index % 3) + 1; // åˆ—å· (1-3)
      
      tooltip.innerHTML = `
        <div class="tooltip-header">å†œç”°æ ¼å­ [${gridPosition}-${cellPosition}]</div>
        ${statusInfo}
        <div class="tooltip-divider"></div>
        ${resourceInfo}
      `;
      
      document.body.appendChild(tooltip);
      
      // å®šä½å·¥å…·æç¤º
      tooltip.style.position = 'fixed';
      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
      tooltip.style.zIndex = '2000';
      
      // æ·»åŠ è½»å¾®æ”¾å¤§æ•ˆæœ
      farmlandCell.style.transform = 'scale(1.05)';
      farmlandCell.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.3)';
    }
    
    // éšè—å†œç”°æ ¼å­æ‚¬åœæç¤ºæ¡†
    function hideFarmlandTooltip() {
      // ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿ç§»é™¤æç¤ºæ¡†
      const tooltip = document.getElementById('farmland-tooltip');
      if (tooltip) {
        // å…ˆéšè—æç¤ºæ¡†
        tooltip.style.opacity = '0';
        tooltip.style.visibility = 'hidden';
        
        // çŸ­æš‚å»¶è¿Ÿåç§»é™¤å…ƒç´ ï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆ
        setTimeout(() => {
          if (tooltip && tooltip.parentNode) {
            tooltip.parentNode.removeChild(tooltip);
          }
        }, 50);
      }
      
      // æ¢å¤æ‰€æœ‰å†œç”°æ ¼å­çš„æ ·å¼
      document.querySelectorAll('.farmland-cell').forEach(cell => {
        if (!cell.classList.contains('highlight') && !cell.classList.contains('pulse-glow')) {
          cell.style.transform = '';
          cell.style.boxShadow = '';
        }
      });
    }
    
    // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿æç¤ºæ¡†èƒ½å¤Ÿæ­£ç¡®å…³é—­
    document.addEventListener('mouseover', function(e) {
      const tooltip = document.getElementById('farmland-tooltip');
      if (tooltip) {
        // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨å†œç”°æ ¼å­æˆ–æç¤ºæ¡†å†…
        const isOverFarmlandCell = e.target.closest('.farmland-cell');
        const isOverTooltip = e.target.closest('#farmland-tooltip');
        
        // å¦‚æœé¼ æ ‡ä¸åœ¨å†œç”°æ ¼å­æˆ–æç¤ºæ¡†å†…ï¼Œåˆ™å…³é—­æç¤ºæ¡†
        if (!isOverFarmlandCell && !isOverTooltip) {
          hideFarmlandTooltip();
        }
      }
      
      // æ£€æŸ¥ç‰²å£æ å·¥å…·æç¤º
      const livestockTooltip = document.getElementById('livestock-tooltip');
      if (livestockTooltip) {
        const isOverLivestockStall = e.target.closest('.livestock-stall');
        const isOverLivestockCard = e.target.closest('.livestock-card');
        const isOverLivestockTooltip = e.target.closest('#livestock-tooltip');
        
        if (!isOverLivestockStall && !isOverLivestockCard && !isOverLivestockTooltip) {
          hideLivestockTooltip();
        }
      }
    });

    // æ·»åŠ é¼ æ ‡ç§»å‡ºäº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿å·¥å…·æç¤ºèƒ½å¤Ÿæ­£ç¡®å…³é—­
    document.addEventListener('mouseout', function(e) {
      const tooltip = document.getElementById('farmland-tooltip');
      if (tooltip) {
        // æ£€æŸ¥é¼ æ ‡æ˜¯å¦ä»å†œç”°æ ¼å­æˆ–æç¤ºæ¡†ç§»å‡º
        const relatedTarget = e.relatedTarget;
        const isLeavingFarmlandCell = e.target.closest('.farmland-cell') && !relatedTarget?.closest('.farmland-cell');
        const isLeavingTooltip = e.target.closest('#farmland-tooltip') && !relatedTarget?.closest('#farmland-tooltip');
        
        // å¦‚æœé¼ æ ‡ä»å†œç”°æ ¼å­æˆ–æç¤ºæ¡†ç§»å‡ºï¼Œåˆ™å…³é—­æç¤ºæ¡†
        if (isLeavingFarmlandCell || isLeavingTooltip) {
          hideFarmlandTooltip();
        }
      }
      
      // æ£€æŸ¥ç‰²å£æ å·¥å…·æç¤º
      const livestockTooltip = document.getElementById('livestock-tooltip');
      if (livestockTooltip) {
        const relatedTarget = e.relatedTarget;
        const isLeavingLivestockStall = e.target.closest('.livestock-stall') && !relatedTarget?.closest('.livestock-stall');
        const isLeavingLivestockCard = e.target.closest('.livestock-card') && !relatedTarget?.closest('.livestock-card');
        const isLeavingLivestockTooltip = e.target.closest('#livestock-tooltip') && !relatedTarget?.closest('#livestock-tooltip');
        
        if (isLeavingLivestockStall || isLeavingLivestockCard || isLeavingLivestockTooltip) {
          hideLivestockTooltip();
        }
      }
    });
    

    
    // åˆ›å»ºå†œç”°æ ¼å­å‡½æ•°
    function createFarmlandCell(index, cellData) {
      const farmlandCell = document.createElement('div');
      farmlandCell.className = 'farmland-cell';
      farmlandCell.id = `farmland-cell-${index}`; // æ·»åŠ idå±æ€§ï¼Œä¾›plantCropå‡½æ•°ä½¿ç”¨
      farmlandCell.dataset.cellId = index;

      // å®šä¹‰å†œç”°æ ¼å­è§£é”è§„åˆ™
      // 1çº§ï¼šè§£é”æ ¼å­0ã€1ï¼ˆ1-1ã€1-2ï¼‰
      // 2çº§ï¼šè§£é”æ ¼å­2ã€3ï¼ˆ1-3ã€2-1ï¼‰
      // 3çº§ï¼šè§£é”æ ¼å­4ã€5ï¼ˆ2-2ã€2-3ï¼‰
      // 4çº§ï¼šè§£é”æ ¼å­6ã€7ã€8ï¼ˆ3-1ã€3-2ã€3-3ï¼‰
      const unlockRules = {
        1: [0, 1],
        2: [0, 1, 2, 3],
        3: [0, 1, 2, 3, 4, 5],
        4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
      };

      const level = farmlandData.level || 1;
      const unlockedCells = unlockRules[level] || unlockRules[1];
      const isUnlocked = unlockedCells.includes(index);

      // å¦‚æœæœªè§£é”ï¼Œæ·»åŠ é”å®šæ ·å¼å¹¶ç¦ç”¨äº¤äº’
      if (!isUnlocked) {
        farmlandCell.classList.add('locked');
        // æ·»åŠ é”çš„æ ‡è¯†
        const lockIcon = document.createElement('div');
        lockIcon.className = 'farmland-lock-icon';
        lockIcon.innerHTML = 'ğŸ”’';
        farmlandCell.appendChild(lockIcon);

        // æ·»åŠ è§£é”æ‰€éœ€ç­‰çº§æ–‡æœ¬
        const lockText = document.createElement('div');
        lockText.className = 'farmland-lock-text';
        // è®¡ç®—æ¯ä¸ªæ ¼å­æ‰€éœ€çš„è§£é”ç­‰çº§
        const requiredLevelMap = {
          0: 1, 1: 1,
          2: 2, 3: 2,
          4: 3, 5: 3,
          6: 4, 7: 4, 8: 4
        };
        const requiredLevel = requiredLevelMap[index];
        lockText.textContent = `${requiredLevel}çº§è§£é”`;
        farmlandCell.appendChild(lockText);

        // æœªè§£é”çš„æ ¼å­ç¦ç”¨æ‹–æ”¾å’Œæ‚¬åœäº‹ä»¶
        farmlandCell.style.pointerEvents = 'none';
        return farmlandCell;
      }
      
          // æ›´æ–°å†œç”°æ ¼å­æ˜¾ç¤º
        function updateCellDisplay() {
          // ä» gameData.farmlandData è¯»å–æœ€æ–°æ•°æ®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é—­åŒ…ä¸­çš„æ—§æ•°æ®
          const latestFarmlandData = gameData.farmlandData || farmlandData;
          const latestCellData = latestFarmlandData.cells[index];
          
          if (!latestCellData) {
            console.warn(`æ ¼å­ ${index} çš„æ•°æ®ä¸å­˜åœ¨`);
            return;
          }
          
          console.log(`æ›´æ–°æ ¼å­ ${index} æ˜¾ç¤ºï¼Œä½œç‰©: ${latestCellData.crop}, ç”Ÿé•¿é˜¶æ®µ: ${latestCellData.growthStage}`);
          
          // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
          farmlandCell.innerHTML = '';
          
          // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
          const statusDiv = document.createElement('div');
          statusDiv.className = 'farmland-cell-status';
          
          // æ·»åŠ æŒ‡ç¤ºå™¨
          const indicatorsDiv = document.createElement('div');
          indicatorsDiv.className = 'farmland-cell-indicators';
          
          // æ¹¿æ¶¦åº¦æŒ‡ç¤ºå™¨
          const moistureIndicator = document.createElement('div');
          moistureIndicator.className = 'farmland-cell-indicator';
          moistureIndicator.innerHTML = `ğŸ’§ ${latestCellData.moisture}`;
          
          // è‚¥æ²ƒåº¦æŒ‡ç¤ºå™¨
          const fertilityIndicator = document.createElement('div');
          fertilityIndicator.className = 'farmland-cell-indicator';
          fertilityIndicator.innerHTML = `ğŸŒ± ${latestCellData.fertility}`;
          
          indicatorsDiv.appendChild(moistureIndicator);
          indicatorsDiv.appendChild(fertilityIndicator);
          
          if (latestCellData.crop === null) {
            // ç©ºé—²çŠ¶æ€
            statusDiv.textContent = 'ç©ºé—²';
          } else {
            // æ˜¾ç¤ºä½œç‰©
            const cropImage = document.createElement('div');
            cropImage.className = 'crop-image';
            
            // è®¡ç®—ç”Ÿé•¿é˜¶æ®µ
            const currentDay = gameData.day || 1;
            const daysSincePlanted = latestCellData.plantedDay ? currentDay - latestCellData.plantedDay : 0;
            const seed = latestFarmlandData.seeds[latestCellData.crop];
            
            if (!seed) {
              console.error(`æ‰¾ä¸åˆ°ç§å­æ•°æ®: ${latestCellData.crop}`);
              statusDiv.textContent = 'é”™è¯¯';
            } else {
              // æ—©æœŸ(1-2å¤©): é˜¶æ®µ1, ä¸­æœŸ(3-4å¤©): é˜¶æ®µ2, æˆç†ŸæœŸ(5-6å¤©): é˜¶æ®µ3
              if (daysSincePlanted <= 2) {
                latestCellData.growthStage = 1;
                statusDiv.textContent = 'æ—©æœŸ';
                cropImage.style.backgroundImage = `url('${seed.stages[0]}')`;
              } else if (daysSincePlanted <= 4) {
                latestCellData.growthStage = 2;
                statusDiv.textContent = 'ä¸­æœŸ';
                cropImage.style.backgroundImage = `url('${seed.stages[1]}')`;
              } else if (daysSincePlanted >= 5) {
                latestCellData.growthStage = 3;
                statusDiv.textContent = 'æˆç†ŸæœŸ';
                cropImage.style.backgroundImage = `url('${seed.stages[2]}')`;
                
                // æ·»åŠ æˆç†Ÿæ ‡è®°
                const readyMark = document.createElement('div');
                readyMark.className = 'ready-to-harvest';
                readyMark.innerHTML = 'â­';
                farmlandCell.appendChild(readyMark);
                
                // ä¸ºæˆç†Ÿä½œç‰©æ·»åŠ æ‚¬åœæ•ˆæœ
                farmlandCell.classList.add('ready-for-harvest');
                farmlandCell.classList.add('harvest-cursor');
              }
              
              farmlandCell.appendChild(cropImage);
            }
          }
          
          farmlandCell.appendChild(statusDiv);
          farmlandCell.appendChild(indicatorsDiv);
        }
      
      // åˆå§‹åŒ–æ˜¾ç¤º
      updateCellDisplay();
      
      // æ·»åŠ æ‚¬åœäº‹ä»¶ - è®¾ç½®0.5ç§’å»¶è¿Ÿ
      let hoverTimeout;
      farmlandCell.addEventListener('mouseenter', function() {
        // æ£€æŸ¥æ˜¯å¦è§£é”
        const unlockRules = {
          1: [0, 1],
          2: [0, 1, 2, 3],
          3: [0, 1, 2, 3, 4, 5],
          4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
        };
        const level = farmlandData.level || 1;
        const unlockedCells = unlockRules[level] || unlockRules[1];
        if (!unlockedCells.includes(index)) return;

        // ç¡®ä¿æ²¡æœ‰æœªæ‰§è¡Œçš„æ‚¬åœå®šæ—¶å™¨
        if (hoverTimeout) {
          clearTimeout(hoverTimeout);
        }

        // è®¾ç½®æ–°çš„æ‚¬åœå®šæ—¶å™¨
        hoverTimeout = setTimeout(() => {
          // å†æ¬¡éªŒè¯é¼ æ ‡æ˜¯å¦è¿˜åœ¨å…ƒç´ ä¸Š
          if (farmlandCell.matches(':hover')) {
            showFarmlandTooltip(farmlandCell, cellData, index); // cellData å‚æ•°ä¼šè¢«å¿½ç•¥ï¼Œå‡½æ•°å†…éƒ¨ä½¿ç”¨æœ€æ–°æ•°æ®
          }
        }, 500); // 500æ¯«ç§’å»¶è¿Ÿ
      });
      
      farmlandCell.addEventListener('mouseleave', function() {
        // æ¸…é™¤å»¶è¿Ÿæ˜¾ç¤ºçš„å®šæ—¶å™¨
        if (hoverTimeout) {
          clearTimeout(hoverTimeout);
          hoverTimeout = null;
        }
        // ç«‹å³éšè—æç¤ºæ¡†
        hideFarmlandTooltip();
      });
      
      // æ‹–æ”¾äº‹ä»¶
      farmlandCell.addEventListener('dragover', function(e) {
        e.preventDefault();
        // æ£€æŸ¥æ˜¯å¦è§£é”
        const unlockRules = {
          1: [0, 1],
          2: [0, 1, 2, 3],
          3: [0, 1, 2, 3, 4, 5],
          4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
        };
        const level = farmlandData.level || 1;
        const unlockedCells = unlockRules[level] || unlockRules[1];
        if (!unlockedCells.includes(index)) return;

        // ä½¿ç”¨å…¨å±€å˜é‡è·å–æ‹–æ‹½çš„æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨æ‹–æ‹½ç‰¹æ•ˆçš„å…¨å±€å˜é‡
        const draggedItem = window.currentDraggingSeed || window.selectedSeed || window.selectedTool;
        console.log('dragoveräº‹ä»¶ - æ‹–æ‹½é¡¹ç›®:', draggedItem, 'currentDraggingSeed:', window.currentDraggingSeed, 'selectedSeed:', window.selectedSeed, 'selectedTool:', window.selectedTool);

        // æ£€æŸ¥æ‹–æ‹½çš„æ•°æ®æ˜¯å¦ä¸ºç§å­ã€æ°´æˆ–è‚¥æ–™
        if (draggedItem && (
            farmlandData.seeds[draggedItem] || // ç§å­
            draggedItem === 'water' ||
            draggedItem === 'fertilizer'
        )) {
          e.dataTransfer.dropEffect = 'move';

          // å¦‚æœæ˜¯ç©ºæ ¼å­ä¸”æ‹–æ‹½çš„æ˜¯ç§å­ï¼Œæ·»åŠ è„‰å†²å…‰æ™•æ•ˆæœ
          if (cellData.crop === null && farmlandData.seeds[draggedItem]) {
            farmlandCell.classList.add('highlight', 'pulse-glow');
          } else {
            farmlandCell.classList.add('highlight');
          }
        } else {
          e.dataTransfer.dropEffect = 'none';
        }
      });
      
      farmlandCell.addEventListener('dragleave', function() {
        farmlandCell.classList.remove('highlight', 'pulse-glow');
        // éšè—å¸é™„æŒ‡ç¤ºå™¨
        const snapIndicator = document.getElementById('snap-indicator');
        if (snapIndicator) {
          snapIndicator.style.display = 'none';
        }
      });

      farmlandCell.addEventListener('drop', function(e) {
        e.preventDefault();
        // æ£€æŸ¥æ˜¯å¦è§£é”
        const unlockRules = {
          1: [0, 1],
          2: [0, 1, 2, 3],
          3: [0, 1, 2, 3, 4, 5],
          4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
        };
        const level = farmlandData.level || 1;
        const unlockedCells = unlockRules[level] || unlockRules[1];
        if (!unlockedCells.includes(index)) return;

        farmlandCell.classList.remove('highlight', 'pulse-glow');
        // éšè—å¸é™„æŒ‡ç¤ºå™¨
        const snapIndicator = document.getElementById('snap-indicator');
        if (snapIndicator) {
          snapIndicator.style.display = 'none';
        }

        // ä½¿ç”¨å…¨å±€å˜é‡è·å–æ‹–æ‹½çš„æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨æ‹–æ‹½ç‰¹æ•ˆçš„å…¨å±€å˜é‡
        const draggedItem = window.currentDraggingSeed || window.selectedSeed || window.selectedTool;
        console.log('dropäº‹ä»¶ - æ‹–æ‹½é¡¹ç›®:', draggedItem, 'currentDraggingSeed:', window.currentDraggingSeed, 'selectedSeed:', window.selectedSeed, 'selectedTool:', window.selectedTool);
        console.log('æ¡ä»¶æ£€æŸ¥ - draggedItem:', draggedItem, 'farmlandData.seeds[draggedItem]:', farmlandData.seeds[draggedItem], 'cellData.crop:', cellData.crop);

        // å¤„ç†ç§å­ç§æ¤ï¼ˆç›´æ¥å®ç°ç§æ¤é€»è¾‘ï¼‰
        if (draggedItem && farmlandData.seeds[draggedItem] && cellData.crop === null) {
          console.log('è¿›å…¥ç§å­ç§æ¤é€»è¾‘');
          const seedAmount = gameData.resources[draggedItem]?.amount || 0;
          console.log('ç§å­æ•°é‡:', seedAmount);
          if (seedAmount > 0) {
            console.log('å¼€å§‹ç§æ¤æ“ä½œ');

            // ç›´æ¥æ‰§è¡Œç§æ¤é€»è¾‘
            // å‡å°‘ç§å­æ•°é‡
            gameData.resources[draggedItem].amount--;
            console.log('å‡å°‘ç§å­æ•°é‡å:', gameData.resources[draggedItem].amount);

            // è®¾ç½®ä½œç‰©æ•°æ®
            cellData.crop = draggedItem;
            cellData.growthStage = 0; // åˆå§‹ç”Ÿé•¿é˜¶æ®µ
            cellData.growthProgress = 0; // åˆå§‹ç”Ÿé•¿è¿›åº¦
            cellData.plantedDay = gameData.day || 1; // ç§æ¤æ—¥æœŸ

            // é‡ç½®å†œç”°çŠ¶æ€
            cellData.moisture = 0; // åˆå§‹æ¹¿åº¦è®¾ä¸º0
            cellData.fertility = 50; // åˆå§‹è‚¥åŠ›

            console.log(`åœ¨æ ¼å­${index}ç§æ¤äº†${draggedItem}`);
            console.log('window.triggerPlaceAnimation æ˜¯å¦å­˜åœ¨:', typeof window.triggerPlaceAnimation);

            // è§¦å‘åä¸½çš„æ”¾ç½®åŠ¨ç”»ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å¼¹è·³ã€é—ªå…‰ã€ç²’å­ç­‰ï¼‰
            if (window.triggerPlaceAnimation && typeof window.triggerPlaceAnimation === 'function') {
              console.log('æ­£åœ¨è°ƒç”¨ triggerPlaceAnimationï¼ˆæ‹–æ‹½ï¼‰...');
              window.triggerPlaceAnimation(farmlandCell, 'seed');
              console.log('triggerPlaceAnimation è°ƒç”¨å®Œæˆï¼ˆæ‹–æ‹½ï¼‰');
            }

            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
            setTimeout(() => {
              // ç«‹å³æ›´æ–°å½“å‰æ ¼å­çš„æ˜¾ç¤º
              updateCellDisplay();

              // æ›´æ–°å†œç”°çª—å£ä¸­çš„ç§å­å¡ç‰Œæ•°é‡
              const farmlandModal = farmlandCell.closest('.farmland-modal');
              if (farmlandModal && window.updateSeedCards) {
                window.updateSeedCards();
              }

              renderResources();
              updateGameData();

              // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
              showNotification('ç§æ¤æˆåŠŸ', `æˆåŠŸç§æ¤äº†${farmlandData.seeds[draggedItem].name.replace('ç§å­', '')}ï¼`);
            }, 300);

            // è®¾ç½®è¿ç»­æ’­ç§æ¨¡å¼ï¼Œç¡®ä¿æ‹–æ‹½ç‰¹æ•ˆç»§ç»­å·¥ä½œ
            window.continuousPlanting = true;
            console.log('è®¾ç½®è¿ç»­æ’­ç§æ¨¡å¼:', window.continuousPlanting);
          } else {
            showNotification('ç§å­ä¸è¶³', `ä½ æ²¡æœ‰${farmlandData.seeds[draggedItem].name}ï¼`);
          }
        }
        
        // å¤„ç†æµ‡æ°´ - æ”¯æŒæ°´ã€æ°´è¢‹å’Œæœ¨æ¡¶
        else if (draggedItem === 'water' || draggedItem === 'water_bag' || draggedItem === 'bucket') {
          let waterAmount = 0;
          let waterSource = '';
          let waterUnit = '';
          
          // æ ¹æ®ä¸åŒçš„æ°´æºç¡®å®šæ°´é‡å’Œå•ä½
          if (draggedItem === 'water') {
            waterAmount = gameData.resources.water?.amount || 0;
            waterSource = 'æ°´';
            waterUnit = 'å•ä½';
          } else if (draggedItem === 'water_bag') {
            // ä½¿ç”¨ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
            const result = useWaterFromContainer('water_bag', 20);
            if (!result.success) {
              showNotification('æ°´èµ„æºä¸è¶³', result.message);
              return;
            }
            waterAmount = result.usedAmount;
            waterSource = 'æ°´è¢‹';
            waterUnit = 'æ°´é‡';
            cellData.moisture = Math.min(100, cellData.moisture + (waterAmount * 5)); // 20æ°´å¢åŠ 100æ¹¿æ¶¦åº¦
          } else if (draggedItem === 'bucket') {
            // ä½¿ç”¨ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
            const result = useWaterFromContainer('bucket', 25);
            if (!result.success) {
              showNotification('æ°´èµ„æºä¸è¶³', result.message);
              return;
            }
            waterAmount = result.usedAmount;
            waterSource = 'æœ¨æ¡¶';
            waterUnit = 'æ°´é‡';
            cellData.moisture = Math.min(100, cellData.moisture + (waterAmount * 4)); // 25æ°´å¢åŠ 100æ¹¿æ¶¦åº¦
          }
          
          if (draggedItem === 'water_bag') {
            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
            farmlandCell.classList.add('water-animation');

            // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
            if (!window.createWaterEffect || !window.createWaterFloatingText) {
              if (typeof initializeAnimationCSS === 'function') {
                initializeAnimationCSS();
              }
              if (typeof initializeAnimationEffects === 'function') {
                initializeAnimationEffects();
              }
            }

            // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
            if (window.createWaterEffect) {
              window.createWaterEffect(farmlandCell);
            }
            if (window.createWaterFloatingText) {
              window.createWaterFloatingText(farmlandCell);
            }

            // å¤„ç†æ°´èµ„æºï¼ˆæ°´ï¼‰çš„ä½¿ç”¨
            if (draggedItem === 'water') {
              if (waterAmount <= 0) {
                showNotification('æ°´èµ„æºä¸è¶³', 'ä½ æ²¡æœ‰æ°´ï¼');
                return;
              }
              gameData.resources.water.amount -= 1;
              cellData.moisture = Math.min(100, cellData.moisture + 100);
            }

            // 1500msåç§»é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
              farmlandCell.classList.remove('water-animation');
            }, 1500);

            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
            setTimeout(() => {
              updateCellDisplay();

              // æ›´æ–°å·¦ä¾§æ å¡ç‰Œæ•°é‡æ˜¾ç¤º
              updateLeftPanelCards();

              // æ›´æ–°èµ„æºå¡å›¾ç‰‡ï¼Œç¡®ä¿æ­£ç¡®æ˜¾ç¤ºå½“å‰æ°´ä½
              if (draggedItem === 'water_bag' || draggedItem === 'bucket') {
                updateContainerImage(draggedItem);
                // æ›´æ–°å¯¹åº”å¡ç‰Œæ˜¾ç¤º
                updateResourceCard(draggedItem);
              }

              renderResources();
              updateGameData();
              showNotification('æµ‡æ°´æˆåŠŸ', `ä½¿ç”¨${waterSource}æµ‡æ°´æˆåŠŸï¼Œæ¹¿æ¶¦åº¦å¢åŠ äº†${draggedItem === 'water' ? 100 : waterAmount * (draggedItem === 'water_bag' ? 5 : 4)}ï¼`);
            }, 1500);
          } else {
            showNotification('æ°´èµ„æºä¸è¶³', `ä½ çš„${waterSource}å·²ç»æ²¡æœ‰${waterUnit}äº†ï¼`);
          }
        }
        // å¤„ç†æ–½è‚¥
        else if (draggedItem === 'fertilizer') {
          const fertilizerAmount = gameData.resources.fertilizer?.amount || 0;
          if (fertilizerAmount > 0) {
            // æ·»åŠ æ–½è‚¥åŠ¨ç”»æ•ˆæœ
            farmlandCell.classList.add('fertilizer-animation');
            
            gameData.resources.fertilizer.amount -= 1;
            cellData.fertility = Math.min(100, cellData.fertility + 25); // æ”¹ä¸ºå¢åŠ 25è‚¥æ²ƒåº¦
            
          // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
          setTimeout(() => {
            updateCellDisplay();
            
            // æ›´æ–°å·¦ä¾§æ å¡ç‰Œæ•°é‡æ˜¾ç¤º
            updateLeftPanelCards();
            
            renderResources();
            updateGameData();
            showNotification('æ–½è‚¥æˆåŠŸ', 'è‚¥æ²ƒåº¦å¢åŠ äº†25ï¼');
            
            // ç§»é™¤åŠ¨ç”»ç±»
            farmlandCell.classList.remove('fertilizer-animation');
          }, 300);
          } else {
            showNotification('è‚¥æ–™ä¸è¶³', 'ä½ æ²¡æœ‰è‚¥æ–™ï¼');
          }
        }
      });
      
      // ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨å·¥å…·æˆ–æ”¶è·
      farmlandCell.addEventListener('click', function() {
        if (window.selectedTool === 'bucket') {
          // ä½¿ç”¨æœ¨æ¡¶æµ‡æ°´
          const bucket = gameData.resources.bucket;
          let waterLevel = 0;
          if (bucket.instances && bucket.instances.length > 0) {
            waterLevel = bucket.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (bucket.waterLevel !== undefined) {
            waterLevel = bucket.waterLevel;
          }

          if (waterLevel >= 50) {
            // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿå‡å°‘æ°´ä½
            if (bucket.instances && bucket.instances.length > 0) {
              // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹
              for (let inst of bucket.instances) {
                if (inst.waterLevel && inst.waterLevel >= 50) {
                  inst.waterLevel -= 50;
                  inst.durability = Math.max(0, inst.durability - 1);
                  // å¦‚æœå®ä¾‹çš„æ°´ä½ä¸º0ï¼Œä»instancesä¸­ç§»é™¤
                  if (inst.waterLevel <= 0) {
                    bucket.instances = bucket.instances.filter(i => i !== inst);
                  }
                  break;
                }
              }
              // å¦‚æœinstancesä¸ºç©ºï¼Œåˆ é™¤instanceså±æ€§
              if (bucket.instances.length === 0) {
                delete bucket.instances;
                bucket.waterLevel = 0;
              }
            } else if (bucket.waterLevel !== undefined) {
              bucket.waterLevel -= 50;
              bucket.durability = Math.max(0, bucket.durability - 1);
            }

            cellData.moisture = Math.min(100, cellData.moisture + 50);

            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
            farmlandCell.classList.add('water-animation');

            // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
            if (!window.createWaterEffect || !window.createWaterFloatingText) {
              if (typeof initializeAnimationCSS === 'function') {
                initializeAnimationCSS();
              }
              if (typeof initializeAnimationEffects === 'function') {
                initializeAnimationEffects();
              }
            }

            // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
            if (window.createWaterEffect) {
              window.createWaterEffect(farmlandCell);
            }
            if (window.createWaterFloatingText) {
              window.createWaterFloatingText(farmlandCell);
            }

            // 1500msåç§»é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
              farmlandCell.classList.remove('water-animation');
            }, 1500);

            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
            setTimeout(() => {
              updateCellDisplay();
              updateFarmlandRelatedResources();
              updateGameData();
            }, 1500);

            // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
            updateContainerImage('water_bag');
            // æ›´æ–°æ°´è¢‹å¡ç‰Œæ˜¾ç¤º
            updateResourceCard('water_bag');

            showNotification('æµ‡æ°´æˆåŠŸ', 'æ¹¿æ¶¦åº¦å¢åŠ äº†50ï¼');
          } else {
            showNotification('æ°´é‡ä¸è¶³', 'æœ¨æ¡¶ä¸­çš„æ°´ä¸è¶³ä»¥æµ‡æ°´ï¼');
          }
        } else if (window.selectedTool === 'water_bag' || window.selectedTool === 'empty_water_bag') {
          // ä½¿ç”¨æ°´è¢‹æµ‡æ°´
          const waterBag = gameData.resources.water_bag;
          let waterLevel = 0;
          if (waterBag.instances && waterBag.instances.length > 0) {
            waterLevel = waterBag.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (waterBag.waterLevel !== undefined) {
            waterLevel = waterBag.waterLevel;
          }

          if (waterLevel >= 20) {
            // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿå‡å°‘æ°´ä½
            if (waterBag.instances && waterBag.instances.length > 0) {
              // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹
              for (let inst of waterBag.instances) {
                if (inst.waterLevel && inst.waterLevel >= 20) {
                  inst.waterLevel -= 20;
                  inst.durability = Math.max(0, inst.durability - 1);
                  // å¦‚æœå®ä¾‹çš„æ°´ä½ä¸º0ï¼Œä»instancesä¸­ç§»é™¤
                  if (inst.waterLevel <= 0) {
                    waterBag.instances = waterBag.instances.filter(i => i !== inst);
                  }
                  break;
                }
              }
              // å¦‚æœinstancesä¸ºç©ºï¼Œåˆ é™¤instanceså±æ€§
              if (waterBag.instances.length === 0) {
                delete waterBag.instances;
                waterBag.waterLevel = 0;
              }
            } else if (waterBag.waterLevel !== undefined) {
              waterBag.waterLevel -= 20;
              waterBag.durability = Math.max(0, waterBag.durability - 1);
            }
            
            cellData.moisture = Math.min(100, cellData.moisture + 50);

            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
            farmlandCell.classList.add('water-animation');

            // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
            if (!window.createWaterEffect || !window.createWaterFloatingText) {
              if (typeof initializeAnimationCSS === 'function') {
                initializeAnimationCSS();
              }
              if (typeof initializeAnimationEffects === 'function') {
                initializeAnimationEffects();
              }
            }

            // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
            if (window.createWaterEffect) {
              window.createWaterEffect(farmlandCell);
            }
            if (window.createWaterFloatingText) {
              window.createWaterFloatingText(farmlandCell);
            }

            // 1500msåç§»é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
              farmlandCell.classList.remove('water-animation');
            }, 1500);

            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
            setTimeout(() => {
              updateCellDisplay();
              updateFarmlandRelatedResources();
              updateGameData();
            }, 1500);

            // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
            updateContainerImage('water_bag');
            // æ›´æ–°æ°´è¢‹å¡ç‰Œæ˜¾ç¤º
            updateResourceCard('water_bag');

            showNotification('æµ‡æ°´æˆåŠŸ', 'æ¹¿æ¶¦åº¦å¢åŠ äº†50ï¼');
          } else {
            showNotification('æ°´é‡ä¸è¶³', 'æ°´è¢‹ä¸­çš„æ°´ä¸è¶³ä»¥æµ‡æ°´ï¼');
          }
        } else if (window.selectedTool === 'fertilizer') {
          // æ–½è‚¥
          const fertilizerAmount = gameData.resources.fertilizer?.amount || 0;
          if (fertilizerAmount > 0) {
            gameData.resources.fertilizer.amount -= 1;
            cellData.fertility = Math.min(100, cellData.fertility + 25);
            updateCellDisplay();
            renderResources();
            updateGameData();
            showNotification('æ–½è‚¥æˆåŠŸ', 'è‚¥æ²ƒåº¦å¢åŠ äº†25ï¼');
          } else {
            showNotification('è‚¥æ–™ä¸è¶³', 'ä½ æ²¡æœ‰è‚¥æ–™ï¼');
          }
        } else if (cellData.crop !== null && cellData.growthStage === 3) {
          // æ”¶è·ä½œç‰©
          const seed = farmlandData.seeds[cellData.crop];
          const rewardAmount = seed.rewardCount[2]; // æˆç†ŸæœŸæ”¶è·æ•°é‡
          
          // æ·»åŠ æ”¶è·ç‰©åˆ°èµ„æº
          if (!gameData.resources[seed.reward]) {
            gameData.resources[seed.reward] = { 
              name: getResourceName(seed.reward), 
              amount: 0, 
              image: `UI/${getResourceName(seed.reward)}.jpg`,
              category: 'å†œä½œç‰©'
            };
          }
          
          gameData.resources[seed.reward].amount += rewardAmount;
          
          // å¦‚æœæ˜¯å°éº¦æˆ–æ°´ç¨»ï¼Œé¢å¤–äº§å‡º2å¼ è‰æ–™å¡ç‰Œ
          if (cellData.crop === 'wheat_seed' || cellData.crop === 'rice_seed') {
            if (!gameData.resources['grass_feed']) {
              gameData.resources['grass_feed'] = { 
                name: 'è‰æ–™', 
                amount: 0, 
                image: 'UI/è‰æ–™.jpg',
                category: 'material'
              };
            }
            gameData.resources['grass_feed'].amount += 2;
            showNotification('é¢å¤–æ”¶è·', `æ”¶è·äº†2å¼ è‰æ–™å¡ç‰Œï¼`);
          }
          
          // å¦‚æœæ”¶è·çš„æ˜¯ç§å­ï¼Œæ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
          // æ£€æŸ¥æ”¶è·çš„ç‰©å“æ˜¯å¦æ˜¯ç§å­èµ„æºä¹‹ä¸€
          if (window.updateSeedCards && Object.keys(farmlandData.seeds).includes(seed.reward)) {
            window.updateSeedCards();
          }
          
          // é‡ç½®å†œç”°æ ¼å­ï¼Œä½†ä¿ç•™è‚¥æ²ƒåº¦å˜åŒ–
          cellData.crop = null;
          cellData.growthStage = 0;
          cellData.plantedDay = null;
          cellData.moisture = 0;
          // æ”¶è·åè‚¥æ²ƒåº¦å‡å°‘50ï¼Œä½†ä¸èƒ½ä½äº0
          cellData.fertility = Math.max(0, cellData.fertility - 50);
          
          // æ·»åŠ æ”¶è·åŠ¨ç”»
          const harvestAnimation = document.createElement('div');
          harvestAnimation.className = 'harvest-animation';
          harvestAnimation.textContent = `+${rewardAmount} ${getResourceName(seed.reward)}`;
          farmlandCell.appendChild(harvestAnimation);
          
          // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œè®©ä½œç‰©å¿«é€Ÿæ¶ˆå¤±
          updateCellDisplay();
          renderResources();
          updateGameData();
          showNotification('æ”¶è·æˆåŠŸ', `æ”¶è·äº†${rewardAmount}ä¸ª${getResourceName(seed.reward)}ï¼`);
          
          // çŸ­æš‚å»¶è¿Ÿåç§»é™¤åŠ¨ç”»æ•ˆæœ
          setTimeout(() => {
            // ç§»é™¤åŠ¨ç”»
            if (harvestAnimation.parentNode) {
              harvestAnimation.parentNode.removeChild(harvestAnimation);
            }
          }, 300); // ç¼©çŸ­åŠ¨ç”»æ—¶é—´åˆ°300ms
        }
      });
      
      return farmlandCell;
    }
    
    // æ˜¾ç¤ºå†œç”°æ¨¡æ€æ¡†
    function showFarmlandModal() {
      console.log('æ˜¾ç¤ºå†œç”°æ¨¡æ€æ¡†è¢«è°ƒç”¨');

      // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å’ŒCSSæ ·å¼è¢«æ­£ç¡®åˆå§‹åŒ–
      if (typeof initializeAnimationCSS === 'function') {
        initializeAnimationCSS();
        console.log('å†œç”°çª—å£ï¼šåŠ¨ç”»CSSæ ·å¼åˆå§‹åŒ–å®Œæˆ');
      }
      if (typeof initializeAnimationEffects === 'function') {
        initializeAnimationEffects();
        console.log('å†œç”°çª—å£ï¼šåŠ¨ç”»ç‰¹æ•ˆå‡½æ•°åˆå§‹åŒ–å®Œæˆ');
      }

      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'farmland-modal';
      modalContainer.id = 'farmlandModal';
      
      // åˆ›å»ºå¼¹çª—å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
      const modalContent = document.createElement('div');
      modalContent.className = 'farmland-modal-content ink-border';
      
      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'farmland-modal-header';
      
      // åˆ›å»ºæ ‡é¢˜ï¼Œä½¿ç”¨ink-textæ ·å¼
      const title = document.createElement('h2');
      title.className = 'farmland-modal-title ink-text';
      title.textContent = 'å†œç”°ç®¡ç†';
      modalHeader.appendChild(title);
      
      // åˆ›å»ºå…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.className = 'farmland-modal-close';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = function() {
        // æ¸…é™¤ç§å­å…‰æ ‡
        clearSeedCursor();
        // æ¸…é™¤é€‰æ‹©çŠ¶æ€
        window.selectedSeed = null;
        window.selectedTool = null;

        modalContainer.classList.remove('active');
        setTimeout(() => {
          // ä¿å­˜å†œç”°æ•°æ®
          gameData.farmlandData = farmlandData;
          updateGameData();

          // æ¸…ç†å…¨å±€å˜é‡
          window.farmlandOtherResourcesContainer = null;
          window.updateSeedCards = null;
          window.updateFarmlandRelatedResources = null;

          modalContainer.remove();
        }, 300);
      };
      modalHeader.appendChild(closeButton);
      
      modalContent.appendChild(modalHeader);
      
      // åˆ›å»ºä¸»ä½“åŒºåŸŸï¼Œåˆ†ä¸ºå·¦å³ä¸¤æ 
      const modalBody = document.createElement('div');
      modalBody.className = 'farmland-modal-body';
      modalBody.style.display = 'flex';
      modalBody.style.gap = '20px';
      
      // å·¦ä¾§ï¼šèƒŒåŒ…åŒºåŸŸï¼ˆç§å­å¡ç‰Œï¼‰- ä½¿ç”¨ä¸åˆ¶ä½œçª—å£ç›¸åŒçš„æ ·å¼
      const leftPanel = document.createElement('div');
      leftPanel.className = 'crafting-left';
      leftPanel.style.padding = '1rem';
      
      const seedTitle = document.createElement('h3');
      seedTitle.className = 'crafting-section-title';
      seedTitle.textContent = 'ç§å­èƒŒåŒ…';
      leftPanel.appendChild(seedTitle);
      
      const seedContainer = document.createElement('div');
      seedContainer.className = 'crafting-inventory';
      seedContainer.style.display = 'flex';
      seedContainer.style.flexWrap = 'wrap';
      seedContainer.style.gap = '0.5rem';
      seedContainer.style.padding = '0.5rem';
      seedContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
      seedContainer.style.borderRadius = '0.5rem';
      seedContainer.style.maxHeight = '200px';
      seedContainer.style.overflowY = 'auto';
      
      // æ·»åŠ ç§å­å¡ç‰Œï¼ˆåªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„å¡ç‰Œï¼‰
      Object.keys(farmlandData.seeds).forEach(seedKey => {
        const seedAmount = gameData.resources[seedKey]?.amount || 0;
        const seed = farmlandData.seeds[seedKey];
        const seedCard = createSeedCard(seedKey, seed);
        
        // å¦‚æœæ•°é‡ä¸º0ï¼Œå½»åº•éšè—å¡ç‰Œ
        if (seedAmount <= 0) {
          seedCard.style.display = 'none';
          seedCard.style.visibility = 'hidden';
          seedCard.style.opacity = '0';
          seedCard.style.pointerEvents = 'none';
          seedCard.style.position = 'absolute';
          seedCard.style.left = '-9999px';
        } else {
          seedCard.style.display = '';
          seedCard.style.visibility = 'visible';
          seedCard.style.opacity = '1';
          seedCard.style.pointerEvents = 'auto';
          seedCard.style.position = '';
          seedCard.style.left = '';
        }
        
        seedContainer.appendChild(seedCard);
      });
      
      // æ·»åŠ ç§å­æ›´æ–°å‡½æ•°ï¼Œç”¨äºå®æ—¶æ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤ºçŠ¶æ€
      window.updateSeedCards = function() {
        console.log('å¼€å§‹æ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤ºçŠ¶æ€');
        
        // è·å–å†œç”°çª—å£ä¸­çš„ç§å­å®¹å™¨
        const farmlandModal = document.getElementById('farmlandModal');
        if (!farmlandModal) {
          console.warn('å†œç”°çª—å£æœªæ‰¾åˆ°ï¼Œæ— æ³•æ›´æ–°ç§å­å¡ç‰Œ');
          return;
        }
        
        const seedContainer = farmlandModal.querySelector('.crafting-inventory');
        if (!seedContainer) {
          console.warn('ç§å­å®¹å™¨æœªæ‰¾åˆ°ï¼Œæ— æ³•æ›´æ–°ç§å­å¡ç‰Œ');
          return;
        }
        
        // è·å–å½“å‰æ‰€æœ‰ç§å­å¡ç‰Œ
        const seedCards = seedContainer.querySelectorAll('.crafting-inventory-card');
        console.log('å½“å‰ç§å­å¡ç‰Œæ•°é‡:', seedCards.length);
        
        // éå†æ‰€æœ‰ç§å­ç±»å‹ï¼Œç¡®ä¿æ˜¾ç¤ºçŠ¶æ€æ­£ç¡®
        Object.keys(farmlandData.seeds).forEach(seedKey => {
          const seedAmount = gameData.resources[seedKey]?.amount || 0;
          const existingCard = seedContainer.querySelector(`[data-seed-type="${seedKey}"]`);
          
          console.log(`ç§å­ ${seedKey}: æ•°é‡=${seedAmount}, å·²æœ‰å¡ç‰Œ=${!!existingCard}`);
          
          if (seedAmount <= 0) {
            // æ•°é‡ä¸º0ï¼Œå½»åº•ç§»é™¤å¡ç‰Œ
            if (existingCard) {
              console.log(`ç§»é™¤ç§å­å¡ç‰Œ: ${seedKey}`);
              existingCard.remove();
            }
          } else {
            // æ•°é‡å¤§äº0
            if (existingCard) {
              // æ›´æ–°ç°æœ‰å¡ç‰Œçš„æ•°é‡æ˜¾ç¤º
              const seedNameElement = existingCard.querySelector('.crafting-card-title');
              if (seedNameElement) {
                const seed = farmlandData.seeds[seedKey];
                seedNameElement.textContent = `${seed.name} Ã— ${seedAmount}`;
              }
              
              // ç¡®ä¿å¡ç‰Œå¯è§
              existingCard.style.display = '';
              existingCard.style.visibility = 'visible';
              existingCard.style.opacity = '1';
              existingCard.style.pointerEvents = 'auto';
              existingCard.style.position = '';
              existingCard.style.left = '';
            } else {
              // åˆ›å»ºæ–°çš„å¡ç‰Œ
              console.log(`åˆ›å»ºæ–°ç§å­å¡ç‰Œ: ${seedKey}`);
              const seed = farmlandData.seeds[seedKey];
              const seedCard = createSeedCard(seedKey, seed);
              seedContainer.appendChild(seedCard);
              
              // ç§å­å¡ç‰Œåœ¨createSeedCardå‡½æ•°ä¸­å·²ç»åŒ…å«äº†å®Œæ•´çš„æ‹–æ‹½ç‰¹æ•ˆå®ç°ï¼Œæ— éœ€å†æ¬¡åˆå§‹åŒ–
            }
          }
        });
        
        console.log('ç§å­å¡ç‰Œæ›´æ–°å®Œæˆ');
      };
      
      // æ·»åŠ ç›¸å…³èµ„æºå¡ç‰Œæ›´æ–°å‡½æ•°ï¼Œç”¨äºå®æ—¶æ›´æ–°ç›¸å…³èµ„æºå¡ç‰Œæ˜¾ç¤ºçŠ¶æ€
      window.updateFarmlandRelatedResources = function() {
        console.log('å¼€å§‹æ›´æ–°å†œç”°çª—å£ç›¸å…³èµ„æºå¡ç‰Œæ˜¾ç¤ºçŠ¶æ€');

        // ä½¿ç”¨å…¨å±€å˜é‡è®¿é—®ç›¸å…³èµ„æºå®¹å™¨
        const otherResourcesContainer = window.farmlandOtherResourcesContainer;
        if (!otherResourcesContainer) {
          console.warn('å†œç”°çª—å£ç›¸å…³èµ„æºå®¹å™¨æœªæ‰¾åˆ°');
          return;
        }

        // å®šä¹‰éœ€è¦æ˜¾ç¤ºçš„ç›¸å…³èµ„æºï¼ˆæ’é™¤empty_bucketï¼Œå®ƒåªæ˜¯bucketçš„å¼•ç”¨ï¼‰
        const relatedResources = ['bucket', 'water_bag', 'empty_water_bag', 'fertilizer'];

        // æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºç›¸å…³èµ„æºå¡ç‰Œ
        otherResourcesContainer.innerHTML = '';

        relatedResources.forEach(resourceKey => {
          const resource = gameData.resources[resourceKey];
          if (resource && resource.amount > 0) {
            // ä½¿ç”¨å†œç”°çª—å£ä¸“ç”¨çš„èµ„æºå¡ç‰Œåˆ›å»ºå‡½æ•°ï¼ˆç¦ç”¨ä¼ ç»Ÿæ‹–æ‹½ï¼Œä½¿ç”¨è‡ªå®šä¹‰å…‰æ ‡ï¼‰
            const resourceCard = createFarmlandResourceCard(resourceKey, resource);
            otherResourcesContainer.appendChild(resourceCard);
          }
        });

        console.log('ç›¸å…³èµ„æºå¡ç‰Œæ›´æ–°å®Œæˆ');
      };
      
      leftPanel.appendChild(seedContainer);

      // ä¸ºç§å­å®¹å™¨æ·»åŠ æ»šåŠ¨æ¡
      const seedScrollbar = document.createElement('div');
      seedScrollbar.className = 'resource-scrollbar';
      seedScrollbar.innerHTML = '<div class="resource-scrollbar-thumb"></div>';
      leftPanel.appendChild(seedScrollbar);

      // æ·»åŠ ç§æ¤ç”¨å“å¡ç‰Œ
      const otherResourcesTitle = document.createElement('h3');
      otherResourcesTitle.className = 'crafting-section-title';
      otherResourcesTitle.textContent = 'ç§æ¤ç”¨å“';
      otherResourcesTitle.style.marginTop = '20px';
      leftPanel.appendChild(otherResourcesTitle);

      const otherResourcesContainer = document.createElement('div');
      otherResourcesContainer.className = 'crafting-inventory farmland-related-resources';
      otherResourcesContainer.style.display = 'flex';
      otherResourcesContainer.style.flexWrap = 'wrap';
      otherResourcesContainer.style.gap = '0.5rem';
      otherResourcesContainer.style.padding = '0.5rem';
      otherResourcesContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
      otherResourcesContainer.style.borderRadius = '0.5rem';
      otherResourcesContainer.style.maxHeight = '200px';
      otherResourcesContainer.style.overflowY = 'auto';
      
      // å®šä¹‰éœ€è¦æ˜¾ç¤ºçš„ç›¸å…³èµ„æºï¼ˆæ’é™¤empty_bucketï¼Œå®ƒåªæ˜¯bucketçš„å¼•ç”¨ï¼‰
      const relatedResources = ['bucket', 'water_bag', 'water_bag_full', 'empty_water_bag', 'fertilizer'];
      
      relatedResources.forEach(resourceKey => {
        const resource = gameData.resources[resourceKey];
        if (resource && resource.amount > 0) {
          // ä½¿ç”¨å†œç”°çª—å£ä¸“ç”¨çš„èµ„æºå¡ç‰Œåˆ›å»ºå‡½æ•°ï¼ˆç¦ç”¨ä¼ ç»Ÿæ‹–æ‹½ï¼Œä½¿ç”¨è‡ªå®šä¹‰å…‰æ ‡ï¼‰
          const resourceCard = createFarmlandResourceCard(resourceKey, resource);
          otherResourcesContainer.appendChild(resourceCard);
        }
      });

      leftPanel.appendChild(otherResourcesContainer);
      
      // ä¸ºç§æ¤ç”¨å“å®¹å™¨æ·»åŠ æ»šåŠ¨æ¡
      const farmlandScrollbar = document.createElement('div');
      farmlandScrollbar.className = 'resource-scrollbar';
      farmlandScrollbar.innerHTML = '<div class="resource-scrollbar-thumb"></div>';
      leftPanel.appendChild(farmlandScrollbar);

      // å°†å®¹å™¨ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿åç»­æ›´æ–°
      window.farmlandOtherResourcesContainer = otherResourcesContainer;
      
      // å³ä¾§ï¼šå†œç”°åŒºåŸŸï¼ˆä¹å®«æ ¼ï¼‰
      const rightPanel = document.createElement('div');
      rightPanel.className = 'farmland-grid-panel';
      rightPanel.style.width = '70%';

      // æ ‡é¢˜å’Œå‡çº§æŒ‰é’®å®¹å™¨
      const titleContainer = document.createElement('div');
      titleContainer.style.display = 'flex';
      titleContainer.style.justifyContent = 'space-between';
      titleContainer.style.alignItems = 'center';
      titleContainer.style.marginBottom = '15px';

      const farmlandTitle = document.createElement('h3');
      farmlandTitle.className = 'farmland-panel-title ink-text';
      farmlandTitle.textContent = 'å†œç”°åŒºåŸŸ';
      farmlandTitle.style.margin = '0';
      titleContainer.appendChild(farmlandTitle);

      // å‡çº§æŒ‰é’® - ä½¿ç”¨å¤é£æ ·å¼
      const upgradeButton = document.createElement('button');
      upgradeButton.className = 'ink-button ink-button-small';
      upgradeButton.id = 'farmland-upgrade-btn';
      upgradeButton.innerHTML = `<span id="farmland-level-text">${farmlandData.level}çº§</span><span class="upgrade-icon">â¬†ï¸</span> å‡çº§`;
      upgradeButton.title = 'å‡çº§å†œç”°è§£é”æ›´å¤šæ ¼å­';
      upgradeButton.onclick = () => showFarmlandUpgradeModal();
      titleContainer.appendChild(upgradeButton);

      rightPanel.appendChild(titleContainer);
      
      const gridContainer = document.createElement('div');
      gridContainer.className = 'farmland-grid';
      gridContainer.style.display = 'grid';
      gridContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
      gridContainer.style.gap = '15px';
      
      // åˆ›å»º9ä¸ªå†œç”°æ ¼å­
      for (let i = 0; i < 9; i++) {
        const farmlandCell = createFarmlandCell(i, farmlandData.cells[i]);
        gridContainer.appendChild(farmlandCell);
      }
      
      rightPanel.appendChild(gridContainer);
      
      modalBody.appendChild(leftPanel);
      modalBody.appendChild(rightPanel);
      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      
      // åˆå§‹åŒ–å…¨å±€å˜é‡
      window.selectedTool = null;
      window.selectedSeed = null;
      window.lastMouseX = window.innerWidth / 2;
      window.lastMouseY = window.innerHeight / 2;

      // ç›‘å¬é¼ æ ‡ä½ç½®ï¼ˆç”¨äºè‡ªå®šä¹‰å…‰æ ‡ï¼‰
      document.addEventListener('mousemove', function(e) {
        window.lastMouseX = e.clientX;
        window.lastMouseY = e.clientY;
      });
      
      // æ·»åŠ åˆ°æ–‡æ¡£
      document.body.appendChild(modalContainer);

      // åˆå§‹åŒ–ç‰²å£æ æ˜¾ç¤ºçŠ¶æ€
      // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²ç»å®Œå…¨æ„å»º
      setTimeout(() => {
        if (window.updateLivestockInventory) {
          window.updateLivestockInventory();
        }
        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        if (window.initializeLivestockScrollbars) {
          window.initializeLivestockScrollbars();
        }
      }, 10);
      
      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .farmland-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }
        
        .farmland-modal.active {
          opacity: 1;
          visibility: visible;
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
        }
        
        .farmland-modal-content {
          background-color: #FFFDF7;
          border-radius: 0.25rem;
          width: 90%;
          max-width: 900px;
          padding: 1.5rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          transform: translateY(-20px);
          transition: all 0.3s ease;
        }
        
        .farmland-modal.active .farmland-modal-content {
          transform: translateY(0);
        }
        
        /* ç§å­å·¥å…·æç¤ºæ ·å¼ */
        .seed-tooltip {
          background-color: #2D3748;
          color: white;
          padding: 0.75rem;
          border-radius: 0.5rem;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
          font-size: 0.875rem;
          max-width: 200px;
          z-index: 2000;
        }
        
        .tooltip-title {
          font-weight: bold;
          margin-bottom: 0.5rem;
          color: #F7FAFC;
        }
        
        .tooltip-info {
          margin-bottom: 0.25rem;
          color: #E2E8F0;
        }
        
        .tooltip-info:last-child {
          margin-bottom: 0;
        }
        
        .farmland-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          border-bottom: 1px solid #E2E8F0;
          padding-bottom: 0.5rem;
        }
        
        .farmland-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .farmland-modal-close {
          background: none;
          border: none;
          font-size: 1.25rem;
          cursor: pointer;
          color: #4A5568;
          padding: 5px;
        }
        
        .farmland-panel-title {
          font-size: 1.2rem;
          font-weight: normal;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        /* ç§å­å¡ç‰Œæ ·å¼ */
        .seed-card {
          background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
          border: 2px solid #8D6E63;
          border-radius: 8px;
          padding: 10px;
          display: flex;
          flex-direction: column;
          align-items: center;
          cursor: grab;
          transition: all 0.3s ease;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          position: relative;
        }
        
        .seed-card:hover {
          transform: scale(1.05) rotate(2deg);
          box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .seed-card.dragging {
          opacity: 0.7;
          cursor: grabbing;
        }
        
        .seed-card-image {
          width: 40px;
          height: 40px;
          background-size: contain;
          background-position: center;
          background-repeat: no-repeat;
          margin-bottom: 5px;
        }
        
        .seed-card-name {
          font-size: 0.9rem;
          color: #5D4037;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
          margin-bottom: 3px;
        }
        
        .seed-card-info {
          font-size: 0.7rem;
          color: #7D6E63;
          text-align: center;
          width: 100%;
        }
        
        .seed-card-count {
          position: absolute;
          top: 5px;
          right: 5px;
          background-color: #8D6E63;
          color: white;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 12px;
          font-weight: bold;
        }

        /* å†œç”°æ ¼å­æ ·å¼ */
        .farmland-cell {
          width: 120px;
          height: 120px;
          background-color: #8D6E63;
          border-radius: 8px;
          position: relative;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          border: 3px solid #6D4C41;
          overflow: hidden;
        }
        
        .farmland-cell::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: url('UI/å†œç”°.jpg');
          background-size: cover;
          background-position: center;
          border-radius: 5px;
          z-index: 1;
        }
        
        .farmland-cell:hover {
          transform: scale(1.05);
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* æ³¨æ„ï¼š.farmland-cell.highlight å’Œ .farmland-cell.pulse-glow æ ·å¼å·²ç§»è‡³å…¨å±€CSS */

        /* æœªè§£é”å†œç”°æ ¼å­æ ·å¼ */
        .farmland-cell-locked,
        .farmland-cell.locked {
          background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%) !important;
          opacity: 0.6;
          position: relative;
          cursor: not-allowed;
          pointer-events: none;
          filter: grayscale(80%);
        }

        .farmland-cell-locked::before,
        .farmland-cell.locked::before {
          display: none;
        }

        .farmland-cell.locked:hover {
          transform: none;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .farmland-lock-icon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 2.5rem;
          opacity: 0.8;
          z-index: 10;
          pointer-events: none;
        }

        .farmland-lock-text {
          position: absolute;
          bottom: 10px;
          left: 50%;
          transform: translateX(-50%);
          color: white;
          font-size: 0.8rem;
          white-space: nowrap;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
          z-index: 10;
          pointer-events: none;
        }
        
        /* æ³¨æ„ï¼š@keyframes pulse-glow åŠ¨ç”»å·²ç§»è‡³å…¨å±€CSS */
        
        /* ç§æ¤æˆåŠŸåçš„åŠ¨ç”» */
        .farmland-cell.plant-animation {
          animation: plant-effect 0.6s ease-out;
        }

        @keyframes plant-effect {
          0% {
            transform: scale(1);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
          }
          50% {
            transform: scale(1.15);
            box-shadow: 0 0 30px rgba(76, 175, 80, 1), 0 0 60px rgba(76, 175, 80, 0.5);
          }
          100% {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
          }
        }

        /* æ°´æ»´ç²’å­ç‰¹æ•ˆ */
        .water-particle {
          position: fixed;
          pointer-events: none;
          border-radius: 50%;
          background: radial-gradient(circle, rgba(59, 130, 246, 0.9) 0%, rgba(147, 197, 253, 0.6) 50%, transparent 100%);
          z-index: 9998;
          animation: water-particle-fall 0.8s ease-out forwards;
        }

        @keyframes water-particle-fall {
          0% {
            opacity: 1;
            transform: scale(0.5) translateY(0) rotate(0deg);
          }
          50% {
            opacity: 0.8;
            transform: scale(1) translateY(var(--fall-distance)) rotate(180deg);
          }
          100% {
            opacity: 0;
            transform: scale(0.3) translateY(calc(var(--fall-distance) * 2)) rotate(360deg);
          }
        }

        /* æ°´æ»´é£æº…ç‰¹æ•ˆ */
        .water-splash {
          position: fixed;
          pointer-events: none;
          border-radius: 50%;
          background: radial-gradient(circle, rgba(59, 130, 246, 0.8) 0%, rgba(147, 197, 253, 0.4) 50%, transparent 100%);
          z-index: 9998;
          animation: water-splash-expand 0.6s ease-out forwards;
        }

        @keyframes water-splash-expand {
          0% {
            opacity: 1;
            transform: scale(0);
          }
          50% {
            opacity: 0.7;
            transform: scale(2.5);
          }
          100% {
            opacity: 0;
            transform: scale(4);
          }
        }

        /* é£Ÿç‰©ç²’å­ç‰¹æ•ˆ */
        .food-particle {
          position: fixed;
          pointer-events: none;
          border-radius: 30%;
          background: radial-gradient(circle, rgba(237, 137, 54, 0.9) 0%, rgba(251, 191, 36, 0.6) 50%, transparent 100%);
          z-index: 9998;
          animation: food-particle-bounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes food-particle-bounce {
          0% {
            opacity: 1;
            transform: scale(0.3) translateY(0) rotate(0deg);
          }
          30% {
            opacity: 0.9;
            transform: scale(1.2) translateY(var(--bounce-height)) rotate(120deg);
          }
          60% {
            opacity: 0.7;
            transform: scale(0.9) translateY(var(--bounce-height-half)) rotate(240deg);
          }
          100% {
            opacity: 0;
            transform: scale(0.2) translateY(var(--fall-distance)) rotate(360deg);
          }
        }

        /* è°·ç²’ç‰¹æ•ˆ - ç”¨äºå–‚é£ŸåŠ¨ç”» */
        .food-grain {
          position: fixed;
          pointer-events: none;
          border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
          background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
          z-index: 9998;
          animation: food-grain-spin 1s ease-out forwards;
        }

        /* é£Ÿç‰©æ˜Ÿå½¢ç‰¹æ•ˆ */
        .food-star {
          position: fixed;
          pointer-events: none;
          width: 20px;
          height: 20px;
          background: radial-gradient(circle, rgba(255, 193, 7, 0.9) 0%, rgba(237, 137, 54, 0.6) 50%, transparent 100%);
          clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
          z-index: 9998;
          animation: food-star-spin 0.8s ease-out forwards;
        }

        @keyframes food-star-spin {
          0% {
            opacity: 1;
            transform: scale(0) translateY(0) rotate(0deg);
          }
          50% {
            opacity: 0.9;
            transform: scale(1.5) translateY(var(--star-distance)) rotate(180deg);
          }
          100% {
            opacity: 0;
            transform: scale(0) translateY(calc(var(--star-distance) * 2)) rotate(360deg);
          }
        }

        /* æ°´æ³¢çº¹æ‰©å±•åŠ¨ç”» */
        @keyframes water-ripple-expand {
          0% {
            opacity: 1;
            transform: scale(0.2);
            border-width: 3px;
          }
          100% {
            opacity: 0;
            transform: scale(2.5);
            border-width: 1px;
          }
        }

        /* æ°´é›¾æ¼‚æµ®åŠ¨ç”» */
        @keyframes water-mist-float {
          0% {
            opacity: 0.8;
            transform: scale(0.5) translateY(0);
          }
          50% {
            opacity: 0.5;
            transform: scale(1.2) translateY(-20px);
          }
          100% {
            opacity: 0;
            transform: scale(0.8) translateY(-40px);
          }
        }

        /* æ°´èŠ±é£æº…åŠ¨ç”» */
        @keyframes water-droplet-splash {
          0% {
            opacity: 1;
            transform: scale(1) translate(0, 0);
          }
          50% {
            opacity: 0.7;
            transform: scale(1.3) translate(var(--splash-x), var(--splash-y));
          }
          100% {
            opacity: 0;
            transform: scale(0.3) translate(calc(var(--splash-x) * 1.5), calc(var(--splash-y) * 1.5));
          }
        }

        /* æ°´æ»´ç²’å­ç‰¹æ•ˆ - ç”¨äºå–‚æ°´åŠ¨ç”» */
        .water-droplet {
          position: fixed;
          pointer-events: none;
          border-radius: 50%;
          background: radial-gradient(circle, rgba(59, 130, 246, 0.9) 0%, transparent 70%);
          z-index: 9998;
          animation: water-droplet-splash 0.8s ease-out forwards;
        }

        /* æ°´é›¾ç‰¹æ•ˆ - ç”¨äºå–‚æ°´åŠ¨ç”» */
        .water-mist {
          position: fixed;
          pointer-events: none;
          border-radius: 50%;
          background: radial-gradient(circle, rgba(147, 197, 253, 0.4) 0%, transparent 70%);
          z-index: 9997;
          animation: water-mist-float 1.2s ease-out forwards;
        }

        /* è°·ç²’æ—‹è½¬ç‰¹æ•ˆ */
        @keyframes food-grain-spin {
          0% {
            opacity: 1;
            transform: scale(0) rotate(0deg) translateY(0);
          }
          30% {
            opacity: 0.9;
            transform: scale(1.3) rotate(180deg) translateY(-30px);
          }
          60% {
            opacity: 0.6;
            transform: scale(0.9) rotate(360deg) translateY(-20px);
          }
          100% {
            opacity: 0;
            transform: scale(0.2) rotate(540deg) translateY(-10px);
          }
        }

        /* é—ªçƒå…‰ç‚¹ç‰¹æ•ˆ */
        @keyframes sparkle-burst {
          0% {
            opacity: 1;
            transform: scale(0);
            box-shadow: 0 0 0 rgba(255, 215, 0, 0);
          }
          50% {
            opacity: 1;
            transform: scale(2);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
          }
          100% {
            opacity: 0;
            transform: scale(0.5);
            box-shadow: 0 0 0 rgba(255, 215, 0, 0);
          }
        }

        /* æ–½è‚¥åŠ¨ç”» */
        .farmland-cell.fertilizer-animation {
          animation: fertilizer-effect 0.6s ease-out;
        }
        
        @keyframes fertilizer-effect {
          0% {
            transform: scale(1);
            filter: brightness(1);
          }
          25% {
            transform: scale(1.08);
            filter: brightness(1.2);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.4);
          }
          50% {
            transform: scale(1.12);
            filter: brightness(1.4);
            box-shadow: 0 0 20px rgba(34, 197, 94, 1), 0 0 40px rgba(34, 197, 94, 0.5);
          }
          100% {
            transform: scale(1.05);
            filter: brightness(1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
          }
        }
        
        /* å†œç”°çŠ¶æ€æ˜¾ç¤º */
        .farmland-cell-status {
          position: absolute;
          top: 5px;
          left: 5px;
          background-color: rgba(0, 0, 0, 0.6);
          color: white;
          padding: 2px 5px;
          border-radius: 3px;
          font-size: 0.6rem;
          z-index: 10;
        }
        
        .farmland-cell-indicators {
          position: absolute;
          bottom: 5px;
          left: 5px;
          right: 5px;
          display: flex;
          justify-content: space-between;
          z-index: 10;
        }
        
        .farmland-cell-indicator {
          background-color: rgba(0, 0, 0, 0.6);
          color: white;
          padding: 2px 5px;
          border-radius: 3px;
          font-size: 0.6rem;
          display: flex;
          align-items: center;
        }
        
        /* ä½œç‰©å›¾ç‰‡ */
        .crop-image {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 120px;
          height: 120px;
          background-size: contain;
          background-position: center;
          background-repeat: no-repeat;
          z-index: 5;
        }
        
        /* æˆç†Ÿæ ‡è®° */
        .ready-to-harvest {
          position: absolute;
          top: 5px;
          right: 5px;
          color: gold;
          font-size: 1.2rem;
          z-index: 15;
          animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.2); }
          100% { transform: scale(1); }
        }
        
        /* å·¥å…·æŒ‰é’®æ ·å¼ */
        .tool-button.selected {
          background-color: #4CAF50;
          border-color: #388E3C;
        }
        
        /* å†œç”°æ ¼å­æ‚¬åœæç¤ºæ¡†æ ·å¼ */
        .farmland-tooltip {
          position: fixed;
          background-color: rgba(45, 55, 72, 0.95);
          backdrop-filter: blur(5px);
          color: #F7FAFC;
          padding: 12px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          font-size: 0.8rem;
          width: 220px;
          z-index: 2000;
          opacity: 0;
          transform: translateY(-5px);
          animation: fadeInTooltip 0.3s ease-out forwards;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }
        
        /* æˆåŠŸæç¤º */
        .harvest-animation {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: #4CAF50;
          font-size: 1.5rem;
          font-weight: bold;
          z-index: 20;
          animation: harvestPop 1s ease-out forwards;
        }
        
        @keyframes harvestPop {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
          50% { transform: translate(-50%, -80px) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%, -100px) scale(0.8); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      // æ’­æ”¾å†œåœºéŸ³æ•ˆ
      playFarmSound();
      
      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);
      
      // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          // æ¸…é™¤ç§å­å…‰æ ‡
          clearSeedCursor();
          // æ¸…é™¤é€‰æ‹©çŠ¶æ€
          window.selectedSeed = null;
          window.selectedTool = null;

          modalContainer.classList.remove('active');
          setTimeout(() => {
            // ä¿å­˜å†œç”°æ•°æ®
            gameData.farmlandData = farmlandData;
            updateGameData();
            modalContainer.remove();
          }, 300);
        }
      };
      
      // å½“å‰é€‰ä¸­çš„å·¥å…·æˆ–ç§å­
      window.selectedTool = null;
      window.selectedSeed = null;
      
      // é€‰æ‹©å·¥å…·å‡½æ•°
      function selectTool(tool) {
        window.selectedTool = tool;
        window.selectedSeed = null;
        document.querySelectorAll('.seed-card').forEach(card => {
          card.classList.remove('selected');
        });
      }
      
      // æ·»åŠ é€‰æ‹©ç§å­å‡½æ•°ï¼ˆå•å‡»é€‰æ‹©ï¼‰
      function selectSeed(seedKey) {
        const seedAmount = gameData.resources[seedKey]?.amount || 0;
        if (seedAmount <= 0) {
          showNotification('ç§å­ä¸è¶³', `ä½ æ²¡æœ‰${farmlandData.seeds[seedKey].name}ï¼`);
          // æ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤ºï¼Œç¡®ä¿æ•°é‡ä¸º0çš„å¡ç‰Œè¢«éšè—
          if (window.updateSeedCards) {
            window.updateSeedCards();
          }
          return;
        }

        // æ¸…é™¤å·¥å…·é€‰æ‹©
        window.selectedTool = null;
        document.querySelectorAll('.tool-button').forEach(btn => {
          btn.classList.remove('selected');
        });

        // é€‰æ‹©ç§å­ï¼ˆä»…é«˜äº®æ˜¾ç¤ºï¼Œä¸åˆ›å»ºå…‰æ ‡ï¼‰
        window.selectedSeed = seedKey;
        document.querySelectorAll('.crafting-inventory-card').forEach(card => {
          if (card.dataset.seedType !== seedKey) {
            card.classList.remove('selected');
          } else {
            card.classList.add('selected');
          }
        });
      }

      // åˆ›å»ºè‡ªå®šä¹‰ç§å­å…‰æ ‡å‡½æ•°
      function createSeedCursor(seedKey) {
        console.log('createSeedCursor è¢«è°ƒç”¨ï¼ŒseedKey:', seedKey);
        const seed = farmlandData.seeds[seedKey];
        const seedAmount = gameData.resources[seedKey]?.amount || 0;

        console.log('ç§å­ä¿¡æ¯:', seed);
        console.log('ç§å­æ•°é‡:', seedAmount);

        // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å…‰æ ‡
        const existingCursor = document.getElementById('seed-drag-cursor');
        if (existingCursor) {
          console.log('æ¸…é™¤æ—§å…‰æ ‡');
          existingCursor.parentNode.removeChild(existingCursor);
        }

        // åˆ›å»ºè‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆ
        const customCursor = document.createElement('div');
        customCursor.id = 'seed-drag-cursor';
        customCursor.className = 'seed-drag-cursor';
        customCursor.style.cssText = `
          position: fixed;
          pointer-events: none;
          z-index: 9999;
          width: 40px;
          height: 40px;
          background-image: url('${seed.image}');
          background-size: cover;
          border-radius: 50%;
          box-shadow: 0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3);
          opacity: 0.9;
          transform: translate(-50%, -50%);
          transition: transform 0.1s ease;
          display: block !important;
        `;

        // æ·»åŠ æ‰‹å½¢å›¾æ ‡æ•ˆæœ
        const handIcon = document.createElement('div');
        handIcon.style.cssText = `
          position: absolute;
          top: -10px;
          right: -10px;
          width: 20px;
          height: 20px;
          background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238D6E63"><path d="M12.5 5.5C11.67 5.5 11 6.17 11 7V11C11 11.55 10.55 12 10 12S9 11.55 9 11V7C9 6.17 8.33 5.5 7.5 5.5S6 6.17 6 7V12C6 13.1 6.9 14 8 14H9.5C10.33 14 11 13.33 11 12.5V12C11 13.1 10.1 14 9 14H8C6.9 14 6 13.1 6 12V7C6 6.17 5.33 5.5 4.5 5.5S3 6.17 3 7V12C3 14.21 4.79 16 7 16H11.5C13.43 16 15 14.43 15 12.5V7C15 6.17 14.33 5.5 13.5 5.5S12 6.17 12 7V11.5C12 11.78 12.22 12 12.5 12Z"/></svg>');
          background-size: contain;
          background-repeat: no-repeat;
        `;
        customCursor.appendChild(handIcon);

        // æ·»åŠ æ•°é‡æŒ‡ç¤ºå™¨åˆ°å·¦ä¸‹è§’
        const countIndicator = document.createElement('div');
        countIndicator.id = 'seed-count-indicator';
        countIndicator.className = 'seed-count-indicator';
        countIndicator.style.cssText = `
          position: absolute;
          bottom: -5px;
          left: -5px;
          background-color: #E53E3E;
          color: white;
          border-radius: 50%;
          width: 18px;
          height: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: bold;
          border: 2px solid white;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        `;
        countIndicator.textContent = seedAmount;
        customCursor.appendChild(countIndicator);

        document.body.appendChild(customCursor);

        // éšè—é»˜è®¤å…‰æ ‡ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰å…‰æ ‡
        document.body.style.cursor = 'none';

        // åˆå§‹åŒ–å…‰æ ‡ä½ç½®
        customCursor.style.left = window.lastMouseX + 'px';
        customCursor.style.top = window.lastMouseY + 'px';

        // å­˜å‚¨çŠ¶æ€
        let lastPosition = { x: window.lastMouseX || 0, y: window.lastMouseY || 0 };
        let lastTime = Date.now();
        const trailInterval = 100;
        let lastTrailTime = lastTime;
        let lastPlantedCellId = null; // è®°å½•ä¸Šä¸€æ¬¡ç§æ¤çš„æ ¼å­IDï¼Œé˜²æ­¢é‡å¤ç§æ¤

        // åˆ›å»ºæ‹–å½±æ•ˆæœ
        function createDragTrail(x, y, image) {
          const trail = document.createElement('div');
          trail.className = 'drag-trail';
          trail.style.left = (x - 20) + 'px';
          trail.style.top = (y - 20) + 'px';
          trail.style.width = '40px';
          trail.style.height = '40px';
          trail.style.backgroundImage = `url('${image}')`;
          document.body.appendChild(trail);

          setTimeout(() => {
            if (trail.parentNode) {
              trail.parentNode.removeChild(trail);
            }
          }, 500);
        }

        // åˆ›å»ºå…‰ç‚¹ç²’å­
        function createParticle(x, y, speed) {
          const particle = document.createElement('div');
          particle.className = 'particle drag-particle';
          const size = 5 + Math.random() * 8;
          const angle = Math.random() * Math.PI * 2;
          const distance = 20 + Math.random() * 40 + speed * 5;

          particle.style.left = (x - size/2) + 'px';
          particle.style.top = (y - size/2) + 'px';
          particle.style.width = size + 'px';
          particle.style.height = size + 'px';
          particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
          particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');

          const colors = [
            'rgba(255, 215, 0, 0.8)',
            'rgba(255, 165, 0, 0.8)',
            'rgba(255, 140, 0, 0.8)',
            'rgba(139, 69, 19, 0.6)'
          ];
          const color = colors[Math.floor(Math.random() * colors.length)];
          particle.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;

          document.body.appendChild(particle);

          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 1000);
        }

      // æ›´æ–°å…‰æ ‡ä½ç½®
        const updateCursorPosition = (e) => {
          if (!document.getElementById('seed-drag-cursor')) {
            document.body.appendChild(customCursor);
          }

          const currentTime = Date.now();
          const deltaTime = currentTime - lastTime;
          const deltaX = e.clientX - lastPosition.x;
          const deltaY = e.clientY - lastPosition.y;
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          const speed = distance / (deltaTime || 1);

          // æ£€æŸ¥æ˜¯å¦é è¿‘å†œç”°æ ¼å­ä¸­å¿ƒ
          const hoveredCell = document.elementFromPoint(e.clientX, e.clientY);
          const farmlandCell = hoveredCell?.closest('.farmland-cell');
          let isSnap = false;

          // æ£€æŸ¥æ ¼å­æ˜¯å¦å·²è§£é”ï¼ˆä¸åŒ…å« locked æˆ– farmland-cell-locked ç±»ï¼‰
          const isLocked = farmlandCell && (
            farmlandCell.classList.contains('locked') ||
            farmlandCell.classList.contains('farmland-cell-locked')
          );

          if (farmlandCell && !isLocked && !farmlandCell.querySelector('.crop-image')) {
            const rect = farmlandCell.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const snapDistance = Math.sqrt(
              Math.pow(e.clientX - centerX, 2) +
              Math.pow(e.clientY - centerY, 2)
            );

            if (snapDistance < 50) {
              customCursor.style.left = centerX + 'px';
              customCursor.style.top = centerY + 'px';
              isSnap = true;

              let snapIndicator = document.getElementById('snap-indicator');
              if (!snapIndicator) {
                snapIndicator = document.createElement('div');
                snapIndicator.id = 'snap-indicator';
                snapIndicator.className = 'snap-indicator';
                document.body.appendChild(snapIndicator);
              }
              snapIndicator.style.left = rect.left + 'px';
              snapIndicator.style.top = rect.top + 'px';
              snapIndicator.style.width = rect.width + 'px';
              snapIndicator.style.height = rect.height + 'px';
              snapIndicator.style.display = 'block';

              // è‡ªåŠ¨ç§æ¤é€»è¾‘ï¼šå½“å…‰æ ‡å¸é™„åˆ°æ ¼å­ä¸­å¿ƒæ—¶è‡ªåŠ¨ç§æ¤
              const cellId = parseInt(farmlandCell.dataset.cellId);
              if (cellId !== undefined && cellId !== lastPlantedCellId) {
                console.log(`è‡ªåŠ¨è§¦å‘ç§æ¤ï¼Œæ ¼å­ID: ${cellId}`);

                // è°ƒç”¨plantCropå‡½æ•°ç§æ¤ï¼ˆplantCropå‡½æ•°å·²æ›´æ–°æ ¼å­æ˜¾ç¤ºï¼‰
                if (plantCrop(cellId, seedKey)) {
                  console.log('è‡ªåŠ¨ç§æ¤æˆåŠŸ');
                  console.log('window.triggerPlaceAnimation æ˜¯å¦å­˜åœ¨:', typeof window.triggerPlaceAnimation);

                  // è§¦å‘åä¸½çš„æ”¾ç½®åŠ¨ç”»ç‰¹æ•ˆ
                  if (window.triggerPlaceAnimation && typeof window.triggerPlaceAnimation === 'function') {
                    console.log('æ­£åœ¨è°ƒç”¨ triggerPlaceAnimation...');
                    window.triggerPlaceAnimation(farmlandCell, 'seed');
                    console.log('triggerPlaceAnimation è°ƒç”¨å®Œæˆ');
                  } else {
                    console.log('triggerPlaceAnimation ä¸å¯ç”¨ï¼Œä½¿ç”¨ç®€å•åŠ¨ç”»');
                    farmlandCell.classList.add('plant-animation');
                    setTimeout(() => {
                      farmlandCell.classList.remove('plant-animation');
                    }, 600);
                  }

                  // æ›´æ–°æ•°é‡æŒ‡ç¤ºå™¨
                  const newSeedAmount = gameData.resources[seedKey]?.amount || 0;
                  countIndicator.textContent = newSeedAmount;

                  // æ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
                  if (window.updateSeedCards) {
                    window.updateSeedCards();
                  }

                  // è®°å½•å·²ç§æ¤çš„æ ¼å­ï¼Œé˜²æ­¢é‡å¤ç§æ¤
                  lastPlantedCellId = cellId;

                  // å¦‚æœç§å­ç”¨å®Œäº†ï¼Œæ¸…é™¤å…‰æ ‡
                  if (newSeedAmount <= 0) {
                    console.log('ç§å­ç”¨å®Œï¼Œæ¸…é™¤å…‰æ ‡');
                    clearSeedCursor();
                    return;
                  }
                }
              }
            } else {
              const hideSnapIndicator = document.getElementById('snap-indicator');
              if (hideSnapIndicator) {
                hideSnapIndicator.style.display = 'none';
              }
            }
          } else {
            const snapIndicator2 = document.getElementById('snap-indicator');
            if (snapIndicator2) {
              snapIndicator2.style.display = 'none';
            }
          }

          if (!isSnap) {
            customCursor.style.left = e.clientX + 'px';
            customCursor.style.top = e.clientY + 'px';
          }

          // æ‘‡æ‘†æ•ˆæœ
          const swing = Math.sin(Date.now() / 150) * 5;

          const canPlaceNow = farmlandCell && !isLocked && !farmlandCell.querySelector('.crop-image');

          if (canPlaceNow) {
            customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(1.1)`;
            customCursor.style.boxShadow = '0 0 25px rgba(76, 175, 80, 0.8), 0 4px 8px rgba(0,0,0,0.3)';
          } else {
            const scale = 1 + Math.sin(Date.now() / 200) * 0.05;
            customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(${scale})`;
            customCursor.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3)';
          }

          // åˆ›å»ºæ‹–å½±
          if (currentTime - lastTrailTime > Math.max(50, 150 - speed * 10)) {
            createDragTrail(lastPosition.x, lastPosition.y, seed.image);
            lastTrailTime = currentTime;
          }

          // åˆ›å»ºç²’å­
          if (Math.random() < 0.3) {
            createParticle(e.clientX, e.clientY, speed);
          }

          lastPosition = { x: e.clientX, y: e.clientY };
          lastTime = currentTime;
          window.lastMouseX = e.clientX;
          window.lastMouseY = e.clientY;

          // æ›´æ–°æ•°é‡
          const currentSeedAmount = gameData.resources[seedKey]?.amount || 0;
          countIndicator.textContent = currentSeedAmount;

          if (currentSeedAmount <= 0) {
            // æ•°é‡ä¸º0æ—¶ç«‹å³æ¸…é™¤å…‰æ ‡
            if (window.clearAllCustomCursors) {
              window.clearAllCustomCursors();
            }
            return;
          }
        };

        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        updateCursorPosition({ clientX: window.lastMouseX || 0, clientY: window.lastMouseY || 0 });

        // æ·»åŠ é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨
        window.seedCursorMouseMoveHandler = updateCursorPosition;
        document.addEventListener('mousemove', window.seedCursorMouseMoveHandler);
      }

      // æ¸…é™¤ç§å­å…‰æ ‡å‡½æ•°
      function clearSeedCursor() {
        // ä½¿ç”¨å…¨å±€æ¸…é™¤å‡½æ•°
        if (window.clearAllCustomCursors) {
          window.clearAllCustomCursors();
        }

        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
        if (window.seedCursorMouseMoveHandler) {
          document.removeEventListener('mousemove', window.seedCursorMouseMoveHandler);
          window.seedCursorMouseMoveHandler = null;
        }
      }

      // åˆ›å»ºèµ„æºå…‰æ ‡å‡½æ•°ï¼ˆç”¨äºæ°´å’Œè‚¥æ–™çš„è¿ç»­æ–½æ”¾ï¼‰- ä¸ç§å­å…‰æ ‡ä½¿ç”¨ç›¸åŒæ ·å¼
      function createResourceCursor(resourceKey) {
        console.log('createResourceCursor è¢«è°ƒç”¨ï¼ŒresourceKey:', resourceKey);
        const resource = gameData.resources[resourceKey];
        const resourceAmount = resource?.amount || 0;

        if (resourceAmount <= 0) {
          showNotification('èµ„æºä¸è¶³', `ä½ æ²¡æœ‰${resource.name}ï¼`);
          return;
        }

        // æ¸…é™¤ç§å­é€‰æ‹©
        window.selectedSeed = null;
        document.querySelectorAll('.crafting-inventory-card').forEach(card => {
          if (card.dataset.seedType) {
            card.classList.remove('selected');
          }
        });

        // é€‰æ‹©èµ„æºå·¥å…·
        window.selectedTool = resourceKey;
        document.querySelectorAll('.crafting-inventory-card').forEach(card => {
          if (card.dataset.resourceType !== resourceKey) {
            card.classList.remove('selected');
          } else {
            card.classList.add('selected');
          }
        });

        // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å…‰æ ‡
        const existingCursor = document.getElementById('resource-drag-cursor');
        if (existingCursor) {
          console.log('æ¸…é™¤æ—§å…‰æ ‡');
          existingCursor.parentNode.removeChild(existingCursor);
        }

        // åˆ›å»ºè‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆï¼ˆä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„æ ·å¼ï¼‰
        const customCursor = document.createElement('div');
        customCursor.id = 'resource-drag-cursor';
        customCursor.className = 'resource-drag-cursor';
        customCursor.style.cssText = `
          position: fixed;
          pointer-events: none;
          z-index: 9999;
          width: 40px;
          height: 40px;
          background-image: url('${resource.image}');
          background-size: cover;
          border-radius: 50%;
          box-shadow: 0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3);
          opacity: 0.9;
          transform: translate(-50%, -50%);
          transition: transform 0.1s ease;
          display: block !important;
        `;

        // æ·»åŠ æ‰‹å½¢å›¾æ ‡æ•ˆæœ
        const handIcon = document.createElement('div');
        handIcon.style.cssText = `
          position: absolute;
          top: -10px;
          right: -10px;
          width: 20px;
          height: 20px;
          background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238D6E63"><path d="M12.5 5.5C11.67 5.5 11 6.17 11 7V11C11 11.55 10.55 12 10 12S9 11.55 9 11V7C9 6.17 8.33 5.5 7.5 5.5S6 6.17 6 7V12C6 13.1 6.9 14 8 14H9.5C10.33 14 11 13.33 11 12.5V12C11 13.1 10.1 14 9 14H8C6.9 14 6 13.1 6 12V7C6 6.17 5.33 5.5 4.5 5.5S3 6.17 3 7V12C3 14.21 4.79 16 7 16H11.5C13.43 16 15 14.43 15 12.5V7C15 6.17 14.33 5.5 13.5 5.5S12 6.17 12 7V11.5C12 11.78 12.22 12 12.5 12Z"/></svg>');
          background-size: contain;
          background-repeat: no-repeat;
        `;
        customCursor.appendChild(handIcon);

        // æ·»åŠ æ•°é‡æŒ‡ç¤ºå™¨åˆ°å·¦ä¸‹è§’
        const countIndicator = document.createElement('div');
        countIndicator.id = 'resource-count-indicator';
        countIndicator.className = 'seed-count-indicator';
        countIndicator.style.cssText = `
          position: absolute;
          bottom: -5px;
          left: -5px;
          background-color: #E53E3E;
          color: white;
          border-radius: 50%;
          width: 18px;
          height: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: bold;
          border: 2px solid white;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        `;
        // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
        let displayCount = resourceAmount;
        if (resourceKey === 'bucket') {
          // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('bucket');
          displayCount = Math.floor(totalWater / 50);
          console.log('å†œç”°çª—å£æœ¨æ¡¶ï¼štotalWater =', totalWater, ', displayCount =', displayCount);
        } else if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
          // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('water_bag');
          displayCount = Math.floor(totalWater / 20);
          console.log('å†œç”°çª—å£æ°´è¢‹ï¼šresourceKey =', resourceKey, ', totalWater =', totalWater, ', displayCount =', displayCount);
        }
        countIndicator.textContent = displayCount;
        customCursor.appendChild(countIndicator);

        document.body.appendChild(customCursor);

        // éšè—é»˜è®¤å…‰æ ‡ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰å…‰æ ‡
        document.body.style.cursor = 'none';

        // åˆå§‹åŒ–å…‰æ ‡ä½ç½®
        customCursor.style.left = window.lastMouseX + 'px';
        customCursor.style.top = window.lastMouseY + 'px';

        // å­˜å‚¨çŠ¶æ€
        let lastPosition = { x: window.lastMouseX || 0, y: window.lastMouseY || 0 };
        let lastTime = Date.now();
        const trailInterval = 100;
        let lastTrailTime = lastTime;
        let lastAppliedCellId = null; // è®°å½•ä¸Šä¸€æ¬¡æ–½æ”¾çš„æ ¼å­IDï¼Œé˜²æ­¢é‡å¤æ–½æ”¾

        // åˆ›å»ºæ‹–å½±æ•ˆæœ
        function createDragTrail(x, y, image) {
          const trail = document.createElement('div');
          trail.className = 'drag-trail';
          trail.style.left = (x - 20) + 'px';
          trail.style.top = (y - 20) + 'px';
          trail.style.width = '40px';
          trail.style.height = '40px';
          trail.style.backgroundImage = `url('${image}')`;
          document.body.appendChild(trail);

          setTimeout(() => {
            if (trail.parentNode) {
              trail.parentNode.removeChild(trail);
            }
          }, 500);
        }

        // åˆ›å»ºå…‰ç‚¹ç²’å­ï¼ˆä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„é‡‘è‰²ç²’å­æ•ˆæœï¼‰
        function createParticle(x, y, speed) {
          const particle = document.createElement('div');
          particle.className = 'particle drag-particle';
          const size = 5 + Math.random() * 8;
          const angle = Math.random() * Math.PI * 2;
          const distance = 20 + Math.random() * 40 + speed * 5;

          particle.style.left = (x - size/2) + 'px';
          particle.style.top = (y - size/2) + 'px';
          particle.style.width = size + 'px';
          particle.style.height = size + 'px';
          particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
          particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');

          // ä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„é‡‘è‰²ç³»ç²’å­é¢œè‰²
          const colors = [
            'rgba(255, 215, 0, 0.8)',
            'rgba(255, 165, 0, 0.8)',
            'rgba(255, 140, 0, 0.8)',
            'rgba(139, 69, 19, 0.6)'
          ];
          const color = colors[Math.floor(Math.random() * colors.length)];
          particle.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;

          document.body.appendChild(particle);

          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 1000);
        }

        // æ›´æ–°å…‰æ ‡ä½ç½®
        const updateCursorPosition = (e) => {
          if (!document.getElementById('resource-drag-cursor')) {
            document.body.appendChild(customCursor);
          }

          const currentTime = Date.now();
          const deltaTime = currentTime - lastTime;
          const deltaX = e.clientX - lastPosition.x;
          const deltaY = e.clientY - lastPosition.y;
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          const speed = distance / (deltaTime || 1);

          // æ£€æŸ¥æ˜¯å¦é è¿‘å†œç”°æ ¼å­ä¸­å¿ƒ
          const hoveredCell = document.elementFromPoint(e.clientX, e.clientY);
          const farmlandCell = hoveredCell?.closest('.farmland-cell');
          let isSnap = false;
          let cellData = null;

          // æ£€æŸ¥æ ¼å­æ˜¯å¦å·²è§£é”ï¼ˆä¸åŒ…å« locked æˆ– farmland-cell-locked ç±»ï¼‰
          const isLocked = farmlandCell && (
            farmlandCell.classList.contains('locked') ||
            farmlandCell.classList.contains('farmland-cell-locked')
          );

          if (farmlandCell && !isLocked) {
            const cellId = parseInt(farmlandCell.dataset.cellId);
            cellData = farmlandData.cells[cellId];

            // åªå¯¹æœ‰ä½œç‰©æˆ–ç©ºæ ¼å­æ–½æ”¾èµ„æº
            if (cellData && cellData.crop !== null) {
              const rect = farmlandCell.getBoundingClientRect();
              const centerX = rect.left + rect.width / 2;
              const centerY = rect.top + rect.height / 2;
              const snapDistance = Math.sqrt(
                Math.pow(e.clientX - centerX, 2) +
                Math.pow(e.clientY - centerY, 2)
              );

              if (snapDistance < 50) {
                customCursor.style.left = centerX + 'px';
                customCursor.style.top = centerY + 'px';
                isSnap = true;

                let snapIndicator = document.getElementById('snap-indicator');
                if (!snapIndicator) {
                  snapIndicator = document.createElement('div');
                  snapIndicator.id = 'snap-indicator';
                  snapIndicator.className = 'snap-indicator';
                  document.body.appendChild(snapIndicator);
                }
                snapIndicator.style.left = rect.left + 'px';
                snapIndicator.style.top = rect.top + 'px';
                snapIndicator.style.width = rect.width + 'px';
                snapIndicator.style.height = rect.height + 'px';
                snapIndicator.style.display = 'block';

                // è‡ªåŠ¨æ–½æ”¾é€»è¾‘ï¼šå½“å…‰æ ‡å¸é™„åˆ°æ ¼å­ä¸­å¿ƒæ—¶è‡ªåŠ¨æ–½æ”¾
                if (cellId !== undefined && cellId !== lastAppliedCellId) {
                  console.log(`è‡ªåŠ¨è§¦å‘æ–½æ”¾${resourceKey}ï¼Œæ ¼å­ID: ${cellId}`);

                  let success = false;
                  if (resourceKey === 'bucket') {
                    // ä½¿ç”¨æœ¨æ¡¶æµ‡æ°´ - ä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°
                    const result = useWaterFromContainer('bucket', 50);
                    if (result.success) {
                      cellData.moisture = Math.min(100, cellData.moisture + result.usedAmount);
                      success = true;
                      const totalWater = getContainerTotalWater('bucket');
                      let message = `æ¹¿æ¶¦åº¦å¢åŠ äº†${result.usedAmount}ï¼å‰©ä½™æ€»æ°´é‡: ${totalWater}/250`;
                      if (result.containerDestroyed) {
                        message += ' ' + result.message;
                      }
                      showNotification('æµ‡æ°´æˆåŠŸ', message);
                    } else {
                      showNotification('æµ‡æ°´å¤±è´¥', result.message);
                    }
                    } else if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
                    // ä½¿ç”¨æ°´è¢‹æµ‡æ°´ - ä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°
                    const result = useWaterFromContainer('water_bag', 20);
                    if (result.success) {
                      cellData.moisture = Math.min(100, cellData.moisture + result.usedAmount);
                      success = true;
                      const totalWater = getContainerTotalWater('water_bag');
                      let message = `æ¹¿æ¶¦åº¦å¢åŠ äº†${result.usedAmount}ï¼å‰©ä½™æ€»æ°´é‡: ${totalWater}/100`;
                      if (result.containerDestroyed) {
                        message += ' ' + result.message;
                      }
                      showNotification('æµ‡æ°´æˆåŠŸ', message);
                    } else {
                      showNotification('æµ‡æ°´å¤±è´¥', result.message);
                    }
                  } else if (resourceKey === 'fertilizer') {
                    // æ–½è‚¥
                    const fertilizerAmount = gameData.resources.fertilizer?.amount || 0;
                    if (fertilizerAmount > 0 && cellData.fertility < 100) {
                      gameData.resources.fertilizer.amount -= 1;
                      cellData.fertility = Math.min(100, cellData.fertility + 25);
                      success = true;
                      showNotification('æ–½è‚¥æˆåŠŸ', 'è‚¥æ²ƒåº¦å¢åŠ äº†25ï¼');
                    }
                  }

                  if (success) {
                    // æ›´æ–°æ ¼å­æ˜¾ç¤º
                    const cellElement = document.getElementById(`farmland-cell-${cellId}`);
                    if (cellElement) {
                      // æ›´æ–°åº•éƒ¨æŒ‡ç¤ºå™¨ä¸­çš„æ¹¿åº¦å’Œè‚¥æ²ƒåº¦æ•°å€¼
                      const indicatorsDiv = cellElement.querySelector('.farmland-cell-indicators');
                      if (indicatorsDiv) {
                        const indicators = indicatorsDiv.querySelectorAll('.farmland-cell-indicator');
                        if (indicators.length >= 2) {
                          // ç¬¬ä¸€ä¸ªæŒ‡ç¤ºå™¨æ˜¯æ¹¿æ¶¦åº¦ï¼ˆå·¦ä¸‹è§’ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯è‚¥æ²ƒåº¦ï¼ˆå³ä¸‹è§’ï¼‰
                          indicators[0].innerHTML = `ğŸ’§ ${cellData.moisture}`;
                          indicators[1].innerHTML = `ğŸŒ± ${cellData.fertility}`;
                        }
                      }

                      // è§¦å‘ç›¸åº”çš„è§†è§‰ç‰¹æ•ˆ
                      if (resourceKey === 'water' || resourceKey === 'bucket' || resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
                        // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
                        if (!window.createWaterEffect || !window.createWaterFloatingText) {
                          if (typeof initializeAnimationCSS === 'function') {
                            initializeAnimationCSS();
                          }
                          if (typeof initializeAnimationEffects === 'function') {
                            initializeAnimationEffects();
                          }
                        }

                        if (window.createWaterEffect) {
                          // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
                          cellElement.classList.add('water-animation');

                          // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
                          window.createWaterEffect(cellElement);
                          window.createWaterFloatingText(cellElement);

                          // 1500msåç§»é™¤åŠ¨ç”»ç±»
                          setTimeout(() => {
                            cellElement.classList.remove('water-animation');
                          }, 1500);
                        }
                      } else if (resourceKey === 'fertilizer' && window.createFertilizerEffect) {
                        window.createFertilizerEffect(cellElement);
                      }
                    }

                    // æ›´æ–°æ•°é‡æŒ‡ç¤ºå™¨
                    const newResource = gameData.resources[resourceKey];
                    let newDisplayCount = newResource?.amount || 0;
                    // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
                    if (resourceKey === 'bucket') {
                      // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
                      const totalWater = getContainerTotalWater('bucket');
                      newDisplayCount = Math.floor(totalWater / 50);
                    } else if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
                      // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
                      const totalWater = getContainerTotalWater('water_bag');
                      newDisplayCount = Math.floor(totalWater / 20);
                    }
                    countIndicator.textContent = newDisplayCount;

                    // æ›´æ–°æ‰€æœ‰çª—å£ä¸­çš„èµ„æºå¡ç‰Œæ˜¾ç¤º
                    if (window.updateFarmlandRelatedResources) {
                      window.updateFarmlandRelatedResources();
                    }
                    // æ›´æ–°èƒŒåŒ…æ ä¸­çš„æœ¨æ¡¶å¡ç‰Œ
                    updateResourceCard('bucket');
                    // æ›´æ–°èƒŒåŒ…æ ä¸­çš„æ°´è¢‹å¡ç‰Œ
                    updateResourceCard('water_bag');
                    updateResourceCard('water_bag');
                    // æ›´æ–°ä»“åº“çª—å£
                    const storageModal = document.getElementById('storageModal');
                    if (storageModal && storageModal.classList.contains('active')) {
                      populateStorageModal();
                    }
                    // æ›´æ–°ç‰²å£æ£šçª—å£
                    const livestockModal = document.getElementById('livestockModal');
                    if (livestockModal && livestockModal.classList.contains('active')) {
                      updateFeedDisplay();
                    }
                    // æ›´æ–°é©¬å©çª—å£
                    const stableModal = document.getElementById('stableModal');
                    if (stableModal && stableModal.classList.contains('active')) {
                      if (window.updateStableFeedCards) {
                        window.updateStableFeedCards();
                      }
                      if (window.updateFeedCards) {
                        window.updateFeedCards();
                      }
                    }

                    renderResources();
                    updateGameData();

                    // è®°å½•å·²æ–½æ”¾çš„æ ¼å­ï¼Œé˜²æ­¢é‡å¤æ–½æ”¾
                    lastAppliedCellId = cellId;

                    // å¦‚æœèµ„æºç”¨å®Œäº†ï¼Œæ¸…é™¤å…‰æ ‡
                    let shouldClearCursor = false;
                    if (resourceKey === 'bucket' || resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
                      // æ°´è¢‹å’Œæ°´æ¡¶ï¼šæ£€æŸ¥æ°´ä½æ ¼å­æ•°æ˜¯å¦ä¸º0
                      if (newDisplayCount <= 0) {
                        shouldClearCursor = true;
                        console.log('å†œç”°çª—å£ï¼šæ°´è¢‹æˆ–æ°´æ¡¶æ°´ä½æ ¼å­æ•°ä¸º0ï¼Œæ¸…é™¤å…‰æ ‡');
                      }
                    } else {
                      // å…¶ä»–ç‰©å“ï¼šæ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0
                      if (newResource?.amount <= 0) {
                        shouldClearCursor = true;
                      }
                    }
                    
                    if (shouldClearCursor) {
                      console.log('èµ„æºç”¨å®Œï¼Œæ¸…é™¤å…‰æ ‡');
                      clearSeedCursor();
                      return;
                    }
                  }
                }
              } else {
                const hideSnapIndicator = document.getElementById('snap-indicator');
                if (hideSnapIndicator) {
                  hideSnapIndicator.style.display = 'none';
                }
              }
            }
          }

          if (!isSnap) {
            customCursor.style.left = e.clientX + 'px';
            customCursor.style.top = e.clientY + 'px';
          }

          // æ‘‡æ‘†æ•ˆæœ
          const swing = Math.sin(Date.now() / 150) * 5;

          const canApplyNow = farmlandCell && !isLocked && cellData && cellData.crop !== null;

          if (canApplyNow) {
            customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(1.1)`;
            customCursor.style.boxShadow = '0 0 25px rgba(76, 175, 80, 0.8), 0 4px 8px rgba(0,0,0,0.3)';
          } else {
            const scale = 1 + Math.sin(Date.now() / 200) * 0.05;
            customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(${scale})`;
            customCursor.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3)';
          }

          // åˆ›å»ºæ‹–å½±
          if (currentTime - lastTrailTime > Math.max(50, 150 - speed * 10)) {
            createDragTrail(lastPosition.x, lastPosition.y, resource.image);
            lastTrailTime = currentTime;
          }

          // åˆ›å»ºç²’å­
          if (Math.random() < 0.3) {
            createParticle(e.clientX, e.clientY, speed);
          }

          // æ›´æ–°ä½ç½®
          lastPosition = { x: e.clientX, y: e.clientY };
          lastTime = currentTime;
          window.lastMouseX = e.clientX;
          window.lastMouseY = e.clientY;

          // æ›´æ–°æ•°é‡
          let currentDisplayCount = gameData.resources[resourceKey]?.amount || 0;
          // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
          if (resourceKey === 'bucket') {
            // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
            const totalWater = getContainerTotalWater('bucket');
            currentDisplayCount = Math.floor(totalWater / 50);
          } else if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
            // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
            const totalWater = getContainerTotalWater('water_bag');
            currentDisplayCount = Math.floor(totalWater / 20);
          }
          countIndicator.textContent = currentDisplayCount;

          // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œå½“æ°´ä½æ ¼å­æ•°ä¸º0æ—¶ç«‹å³æ¸…é™¤å…‰æ ‡ï¼›å…¶ä»–ç‰©å“å½“å¡ç‰Œæ•°é‡ä¸º0æ—¶æ¸…é™¤
          let shouldClearCursor = false;
          if (resourceKey === 'bucket' || resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
            // æ°´è¢‹å’Œæ°´æ¡¶ï¼šæ£€æŸ¥æ°´ä½æ ¼å­æ•°æ˜¯å¦ä¸º0
            if (currentDisplayCount <= 0) {
              shouldClearCursor = true;
              console.log('å†œç”°çª—å£ï¼šæ°´è¢‹æˆ–æ°´æ¡¶æ°´ä½æ ¼å­æ•°ä¸º0ï¼Œæ¸…é™¤å…‰æ ‡');
            }
          } else {
            // å…¶ä»–ç‰©å“ï¼šæ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0
            if (gameData.resources[resourceKey]?.amount <= 0) {
              shouldClearCursor = true;
            }
          }

          if (shouldClearCursor) {
            // æ¸…é™¤å…‰æ ‡
            if (window.clearAllCustomCursors) {
              window.clearAllCustomCursors();
            }
            return;
          }
        };

        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        updateCursorPosition({ clientX: window.lastMouseX || 0, clientY: window.lastMouseY || 0 });

        // æ·»åŠ é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨
        window.resourceCursorMouseMoveHandler = updateCursorPosition;
        document.addEventListener('mousemove', window.resourceCursorMouseMoveHandler);
      }

      // åˆ›å»ºå†œç”°çª—å£ä¸“ç”¨çš„èµ„æºå¡ç‰Œå‡½æ•°ï¼ˆç¦ç”¨ä¼ ç»Ÿæ‹–æ‹½ï¼Œä½¿ç”¨è‡ªå®šä¹‰å…‰æ ‡ï¼‰
      function createFarmlandResourceCard(resourceKey, resource) {
        const resourceCard = document.createElement('div');
        resourceCard.className = 'crafting-inventory-card';
        resourceCard.dataset.resourceType = resourceKey;
        resourceCard.style.cursor = 'grab'; // è®¾ç½®ä¸ºgrabå…‰æ ‡

        // ç¦ç”¨ä¼ ç»Ÿ HTML5 æ‹–æ‹½
        resourceCard.draggable = false;

        // å¤„ç†æœ¨æ¡¶å’Œæ°´è¢‹çš„ç‰¹æ®Šæ˜¾ç¤ºé€»è¾‘
        let displayImage = resource.image;
        let displayName = resource.name;
        if (resourceKey === 'bucket') {
          // è®¡ç®—æ°´ä½ï¼šæ”¯æŒå®ä¾‹ç³»ç»Ÿå’ŒwaterLevelå±æ€§
          let waterLevel = 0;
          if (resource.instances && resource.instances.length > 0) {
            waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (resource.waterLevel !== undefined) {
            waterLevel = resource.waterLevel;
          }
          
          // æœ¨æ¡¶ï¼ˆ5æ ¼ï¼Œæ¯æ ¼50å•ä½ï¼‰ï¼šæ°´ä½ = 0æ˜¾ç¤ºç©ºæœ¨æ¡¶ï¼Œæ°´ä½ > 0ï¼ˆ1-5æ ¼ï¼‰æ˜¾ç¤ºæ»¡æ°´æœ¨æ¡¶
          if (waterLevel > 0) {
            displayImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            displayImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
          }
          displayName = 'æœ¨æ¡¶';
        } else if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
          // æ ¹æ®å®ä¾‹ç³»ç»Ÿæˆ–waterLevelåŠ¨æ€è®¾ç½®æ°´è¢‹å›¾ç‰‡
          let waterLevel = 0;
          if (resource.instances && resource.instances.length > 0) {
            // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿè®¡ç®—æ€»æ°´é‡
            waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else {
            // ä½¿ç”¨resource.waterLevel
            waterLevel = resource.waterLevel || 0;
          }
          displayImage = waterLevel > 0 ? 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
          displayName = 'æ°´è¢‹';
        }

        // èµ„æºå›¾ç‰‡
        const resourceImage = document.createElement('div');
        resourceImage.className = 'crafting-card-image';
        resourceImage.style.backgroundImage = `url('${displayImage}')`;
        resourceImage.style.position = 'relative';
        resourceImage.style.overflow = 'visible';
        
        // ä¸ºæœ¨æ¡¶æ·»åŠ æ°´ä½æŒ‡ç¤ºæ¡ï¼ˆåœ¨å›¾ç‰‡å·¦ä¾§ï¼‰
        if (resourceKey === 'bucket') {
          // è®¡ç®—æ°´ä½ï¼šæ”¯æŒå®ä¾‹ç³»ç»Ÿå’ŒwaterLevelå±æ€§
          let waterLevel = 0;
          if (resource.instances && resource.instances.length > 0) {
            waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (resource.waterLevel !== undefined) {
            waterLevel = resource.waterLevel;
          }

          const waterIndicator = document.createElement('div');
          waterIndicator.className = 'water-level-indicator-backpack';
          waterIndicator.style.cssText = `
            position: absolute;
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 70px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            z-index: 10;
          `;

          // åˆ›å»º5ä¸ªæ°´ä½æ ¼
          const filledLevels = Math.floor(waterLevel / 50);

          for (let i = 0; i < 5; i++) {
            const waterCell = document.createElement('div');
            const isFilled = i >= (5 - filledLevels);

            waterCell.style.cssText = `
              flex: 1;
              border: 1px solid #8B4513;
              background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'};
              border-radius: 2px;
              transition: background-color 0.3s ease;
            `;

            waterIndicator.appendChild(waterCell);
          }

          resourceImage.appendChild(waterIndicator);
        }

        // ä¸ºæ°´è¢‹æ·»åŠ æ°´ä½æŒ‡ç¤ºæ¡ï¼ˆåœ¨å›¾ç‰‡å·¦ä¾§ï¼‰
        if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
          // è®¡ç®—æ°´ä½ï¼šæ”¯æŒå®ä¾‹ç³»ç»Ÿå’ŒwaterLevelå±æ€§
          let waterLevel = 0;
          if (resource.instances && resource.instances.length > 0) {
            waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (resource.waterLevel !== undefined) {
            waterLevel = resource.waterLevel;
          }

          const waterIndicator = document.createElement('div');
          waterIndicator.className = 'water-level-indicator-backpack';
          waterIndicator.style.cssText = `
            position: absolute;
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 70px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            z-index: 10;
          `;

          // æ°´è¢‹ï¼šæ»¡æ°´é‡100ï¼Œæ¯æ ¼20
          const filledLevels = Math.floor(waterLevel / 20);

          for (let i = 0; i < 5; i++) {
            const waterCell = document.createElement('div');
            const isFilled = i >= (5 - filledLevels);

            waterCell.style.cssText = `
              flex: 1;
              border: 1px solid #8B4513;
              background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'};
              border-radius: 2px;
              transition: background-color 0.3s ease;
            `;

            waterIndicator.appendChild(waterCell);
          }

          resourceImage.appendChild(waterIndicator);
        }
        
        resourceCard.appendChild(resourceImage);

        // ä¸ºæ°´è¢‹å’Œæœ¨æ¡¶æ·»åŠ ç«–ç€æ˜¾ç¤ºçš„è€ä¹…åº¦æ¡ï¼ˆå‚è€ƒèƒŒåŒ…æ æ ·å¼ï¼‰
        if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag' || resourceKey === 'bucket') {
          // è®¡ç®—å¹³å‡è€ä¹…åº¦
          let durability = resource.durability;
          if (resource.instances && resource.instances.length > 0) {
            const totalDurability = resource.instances.reduce((sum, inst) => sum + (inst.durability || 100), 0);
            durability = Math.round(totalDurability / resource.instances.length);
          }
          
          if (durability !== undefined) {
            const durabilityContainer = document.createElement('div');
            durabilityContainer.className = 'card-durability';
            durabilityContainer.style.cssText = `
              position: absolute;
              right: 4px;
              top: 34px;
              width: 4px;
              height: 45px;
              background-color: #E2E8F0;
              border-radius: 2px;
              overflow: hidden;
              z-index: 10;
            `;

            const durabilityBar = document.createElement('div');
            durabilityBar.className = 'durability-bar';
            durabilityBar.style.cssText = `
              width: 100%;
              background-color: ${durability > 50 ? '#38A169' : durability > 20 ? '#D69E2E' : '#E53E3E'};
              position: absolute;
              left: 0;
              bottom: 0;
              border-radius: 0 0 2px 2px;
              transition: height 0.3s ease;
              height: ${durability}%;
            `;

            durabilityContainer.appendChild(durabilityBar);
            resourceCard.appendChild(durabilityContainer);
          }
        }

        // èµ„æºåç§°å’Œæ•°é‡
        const resourceName = document.createElement('div');
        resourceName.className = 'crafting-card-title';
        resourceName.textContent = `${displayName}`;
        resourceCard.appendChild(resourceName);

        // ç¦ç”¨æ‚¬åœæç¤º
        resourceCard.removeAttribute('title');

        // æ·»åŠ æ•°é‡æ˜¾ç¤º
        const countDiv = document.createElement('div');
        countDiv.className = 'crafting-card-count';
        countDiv.textContent = `Ã— ${resource.amount}`;
        countDiv.style.display = 'none'; // éšè—æ•°é‡æ˜¾ç¤ºï¼Œå› ä¸ºå·²ç»åœ¨æ ‡é¢˜ä¸­æ˜¾ç¤ºäº†
        resourceCard.appendChild(countDiv);

        // åªä¸ºæ°´å’Œè‚¥æ–™æ·»åŠ è‡ªå®šä¹‰å…‰æ ‡å’Œè¿ç»­æ–½æ”¾åŠŸèƒ½
        if (resourceKey === 'water' || resourceKey === 'fertilizer' || resourceKey === 'bucket' || resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
          // mousedown äº‹ä»¶ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
          resourceCard.addEventListener('mousedown', function(e) {
            e.preventDefault();
            createResourceCursor(resourceKey);
          });
        }

        return resourceCard;
      }
      
      // åˆ›å»ºç§å­å¡ç‰Œå‡½æ•° - ç®€åŒ–ç‰ˆæœ¬ï¼Œåªæ˜¾ç¤ºæ ‡é¢˜å’Œæ•°é‡
      function createSeedCard(seedKey, seed) {
        const seedCard = document.createElement('div');
        seedCard.className = 'crafting-inventory-card';
        seedCard.dataset.seedType = seedKey;
        seedCard.style.cursor = 'grab'; // è®¾ç½®ä¸ºgrabå…‰æ ‡

        // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰è¿™ç§ç§å­
        const seedAmount = gameData.resources[seedKey]?.amount || 0;

        // ç§å­å›¾ç‰‡
        const seedImage = document.createElement('div');
        seedImage.className = 'crafting-card-image';
        seedImage.style.backgroundImage = `url('${seed.image}')`;
        seedCard.appendChild(seedImage);

        // ç§å­åç§°å’Œæ•°é‡åˆå¹¶æ˜¾ç¤º
        const seedName = document.createElement('div');
        seedName.className = 'crafting-card-title';
        seedName.textContent = `${seed.name}`;
        seedCard.appendChild(seedName);

        // æ·»åŠ é¼ æ ‡æ‚¬åœæç¤º
        seedCard.title = `${seed.name}\nç”Ÿé•¿å‘¨æœŸ: ${seed.growthTime}å¤©\næ”¶è·å¥–åŠ±: ${seed.rewardCount.join('-')}ä¸ª${getResourceName(seed.reward)}`;

        // æ‚¬åœæ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œä½¿ç”¨updateCardTooltipå‡½æ•°ç¡®ä¿æ•°é‡å®æ—¶æ›´æ–°
        seedCard.addEventListener('mouseenter', function(event) {
          updateCardTooltip(event);
        });

        seedCard.addEventListener('mouseleave', function() {
          hideSeedTooltip();
        });

        // æ‹–æ‹½å¼€å§‹ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
        seedCard.addEventListener('mousedown', function(e) {
          e.preventDefault();
          const seedAmount = gameData.resources[seedKey]?.amount || 0;
          if (seedAmount <= 0) {
            showNotification('ç§å­ä¸è¶³', `ä½ æ²¡æœ‰${farmlandData.seeds[seedKey].name}ï¼`);
            return;
          }

          // æ¸…é™¤å·¥å…·é€‰æ‹©
          window.selectedTool = null;
          document.querySelectorAll('.tool-button').forEach(btn => {
            btn.classList.remove('selected');
          });

          // é€‰æ‹©ç§å­
          window.selectedSeed = seedKey;
          document.querySelectorAll('.crafting-inventory-card').forEach(card => {
            if (card.dataset.seedType !== seedKey) {
              card.classList.remove('selected');
            } else {
              card.classList.add('selected');
            }
          });

          // åˆ›å»ºè‡ªå®šä¹‰ç§å­å…‰æ ‡
          createSeedCursor(seedKey);
        });

        return seedCard;
      }
      
      // æ˜¾ç¤ºç§å­å·¥å…·æç¤º
      function showSeedTooltip(seedCard, seed, seedAmount) {
        // å®æ—¶è·å–å½“å‰ç§å­æ•°é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¼ å…¥çš„åˆå§‹æ•°é‡
        const currentSeedKey = seedCard.dataset.seedType;
        const currentSeedAmount = gameData.resources[currentSeedKey]?.amount || 0;
        
        const tooltip = document.createElement('div');
        tooltip.id = 'seed-tooltip';
        tooltip.className = 'seed-tooltip';
        tooltip.innerHTML = `
          <div class="tooltip-title">${seed.name}</div>
          <div class="tooltip-info">ç”Ÿé•¿å‘¨æœŸ: ${seed.growthTime}å¤©</div>
          <div class="tooltip-info">æ”¶è·å¥–åŠ±: ${seed.rewardCount.join('-')}ä¸ª${getResourceName(seed.reward)}</div>
          <div class="tooltip-info">å½“å‰æ•°é‡: ${currentSeedAmount}</div>
        `;
        
        document.body.appendChild(tooltip);
        
        // å®šä½å·¥å…·æç¤º
        const rect = seedCard.getBoundingClientRect();
        tooltip.style.position = 'fixed';
        tooltip.style.left = rect.right + 10 + 'px';
        tooltip.style.top = rect.top + 'px';
        tooltip.style.zIndex = '2000';
      }
      
      // éšè—ç§å­å·¥å…·æç¤º
      function hideSeedTooltip() {
        const tooltip = document.getElementById('seed-tooltip');
        if (tooltip) {
          tooltip.remove();
        }
      }
      
      // è·å–èµ„æºåç§°
      function getResourceName(resourceKey) {
        const resourceNames = {
          'corn': 'ç‰ç±³',
          'wheat': 'å°éº¦',
          'rice': 'æ°´ç¨»',
          'vegetable': 'è”¬èœ',
          'fruit': 'æ°´æœ',
          'herb': 'è‰è¯',
          'fertilizer': 'è‚¥æ–™',
          'empty_bucket': 'æœ¨æ¡¶',
          'bucket': 'æœ¨æ¡¶',
          'empty_waterskin': 'æ°´è¢‹',
          'waterskin': 'æ°´è¢‹'
        };
        return resourceNames[resourceKey] || resourceKey;
      }
      
      // createResourceCard å‡½æ•°å·²ç§»åŠ¨åˆ°å…¨å±€ä½œç”¨åŸŸ
      

      // æ›´æ–°å·¦ä¾§æ å¡ç‰Œæ•°é‡æ˜¾ç¤º
      function updateLeftPanelCards() {
        try {
          // æ›´æ–°ç§å­å¡ç‰Œæ•°é‡ï¼ˆåˆ¶ä½œç•Œé¢ï¼‰
          Object.keys(farmlandData.seeds).forEach(seedKey => {
            const seedCards = document.querySelectorAll(`.crafting-inventory-card[data-seed-type="${seedKey}"]`);
            const leftPanelCards = document.querySelectorAll(`.resource-card[data-resource-type="${seedKey}"]`);
            const seedAmount = gameData.resources[seedKey]?.amount || 0;
            
            // æ›´æ–°åˆ¶ä½œç•Œé¢å¡ç‰Œ
            seedCards.forEach(card => {
              updateCardVisibility(card, seedAmount, farmlandData.seeds[seedKey].name);
              
              const nameDiv = card.querySelector('.crafting-card-title');
              if (nameDiv) {
                nameDiv.textContent = `${farmlandData.seeds[seedKey].name}`;
              }
              
              // æ›´æ–°å·¥å…·æç¤º
              card.title = `${farmlandData.seeds[seedKey].name}\næ•°é‡: ${seedAmount}\nç”Ÿé•¿å‘¨æœŸ: ${farmlandData.seeds[seedKey].growthTime}å¤©\næ”¶è·å¥–åŠ±: ${farmlandData.seeds[seedKey].rewardCount.join('-')}ä¸ª${getResourceName(farmlandData.seeds[seedKey].reward)}`;
              
              // æ›´æ–°æ•°é‡æ˜¾ç¤º
              const countDiv = card.querySelector('.crafting-card-count');
              if (countDiv) {
                countDiv.textContent = `Ã— ${seedAmount}`;
              }
            });
            
            // æ›´æ–°å·¦ä¾§å·¥å…·æ å¡ç‰Œ
            leftPanelCards.forEach(card => {
              updateCardVisibility(card, seedAmount, farmlandData.seeds[seedKey].name);
              
              const nameDiv = card.querySelector('.card-title');
              if (nameDiv) {
                nameDiv.textContent = `${farmlandData.seeds[seedKey].name} Ã— ${seedAmount}`;
              }
              
              // æ›´æ–°å·¥å…·æç¤º
              card.title = `${farmlandData.seeds[seedKey].name}\næ•°é‡: ${seedAmount}\nç”Ÿé•¿å‘¨æœŸ: ${farmlandData.seeds[seedKey].growthTime}å¤©\næ”¶è·å¥–åŠ±: ${farmlandData.seeds[seedKey].rewardCount.join('-')}ä¸ª${getResourceName(farmlandData.seeds[seedKey].reward)}`;
              
              // æ›´æ–°æ•°é‡æ˜¾ç¤º
              const countDiv = card.querySelector('.resource-count');
              if (countDiv) {
                countDiv.textContent = `Ã— ${seedAmount}`;
              }
            });
          });
          
          // æ›´æ–°èµ„æºå¡ç‰Œæ•°é‡ï¼ˆæ’é™¤empty_bucketï¼Œå®ƒåªæ˜¯bucketçš„å¼•ç”¨ï¼‰
          const relatedResources = ['bucket', 'empty_waterskin', 'waterskin', 'fertilizer'];
          relatedResources.forEach(resourceKey => {
            const resourceCards = document.querySelectorAll(`.crafting-inventory-card[data-resource-type="${resourceKey}"]`);
            const leftPanelCards = document.querySelectorAll(`.resource-card[data-resource-type="${resourceKey}"]`);
            const resource = gameData.resources[resourceKey];
            
            if (resource) {
              // æ›´æ–°åˆ¶ä½œç•Œé¢å¡ç‰Œ
              resourceCards.forEach(card => {
                updateCardVisibility(card, resource.amount, resource.name);
                
                const nameDiv = card.querySelector('.crafting-card-title');
                if (nameDiv) {
                  nameDiv.textContent = `${resource.name} Ã— ${resource.amount}`;
                }
                
                // æ›´æ–°æœ¨æ¡¶çš„æ°´ä½æŒ‡ç¤ºæ¡å’Œè€ä¹…åº¦
                if (resourceKey === 'bucket') {
                  const imageDiv = card.querySelector('.crafting-card-image');
                  if (imageDiv) {
                    // æ›´æ–°å›¾ç‰‡
                    let bucketImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
                    if (resource.waterLevel >= 200) {
                      bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
                    } else if (resource.waterLevel > 0) {
                      bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
                    }
                    imageDiv.style.backgroundImage = `url('${bucketImage}')`;
                    
                    // æ›´æ–°æ°´ä½æŒ‡ç¤ºæ¡
                    const waterIndicator = imageDiv.querySelector('.water-level-indicator-backpack');
                    // è®¡ç®—æ°´ä½ï¼šæ”¯æŒå®ä¾‹ç³»ç»Ÿå’ŒwaterLevelå±æ€§
                    let waterLevel = 0;
                    if (resource.instances && resource.instances.length > 0) {
                      waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
                    } else if (resource.waterLevel !== undefined) {
                      waterLevel = resource.waterLevel;
                    }
                    
                    if (waterIndicator && waterLevel > 0) {
                      const filledLevels = Math.floor(waterLevel / 50);
                      const cells = waterIndicator.querySelectorAll('div');
                      cells.forEach((cell, index) => {
                        const isFilled = index >= (5 - filledLevels);
                        cell.style.backgroundColor = isFilled ? '#3B82F6' : '#FFFFFF';
                      });
                    }
                    
                    // æ›´æ–°æˆ–æ·»åŠ è€ä¹…åº¦æ˜¾ç¤º
                    let durabilityDiv = nameDiv.querySelector('.crafting-card-durability');
                    if (resource.durability !== undefined) {
                      if (durabilityDiv) {
                        durabilityDiv.textContent = `è€ä¹…: ${resource.durability}%`;
                        durabilityDiv.style.color = resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E';
                      } else {
                        durabilityDiv = document.createElement('div');
                        durabilityDiv.className = 'crafting-card-durability';
                        durabilityDiv.style.cssText = `
                          font-size: 0.6rem;
                          color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'};
                          text-align: center;
                          margin-top: 2px;
                        `;
                        durabilityDiv.textContent = `è€ä¹…: ${resource.durability}%`;
                        nameDiv.appendChild(durabilityDiv);
                      }
                    }
                  }
                }
                
                // æ›´æ–°æ•°é‡æ˜¾ç¤º
                const countDiv = card.querySelector('.crafting-card-count');
                if (countDiv) {
                  countDiv.textContent = `Ã— ${resource.amount}`;
                }
              });
              
              // æ›´æ–°å·¦ä¾§å·¥å…·æ å¡ç‰Œ
              leftPanelCards.forEach(card => {
                updateCardVisibility(card, resource.amount, resource.name);
                
                const nameDiv = card.querySelector('.card-title');
                if (nameDiv) {
                  nameDiv.textContent = `${resource.name} Ã— ${resource.amount}`;
                }
                
                // ç§æ¤ç”¨å“ä¸è®¾ç½®titleå±æ€§ï¼Œé˜²æ­¢æ˜¾ç¤ºæ‚¬åœæç¤º
                // card.title = `${resource.name}\næ•°é‡: ${resource.amount}`;
                
                // æ›´æ–°æ•°é‡æ˜¾ç¤º
                const countDiv = card.querySelector('.resource-count');
                if (countDiv) {
                  countDiv.textContent = `Ã— ${resource.amount}`;
                }
              });
            }
          });
          
          // å®æ—¶æ›´æ–°å·¥å…·æç¤ºï¼ˆç¡®ä¿é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæœ€æ–°çš„æ•°é‡ï¼‰
          updateTooltipOnHover();
          
          console.log('å·¦ä¾§æ å¡ç‰Œæ•°é‡å·²æ›´æ–°');
        } catch (error) {
          console.error('æ›´æ–°å·¦ä¾§æ å¡ç‰Œæ•°é‡æ—¶å‡ºé”™:', error);
        }
      }
      
      // æ›´æ–°å¡ç‰Œå¯è§æ€§
      function updateCardVisibility(card, amount, name) {
        // å¦‚æœæ•°é‡ä¸º0ï¼Œå®Œå…¨éšè—å¡ç‰Œ
        if (amount <= 0) {
          card.style.display = 'none';
          card.classList.add('hidden');
          card.style.visibility = 'hidden';
          card.style.opacity = '0';
          card.style.pointerEvents = 'none';
        } else {
          card.style.display = 'flex';
          card.classList.remove('hidden');
          card.style.visibility = 'visible';
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
        }
      }
      
      // å®æ—¶æ›´æ–°å·¥å…·æç¤ºä¸­çš„æ•°é‡ä¿¡æ¯ï¼ˆé¼ æ ‡æ‚¬åœæ—¶è°ƒç”¨ï¼‰
      function updateTooltipOnHover() {
        // å®šä¹‰éœ€è¦ç¦ç”¨tooltipçš„èµ„æºç±»å‹ï¼ˆç§æ¤ç”¨å“ï¼Œæ’é™¤empty_bucketï¼Œå®ƒåªæ˜¯bucketçš„å¼•ç”¨ï¼‰
        const tooltipDisabledResources = ['bucket', 'empty_waterskin', 'waterskin', 'fertilizer'];
        
        // ä¸ºæ‰€æœ‰å·¦ä¾§æ å¡ç‰Œæ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶
        const leftPanelCards = document.querySelectorAll('.crafting-inventory-card');
        
        leftPanelCards.forEach(card => {
          // æ£€æŸ¥æ˜¯å¦ä¸ºç§æ¤ç”¨å“ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
          const resourceType = card.dataset.resourceType;
          const isPlantingSupply = resourceType && tooltipDisabledResources.includes(resourceType);
          
          if (isPlantingSupply) {
            // ç§æ¤ç”¨å“ï¼šç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿ä¸æ˜¾ç¤ºtooltip
            card.removeEventListener('mouseenter', updateCardTooltip);
            card.removeEventListener('mouseleave', hideAllTooltips);
            // ç§»é™¤titleå±æ€§ï¼Œé˜²æ­¢æµè§ˆå™¨é»˜è®¤tooltip
            card.removeAttribute('title');
            return; // è·³è¿‡ï¼Œä¸æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
          }
          
          // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
          card.removeEventListener('mouseenter', updateCardTooltip);
          card.removeEventListener('mouseleave', hideAllTooltips);
          
          // æ·»åŠ æ–°çš„é¼ æ ‡æ‚¬åœäº‹ä»¶
          card.addEventListener('mouseenter', updateCardTooltip);
          card.addEventListener('mouseleave', hideAllTooltips);
        });
      }
      
      // æ›´æ–°å•ä¸ªå¡ç‰Œçš„å·¥å…·æç¤º
      function updateCardTooltip(event) {
        const card = event.currentTarget;
        const seedType = card.dataset.seedType;
        const resourceType = card.dataset.resourceType;
        
        if (seedType) {
          // ç§å­å¡ç‰Œ - ä½¿ç”¨è‡ªå®šä¹‰å·¥å…·æç¤º
          hideSeedTooltip(); // å…ˆéšè—å¯èƒ½å­˜åœ¨çš„æ—§æç¤º
          const seed = farmlandData.seeds[seedType];
          const seedAmount = gameData.resources[seedType]?.amount || 0;
          showSeedTooltip(card, seed, seedAmount);
        } else if (resourceType) {
          // èµ„æºå¡ç‰Œ
          hideResourceTooltip(); // å…ˆéšè—å¯èƒ½å­˜åœ¨çš„æ—§æç¤º
          const resource = gameData.resources[resourceType];
          if (resource) {
            showResourceTooltip(card, resource);
          }
        }
      }
      
      // showResourceTooltip å’Œ hideResourceTooltip å‡½æ•°å·²ç§»åŠ¨åˆ°å…¨å±€ä½œç”¨åŸŸå®šä¹‰ä½ç½®
      
      // éšè—æ‰€æœ‰å·¥å…·æç¤º
      function hideAllTooltips() {
        hideResourceTooltip();
        // å¦‚æœæœ‰å…¶ä»–ç±»å‹çš„å·¥å…·æç¤ºï¼Œä¹Ÿåœ¨è¿™é‡Œæ·»åŠ éšè—é€»è¾‘
      }
      
      // showFarmlandTooltip å‡½æ•°å·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œä¸å†é‡å¤å®šä¹‰
      
      // hideFarmlandTooltip å‡½æ•°å·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œä¸å†é‡å¤å®šä¹‰
      
      // æ›´æ–°æ‰€æœ‰å†œç”°æ ¼å­çš„æ˜¾ç¤º
      function updateFarmlandDisplay() {
        // ç›´æ¥ä» gameData è·å–æœ€æ–°çš„å†œç”°æ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
        const farmlandData = gameData.farmlandData;
        if (!farmlandData || !farmlandData.cells) return;
        
        const farmlandCells = document.querySelectorAll('.farmland-cell');
        farmlandCells.forEach(cell => {
          const cellId = parseInt(cell.dataset.cellId);
          const cellData = farmlandData.cells[cellId];
          
          // å®šä¹‰å†œç”°æ ¼å­è§£é”è§„åˆ™
          const unlockRules = {
            1: [0, 1],
            2: [0, 1, 2, 3],
            3: [0, 1, 2, 3, 4, 5],
            4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
          };

          const level = farmlandData.level || 1;
          const unlockedCells = unlockRules[level] || unlockRules[1];
          const isUnlocked = unlockedCells.includes(cellId);
          
          // å¦‚æœæœªè§£é”ï¼Œä¸æ›´æ–°æ˜¾ç¤ºï¼ˆä¿æŒé”å®šçŠ¶æ€ï¼‰
          if (!isUnlocked) {
            // ç¡®ä¿æœ‰é”å®šå›¾æ ‡
            if (!cell.querySelector('.farmland-lock-icon')) {
              const lockIcon = document.createElement('div');
              lockIcon.className = 'farmland-lock-icon';
              lockIcon.innerHTML = 'ğŸ”’';
              cell.appendChild(lockIcon);
            }
            // ç¡®ä¿æœ‰é”å®šæ–‡æœ¬
            if (!cell.querySelector('.farmland-lock-text')) {
              const lockText = document.createElement('div');
              lockText.className = 'farmland-lock-text';
              const requiredLevelMap = {
                0: 1, 1: 1,
                2: 2, 3: 2,
                4: 3, 5: 3,
                6: 4, 7: 4, 8: 4
              };
              const requiredLevel = requiredLevelMap[cellId];
              lockText.textContent = `${requiredLevel}çº§è§£é”`;
              cell.appendChild(lockText);
            }
            return;
          }
          
          // é‡æ–°æ¸²æŸ“æ ¼å­å†…å®¹
          cell.innerHTML = '';
          
          // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
          const statusDiv = document.createElement('div');
          statusDiv.className = 'farmland-cell-status';
          
          // æ·»åŠ æŒ‡ç¤ºå™¨
          const indicatorsDiv = document.createElement('div');
          indicatorsDiv.className = 'farmland-cell-indicators';
          
          // æ¹¿æ¶¦åº¦æŒ‡ç¤ºå™¨
          const moistureIndicator = document.createElement('div');
          moistureIndicator.className = 'farmland-cell-indicator';
          moistureIndicator.innerHTML = `ğŸ’§ ${cellData.moisture}`;
          
          // è‚¥æ²ƒåº¦æŒ‡ç¤ºå™¨
          const fertilityIndicator = document.createElement('div');
          fertilityIndicator.className = 'farmland-cell-indicator';
          fertilityIndicator.innerHTML = `ğŸŒ± ${cellData.fertility}`;
          
          indicatorsDiv.appendChild(moistureIndicator);
          indicatorsDiv.appendChild(fertilityIndicator);
          
          if (cellData.crop === null) {
            // ç©ºé—²çŠ¶æ€
            statusDiv.textContent = 'ç©ºé—²';
          } else {
            // æ˜¾ç¤ºä½œç‰©
            const cropImage = document.createElement('div');
            cropImage.className = 'crop-image';
            
            // è®¡ç®—ç”Ÿé•¿é˜¶æ®µ
            const currentDay = gameData.day || 1;
            const daysSincePlanted = cellData.plantedDay ? currentDay - cellData.plantedDay : 0;
            const seed = farmlandData.seeds[cellData.crop];
            
            // æ—©æœŸ(1-2å¤©): é˜¶æ®µ1, ä¸­æœŸ(3-4å¤©): é˜¶æ®µ2, æˆç†ŸæœŸ(5-6å¤©): é˜¶æ®µ3
            if (daysSincePlanted <= 2) {
              cellData.growthStage = 1;
              statusDiv.textContent = 'æ—©æœŸ';
              cropImage.style.backgroundImage = `url('${seed.stages[0]}')`;
            } else if (daysSincePlanted <= 4) {
              cellData.growthStage = 2;
              statusDiv.textContent = 'ä¸­æœŸ';
              cropImage.style.backgroundImage = `url('${seed.stages[1]}')`;
            } else if (daysSincePlanted >= 5) {
              cellData.growthStage = 3;
              statusDiv.textContent = 'æˆç†ŸæœŸ';
              cropImage.style.backgroundImage = `url('${seed.stages[2]}')`;
              
              // æ·»åŠ æˆç†Ÿæ ‡è®°
              const readyMark = document.createElement('div');
              readyMark.className = 'ready-to-harvest';
              readyMark.innerHTML = 'â­';
              cell.appendChild(readyMark);
              
              // ä¸ºæˆç†Ÿä½œç‰©æ·»åŠ æ‚¬åœæ•ˆæœ
              cell.classList.add('ready-for-harvest');
              cell.classList.add('harvest-cursor');
            }
            
            cell.appendChild(cropImage);
          }
          
          cell.appendChild(statusDiv);
          cell.appendChild(indicatorsDiv);
        });
      }
      
      // å°† updateFarmlandDisplay å‡½æ•°èµ‹å€¼åˆ° windowï¼Œä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨
      window.updateFarmlandDisplay = updateFarmlandDisplay;
      
      // åˆ›å»ºå†œç”°æ ¼å­å‡½æ•°
      function createFarmlandCell(index, cellData) {
        const farmlandCell = document.createElement('div');
        farmlandCell.className = 'farmland-cell';
        farmlandCell.id = `farmland-cell-${index}`; // æ·»åŠ idå±æ€§ï¼Œä¾›plantCropå‡½æ•°ä½¿ç”¨
        farmlandCell.dataset.cellId = index;

        // å®šä¹‰å†œç”°æ ¼å­è§£é”è§„åˆ™
        // 1çº§ï¼šè§£é”æ ¼å­0ã€1ï¼ˆ1-1ã€1-2ï¼‰
        // 2çº§ï¼šè§£é”æ ¼å­2ã€3ï¼ˆ1-3ã€2-1ï¼‰
        // 3çº§ï¼šè§£é”æ ¼å­4ã€5ï¼ˆ2-2ã€2-3ï¼‰
        // 4çº§ï¼šè§£é”æ ¼å­6ã€7ã€8ï¼ˆ3-1ã€3-2ã€3-3ï¼‰
        const unlockRules = {
          1: [0, 1],
          2: [0, 1, 2, 3],
          3: [0, 1, 2, 3, 4, 5],
          4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
        };

        const level = farmlandData.level || 1;
        const unlockedCells = unlockRules[level] || unlockRules[1];
        const isUnlocked = unlockedCells.includes(index);

        // å¦‚æœæœªè§£é”ï¼Œæ·»åŠ é”å®šæ ·å¼å’Œæ ‡è®°
        if (!isUnlocked) {
          farmlandCell.classList.add('farmland-cell-locked');
          const lockIcon = document.createElement('div');
          lockIcon.className = 'farmland-lock-icon';
          lockIcon.innerHTML = 'ğŸ”’';
          farmlandCell.appendChild(lockIcon);

          const lockText = document.createElement('div');
          lockText.className = 'farmland-lock-text';
          // è®¡ç®—æ¯ä¸ªæ ¼å­æ‰€éœ€çš„è§£é”ç­‰çº§
          const requiredLevelMap = {
            0: 1, 1: 1,
            2: 2, 3: 2,
            4: 3, 5: 3,
            6: 4, 7: 4, 8: 4
          };
          const requiredLevel = requiredLevelMap[index];
          lockText.textContent = `${requiredLevel}çº§è§£é”`;
          farmlandCell.appendChild(lockText);

          // æœªè§£é”çš„æ ¼å­ç¦ç”¨æ‚¬åœå’Œæ‹–æ”¾äº‹ä»¶
          farmlandCell.style.pointerEvents = 'none';
          return farmlandCell;
        }

        // å·²è§£é”çš„æ ¼å­å¯ç”¨é¼ æ ‡äº‹ä»¶
        farmlandCell.style.pointerEvents = 'auto';

        // æ›´æ–°å†œç”°æ ¼å­æ˜¾ç¤º
        function updateCellDisplay() {
          // ä» gameData.farmlandData.cells è¯»å–æœ€æ–°æ•°æ®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é—­åŒ…ä¸­çš„æ—§æ•°æ®
          const latestCellData = gameData.farmlandData.cells[index];
          if (!latestCellData) return;
          
          // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
          farmlandCell.innerHTML = '';
          
          // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
          const statusDiv = document.createElement('div');
          statusDiv.className = 'farmland-cell-status';
          
          // æ·»åŠ æŒ‡ç¤ºå™¨
          const indicatorsDiv = document.createElement('div');
          indicatorsDiv.className = 'farmland-cell-indicators';
          
          // æ¹¿æ¶¦åº¦æŒ‡ç¤ºå™¨
          const moistureIndicator = document.createElement('div');
          moistureIndicator.className = 'farmland-cell-indicator';
          moistureIndicator.innerHTML = `ğŸ’§ ${latestCellData.moisture}`;
          
          // è‚¥æ²ƒåº¦æŒ‡ç¤ºå™¨
          const fertilityIndicator = document.createElement('div');
          fertilityIndicator.className = 'farmland-cell-indicator';
          fertilityIndicator.innerHTML = `ğŸŒ± ${latestCellData.fertility}`;
          
          indicatorsDiv.appendChild(moistureIndicator);
          indicatorsDiv.appendChild(fertilityIndicator);
          
          if (latestCellData.crop === null) {
            // ç©ºé—²çŠ¶æ€
            statusDiv.textContent = 'ç©ºé—²';
          } else {
            // æ˜¾ç¤ºä½œç‰©
            const cropImage = document.createElement('div');
            cropImage.className = 'crop-image';
            
            // è®¡ç®—ç”Ÿé•¿é˜¶æ®µ
            const currentDay = gameData.day || 1;
            const daysSincePlanted = latestCellData.plantedDay ? currentDay - latestCellData.plantedDay : 0;
            const seed = farmlandData.seeds[latestCellData.crop];
            
            // æ—©æœŸ(1-2å¤©): é˜¶æ®µ1, ä¸­æœŸ(3-4å¤©): é˜¶æ®µ2, æˆç†ŸæœŸ(5-6å¤©): é˜¶æ®µ3
            if (daysSincePlanted <= 2) {
              latestCellData.growthStage = 1;
              statusDiv.textContent = 'æ—©æœŸ';
              cropImage.style.backgroundImage = `url('${seed.stages[0]}')`;
            } else if (daysSincePlanted <= 4) {
              latestCellData.growthStage = 2;
              statusDiv.textContent = 'ä¸­æœŸ';
              cropImage.style.backgroundImage = `url('${seed.stages[1]}')`;
            } else if (daysSincePlanted >= 5) {
              latestCellData.growthStage = 3;
              statusDiv.textContent = 'æˆç†ŸæœŸ';
              cropImage.style.backgroundImage = `url('${seed.stages[2]}')`;
              
              // æ·»åŠ æˆç†Ÿæ ‡è®°
              const readyMark = document.createElement('div');
              readyMark.className = 'ready-to-harvest';
              readyMark.innerHTML = 'â­';
              farmlandCell.appendChild(readyMark);
              
              // ä¸ºæˆç†Ÿä½œç‰©æ·»åŠ æ‚¬åœæ•ˆæœ
              farmlandCell.classList.add('ready-for-harvest');
              farmlandCell.classList.add('harvest-cursor');
            }
            
            farmlandCell.appendChild(cropImage);
          }
          
          farmlandCell.appendChild(statusDiv);
          farmlandCell.appendChild(indicatorsDiv);
        }
        
        // åˆå§‹åŒ–æ˜¾ç¤º
        updateCellDisplay();
        
        // æ·»åŠ æ‚¬åœäº‹ä»¶ - è®¾ç½®0.5ç§’å»¶è¿Ÿï¼ˆä»…å¯¹å·²è§£é”æ ¼å­æœ‰æ•ˆï¼‰
        let hoverTimeout;
        farmlandCell.addEventListener('mouseenter', function() {
          // æ£€æŸ¥æ ¼å­æ˜¯å¦å·²è§£é”
          const unlockRules = {
            1: [0, 1],
            2: [0, 1, 2, 3],
            3: [0, 1, 2, 3, 4, 5],
            4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
          };
          const level = farmlandData.level || 1;
          const unlockedCells = unlockRules[level] || unlockRules[1];
          const isUnlocked = unlockedCells.includes(index);
          if (!isUnlocked) {
            return; // æœªè§£é”çš„æ ¼å­ä¸æ˜¾ç¤ºæ‚¬åœæç¤º
          }

          // ç¡®ä¿æ²¡æœ‰æœªæ‰§è¡Œçš„æ‚¬åœå®šæ—¶å™¨
          if (hoverTimeout) {
            clearTimeout(hoverTimeout);
          }

          // è®¾ç½®æ–°çš„æ‚¬åœå®šæ—¶å™¨
          hoverTimeout = setTimeout(() => {
            // å†æ¬¡éªŒè¯é¼ æ ‡æ˜¯å¦è¿˜åœ¨å…ƒç´ ä¸Š
            if (farmlandCell.matches(':hover')) {
              showFarmlandTooltip(farmlandCell, cellData, index); // cellData å‚æ•°ä¼šè¢«å¿½ç•¥ï¼Œå‡½æ•°å†…éƒ¨ä½¿ç”¨æœ€æ–°æ•°æ® // cellData å‚æ•°ä¼šè¢«å¿½ç•¥ï¼Œå‡½æ•°å†…éƒ¨ä½¿ç”¨æœ€æ–°æ•°æ®
            }
          }, 500); // 500æ¯«ç§’å»¶è¿Ÿ
        });

        farmlandCell.addEventListener('mouseleave', function() {
          // æ£€æŸ¥æ ¼å­æ˜¯å¦å·²è§£é”
          const unlockRules = {
            1: [0, 1],
            2: [0, 1, 2, 3],
            3: [0, 1, 2, 3, 4, 5],
            4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
          };
          const level = farmlandData.level || 1;
          const unlockedCells = unlockRules[level] || unlockRules[1];
          const isUnlocked = unlockedCells.includes(index);
          if (!isUnlocked) {
            return; // æœªè§£é”çš„æ ¼å­ä¸å¤„ç†
          }

          // æ¸…é™¤å»¶è¿Ÿæ˜¾ç¤ºçš„å®šæ—¶å™¨
          if (hoverTimeout) {
            clearTimeout(hoverTimeout);
            hoverTimeout = null;
          }
          // ç«‹å³éšè—æç¤ºæ¡†
          hideFarmlandTooltip();
        });

        // æ‚¬åœäº‹ä»¶ - å½“é€‰æ‹©äº†ç§å­æ—¶ï¼Œæ˜¾ç¤ºé«˜äº®æ•ˆæœ
        farmlandCell.addEventListener('mouseenter', function() {
          // æ£€æŸ¥æ ¼å­æ˜¯å¦å·²è§£é”
          const isUnlocked = isCellUnlocked(index);
          if (!isUnlocked) {
            console.log(`æ ¼å­ ${index} æœªè§£é”ï¼Œä¸æ˜¾ç¤ºé«˜äº®`);
            return;
          }

          // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç§å­
          if (!window.selectedSeed) {
            return;
          }

          // å¦‚æœæ ¼å­å·²ç§æ¤ä½œç‰©ï¼Œä¸æ˜¾ç¤ºé«˜äº®
          if (cellData.crop !== null) {
            return;
          }

          console.log(`æ ¼å­ ${index} æ˜¾ç¤ºé«˜äº®æ•ˆæœ`);
          // æ˜¾ç¤ºè„‰å†²å…‰æ™•æ•ˆæœ
          farmlandCell.classList.add('highlight', 'pulse-glow');
        });

        farmlandCell.addEventListener('mouseleave', function() {
          farmlandCell.classList.remove('highlight', 'pulse-glow');
        });

        // ç‚¹å‡»äº‹ä»¶ - ç§æ¤ã€ä½¿ç”¨å·¥å…·æˆ–æ”¶è·
        farmlandCell.addEventListener('click', function(e) {
          console.log(`å†œç”°æ ¼å­ ${index} è¢«ç‚¹å‡»`);
          e.stopPropagation();

          // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç§å­è¿›è¡Œç§æ¤
          if (window.selectedSeed && farmlandData.seeds[window.selectedSeed] && cellData.crop === null) {
            console.log('å°è¯•ç§æ¤ç§å­:', window.selectedSeed);
            const seedKey = window.selectedSeed;
            const seedAmount = gameData.resources[seedKey]?.amount || 0;

            console.log('ç§å­æ•°é‡:', seedAmount);

            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç§å­
            if (seedAmount <= 0) {
              console.log('ç§å­æ•°é‡ä¸è¶³');
              showNotification('ç§å­ä¸è¶³', `ä½ æ²¡æœ‰${farmlandData.seeds[seedKey].name}ï¼`);
              // æ¸…é™¤ç§å­é€‰æ‹©
              window.selectedSeed = null;
              clearSeedCursor();
              // æ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
              if (window.updateSeedCards) {
                window.updateSeedCards();
              }
              return;
            }

            // ä½¿ç”¨plantCropå‡½æ•°ç§æ¤ç§å­
            console.log('è°ƒç”¨ plantCrop å‡½æ•°');
            if (plantCrop(index, seedKey)) {
              console.log('plantCrop è¿”å› trueï¼Œç§æ¤æˆåŠŸ');
              // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
              setTimeout(() => {
                // æ›´æ–°æ˜¾ç¤º
                updateCellDisplay();

                // æ›´æ–°ç§å­å¡ç‰Œæ•°é‡æ˜¾ç¤º
                const seedCards = document.querySelectorAll('.crafting-inventory-card');
                seedCards.forEach(card => {
                  if (card.dataset.seedType === seedKey) {
                    const nameDiv = card.querySelector('.crafting-card-title');
                    if (nameDiv) {
                      nameDiv.textContent = `${farmlandData.seeds[seedKey].name} Ã— ${gameData.resources[seedKey].amount}`;
                    }
                    card.classList.remove('selected');
                  }
                });

                // æ›´æ–°ä¸»é¡µèƒŒåŒ…æ ä¸­çš„èµ„æºå¡ç‰Œ
                updateMainResourceCard(seedKey);

                // è§¦å‘æ”¾ç½®ç‰¹æ•ˆ
                window.triggerPlaceAnimation(farmlandCell, 'seed');

                showNotification('ç§æ¤æˆåŠŸ', `æˆåŠŸç§æ¤äº†${farmlandData.seeds[seedKey].name}ï¼`);
                renderResources();
                updateGameData();

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™ç§å­
                if (gameData.resources[seedKey]?.amount > 0) {
                  // æ›´æ–°è‡ªå®šä¹‰å…‰æ ‡çš„æ•°é‡æ˜¾ç¤º
                  const countIndicator = document.getElementById('seed-count-indicator');
                  if (countIndicator) {
                    countIndicator.textContent = gameData.resources[seedKey].amount;
                  }
                } else {
                  // ç§å­ç”¨å®Œäº†ï¼Œæ¸…é™¤å…‰æ ‡å’Œé€‰æ‹©
                  window.selectedSeed = null;
                  clearSeedCursor();
                }
              }, 300);
            } else {
              console.log('plantCrop è¿”å› falseï¼Œç§æ¤å¤±è´¥');
            }
            return;
          }

          // å¤„ç†å·¥å…·ä½¿ç”¨
          if (window.selectedTool === 'water') {
            // æµ‡æ°´
            const waterAmount = gameData.resources.water?.amount || 0;
            if (waterAmount > 0) {
              gameData.resources.water.amount -= 1;
              cellData.moisture = Math.min(100, cellData.moisture + 100); // ä¸€æ¡¶æ°´å¢åŠ 100æ¹¿æ¶¦åº¦

              // è·å–æ ¼å­å…ƒç´ å¹¶æ·»åŠ æµ‡æ°´åŠ¨ç”»
              const cellElement = document.getElementById(`farmland-cell-${cellId}`);
              if (cellElement) {
                cellElement.classList.add('water-animation');

                // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
                if (!window.createWaterEffect || !window.createWaterFloatingText) {
                  if (typeof initializeAnimationCSS === 'function') {
                    initializeAnimationCSS();
                  }
                  if (typeof initializeAnimationEffects === 'function') {
                    initializeAnimationEffects();
                  }
                }

                // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
                if (window.createWaterEffect) {
                  window.createWaterEffect(cellElement);
                }
                if (window.createWaterFloatingText) {
                  window.createWaterFloatingText(cellElement);
                }

                // 1500msåç§»é™¤åŠ¨ç”»ç±»
                setTimeout(() => {
                  cellElement.classList.remove('water-animation');
                }, 1500);
              }

              // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
              setTimeout(() => {
                updateCellDisplay();
                renderResources();
                updateGameData();
              }, 1500);

              showNotification('æµ‡æ°´æˆåŠŸ', 'æ¹¿æ¶¦åº¦å¢åŠ äº†100ï¼');
            } else {
              showNotification('æ°´èµ„æºä¸è¶³', 'ä½ æ²¡æœ‰æ°´ï¼');
            }
          } else if (window.selectedTool === 'fertilizer') {
            // æ–½è‚¥
            const fertilizerAmount = gameData.resources.fertilizer?.amount || 0;
            if (fertilizerAmount > 0) {
              gameData.resources.fertilizer.amount -= 1;
              cellData.fertility = Math.min(100, cellData.fertility + 50); // 1ä¸ªè‚¥æ–™å¢åŠ 50è‚¥æ²ƒåº¦
              updateCellDisplay();
              renderResources();
              updateGameData();
              // æ›´æ–°å†œç”°çª—å£ä¸­çš„ç›¸å…³èµ„æºå¡ç‰Œ
              if (window.updateFarmlandRelatedResources) {
                window.updateFarmlandRelatedResources();
              }
              showNotification('æ–½è‚¥æˆåŠŸ', 'è‚¥æ²ƒåº¦å¢åŠ äº†50ï¼');
            } else {
              showNotification('è‚¥æ–™ä¸è¶³', 'ä½ æ²¡æœ‰è‚¥æ–™ï¼');
            }
          } else if (cellData.growthStage === 3) {
            // æ”¶è·ä½œç‰©
            const seed = farmlandData.seeds[cellData.crop];
            let rewardCount = 1;
            
            // æ ¹æ®æ¹¿æ¶¦åº¦å’Œè‚¥æ²ƒåº¦è®¡ç®—æ”¶è·é‡
            if (cellData.moisture >= 80 && cellData.fertility >= 80) {
              rewardCount = seed.rewardCount[2]; // æœ€é«˜æ”¶è·é‡
            } else if (cellData.moisture >= 50 && cellData.fertility >= 50) {
              rewardCount = seed.rewardCount[1]; // ä¸­ç­‰æ”¶è·é‡
            } else {
              rewardCount = seed.rewardCount[0]; // æœ€ä½æ”¶è·é‡
            }
            
            // æ·»åŠ å¥–åŠ±åˆ°èµ„æº
            if (!gameData.resources[seed.reward]) {
              gameData.resources[seed.reward] = { name: '', description: '', amount: 0 };
            }
            gameData.resources[seed.reward].amount += rewardCount;
            
            // å¦‚æœæ˜¯å°éº¦æˆ–æ°´ç¨»ï¼Œé¢å¤–äº§å‡º2å¼ è‰æ–™å¡ç‰Œ
            if (cellData.crop === 'wheat_seed' || cellData.crop === 'rice_seed') {
              if (!gameData.resources['grass_feed']) {
                gameData.resources['grass_feed'] = { 
                  name: 'è‰æ–™', 
                  description: 'é©¬åŒ¹å–œçˆ±çš„è‰æ–™ï¼Œå¯ä»¥ç»´æŒé©¬åŒ¹çš„é¥±é£Ÿåº¦',
                  amount: 0,
                  image: 'UI/è‰æ–™.jpg',
                  category: 'material'
                };
              }
              gameData.resources['grass_feed'].amount += 2;
              showNotification('é¢å¤–æ”¶è·', `æ”¶è·äº†2å¼ è‰æ–™å¡ç‰Œï¼`);
            }
            
            // å¦‚æœæ”¶è·çš„æ˜¯ç§å­ï¼Œæ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
            // æ£€æŸ¥æ”¶è·çš„ç‰©å“æ˜¯å¦æ˜¯ç§å­èµ„æºä¹‹ä¸€
            if (window.updateSeedCards && Object.keys(farmlandData.seeds).includes(seed.reward)) {
              window.updateSeedCards();
            }
            
            // æ˜¾ç¤ºæ”¶è·åŠ¨ç”»
            const harvestAnim = document.createElement('div');
            harvestAnim.className = 'harvest-animation harvest-success';
            harvestAnim.innerHTML = `<div style="font-weight: bold; color: #4CAF50;">+${rewardCount} ${seed.name.replace('ç§å­', '')}</div>`;
            farmlandCell.appendChild(harvestAnim);
            
            // ç«‹å³é‡ç½®å†œç”°æ ¼å­ï¼Œè®©ä½œç‰©å¿«é€Ÿæ¶ˆå¤±
            cellData.crop = null;
            cellData.growthStage = 0;
            cellData.plantedDay = null;
            cellData.moisture = 0;
            cellData.fertility = 50;
            updateCellDisplay();
            
            // çŸ­æš‚å»¶è¿Ÿåç§»é™¤åŠ¨ç”»æ•ˆæœ
            setTimeout(() => {
              if (harvestAnim.parentNode) {
                harvestAnim.parentNode.removeChild(harvestAnim);
              }
            }, 300);
            
            showNotification('æ”¶è·æˆåŠŸ', `æ”¶è·äº†${rewardCount}ä¸ª${seed.name.replace('ç§å­', '')}ï¼`);
            renderResources();
            updateGameData();
          }
        });
        
        return farmlandCell;
      }
      
      // åœ¨å†œç”°ç®¡ç†çª—å£æ‰“å¼€åç«‹å³åˆå§‹åŒ–å·¥å…·æç¤ºæ›´æ–°åŠŸèƒ½
      updateTooltipOnHover();
    }

    // æ˜¾ç¤ºå†œç”°å‡çº§æ¨¡æ€æ¡†
    function showFarmlandUpgradeModal() {
      const currentLevel = farmlandData.level || 1;

      // å·²è¾¾æœ€é«˜ç­‰çº§ï¼Œä¸å…è®¸å‡çº§
      if (currentLevel >= 4) {
        showNotification('å‡çº§æç¤º', 'å†œç”°å·²è¾¾æœ€é«˜ç­‰çº§ï¼');
        return;
      }

      // å‡çº§æ‰€éœ€èµ„æº
      const upgradeCosts = {
        1: { soil: 20, fertilizer: 20 },  // 1çº§å‡2çº§
        2: { soil: 50, fertilizer: 50 },  // 2çº§å‡3çº§
        3: { soil: 100, fertilizer: 100 }  // 3çº§å‡4çº§
      };

      const requiredResources = upgradeCosts[currentLevel];

      // å®šä¹‰æ¯çº§è§£é”çš„æ ¼å­æè¿°
      const unlockDesc = {
        1: '1-1ã€1-2',
        2: '1-3ã€2-1',
        3: '2-2ã€2-3',
        4: '3-1ã€3-2ã€3-3'
      };

      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'farmland-upgrade-modal';
      modalContainer.id = 'farmlandUpgradeModal';

      // åˆ›å»ºå¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'farmland-upgrade-modal-content ink-border';

      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'farmland-upgrade-modal-header';

      const title = document.createElement('h2');
      title.className = 'farmland-upgrade-modal-title ink-text';
      title.textContent = 'å†œç”°å‡çº§';
      modalHeader.appendChild(title);

      const closeButton = document.createElement('button');
      closeButton.className = 'farmland-upgrade-modal-close';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = function() {
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      modalHeader.appendChild(closeButton);

      modalContent.appendChild(modalHeader);

      // åˆ›å»ºå†…å®¹åŒºåŸŸ
      const modalBody = document.createElement('div');
      modalBody.className = 'farmland-upgrade-modal-body';

      // å½“å‰ç­‰çº§å’Œä¸‹ä¸€çº§æ˜¾ç¤º
      const levelDisplay = document.createElement('div');
      levelDisplay.className = 'farmland-level-display';

      levelDisplay.innerHTML = `
        <div class="current-level-text">å½“å‰ç­‰çº§ï¼š${currentLevel}çº§</div>
        <div class="next-level-text">å‡çº§åè§£é”ï¼š${currentLevel + 1}çº§ï¼ˆ${unlockDesc[currentLevel + 1]}ï¼‰</div>
        <div class="level-indicator">
          ${[1,2,3,4].map(level => `
            <div class="level-dot ${level <= currentLevel ? 'active' : ''}">${level}</div>
          `).join('')}
        </div>
      `;
      modalBody.appendChild(levelDisplay);

      // å‡çº§æ‰€éœ€èµ„æºæ˜¾ç¤º
      const resourcesDisplay = document.createElement('div');
      resourcesDisplay.className = 'upgrade-resources';

      const soilNeeded = requiredResources.soil;
      const fertilizerNeeded = requiredResources.fertilizer;
      const soilOwned = gameData.resources['soil']?.amount || 0;
      const fertilizerOwned = gameData.resources['fertilizer']?.amount || 0;

      resourcesDisplay.innerHTML = `
        <div class="resource-item ${soilOwned >= soilNeeded ? 'sufficient' : 'insufficient'}">
          <span class="resource-name">åœŸå£¤</span>
          <span class="resource-amount">${soilOwned}/${soilNeeded}</span>
        </div>
        <div class="resource-item ${fertilizerOwned >= fertilizerNeeded ? 'sufficient' : 'insufficient'}">
          <span class="resource-name">è‚¥æ–™</span>
          <span class="resource-amount">${fertilizerOwned}/${fertilizerNeeded}</span>
        </div>
      `;
      modalBody.appendChild(resourcesDisplay);

      // å‡çº§æŒ‰é’®
      const upgradeButton = document.createElement('button');
      upgradeButton.className = 'farmland-upgrade-button';
      upgradeButton.textContent = `å‡çº§åˆ°${currentLevel + 1}çº§`;

      const canUpgrade = soilOwned >= soilNeeded && fertilizerOwned >= fertilizerNeeded;
      if (!canUpgrade) {
        upgradeButton.disabled = true;
        upgradeButton.classList.add('disabled');
      }

      upgradeButton.onclick = function() {
        if (canUpgrade) {
          console.log('å¼€å§‹å‡çº§å†œç”°...');

          // æ¶ˆè€—èµ„æº
          gameData.resources['soil'].amount -= soilNeeded;
          gameData.resources['fertilizer'].amount -= fertilizerNeeded;

          // å‡çº§
          const oldLevel = farmlandData.level || 1;
          farmlandData.level = currentLevel + 1;
          console.log(`å†œç”°ä» ${oldLevel} çº§å‡çº§åˆ° ${farmlandData.level} çº§`);

          // å…³é”®ä¿®å¤ï¼šç¡®ä¿ gameData.farmlandData ä¸ farmlandData ä¿æŒåŒæ­¥
          gameData.farmlandData = farmlandData;

          // æ›´æ–°å‡çº§æŒ‰é’®æ˜¾ç¤º
          const levelText = document.getElementById('farmland-level-text');
          if (levelText) {
            levelText.textContent = `${farmlandData.level}çº§`;
          }

          // å…³é—­å‡çº§æ¨¡æ€æ¡†ï¼ˆå…ˆå…³é—­å‡çº§æ¨¡æ€æ¡†ï¼Œå†æ›´æ–°å†œç”°æ ¼å­ï¼‰
          modalContainer.classList.remove('active');

          // ç­‰å¾…æ¨¡æ€æ¡†å…³é—­åŠ¨ç”»å®Œæˆåï¼Œå†æ›´æ–°å†œç”°æ ¼å­
          setTimeout(() => {
            modalContainer.remove();

            console.log('å‡çº§æ¨¡æ€æ¡†å·²å…³é—­ï¼Œå¼€å§‹æ›´æ–°å†œç”°æ ¼å­...');
            console.log('å½“å‰ farmlandData.level:', farmlandData.level);

            // é‡æ–°æ¸²æŸ“å†œç”°æ ¼å­ï¼ˆç¡®ä¿å‡çº§æ¨¡æ€æ¡†å·²å®Œå…¨å…³é—­ï¼‰
            updateAllFarmlandCells();

            // æ¸…é™¤å¯èƒ½çš„æ—§çŠ¶æ€
            window.selectedSeed = null;
            window.selectedTool = null;

            // æ¸…é™¤è‡ªå®šä¹‰å…‰æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (typeof clearSeedCursor === 'function') {
              clearSeedCursor();
            }

            // åˆ·æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
            if (window.updateSeedCards) {
              window.updateSeedCards();
            }

            // åˆ·æ–°ç§æ¤ç”¨å“å¡ç‰Œæ˜¾ç¤ºï¼ˆä¿®å¤å‡çº§åé‡æ–°æ‰“å¼€çª—å£æ—¶ç§æ¤ç”¨å“æ¶ˆå¤±çš„é—®é¢˜ï¼‰
            if (window.updateFarmlandRelatedResources) {
              window.updateFarmlandRelatedResources();
            }

            showNotification('å‡çº§æˆåŠŸ', `å†œç”°å‡çº§åˆ°${farmlandData.level}çº§ï¼è§£é”äº†${unlockDesc[farmlandData.level]}æ ¼å­ï¼`);

            renderResources();
            updateGameData();
          }, 300);
        }
      };
      modalBody.appendChild(upgradeButton);

      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);

      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .farmland-upgrade-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }

        .farmland-upgrade-modal.active {
          opacity: 1;
          visibility: visible;
        }

        .farmland-upgrade-modal-content {
          background-color: #FFFDF7;
          border-radius: 0.25rem;
          width: 90%;
          max-width: 500px;
          padding: 1.5rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          transform: translateY(-20px);
          transition: all 0.3s ease;
        }

        .farmland-upgrade-modal.active .farmland-upgrade-modal-content {
          transform: translateY(0);
        }

        .farmland-upgrade-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
        }

        .farmland-upgrade-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #2D3748;
          margin: 0;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .farmland-upgrade-modal-close {
          background: none;
          border: none;
          font-size: 1.75rem;
          color: #4A5568;
          cursor: pointer;
          transition: color 0.2s;
        }

        .farmland-upgrade-modal-close:hover {
          color: #2D3748;
        }

        .farmland-upgrade-modal-body {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }

        .farmland-level-display {
          text-align: center;
          padding: 1rem;
          background-color: #EDF2F7;
          border-radius: 0.5rem;
        }

        .current-level-text {
          font-size: 1.2rem;
          color: #2D3748;
          margin-bottom: 0.5rem;
          font-weight: bold;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .next-level-text {
          font-size: 0.9rem;
          color: #4A5568;
          margin-bottom: 1rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .level-indicator {
          display: flex;
          justify-content: center;
          gap: 0.5rem;
        }

        .level-dot {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1rem;
          font-weight: bold;
          background-color: #E2E8F0;
          color: #A0AEC0;
          transition: all 0.3s ease;
        }

        .level-dot.active {
          background-color: #48BB78;
          color: white;
        }

        .upgrade-resources {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
          padding: 1rem;
          background-color: #F7FAFC;
          border-radius: 0.5rem;
        }

        .resource-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem;
          border-radius: 0.5rem;
          transition: all 0.2s;
        }

        .resource-item.sufficient {
          background-color: rgba(72, 187, 120, 0.1);
          border: 1px solid #48BB78;
        }

        .resource-item.insufficient {
          background-color: rgba(245, 101, 101, 0.1);
          border: 1px solid #F56565;
        }

        .resource-name {
          font-size: 1rem;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .resource-amount {
          font-size: 1rem;
          font-weight: bold;
        }

        .resource-item.sufficient .resource-amount {
          color: #48BB78;
        }

        .resource-item.insufficient .resource-amount {
          color: #F56565;
        }

        .farmland-upgrade-button {
          padding: 0.75rem 1.5rem;
          background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%);
          color: white;
          border: none;
          border-radius: 0.5rem;
          font-size: 1rem;
          font-weight: normal;
          cursor: pointer;
          transition: all 0.3s ease;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .farmland-upgrade-button:hover:not(.disabled) {
          background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .farmland-upgrade-button.disabled {
          background-color: #CBD5E0;
          cursor: not-allowed;
          opacity: 0.6;
        }

        /* å‡çº§æŒ‰é’®æ ·å¼ */
        .farmland-upgrade-btn {
          padding: 0.5rem 1rem;
          background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%);
          color: white;
          border: none;
          border-radius: 0.5rem;
          font-size: 0.9rem;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .farmland-upgrade-btn:hover {
          background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .farmland-upgrade-btn .upgrade-icon {
          font-size: 1rem;
        }

        .farmland-upgrade-btn #farmland-level-text {
          font-weight: bold;
        }

        /* æœªè§£é”å†œç”°æ ¼å­æ ·å¼ */
        .farmland-cell-locked {
          background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%) !important;
          opacity: 0.6;
          position: relative;
          pointer-events: none;
          filter: grayscale(80%);
        }

        .farmland-lock-icon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 2.5rem;
          opacity: 0.8;
        }

        .farmland-lock-text {
          position: absolute;
          bottom: 10px;
          left: 50%;
          transform: translateX(-50%);
          color: white;
          font-size: 0.8rem;
          white-space: nowrap;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }
      `;
      document.head.appendChild(style);

      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        }
      };
    }

    // æ›´æ–°å•ä¸ªå†œç”°æ ¼å­çš„æ˜¾ç¤º
    function updateFarmlandCellDisplay(farmlandCell, cellIndex, cellData) {
      // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
      farmlandCell.innerHTML = '';

      // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
      const statusDiv = document.createElement('div');
      statusDiv.className = 'farmland-cell-status';

      // æ·»åŠ æŒ‡ç¤ºå™¨
      const indicatorsDiv = document.createElement('div');
      indicatorsDiv.className = 'farmland-cell-indicators';

      // æ¹¿æ¶¦åº¦æŒ‡ç¤ºå™¨
      const moistureIndicator = document.createElement('div');
      moistureIndicator.className = 'farmland-cell-indicator';
      moistureIndicator.innerHTML = `ğŸ’§ ${cellData.moisture}`;

      // è‚¥æ²ƒåº¦æŒ‡ç¤ºå™¨
      const fertilityIndicator = document.createElement('div');
      fertilityIndicator.className = 'farmland-cell-indicator';
      fertilityIndicator.innerHTML = `ğŸŒ± ${cellData.fertility}`;

      indicatorsDiv.appendChild(moistureIndicator);
      indicatorsDiv.appendChild(fertilityIndicator);

      if (cellData.crop === null) {
        // ç©ºé—²çŠ¶æ€
        statusDiv.textContent = 'ç©ºé—²';
      } else {
        // æ˜¾ç¤ºä½œç‰©
        const cropImage = document.createElement('div');
        cropImage.className = 'crop-image';

        // è®¡ç®—ç”Ÿé•¿é˜¶æ®µ
        const currentDay = gameData.day || 1;
        const daysSincePlanted = cellData.plantedDay ? currentDay - cellData.plantedDay : 0;
        const seed = farmlandData.seeds[cellData.crop];

        // æ—©æœŸ(1-2å¤©): é˜¶æ®µ1, ä¸­æœŸ(3-4å¤©): é˜¶æ®µ2, æˆç†ŸæœŸ(5-6å¤©): é˜¶æ®µ3
        if (daysSincePlanted <= 2) {
          cellData.growthStage = 1;
          statusDiv.textContent = 'æ—©æœŸ';
          cropImage.style.backgroundImage = `url('${seed.stages[0]}')`;
        } else if (daysSincePlanted <= 4) {
          cellData.growthStage = 2;
          statusDiv.textContent = 'ä¸­æœŸ';
          cropImage.style.backgroundImage = `url('${seed.stages[1]}')`;
        } else if (daysSincePlanted >= 5) {
          cellData.growthStage = 3;
          statusDiv.textContent = 'æˆç†ŸæœŸ';
          cropImage.style.backgroundImage = `url('${seed.stages[2]}')`;

          // æ·»åŠ æˆç†Ÿæ ‡è®°
          const readyMark = document.createElement('div');
          readyMark.className = 'ready-to-harvest';
          readyMark.innerHTML = 'â­';
          farmlandCell.appendChild(readyMark);

          // ä¸ºæˆç†Ÿä½œç‰©æ·»åŠ æ‚¬åœæ•ˆæœ
          farmlandCell.classList.add('ready-for-harvest');
          farmlandCell.classList.add('harvest-cursor');
        }

        farmlandCell.appendChild(cropImage);
      }

      farmlandCell.appendChild(statusDiv);
      farmlandCell.appendChild(indicatorsDiv);
    }

    // ç§æ¤ä½œç‰©å‡½æ•°ï¼ˆç§»åˆ°å¤–éƒ¨ä»¥ä¾›å…¶ä»–å‡½æ•°è°ƒç”¨ï¼‰
    function plantCrop(cellIndex, seedType) {
      try {
        console.log('plantCropå‡½æ•°å¼€å§‹æ‰§è¡Œ - cellIndex:', cellIndex, 'seedType:', seedType);
        const farmlandCell = document.getElementById(`farmland-cell-${cellIndex}`);
        console.log('æŸ¥æ‰¾å†œç”°æ ¼å­å…ƒç´  - farmland-cell-' + cellIndex + ':', farmlandCell);
        if (!farmlandCell) {
          console.log('æ‰¾ä¸åˆ°å†œç”°æ ¼å­å…ƒç´ ï¼Œè¿”å›false');
          return false;
        }

        const cellData = farmlandData.cells[cellIndex];
        console.log('è·å–cellData:', cellData);
        if (cellData.crop !== null) {
          console.log('å†œç”°æ ¼å­å·²æœ‰ä½œç‰©ï¼Œæ— æ³•ç§æ¤');
          return false;
        }

        const seedAmount = gameData.resources[seedType]?.amount || 0;
        console.log('æ£€æŸ¥ç§å­æ•°é‡:', seedAmount);
        if (seedAmount <= 0) {
          console.log('ç§å­æ•°é‡ä¸è¶³ï¼Œæ— æ³•ç§æ¤');
          return false;
        }

        // å‡å°‘ç§å­æ•°é‡
        gameData.resources[seedType].amount--;
        console.log('å‡å°‘ç§å­æ•°é‡å:', gameData.resources[seedType].amount);

        // æ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
        if (window.updateSeedCards) {
          console.log('è°ƒç”¨updateSeedCards');
          window.updateSeedCards();
        }

        // è®¾ç½®ä½œç‰©æ•°æ®
        cellData.crop = seedType;
        cellData.growthStage = 0; // åˆå§‹ç”Ÿé•¿é˜¶æ®µ
        cellData.growthProgress = 0; // åˆå§‹ç”Ÿé•¿è¿›åº¦
        cellData.plantedDay = gameData.day || 1; // ç§æ¤æ—¥æœŸ

        // é‡ç½®å†œç”°çŠ¶æ€
        cellData.moisture = 0; // åˆå§‹æ¹¿åº¦è®¾ä¸º0
        cellData.fertility = 50; // åˆå§‹è‚¥åŠ›

        // ç«‹å³æ›´æ–°æ ¼å­çš„è§†è§‰æ˜¾ç¤º
        updateFarmlandCellDisplay(farmlandCell, cellIndex, cellData);

        renderResources();
        updateGameData();

        console.log(`åœ¨æ ¼å­${cellIndex}ç§æ¤äº†${seedType}ï¼Œå‡†å¤‡è¿”å›true`);
        return true;

      } catch (error) {
        console.error('ç§æ¤ä½œç‰©æ—¶å‡ºé”™:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        return false;
      }
    }

    // æ›´æ–°æ‰€æœ‰å†œç”°æ ¼å­æ˜¾ç¤º
    function updateAllFarmlandCells() {
      console.log('å¼€å§‹æ›´æ–°æ‰€æœ‰å†œç”°æ ¼å­...');
      console.log('å½“å‰ farmlandData.level:', farmlandData.level);

      // æ¸…é™¤æ—§æ ¼å­çš„æ‰€æœ‰é«˜äº®æ•ˆæœå’ŒåŠ¨ç”»çŠ¶æ€
      document.querySelectorAll('.farmland-cell').forEach(cell => {
        cell.classList.remove('highlight', 'pulse-glow', 'placing', 'flash');
        // ç§»é™¤å¯èƒ½çš„æ”¶è·åŠ¨ç”»
        const harvestAnim = cell.querySelector('.harvest-animation');
        if (harvestAnim) {
          harvestAnim.remove();
        }
      });

      // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„ç²’å­æ•ˆæœå’Œæ‹–å½±
      document.querySelectorAll('.drag-trail, .particle.drag-particle, .snap-indicator').forEach(el => {
        if (el.parentNode) {
          el.parentNode.removeChild(el);
        }
      });

      // å…³é”®ä¿®å¤ï¼šç¡®ä¿ gameData.farmlandData ä¸ farmlandData ä¿æŒåŒæ­¥
      gameData.farmlandData = farmlandData;

      // ç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„
      for (let i = 0; i < 9; i++) {
        if (!farmlandData.cells[i]) {
          farmlandData.cells[i] = {
            crop: null,
            growthStage: 0,
            growthProgress: 0,
            plantedDay: null,
            moisture: 0,
            fertility: 50
          };
        }
      }

      // é‡æ–°åˆ›å»ºæ‰€æœ‰å†œç”°æ ¼å­
      for (let i = 0; i < 9; i++) {
        const existingCell = document.getElementById(`farmland-cell-${i}`);
        console.log(`é‡æ–°åˆ›å»ºæ ¼å­ ${i}ï¼Œæ•°æ®:`, farmlandData.cells[i]);
        console.log(`æ ¼å­ ${i} æ˜¯å¦è§£é”:`, isCellUnlocked(i));

        // åˆ›å»ºæ–°çš„å†œç”°æ ¼å­ï¼Œä¼ å…¥å¼•ç”¨ç¡®ä¿æ•°æ®åŒæ­¥
        const newCell = createFarmlandCell(i, farmlandData.cells[i]);

        // æ£€æŸ¥æ–°æ ¼å­æ˜¯å¦æ­£ç¡®åˆ›å»º
        if (!newCell) {
          console.error(`æ ¼å­ ${i} åˆ›å»ºå¤±è´¥ï¼`);
          continue;
        }

        // æ£€æŸ¥æ–°æ ¼å­çš„ pointer-events è®¾ç½®
        console.log(`æ ¼å­ ${i} çš„ pointer-events:`, newCell.style.pointerEvents);

        if (existingCell) {
          // æ›¿æ¢æ—§æ ¼å­
          existingCell.parentNode.replaceChild(newCell, existingCell);

          // éªŒè¯æ›¿æ¢æˆåŠŸ
          const newCellInDom = document.getElementById(`farmland-cell-${i}`);
          if (newCellInDom !== newCell) {
            console.error(`æ ¼å­ ${i} æ›¿æ¢å¤±è´¥ï¼`);
          } else {
            console.log(`æ ¼å­ ${i} æ›¿æ¢æˆåŠŸ`);
          }
        } else {
          // å¦‚æœæ ¼å­ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰¾åˆ°å¹¶æ·»åŠ åˆ°æ­£ç¡®çš„çˆ¶å…ƒç´ 
          console.log(`æ ¼å­ ${i} ä¸å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ åˆ°DOM`);
          // æ‰¾åˆ°å†œç”°æ ¼å­å®¹å™¨
          const farmlandGrid = document.querySelector('.farmland-grid');
          if (farmlandGrid) {
            farmlandGrid.appendChild(newCell);
            console.log(`æ ¼å­ ${i} å·²æ·»åŠ åˆ°å†œç”°ç½‘æ ¼`);
          } else {
            console.error(`æ‰¾ä¸åˆ°å†œç”°ç½‘æ ¼å®¹å™¨ï¼`);
          }
        }
      }

      // é‡æ–°åˆå§‹åŒ–å·¥å…·æç¤º
      if (window.updateTooltipOnHover) {
        window.updateTooltipOnHover();
      } else {
        console.warn('updateTooltipOnHover å‡½æ•°æœªå®šä¹‰ï¼Œè·³è¿‡å·¥å…·æç¤ºé‡æ–°åˆå§‹åŒ–');
      }

      // ç¡®ä¿å…¨å±€å‡½æ•°å¯ç”¨
      if (!window.triggerPlaceAnimation) {
        console.warn('window.triggerPlaceAnimation æœªå®šä¹‰ï¼Œç§æ¤ç‰¹æ•ˆå¯èƒ½æ— æ³•æ˜¾ç¤º');
      }

      // å…³é”®ä¿®å¤ï¼šç¡®ä¿æ–°åˆ›å»ºçš„æ ¼å­æ­£ç¡®ç»‘å®šäº‹ä»¶
      setTimeout(() => {
        console.log('éªŒè¯å†œç”°æ ¼å­äº‹ä»¶ç»‘å®š...');
        document.querySelectorAll('.farmland-cell').forEach(cell => {
          const cellIndex = parseInt(cell.dataset.cellId || cell.id.replace('farmland-cell-', ''));
          if (!isNaN(cellIndex)) {
            // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦å·²è§£é”
            const isUnlocked = isCellUnlocked(cellIndex);
            console.log(`æ ¼å­ ${cellIndex} è§£é”çŠ¶æ€: ${isUnlocked}, pointer-events: ${cell.style.pointerEvents}`);
            
            // ç¡®ä¿å·²è§£é”æ ¼å­çš„pointer-eventsè®¾ç½®ä¸ºauto
            if (isUnlocked && cell.style.pointerEvents !== 'auto') {
              cell.style.pointerEvents = 'auto';
              console.log(`ä¿®å¤æ ¼å­ ${cellIndex} çš„pointer-events`);
            }
          }
        });
        
        // é‡æ–°ç»‘å®šæ‰€æœ‰å†œç”°æ ¼å­çš„ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿äº‹ä»¶å§”æ‰˜æ­£å¸¸å·¥ä½œ
        console.log('é‡æ–°åˆå§‹åŒ–å†œç”°æ ¼å­ç‚¹å‡»äº‹ä»¶...');
        if (window.bindFarmlandCellEvents) {
          document.querySelectorAll('.farmland-cell').forEach(cell => {
            const cellIndex = parseInt(cell.dataset.cellId || cell.id.replace('farmland-cell-', ''));
            if (!isNaN(cellIndex)) {
              // å…ˆç§»é™¤æ‰€æœ‰ç°æœ‰çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
              const newCell = cell.cloneNode(true);
              cell.parentNode.replaceChild(newCell, cell);
              
              // é‡æ–°ç»‘å®šäº‹ä»¶
              bindFarmlandCellEvents(newCell, cellIndex);
              console.log(`é‡æ–°ç»‘å®šæ ¼å­ ${cellIndex} çš„ç‚¹å‡»äº‹ä»¶`);
            }
          });
        }
        console.log('å†œç”°æ ¼å­äº‹ä»¶éªŒè¯å®Œæˆ');
      }, 150);

      console.log('å†œç”°æ ¼å­æ›´æ–°å®Œæˆ');
    }

    // è¾…åŠ©å‡½æ•°ï¼šç»‘å®šå†œç”°æ ¼å­äº‹ä»¶
    function bindFarmlandCellEvents(cell, cellIndex) {
      const cellData = farmlandData.cells[cellIndex];
      
      // ç‚¹å‡»äº‹ä»¶ - ç§æ¤ã€ä½¿ç”¨å·¥å…·æˆ–æ”¶è·
      cell.addEventListener('click', function(e) {
        console.log(`å†œç”°æ ¼å­ ${cellIndex} è¢«ç‚¹å‡»`);
        e.stopPropagation();

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç§å­è¿›è¡Œç§æ¤
        if (window.selectedSeed && farmlandData.seeds[window.selectedSeed] && cellData.crop === null) {
          console.log('å°è¯•ç§æ¤ç§å­:', window.selectedSeed);
          const seedKey = window.selectedSeed;
          const seedAmount = gameData.resources[seedKey]?.amount || 0;

          console.log('ç§å­æ•°é‡:', seedAmount);

          // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç§å­
          if (seedAmount <= 0) {
            console.log('ç§å­æ•°é‡ä¸è¶³');
            showNotification('ç§å­ä¸è¶³', `ä½ æ²¡æœ‰${farmlandData.seeds[seedKey].name}ï¼`);
            // æ¸…é™¤ç§å­é€‰æ‹©
            window.selectedSeed = null;
            clearSeedCursor();
            // æ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
            if (window.updateSeedCards) {
              window.updateSeedCards();
            }
            return;
          }

          // ä½¿ç”¨plantCropå‡½æ•°ç§æ¤ç§å­
          console.log('è°ƒç”¨ plantCrop å‡½æ•°');
          if (plantCrop(cellIndex, seedKey)) {
            console.log('plantCrop è¿”å› trueï¼Œç§æ¤æˆåŠŸ');
            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
            setTimeout(() => {
              // æ›´æ–°æ˜¾ç¤º
              const updateCellDisplay = () => {
                // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
                cell.innerHTML = '';
                
                // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
                const statusDiv = document.createElement('div');
                statusDiv.className = 'farmland-cell-status';
                
                // æ·»åŠ æŒ‡ç¤ºå™¨
                const indicatorsDiv = document.createElement('div');
                indicatorsDiv.className = 'farmland-cell-indicators';
                
                // æ¹¿æ¶¦åº¦æŒ‡ç¤ºå™¨
                const moistureIndicator = document.createElement('div');
                moistureIndicator.className = 'farmland-cell-indicator';
                moistureIndicator.innerHTML = `ğŸ’§ ${cellData.moisture}`;
                
                // è‚¥æ²ƒåº¦æŒ‡ç¤ºå™¨
                const fertilityIndicator = document.createElement('div');
                fertilityIndicator.className = 'farmland-cell-indicator';
                fertilityIndicator.innerHTML = `ğŸŒ± ${cellData.fertility}`;
                
                indicatorsDiv.appendChild(moistureIndicator);
                indicatorsDiv.appendChild(fertilityIndicator);
                
                if (cellData.crop === null) {
                  // ç©ºé—²çŠ¶æ€
                  statusDiv.textContent = 'ç©ºé—²';
                } else {
                  // æ˜¾ç¤ºä½œç‰©
                  const cropImage = document.createElement('div');
                  cropImage.className = 'crop-image';
                  
                  // è®¡ç®—ç”Ÿé•¿é˜¶æ®µ
                  const currentDay = gameData.day || 1;
                  const daysSincePlanted = cellData.plantedDay ? currentDay - cellData.plantedDay : 0;
                  const seed = farmlandData.seeds[cellData.crop];
                  
                  // æ—©æœŸ(1-2å¤©): é˜¶æ®µ1, ä¸­æœŸ(3-4å¤©): é˜¶æ®µ2, æˆç†ŸæœŸ(5-6å¤©): é˜¶æ®µ3
                  if (daysSincePlanted <= 2) {
                    cellData.growthStage = 1;
                    statusDiv.textContent = 'æ—©æœŸ';
                    cropImage.style.backgroundImage = `url('${seed.stages[0]}')`;
                  } else if (daysSincePlanted <= 4) {
                    cellData.growthStage = 2;
                    statusDiv.textContent = 'ä¸­æœŸ';
                    cropImage.style.backgroundImage = `url('${seed.stages[1]}')`;
                  } else if (daysSincePlanted >= 5) {
                    cellData.growthStage = 3;
                    statusDiv.textContent = 'æˆç†ŸæœŸ';
                    cropImage.style.backgroundImage = `url('${seed.stages[2]}')`;
                    
                    // æ·»åŠ æˆç†Ÿæ ‡è®°
                    const readyMark = document.createElement('div');
                    readyMark.className = 'ready-to-harvest';
                    readyMark.innerHTML = 'â­';
                    cell.appendChild(readyMark);
                    
                    // ä¸ºæˆç†Ÿä½œç‰©æ·»åŠ æ‚¬åœæ•ˆæœ
                    cell.classList.add('ready-for-harvest');
                    cell.classList.add('harvest-cursor');
                  }
                  
                  cell.appendChild(cropImage);
                }
                
                cell.appendChild(statusDiv);
                cell.appendChild(indicatorsDiv);
              };
              
              updateCellDisplay();

              // æ›´æ–°ç§å­å¡ç‰Œæ•°é‡æ˜¾ç¤º
              const seedCards = document.querySelectorAll('.crafting-inventory-card');
              seedCards.forEach(card => {
                if (card.dataset.seedType === seedKey) {
                  const nameDiv = card.querySelector('.crafting-card-title');
                  if (nameDiv) {
                    nameDiv.textContent = `${farmlandData.seeds[seedKey].name} Ã— ${gameData.resources[seedKey].amount}`;
                  }
                  card.classList.remove('selected');
                }
              });

              // æ›´æ–°ä¸»é¡µèƒŒåŒ…æ ä¸­çš„èµ„æºå¡ç‰Œ
              updateMainResourceCard(seedKey);

              // è§¦å‘æ”¾ç½®ç‰¹æ•ˆ
              window.triggerPlaceAnimation(cell, 'seed');

              showNotification('ç§æ¤æˆåŠŸ', `æˆåŠŸç§æ¤äº†${farmlandData.seeds[seedKey].name}ï¼`);
              renderResources();
              updateGameData();

              // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™ç§å­
              if (gameData.resources[seedKey]?.amount > 0) {
                // æ›´æ–°è‡ªå®šä¹‰å…‰æ ‡çš„æ•°é‡æ˜¾ç¤º
                const countIndicator = document.getElementById('seed-count-indicator');
                if (countIndicator) {
                  countIndicator.textContent = gameData.resources[seedKey].amount;
                }
              } else {
                // ç§å­ç”¨å®Œäº†ï¼Œæ¸…é™¤å…‰æ ‡å’Œé€‰æ‹©
                window.selectedSeed = null;
                clearSeedCursor();
              }
            }, 300);
          } else {
            console.log('plantCrop è¿”å› falseï¼Œç§æ¤å¤±è´¥');
          }
          return;
        }

        // å¤„ç†å·¥å…·ä½¿ç”¨ï¼ˆçœç•¥å·¥å…·ä½¿ç”¨éƒ¨åˆ†ï¼Œä¿æŒä¸ç°æœ‰ä»£ç ä¸€è‡´ï¼‰
        if (window.selectedTool === 'fertilizer') {
          // æ–½è‚¥
          const fertilizerAmount = gameData.resources.fertilizer?.amount || 0;
          if (fertilizerAmount > 0) {
            gameData.resources.fertilizer.amount -= 1;
            cellData.fertility = Math.min(100, cellData.fertility + 50); // 1ä¸ªè‚¥æ–™å¢åŠ 50è‚¥æ²ƒåº¦
            updateCellDisplay();
            renderResources();
            updateGameData();
            // æ›´æ–°å†œç”°çª—å£ä¸­çš„ç›¸å…³èµ„æºå¡ç‰Œ
            if (window.updateFarmlandRelatedResources) {
              window.updateFarmlandRelatedResources();
            }
            showNotification('æ–½è‚¥æˆåŠŸ', 'è‚¥æ²ƒåº¦å¢åŠ äº†50ï¼');
          } else {
            showNotification('è‚¥æ–™ä¸è¶³', 'ä½ æ²¡æœ‰è‚¥æ–™ï¼');
          }
        } else if (cellData.growthStage === 3) {
          // æ”¶è·ä½œç‰©ï¼ˆçœç•¥æ”¶è·éƒ¨åˆ†ï¼Œä¿æŒä¸ç°æœ‰ä»£ç ä¸€è‡´ï¼‰
          const seed = farmlandData.seeds[cellData.crop];
          let rewardCount = 1;
          
          // æ ¹æ®æ¹¿æ¶¦åº¦å’Œè‚¥æ²ƒåº¦è®¡ç®—æ”¶è·é‡
          if (cellData.moisture >= 80 && cellData.fertility >= 80) {
            rewardCount = seed.rewardCount[2]; // æœ€é«˜æ”¶è·é‡
          } else if (cellData.moisture >= 50 && cellData.fertility >= 50) {
            rewardCount = seed.rewardCount[1]; // ä¸­ç­‰æ”¶è·é‡
          } else {
            rewardCount = seed.rewardCount[0]; // æœ€ä½æ”¶è·é‡
          }
          
          // æ·»åŠ å¥–åŠ±åˆ°èµ„æº
          if (!gameData.resources[seed.reward]) {
            gameData.resources[seed.reward] = { name: '', description: '', amount: 0 };
          }
          gameData.resources[seed.reward].amount += rewardCount;
          
          // å¦‚æœæ˜¯å°éº¦æˆ–æ°´ç¨»ï¼Œé¢å¤–äº§å‡º2å¼ è‰æ–™å¡ç‰Œ
          if (cellData.crop === 'wheat_seed' || cellData.crop === 'rice_seed') {
            if (!gameData.resources['grass_feed']) {
              gameData.resources['grass_feed'] = { 
                name: 'è‰æ–™', 
                description: 'é©¬åŒ¹å–œçˆ±çš„è‰æ–™ï¼Œå¯ä»¥ç»´æŒé©¬åŒ¹çš„é¥±é£Ÿåº¦',
                amount: 0,
                image: 'UI/è‰æ–™.jpg',
                category: 'material'
              };
            }
            gameData.resources['grass_feed'].amount += 2;
            showNotification('é¢å¤–æ”¶è·', `æ”¶è·äº†2å¼ è‰æ–™å¡ç‰Œï¼`);
          }
          
          // å¦‚æœæ”¶è·çš„æ˜¯ç§å­ï¼Œæ›´æ–°ç§å­å¡ç‰Œæ˜¾ç¤º
          // æ£€æŸ¥æ”¶è·çš„ç‰©å“æ˜¯å¦æ˜¯ç§å­èµ„æºä¹‹ä¸€
          if (window.updateSeedCards && Object.keys(farmlandData.seeds).includes(seed.reward)) {
            window.updateSeedCards();
          }
          
          // æ˜¾ç¤ºæ”¶è·åŠ¨ç”»
          const harvestAnim = document.createElement('div');
          harvestAnim.className = 'harvest-animation harvest-success';
          harvestAnim.innerHTML = `<div style="font-weight: bold; color: #4CAF50;">+${rewardCount} ${seed.name.replace('ç§å­', '')}</div>`;
          cell.appendChild(harvestAnim);
          
          // ç«‹å³é‡ç½®å†œç”°æ ¼å­ï¼Œè®©ä½œç‰©å¿«é€Ÿæ¶ˆå¤±
          cellData.crop = null;
          cellData.growthStage = 0;
          cellData.plantedDay = null;
          cellData.moisture = 0;
          cellData.fertility = 50;
          
          // æ›´æ–°æ˜¾ç¤º
          const updateCellDisplay = () => {
            // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
            cell.innerHTML = '';
            
            // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
            const statusDiv = document.createElement('div');
            statusDiv.className = 'farmland-cell-status';
            
            // æ·»åŠ æŒ‡ç¤ºå™¨
            const indicatorsDiv = document.createElement('div');
            indicatorsDiv.className = 'farmland-cell-indicators';
            
            // æ¹¿æ¶¦åº¦æŒ‡ç¤ºå™¨
            const moistureIndicator = document.createElement('div');
            moistureIndicator.className = 'farmland-cell-indicator';
            moistureIndicator.innerHTML = `ğŸ’§ ${cellData.moisture}`;
            
            // è‚¥æ²ƒåº¦æŒ‡ç¤ºå™¨
            const fertilityIndicator = document.createElement('div');
            fertilityIndicator.className = 'farmland-cell-indicator';
            fertilityIndicator.innerHTML = `ğŸŒ± ${cellData.fertility}`;
            
            indicatorsDiv.appendChild(moistureIndicator);
            indicatorsDiv.appendChild(fertilityIndicator);
            
            statusDiv.textContent = 'ç©ºé—²';
            
            cell.appendChild(statusDiv);
            cell.appendChild(indicatorsDiv);
          };
          
          updateCellDisplay();
          
          // çŸ­æš‚å»¶è¿Ÿåç§»é™¤åŠ¨ç”»æ•ˆæœ
          setTimeout(() => {
            if (harvestAnim.parentNode) {
              harvestAnim.parentNode.removeChild(harvestAnim);
            }
          }, 300);
          
          showNotification('æ”¶è·æˆåŠŸ', `æ”¶è·äº†${rewardCount}ä¸ª${seed.name.replace('ç§å­', '')}ï¼`);
          renderResources();
          updateGameData();
        }
      });
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ ¼å­æ˜¯å¦å·²è§£é”
    function isCellUnlocked(index) {
      const unlockRules = {
        1: [0, 1],
        2: [0, 1, 2, 3],
        3: [0, 1, 2, 3, 4, 5],
        4: [0, 1, 2, 3, 4, 5, 6, 7, 8]
      };
      const level = farmlandData.level || 1;
      const unlockedCells = unlockRules[level] || unlockRules[1];
      return unlockedCells.includes(index);
    }


    // æ˜¾ç¤ºå®…é‚¸å‡çº§æ¨¡æ€æ¡†
    function showHouseUpgradeModal() {
      // è·å–å½“å‰æˆ¿å±‹ç­‰çº§ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º1çº§
      const currentLevel = gameData.houseLevel || 1;
      
      // è®¡ç®—å‡çº§åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„èµ„æº
      const upgradeCosts = {
        1: { wood: 20, stone: 10, money: 100 }, // 1çº§å‡2çº§
        2: { wood: 40, stone: 20, money: 200 }, // 2çº§å‡3çº§
        3: { wood: 60, stone: 30, money: 300 }, // 3çº§å‡4çº§
        4: { wood: 80, stone: 40, money: 400 }, // 4çº§å‡5çº§
        5: { wood: 100, grass_feed: 100, mud: 100, stone: 100 } // 5çº§å‡6çº§ï¼ˆè§£é”å†°çª–ï¼‰
      };

      // è·å–ä¸‹ä¸€çº§å‡çº§æ‰€éœ€èµ„æº
      const nextLevel = Math.min(currentLevel + 1, 6); // æœ€é«˜6çº§
      const requiredResources = upgradeCosts[currentLevel] || upgradeCosts[5];
      
      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'house-upgrade-modal';
      modalContainer.id = 'houseUpgradeModal';
      
      // åˆ›å»ºå¼¹çª—å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
      const modalContent = document.createElement('div');
      modalContent.className = 'house-upgrade-modal-content ink-border';
      
      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'house-upgrade-modal-header';
      
      // åˆ›å»ºæ ‡é¢˜ï¼Œä½¿ç”¨ink-textæ ·å¼
      const title = document.createElement('h2');
      title.className = 'house-upgrade-modal-title ink-text';
      title.textContent = 'æˆ‘çš„å®…é‚¸';
      modalHeader.appendChild(title);
      
      // åˆ›å»ºå…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.className = 'house-upgrade-modal-close';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = function() {
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      modalHeader.appendChild(closeButton);
      
      modalContent.appendChild(modalHeader);
      
      // åˆ›å»ºå†…å®¹åŒºåŸŸ
      const modalBody = document.createElement('div');
      modalBody.className = 'house-upgrade-modal-body';
      
      // æ·»åŠ å½“å‰ç­‰çº§æ˜¾ç¤º
      const levelDisplay = document.createElement('div');
      levelDisplay.className = 'house-level-display';
      levelDisplay.innerHTML = `
        <div class="current-level">å½“å‰ç­‰çº§ï¼š${currentLevel}çº§</div>
        <div class="level-indicator">
          ${[1,2,3,4,5,6].map(level => `
            <div class="level-dot ${level <= currentLevel ? 'active' : ''}">${level}</div>
          `).join('')}
        </div>
      `;
      modalBody.appendChild(levelDisplay);
      
      // æ·»åŠ å‡çº§æ‰€éœ€èµ„æºæ˜¾ç¤º
      const resourcesDisplay = document.createElement('div');
      resourcesDisplay.className = 'upgrade-resources-display';

      let resourcesHTML = '<div class="resources-title">å‡çº§æ‰€éœ€ææ–™ï¼š</div><div class="resources-list">';
      for (const [resource, amount] of Object.entries(requiredResources)) {
        const resourceName = gameData.resources[resource]?.name || resource;
        const hasEnough = gameData.resources[resource]?.amount >= amount;
        resourcesHTML += `
          <div class="resource-item ${hasEnough ? 'enough' : 'not-enough'}">
            <span class="resource-name">${resourceName}:</span>
            <span class="resource-amount">${amount}ä¸ª</span>
            <span class="resource-status">${hasEnough ? 'âœ“' : 'âœ—'}</span>
          </div>
        `;
      }
      resourcesHTML += '</div>';

      resourcesDisplay.innerHTML = resourcesHTML;
      modalBody.appendChild(resourcesDisplay);



      // æ·»åŠ ä¸‹ä¸€çº§è§£é”å†…å®¹æ˜¾ç¤ºï¼ˆå¦‚æœä¸æ˜¯æœ€é«˜ç­‰çº§ï¼‰
      if (currentLevel < 6) {
        const unlockDisplay = document.createElement('div');
        unlockDisplay.className = 'unlock-features-display';

        // æ ¹æ®ä¸‹ä¸€çº§è§£é”çš„åŠŸèƒ½
        let nextLevelUnlock = '';
        let unlockDescription = '';

        switch(nextLevel) {
          case 2:
            nextLevelUnlock = 'å†œç”°å’Œæ°´äº•';
            unlockDescription = 'åœ¨å†œç”°ä¸­ç§æ¤å’Œç®¡ç†ä½œç‰©ï¼Œå¯ä»¥ç”Ÿäº§å„ç§é£Ÿç‰©èµ„æºï¼›åœ¨æ°´äº•è¾¹å¯ä»¥å–æ°´æˆ–è£…æ°´ã€‚';
            break;
          case 3:
            nextLevelUnlock = 'ä»“åº“';
            unlockDescription = 'å­˜å‚¨ç‰©å“çš„ä»“åº“ï¼Œå¯ä»¥å®‰å…¨ä¿å­˜å„ç§èµ„æºå’Œææ–™ã€‚';
            break;
          case 4:
            nextLevelUnlock = 'ç‰²å£æ£š';
            unlockDescription = 'åœ¨å®…é‚¸çš„ç‰²å£æ£šä¸­é¥²å…»åŠ¨ç‰©ï¼Œå¯ä»¥è·å¾—è‚‰å’Œçš®æ¯›ã€‚';
            break;
          case 5:
            nextLevelUnlock = 'é©¬å©';
            unlockDescription = 'åœ¨é©¬å©ä¸­é¥²å…»é©¬åŒ¹ï¼Œå¯ä»¥æä¾›ä»£æ­¥å·¥å…·å’Œè¿è¾“èƒ½åŠ›ã€‚';
            break;
          case 6:
            nextLevelUnlock = 'å†°çª–';
            unlockDescription = 'ä½¿ç”¨å†°å—ä¿é²œå…·æœ‰æ—¶æ•ˆæ€§çš„é£Ÿç‰©ï¼Œé˜²æ­¢é£Ÿç‰©è…çƒ‚ã€‚';
            break;
        }

        unlockDisplay.innerHTML = `
          <div class="unlock-title">å‡çº§åˆ°${nextLevel}çº§å°†è§£é”ï¼š</div>
          <div class="unlock-feature">
            <div class="unlock-feature-name">${nextLevelUnlock}</div>
            <div class="unlock-feature-desc">${unlockDescription}</div>
          </div>
        `;

        modalBody.appendChild(unlockDisplay);
      }
      
      // æ·»åŠ å‡çº§æŒ‰é’®
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'upgrade-button-container';
      
      const upgradeButton = document.createElement('button');
      upgradeButton.className = 'house-upgrade-button ink-button ink-button-primary';
      upgradeButton.textContent = 'å‡çº§';
      
      // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºè¿›è¡Œå‡çº§
      let canUpgrade = true;
      for (const [resource, amount] of Object.entries(requiredResources)) {
        if (!gameData.resources[resource] || gameData.resources[resource].amount < amount) {
          canUpgrade = false;
          break;
        }
      }

      // å¦‚æœå·²ç»æ˜¯6çº§æˆ–èµ„æºä¸è¶³ï¼Œç¦ç”¨æŒ‰é’®
      if (currentLevel >= 6 || !canUpgrade) {
        upgradeButton.disabled = true;
        upgradeButton.textContent = currentLevel >= 6 ? 'å·²è¾¾åˆ°æœ€é«˜ç­‰çº§' : 'ææ–™ä¸è¶³';
      }

      // æ·»åŠ å‡çº§æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      upgradeButton.onclick = function() {
        if (!canUpgrade || currentLevel >= 6) return;

        // æ‰§è¡Œå‡çº§
        performHouseUpgrade(requiredResources);

        // å…³é—­å¼¹çª—
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      
      buttonContainer.appendChild(upgradeButton);
      modalBody.appendChild(buttonContainer);
      
      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      
      // åˆå§‹åŒ–å…¨å±€å˜é‡
      window.selectedTool = null;
      window.selectedSeed = null;
      window.lastMouseX = window.innerWidth / 2;
      window.lastMouseY = window.innerHeight / 2;

      // ç›‘å¬é¼ æ ‡ä½ç½®ï¼ˆç”¨äºè‡ªå®šä¹‰å…‰æ ‡ï¼‰
      document.addEventListener('mousemove', function(e) {
        window.lastMouseX = e.clientX;
        window.lastMouseY = e.clientY;
      });
      
      // æ·»åŠ åˆ°æ–‡æ¡£
      document.body.appendChild(modalContainer);

      // åˆå§‹åŒ–ç‰²å£æ æ˜¾ç¤ºçŠ¶æ€
      // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²ç»å®Œå…¨æ„å»º
      setTimeout(() => {
        if (window.updateLivestockInventory) {
          window.updateLivestockInventory();
        }
        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        if (window.initializeLivestockScrollbars) {
          window.initializeLivestockScrollbars();
        }
      }, 10);
      
      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .house-upgrade-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }
        
        .house-upgrade-modal.active {
          opacity: 1;
          visibility: visible;
        }
        
        .house-upgrade-modal-content {
          background-color: #F7FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 0.5rem;
          max-width: 500px;
          width: 90%;
          padding: 1.5rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
          transform: translateY(-20px);
          transition: all 0.3s ease;
        }
        
        .house-upgrade-modal.active .house-upgrade-modal-content {
          transform: translateY(0);
        }
        
        .house-upgrade-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
        }
        
        .house-upgrade-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .house-upgrade-modal-close {
          background: none;
          border: none;
          font-size: 1.25rem;
          cursor: pointer;
          color: #4A5568;
        }
        
        .house-upgrade-modal-body {
          margin-bottom: 1rem;
        }
        
        .house-level-display {
          text-align: center;
          margin-bottom: 1.5rem;
        }
        
        .current-level {
          font-size: 1.2rem;
          font-weight: normal;
          color: #2D3748;
          margin-bottom: 0.75rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .level-indicator {
          display: flex;
          justify-content: center;
          gap: 0.5rem;
        }
        
        .level-dot {
          width: 30px;
          height: 30px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: normal;
          color: #4A5568;
          background-color: #E2E8F0;
          border: 2px solid #CBD5E0;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .level-dot.active {
          background-color: #805AD5;
          color: white;
          border-color: #6B46C1;
        }
        
        .upgrade-resources-display {
          margin-bottom: 1.5rem;
        }
        
        .resources-title {
          font-size: 1rem;
          font-weight: normal;
          color: #2D3748;
          margin-bottom: 0.75rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .resources-list {
          background-color: #EDF2F7;
          border-radius: 0.5rem;
          padding: 1rem;
        }
        
        .resource-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem 0;
          border-bottom: 1px solid #E2E8F0;
        }
        
        .resource-item:last-child {
          border-bottom: none;
        }
        
        .resource-item.enough {
          color: #38A169;
        }
        
        .resource-item.not-enough {
          color: #E53E3E;
        }
        
        .resource-name {
          flex-grow: 1;
        }
        
        .resource-amount {
          margin-right: 0.5rem;
        }
        
        .resource-status {
          font-weight: bold;
        }
        
        .unlock-features-display {
          margin-bottom: 1.5rem;
          padding: 1rem;
          background-color: #F0F9FF;
          border: 1px solid #BAE6FD;
          border-radius: 0.5rem;
        }
        
        .unlock-title {
          font-size: 1rem;
          font-weight: normal;
          color: #075985;
          margin-bottom: 0.5rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .unlock-feature {
          display: flex;
          flex-direction: column;
          gap: 0.25rem;
        }
        
        .unlock-feature-name {
          font-size: 1.1rem;
          font-weight: normal;
          color: #0C4A6E;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .unlock-feature-desc {
          font-size: 0.875rem;
          color: #0E7490;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
          line-height: 1.4;
        }
        
        .upgrade-button-container {
          display: flex;
          justify-content: center;
        }
        
        .house-upgrade-button {
          background-color: #805AD5;
          color: white;
          border: none;
          border-radius: 0.375rem;
          padding: 0.75rem 1.5rem;
          font-weight: normal;
          cursor: pointer;
          transition: all 0.3s ease;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .house-upgrade-button:hover:not(:disabled) {
          background-color: #6B46C1;
          transform: translateY(-2px);
          box-shadow: 0 0 20px rgba(141, 110, 99, 0.4);
        }
        
        .house-upgrade-button:disabled {
          background-color: #CBD5E0;
          cursor: not-allowed;
        }
      `;
      document.head.appendChild(style);
      
      // æ’­æ”¾å†œåœºéŸ³æ•ˆ
      playFarmSound();
      
      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);
      
      // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        }
      };
    }
    
    // æ‰§è¡Œæˆ¿å±‹å‡çº§
    function performHouseUpgrade(requiredResources) {
      const upgradeResults = {
        resources: {},
        status: {},
        effects: []
      };

      const currentLevel = gameData.houseLevel || 1;
      const nextLevel = currentLevel + 1;

      // æ‰£é™¤èµ„æº
      for (const [resource, amount] of Object.entries(requiredResources)) {
        gameData.resources[resource].amount -= amount;
        upgradeResults.resources[resource] = -amount;
      }

      // å¢åŠ æˆ¿å±‹ç­‰çº§
      gameData.houseLevel = nextLevel;

      // æ ¹æ®æˆ¿å±‹ç­‰çº§è§£é”ä¸åŒåŠŸèƒ½
      let unlockMessage = '';
      if (nextLevel === 2) {
        // äºŒçº§æˆ¿å±‹ï¼šè§£é”å†œç”°
        unlockMessage = 'è§£é”äº†å†œç”°åŠŸèƒ½ï¼';
      } else if (nextLevel === 3) {
        // ä¸‰çº§æˆ¿å±‹ï¼šè§£é”ç‰²å£æ£š
        unlockMessage = 'è§£é”äº†ç‰²å£æ£šåŠŸèƒ½ï¼';
      } else if (nextLevel === 4) {
        // å››çº§æˆ¿å±‹ï¼šè§£é”é©¬å©
        unlockMessage = 'è§£é”äº†é©¬å©åŠŸèƒ½ï¼';
      } else if (nextLevel === 5) {
        // äº”çº§æˆ¿å±‹ï¼šè§£é”å†°çª–
        unlockMessage = 'è§£é”äº†å†°çª–åŠŸèƒ½ï¼';
      } else if (nextLevel === 6) {
        // å…­çº§æˆ¿å±‹ï¼šæœ€é«˜ç­‰çº§
        unlockMessage = 'å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼';
      }

      // æ›´æ–°æˆ‘çš„å®…é‚¸åœ°ç‚¹çš„å¯ç”¨è¡ŒåŠ¨
      updateMyMansionActions();

      // æ›´æ–°è¡ŒåŠ¨æ˜¾ç¤º
      renderActions();

      upgradeResults.effects.push(`æˆ¿å±‹ç­‰çº§æå‡åˆ°${nextLevel}çº§`);
      if (unlockMessage) {
        upgradeResults.effects.push(unlockMessage);
      }

      showNotification('æˆ¿å±‹å‡çº§æˆåŠŸ', `ä½ çš„å®…é‚¸å·²å‡çº§åˆ°${nextLevel}çº§ï¼${unlockMessage}`);
      // showEventResult('æˆ¿å±‹å‡çº§ç»“æœ', upgradeResults); // åˆ é™¤é‡å¤çš„å¼¹çª—æ˜¾ç¤º

      // æ›´æ–°UI
      renderResources();
      updateGameData();

      // æ¶ˆè€—æ—¶é—´
      advanceTime();
    }
    
    // æ›´æ–°æˆ‘çš„å®…é‚¸åœ°ç‚¹çš„å¯ç”¨è¡ŒåŠ¨
    function updateMyMansionActions() {
      const houseLevel = gameData.houseLevel || 1;
      console.log('æ›´æ–°æˆ‘çš„å®…é‚¸åŠ¨ä½œï¼Œå½“å‰æˆ¿å±‹ç­‰çº§:', houseLevel);
      const mansionLocation = gameData.locations.find(loc => loc.id === 'my_mansion');
      
      if (mansionLocation) {
        // åŸºç¡€è¡ŒåŠ¨ï¼šå°æ†©ã€å‡çº§æˆ¿å±‹
        let availableActions = ['nap', 'upgrade_house'];

        // 2çº§è§£é”å†œç”°å’Œæ°´äº•
        if (houseLevel >= 2) {
          availableActions.push('farmland');
          availableActions.push('water_well');
        }

        // 3çº§è§£é”ä»“åº“
        if (houseLevel >= 3) {
          availableActions.push('store_items');
        }

        // 4çº§è§£é”ç‰²å£æ£š
        if (houseLevel >= 4) {
          availableActions.push('livestock_shed');
        }

        // 5çº§è§£é”é©¬å©
        if (houseLevel >= 5) {
          availableActions.push('stable');
        }

        // 6çº§è§£é”å†°çª–
        if (houseLevel >= 6) {
          availableActions.push('icehouse');
        }

        // æ›´æ–°å¯ç”¨è¡ŒåŠ¨
        mansionLocation.actions = availableActions;
      }

      // 5çº§è§£é”é©¬å©åœ°ç‚¹
      const stableLocation = gameData.locations.find(loc => loc.id === 'stable');
      if (stableLocation) {
        stableLocation.available = houseLevel >= 5;

        // æ›´æ–°åœ°ç‚¹æ˜¾ç¤º
        renderLocations();
      }
    }



    // æ˜¾ç¤ºç‰²å£æ£šæ¨¡æ€æ¡†
    window.showLivestockShedModal = function() {
      console.log('æ˜¾ç¤ºç‰²å£æ£šæ¨¡æ€æ¡†è¢«è°ƒç”¨');
      
      // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å’ŒCSSæ ·å¼è¢«æ­£ç¡®åˆå§‹åŒ–
      if (typeof initializeAnimationCSS === 'function') {
        initializeAnimationCSS();
        console.log('ç‰²å£æ£šçª—å£ï¼šåŠ¨ç”»CSSæ ·å¼åˆå§‹åŒ–å®Œæˆ');
      }
      if (typeof initializeAnimationEffects === 'function') {
        initializeAnimationEffects();
        console.log('ç‰²å£æ£šçª—å£ï¼šåŠ¨ç”»ç‰¹æ•ˆå‡½æ•°åˆå§‹åŒ–å®Œæˆ');
      }
      
      // åœ¨æ‰“å¼€ç‰²å£æ£šæ¨¡æ€æ¡†ä¹‹å‰ï¼Œæ¸…ç†æ‰€æœ‰é—ç•™çš„tooltip
      hideLivestockTooltip();
      hideStableTooltip();
      
      // ç¡®ä¿ç‰²å£æ£šæ•°æ®å­˜åœ¨å¹¶è·å–æœ€æ–°çš„æ•°æ®
      if (!gameData.livestockData) {
        // é‡æ–°åˆå§‹åŒ–ç‰²å£æ£šæ•°æ®
        gameData.livestockData = {
          stalls: Array(4).fill(null).map(() => ({
            animal: null,
            growthStage: 0,
            health: 100,
            productivity: 70,
            cleanliness: 0,
            satiety: 100,  // é¥±é£Ÿåº¦: 0-100
            startDay: null,
            lastFedDay: null,
            lastProducedDay: null,
            produceCount: 0,
            specialState: null
          })),
          animals: {
            chick: { 
              name: 'é¸¡', 
              babyName: 'é¸¡å´½',
              adultName: 'é¸¡æˆå¹´æœŸ',
              growthTime: 3, 
              babyImage: 'UI/é¸¡å¹¼å¹´æœŸ.jpg', 
              adultImage: 'UI/é¸¡æˆå¹´æœŸ.jpg', 
              product: 'egg', 
              maxProduction: 15,
              fertilityBonus: 1
            },
            duckling: { 
              name: 'é¸­', 
              babyName: 'é¸­å´½',
              adultName: 'é¸­æˆå¹´æœŸ',
              growthTime: 5,
              babyImage: 'UI/é¸­å¹¼å¹´æœŸ.jpg', 
              adultImage: 'UI/é¸­æˆå¹´æœŸ.jpg', 
              product: 'egg', 
              maxProduction: 12,
              fertilityBonus: 1
            },
            piglet: { 
              name: 'çŒª', 
              babyName: 'çŒªå´½',
              adultName: 'çŒªæˆå¹´æœŸ',
              growthTime: 10,
              babyImage: 'UI/çŒªå¹¼å¹´æœŸ.jpg', 
              adultImage: 'UI/çŒªæˆå¹´æœŸ.jpg', 
              product: null,
              maxProduction: 0,
              fertilityBonus: 2
            }
          }
        };
      }
      
      // è·å–å½“å‰çš„ç‰²å£æ£šæ•°æ®
      const livestockData = gameData.livestockData;
      
      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'livestock-modal';
      modalContainer.id = 'livestockModal';
      
      // åˆ›å»ºå¼¹çª—å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
      const modalContent = document.createElement('div');
      modalContent.className = 'livestock-modal-content ink-border';
      
      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'livestock-modal-header';
      
      // åˆ›å»ºæ ‡é¢˜ï¼Œä½¿ç”¨ink-textæ ·å¼
      const title = document.createElement('h2');
      title.className = 'livestock-modal-title ink-text';
      title.textContent = 'ç‰²å£æ£šç®¡ç†';
      modalHeader.appendChild(title);
      
      // åˆ›å»ºå…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.className = 'livestock-modal-close';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = function() {
        // å…³é—­ç‰²å£æ å’Œé©¬å©æ çš„æ‚¬åœæç¤º
        hideLivestockTooltip();
        hideStableTooltip();
        // æ¸…é™¤å®šæ—¶å™¨
        if (window.livestockHoverTimer) {
          clearTimeout(window.livestockHoverTimer);
          window.livestockHoverTimer = null;
        }
        if (window.stableHoverTimer) {
          clearTimeout(window.stableHoverTimer);
          window.stableHoverTimer = null;
        }
        window.livestockTooltipVisible = false;
        window.stableTooltipVisible = false;
        
        // ç§»é™¤æ‰€æœ‰ç‰²å£æ çš„tooltipå…ƒç´ 
        const allLivestockTooltips = document.querySelectorAll('#livestock-tooltip, .livestock-tooltip-element');
        allLivestockTooltips.forEach(tooltip => {
          if (tooltip.parentNode) {
            tooltip.remove();
          }
        });
        
        // ç§»é™¤æ‰€æœ‰é©¬å©æ çš„tooltipå…ƒç´ 
        const allStableTooltips = document.querySelectorAll('#stable-tooltip, .stable-tooltip-element');
        allStableTooltips.forEach(tooltip => {
          if (tooltip.parentNode) {
            tooltip.remove();
          }
        });
        
        modalContainer.classList.remove('active');
        setTimeout(() => {
          // ä¿å­˜ç‰²å£æ£šæ•°æ®
          gameData.livestockData = livestockData;
          updateGameData();
          modalContainer.remove();
        }, 300);
      };
      modalHeader.appendChild(closeButton);
      
      modalContent.appendChild(modalHeader);
      
      // åˆ›å»ºä¸»ä½“åŒºåŸŸï¼Œåˆ†ä¸ºå·¦å³ä¸¤æ 
      const modalBody = document.createElement('div');
      modalBody.className = 'livestock-modal-body';
      modalBody.style.display = 'flex';
      modalBody.style.gap = '20px';
      
      // å·¦ä¾§ï¼šèƒŒåŒ…åŒºåŸŸï¼ˆå¹¼å¹´åŠ¨ç‰©å¡ç‰Œå’Œé¥²æ–™ï¼‰
      const leftPanel = document.createElement('div');
      leftPanel.className = 'livestock-left';
      leftPanel.style.padding = '1rem';
      leftPanel.style.width = '40%';
      
      const animalTitle = document.createElement('h3');
      animalTitle.className = 'livestock-section-title';
      animalTitle.textContent = 'å¹¼å¹´åŠ¨ç‰©';
      leftPanel.appendChild(animalTitle);
      
      const animalContainer = document.createElement('div');
      animalContainer.className = 'livestock-inventory';
      animalContainer.style.display = 'flex';
      animalContainer.style.flexWrap = 'wrap';
      animalContainer.style.gap = '0.5rem';
      animalContainer.style.padding = '0.5rem';
      animalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
      animalContainer.style.borderRadius = '0.5rem';
      animalContainer.style.marginBottom = '1rem';
      animalContainer.style.maxHeight = '200px';
      animalContainer.style.overflowY = 'auto';
      animalContainer.id = 'livestock-animal-container';
      
      // æ·»åŠ å¹¼å¹´åŠ¨ç‰©å¡ç‰Œï¼ˆåªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„å¡ç‰Œï¼‰
      const babyAnimals = ['chick', 'duckling', 'piglet'];
      babyAnimals.forEach(animalId => {
        const animalAmount = gameData.resources[animalId]?.amount || 0;
        if (animalAmount > 0) {
          const animalCard = createAnimalCard(animalId, livestockData.animals[animalId]);
          animalContainer.appendChild(animalCard);
        }
      });
      
      leftPanel.appendChild(animalContainer);
      
      // ä¸ºåŠ¨ç‰©å®¹å™¨æ·»åŠ æ»šåŠ¨æ¡
      const animalScrollbar = document.createElement('div');
      animalScrollbar.className = 'resource-scrollbar';
      animalScrollbar.innerHTML = '<div class="resource-scrollbar-thumb"></div>';
      leftPanel.appendChild(animalScrollbar);
      
      // æ·»åŠ é¥²æ–™
      const feedTitle = document.createElement('h3');
      feedTitle.className = 'livestock-section-title';
      feedTitle.textContent = 'å…»æ®–ç”¨å“';
      leftPanel.appendChild(feedTitle);
      
      const feedContainer = document.createElement('div');
      feedContainer.className = 'livestock-inventory';
      feedContainer.style.display = 'flex';
      feedContainer.style.flexWrap = 'wrap';
      feedContainer.style.gap = '0.5rem';
      feedContainer.style.padding = '0.5rem';
      feedContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
      feedContainer.style.borderRadius = '0.5rem';
      feedContainer.style.maxHeight = '200px';
      feedContainer.style.overflowY = 'auto';
      
      // æ·»åŠ é¥²æ–™å¡ç‰Œï¼ˆä½¿ç”¨åŠ¨æ€æ›´æ–°çš„æ–¹å¼ï¼‰
      const feedContainerId = 'livestock-feed-container';
      feedContainer.id = feedContainerId;
      
      leftPanel.appendChild(feedContainer);
      
      // ä¸ºé¥²æ–™å®¹å™¨æ·»åŠ æ»šåŠ¨æ¡
      const feedScrollbar = document.createElement('div');
      feedScrollbar.className = 'resource-scrollbar';
      feedScrollbar.innerHTML = '<div class="resource-scrollbar-thumb"></div>';
      leftPanel.appendChild(feedScrollbar);
      
      // åœ¨å®¹å™¨æ·»åŠ åˆ°DOMåå†åˆå§‹åŒ–æ˜¾ç¤º
      setTimeout(() => {
        updateFeedDisplay(); // åˆå§‹åŒ–æ˜¾ç¤º
        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        if (window.initializeLivestockScrollbars) {
          window.initializeLivestockScrollbars();
        }
      }, 100);
      
      // å³ä¾§ï¼šç‰²å£æ£šåŒºåŸŸï¼ˆä¸‰ä¸ªæ ä½ï¼‰
      const rightPanel = document.createElement('div');
      rightPanel.className = 'livestock-right';
      rightPanel.style.width = '60%';

      // åˆ›å»ºæ ‡é¢˜å’Œå‡çº§æŒ‰é’®çš„å®¹å™¨
      const titleContainer = document.createElement('div');
      titleContainer.style.display = 'flex';
      titleContainer.style.justifyContent = 'space-between';
      titleContainer.style.alignItems = 'center';
      titleContainer.style.marginBottom = '15px';

      const livestockTitle = document.createElement('h3');
      livestockTitle.className = 'livestock-panel-title ink-text';
      livestockTitle.textContent = 'ç‰²å£æ ';
      livestockTitle.style.margin = '0';
      titleContainer.appendChild(livestockTitle);

      // æ·»åŠ å‡çº§æŒ‰é’®
      const upgradeBtn = document.createElement('button');
      upgradeBtn.className = 'upgrade-btn ink-button-small ink-button';
      upgradeBtn.id = 'livestock-upgrade-btn';
      upgradeBtn.style.marginLeft = '10px';
      upgradeBtn.style.fontSize = '0.9rem';
      upgradeBtn.style.padding = '0.5rem 1rem';
      titleContainer.appendChild(upgradeBtn);

      // æ›´æ–°å‡çº§æŒ‰é’®æ˜¾ç¤ºçš„å‡½æ•°
      window.updateLivestockUpgradeBtn = function() {
        const level = gameData.livestockData?.level || 1;
        if (level >= 4) {
          upgradeBtn.innerHTML = `<span>ç­‰çº§å·²è¾¾æ»¡çº§</span>`;
          upgradeBtn.disabled = true;
          upgradeBtn.style.opacity = '0.5';
        } else {
          upgradeBtn.innerHTML = `<span id="livestock-level-text">${level}çº§</span><span class="upgrade-icon">â¬†ï¸</span> å‡çº§`;
          upgradeBtn.disabled = false;
          upgradeBtn.style.opacity = '1';
        }
      };
      updateLivestockUpgradeBtn();

      // å‡çº§æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      upgradeBtn.onclick = function() {
        showLivestockUpgradeModal();
      };

      rightPanel.appendChild(titleContainer);

      const stallsContainer = document.createElement('div');
      stallsContainer.className = 'livestock-stalls';
      stallsContainer.style.display = 'grid';
      stallsContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
      stallsContainer.style.gridTemplateRows = 'repeat(2, 1fr)';
      stallsContainer.style.gap = '15px';
      
      // åˆ›å»º4ä¸ªç‰²å£æ 
      for (let i = 0; i < 4; i++) {
        const stall = createLivestockStall(i, livestockData.stalls[i]);
        stallsContainer.appendChild(stall);
      }
      
      rightPanel.appendChild(stallsContainer);
      
      modalBody.appendChild(leftPanel);
      modalBody.appendChild(rightPanel);
      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      
      // åˆå§‹åŒ–å…¨å±€å˜é‡
      window.selectedAnimal = null;
      window.selectedFeed = null;
      
      // æ·»åŠ åˆ°æ–‡æ¡£
      document.body.appendChild(modalContainer);

      // åˆå§‹åŒ–ç‰²å£æ æ˜¾ç¤ºçŠ¶æ€
      // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²ç»å®Œå…¨æ„å»º
      setTimeout(() => {
        if (window.updateLivestockInventory) {
          window.updateLivestockInventory();
        }
        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        if (window.initializeLivestockScrollbars) {
          window.initializeLivestockScrollbars();
        }
      }, 10);
      
      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .livestock-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }
        
        .livestock-modal.active {
          opacity: 1;
          visibility: visible;
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
        }
        
        .livestock-modal-content {
          background-color: #FFFDF7;
          border-radius: 0.25rem;
          width: 90%;
          max-width: 900px;
          padding: 1.5rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          transform: translateY(-20px);
          transition: all 0.3s ease;
        }
        
        .livestock-modal.active .livestock-modal-content {
          transform: translateY(0);
        }
        
        .livestock-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
        }
        
        .livestock-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .livestock-modal-close {
          background: none;
          border: none;
          font-size: 1.25rem;
          cursor: pointer;
          color: #4A5568;
        }
        
        .livestock-section-title {
          font-size: 1.2rem;
          font-weight: normal;
          margin-bottom: 0.75rem;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .livestock-panel-title {
          font-size: 1.2rem;
          font-weight: normal;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        /* ç‰²å£æ£šæ»šåŠ¨æ¡æ ·å¼ */
        .livestock-inventory::-webkit-scrollbar {
          width: 8px;
        }
        
        .livestock-inventory::-webkit-scrollbar-track {
          background: rgba(0, 0, 0, 0.05);
          border-radius: 4px;
        }
        
        .livestock-inventory::-webkit-scrollbar-thumb {
          background: #8D6E63;
          border-radius: 4px;
        }
        
        .livestock-inventory::-webkit-scrollbar-thumb:hover {
          background: #6D4C41;
        }
        
        /* ç‰²å£æ æ ·å¼ - ç«‹ä½“æ•ˆæœ */
        .livestock-stall {
          width: 200px;
          height: 200px;
          border: 2px solid #8D6E63;
          border-radius: 0.5rem;
          background-image: url('UI/ç‰²å£æ£š.jpg');
          background-size: cover;
          background-position: center;
          position: relative;
          display: flex;
          flex-direction: column;
          transition: all 0.3s ease;
          overflow: visible; /* ç¡®ä¿æµ‡æ°´ç‰¹æ•ˆå¯ä»¥è¶…å‡ºè¾¹ç•Œæ˜¾ç¤º */
          /* ç«‹ä½“æ•ˆæœ */
          box-shadow: 
            0 8px 6px -6px rgba(0, 0, 0, 0.5),
            0 2px 4px rgba(0, 0, 0, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.3),
            inset 0 -1px 0 rgba(0, 0, 0, 0.2);
          cursor: pointer; /* é»˜è®¤æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
        }
        
        /* å½“ç‰²å£æ æœ‰åŠ¨ç‰©æ—¶ï¼Œæ¸…é™¤é»˜è®¤èƒŒæ™¯å›¾ç‰‡ */
        .livestock-stall.has-animal,
        .livestock-stall.has-baby-animal {
          background-image: none !important;
          background-color: #FFFDF7;
        }
        
        .livestock-stall:hover {
          transform: translateY(-8px);
          box-shadow: 
            0 12px 10px -8px rgba(0, 0, 0, 0.6),
            0 4px 8px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.4),
            inset 0 -1px 0 rgba(0, 0, 0, 0.3);
          cursor: pointer; /* æ‚¬åœæ—¶æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
        }

        /* æ”¾ç½®åŠ¨ç‰©æ—¶çš„å¼¹è·³åŠ¨ç”» */
        .livestock-stall.placing, .farmland-cell.placing {
          animation: place-bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          overflow: visible !important;
          z-index: 1000;
        }

        /* æ”¾ç½®åŠ¨ç”»æ—¶ï¼Œå†œç”°æ ¼å­çš„ä½œç‰©å›¾ç‰‡è¾¹æ¡† */
        .farmland-cell.placing .crop-image {
          border: 3px solid #6D4C41;
          border-radius: 8px;
        }

        @keyframes place-bounce {
          0% {
            transform: scale(0.3) translateY(50px);
            opacity: 0;
          }
          25% {
            transform: scale(1.1) translateY(-10px);
            opacity: 1;
          }
          70% {
            transform: scale(0.95) translateY(5px);
          }
          100% {
            transform: scale(1) translateY(0);
          }
        }

        /* æ”¾ç½®æˆåŠŸæ—¶çš„é—ªå…‰ç‰¹æ•ˆ */
        .livestock-stall.flash, .farmland-cell.flash {
          position: relative;
        }

        .livestock-stall.flash::after, .farmland-cell.flash::after {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, transparent 70%);
          animation: flash-effect 0.8s ease-out forwards;
          pointer-events: none;
          z-index: 100;
        }

        @keyframes flash-effect {
          0% {
            opacity: 1;
            transform: scale(0);
          }
          50% {
            opacity: 0.8;
            transform: scale(1);
          }
          100% {
            opacity: 0;
            transform: scale(1.5);
          }
        }



        /* æˆåŠŸæ”¾ç½®åçš„ç²’å­æ•ˆæœå®¹å™¨ */
        .particle-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          overflow: hidden;
          z-index: 200;
        }

        /* ç²’å­æ•ˆæœ */
        .particle {
          position: absolute;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          animation: particle-fly 1s ease-out forwards;
        }

        @keyframes particle-fly {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--tx), var(--ty)) scale(0);
            opacity: 0;
          }
        }

        /* æ˜Ÿæ˜Ÿç‰¹æ•ˆ */
        .star {
          position: absolute;
          width: 20px;
          height: 20px;
          background: radial-gradient(circle, #FFD700 0%, transparent 70%);
          animation: star-twinkle 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 150;
        }

        @keyframes star-twinkle {
          0% {
            transform: scale(0) rotate(0deg);
            opacity: 0;
          }
          30% {
            transform: scale(1.2) rotate(45deg);
            opacity: 1;
          }
          60% {
            transform: scale(1) rotate(90deg);
            opacity: 0.8;
          }
          100% {
            transform: scale(0.5) rotate(180deg);
            opacity: 0;
          }
        }

        /* æˆåŠŸå›¾æ ‡åŠ¨ç”» */
        .success-icon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 60px;
          animation: success-pop 1s ease-out forwards;
          pointer-events: none;
          z-index: 180;
        }

        @keyframes success-pop {
          0% {
            transform: translate(-50%, -50%) scale(0) rotate(-180deg);
            opacity: 0;
          }
          40% {
            transform: translate(-50%, -50%) scale(1.3) rotate(10deg);
            opacity: 1;
          }
          70% {
            transform: translate(-50%, -50%) scale(0.9) rotate(-5deg);
            opacity: 0.9;
          }
          100% {
            transform: translate(-50%, -50%) scale(1) rotate(0);
            opacity: 0;
          }
        }

        /* é¢å¤–çš„å…‰ç¯æ•ˆæœ */
        .halo-effect {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 100%;
          height: 100%;
          border-radius: 50%;
          border: 3px solid rgba(255, 215, 0, 0.8);
          animation: halo-expand 1s ease-out forwards;
          pointer-events: none;
          z-index: 150;
        }

        @keyframes halo-expand {
          0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
          }
          50% {
            opacity: 0.6;
          }
          100% {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
          }
        }

        /* æ¼‚æµ®æ–‡å­—æ•ˆæœ */
        .floating-text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translateX(-50%) translateY(-50%);
          font-size: 1.2rem;
          font-weight: bold;
          color: #FFD700;
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
          animation: float-up 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 1000;
          white-space: nowrap;
        }

        @keyframes float-up {
          0% {
            top: 50%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(0.5);
          }
          20% {
            opacity: 1;
            transform: translateX(-50%) translateY(-50%) scale(1.2);
          }
          100% {
            top: 10%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(1);
          }
        }

        /* å½©è™¹ç²’å­ */
        .rainbow-particle {
          position: absolute;
          width: 6px;
          height: 6px;
          border-radius: 50%;
          animation: rainbow-particle-fly 1.2s ease-out forwards;
        }

        @keyframes rainbow-particle-fly {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--tx), var(--ty)) scale(0);
            opacity: 0;
          }
        }

        /* å¿ƒå½¢è¡¨æƒ…æ•ˆæœ */
        .heart-particle {
          position: absolute;
          font-size: 20px;
          animation: heart-float 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 190;
        }

        @keyframes heart-float {
          0% {
            transform: translateY(0) scale(0) rotate(-20deg);
            opacity: 0;
          }
          30% {
            transform: translateY(-20px) scale(1.2) rotate(10deg);
            opacity: 1;
          }
          100% {
            transform: translateY(-60px) scale(0.5) rotate(0);
            opacity: 0;
          }
        }
        
        .livestock-stall.active {
          border-color: #805AD5;
          box-shadow: 
            0 0 15px rgba(128, 90, 213, 0.5),
            0 8px 6px -6px rgba(128, 90, 213, 0.3),
            0 2px 4px rgba(128, 90, 213, 0.2),
            inset 0 0 10px rgba(128, 90, 213, 0.2);
        }
        
        .livestock-stall-content {
          padding: 0px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          width: 100%;
          position: relative;
          z-index: auto; /* æ”¹ä¸ºautoï¼Œé¿å…åˆ›å»ºå †å ä¸Šä¸‹æ–‡ */
          pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€å­å…ƒç´ ï¼Œç›´æ¥è§¦å‘çˆ¶å…ƒç´ çš„mouseenter/mouseleaveäº‹ä»¶ */
        }
        
        .livestock-animal-image {
          width: 200px;
          height: 200px;
          object-fit: cover;
          border-radius: 0.25rem;
          margin-bottom: 0rem;
          z-index: 10;
          position: relative;
          transform-origin: center center;
        }
        
        .livestock-animal-name {
          font-size: 1rem;
          font-weight: normal;
          color: #2D3748;
          margin-bottom: 0.25rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .livestock-animal-status {
          display: flex;
          flex-direction: column;
          align-items: center;
          font-size: 0.75rem;
          color: #4A5568;
          width: 100%;
        }
        
        .livestock-status-bar {
          width: 80%;
          height: 6px;
          background-color: #E2E8F0;
          border-radius: 3px;
          margin: 2px 0;
          overflow: hidden;
        }
        
        .livestock-status-fill {
          height: 100%;
          border-radius: 3px;
        }
        
        .livestock-health-fill {
          background-color: #38A169;
        }
        
        .livestock-productivity-fill {
          background-color: #805AD5;
        }
        
        .livestock-cleanliness-fill {
          background-color: #3182CE;
        }
        
        .livestock-egg-indicator {
          position: absolute;
          top: 2px;
          right: 2px;
          width: 28px;
          height: 28px;
          background: linear-gradient(135deg, #E53E3E 0%, #C53030 100%);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 0.9rem;
          cursor: pointer;
          z-index: 10;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
          transition: all 0.3s ease;
          animation: egg-pulse 2s infinite;
        }
        
        .livestock-egg-indicator:hover {
          transform: scale(1.1);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          background: linear-gradient(135deg, #F56565 0%, #E53E3E 100%);
        }
        
        .livestock-egg-indicator:active {
          transform: scale(0.95);
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes egg-pulse {
          0% {
            box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7);
          }
          70% {
            box-shadow: 0 0 0 6px rgba(229, 62, 62, 0);
          }
          100% {
            box-shadow: 0 0 0 0 rgba(229, 62, 62, 0);
          }
        }
        
        .livestock-clean-indicator {
          position: absolute;
          bottom: 2px;
          right: 2px;
          width: 20px;
          height: 20px;
          background-color: #3182CE;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 0.6rem;
          cursor: pointer;
          z-index: 10;
        }
        
        .livestock-feed-button {
          position: absolute;
          bottom: 2px;
          left: 2px;
          width: 20px;
          height: 20px;
          background-color: #38A169;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.6rem;
          cursor: pointer;
          z-index: 10;
        }
        
        /* åŠ¨ç‰©å¡ç‰Œæ ·å¼ */
        .livestock-animal-card {
          width: 100px;
          height: 120px;
          border: 2px solid #8D6E63;
          border-radius: 0.5rem;
          background-color: #FFFDF7;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 0.5rem;
          cursor: grab;
          transition: all 0.3s ease;
        }
        
        .livestock-animal-card:hover {
          transform: scale(1.05);
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .livestock-animal-card.dragging {
          opacity: 0.5;
          cursor: grabbing;
        }
        
        .livestock-animal-card-image {
          width: 60px;
          height: 60px;
          object-fit: cover;
          border-radius: 0.25rem;
          margin-bottom: 0.25rem;
        }
        
        .livestock-animal-card-name {
          font-size: 0.875rem;
          font-weight: normal;
          color: #2D3748;
          text-align: center;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .livestock-animal-card-count {
          font-size: 0.75rem;
          color: #4A5568;
        }
        
        /* å·¥å…·æç¤ºæ ·å¼ */
        .livestock-tooltip {
          position: fixed;
          background-color: rgba(45, 55, 72, 0.95);
          backdrop-filter: blur(5px);
          color: #F7FAFC;
          padding: 12px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          font-size: 0.8rem;
          max-width: 220px;
          z-index: 2000;
          opacity: 0;
          transform: translateY(-5px);
          animation: fadeInTooltip 0.3s ease-out forwards;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
          pointer-events: auto; /* å…è®¸é¼ æ ‡ä¸å·¥å…·æç¤ºäº¤äº’ */
        }
        
        .livestock-tooltip-title {
          font-weight: bold;
          font-size: 16px;
          margin-bottom: 8px;
          border-bottom: 1px solid rgba(255,255,255,0.3);
          padding-bottom: 6px;
        }
        
        .livestock-tooltip-info {
          margin: 5px 0;
          display: block;
        }
        
        .livestock-tooltip-info div {
          margin-bottom: 0.25rem;
        }
        
        .livestock-tooltip-action {
          margin-top: 0.5rem;
          padding-top: 0.25rem;
          border-top: 1px solid rgba(255,255,255,0.3);
          color: white;
          font-style: italic;
        }
        
        .tooltip-label {
          color: rgba(255,255,255,0.8);
        }
        
        .tooltip-value {
          font-weight: bold;
        }
        
        .status-good { color: #4CAF50; }
        .status-warning { color: #FFC107; }
        .status-danger { color: #F44336; }

        /* æœªè§£é”çš„æ ä½æ ·å¼ */
        .livestock-stall.locked,
        .stable-stall.locked {
          opacity: 0.5;
          cursor: not-allowed;
          filter: grayscale(80%);
          pointer-events: none;
        }

        .livestock-stall.locked:hover,
        .stable-stall.locked:hover {
          transform: none;
          box-shadow: none;
          cursor: not-allowed;
        }

        .stall-lock-icon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 48px;
          text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
          z-index: 20;
        }

        /* æµ‡æ°´ç‰¹æ•ˆæ ·å¼ */
        .water-ripple {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          border: 2px solid rgba(135, 206, 250, 0.8);
          border-radius: 50%;
          animation: water-ripple-expand 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 180;
        }

        @keyframes water-ripple-expand {
          0% {
            width: 10px;
            height: 10px;
            opacity: 1;
          }
          100% {
            width: 150px;
            height: 150px;
            opacity: 0;
          }
        }

        .water-drop {
          position: absolute;
          width: 10px;
          height: 15px;
          background: radial-gradient(ellipse at 50% 30%, rgba(135, 206, 250, 0.9), rgba(70, 130, 180, 0.7));
          border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
          animation: water-drop-fall 1.2s ease-in forwards;
          pointer-events: none;
          z-index: 200;
        }

        @keyframes water-drop-fall {
          0% {
            transform: translateY(-50px) scale(0);
            opacity: 0;
          }
          20% {
            transform: translateY(0) scale(1);
            opacity: 1;
          }
          60% {
            transform: translateY(30px) scale(1.1);
            opacity: 0.8;
          }
          100% {
            transform: translateY(50px) scale(0.3);
            opacity: 0;
          }
        }

        .water-splash-particle {
          position: absolute;
          width: 8px;
          height: 8px;
          background: radial-gradient(circle, rgba(173, 216, 230, 0.9), transparent);
          border-radius: 50%;
          animation: water-splash 0.8s ease-out forwards;
          pointer-events: none;
          z-index: 190;
        }

        @keyframes water-splash {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--sx), var(--sy)) scale(0);
            opacity: 0;
          }
        }

        /* æ¼‚æµ®æ–‡å­—æ•ˆæœ */
        .floating-text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translateX(-50%) translateY(-50%);
          font-size: 1.2rem;
          font-weight: bold;
          color: #FFD700;
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
          animation: float-up 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 1000;
          white-space: nowrap;
        }

        @keyframes float-up {
          0% {
            top: 50%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(0.5);
          }
          20% {
            opacity: 1;
            transform: translateX(-50%) translateY(-50%) scale(1.2);
          }
          100% {
            top: 10%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(1);
          }
        }
      `;
      document.head.appendChild(style);
      
      // æ’­æ”¾å†œåœºéŸ³æ•ˆ
      playFarmSound();
      
      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);
      
      // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          // å…³é—­ç‰²å£æ æ‚¬åœæç¤º
          hideLivestockTooltip();
          // æ¸…é™¤å®šæ—¶å™¨
          if (window.livestockHoverTimer) {
            clearTimeout(window.livestockHoverTimer);
            window.livestockHoverTimer = null;
          }
          window.livestockTooltipVisible = false;
          
          // ç§»é™¤æ‰€æœ‰ç‰²å£æ çš„tooltipå…ƒç´ 
          const allLivestockTooltips = document.querySelectorAll('#livestock-tooltip, .livestock-tooltip-element');
          allLivestockTooltips.forEach(tooltip => {
            if (tooltip.parentNode) {
              tooltip.remove();
            }
          });
          
          modalContainer.classList.remove('active');
          setTimeout(() => {
            gameData.livestockData = livestockData;
            updateGameData();
            modalContainer.remove();
          }, 300);
        }
      };
    }

    // åˆ›å»ºåŠ¨ç‰©å¡ç‰Œ
    window.createAnimalCard = function(animalId, animalData) {
      const resource = gameData.resources[animalId];
      const card = document.createElement('div');
      card.className = 'livestock-animal-card livestock-card';
      card.dataset.animalId = animalId;
      card.style.cursor = 'pointer'; // æ”¹ä¸ºæŒ‡é’ˆå…‰æ ‡

      // ä½¿ç”¨å¯¹åº”çš„å¹¼å¹´åŠ¨ç‰©å›¾ç‰‡ï¼Œè€Œä¸æ˜¯ç»Ÿä¸€çš„å¹¼å¹´æœŸå›¾ç‰‡
      const animalImages = {
        'chick': 'UI/é¸¡å´½.jpg',
        'duckling': 'UI/é¸­å´½.jpg',
        'piglet': 'UI/çŒªå´½.jpg'
      };

      card.innerHTML = `
        <img src="${animalImages[animalId] || animalData.babyImage}" alt="${animalData.babyName}" class="livestock-animal-card-image">
        <div class="livestock-animal-card-name">${animalData.babyName}</div>
        <div class="livestock-animal-card-count">æ•°é‡: ${resource.amount}</div>
      `;

      // æ·»åŠ æ‚¬æµ®æ˜¾ç¤ºåŠŸèƒ½ï¼ˆä»¿ç…§å†œç”°çª—å£å®ç°ï¼‰
      card.addEventListener('mouseenter', function() {
        hideLivestockTooltip(); // å…ˆéšè—å¯èƒ½å­˜åœ¨çš„æ—§æç¤º

        const tooltip = document.createElement('div');
        tooltip.id = 'livestock-tooltip';
        tooltip.className = 'livestock-tooltip';
        // è·å–åŠ¨ç‰©æˆé•¿æ—¶é—´
        const growthTime = animalData.growthTime || 10; // é»˜è®¤10å¤©

        tooltip.innerHTML = `
          <div class="livestock-tooltip-title">${animalData.babyName}</div>
          <div class="livestock-tooltip-info">æ•°é‡: ${resource.amount}</div>
          <div class="livestock-tooltip-info">ç±»å‹: å¹¼å¹´åŠ¨ç‰©</div>
          <div class="livestock-tooltip-info">æˆé•¿æ—¶é—´: ${growthTime}å¤©</div>
        `;

        document.body.appendChild(tooltip);

        // å®šä½å·¥å…·æç¤º
        const rect = card.getBoundingClientRect();
        tooltip.style.position = 'fixed';
        tooltip.style.left = rect.right + 10 + 'px';
        tooltip.style.top = rect.top + 'px';
        tooltip.style.zIndex = '2000';

        // æ·»åŠ æ·¡å…¥åŠ¨ç”»
        tooltip.style.opacity = '0';
        tooltip.style.transform = 'translateY(-5px)';
        setTimeout(() => {
          tooltip.style.opacity = '1';
          tooltip.style.transform = 'translateY(0)';
          tooltip.style.transition = 'all 0.3s ease-out';
        }, 10);
      });

      // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
      card.addEventListener('mouseleave', function() {
        hideLivestockTooltip();
      });

      // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
      card.addEventListener('mousedown', function(e) {
        e.preventDefault();
        const animalAmount = gameData.resources[animalId]?.amount || 0;
        if (animalAmount <= 0) {
          showNotification('å¹¼å´½ä¸è¶³', `ä½ æ²¡æœ‰${animalData.babyName}ï¼`);
          return;
        }

        // åˆ›å»ºç‰²å£å…‰æ ‡
        createLivestockCursor(animalId, 'animal');
      });

      return card;
    }

    // åˆ›å»ºç‰²å£æ 
    window.createLivestockStall = function(stallIndex, stallData) {
      const stall = document.createElement('div');
      stall.className = 'livestock-stall';
      stall.dataset.stallIndex = stallIndex;

      // æ£€æŸ¥ç‰²å£æ æ˜¯å¦è§£é”ï¼ˆç­‰çº§é™åˆ¶ï¼‰
      const isUnlocked = stallIndex < (gameData.livestockData?.level || 1);
      if (!isUnlocked) {
        stall.classList.add('locked');
        // æ·»åŠ é”çš„æ ‡è¯†
        const lockIcon = document.createElement('div');
        lockIcon.className = 'stall-lock-icon';
        lockIcon.innerHTML = 'ğŸ”’';
        stall.appendChild(lockIcon);
        // æœªè§£é”çš„æ ä½ç¦ç”¨æ‹–æ”¾äº‹ä»¶
        return stall;
      }

      updateStallDisplay(stall, stallData, stallIndex);

      return stall;
    }

    // æ›´æ–°ç‰²å£æ æ˜¾ç¤º
    window.updateStallDisplay = function(stall, stallData, stallIndex) {
      const livestockData = gameData.livestockData;

      // åªåœ¨stallå·²ç»æ·»åŠ åˆ°DOMä¸­æ—¶æ‰å…‹éš†èŠ‚ç‚¹
      // é¦–æ¬¡åˆ›å»ºæ—¶stall.parentNodeä¸ºnullï¼Œç›´æ¥æ“ä½œstall
      let targetStall = stall;
      if (stall.parentNode) {
        // å…‹éš†èŠ‚ç‚¹ä»¥æ¸…é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        targetStall = stall.cloneNode(true);
        stall.parentNode.replaceChild(targetStall, stall);
      }

      // æ¸…ç©ºå†…å®¹
      targetStall.innerHTML = '';

      // æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬å™¨
      targetStall.addEventListener('dragover', function(e) {
        e.preventDefault();
        // åªå¯¹æœ‰åŠ¨ç‰©çš„æ ä½æ˜¾ç¤ºé«˜äº®
        if (stallData.animal) {
          targetStall.classList.add('drag-over');
          targetStall.style.border = '2px dashed #4CAF50';
          targetStall.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
        }
      });

      targetStall.addEventListener('dragleave', function(e) {
        e.preventDefault();
        targetStall.classList.remove('drag-over');
        targetStall.style.border = '';
        targetStall.style.backgroundColor = '';
      });

      targetStall.addEventListener('drop', function(e) {
        e.preventDefault();
        targetStall.classList.remove('drag-over');
        targetStall.style.border = '';
        targetStall.style.backgroundColor = '';

        // è·å–æ‹–æ‹½çš„ç‰©å“
        const draggedItem = window.currentDraggingSeed || window.selectedSeed || window.selectedTool;

        // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ç‰©
        if (stallData.animal && (draggedItem === 'water_bag' || draggedItem === 'bucket')) {
          // ä½¿ç”¨ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
          const waterAmount = draggedItem === 'water_bag' ? 20 : 25;
          const result = useWaterFromContainer(draggedItem, waterAmount);
          const waterSource = draggedItem === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶';

          if (result.success) {
            // å¢åŠ åŠ¨ç‰©çš„å¥åº·å€¼å’Œé¥±é£Ÿåº¦
            stallData.health = Math.min(100, stallData.health + result.usedAmount * 0.5);
            stallData.satiety = Math.min(100, stallData.satiety + result.usedAmount * 0.3);
            stallData.lastFedDay = gameData.day; // æ›´æ–°å–‚å…»æ—¥æœŸ

            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
            targetStall.classList.add('water-animation');

            // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
            const cssLoaded = document.getElementById('animation-effects-css') !== null;
            const waterEffectExists = typeof window.createWaterEffect === 'function';
            const waterFloatingTextExists = typeof window.createWaterFloatingText === 'function';

            if (!waterEffectExists || !waterFloatingTextExists || !cssLoaded) {
              console.log('ç‰²å£æ ï¼šåŠ¨ç”»ç‰¹æ•ˆæœªå®Œå…¨åˆå§‹åŒ–ï¼Œå¼€å§‹åˆå§‹åŒ–...');
              console.log('  - CSSå·²åŠ è½½:', cssLoaded);
              console.log('  - createWaterEffectå­˜åœ¨:', waterEffectExists);
              console.log('  - createWaterFloatingTextå­˜åœ¨:', waterFloatingTextExists);

              if (typeof initializeAnimationCSS === 'function') {
                initializeAnimationCSS();
                console.log('  - initializeAnimationCSS() å·²è°ƒç”¨');
              }
              if (typeof initializeAnimationEffects === 'function') {
                initializeAnimationEffects();
                console.log('  - initializeAnimationEffects() å·²è°ƒç”¨');
              }

              // å†æ¬¡æ£€æŸ¥åˆå§‹åŒ–ç»“æœ
              console.log('ç‰²å£æ ï¼šåˆå§‹åŒ–åæ£€æŸ¥...');
              console.log('  - CSSå·²åŠ è½½:', document.getElementById('animation-effects-css') !== null);
              console.log('  - createWaterEffectå­˜åœ¨:', typeof window.createWaterEffect === 'function');
              console.log('  - createWaterFloatingTextå­˜åœ¨:', typeof window.createWaterFloatingText === 'function');
            }

            // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
            if (window.createWaterEffect) {
              window.createWaterEffect(targetStall);
              console.log('ç‰²å£æ ï¼šæ°´æ³¢çº¹ç‰¹æ•ˆå·²è§¦å‘');
            } else {
              console.warn('ç‰²å£æ ï¼šcreateWaterEffectå‡½æ•°æœªå®šä¹‰ï¼');
            }
            if (window.createWaterFloatingText) {
              window.createWaterFloatingText(targetStall);
              console.log('ç‰²å£æ ï¼šæµ‡æ°´æ¼‚æµ®æ–‡å­—å·²è§¦å‘');
            } else {
              console.warn('ç‰²å£æ ï¼šcreateWaterFloatingTextå‡½æ•°æœªå®šä¹‰ï¼');
            }

            // 1500msåç§»é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
              targetStall.classList.remove('water-animation');
            }, 1500);

            // 2000msåæ›´æ–°æ˜¾ç¤ºï¼ˆç¡®ä¿æ‰€æœ‰ç‰¹æ•ˆæ’­æ”¾å®Œæˆï¼‰
            setTimeout(() => {
              // é‡æ–°æ¸²æŸ“ç‰²å£æ 
              renderLivestockStalls();
              renderResources();
              updateGameData();
              showNotification('å–‚æ°´æˆåŠŸ', `ä½¿ç”¨${waterSource}ç»™åŠ¨ç‰©å–‚æ°´æˆåŠŸï¼`);
            }, 2000);
          } else {
            showNotification('æ°´èµ„æºä¸è¶³', result.message);
          }
        } else if (!stallData.animal) {
          showNotification('æ²¡æœ‰åŠ¨ç‰©', 'è¿™ä¸ªæ ä½ä¸­æ²¡æœ‰åŠ¨ç‰©ï¼Œæ— æ³•å–‚æ°´ï¼');
        }
      });

      const stallContent = document.createElement('div');
      stallContent.className = 'livestock-stall-content';

      if (stallData.animal) {
        // æ˜¾ç¤ºåŠ¨ç‰©ä¿¡æ¯
        const animalData = livestockData.animals[stallData.animal];
        const isAdult = stallData.growthStage === 2;

        // æ ¹æ®ç”Ÿé•¿é˜¶æ®µæ·»åŠ ä¸åŒçš„ç±»
        if (isAdult) {
          targetStall.classList.add('has-animal');
        } else {
          targetStall.classList.add('has-baby-animal');
        }

        // è·å–æ­£ç¡®çš„å›¾ç‰‡è·¯å¾„
        let imageUrl;
        if (isAdult) {
          imageUrl = animalData.adultImage;
        } else {
          // å¹¼å¹´æœŸä½¿ç”¨ç‰¹å®šçš„å¹¼å´½å›¾ç‰‡
          const babyImages = {
            'chick': 'UI/é¸¡å¹¼å¹´æœŸ.jpg',
            'duckling': 'UI/é¸­å¹¼å¹´æœŸ.jpg',
            'piglet': 'UI/çŒªå¹¼å¹´æœŸ.jpg'
          };
          imageUrl = babyImages[stallData.animal] || animalData.babyImage;
        }

        // åŠ¨ç‰©å›¾ç‰‡
        const animalImage = document.createElement('img');
        animalImage.src = imageUrl;
        animalImage.className = 'livestock-animal-image';
        stallContent.appendChild(animalImage);

        // ä¸å†æ˜¾ç¤ºåŠ¨ç‰©åç§°ï¼ŒæŒ‰ç…§è¦æ±‚ä»…æ˜¾ç¤ºå›¾ç‰‡

        // æ·»åŠ æ‚¬åœäº‹ä»¶ç›‘å¬å™¨
        targetStall.addEventListener('mouseenter', function(e) {
          // æ£€æŸ¥ç‰²å£æ£šçª—å£æ˜¯å¦å­˜åœ¨
          const livestockModal = document.getElementById('livestockModal');
          if (!livestockModal) return;
          // æ£€æŸ¥æ˜¯å¦è§£é”
          const isUnlocked = stallIndex < (gameData.livestockData?.level || 1);
          if (!isUnlocked) return;

          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
          if (window.livestockHoverTimer) {
            clearTimeout(window.livestockHoverTimer);
            window.livestockHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œä¸å†æ‰§è¡Œ
          if (window.livestockTooltipVisible) return;

          // è®¾ç½®0.5ç§’å»¶è¿Ÿæ˜¾ç¤º
          window.livestockHoverTimer = setTimeout(() => {
            showLivestockTooltip(targetStall, stallData, stallIndex);
            window.livestockTooltipVisible = true;
          }, 500);
        });

        targetStall.addEventListener('mouseleave', function() {
          // æ¸…é™¤å®šæ—¶å™¨ï¼ˆå¦‚æœè¿˜æœªæ˜¾ç¤ºï¼‰
          if (window.livestockHoverTimer) {
            clearTimeout(window.livestockHoverTimer);
            window.livestockHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œç«‹å³éšè—
          if (window.livestockTooltipVisible) {
            hideLivestockTooltip();
            window.livestockTooltipVisible = false;
          }
        });

        // å¦‚æœæ˜¯æˆå¹´æœŸä¸”èƒ½äº§è›‹ï¼Œå¹¶ä¸”ä»Šå¤©è¿˜æ²¡æœ‰æ”¶è·è¿‡ï¼Œæ˜¾ç¤ºè›‹æŒ‡ç¤ºå™¨
        if (isAdult && animalData.product === 'egg' && stallData.lastProducedDay !== gameData.day) {
          const eggIndicator = document.createElement('div');
          eggIndicator.className = 'livestock-egg-indicator';
          eggIndicator.innerHTML = 'ğŸ¥š';

          // è®¾ç½®æ‚¬åœæç¤ºï¼Œæ˜¾ç¤ºå¯èƒ½çš„è›‹æ•°é‡
          let estimatedEggs = 1;
          if (stallData.health >= 80) estimatedEggs = 3;
          else if (stallData.health >= 50) estimatedEggs = 2;

          eggIndicator.title = `ç‚¹å‡»æ”¶è·è›‹ (é¢„è®¡${estimatedEggs}ä¸ª)`;

          // æ·»åŠ æ‚¬åœå’Œç‚¹å‡»æ•ˆæœ
          eggIndicator.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.15) rotate(10deg)';
          });

          eggIndicator.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1) rotate(0deg)';
          });

          eggIndicator.onclick = (e) => {
            e.stopPropagation();
            collectEgg(stallIndex);
          };
          targetStall.appendChild(eggIndicator);
        }

        // å¦‚æœæ±¡æµŠåº¦è¾¾åˆ°100ï¼Œæ˜¾ç¤ºæ¸…ç†æŒ‡ç¤ºå™¨
        if (stallData.cleanliness >= 100) {
          const cleanIndicator = document.createElement('div');
          cleanIndicator.className = 'livestock-clean-indicator';
          cleanIndicator.innerHTML = 'ğŸ§¹';
          cleanIndicator.title = 'ç‚¹å‡»æ¸…ç†è·å¾—è‚¥æ–™';
          cleanIndicator.onclick = (e) => {
            e.stopPropagation();
            cleanStall(stallIndex);
          };
          targetStall.appendChild(cleanIndicator);
        }

        // å·²ç§»é™¤å–‚å…»æŒ‰é’®ï¼Œæ”¹ä¸ºä»å·¦ä¾§æ‹–æ‹½é¥²æ–™å–‚å…»

        // å¦‚æœæ˜¯æˆå¹´æœŸï¼Œç‚¹å‡»æ”¶è·
        if (isAdult) {
          targetStall.style.cursor = 'pointer';
          targetStall.classList.add('adult-animal');
          targetStall.onclick = (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            harvestAnimal(stallIndex);
          };
        }
      } else {
        // ç©ºæ  - æ˜¾ç¤ºé»˜è®¤èƒŒæ™¯å’Œæ·»åŠ æ‚¬åœäº‹ä»¶
        targetStall.style.backgroundImage = "url('UI/ç‰²å£æ£š.jpg')";

        // æ·»åŠ æ‚¬åœäº‹ä»¶ç›‘å¬å™¨ï¼ˆ0.5ç§’å»¶è¿Ÿï¼‰
        targetStall.addEventListener('mouseenter', function(e) {
          // æ£€æŸ¥ç‰²å£æ£šçª—å£æ˜¯å¦å­˜åœ¨
          const livestockModal = document.getElementById('livestockModal');
          if (!livestockModal) return;
          // æ£€æŸ¥æ˜¯å¦è§£é”
          const isUnlocked = stallIndex < (gameData.livestockData?.level || 1);
          if (!isUnlocked) return;

          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
          if (window.livestockHoverTimer) {
            clearTimeout(window.livestockHoverTimer);
            window.livestockHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œä¸å†æ‰§è¡Œ
          if (window.livestockTooltipVisible) return;

          // è®¾ç½®0.5ç§’å»¶è¿Ÿæ˜¾ç¤º
          window.livestockHoverTimer = setTimeout(() => {
            showLivestockTooltip(targetStall, stallData, stallIndex);
            window.livestockTooltipVisible = true;
          }, 500);
        });

        targetStall.addEventListener('mouseleave', function() {
          // æ¸…é™¤å®šæ—¶å™¨ï¼ˆå¦‚æœè¿˜æœªæ˜¾ç¤ºï¼‰
          if (window.livestockHoverTimer) {
            clearTimeout(window.livestockHoverTimer);
            window.livestockHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œç«‹å³éšè—
          if (window.livestockTooltipVisible) {
            hideLivestockTooltip();
            window.livestockTooltipVisible = false;
          }
        });
      }

      targetStall.appendChild(stallContent);
    }

    // æ˜¾ç¤ºç‰²å£æ å·¥å…·æç¤º
    window.showLivestockTooltip = function(stall, stallData, stallIndex) {
      // æ£€æŸ¥ç‰²å£æ£šçª—å£æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸æ˜¾ç¤ºtooltip
      const livestockModal = document.getElementById('livestockModal');
      if (!livestockModal) return;

      // å¦‚æœå·²å­˜åœ¨å·¥å…·æç¤ºï¼Œå…ˆç§»é™¤æ‰€æœ‰tooltip
      hideLivestockTooltip();
      hideStableTooltip();

      const livestockData = gameData.livestockData;
      const hasAnimal = stallData.animal !== null;
      const isAdult = stallData.growthStage === 2;

      // åˆ›å»ºå·¥å…·æç¤ºå…ƒç´ 
      const tooltip = document.createElement('div');
      tooltip.id = 'livestock-tooltip';
      tooltip.className = 'livestock-tooltip-element';

      // ç‰²å£æ ç¼–å·
      const header = document.createElement('div');
      header.className = 'tooltip-header';
      header.textContent = `ç‰²å£æ  ${stallIndex + 1}`;
      tooltip.appendChild(header);

      // æ ¹æ®æ˜¯å¦æœ‰åŠ¨ç‰©æ˜¾ç¤ºä¸åŒä¿¡æ¯
      if (hasAnimal) {
        const animalData = livestockData.animals[stallData.animal];

        // åŠ¨ç‰©ç§ç±»
        const animalType = document.createElement('div');
        animalType.className = 'tooltip-status';
        const animalName = isAdult ? animalData.name : animalData.babyName;
        animalType.innerHTML = `<div class="tooltip-label">åŠ¨ç‰©ç§ç±»ï¼š</div><div class="tooltip-value">${animalName}</div>`;
        tooltip.appendChild(animalType);

        // æˆé•¿é˜¶æ®µ
        const growthStage = document.createElement('div');
        growthStage.className = 'tooltip-status';
        const growthStageText = isAdult ? 'æˆå¹´æœŸ' : 'å¹¼å¹´æœŸ';
        growthStage.innerHTML = `<div class="tooltip-label">æˆé•¿é˜¶æ®µï¼š</div><div class="tooltip-value">${growthStageText}</div>`;
        tooltip.appendChild(growthStage);

        // åˆ†éš”çº¿
        const divider = document.createElement('div');
        divider.className = 'tooltip-divider';
        tooltip.appendChild(divider);

        // å¥åº·å€¼
        const healthStatus = document.createElement('div');
        healthStatus.className = 'tooltip-resources';
        healthStatus.innerHTML = `
          <div class="tooltip-label">å¥åº·å€¼ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${stallData.health}%; background-color: ${stallData.health <= 30 ? '#E53E3E' : '#38A169'};"></div>
          </div>
          <div class="tooltip-value">${stallData.health}%</div>
        `;
        tooltip.appendChild(healthStatus);

        // é¥±é£Ÿåº¦
        const satietyValue = stallData.satiety !== undefined ? stallData.satiety : 100;
        const satietyStatus = document.createElement('div');
        satietyStatus.className = 'tooltip-resources';
        satietyStatus.innerHTML = `
          <div class="tooltip-label">é¥±é£Ÿåº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${satietyValue}%; background-color: ${satietyValue <= 20 ? '#E53E3E' : '#ED8936'};"></div>
          </div>
          <div class="tooltip-value">${satietyValue}%</div>
        `;
        tooltip.appendChild(satietyStatus);

        // å£æ¸´åº¦
        const thirstValue = stallData.thirst !== undefined ? stallData.thirst : 100;
        const thirstStatus = document.createElement('div');
        thirstStatus.className = 'tooltip-resources';
        thirstStatus.innerHTML = `
          <div class="tooltip-label">å£æ¸´åº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${thirstValue}%; background-color: ${thirstValue <= 20 ? '#E53E3E' : '#3182CE'};"></div>
          </div>
          <div class="tooltip-value">${thirstValue}%</div>
        `;
        tooltip.appendChild(thirstStatus);

        // ç”Ÿäº§æ•ˆç‡ï¼ˆä»…æˆå¹´æœŸæ˜¾ç¤ºï¼‰
        if (isAdult) {
          const productivityStatus = document.createElement('div');
          productivityStatus.className = 'tooltip-resources';
          productivityStatus.innerHTML = `
            <div class="tooltip-label">ç”Ÿäº§æ•ˆç‡ï¼š</div>
            <div class="tooltip-progress">
              <div class="tooltip-progress-bar" style="width: ${stallData.productivity}%; background-color: ${stallData.productivity <= 30 ? '#E53E3E' : '#805AD5'};"></div>
            </div>
            <div class="tooltip-value">${stallData.productivity}%</div>
          `;
          tooltip.appendChild(productivityStatus);
        }

        // æ±¡æµŠåº¦
        const cleanlinessStatus = document.createElement('div');
        cleanlinessStatus.className = 'tooltip-resources';
        cleanlinessStatus.innerHTML = `
          <div class="tooltip-label">æ±¡æµŠåº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${stallData.cleanliness}%; background-color: ${stallData.cleanliness <= 50 ? '#3182CE' : '#E53E3E'};"></div>
          </div>
          <div class="tooltip-value">${stallData.cleanliness}%</div>
        `;
        tooltip.appendChild(cleanlinessStatus);
      }

      // æè¿°ä¿¡æ¯
      const description = document.createElement('div');
      description.className = 'tooltip-description';
      if (hasAnimal) {
        if (isAdult) {
          description.textContent = 'ç‚¹å‡»æ”¶è·';
          description.style.color = '#FFD700';
        } else {
          description.textContent = 'æ‹–æ‹½é¥²æ–™æˆ–è¯ä¸¸å–‚å…»';
        }
      } else {
        // ç©ºæ  - æ˜¾ç¤ºç©ºæ ä¿¡æ¯
        const emptyStatus = document.createElement('div');
        emptyStatus.className = 'tooltip-status';
        emptyStatus.innerHTML = `
          <div class="tooltip-label">çŠ¶æ€ï¼š</div>
          <div class="tooltip-value" style="color: #CBD5E0;">ç©ºé—²</div>
        `;
        tooltip.appendChild(emptyStatus);

        description.textContent = 'æ‹–æ‹½å¹¼å¹´åŠ¨ç‰©åˆ°æ­¤æ è¿›è¡Œå…»æ®–';
      }
      tooltip.appendChild(description);

      // è®¾ç½®æ ·å¼å¹¶æ·»åŠ åˆ°é¡µé¢
      tooltip.style.position = 'fixed';
      tooltip.style.zIndex = '1001';
      tooltip.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
      tooltip.style.color = 'white';
      tooltip.style.padding = '12px';
      tooltip.style.borderRadius = '8px';
      tooltip.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
      tooltip.style.width = '220px';
      tooltip.style.fontSize = '14px';
      tooltip.style.lineHeight = '1.5';
      tooltip.style.pointerEvents = 'none';

      // è®¡ç®—ä½ç½® - ä½¿ç”¨é¼ æ ‡ä½ç½®
      const rect = stall.getBoundingClientRect();
      const tooltipX = rect.left;
      const tooltipY = rect.bottom;

      // ç¡®ä¿æç¤ºæ¡†ä¸è¶…å‡ºçª—å£è¾¹ç•Œï¼ˆä¸å†œç”°æ ¼å­ä¸€è‡´ï¼Œå®½åº¦220pxï¼‰
      let left = tooltipX + 15;
      let top = tooltipY + 15;

      // æ£€æŸ¥å³ä¾§è¾¹ç•Œï¼ˆå®½åº¦220pxï¼‰
      if (left + 220 > window.innerWidth) {
        left = tooltipX - 220 - 15;
      }

      // æ£€æŸ¥åº•éƒ¨è¾¹ç•Œ
      if (top + 150 > window.innerHeight) {
        top = tooltipY - 150 - 15;
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';

      document.body.appendChild(tooltip);

      // æ·»åŠ æ·¡å…¥æ•ˆæœ
      tooltip.style.opacity = '0';
      tooltip.style.transition = 'opacity 0.3s ease';

      // è§¦å‘é‡æ’ä»¥åº”ç”¨è¿‡æ¸¡æ•ˆæœ
      tooltip.offsetHeight;

      tooltip.style.opacity = '1';
    };

    // éšè—ç‰²å£æ å·¥å…·æç¤º
    window.hideLivestockTooltip = function() {
      // ç§»é™¤æ‰€æœ‰ç‰²å£æ ç›¸å…³çš„tooltipå…ƒç´ ï¼ˆç¡®ä¿æ¸…ç†å¹²å‡€ï¼‰
      const tooltips = document.querySelectorAll('#livestock-tooltip, .livestock-tooltip-element');
      tooltips.forEach(tooltip => {
        if (tooltip.parentNode) {
          tooltip.remove();
        }
      });
      // æ›´æ–°å¯è§æ€§æ ‡å¿—
      window.livestockTooltipVisible = false;
    };

    // ç‰²å£æ£šå‡çº§é…ç½®
    const livestockUpgradeCosts = [
      { level: 1, wood: 20, grass: 20 },  // 1çº§å‡2çº§
      { level: 2, wood: 50, grass: 50 },  // 2çº§å‡3çº§
      { level: 3, wood: 100, grass: 100 }  // 3çº§å‡4çº§
    ];

    // é©¬å©å‡çº§é…ç½®
    const stableUpgradeCosts = [
      { level: 1, wood: 20, grass: 20 },  // 1çº§å‡2çº§
      { level: 2, wood: 50, grass: 50 },  // 2çº§å‡3çº§
      { level: 3, wood: 100, grass: 100 }  // 3çº§å‡4çº§
    ];

    // æ˜¾ç¤ºç‰²å£æ£šå‡çº§æ¨¡æ€æ¡†
    window.showLivestockUpgradeModal = function() {
      const currentLevel = gameData.livestockData?.level || 1;

      // å·²è¾¾æœ€é«˜ç­‰çº§ï¼Œä¸å…è®¸å‡çº§
      if (currentLevel >= 4) {
        showNotification('å‡çº§æç¤º', 'ç‰²å£æ£šå·²è¾¾æœ€é«˜ç­‰çº§ï¼');
        return;
      }

      // å‡çº§æ‰€éœ€èµ„æº
      const upgradeCosts = {
        1: { wood: 20, grass_feed: 20 },  // 1çº§å‡2çº§
        2: { wood: 50, grass_feed: 50 },   // 2çº§å‡3çº§
        3: { wood: 100, grass_feed: 100 }   // 3çº§å‡4çº§
      };

      const requiredResources = upgradeCosts[currentLevel];

      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'livestock-upgrade-modal';
      modalContainer.id = 'livestockUpgradeModal';

      // åˆ›å»ºå¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'livestock-upgrade-modal-content ink-border';

      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'livestock-upgrade-modal-header';

      const title = document.createElement('h2');
      title.className = 'livestock-upgrade-modal-title ink-text';
      title.textContent = 'ç‰²å£æ£šå‡çº§';
      modalHeader.appendChild(title);

      const closeButton = document.createElement('button');
      closeButton.className = 'livestock-upgrade-modal-close';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = function() {
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      modalHeader.appendChild(closeButton);

      modalContent.appendChild(modalHeader);

      // åˆ›å»ºå†…å®¹åŒºåŸŸ
      const modalBody = document.createElement('div');
      modalBody.className = 'livestock-upgrade-modal-body';

      // å½“å‰ç­‰çº§å’Œä¸‹ä¸€çº§æ˜¾ç¤º
      const levelDisplay = document.createElement('div');
      levelDisplay.className = 'livestock-level-display';
      levelDisplay.innerHTML = `
        <div class="current-level-text">å½“å‰ç­‰çº§ï¼š${currentLevel}çº§</div>
        <div class="next-level-text">å‡çº§åè§£é”ï¼š${currentLevel + 1}çº§ï¼ˆç¬¬${currentLevel + 1}å·æ ï¼‰</div>
        <div class="level-indicator">
          ${[1,2,3,4].map(level => `
            <div class="level-dot ${level <= currentLevel ? 'active' : ''}">${level}</div>
          `).join('')}
        </div>
      `;
      modalBody.appendChild(levelDisplay);

      // å‡çº§æ‰€éœ€èµ„æºæ˜¾ç¤º
      const resourcesDisplay = document.createElement('div');
      resourcesDisplay.className = 'upgrade-resources';

      const woodNeeded = requiredResources.wood;
      const grassNeeded = requiredResources.grass_feed;
      const woodOwned = gameData.resources['wood']?.amount || 0;
      const grassOwned = gameData.resources['grass_feed']?.amount || 0;

      resourcesDisplay.innerHTML = `
        <div class="resource-item ${woodOwned >= woodNeeded ? 'sufficient' : 'insufficient'}">
          <span class="resource-name">æœ¨æ</span>
          <span class="resource-amount">${woodOwned}/${woodNeeded}</span>
        </div>
        <div class="resource-item ${grassOwned >= grassNeeded ? 'sufficient' : 'insufficient'}">
          <span class="resource-name">è‰æ–™</span>
          <span class="resource-amount">${grassOwned}/${grassNeeded}</span>
        </div>
      `;
      modalBody.appendChild(resourcesDisplay);

      // å‡çº§æŒ‰é’®
      const upgradeButton = document.createElement('button');
      upgradeButton.className = 'livestock-upgrade-button ink-button';
      upgradeButton.textContent = `å‡çº§åˆ°${currentLevel + 1}çº§`;

      const canUpgrade = woodOwned >= woodNeeded && grassOwned >= grassNeeded;
      if (!canUpgrade) {
        upgradeButton.disabled = true;
        upgradeButton.classList.add('disabled');
      }

      upgradeButton.onclick = function() {
        if (canUpgrade) {
          // æ¶ˆè€—èµ„æº
          gameData.resources['wood'].amount -= woodNeeded;
          gameData.resources['grass_feed'].amount -= grassNeeded;

          // å‡çº§
          gameData.livestockData.level = currentLevel + 1;

          // æ›´æ–°å‡çº§æŒ‰é’®æ˜¾ç¤º
          const levelText = document.getElementById('livestock-level-text');
          if (levelText) {
            levelText.textContent = `${gameData.livestockData.level}çº§`;
          }

          // é‡æ–°æ¸²æŸ“ç‰²å£æ 
          const stallsContainer = document.querySelector('.livestock-stalls');
          if (stallsContainer) {
            stallsContainer.innerHTML = '';
            for (let i = 0; i < 4; i++) {
              const stall = createLivestockStall(i, gameData.livestockData.stalls[i]);
              stallsContainer.appendChild(stall);
            }
          }

          // å…³é—­æ¨¡æ€æ¡†
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);

          showNotification('å‡çº§æˆåŠŸ', `ç‰²å£æ£šå‡çº§åˆ°${gameData.livestockData.level}çº§ï¼è§£é”äº†ç¬¬${gameData.livestockData.level}å·æ ï¼`);

          updateLivestockUpgradeBtn();
          renderResources();
          updateFeedDisplay();
          updateGameData();
        }
      };
      modalBody.appendChild(upgradeButton);

      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);

      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .livestock-upgrade-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }

        .livestock-upgrade-modal.active {
          opacity: 1;
          visibility: visible;
        }

        .livestock-upgrade-modal-content {
          background-color: #FFFDF7;
          border-radius: 0.25rem;
          width: 90%;
          max-width: 500px;
          padding: 1.5rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          transform: translateY(-20px);
          transition: all 0.3s ease;
        }

        .livestock-upgrade-modal.active .livestock-upgrade-modal-content {
          transform: translateY(0);
        }

        .livestock-upgrade-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
        }

        .livestock-upgrade-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #2D3748;
          margin: 0;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .livestock-upgrade-modal-close {
          background: none;
          border: none;
          font-size: 1.75rem;
          color: #4A5568;
          cursor: pointer;
          transition: color 0.2s;
        }

        .livestock-upgrade-modal-close:hover {
          color: #2D3748;
        }

        .livestock-level-display {
          text-align: center;
          margin-bottom: 1.5rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .current-level-text {
          font-size: 1.1rem;
          color: #2D3748;
          margin-bottom: 0.5rem;
        }

        .next-level-text {
          font-size: 0.9rem;
          color: #4A5568;
          margin-bottom: 1rem;
        }

        .level-indicator {
          display: flex;
          justify-content: center;
          gap: 0.5rem;
        }

        .level-dot {
          width: 30px;
          height: 30px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: #E2E8F0;
          color: #4A5568;
          font-size: 0.9rem;
        }

        .level-dot.active {
          background-color: #8D6E63;
          color: white;
        }

        .upgrade-resources {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
          margin-bottom: 1.5rem;
        }

        .resource-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem;
          background-color: rgba(0, 0, 0, 0.02);
          border-radius: 0.5rem;
        }

        .resource-item.sufficient {
          border: 2px solid #38A169;
        }

        .resource-item.insufficient {
          border: 2px solid #E53E3E;
        }

        .resource-name {
          font-size: 0.9rem;
          color: #4A5568;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .resource-amount {
          font-size: 0.9rem;
          font-weight: bold;
        }

        .resource-item.sufficient .resource-amount {
          color: #38A169;
        }

        .resource-item.insufficient .resource-amount {
          color: #E53E3E;
        }

        .livestock-upgrade-button {
          padding: 0.75rem 1.5rem;
          background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%);
          color: white;
          border: none;
          border-radius: 0.5rem;
          font-size: 1rem;
          font-weight: normal;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 100%;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .livestock-upgrade-button:hover:not(.disabled) {
          background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .livestock-upgrade-button.disabled {
          background-color: #CBD5E0;
          cursor: not-allowed;
          opacity: 0.6;
        }
      `;
      document.head.appendChild(style);

      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        }
      };
    };

    // æ˜¾ç¤ºé©¬å©å‡çº§æ¨¡æ€æ¡†
    window.showStableUpgradeModal = function() {
      const currentLevel = gameData.stableData?.level || 1;

      // å·²è¾¾æœ€é«˜ç­‰çº§ï¼Œä¸å…è®¸å‡çº§
      if (currentLevel >= 4) {
        showNotification('å‡çº§æç¤º', 'é©¬å©å·²è¾¾æœ€é«˜ç­‰çº§ï¼');
        return;
      }

      // å‡çº§æ‰€éœ€èµ„æº
      const upgradeCosts = {
        1: { wood: 20, grass_feed: 20 },  // 1çº§å‡2çº§
        2: { wood: 50, grass_feed: 50 },   // 2çº§å‡3çº§
        3: { wood: 100, grass_feed: 100 }   // 3çº§å‡4çº§
      };

      const requiredResources = upgradeCosts[currentLevel];

      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'stable-upgrade-modal';
      modalContainer.id = 'stableUpgradeModal';

      // åˆ›å»ºå¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'stable-upgrade-modal-content ink-border';

      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'stable-upgrade-modal-header';

      const title = document.createElement('h2');
      title.className = 'stable-upgrade-modal-title ink-text';
      title.textContent = 'é©¬å©å‡çº§';
      modalHeader.appendChild(title);

      const closeButton = document.createElement('button');
      closeButton.className = 'stable-upgrade-modal-close';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = function() {
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      modalHeader.appendChild(closeButton);

      modalContent.appendChild(modalHeader);

      // åˆ›å»ºå†…å®¹åŒºåŸŸ
      const modalBody = document.createElement('div');
      modalBody.className = 'stable-upgrade-modal-body';

      // å½“å‰ç­‰çº§å’Œä¸‹ä¸€çº§æ˜¾ç¤º
      const levelDisplay = document.createElement('div');
      levelDisplay.className = 'stable-level-display';
      levelDisplay.innerHTML = `
        <div class="current-level-text">å½“å‰ç­‰çº§ï¼š${currentLevel}çº§</div>
        <div class="next-level-text">å‡çº§åè§£é”ï¼š${currentLevel + 1}çº§ï¼ˆç¬¬${currentLevel + 1}å·æ ï¼‰</div>
        <div class="level-indicator">
          ${[1,2,3,4].map(level => `
            <div class="level-dot ${level <= currentLevel ? 'active' : ''}">${level}</div>
          `).join('')}
        </div>
      `;
      modalBody.appendChild(levelDisplay);

      // å‡çº§æ‰€éœ€èµ„æºæ˜¾ç¤º
      const resourcesDisplay = document.createElement('div');
      resourcesDisplay.className = 'upgrade-resources';

      const woodNeeded = requiredResources.wood;
      const grassNeeded = requiredResources.grass_feed;
      const woodOwned = gameData.resources['wood']?.amount || 0;
      const grassOwned = gameData.resources['grass_feed']?.amount || 0;

      resourcesDisplay.innerHTML = `
        <div class="resource-item ${woodOwned >= woodNeeded ? 'sufficient' : 'insufficient'}">
          <span class="resource-name">æœ¨æ</span>
          <span class="resource-amount">${woodOwned}/${woodNeeded}</span>
        </div>
        <div class="resource-item ${grassOwned >= grassNeeded ? 'sufficient' : 'insufficient'}">
          <span class="resource-name">è‰æ–™</span>
          <span class="resource-amount">${grassOwned}/${grassNeeded}</span>
        </div>
      `;
      modalBody.appendChild(resourcesDisplay);

      // å‡çº§æŒ‰é’®
      const upgradeButton = document.createElement('button');
      upgradeButton.className = 'stable-upgrade-button ink-button';
      upgradeButton.textContent = `å‡çº§åˆ°${currentLevel + 1}çº§`;

      const canUpgrade = woodOwned >= woodNeeded && grassOwned >= grassNeeded;
      if (!canUpgrade) {
        upgradeButton.disabled = true;
        upgradeButton.classList.add('disabled');
      }

      upgradeButton.onclick = function() {
        if (canUpgrade) {
          // æ¶ˆè€—èµ„æº
          gameData.resources['wood'].amount -= woodNeeded;
          gameData.resources['grass_feed'].amount -= grassNeeded;

          // å‡çº§
          gameData.stableData.level = currentLevel + 1;

          // æ›´æ–°å‡çº§æŒ‰é’®æ˜¾ç¤º
          const levelText = document.getElementById('stable-level-text');
          if (levelText) {
            levelText.textContent = `${gameData.stableData.level}çº§`;
          }

          // é‡æ–°æ¸²æŸ“é©¬å©æ 
          const stallsContainer = document.querySelector('.stable-stalls');
          if (stallsContainer) {
            stallsContainer.innerHTML = '';
            for (let i = 0; i < 4; i++) {
              const stall = createStableStall(i, gameData.stableData.stalls[i]);
              stallsContainer.appendChild(stall);
            }
          }

          // å…³é—­æ¨¡æ€æ¡†
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);

          showNotification('å‡çº§æˆåŠŸ', `é©¬å©å‡çº§åˆ°${gameData.stableData.level}çº§ï¼è§£é”äº†ç¬¬${gameData.stableData.level}å·æ ï¼`);

          updateStableUpgradeBtn();
          renderResources();
          updateStableFeedCards();
          updateGameData();
        }
      };
      modalBody.appendChild(upgradeButton);

      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);

      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .stable-upgrade-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }

        .stable-upgrade-modal.active {
          opacity: 1;
          visibility: visible;
        }

        .stable-upgrade-modal-content {
          background-color: #FFFDF7;
          border-radius: 0.25rem;
          width: 90%;
          max-width: 500px;
          padding: 1.5rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          transform: translateY(-20px);
          transition: all 0.3s ease;
        }

        .stable-upgrade-modal.active .stable-upgrade-modal-content {
          transform: translateY(0);
        }

        .stable-upgrade-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
        }

        .stable-upgrade-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #2D3748;
          margin: 0;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .stable-upgrade-modal-close {
          background: none;
          border: none;
          font-size: 1.75rem;
          color: #4A5568;
          cursor: pointer;
          transition: color 0.2s;
        }

        .stable-upgrade-modal-close:hover {
          color: #2D3748;
        }

        .stable-level-display {
          text-align: center;
          margin-bottom: 1.5rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .current-level-text {
          font-size: 1.1rem;
          color: #2D3748;
          margin-bottom: 0.5rem;
        }

        .next-level-text {
          font-size: 0.9rem;
          color: #4A5568;
          margin-bottom: 1rem;
        }

        .level-indicator {
          display: flex;
          justify-content: center;
          gap: 0.5rem;
        }

        .level-dot {
          width: 30px;
          height: 30px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: #E2E8F0;
          color: #4A5568;
          font-size: 0.9rem;
        }

        .level-dot.active {
          background-color: #8D6E63;
          color: white;
        }

        .upgrade-resources {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
          margin-bottom: 1.5rem;
        }

        .resource-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem;
          background-color: rgba(0, 0, 0, 0.02);
          border-radius: 0.5rem;
        }

        .resource-item.sufficient {
          border: 2px solid #38A169;
        }

        .resource-item.insufficient {
          border: 2px solid #E53E3E;
        }

        .resource-name {
          font-size: 0.9rem;
          color: #4A5568;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .resource-amount {
          font-size: 0.9rem;
          font-weight: bold;
        }

        .resource-item.sufficient .resource-amount {
          color: #38A169;
        }

        .resource-item.insufficient .resource-amount {
          color: #E53E3E;
        }

        .stable-upgrade-button {
          padding: 0.75rem 1.5rem;
          background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%);
          color: white;
          border: none;
          border-radius: 0.5rem;
          font-size: 1rem;
          font-weight: normal;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 100%;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .stable-upgrade-button:hover:not(.disabled) {
          background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .stable-upgrade-button.disabled {
          background-color: #CBD5E0;
          cursor: not-allowed;
          opacity: 0.6;
        }
      `;
      document.head.appendChild(style);

      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        }
      };
    };

    // æ˜¾ç¤ºé©¬å©æ å·¥å…·æç¤º
    window.showStableTooltip = function(stall, stallData, stallIndex) {
      // æ£€æŸ¥é©¬å©çª—å£æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸æ˜¾ç¤ºtooltip
      const stableModal = document.getElementById('stableModal');
      if (!stableModal) return;

      // å¦‚æœå·²å­˜åœ¨å·¥å…·æç¤ºï¼Œå…ˆç§»é™¤æ‰€æœ‰tooltip
      hideStableTooltip();
      hideLivestockTooltip();

      const stableData = gameData.stableData;
      const hasHorse = stallData.horse !== null;

      // åˆ›å»ºå·¥å…·æç¤ºå…ƒç´ 
      const tooltip = document.createElement('div');
      tooltip.id = 'stable-tooltip';
      tooltip.className = 'stable-tooltip-element';

      // é©¬å©æ ç¼–å·
      const header = document.createElement('div');
      header.className = 'tooltip-header';
      header.textContent = `é©¬å©æ  ${stallIndex + 1}`;
      tooltip.appendChild(header);

      // æ ¹æ®æ˜¯å¦æœ‰é©¬æ˜¾ç¤ºä¸åŒä¿¡æ¯
      if (hasHorse) {
        const horseData = stableData.horses[stallData.horse];

        // é©¬åŒ¹ç§ç±»
        const horseType = document.createElement('div');
        horseType.className = 'tooltip-status';
        horseType.innerHTML = `<div class="tooltip-label">é©¬åŒ¹ç§ç±»ï¼š</div><div class="tooltip-value">${horseData.name}</div>`;
        tooltip.appendChild(horseType);

        // åˆ†éš”çº¿
        const divider = document.createElement('div');
        divider.className = 'tooltip-divider';
        tooltip.appendChild(divider);

        // å¥åº·å€¼
        const healthStatus = document.createElement('div');
        healthStatus.className = 'tooltip-resources';
        const healthPercent = Math.round((stallData.health / horseData.maxHealth) * 100);
        healthStatus.innerHTML = `
          <div class="tooltip-label">å¥åº·å€¼ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${healthPercent}%; background-color: ${healthPercent <= 30 ? '#E53E3E' : '#38A169'};"></div>
          </div>
          <div class="tooltip-value">${Math.round(stallData.health)}/${horseData.maxHealth}</div>
        `;
        tooltip.appendChild(healthStatus);

        // é¥±é£Ÿåº¦
        const satietyStatus = document.createElement('div');
        satietyStatus.className = 'tooltip-resources';
        satietyStatus.innerHTML = `
          <div class="tooltip-label">é¥±é£Ÿåº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${stallData.satiety}%; background-color: ${stallData.satiety <= 20 ? '#E53E3E' : '#ED8936'};"></div>
          </div>
          <div class="tooltip-value">${Math.round(stallData.satiety)}%</div>
        `;
        tooltip.appendChild(satietyStatus);

        // å£æ¸´åº¦
        const thirstStatus = document.createElement('div');
        thirstStatus.className = 'tooltip-resources';
        thirstStatus.innerHTML = `
          <div class="tooltip-label">å£æ¸´åº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${stallData.thirst}%; background-color: ${stallData.thirst <= 20 ? '#E53E3E' : '#3182CE'};"></div>
          </div>
          <div class="tooltip-value">${Math.round(stallData.thirst)}%</div>
        `;
        tooltip.appendChild(thirstStatus);

        // æ±¡æµŠåº¦
        const cleanlinessStatus = document.createElement('div');
        cleanlinessStatus.className = 'tooltip-resources';
        cleanlinessStatus.innerHTML = `
          <div class="tooltip-label">æ±¡æµŠåº¦ï¼š</div>
          <div class="tooltip-progress">
            <div class="tooltip-progress-bar" style="width: ${stallData.cleanliness}%; background-color: #3182CE;"></div>
          </div>
          <div class="tooltip-value">${stallData.cleanliness}%</div>
        `;
        tooltip.appendChild(cleanlinessStatus);
      }

      // æè¿°ä¿¡æ¯
      const description = document.createElement('div');
      description.className = 'tooltip-description';
      if (hasHorse) {
        description.textContent = 'æ‹–æ‹½é¥²æ–™æˆ–è¯ä¸¸å–‚å…»ï¼Œç‚¹å‡»æ¸…ç†è·å¾—è‚¥æ–™';
        description.style.color = '#E2E8F0';
      } else {
        // ç©ºæ  - æ˜¾ç¤ºç©ºæ ä¿¡æ¯
        const emptyStatus = document.createElement('div');
        emptyStatus.className = 'tooltip-status';
        emptyStatus.innerHTML = `
          <div class="tooltip-label">çŠ¶æ€ï¼š</div>
          <div class="tooltip-value" style="color: #CBD5E0;">ç©ºé—²</div>
        `;
        tooltip.appendChild(emptyStatus);

        description.textContent = 'æ‹–æ‹½é©¬åŒ¹åˆ°æ­¤æ è¿›è¡Œå…»æ®–';
      }
      tooltip.appendChild(description);

      // è®¾ç½®æ ·å¼å¹¶æ·»åŠ åˆ°é¡µé¢
      tooltip.style.position = 'fixed';
      tooltip.style.zIndex = '1001';
      tooltip.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
      tooltip.style.color = 'white';
      tooltip.style.padding = '12px';
      tooltip.style.borderRadius = '8px';
      tooltip.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
      tooltip.style.width = '220px';
      tooltip.style.fontSize = '14px';
      tooltip.style.lineHeight = '1.5';
      tooltip.style.pointerEvents = 'none';

      // è®¡ç®—ä½ç½® - ä½¿ç”¨é¼ æ ‡ä½ç½®
      const rect = stall.getBoundingClientRect();
      const tooltipX = rect.left;
      const tooltipY = rect.bottom;

      // ç¡®ä¿æç¤ºæ¡†ä¸è¶…å‡ºçª—å£è¾¹ç•Œï¼ˆä¸å†œç”°æ ¼å­ä¸€è‡´ï¼Œå®½åº¦220pxï¼‰
      let left = tooltipX + 15;
      let top = tooltipY + 15;

      // æ£€æŸ¥å³ä¾§è¾¹ç•Œï¼ˆå®½åº¦220pxï¼‰
      if (left + 220 > window.innerWidth) {
        left = tooltipX - 220 - 15;
      }

      // æ£€æŸ¥åº•éƒ¨è¾¹ç•Œ
      if (top + 150 > window.innerHeight) {
        top = tooltipY - 150 - 15;
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';

      document.body.appendChild(tooltip);

      // æ·»åŠ æ·¡å…¥æ•ˆæœ
      tooltip.style.opacity = '0';
      tooltip.style.transition = 'opacity 0.3s ease';

      // è§¦å‘é‡æ’ä»¥åº”ç”¨è¿‡æ¸¡æ•ˆæœ
      tooltip.offsetHeight;

      tooltip.style.opacity = '1';
    };

    // éšè—é©¬å©æ å·¥å…·æç¤º
    window.hideStableTooltip = function() {
      // ç§»é™¤æ‰€æœ‰é©¬å©æ ç›¸å…³çš„tooltipå…ƒç´ ï¼ˆç¡®ä¿æ¸…ç†å¹²å‡€ï¼‰
      const tooltips = document.querySelectorAll('#stable-tooltip, .stable-tooltip-element');
      tooltips.forEach(tooltip => {
        if (tooltip.parentNode) {
          tooltip.remove();
        }
      });
      // æ›´æ–°å¯è§æ€§æ ‡å¿—
      window.stableTooltipVisible = false;
    };

    // è·å–ç‰¹æ®ŠçŠ¶æ€æ–‡æœ¬
    function getSpecialStateText(state) {
      const stateTexts = {
        'high_production': 'é«˜äº§è›‹',
        'fast_growth': 'å¿«é€Ÿç”Ÿé•¿'
      };
      return stateTexts[state] || state;
    }

    // åˆ›å»ºç‰²å£å…‰æ ‡å‡½æ•°ï¼ˆç”¨äºåŠ¨ç‰©ã€é¥²æ–™å’Œæ‰«å¸šçš„è¿ç»­æ”¾ç½®ï¼‰- ä¸ç§å­å…‰æ ‡ä½¿ç”¨ç›¸åŒæ ·å¼
    function createLivestockCursor(itemId, itemType) {
      console.log('createLivestockCursor è¢«è°ƒç”¨ï¼ŒitemId:', itemId, 'itemType:', itemType);

      let item, itemAmount, itemImage, itemName;

      // æ ¹æ®ç‰©å“ç±»å‹è·å–ç‰©å“ä¿¡æ¯
      if (itemType === 'animal') {
        const livestockData = gameData.livestockData;
        const animalData = livestockData.animals[itemId];
        item = gameData.resources[itemId];
        itemAmount = item?.amount || 0;
        // ä½¿ç”¨å¹¼å´½å›¾ç‰‡ï¼ˆä¸å¡ç‰Œæ˜¾ç¤ºä¸€è‡´ï¼‰ï¼Œè€Œä¸æ˜¯å¹¼å¹´æœŸå›¾ç‰‡
        const babyAnimalImages = {
          'chick': 'UI/é¸¡å´½.jpg',
          'duckling': 'UI/é¸­å´½.jpg',
          'piglet': 'UI/çŒªå´½.jpg'
        };
        itemImage = babyAnimalImages[itemId] || animalData.babyImage;
        itemName = animalData.babyName;
      } else if (itemType === 'feed' || itemType === 'broom') {
        item = gameData.resources[itemId];
        itemAmount = item?.amount || 0;
        itemImage = item.image;
        itemName = item.name;

        // å¯¹äºæœ¨æ¡¶å’Œæ°´è¢‹ï¼Œæ ¹æ®æ°´ä½åŠ¨æ€è®¾ç½®å›¾ç‰‡
        if (itemId === 'bucket') {
          let waterLevel = 0;
          if (item.instances && item.instances.length > 0) {
            waterLevel = item.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (item.waterLevel !== undefined) {
            waterLevel = item.waterLevel;
          }
          // æœ¨æ¡¶ï¼ˆ5æ ¼ï¼Œæ¯æ ¼50å•ä½ï¼‰ï¼šæ°´ä½ = 0æ˜¾ç¤ºç©ºæœ¨æ¡¶ï¼Œæ°´ä½ > 0ï¼ˆ1-5æ ¼ï¼‰æ˜¾ç¤ºæ»¡æ°´æœ¨æ¡¶
          if (waterLevel > 0) {
            itemImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            itemImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
          }
        } else if (itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
          let waterLevel = 0;
          if (item.instances && item.instances.length > 0) {
            waterLevel = item.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (item.waterLevel !== undefined) {
            waterLevel = item.waterLevel;
          }
          if (waterLevel >= 80) {
            itemImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
          } else if (waterLevel > 0) {
            itemImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            itemImage = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
          }
        }

        // æ£€æŸ¥æ‰«å¸šè€ä¹…åº¦
        if (itemType === 'broom' && item.durability !== undefined && item.durability <= 0) {
          showNotification('æ‰«å¸šå·²æŸå', 'æ‰«å¸šè€ä¹…åº¦å·²è€—å°½ï¼');
          return;
        }

        // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ°´è€Œä¸æ˜¯æ£€æŸ¥æ•°é‡
        if (itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
          const totalWater = getContainerTotalWater(itemId);
          if (totalWater <= 0) {
            showNotification('æ²¡æœ‰æ°´', `${itemName}é‡Œæ²¡æœ‰æ°´ï¼Œè¯·å…ˆè£…æ°´ï¼`);
            return;
          }
        }
      }

      // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ä»¥å¤–çš„ç‰©å“ï¼Œæ£€æŸ¥æ•°é‡
      if ((itemId !== 'bucket' && itemId !== 'water_bag' && itemId !== 'water_bag_full' && itemId !== 'empty_water_bag') && itemAmount <= 0) {
        showNotification('æ•°é‡ä¸è¶³', `ä½ æ²¡æœ‰${itemName}ï¼`);
        return;
      }

      // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å…‰æ ‡
      const existingCursor = document.getElementById('livestock-drag-cursor');
      if (existingCursor) {
        console.log('æ¸…é™¤æ—§å…‰æ ‡');
        existingCursor.parentNode.removeChild(existingCursor);
      }

      // åˆ›å»ºè‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆï¼ˆä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„æ ·å¼ï¼‰
      const customCursor = document.createElement('div');
      customCursor.id = 'livestock-drag-cursor';
      customCursor.className = 'livestock-drag-cursor';
      customCursor.style.cssText = `
        position: fixed;
        pointer-events: none;
        z-index: 9999;
        width: 40px;
        height: 40px;
        background-image: url('${itemImage}');
        background-size: cover;
        border-radius: 50%;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3);
        opacity: 0.9;
        transform: translate(-50%, -50%);
        transition: transform 0.1s ease;
        display: block !important;
      `;

      // æ·»åŠ æ‰‹å½¢å›¾æ ‡æ•ˆæœ
      const handIcon = document.createElement('div');
      handIcon.style.cssText = `
        position: absolute;
        top: -10px;
        right: -10px;
        width: 20px;
        height: 20px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238D6E63"><path d="M12.5 5.5C11.67 5.5 11 6.17 11 7V11C11 11.55 10.55 12 10 12S9 11.55 9 11V7C9 6.17 8.33 5.5 7.5 5.5S6 6.17 6 7V12C6 13.1 6.9 14 8 14H9.5C10.33 14 11 13.33 11 12.5V12C11 13.1 10.1 14 9 14H8C6.9 14 6 13.1 6 12V7C6 6.17 5.33 5.5 4.5 5.5S3 6.17 3 7V12C3 14.21 4.79 16 7 16H11.5C13.43 16 15 14.43 15 12.5V7C15 6.17 14.33 5.5 13.5 5.5S12 6.17 12 7V11.5C12 11.78 12.22 12 12.5 12Z"/></svg>');
        background-size: contain;
        background-repeat: no-repeat;
      `;
      customCursor.appendChild(handIcon);

      // æ·»åŠ æ•°é‡æŒ‡ç¤ºå™¨åˆ°å·¦ä¸‹è§’
      const countIndicator = document.createElement('div');
      countIndicator.id = 'livestock-count-indicator';
      countIndicator.className = 'seed-count-indicator';
      countIndicator.style.cssText = `
        position: absolute;
        bottom: -5px;
        left: -5px;
        background-color: #E53E3E;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      `;
      // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
      let displayCount = itemAmount;
      if ((itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag')) {
        if (itemId === 'bucket') {
          // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('bucket');
          displayCount = Math.floor(totalWater / 50);
          console.log('é©¬å©æ æœ¨æ¡¶ï¼štotalWater =', totalWater, ', displayCount =', displayCount);
        } else {
          // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('water_bag');
          displayCount = Math.floor(totalWater / 20);
          console.log('é©¬å©æ æ°´è¢‹ï¼šitemId =', itemId, ', totalWater =', totalWater, ', displayCount =', displayCount);
        }
      }
      countIndicator.textContent = displayCount;
      customCursor.appendChild(countIndicator);

      document.body.appendChild(customCursor);

      // éšè—é»˜è®¤å…‰æ ‡ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰å…‰æ ‡
      document.body.style.cursor = 'none';

      // åˆå§‹åŒ–å…‰æ ‡ä½ç½®
      customCursor.style.left = window.lastMouseX + 'px';
      customCursor.style.top = window.lastMouseY + 'px';

      // å­˜å‚¨çŠ¶æ€
      let lastPosition = { x: window.lastMouseX || 0, y: window.lastMouseY || 0 };
      let lastTime = Date.now();
      const trailInterval = 100;
      let lastTrailTime = lastTime;
      let lastAppliedStallId = null; // è®°å½•ä¸Šä¸€æ¬¡æ“ä½œçš„æ ä½IDï¼Œé˜²æ­¢é‡å¤æ“ä½œ

      // åˆ›å»ºæ‹–å½±æ•ˆæœ
      function createDragTrail(x, y, image) {
        const trail = document.createElement('div');
        trail.className = 'drag-trail';
        trail.style.left = (x - 20) + 'px';
        trail.style.top = (y - 20) + 'px';
        trail.style.width = '40px';
        trail.style.height = '40px';
        trail.style.backgroundImage = `url('${image}')`;
        document.body.appendChild(trail);

        setTimeout(() => {
          if (trail.parentNode) {
            trail.parentNode.removeChild(trail);
          }
        }, 500);
      }

      // åˆ›å»ºå…‰ç‚¹ç²’å­ï¼ˆä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„é‡‘è‰²ç²’å­æ•ˆæœï¼‰
      function createParticle(x, y, speed) {
        const particle = document.createElement('div');
        particle.className = 'particle drag-particle';
        const size = 5 + Math.random() * 8;
        const angle = Math.random() * Math.PI * 2;
        const distance = 20 + Math.random() * 40 + speed * 5;

        particle.style.left = (x - size/2) + 'px';
        particle.style.top = (y - size/2) + 'px';
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');

        // ä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„é‡‘è‰²ç³»ç²’å­é¢œè‰²
        const colors = [
          'rgba(255, 215, 0, 0.8)',
          'rgba(255, 165, 0, 0.8)',
          'rgba(255, 140, 0, 0.8)',
          'rgba(139, 69, 19, 0.6)'
        ];
        const color = colors[Math.floor(Math.random() * colors.length)];
        particle.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;

        document.body.appendChild(particle);

        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, 1000);
      }

      // æ›´æ–°å…‰æ ‡ä½ç½®
      const updateCursorPosition = (e) => {
        if (!document.getElementById('livestock-drag-cursor')) {
          document.body.appendChild(customCursor);
        }

        const currentTime = Date.now();
        const deltaTime = currentTime - lastTime;
        const deltaX = e.clientX - lastPosition.x;
        const deltaY = e.clientY - lastPosition.y;
        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        const speed = distance / (deltaTime || 1);

        // æ£€æŸ¥æ˜¯å¦é è¿‘ç‰²å£æ æˆ–é©¬å©æ ä¸­å¿ƒ
        const hoveredElement = document.elementFromPoint(e.clientX, e.clientY);
        const livestockStall = hoveredElement?.closest('.livestock-stall');
        const stableStall = hoveredElement?.closest('.stable-stall');
        let isSnap = false;
        let stallElement = livestockStall || stableStall;
        let stallData = null;
        let stallIndex = null;

        // ç¡®å®šç›®æ ‡æ ä½å’Œç±»å‹
        if (livestockStall) {
          stallIndex = parseInt(livestockStall.dataset.stallIndex);
          stallData = gameData.livestockData.stalls[stallIndex];
        } else if (stableStall) {
          stallIndex = parseInt(stableStall.dataset.stallIndex);
          stallData = gameData.stableData.stalls[stallIndex];
        }

        // æ£€æŸ¥æ ä½æ˜¯å¦å·²è§£é”
        const isLocked = stallElement && stallElement.classList.contains('locked');

        if (stallElement && !isLocked) {
          const rect = stallElement.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          const snapDistance = Math.sqrt(
            Math.pow(e.clientX - centerX, 2) +
            Math.pow(e.clientY - centerY, 2)
          );

          if (snapDistance < 50) {
            customCursor.style.left = centerX + 'px';
            customCursor.style.top = centerY + 'px';
            isSnap = true;

            let snapIndicator = document.getElementById('snap-indicator');
            if (!snapIndicator) {
              snapIndicator = document.createElement('div');
              snapIndicator.id = 'snap-indicator';
              snapIndicator.className = 'snap-indicator';
              document.body.appendChild(snapIndicator);
            }
            snapIndicator.style.left = rect.left + 'px';
            snapIndicator.style.top = rect.top + 'px';
            snapIndicator.style.width = rect.width + 'px';
            snapIndicator.style.height = rect.height + 'px';
            snapIndicator.style.display = 'block';

            // è‡ªåŠ¨æ“ä½œé€»è¾‘ï¼šå½“å…‰æ ‡å¸é™„åˆ°æ ä½ä¸­å¿ƒæ—¶è‡ªåŠ¨æ‰§è¡Œæ“ä½œ
            if (stallIndex !== undefined && stallIndex !== lastAppliedStallId) {
              console.log(`è‡ªåŠ¨è§¦å‘æ“ä½œï¼Œç±»å‹: ${itemType}, æ ä½ID: ${stallIndex}`);

              let success = false;

              // æ ¹æ®ç‰©å“ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
              if (itemType === 'animal') {
                // æ”¾ç½®åŠ¨ç‰©
                if (!stallData.animal) {
                  placeAnimalInStall(stallIndex, itemId);
                  success = true;
                }
              } else if (itemType === 'feed') {
                // å–‚å…»åŠ¨ç‰©
                if (stallData.animal) {
                  if (itemId === 'pill') {
                    feedAnimalWithPill(stallIndex);
                    success = true;
                  } else if (itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
                    // æ°´è¢‹å–‚æ°´ - ä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°ï¼ˆæ”¯æŒæ‰€æœ‰æ°´è¢‹å˜ä½“ï¼‰
                    // æ°´è¢‹ï¼šæ¯æ ¼20å•ä½æ°´ï¼Œæ¯æ¬¡ä½¿ç”¨1æ ¼ï¼ˆ20å•ä½ï¼‰
                    const totalWater = getContainerTotalWater('water_bag');
                    if (totalWater > 0) {
                      const stall = gameData.livestockData.stalls[stallIndex];
                      if (stall.thirst < 100) {
                        const result = useWaterFromContainer('water_bag', 20);
                        if (result.success) {
                          stall.thirst = Math.min(100, stall.thirst + 20); // å¢åŠ 20ç‚¹å£æ¸´åº¦ï¼Œå¯¹åº”1æ ¼æ°´
                          stall.lastFedDay = gameData.day || 1;
                          success = true;
                          // æ›´æ–°æ°´è¢‹å¡ç‰Œæ˜¾ç¤º
                          updateResourceCard('water_bag');
                          const remainingWater = getContainerTotalWater('water_bag');
                          const remainingGrids = Math.floor(remainingWater / 20);
                          let message = `ä½ ç”¨æ°´è¢‹ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 20ç‚¹ï¼å‰©ä½™: ${remainingGrids}æ ¼ï¼ˆ${remainingWater}/100ï¼‰`;
                          if (result.containerDestroyed) {
                            message += ' ' + result.message;
                          }
                          showNotification('å–‚æ°´æˆåŠŸ', message);
                          
            // é‡æ–°è·å–stallElementï¼Œç¡®ä¿æŒ‡å‘æ­£ç¡®çš„DOMå…ƒç´ 
            const waterStallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
            
            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
            if (waterStallElement) {
              waterStallElement.classList.add('water-animation');

              // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
              if (!window.createWaterEffect || !window.createWaterFloatingText) {
                console.log('ç‰²å£æ£šæ°´è¢‹ï¼šæ°´ç‰¹æ•ˆå‡½æ•°æœªå®šä¹‰ï¼Œç«‹å³åˆå§‹åŒ–...');
                if (typeof initializeAnimationCSS === 'function') {
                  initializeAnimationCSS();
                }
                if (typeof initializeAnimationEffects === 'function') {
                  initializeAnimationEffects();
                }
              }

              // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
              if (window.createWaterEffect) {
                window.createWaterEffect(waterStallElement);
                console.log('ç‰²å£æ£šæ°´è¢‹ï¼šæ°´æ³¢çº¹ç‰¹æ•ˆå·²è§¦å‘');
              } else {
                console.warn('ç‰²å£æ£šæ°´è¢‹ï¼šcreateWaterEffectå‡½æ•°æœªå®šä¹‰ï¼');
              }
              if (window.createWaterFloatingText) {
                window.createWaterFloatingText(waterStallElement);
                console.log('ç‰²å£æ£šæ°´è¢‹ï¼šæµ‡æ°´æ¼‚æµ®æ–‡å­—å·²è§¦å‘');
              } else {
                console.warn('ç‰²å£æ£šæ°´è¢‹ï¼šcreateWaterFloatingTextå‡½æ•°æœªå®šä¹‰ï¼');
              }

              // 1500msåç§»é™¤åŠ¨ç”»ç±»
              setTimeout(() => {
                waterStallElement.classList.remove('water-animation');
              }, 1500);
            } else {
              console.warn('ç‰²å£æ£šæ°´è¢‹ï¼šæ— æ³•æ‰¾åˆ°æ ä½DOMå…ƒç´ ï¼ŒstallIndex:', stallIndex);
            }
                        } else {
                          showNotification('å–‚æ°´å¤±è´¥', result.message);
                        }
                      } else {
                        showNotification('å£æ¸´åº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨ä¸å£æ¸´ï¼Œä¸éœ€è¦å–‚æ°´ï¼');
                      }
                    } else {
                      showNotification('æ°´èµ„æºä¸è¶³', 'æ‰€æœ‰æ°´è¢‹é‡Œéƒ½æ²¡æœ‰æ°´ï¼');
                    }
                  } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é€šç”¨é¥²æ–™
                    const stall = gameData.livestockData.stalls[stallIndex];
                    if (itemId === 'animal_feed') {
                      // é€šç”¨é¥²æ–™ï¼šåªæœ‰å½“é¥±é£Ÿåº¦ä¸æ»¡æ—¶æ‰èƒ½å–‚é£Ÿ
                      if (stall.satiety < 100) {
                        feedAnimalWithFood(stallIndex);
                        success = true;
                      } else {
                        showNotification('é¥±é£Ÿåº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨å¾ˆé¥±ï¼Œä¸éœ€è¦å–‚é£Ÿï¼');
                      }
                    } else if (itemId === 'bucket') {
                      // æœ¨æ¡¶å–‚æ°´ - ä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°
                      // æœ¨æ¡¶ï¼šæ¯æ ¼50å•ä½æ°´ï¼Œæ¯æ¬¡ä½¿ç”¨1æ ¼ï¼ˆ50å•ä½ï¼‰
                      const totalWater = getContainerTotalWater('bucket');
                      if (totalWater > 0) {
                        if (stall.thirst < 100) {
                          const result = useWaterFromContainer('bucket', 50);
                          if (result.success) {
                            stall.thirst = Math.min(100, stall.thirst + 50); // å¢åŠ 50ç‚¹å£æ¸´åº¦ï¼Œå¯¹åº”1æ ¼æ°´
                            stall.lastFedDay = gameData.day || 1;
                            success = true;
                            // æ›´æ–°æœ¨æ¡¶å¡ç‰Œæ˜¾ç¤º
                            updateResourceCard('bucket');
                            const remainingWater = getContainerTotalWater('bucket');
                            const remainingGrids = Math.floor(remainingWater / 50);
                            let message = `ä½ ç”¨æœ¨æ¡¶ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 50ç‚¹ï¼å‰©ä½™: ${remainingGrids}æ ¼ï¼ˆ${remainingWater}/250ï¼‰`;
                            if (result.containerDestroyed) {
                              message += ' ' + result.message;
                            }
                            showNotification('å–‚æ°´æˆåŠŸ', message);
                            
                            // é‡æ–°è·å–stallElementï¼Œç¡®ä¿æŒ‡å‘æ­£ç¡®çš„DOMå…ƒç´ 
                            const bucketStallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
                            
                            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
                            if (bucketStallElement) {
                              bucketStallElement.classList.add('water-animation');

                              // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
                              if (!window.createWaterEffect || !window.createWaterFloatingText) {
                                if (typeof initializeAnimationCSS === 'function') {
                                  initializeAnimationCSS();
                                }
                                if (typeof initializeAnimationEffects === 'function') {
                                  initializeAnimationEffects();
                                }
                              }

                              // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
                              if (window.createWaterEffect) {
                                window.createWaterEffect(bucketStallElement);
                                console.log('ç‰²å£æ£šæœ¨æ¡¶ï¼šæ°´æ³¢çº¹ç‰¹æ•ˆå·²è§¦å‘');
                              } else {
                                console.warn('ç‰²å£æ£šæœ¨æ¡¶ï¼šcreateWaterEffectå‡½æ•°æœªå®šä¹‰ï¼');
                              }
                              if (window.createWaterFloatingText) {
                                window.createWaterFloatingText(bucketStallElement);
                                console.log('ç‰²å£æ£šæœ¨æ¡¶ï¼šæµ‡æ°´æ¼‚æµ®æ–‡å­—å·²è§¦å‘');
                              } else {
                                console.warn('ç‰²å£æ£šæœ¨æ¡¶ï¼šcreateWaterFloatingTextå‡½æ•°æœªå®šä¹‰ï¼');
                              }
                              
                              // 1500msåç§»é™¤åŠ¨ç”»ç±»
                              setTimeout(() => {
                                bucketStallElement.classList.remove('water-animation');
                              }, 1500);
                            } else {
                              console.warn('ç‰²å£æ£šæœ¨æ¡¶ï¼šæ— æ³•æ‰¾åˆ°æ ä½DOMå…ƒç´ ï¼ŒstallIndex:', stallIndex);
                            }
                          } else {
                            showNotification('å–‚æ°´å¤±è´¥', result.message);
                          }
                        } else {
                          showNotification('å£æ¸´åº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨ä¸å£æ¸´ï¼Œä¸éœ€è¦å–‚æ°´ï¼');
                        }
                      } else {
                        showNotification('æ°´èµ„æºä¸è¶³', 'æ‰€æœ‰æœ¨æ¡¶é‡Œéƒ½æ²¡æœ‰æ°´ï¼');
                      }
                    }
                  }
                }
              } else if (itemType === 'broom') {
                // æ¸…æ´æ ä½
                if (stallData.animal && stallData.cleanliness > 50) {
                  cleanStallWithBroom(stallIndex);
                  success = true;
                }
              }

              if (success) {
                // è§¦å‘åä¸½çš„æ”¾ç½®åŠ¨ç”»ç‰¹æ•ˆï¼ˆä»…ç”¨äºæ”¾ç½®åŠ¨ç‰©ï¼‰
                if (itemType === 'animal' && window.triggerPlaceAnimation && typeof window.triggerPlaceAnimation === 'function') {
                  console.log('æ­£åœ¨è°ƒç”¨ triggerPlaceAnimation...');
                  window.triggerPlaceAnimation(stallElement, itemType);
                  console.log('triggerPlaceAnimation è°ƒç”¨å®Œæˆ');
                }

                // æ›´æ–°æ•°é‡æŒ‡ç¤ºå™¨
                let newDisplayCount = gameData.resources[itemId]?.amount || 0;
                // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
                if (itemId === 'bucket') {
                  // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
                  const totalWater = getContainerTotalWater('bucket');
                  newDisplayCount = Math.floor(totalWater / 50);
                } else if (itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
                  // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
                  const totalWater = getContainerTotalWater('water_bag');
                  newDisplayCount = Math.floor(totalWater / 20);
                }
                countIndicator.textContent = newDisplayCount;

                // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œå½“æ°´ä½æ ¼å­æ•°ä¸º0æ—¶ç«‹å³æ¸…é™¤å…‰æ ‡ï¼›å…¶ä»–ç‰©å“å½“å¡ç‰Œæ•°é‡ä¸º0æ—¶æ¸…é™¤
                let shouldClearCursor = false;
                if (itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
                  // æ°´è¢‹å’Œæ°´æ¡¶ï¼šæ£€æŸ¥æ°´ä½æ ¼å­æ•°æ˜¯å¦ä¸º0
                  if (newDisplayCount <= 0) {
                    shouldClearCursor = true;
                    console.log('ç‰²å£æ£šï¼šæ°´è¢‹æˆ–æ°´æ¡¶æ°´ä½æ ¼å­æ•°ä¸º0ï¼Œæ¸…é™¤å…‰æ ‡');
                  }
                } else {
                  // å…¶ä»–ç‰©å“ï¼šæ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0
                  if (gameData.resources[itemId]?.amount <= 0) {
                    shouldClearCursor = true;
                  }
                }

                if (shouldClearCursor) {
                  // æ¸…é™¤å…‰æ ‡
                  if (window.clearAllCustomCursors) {
                    window.clearAllCustomCursors();
                  }
                  return;
                }

                // æ›´æ–°ç‰²å£æ£šæˆ–é©¬å©çª—å£ä¸­çš„å·¦ä¾§å¡ç‰Œæ˜¾ç¤º
                if (window.updateLivestockInventory) {
                  window.updateLivestockInventory();
                }
                // æ›´æ–°ç‰²å£æ£šé¥²æ–™å¡ç‰Œæ˜¾ç¤º
                if (typeof updateFeedDisplay === 'function') {
                  updateFeedDisplay();
                }
                if (window.updateStableInventory) {
                  window.updateStableInventory();
                }

                // æ›´æ–°èƒŒåŒ…æ æ˜¾ç¤º
                renderResources();

                // è®°å½•å·²æ“ä½œçš„æ ä½ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
                lastAppliedStallId = stallIndex;
              }
            }
          } else {
            const hideSnapIndicator = document.getElementById('snap-indicator');
            if (hideSnapIndicator) {
              hideSnapIndicator.style.display = 'none';
            }
          }
        } else {
          const snapIndicator2 = document.getElementById('snap-indicator');
          if (snapIndicator2) {
            snapIndicator2.style.display = 'none';
          }
        }

        if (!isSnap) {
          customCursor.style.left = e.clientX + 'px';
          customCursor.style.top = e.clientY + 'px';
        }

        // æ‘‡æ‘†æ•ˆæœ
        const swing = Math.sin(Date.now() / 150) * 5;

        const canPerformAction = stallElement && !isLocked;

        if (canPerformAction) {
          customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(1.1)`;
          customCursor.style.boxShadow = '0 0 25px rgba(76, 175, 80, 0.8), 0 4px 8px rgba(0,0,0,0.3)';
        } else {
          const scale = 1 + Math.sin(Date.now() / 200) * 0.05;
          customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(${scale})`;
          customCursor.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3)';
        }

        // åˆ›å»ºæ‹–å½±
        if (currentTime - lastTrailTime > Math.max(50, 150 - speed * 10)) {
          createDragTrail(lastPosition.x, lastPosition.y, itemImage);
          lastTrailTime = currentTime;
        }

        // åˆ›å»ºç²’å­
        if (Math.random() < 0.3) {
          createParticle(e.clientX, e.clientY, speed);
        }

        lastPosition = { x: e.clientX, y: e.clientY };
        lastTime = currentTime;
        window.lastMouseX = e.clientX;
        window.lastMouseY = e.clientY;

        // æ›´æ–°æ•°é‡
        let currentDisplayCount = gameData.resources[itemId]?.amount || 0;
        // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
        if (itemId === 'bucket') {
          // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('bucket');
          currentDisplayCount = Math.floor(totalWater / 50);
        } else if (itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
          // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('water_bag');
          currentDisplayCount = Math.floor(totalWater / 20);
        }
        countIndicator.textContent = currentDisplayCount;

        // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œå½“æ°´ä½æ ¼å­æ•°ä¸º0æ—¶ç«‹å³æ¸…é™¤å…‰æ ‡ï¼›å…¶ä»–ç‰©å“å½“å¡ç‰Œæ•°é‡ä¸º0æ—¶æ¸…é™¤
        let shouldClearCursor = false;
        if (itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
          // æ°´è¢‹å’Œæ°´æ¡¶ï¼šæ£€æŸ¥æ°´ä½æ ¼å­æ•°æ˜¯å¦ä¸º0
          if (currentDisplayCount <= 0) {
            shouldClearCursor = true;
            console.log('é©¬å©æ ï¼šæ°´è¢‹æˆ–æ°´æ¡¶æ°´ä½æ ¼å­æ•°ä¸º0ï¼Œæ¸…é™¤å…‰æ ‡');
          }
        } else {
          // å…¶ä»–ç‰©å“ï¼šæ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0
          if (gameData.resources[itemId]?.amount <= 0) {
            shouldClearCursor = true;
          }
        }

        if (shouldClearCursor) {
          // æ¸…é™¤å…‰æ ‡
          if (window.clearAllCustomCursors) {
            window.clearAllCustomCursors();
          }
          return;
        }
      };

      // ç«‹å³æ›´æ–°ä¸€æ¬¡
      updateCursorPosition({ clientX: window.lastMouseX || 0, clientY: window.lastMouseY || 0 });

      // æ·»åŠ é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨
      window.livestockCursorMouseMoveHandler = updateCursorPosition;
      document.addEventListener('mousemove', window.livestockCursorMouseMoveHandler);
    }

    // æ¸…é™¤ç‰²å£å…‰æ ‡å‡½æ•°
    function clearLivestockCursor() {
      // ä½¿ç”¨å…¨å±€æ¸…é™¤å‡½æ•°
      if (window.clearAllCustomCursors) {
        window.clearAllCustomCursors();
      }

      // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
      if (window.livestockCursorMouseMoveHandler) {
        document.removeEventListener('mousemove', window.livestockCursorMouseMoveHandler);
        window.livestockCursorMouseMoveHandler = null;
      }
    }

    // æ”¾ç½®åŠ¨ç‰©åˆ°ç‰²å£æ 
    function placeAnimalInStall(stallIndex, animalId) {
      const livestockData = gameData.livestockData;
      const resource = gameData.resources[animalId];

      // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„åŠ¨ç‰©
      if (resource.amount < 1) {
        showNotification('åŠ¨ç‰©ä¸è¶³', `ä½ æ²¡æœ‰è¶³å¤Ÿçš„${resource.name}ï¼`);
        return;
      }

      // æ¶ˆè€—ä¸€ä¸ªå¹¼å¹´åŠ¨ç‰©
      resource.amount -= 1;

      // è®¾ç½®ç‰²å£æ æ•°æ®
      const stall = livestockData.stalls[stallIndex];
      stall.animal = animalId;
      stall.growthStage = 1; // å¹¼å¹´æœŸ
      stall.health = 100;
      stall.satiety = 100; // é¥±é£Ÿåº¦åˆå§‹å€¼
      stall.thirst = 100; // å£æ¸´åº¦åˆå§‹å€¼
      stall.productivity = 70;
      stall.cleanliness = 0;
      stall.startDay = gameData.day; // ä½¿ç”¨æ­£ç¡®çš„æ¸¸æˆå¤©æ•°
      stall.lastFedDay = gameData.day; // ä½¿ç”¨æ­£ç¡®çš„æ¸¸æˆå¤©æ•°
      stall.lastProducedDay = null;
      stall.produceCount = 0;
      stall.specialState = null;
      stall.adultNotified = false; // æ·»åŠ æˆå¹´é€šçŸ¥æ ‡å¿—

      // éšæœºç»™äºˆç‰¹æ®ŠçŠ¶æ€
      const rand = Math.random();
      if (rand < 0.2) { // 20%æ¦‚ç‡
        stall.specialState = 'high_production';
        showNotification('ç‰¹æ®ŠçŠ¶æ€', `è¿™åªåŠ¨ç‰©è·å¾—äº†"é«˜äº§è›‹"çŠ¶æ€ï¼`);
      } else if (rand < 0.3) { // 10%æ¦‚ç‡
        stall.specialState = 'fast_growth';
        showNotification('ç‰¹æ®ŠçŠ¶æ€', `è¿™åªåŠ¨ç‰©è·å¾—äº†"å¿«é€Ÿç”Ÿé•¿"çŠ¶æ€ï¼`);
      }

      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      updateStallDisplay(
        document.querySelector(`[data-stall-index="${stallIndex}"]`),
        stall,
        stallIndex
      );

      // è§¦å‘æ”¾ç½®ç‰¹æ•ˆ
      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
      if (stallElement) {
        window.triggerPlaceAnimation(stallElement, 'animal');
      }

      // æ›´æ–°ç‰²å£æ£šæ¨¡æ€æ¡†ä¸­çš„å·¦ä¾§å¡ç‰Œæ˜¾ç¤º
      updateLivestockInventory();

      showNotification('å…»æ®–æˆåŠŸ', `ä½ æˆåŠŸåœ¨ç‰²å£æ ${stallIndex + 1}ä¸­æ”¾ç½®äº†${resource.name}ï¼`);
      updateGameData();
    }

    // æ›´æ–°ç‰²å£æ£šæ¨¡æ€æ¡†ä¸­çš„å·¦ä¾§å¡ç‰Œæ˜¾ç¤º
    function updateLivestockInventory() {
      const modal = document.getElementById('livestockModal');
      if (!modal) return;
      
      const animalContainer = modal.querySelector('.livestock-inventory');
      if (!animalContainer) return;
      
      // æ¸…ç©ºå®¹å™¨
      animalContainer.innerHTML = '';
      
      // è·å–ç‰²å£æ£šæ•°æ®
      const livestockData = gameData.livestockData;
      
      // æ·»åŠ å¹¼å¹´åŠ¨ç‰©å¡ç‰Œï¼ˆåªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„å¡ç‰Œï¼‰
      const babyAnimals = ['chick', 'duckling', 'piglet'];
      babyAnimals.forEach(animalId => {
        const animalAmount = gameData.resources[animalId]?.amount || 0;
        if (animalAmount > 0) {
          const animalCard = createAnimalCard(animalId, livestockData.animals[animalId]);
          animalContainer.appendChild(animalCard);
        }
      });
    }

    // åˆ›å»ºé©¬åŒ¹å¡ç‰Œ
    window.createHorseCard = function(horseId, horseData) {
      const resource = gameData.resources[horseId];
      const card = document.createElement('div');
      card.className = 'stable-horse-card stable-card';
      card.dataset.horseId = horseId;
      card.style.cursor = 'pointer'; // æ”¹ä¸ºæŒ‡é’ˆå…‰æ ‡

      card.innerHTML = `
        <img src="${horseData.image}" alt="${horseData.name}" class="stable-horse-card-image">
        <div class="stable-horse-card-name">${horseData.name}</div>
        <div class="stable-horse-card-count">æ•°é‡: ${resource.amount}</div>
      `;

      // æ·»åŠ æ‚¬æµ®æ˜¾ç¤ºåŠŸèƒ½
      card.addEventListener('mouseenter', function() {
        hideStableTooltip(); // å…ˆéšè—å¯èƒ½å­˜åœ¨çš„æ—§æç¤º

        const tooltip = document.createElement('div');
        tooltip.id = 'stable-tooltip';
        tooltip.className = 'stable-tooltip';

        tooltip.innerHTML = `
          <div class="stable-tooltip-title">${horseData.name}</div>
          <div class="stable-tooltip-info">æ•°é‡: ${resource.amount}</div>
          <div class="stable-tooltip-info">ç±»å‹: é©¬åŒ¹</div>
          <div class="stable-tooltip-info">æœ€å¤§å¥åº·å€¼: ${horseData.maxHealth}</div>
        `;

        document.body.appendChild(tooltip);

        // å®šä½å·¥å…·æç¤º
        const rect = card.getBoundingClientRect();
        tooltip.style.position = 'fixed';
        tooltip.style.left = rect.right + 10 + 'px';
        tooltip.style.top = rect.top + 'px';
        tooltip.style.zIndex = '2000';

        // æ·»åŠ æ·¡å…¥åŠ¨ç”»
        tooltip.style.opacity = '0';
        tooltip.style.transform = 'translateY(-5px)';
        setTimeout(() => {
          tooltip.style.opacity = '1';
          tooltip.style.transform = 'translateY(0)';
          tooltip.style.transition = 'all 0.3s ease-out';
        }, 10);
      });

      // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
      card.addEventListener('mouseleave', function() {
        hideStableTooltip();
      });

      // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
      card.addEventListener('mousedown', function(e) {
        e.preventDefault();
        const horseAmount = gameData.resources[horseId]?.amount || 0;
        if (horseAmount <= 0) {
          showNotification('é©¬åŒ¹ä¸è¶³', `ä½ æ²¡æœ‰${horseData.name}ï¼`);
          return;
        }

        // åˆ›å»ºé©¬å©å…‰æ ‡
        createStableCursor(horseId, 'horse');
      });

      return card;
    }

    // åˆ›å»ºé¥²æ–™å¡ç‰Œ
    window.createFeedCard = function(feedId, enableTooltip = false) {
      const resource = gameData.resources[feedId];
      const card = document.createElement('div');
      card.className = 'stable-feed-card stable-card';
      card.dataset.feedId = feedId;
      card.style.cursor = 'pointer'; // æ”¹ä¸ºæŒ‡é’ˆå…‰æ ‡

      // å¤„ç†æœ¨æ¡¶å’Œæ°´è¢‹çš„ç‰¹æ®Šæ˜¾ç¤ºé€»è¾‘
      let displayImage = resource.image;
      let displayName = resource.name;
      let waterIndicator = '';

      if (feedId === 'bucket') {
        // æ ¹æ®å®ä¾‹ç³»ç»Ÿæˆ–waterLevelåŠ¨æ€è®¾ç½®å›¾ç‰‡å’Œæ°´ä½
        let waterLevel = 0;
        if (resource.instances && resource.instances.length > 0) {
          waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        } else if (resource.waterLevel !== undefined) {
          waterLevel = resource.waterLevel;
        }

        // æœ¨æ¡¶ï¼ˆ5æ ¼ï¼Œæ¯æ ¼50å•ä½ï¼‰ï¼šæ°´ä½ = 0æ˜¾ç¤ºç©ºæœ¨æ¡¶ï¼Œæ°´ä½ > 0ï¼ˆ1-5æ ¼ï¼‰æ˜¾ç¤ºæ»¡æ°´æœ¨æ¡¶
        if (waterLevel > 0) {
          displayImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else {
          displayImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
        }
        displayName = 'æœ¨æ¡¶';

        // åˆ›å»ºæ°´ä½æŒ‡ç¤ºæ¡
        const filledLevels = Math.floor(waterLevel / 50);
        let waterCells = '';
        for (let i = 0; i < 5; i++) {
          const isFilled = i >= (5 - filledLevels);
          waterCells += `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px;"></div>`;
        }
        waterIndicator = `
          <div class="water-level-indicator-backpack" style="
            position: absolute;
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 70px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            z-index: 10;
          ">
            ${waterCells}
          </div>
        `;
      } else if (feedId === 'water_bag' || feedId === 'water_bag_full' || feedId === 'empty_water_bag') {
        // æ ¹æ®å®ä¾‹ç³»ç»Ÿæˆ–waterLevelåŠ¨æ€è®¾ç½®æ°´è¢‹å›¾ç‰‡
        let waterLevel = 0;
        if (resource.instances && resource.instances.length > 0) {
          waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        } else {
          waterLevel = resource.waterLevel || 0;
        }
        displayImage = waterLevel > 0 ? 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
        displayName = 'æ°´è¢‹';

        // åˆ›å»ºæ°´ä½æŒ‡ç¤ºæ¡ï¼ˆæ°´è¢‹æ»¡æ°´é‡100ï¼Œæ¯æ ¼20ï¼‰
        const filledLevels = Math.floor(waterLevel / 20);
        let waterCells = '';
        for (let i = 0; i < 5; i++) {
          const isFilled = i >= (5 - filledLevels);
          waterCells += `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px;"></div>`;
        }
        waterIndicator = `
          <div class="water-level-indicator-backpack" style="
            position: absolute;
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 70px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            z-index: 10;
          ">
            ${waterCells}
          </div>
        `;
      }

      // è®¡ç®—è€ä¹…åº¦ï¼ˆç”¨äºæ˜¾ç¤ºç«–ç€çš„è€ä¹…åº¦æ¡ï¼‰
      let durability = undefined;
      let durabilityColor = '#38A169';
      if (feedId === 'broom' && resource.durability !== undefined) {
        durability = resource.durability;
        durabilityColor = durability > 50 ? '#38A169' : durability > 20 ? '#D69E2E' : '#E53E3E';
      } else if (feedId === 'bucket' && resource.durability !== undefined) {
        // è®¡ç®—å¹³å‡è€ä¹…åº¦ï¼ˆæ”¯æŒå®ä¾‹ç³»ç»Ÿï¼‰
        durability = resource.durability;
        if (resource.instances && resource.instances.length > 0) {
          const totalDurability = resource.instances.reduce((sum, inst) => sum + (inst.durability || 100), 0);
          durability = Math.round(totalDurability / resource.instances.length);
        }
        durabilityColor = durability > 50 ? '#38A169' : durability > 20 ? '#D69E2E' : '#E53E3E';
      } else if ((feedId === 'water_bag' || feedId === 'water_bag_full' || feedId === 'empty_water_bag') && resource.durability !== undefined) {
        // è®¡ç®—å¹³å‡è€ä¹…åº¦ï¼ˆæ”¯æŒå®ä¾‹ç³»ç»Ÿï¼‰
        durability = resource.durability;
        if (resource.instances && resource.instances.length > 0) {
          const totalDurability = resource.instances.reduce((sum, inst) => sum + (inst.durability || 100), 0);
          durability = Math.round(totalDurability / resource.instances.length);
        }
        durabilityColor = durability > 50 ? '#38A169' : durability > 20 ? '#D69E2E' : '#E53E3E';
      }

      card.innerHTML = `
        <div class="stable-feed-card-image-container" style="position: relative; overflow: visible;">
          ${waterIndicator}
          <img src="${displayImage}" alt="${displayName}" class="stable-feed-card-image">
          ${durability !== undefined ? `
            <div class="card-durability" style="
              position: absolute;
              right: 4px;
              top: 34px;
              width: 4px;
              height: 45px;
              background-color: #E2E8F0;
              border-radius: 2px;
              overflow: hidden;
              z-index: 10;
            ">
              <div class="durability-bar" style="
                width: 100%;
                background-color: ${durabilityColor};
                position: absolute;
                left: 0;
                bottom: 0;
                border-radius: 0 0 2px 2px;
                transition: height 0.3s ease;
                height: ${durability}%;
              "></div>
            </div>
          ` : ''}
        </div>
        <div class="stable-feed-card-name">${displayName}x${resource.amount}</div>
      `;

      // æ·»åŠ æ‚¬æµ®æ˜¾ç¤ºåŠŸèƒ½ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
      if (enableTooltip) {
        card.addEventListener('mouseenter', function() {
          hideStableTooltip(); // å…ˆéšè—å¯èƒ½å­˜åœ¨çš„æ—§æç¤º

          const tooltip = document.createElement('div');
          tooltip.id = 'stable-tooltip';
          tooltip.className = 'stable-tooltip';

          let description = '';
          if (feedId === 'grass_feed') {
            description = 'é©¬åŒ¹çš„æ—¥å¸¸é¥²æ–™ï¼Œå¯ä»¥æ¢å¤30ç‚¹é¥±é£Ÿåº¦';
          } else if (feedId === 'pill') {
            description = 'å¯ä»¥æ¢å¤é©¬åŒ¹30ç‚¹å¥åº·å€¼';
          } else if (feedId === 'bucket') {
            // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæˆ–resource.waterLevelè®¡ç®—æ€»æ°´é‡
            let waterLevel = 0;
            if (resource.instances && resource.instances.length > 0) {
              waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
            } else if (resource.waterLevel !== undefined) {
              waterLevel = resource.waterLevel;
            }
            description = `ç”¨äºç»™åŠ¨ç‰©æä¾›æ°´æºï¼Œå½“å‰æ°´é‡: ${waterLevel}/250`;
          } else if (feedId === 'water_bag' || feedId === 'water_bag_full' || feedId === 'empty_water_bag') {
            // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿæˆ–resource.waterLevelè®¡ç®—æ€»æ°´é‡
            let waterLevel = 0;
            if (resource.instances && resource.instances.length > 0) {
              waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
            } else {
              waterLevel = resource.waterLevel || 0;
            }
            description = `ä¾¿æºå¼æ°´è¢‹ï¼Œå¯ä»¥ç»™åŠ¨ç‰©æä¾›æ°´æºï¼Œå½“å‰æ°´é‡: ${waterLevel}/100`;
          } else if (feedId === 'fertilizer') {
            description = 'é©¬å©æ¸…æ´åè·å¾—ï¼Œå¯ç”¨äºå†œç”°æ–½è‚¥';
          } else if (feedId === 'broom') {
            description = `ç”¨äºæ¸…æ´ç‰²å£æ å’Œé©¬å©æ ï¼Œå½“å‰è€ä¹…åº¦: ${resource.durability || 0}`;
          }

          tooltip.innerHTML = `
            <div class="stable-tooltip-title">${resource.name}</div>
            <div class="stable-tooltip-info">æ•°é‡: ${resource.amount}</div>
            <div class="stable-tooltip-info">ç±»å‹: å…»æ®–ç”¨å“</div>
            ${feedId === 'broom' ? `<div class="stable-tooltip-info">è€ä¹…åº¦: ${resource.durability || 0}</div>` : ''}
            <div class="stable-tooltip-action">${description}</div>
          `;

          document.body.appendChild(tooltip);

          // å®šä½å·¥å…·æç¤º
          const rect = card.getBoundingClientRect();
          tooltip.style.position = 'fixed';
          tooltip.style.left = rect.right + 10 + 'px';
          tooltip.style.top = rect.top + 'px';
          tooltip.style.zIndex = '2000';

          // æ·»åŠ æ·¡å…¥åŠ¨ç”»
          tooltip.style.opacity = '0';
          tooltip.style.transform = 'translateY(-5px)';
          setTimeout(() => {
            tooltip.style.opacity = '1';
            tooltip.style.transform = 'translateY(0)';
            tooltip.style.transition = 'all 0.3s ease-out';
          }, 10);
        });

        // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
        card.addEventListener('mouseleave', function() {
          hideStableTooltip();
        });
      }

      // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
      card.addEventListener('mousedown', function(e) {
        e.preventDefault();
        const feedAmount = gameData.resources[feedId]?.amount || 0;
        if (feedAmount <= 0) {
          showNotification('æ•°é‡ä¸è¶³', `ä½ æ²¡æœ‰${resource.name}ï¼`);
          return;
        }

        // æ£€æŸ¥æ‰«å¸šè€ä¹…åº¦
        if (feedId === 'broom' && resource.durability !== undefined && resource.durability <= 0) {
          showNotification('æ‰«å¸šå·²æŸå', 'æ‰«å¸šè€ä¹…åº¦å·²è€—å°½ï¼');
          return;
        }

        // åˆ›å»ºé©¬å©å…‰æ ‡
        createStableCursor(feedId, 'feed');
      });

      return card;
    }

    // åˆ›å»ºé©¬å©æ 
    window.createStableStall = function(stallIndex, stallData) {
      const stall = document.createElement('div');
      stall.className = 'stable-stall';
      stall.dataset.stallIndex = stallIndex;

      // æ£€æŸ¥é©¬å©æ æ˜¯å¦è§£é”ï¼ˆç­‰çº§é™åˆ¶ï¼‰
      const isUnlocked = stallIndex < (gameData.stableData?.level || 1);
      if (!isUnlocked) {
        stall.classList.add('locked');
        // æ·»åŠ é”çš„æ ‡è¯†
        const lockIcon = document.createElement('div');
        lockIcon.className = 'stall-lock-icon';
        lockIcon.innerHTML = 'ğŸ”’';
        stall.appendChild(lockIcon);
        // æœªè§£é”çš„æ ä½ç¦ç”¨æ‹–æ”¾äº‹ä»¶
        return stall;
      }

      updateStableStallDisplay(stall, stallData, stallIndex);

      return stall;
    }

    // æ›´æ–°é©¬å©æ æ˜¾ç¤º
    window.updateStableStallDisplay = function(stall, stallData, stallIndex) {
      // æ£€æŸ¥ stall æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›
      if (!stall) {
        console.warn('updateStableStallDisplay: stall å‚æ•°ä¸º nullï¼Œè·³è¿‡æ›´æ–°');
        return;
      }
      
      const stableData = gameData.stableData;

      // åªåœ¨stallå·²ç»æ·»åŠ åˆ°DOMä¸­æ—¶æ‰å…‹éš†èŠ‚ç‚¹
      // é¦–æ¬¡åˆ›å»ºæ—¶stall.parentNodeä¸ºnullï¼Œç›´æ¥æ“ä½œstall
      let targetStall = stall;
      if (stall.parentNode) {
        // å…‹éš†èŠ‚ç‚¹ä»¥æ¸…é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        targetStall = stall.cloneNode(true);
        stall.parentNode.replaceChild(targetStall, stall);
      }

      // æ¸…ç©ºå†…å®¹
      targetStall.innerHTML = '';

      // æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬å™¨
      targetStall.addEventListener('dragover', function(e) {
        e.preventDefault();
        // åªå¯¹æœ‰é©¬çš„æ ä½æ˜¾ç¤ºé«˜äº®
        if (stallData.horse) {
          targetStall.classList.add('drag-over');
          targetStall.style.border = '2px dashed #4CAF50';
          targetStall.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
        }
      });

      targetStall.addEventListener('dragleave', function(e) {
        e.preventDefault();
        targetStall.classList.remove('drag-over');
        targetStall.style.border = '';
        targetStall.style.backgroundColor = '';
      });

      targetStall.addEventListener('drop', function(e) {
        e.preventDefault();
        targetStall.classList.remove('drag-over');
        targetStall.style.border = '';
        targetStall.style.backgroundColor = '';
        
        // è·å–æ‹–æ‹½çš„ç‰©å“
        const draggedItem = window.currentDraggingSeed || window.selectedSeed || window.selectedTool;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é©¬
        if (stallData.horse && (draggedItem === 'water_bag' || draggedItem === 'bucket')) {
          // ä½¿ç”¨ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
          const waterAmount = draggedItem === 'water_bag' ? 20 : 50;
          const result = useWaterFromContainer(draggedItem, waterAmount);
          const waterSource = draggedItem === 'water_bag' ? 'æ°´è¢‹' : 'æœ¨æ¡¶';

          if (result.success) {
            // å¢åŠ é©¬åŒ¹çš„å£æ¸´åº¦ï¼ˆä¸ç‰²å£æ£šä¸€è‡´ï¼‰
            stallData.thirst = Math.min(100, stallData.thirst + waterAmount);
            stallData.lastFedDay = gameData.day; // æ›´æ–°å–‚å…»æ—¥æœŸ

            // æ·»åŠ æµ‡æ°´ç‰¹æ•ˆ
            targetStall.classList.add('water-animation');

            // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
            const cssLoaded = document.getElementById('animation-effects-css') !== null;
            const waterEffectExists = typeof window.createWaterEffect === 'function';
            const waterFloatingTextExists = typeof window.createWaterFloatingText === 'function';

            if (!waterEffectExists || !waterFloatingTextExists || !cssLoaded) {
              console.log('é©¬å©æ ï¼šåŠ¨ç”»ç‰¹æ•ˆæœªå®Œå…¨åˆå§‹åŒ–ï¼Œå¼€å§‹åˆå§‹åŒ–...');
              console.log('  - CSSå·²åŠ è½½:', cssLoaded);
              console.log('  - createWaterEffectå­˜åœ¨:', waterEffectExists);
              console.log('  - createWaterFloatingTextå­˜åœ¨:', waterFloatingTextExists);

              if (typeof initializeAnimationCSS === 'function') {
                initializeAnimationCSS();
                console.log('  - initializeAnimationCSS() å·²è°ƒç”¨');
              }
              if (typeof initializeAnimationEffects === 'function') {
                initializeAnimationEffects();
                console.log('  - initializeAnimationEffects() å·²è°ƒç”¨');
              }

              // å†æ¬¡æ£€æŸ¥åˆå§‹åŒ–ç»“æœ
              console.log('é©¬å©æ ï¼šåˆå§‹åŒ–åæ£€æŸ¥...');
              console.log('  - CSSå·²åŠ è½½:', document.getElementById('animation-effects-css') !== null);
              console.log('  - createWaterEffectå­˜åœ¨:', typeof window.createWaterEffect === 'function');
              console.log('  - createWaterFloatingTextå­˜åœ¨:', typeof window.createWaterFloatingText === 'function');
            }

            // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
            if (window.createWaterEffect) {
              window.createWaterEffect(targetStall);
              console.log('é©¬å©æ ï¼šæ°´æ³¢çº¹ç‰¹æ•ˆå·²è§¦å‘');
            } else {
              console.warn('é©¬å©æ ï¼šcreateWaterEffectå‡½æ•°æœªå®šä¹‰ï¼');
            }
            if (window.createWaterFloatingText) {
              window.createWaterFloatingText(targetStall);
              console.log('é©¬å©æ ï¼šæµ‡æ°´æ¼‚æµ®æ–‡å­—å·²è§¦å‘');
            } else {
              console.warn('é©¬å©æ ï¼šcreateWaterFloatingTextå‡½æ•°æœªå®šä¹‰ï¼');
            }

            // 1500msåç§»é™¤åŠ¨ç”»CSSç±»
            setTimeout(() => {
              targetStall.classList.remove('water-animation');
            }, 1500);

            // 2000msåæ›´æ–°æ˜¾ç¤ºï¼ˆç¡®ä¿æ‰€æœ‰ç‰¹æ•ˆæ’­æ”¾å®Œæˆï¼‰
            setTimeout(() => {
              // æ›´æ–°å•ä¸ªé©¬å©æ ï¼ˆé¿å…é‡æ–°æ¸²æŸ“å¯¼è‡´æ¼‚æµ®æ–‡å­—æ¶ˆå¤±ï¼‰
              updateStableStallDisplay(targetStall, stallData, stallIndex);
              renderResources();
              updateGameData();
              showNotification('å–‚æ°´æˆåŠŸ', `ä½¿ç”¨${waterSource}ç»™é©¬åŒ¹å–‚æ°´æˆåŠŸï¼`);
            }, 2000);
          } else {
            showNotification('æ°´èµ„æºä¸è¶³', result.message);
          }
        } else if (!stallData.horse) {
          showNotification('æ²¡æœ‰é©¬åŒ¹', 'è¿™ä¸ªæ ä½ä¸­æ²¡æœ‰é©¬åŒ¹ï¼Œæ— æ³•å–‚æ°´ï¼');
        }
      });

      // å®šä¹‰ä¸åŒé©¬åŒ¹å¯¹åº”çš„å…»æ®–å›¾ç‰‡
      const horseBreedingImages = {
        'native_horse': 'UI/æœ¬åœŸé©¬å…»æ®–ä¸­.jpg',
        'mongolian_horse': 'UI/è’™å¤é©¬å…»æ®–ä¸­.jpg',
        'hequ_horse': 'UI/æ²³æ›²é©¬å…»æ®–ä¸­.jpg',
        'ferghana_horse': 'UI/æ±—è¡€å®é©¬å…»æ®–ä¸­.jpg',
        'super_ferghana_horse': 'UI/æå“æ±—è¡€å®é©¬å…»æ®–ä¸­.jpg'
      };

      // å¦‚æœé©¬å©æ ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤èƒŒæ™¯å›¾ç‰‡
      if (!stallData.horse) {
        targetStall.style.backgroundImage = "url('UI/é©¬å©.jpg')";

        // æ·»åŠ æ‚¬åœäº‹ä»¶ç›‘å¬å™¨ï¼ˆ0.5ç§’å»¶è¿Ÿï¼‰
        targetStall.addEventListener('mouseenter', function(e) {
          // æ£€æŸ¥é©¬å©çª—å£æ˜¯å¦å­˜åœ¨
          const stableModal = document.getElementById('stableModal');
          if (!stableModal) return;
          // æ£€æŸ¥æ˜¯å¦è§£é”
          const isUnlocked = stallIndex < (gameData.stableData?.level || 1);
          if (!isUnlocked) return;

          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
          if (window.stableHoverTimer) {
            clearTimeout(window.stableHoverTimer);
            window.stableHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œä¸å†æ‰§è¡Œ
          if (window.stableTooltipVisible) return;

          // è®¾ç½®0.5ç§’å»¶è¿Ÿæ˜¾ç¤º
          window.stableHoverTimer = setTimeout(() => {
            showStableTooltip(targetStall, stallData, stallIndex);
            window.stableTooltipVisible = true;
          }, 500);
        });

        targetStall.addEventListener('mouseleave', function() {
          // æ¸…é™¤å®šæ—¶å™¨ï¼ˆå¦‚æœè¿˜æœªæ˜¾ç¤ºï¼‰
          if (window.stableHoverTimer) {
            clearTimeout(window.stableHoverTimer);
            window.stableHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œç«‹å³éšè—
          if (window.stableTooltipVisible) {
            hideStableTooltip();
            window.stableTooltipVisible = false;
          }
        });
      } else {
        // æ˜¾ç¤ºé©¬åŒ¹ä¿¡æ¯ï¼Œè®¾ç½®å¯¹åº”çš„å…»æ®–èƒŒæ™¯å›¾ç‰‡
        const horseData = stableData.horses[stallData.horse];
        const breedingImage = horseBreedingImages[stallData.horse] || 'UI/é©¬å©.jpg';
        targetStall.style.backgroundImage = `url('${breedingImage}')`;

        // æ·»åŠ æ‚¬åœäº‹ä»¶ç›‘å¬å™¨ï¼ˆ0.5ç§’å»¶è¿Ÿï¼‰
        targetStall.addEventListener('mouseenter', function(e) {
          // æ£€æŸ¥é©¬å©çª—å£æ˜¯å¦å­˜åœ¨
          const stableModal = document.getElementById('stableModal');
          if (!stableModal) return;
          // æ£€æŸ¥æ˜¯å¦è§£é”
          const isUnlocked = stallIndex < (gameData.stableData?.level || 1);
          if (!isUnlocked) return;

          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
          if (window.stableHoverTimer) {
            clearTimeout(window.stableHoverTimer);
            window.stableHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œä¸å†æ‰§è¡Œ
          if (window.stableTooltipVisible) return;

          // è®¾ç½®0.5ç§’å»¶è¿Ÿæ˜¾ç¤º
          window.stableHoverTimer = setTimeout(() => {
            showStableTooltip(targetStall, stallData, stallIndex);
            window.stableTooltipVisible = true;
          }, 500);
        });

        targetStall.addEventListener('mouseleave', function() {
          // æ¸…é™¤å®šæ—¶å™¨ï¼ˆå¦‚æœè¿˜æœªæ˜¾ç¤ºï¼‰
          if (window.stableHoverTimer) {
            clearTimeout(window.stableHoverTimer);
            window.stableHoverTimer = null;
          }

          // å¦‚æœæç¤ºå·²æ˜¾ç¤ºï¼Œç«‹å³éšè—
          if (window.stableTooltipVisible) {
            hideStableTooltip();
            window.stableTooltipVisible = false;
          }
        });

        // å¦‚æœæ±¡æµŠåº¦è¾¾åˆ°100ï¼Œæ·»åŠ æ¸…ç†æŒ‰é’®
        if (stallData.cleanliness >= 100) {
          const cleanIndicator = document.createElement('div');
          cleanIndicator.className = 'stable-clean-indicator';
          cleanIndicator.innerHTML = 'ğŸ§¹';
          cleanIndicator.title = 'ç‚¹å‡»æ¸…ç†è·å¾—è‚¥æ–™';
          cleanIndicator.onclick = function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            cleanStableStall(stallIndex);
          };
          targetStall.appendChild(cleanIndicator);
        }

      }
    }

    // åˆ›å»ºé©¬å©å…‰æ ‡å‡½æ•°ï¼ˆç”¨äºé©¬åŒ¹ã€é¥²æ–™å’Œæ‰«å¸šçš„è¿ç»­æ”¾ç½®ï¼‰- ä¸ç§å­å…‰æ ‡ä½¿ç”¨ç›¸åŒæ ·å¼
    function createStableCursor(itemId, itemType) {
      console.log('createStableCursor è¢«è°ƒç”¨ï¼ŒitemId:', itemId, 'itemType:', itemType);

      let item, itemAmount, itemImage, itemName;

      // æ ¹æ®ç‰©å“ç±»å‹è·å–ç‰©å“ä¿¡æ¯
      if (itemType === 'horse') {
        const stableData = gameData.stableData;
        const horseData = stableData.horses[itemId];
        item = gameData.resources[itemId];
        itemAmount = item?.amount || 0;
        itemImage = horseData.image;
        itemName = horseData.name;
      } else if (itemType === 'feed' || itemType === 'broom') {
        item = gameData.resources[itemId];
        itemAmount = item?.amount || 0;
        itemImage = item.image;
        itemName = item.name;

        // å¯¹äºæœ¨æ¡¶å’Œæ°´è¢‹ï¼Œæ ¹æ®æ°´ä½åŠ¨æ€è®¾ç½®å›¾ç‰‡
        if (itemId === 'bucket') {
          let waterLevel = 0;
          if (item.instances && item.instances.length > 0) {
            waterLevel = item.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (item.waterLevel !== undefined) {
            waterLevel = item.waterLevel;
          }
          // æœ¨æ¡¶ï¼ˆ5æ ¼ï¼Œæ¯æ ¼50å•ä½ï¼‰ï¼šæ°´ä½ = 0æ˜¾ç¤ºç©ºæœ¨æ¡¶ï¼Œæ°´ä½ > 0ï¼ˆ1-5æ ¼ï¼‰æ˜¾ç¤ºæ»¡æ°´æœ¨æ¡¶
          if (waterLevel > 0) {
            itemImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            itemImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
          }
        } else if (itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
          let waterLevel = 0;
          if (item.instances && item.instances.length > 0) {
            waterLevel = item.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
          } else if (item.waterLevel !== undefined) {
            waterLevel = item.waterLevel;
          }
          if (waterLevel >= 80) {
            itemImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
          } else if (waterLevel > 0) {
            itemImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
          } else {
            itemImage = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
          }
        }

        // æ£€æŸ¥æ‰«å¸šè€ä¹…åº¦
        if (itemType === 'broom' && item.durability !== undefined && item.durability <= 0) {
          showNotification('æ‰«å¸šå·²æŸå', 'æ‰«å¸šè€ä¹…åº¦å·²è€—å°½ï¼');
          return;
        }

        // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ°´è€Œä¸æ˜¯æ£€æŸ¥æ•°é‡
        if ((itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag')) {
          const totalWater = getContainerTotalWater(itemId);
          if (totalWater <= 0) {
            showNotification('æ²¡æœ‰æ°´', `${itemName}é‡Œæ²¡æœ‰æ°´ï¼Œè¯·å…ˆè£…æ°´ï¼`);
            return;
          }
        }
      }

      // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ä»¥å¤–çš„ç‰©å“ï¼Œæ£€æŸ¥æ•°é‡
      if ((itemId !== 'bucket' && itemId !== 'water_bag' && itemId !== 'water_bag_full' && itemId !== 'empty_water_bag') && itemAmount <= 0) {
        showNotification('æ•°é‡ä¸è¶³', `ä½ æ²¡æœ‰${itemName}ï¼`);
        return;
      }

      // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å…‰æ ‡
      const existingCursor = document.getElementById('stable-drag-cursor');
      if (existingCursor) {
        console.log('æ¸…é™¤æ—§å…‰æ ‡');
        existingCursor.parentNode.removeChild(existingCursor);
      }

      // åˆ›å»ºè‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆï¼ˆä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„æ ·å¼ï¼‰
      const customCursor = document.createElement('div');
      customCursor.id = 'stable-drag-cursor';
      customCursor.className = 'stable-drag-cursor';
      customCursor.style.cssText = `
        position: fixed;
        pointer-events: none;
        z-index: 9999;
        width: 40px;
        height: 40px;
        background-image: url('${itemImage}');
        background-size: cover;
        border-radius: 50%;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3);
        opacity: 0.9;
        transform: translate(-50%, -50%);
        transition: transform 0.1s ease;
        display: block !important;
      `;

      // æ·»åŠ æ‰‹å½¢å›¾æ ‡æ•ˆæœ
      const handIcon = document.createElement('div');
      handIcon.style.cssText = `
        position: absolute;
        top: -10px;
        right: -10px;
        width: 20px;
        height: 20px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238D6E63"><path d="M12.5 5.5C11.67 5.5 11 6.17 11 7V11C11 11.55 10.55 12 10 12S9 11.55 9 11V7C9 6.17 8.33 5.5 7.5 5.5S6 6.17 6 7V12C6 13.1 6.9 14 8 14H9.5C10.33 14 11 13.33 11 12.5V12C11 13.1 10.1 14 9 14H8C6.9 14 6 13.1 6 12V7C6 6.17 5.33 5.5 4.5 5.5S3 6.17 3 7V12C3 14.21 4.79 16 7 16H11.5C13.43 16 15 14.43 15 12.5V7C15 6.17 14.33 5.5 13.5 5.5S12 6.17 12 7V11.5C12 11.78 12.22 12 12.5 12Z"/></svg>');
        background-size: contain;
        background-repeat: no-repeat;
      `;
      customCursor.appendChild(handIcon);

      // æ·»åŠ æ•°é‡æŒ‡ç¤ºå™¨åˆ°å·¦ä¸‹è§’
      const countIndicator = document.createElement('div');
      countIndicator.id = 'stable-count-indicator';
      countIndicator.className = 'seed-count-indicator';
      countIndicator.style.cssText = `
        position: absolute;
        bottom: -5px;
        left: -5px;
        background-color: #E53E3E;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      `;
      // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
      let displayCount = itemAmount;
      if ((itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag')) {
        if (itemId === 'bucket') {
          // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('bucket');
          displayCount = Math.floor(totalWater / 50);
          console.log('é©¬å©æ æœ¨æ¡¶ï¼štotalWater =', totalWater, ', displayCount =', displayCount);
        } else {
          // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('water_bag');
          displayCount = Math.floor(totalWater / 20);
          console.log('é©¬å©æ æ°´è¢‹ï¼šitemId =', itemId, ', totalWater =', totalWater, ', displayCount =', displayCount);
        }
      }
      countIndicator.textContent = displayCount;
      customCursor.appendChild(countIndicator);

      document.body.appendChild(customCursor);

      // éšè—é»˜è®¤å…‰æ ‡ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰å…‰æ ‡
      document.body.style.cursor = 'none';

      // åˆå§‹åŒ–å…‰æ ‡ä½ç½®
      customCursor.style.left = window.lastMouseX + 'px';
      customCursor.style.top = window.lastMouseY + 'px';

      // å­˜å‚¨çŠ¶æ€
      let lastPosition = { x: window.lastMouseX || 0, y: window.lastMouseY || 0 };
      let lastTime = Date.now();
      const trailInterval = 100;
      let lastTrailTime = lastTime;
      let lastAppliedStallId = null; // è®°å½•ä¸Šä¸€æ¬¡æ“ä½œçš„æ ä½IDï¼Œé˜²æ­¢é‡å¤æ“ä½œ

      // åˆ›å»ºæ‹–å½±æ•ˆæœ
      function createDragTrail(x, y, image) {
        const trail = document.createElement('div');
        trail.className = 'drag-trail';
        trail.style.left = (x - 20) + 'px';
        trail.style.top = (y - 20) + 'px';
        trail.style.width = '40px';
        trail.style.height = '40px';
        trail.style.backgroundImage = `url('${image}')`;
        document.body.appendChild(trail);

        setTimeout(() => {
          if (trail.parentNode) {
            trail.parentNode.removeChild(trail);
          }
        }, 500);
      }

      // åˆ›å»ºå…‰ç‚¹ç²’å­ï¼ˆä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„é‡‘è‰²ç²’å­æ•ˆæœï¼‰
      function createParticle(x, y, speed) {
        const particle = document.createElement('div');
        particle.className = 'particle drag-particle';
        const size = 5 + Math.random() * 8;
        const angle = Math.random() * Math.PI * 2;
        const distance = 20 + Math.random() * 40 + speed * 5;

        particle.style.left = (x - size/2) + 'px';
        particle.style.top = (y - size/2) + 'px';
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');

        // ä½¿ç”¨ä¸ç§å­å…‰æ ‡ç›¸åŒçš„é‡‘è‰²ç³»ç²’å­é¢œè‰²
        const colors = [
          'rgba(255, 215, 0, 0.8)',
          'rgba(255, 165, 0, 0.8)',
          'rgba(255, 140, 0, 0.8)',
          'rgba(139, 69, 19, 0.6)'
        ];
        const color = colors[Math.floor(Math.random() * colors.length)];
        particle.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;

        document.body.appendChild(particle);

        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, 1000);
      }

      // æ›´æ–°å…‰æ ‡ä½ç½®
      const updateCursorPosition = (e) => {
        if (!document.getElementById('stable-drag-cursor')) {
          document.body.appendChild(customCursor);
        }

        const currentTime = Date.now();
        const deltaTime = currentTime - lastTime;
        const deltaX = e.clientX - lastPosition.x;
        const deltaY = e.clientY - lastPosition.y;
        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        const speed = distance / (deltaTime || 1);

        // æ£€æŸ¥æ˜¯å¦é è¿‘é©¬å©æ ä¸­å¿ƒ
        const hoveredElement = document.elementFromPoint(e.clientX, e.clientY);
        const stableStall = hoveredElement?.closest('.stable-stall');
        let isSnap = false;
        let stallData = null;
        let stallIndex = null;

        // ç¡®å®šç›®æ ‡æ ä½
        if (stableStall) {
          stallIndex = parseInt(stableStall.dataset.stallIndex);
          stallData = gameData.stableData.stalls[stallIndex];
        }

        // æ£€æŸ¥æ ä½æ˜¯å¦å·²è§£é”
        const isLocked = stableStall && stableStall.classList.contains('locked');

        if (stableStall && !isLocked) {
          const rect = stableStall.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          const snapDistance = Math.sqrt(
            Math.pow(e.clientX - centerX, 2) +
            Math.pow(e.clientY - centerY, 2)
          );

          if (snapDistance < 50) {
            customCursor.style.left = centerX + 'px';
            customCursor.style.top = centerY + 'px';
            isSnap = true;

            let snapIndicator = document.getElementById('snap-indicator');
            if (!snapIndicator) {
              snapIndicator = document.createElement('div');
              snapIndicator.id = 'snap-indicator';
              snapIndicator.className = 'snap-indicator';
              document.body.appendChild(snapIndicator);
            }
            snapIndicator.style.left = rect.left + 'px';
            snapIndicator.style.top = rect.top + 'px';
            snapIndicator.style.width = rect.width + 'px';
            snapIndicator.style.height = rect.height + 'px';
            snapIndicator.style.display = 'block';

            // è‡ªåŠ¨æ“ä½œé€»è¾‘ï¼šå½“å…‰æ ‡å¸é™„åˆ°æ ä½ä¸­å¿ƒæ—¶è‡ªåŠ¨æ‰§è¡Œæ“ä½œ
            if (stallIndex !== undefined && stallIndex !== lastAppliedStallId) {
              console.log(`è‡ªåŠ¨è§¦å‘æ“ä½œï¼Œç±»å‹: ${itemType}, æ ä½ID: ${stallIndex}`);

              let success = false;

              // æ ¹æ®ç‰©å“ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
              if (itemType === 'horse') {
                // æ”¾ç½®é©¬åŒ¹
                if (!stallData.horse) {
                  window.placeHorseInStall(stallIndex, itemId);
                  success = true;
                }
              } else if (itemType === 'feed') {
                // å–‚å…»é©¬åŒ¹
                if (stallData.horse) {
                  // æ£€æŸ¥é¥±é£Ÿåº¦å’Œå£æ¸´åº¦æ˜¯å¦å·²æ»¡
                  const stall = gameData.stableData.stalls[stallIndex];
                  const waterSource = gameData.resources[itemId];
                  let canFeed = false;

                  // æ£€æŸ¥ä¸åŒç±»å‹çš„é¥²æ–™
                  if (itemId === 'grass_feed' || itemId === 'pill') {
                    if (itemId === 'grass_feed' && stall.satiety < 100) {
                      canFeed = true;
                    } else if (itemId === 'pill' && stall.health < 100) {
                      canFeed = true;
                    }
                  } else if (itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
                    // ä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°æ£€æŸ¥æ˜¯å¦æœ‰æ°´
                    const totalWater = getContainerTotalWater(itemId);
                    if (totalWater > 0 && stall.thirst < 100) {
                      canFeed = true;
                    }
                  }

                  if (canFeed) {
                    window.feedHorse(stallIndex, itemId);
                    success = true;
                  }
                }
              } else if (itemType === 'broom') {
                // æ¸…æ´æ ä½
                if (stallData.horse && stallData.cleanliness > 50) {
                  window.cleanStableStallWithBroom(stallIndex);
                  success = true;
                }
              }

              if (success) {
                // è§¦å‘åä¸½çš„æ”¾ç½®åŠ¨ç”»ç‰¹æ•ˆï¼ˆä»…ç”¨äºæ”¾ç½®é©¬åŒ¹ï¼‰
                if (itemType === 'horse' && window.triggerPlaceAnimation && typeof window.triggerPlaceAnimation === 'function') {
                  console.log('æ­£åœ¨è°ƒç”¨ triggerPlaceAnimation...');
                  window.triggerPlaceAnimation(stableStall, itemType);
                  console.log('triggerPlaceAnimation è°ƒç”¨å®Œæˆ');
                }

                // æ›´æ–°æ•°é‡æŒ‡ç¤ºå™¨
                let newDisplayCount = gameData.resources[itemId]?.amount || 0;
                // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
                if (itemId === 'bucket') {
                  // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
                  const totalWater = getContainerTotalWater('bucket');
                  newDisplayCount = Math.floor(totalWater / 50);
                } else if (itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
                  // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
                  const totalWater = getContainerTotalWater('water_bag');
                  newDisplayCount = Math.floor(totalWater / 20);
                }
                countIndicator.textContent = newDisplayCount;

                // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œå½“æ°´ä½æ ¼å­æ•°ä¸º0æ—¶ç«‹å³æ¸…é™¤å…‰æ ‡ï¼›å…¶ä»–ç‰©å“å½“å¡ç‰Œæ•°é‡ä¸º0æ—¶æ¸…é™¤
                let shouldClearCursor = false;
                if (itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
                  // æ°´è¢‹å’Œæ°´æ¡¶ï¼šæ£€æŸ¥æ°´ä½æ ¼å­æ•°æ˜¯å¦ä¸º0
                  if (newDisplayCount <= 0) {
                    shouldClearCursor = true;
                    console.log('é©¬å©æ ï¼šæ°´è¢‹æˆ–æ°´æ¡¶æ°´ä½æ ¼å­æ•°ä¸º0ï¼Œæ¸…é™¤å…‰æ ‡');
                  }
                } else {
                  // å…¶ä»–ç‰©å“ï¼šæ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0
                  if (gameData.resources[itemId]?.amount <= 0) {
                    shouldClearCursor = true;
                  }
                }

                if (shouldClearCursor) {
                  // æ¸…é™¤å…‰æ ‡
                  if (window.clearAllCustomCursors) {
                    window.clearAllCustomCursors();
                  }
                  return;
                }

                // æ›´æ–°é©¬å©çª—å£ä¸­çš„å·¦ä¾§å¡ç‰Œæ˜¾ç¤º
                if (window.updateHorseCards) {
                  window.updateHorseCards();
                }
                if (window.updateFeedCards) {
                  window.updateFeedCards();
                }

                // è®°å½•å·²æ“ä½œçš„æ ä½ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
                lastAppliedStallId = stallIndex;
              }
            }
          } else {
            const hideSnapIndicator = document.getElementById('snap-indicator');
            if (hideSnapIndicator) {
              hideSnapIndicator.style.display = 'none';
            }
          }
        } else {
          const snapIndicator2 = document.getElementById('snap-indicator');
          if (snapIndicator2) {
            snapIndicator2.style.display = 'none';
          }
        }

        if (!isSnap) {
          customCursor.style.left = e.clientX + 'px';
          customCursor.style.top = e.clientY + 'px';
        }

        // æ‘‡æ‘†æ•ˆæœ
        const swing = Math.sin(Date.now() / 150) * 5;

        const canPerformAction = stableStall && !isLocked;

        if (canPerformAction) {
          customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(1.1)`;
          customCursor.style.boxShadow = '0 0 25px rgba(76, 175, 80, 0.8), 0 4px 8px rgba(0,0,0,0.3)';
        } else {
          const scale = 1 + Math.sin(Date.now() / 200) * 0.05;
          customCursor.style.transform = `translate(-50%, -50%) rotate(${swing}deg) scale(${scale})`;
          customCursor.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.6), 0 4px 8px rgba(0,0,0,0.3)';
        }

        // åˆ›å»ºæ‹–å½±
        if (currentTime - lastTrailTime > Math.max(50, 150 - speed * 10)) {
          createDragTrail(lastPosition.x, lastPosition.y, itemImage);
          lastTrailTime = currentTime;
        }

        // åˆ›å»ºç²’å­
        if (Math.random() < 0.3) {
          createParticle(e.clientX, e.clientY, speed);
        }

        lastPosition = { x: e.clientX, y: e.clientY };
        lastTime = currentTime;
        window.lastMouseX = e.clientX;
        window.lastMouseY = e.clientY;

        // æ›´æ–°æ•°é‡
        let currentDisplayCount = gameData.resources[itemId]?.amount || 0;
        // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œæ˜¾ç¤ºæ°´ä½æ ¼å­æ•°è€Œä¸æ˜¯å¡ç‰Œæ•°é‡
        if (itemId === 'bucket') {
          // æœ¨æ¡¶ï¼šwaterLevel 0-250ï¼Œæ¯50ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('bucket');
          currentDisplayCount = Math.floor(totalWater / 50);
        } else if (itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
          // æ°´è¢‹ï¼šwaterLevel 0-100ï¼Œæ¯20ä¸ºä¸€ä¸ªç­‰çº§ï¼ˆ5æ ¼ï¼‰
          const totalWater = getContainerTotalWater('water_bag');
          currentDisplayCount = Math.floor(totalWater / 20);
        }
        countIndicator.textContent = currentDisplayCount;

        // å¯¹äºæ°´è¢‹å’Œæ°´æ¡¶ï¼Œå½“æ°´ä½æ ¼å­æ•°ä¸º0æ—¶ç«‹å³æ¸…é™¤å…‰æ ‡ï¼›å…¶ä»–ç‰©å“å½“å¡ç‰Œæ•°é‡ä¸º0æ—¶æ¸…é™¤
        let shouldClearCursor = false;
        if (itemId === 'bucket' || itemId === 'water_bag' || itemId === 'water_bag_full' || itemId === 'empty_water_bag') {
          // æ°´è¢‹å’Œæ°´æ¡¶ï¼šæ£€æŸ¥æ°´ä½æ ¼å­æ•°æ˜¯å¦ä¸º0
          if (currentDisplayCount <= 0) {
            shouldClearCursor = true;
            console.log('é©¬å©æ ï¼šæ°´è¢‹æˆ–æ°´æ¡¶æ°´ä½æ ¼å­æ•°ä¸º0ï¼Œæ¸…é™¤å…‰æ ‡');
          }
        } else {
          // å…¶ä»–ç‰©å“ï¼šæ£€æŸ¥å¡ç‰Œæ•°é‡æ˜¯å¦ä¸º0
          if (gameData.resources[itemId]?.amount <= 0) {
            shouldClearCursor = true;
          }
        }

        if (shouldClearCursor) {
          // æ¸…é™¤å…‰æ ‡
          if (window.clearAllCustomCursors) {
            window.clearAllCustomCursors();
          }
          return;
        }
      };

      // ç«‹å³æ›´æ–°ä¸€æ¬¡
      updateCursorPosition({ clientX: window.lastMouseX || 0, clientY: window.lastMouseY || 0 });

      // æ·»åŠ é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨
      window.stableCursorMouseMoveHandler = updateCursorPosition;
      document.addEventListener('mousemove', window.stableCursorMouseMoveHandler);
    }

    // æ¸…é™¤é©¬å©å…‰æ ‡å‡½æ•°
    function clearStableCursor() {
      // ä½¿ç”¨å…¨å±€æ¸…é™¤å‡½æ•°
      if (window.clearAllCustomCursors) {
        window.clearAllCustomCursors();
      }

      // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
      if (window.stableCursorMouseMoveHandler) {
        document.removeEventListener('mousemove', window.stableCursorMouseMoveHandler);
        window.stableCursorMouseMoveHandler = null;
      }
    }

    // æ”¾ç½®é©¬åŒ¹åˆ°é©¬å©æ 
    window.placeHorseInStall = function(stallIndex, horseId) {
      const stableData = gameData.stableData;

      // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é©¬åŒ¹
      if (gameData.resources[horseId] && gameData.resources[horseId].amount > 0) {
        // æ¶ˆè€—ä¸€åŒ¹é©¬
        gameData.resources[horseId].amount--;

        // è®¾ç½®é©¬å©æ ä¿¡æ¯
        const stall = stableData.stalls[stallIndex];
        const horseData = stableData.horses[horseId];

        stall.horse = horseId;
        stall.health = horseData.maxHealth;
        stall.satiety = 100;
        stall.thirst = 100; // å£æ¸´åº¦åˆå§‹å€¼
        stall.cleanliness = 0;
        stall.startDay = gameData.day;
        stall.lastFedDay = gameData.day;
        stall.lastCleanedDay = gameData.day;

        // æ›´æ–°æ˜¾ç¤º
        renderResources();
        updateStableStallDisplay(
          document.querySelector(`.stable-stall[data-stall-index="${stallIndex}"]`),
          stall,
          stallIndex
        );

        // è§¦å‘æ”¾ç½®ç‰¹æ•ˆ
        const stallElement = document.querySelector(`.stable-stall[data-stall-index="${stallIndex}"]`);
        if (stallElement) {
          window.triggerPlaceAnimation(stallElement, 'horse');
        }

        // æ›´æ–°å·¦ä¾§é©¬åŒ¹å¡ç‰Œæ˜¾ç¤º
        updateHorseCards();

        showNotification('æ”¾å…¥é©¬åŒ¹', `ä½ æˆåŠŸå°†${horseData.name}æ”¾å…¥é©¬å©æ ï¼`);

        updateGameData();
      }
    }

    // å–‚å…»é©¬åŒ¹
    window.feedHorse = function(stallIndex, feedId) {
      const stableData = gameData.stableData;
      const stall = stableData.stalls[stallIndex];
      const horseData = stableData.horses[stall.horse];
      const stallElement = document.querySelector(`.stable-stall[data-stall-index="${stallIndex}"]`);
      
      if (feedId === 'grass_feed') {
        if (gameData.resources[feedId] && gameData.resources[feedId].amount > 0) {
          // æ£€æŸ¥é¥±é£Ÿåº¦æ˜¯å¦å·²æ»¡
          if (stall.satiety >= 100) {
            showNotification('é¥±é£Ÿåº¦å·²æ»¡', `${horseData.name}ç°åœ¨å¾ˆé¥±ï¼Œä¸éœ€è¦å–‚é£Ÿï¼`);
            return;
          }
          
          // æ¶ˆè€—è‰æ–™
          gameData.resources[feedId].amount--;
          
          // å¢åŠ é¥±é£Ÿåº¦
          stall.satiety = Math.min(100, stall.satiety + 30);

          // æ›´æ–°å–‚å…»æ—¥æœŸ
          stall.lastFedDay = gameData.day;

          // æ·»åŠ å–‚é£ŸåŠ¨ç”»æ•ˆæœ
          if (stallElement) {
            stallElement.classList.add('feed-animation');

            // åˆ›å»ºå–‚é£Ÿæ¼‚æµ®æ–‡å­— - æ‰‹åŠ¨åŠ¨ç”»
            const rect = stallElement.getBoundingClientRect();
            const feedText = document.createElement('div');
            feedText.className = 'floating-text';
            feedText.textContent = 'å–‚é£ŸæˆåŠŸï¼ğŸŒ¾';
            feedText.style.color = '#ED8936';
            feedText.style.fontSize = '1.4rem';
            feedText.style.fontWeight = 'bold';
            feedText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 20px rgba(237, 137, 54, 0.8)';
            feedText.style.position = 'fixed';
            feedText.style.left = (rect.left + rect.width / 2) + 'px';
            feedText.style.top = (rect.top + rect.height / 2) + 'px';
            feedText.style.transform = 'translateX(-50%) translateY(-50%)';
            feedText.style.zIndex = '9999';
            feedText.style.opacity = '0';
            feedText.style.pointerEvents = 'none';
            feedText.style.whiteSpace = 'nowrap';
            feedText.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            document.body.appendChild(feedText);

            // åˆ›å»ºé£Ÿç‰©ç²’å­ç‰¹æ•ˆ - å¢åŠ ç²’å­æ•°é‡å’Œå¤šæ ·æ€§
            for (let i = 0; i < 15; i++) {
              const particle = document.createElement('div');
              particle.className = 'food-particle';
              const size = Math.random() * 14 + 6;
              particle.style.width = size + 'px';
              particle.style.height = size + 'px';
              particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
              particle.style.top = (rect.top + rect.height / 2 - 40) + 'px';
              particle.style.setProperty('--bounce-height', (Math.random() * 80 + 20) + 'px');
              particle.style.setProperty('--bounce-height-half', (Math.random() * 40 + 10) + 'px');
              particle.style.setProperty('--fall-distance', (Math.random() * 90 + 20) + 'px');
              
              // éšæœºé¢œè‰²
              const foodColors = ['#F59E0B', '#F97316', '#EF4444', '#10B981', '#3B82F6'];
              particle.style.backgroundColor = foodColors[Math.floor(Math.random() * foodColors.length)];
              particle.style.opacity = Math.random() * 0.3 + 0.7;
              
              const delay = Math.random() * 0.3;
              particle.style.animationDelay = delay + 's';
              document.body.appendChild(particle);

              setTimeout(() => {
                if (particle.parentNode === document.body) {
                  document.body.removeChild(particle);
                }
              }, (800 + delay * 1000));
            }

            // åˆ›å»ºæ—‹è½¬çš„è°·ç²’ç‰¹æ•ˆ
            for (let i = 0; i < 8; i++) {
              const grain = document.createElement('div');
              grain.className = 'food-grain';
              const grainSize = Math.random() * 10 + 5;
              grain.style.cssText = `
                position: fixed;
                width: ${grainSize}px;
                height: ${grainSize}px;
                background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
                border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
                pointer-events: none;
                z-index: 9998;
                animation: food-grain-spin 1s ease-out forwards;
              `;
              const angle = Math.random() * Math.PI * 2;
              const distance = Math.random() * 60 + 20;
              grain.style.left = (rect.left + rect.width / 2 + Math.cos(angle) * distance) + 'px';
              grain.style.top = (rect.top + rect.height / 2 + Math.sin(angle) * distance) + 'px';
              grain.style.animationDelay = (Math.random() * 0.2) + 's';
              document.body.appendChild(grain);

              setTimeout(() => {
                if (grain.parentNode === document.body) {
                  document.body.removeChild(grain);
                }
              }, (1200 + Math.random() * 300));
            }

            // åˆ›å»ºé£Ÿç‰©æ˜Ÿå½¢ç‰¹æ•ˆ - å¢åŠ æ•°é‡å’Œå¤§å°
            for (let i = 0; i < 7; i++) {
              const star = document.createElement('div');
              star.className = 'food-star';
              const starSize = Math.random() * 20 + 12;
              star.style.width = starSize + 'px';
              star.style.height = starSize + 'px';
              const angle = (i / 7) * 360;
              const distance = Math.random() * 60 + 25;
              star.style.left = (rect.left + rect.width / 2 + Math.cos(angle * Math.PI / 180) * distance) + 'px';
              star.style.top = (rect.top + rect.height / 2 + Math.sin(angle * Math.PI / 180) * distance) + 'px';
              star.style.setProperty('--star-distance', (Math.random() * 80 + 30) + 'px');
              star.style.opacity = Math.random() * 0.3 + 0.7;
              const delay = Math.random() * 0.2;
              star.style.animationDelay = delay + 's';
              document.body.appendChild(star);

              setTimeout(() => {
                if (star.parentNode === document.body) {
                  document.body.removeChild(star);
                }
              }, (1000 + delay * 1000));
            }

            // åˆ›å»ºé—ªçƒå…‰ç‚¹ç‰¹æ•ˆ
            for (let i = 0; i < 5; i++) {
              const sparkle = document.createElement('div');
              sparkle.style.cssText = `
                position: fixed;
                width: 8px;
                height: 8px;
                background: radial-gradient(circle, #FFD700 0%, transparent 70%);
                border-radius: 50%;
                pointer-events: none;
                z-index: 9999;
                animation: sparkle-burst 0.6s ease-out forwards;
              `;
              sparkle.style.left = (rect.left + Math.random() * rect.width) + 'px';
              sparkle.style.top = (rect.top + Math.random() * rect.height) + 'px';
              sparkle.style.animationDelay = (Math.random() * 0.3) + 's';
              document.body.appendChild(sparkle);

              setTimeout(() => {
                if (sparkle.parentNode === document.body) {
                  document.body.removeChild(sparkle);
                }
              }, 900);
            }

            // ä½¿ç”¨setTimeoutè§¦å‘åŠ¨ç”»
            setTimeout(() => {
              feedText.style.opacity = '1';
              feedText.style.top = (rect.top + rect.height / 2 - 60) + 'px';
              feedText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.5) rotate(-5deg)';
            }, 10);

            setTimeout(() => {
              feedText.style.opacity = '0';
              feedText.style.top = (rect.top + rect.height / 2 - 120) + 'px';
              feedText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.3) rotate(5deg)';
            }, 500);

            setTimeout(() => {
              stallElement.classList.remove('feed-animation');
              // ç§»é™¤æ¼‚æµ®æ–‡å­—
              if (feedText.parentNode === document.body) {
                document.body.removeChild(feedText);
              }
              updateStableStallDisplay(stallElement, stall, stallIndex);
            }, 1500);
          }

          showNotification('å–‚é£ŸæˆåŠŸ', `ä½ ç”¨è‰æ–™å–‚å…»äº†${horseData.name}ï¼Œé¥±é£Ÿåº¦å¢åŠ 30ç‚¹ï¼`);
        }
      } else if (feedId === 'pill') {
        if (gameData.resources[feedId] && gameData.resources[feedId].amount > 0) {
          // æ£€æŸ¥å¥åº·å€¼æ˜¯å¦å·²æ»¡
          if (stall.health >= horseData.maxHealth) {
            showNotification('å¥åº·å€¼å·²æ»¡', `${horseData.name}ç°åœ¨å¾ˆå¥åº·ï¼Œä¸éœ€è¦ç”¨è¯ï¼`);
            return;
          }
          
          // æ¶ˆè€—è¯ä¸¸
          gameData.resources[feedId].amount--;
          
          // å¢åŠ å¥åº·å€¼
          stall.health = Math.min(horseData.maxHealth, stall.health + 30);
          
          showNotification('å–‚è¯æˆåŠŸ', `ä½ ç”¨è¯ä¸¸æ²»ç–—äº†${horseData.name}ï¼Œå¥åº·å€¼å¢åŠ 30ç‚¹ï¼`);
        }
      } else if (feedId === 'bucket' || feedId === 'water_bag' || feedId === 'water_bag_full' || feedId === 'empty_water_bag') {
        // å–‚æ°´ - ä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°
        const waterSourceName = feedId.includes('bucket') ? 'æœ¨æ¡¶' : 'æ°´è¢‹';
        
        // æ£€æŸ¥å£æ¸´åº¦æ˜¯å¦å·²æ»¡
        if (stall.thirst >= 100) {
          showNotification('å£æ¸´åº¦å·²æ»¡', `${horseData.name}ç°åœ¨ä¸å£æ¸´ï¼Œä¸éœ€è¦å–‚æ°´ï¼`);
          return;
        }

        // ä½¿ç”¨ç»Ÿä¸€çš„æ°´é‡ä½¿ç”¨å‡½æ•°
        // æ°´è¢‹ï¼šæ¯æ ¼20å•ä½ï¼Œæœ¨æ¡¶ï¼šæ¯æ ¼50å•ä½ï¼Œæ¯æ¬¡ä½¿ç”¨1æ ¼æ°´
        const waterAmount = feedId.includes('bucket') ? 50 : 20;
        const result = useWaterFromContainer(feedId, waterAmount);

        if (result.success) {
          // å£æ¸´åº¦å¢åŠ é‡ä¸ä½¿ç”¨çš„æ°´é‡å•ä½æ•°åŒ¹é…ï¼ˆæ°´è¢‹ï¼š1æ ¼=20å•ä½=20å£æ¸´åº¦ï¼Œæœ¨æ¡¶ï¼š1æ ¼=50å•ä½=50å£æ¸´åº¦ï¼‰
          const thirstIncrease = waterAmount; // ä½¿ç”¨ä¸æ ¼å­æ•°åŒ¹é…çš„å£æ¸´åº¦å¢åŠ é‡
          stall.thirst = Math.min(100, stall.thirst + thirstIncrease);
          stall.lastFedDay = gameData.day;

          // æ›´æ–°å¡ç‰Œæ˜¾ç¤º
          updateResourceCard(feedId);

          // æ·»åŠ å–‚æ°´åŠ¨ç”»æ•ˆæœ
          if (stallElement) {
            stallElement.classList.add('water-animation');

            // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
            if (!window.createWaterEffect || !window.createWaterFloatingText) {
              if (typeof initializeAnimationCSS === 'function') {
                initializeAnimationCSS();
              }
              if (typeof initializeAnimationEffects === 'function') {
                initializeAnimationEffects();
              }
            }

            // ä½¿ç”¨ç»Ÿä¸€çš„æ°´æ³¢çº¹ç‰¹æ•ˆå‡½æ•°ï¼ˆåŒ…æ‹¬æ°´æ³¢çº¹ã€æ°´æ»´ã€æ°´èŠ±æº…å°„ç­‰ï¼‰
            if (window.createWaterEffect) {
              window.createWaterEffect(stallElement);
              console.log('æ°´æ³¢çº¹ç‰¹æ•ˆå·²è§¦å‘');
            } else {
              console.warn('createWaterEffectå‡½æ•°æœªå®šä¹‰ï¼');
            }

            // ä½¿ç”¨ç»Ÿä¸€çš„æµ‡æ°´æ¼‚æµ®æ–‡å­—å‡½æ•°
            if (window.createWaterFloatingText) {
              window.createWaterFloatingText(stallElement);
            }

            // 1500msåç§»é™¤åŠ¨ç”»CSSç±»
            setTimeout(() => {
              stallElement.classList.remove('water-animation');
            }, 1500);

            // 2000msåæ›´æ–°æ˜¾ç¤ºï¼ˆç¡®ä¿æ‰€æœ‰ç‰¹æ•ˆæ’­æ”¾å®Œæˆï¼‰
            setTimeout(() => {
              updateStableStallDisplay(stallElement, stall, stallIndex);
            }, 2000);
          }
          
          const remainingWater = getContainerTotalWater(feedId);
          const maxWaterLevel = feedId.includes('bucket') ? 250 : 100;
          const remainingGrids = Math.floor(remainingWater / (feedId.includes('bucket') ? 50 : 20));
          let message = `ä½ ç”¨${waterSourceName}å–‚äº†${horseData.name}ï¼Œå£æ¸´åº¦å¢åŠ ${thirstIncrease}ç‚¹ï¼å‰©ä½™: ${remainingGrids}æ ¼ï¼ˆ${remainingWater}/${maxWaterLevel}ï¼‰`;
          if (result.containerDestroyed) {
            message += ' ' + result.message;
          }
          showNotification('å–‚æ°´æˆåŠŸ', message);

          // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
          updateContainerImage(feedId);

          // æ›´æ–°é©¬å©é¥²æ–™å¡ç‰Œæ˜¾ç¤º
          if (window.updateFeedCards) {
            window.updateFeedCards();
          }

          // æ›´æ–°èƒŒåŒ…æ æ˜¾ç¤º
          renderResources();
        } else {
          showNotification('å–‚æ°´å¤±è´¥', result.message);
        }
      }

      // æ›´æ–°æ˜¾ç¤º
      updateStableStallDisplay(stallElement, stall, stallIndex);
      
      // æ›´æ–°å·¦ä¾§é¥²æ–™å¡ç‰Œæ˜¾ç¤º
      updateFeedCards();
      
      updateGameData();
    }

    // æ¸…ç†é©¬å©æ 
    window.cleanStableStall = function(stallIndex) {
      const stableData = gameData.stableData;
      const stall = stableData.stalls[stallIndex];
      const horseData = stableData.horses[stall.horse];
      
      // æ¸…æ´é©¬å©æ 
      stall.cleanliness = 0;
      stall.lastCleanedDay = gameData.day;
      
      // æ¸…ç†å¯ä»¥æ¢å¤å¥åº·å€¼
      stall.health = Math.min(horseData.maxHealth, stall.health + 30);
      
      // è·å¾—è‚¥æ–™
      const fertilizerAmount = 2;
      if (!gameData.resources.fertilizer) {
        gameData.resources.fertilizer = { name: 'è‚¥æ–™', description: 'å¯ç”¨äºæ–½è‚¥æˆ–äº¤æ˜“', amount: 0, image: 'UI/è‚¥æ–™.jpg', category: 'material' };
      }
      gameData.resources.fertilizer.amount += fertilizerAmount;
      
      showNotification('æ¸…ç†æˆåŠŸ', `ä½ æ¸…ç†äº†é©¬å©æ ï¼Œè·å¾—äº†${fertilizerAmount}ä¸ªè‚¥æ–™ï¼Œå¥åº·å€¼å¢åŠ 30ç‚¹ï¼`);
      
      // æ›´æ–°æ˜¾ç¤º
      const stallElement = document.querySelector(`.stable-stall[data-stall-index="${stallIndex}"]`);
      updateStableStallDisplay(stallElement, stall, stallIndex);
      
      renderResources();
      updateGameData();
    }

    // é€šç”¨çš„æ‰«å¸šæ¸…æ´å‡½æ•°
    function cleanStallWithBroomCommon(stallIndex, stallType) {
      const isStable = stallType === 'stable';
      const data = isStable ? gameData.stableData : gameData.livestockData;
      const stall = data.stalls[stallIndex];
      const locationName = isStable ? 'é©¬å©æ ' : 'ç‰²å£æ ';

      // æ£€æŸ¥æ‰«å¸šæ˜¯å¦å­˜åœ¨ä¸”æœ‰è¶³å¤Ÿè€ä¹…åº¦
      if (!gameData.resources.broom || gameData.resources.broom.amount <= 0) {
        showNotification('æ‰«å¸šä¸è¶³', 'ä½ æ²¡æœ‰æ‰«å¸šï¼');
        return;
      }

      if (gameData.resources.broom.durability <= 0) {
        showNotification('æ‰«å¸šå·²æŸå', 'æ‰«å¸šå·²æŸåï¼Œéœ€è¦æ›´æ¢ï¼');
        return;
      }

      // æ¶ˆè€—æ‰«å¸šè€ä¹…åº¦ï¼ˆæ¯æ¬¡æ¶ˆè€—10è€ä¹…åº¦ï¼‰
      gameData.resources.broom.durability -= 10;

      // å‡å°‘æ±¡æµŠåº¦ï¼ˆæ¯æ¬¡å‡å°‘50æ±¡æµŠåº¦ï¼‰
      stall.cleanliness = Math.max(0, stall.cleanliness - 50);

      // è·å¾—è‚¥æ–™
      const fertilizerAmount = 1;
      if (!gameData.resources.fertilizer) {
        gameData.resources.fertilizer = { name: 'è‚¥æ–™', description: 'å¯ç”¨äºæ–½è‚¥æˆ–äº¤æ˜“', amount: 0, image: 'UI/è‚¥æ–™.jpg', category: 'material' };
      }
      gameData.resources.fertilizer.amount += fertilizerAmount;

      // å¦‚æœæ‰«å¸šè€ä¹…åº¦ä¸º0ï¼Œè‡ªåŠ¨é”€æ¯
      if (gameData.resources.broom.durability <= 0) {
        gameData.resources.broom.amount = 0;
        showNotification('æ‰«å¸šæŸå', `ä½ ä½¿ç”¨æ‰«å¸šæ¸…æ´äº†${locationName}ï¼Œè·å¾—äº†${fertilizerAmount}ä¸ªè‚¥æ–™ï¼Œä½†æ‰«å¸šå·²æŸåï¼`);
      } else {
        showNotification('æ¸…æ´æˆåŠŸ', `ä½ ä½¿ç”¨æ‰«å¸šæ¸…æ´äº†${locationName}ï¼Œè·å¾—äº†${fertilizerAmount}ä¸ªè‚¥æ–™ï¼Œæ‰«å¸šè€ä¹…åº¦å‰©ä½™${gameData.resources.broom.durability}ï¼`);
      }

      // æ›´æ–°æ˜¾ç¤º
      const stallSelector = isStable ? `.stable-stall[data-stall-index="${stallIndex}"]` : `[data-stall-index="${stallIndex}"]`;
      const stallElement = document.querySelector(stallSelector);
      if (stallElement) {
        if (isStable) {
          updateStableStallDisplay(stallElement, stall, stallIndex);
        } else {
          updateStallDisplay(stallElement, stall, stallIndex);
        }
      }

      // æ›´æ–°å·¦ä¾§æ‰«å¸šå¡ç‰Œæ˜¾ç¤º
      if (isStable) {
        updateFeedCards();
      } else {
        updateFeedDisplay();
      }

      renderResources();
      updateGameData();
    }

    // ç”¨æ‰«å¸šæ¸…æ´ç‰²å£æ 
    window.cleanStallWithBroom = function(stallIndex) {
      cleanStallWithBroomCommon(stallIndex, 'livestock');
    }

    // ç”¨æ‰«å¸šæ¸…æ´é©¬å©æ 
    window.cleanStableStallWithBroom = function(stallIndex) {
      cleanStallWithBroomCommon(stallIndex, 'stable');
    }

    // æ›´æ–°æ‰€æœ‰ç‰²å£æ çš„æ˜¾ç¤º
    function updateAllLivestockStallDisplays() {
      if (!gameData.livestockData) return;
      
      const stalls = document.querySelectorAll('[data-stall-index]');
      stalls.forEach(stall => {
        const stallIndex = parseInt(stall.dataset.stallIndex);
        const stallData = gameData.livestockData.stalls[stallIndex];
        if (stallData && stallData.animal) {
          updateStallDisplay(stall, stallData, stallIndex);
        }
      });
    }

    // æ›´æ–°æ‰€æœ‰é©¬å©æ çš„æ˜¾ç¤º
    function updateAllStableStallDisplays() {
      if (!gameData.stableData) return;
      
      const stalls = document.querySelectorAll('.stable-stall[data-stall-index]');
      stalls.forEach(stall => {
        const stallIndex = parseInt(stall.dataset.stallIndex);
        const stallData = gameData.stableData.stalls[stallIndex];
        if (stallData && stallData.horse) {
          updateStableStallDisplay(stall, stallData, stallIndex);
        }
      });
    }

    // éšè—é©¬å©å·¥å…·æç¤º
    window.hideStableTooltip = function() {
      const tooltip = document.getElementById('stable-tooltip');
      if (tooltip) {
        tooltip.remove();
      }
    }

    // æ›´æ–°é©¬åŒ¹å¡ç‰Œæ˜¾ç¤º
    window.updateHorseCards = function() {
      const horseContainer = document.querySelector('.stable-inventory');
      if (!horseContainer) return;
      
      horseContainer.innerHTML = '';
      
      const horseIds = ['native_horse', 'mongolian_horse', 'hequ_horse', 'ferghana_horse', 'super_ferghana_horse'];
      horseIds.forEach(horseId => {
        const horseAmount = gameData.resources[horseId]?.amount || 0;
        if (horseAmount > 0) {
          const horseCard = createHorseCard(horseId, gameData.stableData.horses[horseId]);
          horseContainer.appendChild(horseCard);
        }
      });
    }

    // æ›´æ–°é¥²æ–™å¡ç‰Œæ˜¾ç¤º
    window.updateFeedCards = function() {
      const feedContainers = document.querySelectorAll('.stable-inventory');
      if (feedContainers.length === 0) return;

      feedContainers.forEach(container => {
        if (container.querySelector('.stable-feed-card')) {
          container.innerHTML = '';

          const feedIds = ['grass_feed', 'pill', 'bucket', 'water_bag', 'water_bag_full', 'empty_water_bag', 'broom', 'fertilizer'];
          feedIds.forEach(feedId => {
            const resource = gameData.resources[feedId];
            if (!resource) return;

            // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ°´æˆ–æ•°é‡å¤§äº0
            const isWaterContainer = (feedId === 'bucket' || feedId === 'water_bag' || feedId === 'water_bag_full' || feedId === 'empty_water_bag');
            let shouldDisplay = false;
            if (isWaterContainer) {
              // æ£€æŸ¥æ˜¯å¦æœ‰æ°´æˆ–æ•°é‡å¤§äº0
              let hasWater = false;
              if (resource.waterLevel !== undefined && resource.waterLevel > 0) {
                hasWater = true;
              }
              if (resource.instances && resource.instances.length > 0) {
                hasWater = resource.instances.some(inst => inst.waterLevel > 0);
              }
              shouldDisplay = hasWater || (resource.amount > 0);
            } else {
              // å…¶ä»–ç‰©å“ï¼Œåªæ£€æŸ¥æ•°é‡
              shouldDisplay = resource.amount > 0;
            }

            if (shouldDisplay) {
              // å¦‚æœæ˜¯æ‰«å¸šï¼Œåˆ›å»ºç‰¹æ®Šçš„æ‰«å¸šå¡ç‰Œ
              if (feedId === 'broom') {
                const broomCard = createBroomCard(feedId, gameData.resources[feedId]);
                broomCard.style.width = '100px';
                broomCard.style.height = '120px';
                broomCard.style.margin = '0.25rem';
                container.appendChild(broomCard);
              } else {
                const feedCard = createFeedCard(feedId);
                container.appendChild(feedCard);
              }
            }
          });
        }
      });
    }

    // æ¯æ—¥æ›´æ–°é©¬å©çŠ¶æ€
    window.updateStableDaily = function() {
      if (!gameData.stableData) return;
      
      const stableData = gameData.stableData;
      const currentDay = gameData.day;
      
      stableData.stalls.forEach((stall, index) => {
        if (stall.horse) {
          const horseData = stableData.horses[stall.horse];
          
          // é¥±é£Ÿåº¦æ¯å¤©ä¸‹é™10ç‚¹
          stall.satiety = Math.max(0, stall.satiety - 10);
          
          // å£æ¸´åº¦æ¯å¤©ä¸‹é™10ç‚¹
          stall.thirst = Math.max(0, stall.thirst - 10);
          
          // æ±¡æµŠåº¦éšæ—¶é—´å¢åŠ 
          stall.cleanliness = Math.min(100, stall.cleanliness + horseData.dailyCleanlinessIncrease);
          
          // å¥åº·å€¼éšç€æ±¡æµŠåº¦å¢åŠ è€Œé™ä½
          // æ±¡æµŠåº¦è¶Šé«˜ï¼Œå¥åº·å€¼é™ä½è¶Šå¤š
          const healthLossFromCleanliness = Math.floor(stall.cleanliness / 20); // æ¯å¢åŠ 20æ±¡æµŠåº¦ï¼Œå¥åº·å€¼å‡å°‘1ç‚¹
          stall.health = Math.max(0, stall.health - healthLossFromCleanliness);
          
          // é¥±é£Ÿåº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼
          if (stall.satiety < 20) {
            stall.health = Math.max(0, stall.health - 2);
          }
          
          // å£æ¸´åº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼
          if (stall.thirst < 20) {
            stall.health = Math.max(0, stall.health - 2);
          }
          
          // æ›´æ–°æ˜¾ç¤º
          const stallElement = document.querySelector(`.stable-stall[data-stall-index="${index}"]`);
          updateStableStallDisplay(stallElement, stall, index);
        }
      });
      
      // æ›´æ–°æ‰€æœ‰é©¬å©æ çš„æ˜¾ç¤ºï¼ˆç¡®ä¿é¥±é£Ÿåº¦å˜åŒ–èƒ½è¢«çœ‹åˆ°ï¼‰
      stableData.stalls.forEach((stall, index) => {
        const stallElement = document.querySelector(`.stable-stall[data-stall-index="${index}"]`);
        if (stallElement) {
          updateStableStallDisplay(stallElement, stall, index);
        }
      });
      
      updateGameData();
    }

    // æ¯æ—¥æ›´æ–°ç‰²å£æ£šçŠ¶æ€
    window.updateLivestockDaily = function() {
      if (!gameData.livestockData) return;
      
      const livestockData = gameData.livestockData;
      
      livestockData.stalls.forEach((stall, index) => {
        if (!stall.animal) return; // ç©ºæ è·³è¿‡
        
        const animalData = livestockData.animals[stall.animal];
        const currentDay = gameData.day || 1;
        
        // é¥±é£Ÿåº¦æ¯å¤©ä¸‹é™10ç‚¹
        stall.satiety = Math.max(0, stall.satiety - 10);
        
        // å£æ¸´åº¦æ¯å¤©ä¸‹é™10ç‚¹
        stall.thirst = Math.max(0, stall.thirst - 10);
        
        // æ£€æŸ¥åŠ¨ç‰©æˆé•¿
        if (stall.growthStage === 1) { // å¹¼å¹´æœŸ
          let growthDays = animalData.growthTime;
          
          // å¦‚æœæœ‰å¿«é€Ÿç”Ÿé•¿çŠ¶æ€ï¼Œæˆé•¿æ—¶é—´å‡åŠ
          if (stall.specialState === 'fast_growth') {
            growthDays = Math.ceil(growthDays / 2);
          }
          
          // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æˆå¹´æœŸ
          if (stall.startDay && gameData.day - stall.startDay >= growthDays) {
            stall.growthStage = 2; // è¿›å…¥æˆå¹´æœŸ
            showNotification('åŠ¨ç‰©é•¿å¤§', `${animalData.name}å·²ç»æˆå¹´äº†ï¼`);
            
            // æ›´æ–°æ˜¾ç¤º
            const stallElement = document.querySelector(`[data-stall-index="${index}"]`);
            if (stallElement) {
              updateStallDisplay(stallElement, stall, index);
            }
          }
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å–‚å…»
        if (stall.lastFedDay && gameData.day - stall.lastFedDay > 2) {
          // è¶…è¿‡2å¤©æ²¡æœ‰å–‚å…»ï¼Œé¥±é£Ÿåº¦æŒç»­ä¸‹é™åˆ°0
          stall.satiety = Math.max(0, stall.satiety - 10 * (gameData.day - stall.lastFedDay - 2));
        }
        
        // å¢åŠ æ±¡æµŠåº¦
        stall.cleanliness = Math.min(100, stall.cleanliness + 10);
        
        // æ±¡æµŠåº¦å¢åŠ å¯¼è‡´å¥åº·å€¼ä¸‹é™
        const healthLossFromCleanliness = Math.floor(stall.cleanliness / 20); // æ¯å¢åŠ 20æ±¡æµŠåº¦ï¼Œå¥åº·å€¼å‡å°‘1ç‚¹
        stall.health = Math.max(0, stall.health - healthLossFromCleanliness);
        
        // é¥±é£Ÿåº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼
        if (stall.satiety < 20) {
          stall.health = Math.max(0, stall.health - 2);
        }
        
        // å£æ¸´åº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼
        if (stall.thirst < 20) {
          stall.health = Math.max(0, stall.health - 2);
        }
        
        // å¥åº·å€¼å½±å“ç”Ÿäº§æ•ˆç‡
        if (stall.health <= 30) {
          stall.productivity = Math.max(10, stall.productivity - 15);
          if (stall.growthStage === 2) {
            showNotification('åŠ¨ç‰©ç”Ÿç—…', `${animalData.name}ç”Ÿç—…äº†ï¼Œéœ€è¦è¯ä¸¸æ²»ç–—ï¼`);
          }
        } else if (stall.health < 70) {
          stall.productivity = Math.max(30, stall.productivity - 5);
        }
        
        // å¦‚æœå¥åº·å€¼é™åˆ°0ï¼ŒåŠ¨ç‰©æ­»äº¡
        if (stall.health <= 0) {
          showNotification('åŠ¨ç‰©æ­»äº¡', `${animalData.name}å› ä¸ºå¥åº·å€¼è¿‡ä½è€Œæ­»äº¡äº†ï¼`);
          stall.animal = null;
          stall.growthStage = 0;
          stall.health = 70;
          stall.productivity = 70;
          stall.cleanliness = 0;
          stall.satiety = 100;
          stall.startDay = null;
          stall.lastFedDay = null;
          stall.lastProducedDay = null;
          stall.produceCount = 0;
          stall.specialState = null;
          
          // æ›´æ–°æ˜¾ç¤º
          const stallElement = document.querySelector(`[data-stall-index="${index}"]`);
          if (stallElement) {
            updateStallDisplay(stallElement, stall, index);
          }
        }
        
        // æˆå¹´åŠ¨ç‰©äº§è›‹ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
        if (stall.growthStage === 2 && animalData.product === 'egg' && stall.lastProducedDay !== gameData.day) {
          let lastProducedDay = stall.lastProducedDay || stall.startDay;
          
          // æ£€æŸ¥æ˜¯å¦å¯ä»¥äº§è›‹ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
          if (gameData.day > lastProducedDay) {
            // è®¡ç®—äº§è›‹æ•°é‡ï¼ˆå—å¥åº·å€¼å’Œç”Ÿäº§æ•ˆç‡å½±å“ï¼‰
            let eggCount = 1;
            
            // å¥åº·å€¼å½±å“
            if (stall.health >= 70) {
              eggCount += 1; // å¥åº·å€¼é«˜ï¼Œå¤šä¸€ä¸ªè›‹
            } else if (stall.health <= 30) {
              // å¥åº·å€¼ä½ï¼Œæœ‰æ¦‚ç‡ä¸ä¸‹è›‹
              if (Math.random() > 0.5) {
                eggCount = 0;
              }
            }
            
            // ç”Ÿäº§æ•ˆç‡å½±å“
            if (stall.productivity >= 70) {
              eggCount = Math.floor(eggCount * 1.5);
            } else if (stall.productivity <= 30) {
              eggCount = Math.max(1, Math.floor(eggCount * 0.7));
            }
            
            // ç‰¹æ®ŠçŠ¶æ€å½±å“
            if (stall.specialState === 'high_production') {
              eggCount = Math.floor(eggCount * 1.5);
            }
            
            // æ›´æ–°äº§è›‹æ•°æ®
            stall.lastProducedDay = currentDay;
            stall.produceCount += 1;
            
            // å¦‚æœæœ‰è›‹ï¼Œæ›´æ–°æ˜¾ç¤º
            if (eggCount > 0) {
              const stallElement = document.querySelector(`[data-stall-index="${index}"]`);
              if (stallElement) {
                updateStallDisplay(stallElement, stall, index);
              }
            }
          }
        }
      });
      
      // æ›´æ–°æ‰€æœ‰ç‰²å£æ çš„æ˜¾ç¤ºï¼ˆç¡®ä¿é¥±é£Ÿåº¦å˜åŒ–èƒ½è¢«çœ‹åˆ°ï¼‰
      if (gameData.livestockData && gameData.livestockData.stalls) {
        gameData.livestockData.stalls.forEach((stall, index) => {
          const stallElement = document.querySelector(`[data-stall-index="${index}"]`);
          if (stallElement) {
            updateStallDisplay(stallElement, stall, index);
          }
        });
      }
      
      // ä¿å­˜æ›´æ–°åçš„æ•°æ®
      updateGameData();
    }

    // æ›´æ–°ç‰²å£æ çš„æ—¶é—´æ®µé¥±é£Ÿåº¦æ¶ˆè€—
    window.updateLivestockTimePeriod = function() {
      if (!gameData.livestockData) return;

      const livestockData = gameData.livestockData;

      // æ¯ä¸ªæ—¶é—´æ®µæ¶ˆè€—2ç‚¹é¥±é£Ÿåº¦
      livestockData.stalls.forEach((stall, index) => {
        if (!stall.animal) return; // ç©ºæ è·³è¿‡

        // é¥±é£Ÿåº¦éšæ—¶é—´é™ä½
        stall.satiety = Math.max(0, stall.satiety - 2);

        // æ±¡æµŠåº¦å¢åŠ å¯¼è‡´å¥åº·å€¼ä¸‹é™ï¼ˆæ±¡æµŠåº¦>50æ—¶ï¼Œæ¯ä¸ªæ—¶é—´æ®µå‡å°‘1ç‚¹ï¼‰
        if (stall.cleanliness > 50 && stall.health > 0) {
          stall.health = Math.max(0, stall.health - 1);
        }

        // é¥±é£Ÿåº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼ï¼ˆé¥±é£Ÿåº¦<20æ—¶ï¼Œæ¯ä¸ªæ—¶é—´æ®µå‡å°‘5ç‚¹ï¼‰
        if (stall.satiety < 20 && stall.health > 0) {
          stall.health = Math.max(0, stall.health - 5);
        }

        // æ¯ä¸ªæ—¶é—´æ®µæ¶ˆè€—2ç‚¹å£æ¸´åº¦
        stall.thirst = Math.max(0, stall.thirst - 2);

        // å£æ¸´åº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼ï¼ˆå£æ¸´åº¦<20æ—¶ï¼Œæ¯ä¸ªæ—¶é—´æ®µå‡å°‘5ç‚¹ï¼‰
        if (stall.thirst < 20 && stall.health > 0) {
          stall.health = Math.max(0, stall.health - 5);
        }

        // æ›´æ–°æ˜¾ç¤º
        const stallElement = document.querySelector(`[data-stall-index="${index}"]`);
        if (stallElement) {
          updateStallDisplay(stallElement, stall, index);
        }
      });

      updateGameData();
    }

    // æ›´æ–°é©¬å©æ çš„æ—¶é—´æ®µé¥±é£Ÿåº¦æ¶ˆè€—
    window.updateStableTimePeriod = function() {
      if (!gameData.stableData) return;

      const stableData = gameData.stableData;

      // æ¯ä¸ªæ—¶é—´æ®µæ¶ˆè€—2ç‚¹é¥±é£Ÿåº¦
      stableData.stalls.forEach((stall, index) => {
        if (!stall.horse) return; // ç©ºæ è·³è¿‡

        // é¥±é£Ÿåº¦éšæ—¶é—´é™ä½
        stall.satiety = Math.max(0, stall.satiety - 2);

        // æ±¡æµŠåº¦å¢åŠ å¯¼è‡´å¥åº·å€¼ä¸‹é™ï¼ˆæ±¡æµŠåº¦>50æ—¶ï¼Œæ¯ä¸ªæ—¶é—´æ®µå‡å°‘1ç‚¹ï¼‰
        if (stall.cleanliness > 50 && stall.health > 0) {
          stall.health = Math.max(0, stall.health - 1);
        }

        // é¥±é£Ÿåº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼ï¼ˆé¥±é£Ÿåº¦<20æ—¶ï¼Œæ¯ä¸ªæ—¶é—´æ®µå‡å°‘5ç‚¹ï¼‰
        if (stall.satiety < 20 && stall.health > 0) {
          stall.health = Math.max(0, stall.health - 5);
        }

        // æ¯ä¸ªæ—¶é—´æ®µæ¶ˆè€—2ç‚¹å£æ¸´åº¦
        stall.thirst = Math.max(0, stall.thirst - 2);

        // å£æ¸´åº¦è¿‡ä½ä¹Ÿä¼šå½±å“å¥åº·å€¼ï¼ˆå£æ¸´åº¦<20æ—¶ï¼Œæ¯ä¸ªæ—¶é—´æ®µå‡å°‘5ç‚¹ï¼‰
        if (stall.thirst < 20 && stall.health > 0) {
          stall.health = Math.max(0, stall.health - 5);
        }

        // æ›´æ–°æ˜¾ç¤º
        const stallElement = document.querySelector(`.stable-stall[data-stall-index="${index}"]`);
        if (stallElement) {
          updateStableStallDisplay(stallElement, stall, index);
        }
      });

      updateGameData();
    }

    // æ›´æ–°å†œç”°çŠ¶æ€ï¼ˆå†œä½œç‰©ç”Ÿé•¿ï¼‰
    window.updateFarmlandDaily = function() {
      if (!gameData.farmlandData) return;
      
      const farmlandData = gameData.farmlandData;
      const currentDay = gameData.day || 1;
      
      // æ£€æŸ¥plotsæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºé»˜è®¤æ•°æ®
      if (!farmlandData.plots) {
        farmlandData.plots = Array(9).fill(null).map((_, index) => ({
          crop: null,
          growthStage: 0,
          health: 100,
          plantDay: null,
          lastWateredDay: null
        }));
      }
      
      // æ£€æŸ¥cropsæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºé»˜è®¤æ•°æ®
      if (!farmlandData.crops) {
        farmlandData.crops = {
          corn_seed: { name: 'ç‰ç±³', growthTime: 3 },
          wheat_seed: { name: 'å°éº¦', growthTime: 3 },
          vegetable_seed: { name: 'è”¬èœ', growthTime: 2 },
          fruit_seed: { name: 'æ°´æœ', growthTime: 4 }
        };
      }
      
      // å°†farmlandDataä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä»¥ä¾¿åœ¨updatePlotDisplayä¸­ä½¿ç”¨
      window.currentFarmlandData = farmlandData;
      
      farmlandData.plots.forEach((plot, index) => {
        if (!plot.crop) return; // ç©ºåœ°å—è·³è¿‡
        
        const cropData = farmlandData.crops[plot.crop];
        
        // æ£€æŸ¥ä½œç‰©ç”Ÿé•¿
        if (plot.growthStage < 3) { // æœªæˆç†Ÿ
          let growthDays = cropData.growthTime;
          
          // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ä¸‹ä¸€ä¸ªç”Ÿé•¿é˜¶æ®µ
          if (plot.plantDay && gameData.day - plot.plantDay >= growthDays) {
            plot.growthStage += 1; // è¿›å…¥ä¸‹ä¸€ä¸ªç”Ÿé•¿é˜¶æ®µ
            
            // æ›´æ–°æ˜¾ç¤º
            const plotElement = document.querySelector(`[data-plot-index="${index}"]`);
            if (plotElement) {
              window.updatePlotDisplay(plotElement, plot, index);
            }
            
            // å¦‚æœä½œç‰©æˆç†Ÿ
            if (plot.growthStage === 3) {
              showNotification('ä½œç‰©æˆç†Ÿ', `${cropData.name}å·²ç»æˆç†Ÿå¯ä»¥æ”¶è·äº†ï¼`);
            }
          }
        }
        
        // æ£€æŸ¥ä½œç‰©å¥åº·çŠ¶æ€
        if (plot.lastWateredDay && gameData.day - plot.lastWateredDay > 2) {
          // è¶…è¿‡2å¤©æ²¡æœ‰æµ‡æ°´ï¼Œå¥åº·å€¼ä¸‹é™
          plot.health = Math.max(0, plot.health - 15 * (gameData.day - plot.lastWateredDay - 2));
          
          if (plot.health <= 0) {
            // ä½œç‰©æ­»äº¡
            plot.crop = null;
            plot.growthStage = 0;
            plot.health = 100;
            showNotification('ä½œç‰©æ¯è', `ä¸€å—åœ°é‡Œçš„ä½œç‰©å› ä¸ºæ²¡æœ‰æµ‡æ°´è€Œæ¯èäº†ã€‚`);
            
            // æ›´æ–°æ˜¾ç¤º
            const plotElement = document.querySelector(`[data-plot-index="${index}"]`);
            if (plotElement) {
              window.updatePlotDisplay(plotElement, plot, index);
            }
          } else if (plot.health <= 30) {
            showNotification('ä½œç‰©ç¼ºæ°´', `ä¸€å—åœ°é‡Œçš„ä½œç‰©ä¸¥é‡ç¼ºæ°´ï¼Œå¥åº·çŠ¶æ€ä¸ä½³ï¼`);
          }
        }
      });
      
      // æ›´æ–°æ‰€æœ‰ç‰²å£æ çš„æ˜¾ç¤ºï¼ˆç¡®ä¿é¥±é£Ÿåº¦å˜åŒ–èƒ½è¢«çœ‹åˆ°ï¼‰
      if (gameData.livestockData && gameData.livestockData.stalls) {
        gameData.livestockData.stalls.forEach((stall, index) => {
          const stallElement = document.querySelector(`[data-stall-index="${index}"]`);
          if (stallElement) {
            updateStallDisplay(stallElement, stall, index);
          }
        });
      }
      
      // ä¿å­˜æ›´æ–°åçš„æ•°æ®
      updateGameData();
    }

    // æ›´æ–°åœ°å—æ˜¾ç¤º
    window.updatePlotDisplay = function(plotElement, plot, index) {
      if (!plotElement) return;
      
      plotElement.innerHTML = '';
      plotElement.className = 'farmland-plot';
      plotElement.setAttribute('data-plot-index', index);
      
      if (plot.crop && window.currentFarmlandData && window.currentFarmlandData.crops) {
        const cropData = window.currentFarmlandData.crops[plot.crop];
        if (cropData) {
          // æ˜¾ç¤ºä½œç‰©
          const cropElement = document.createElement('div');
          cropElement.className = 'crop-display';
          cropElement.textContent = `${cropData.name} (${plot.growthStage}/3)`;
          
          // æ ¹æ®ç”Ÿé•¿é˜¶æ®µè®¾ç½®èƒŒæ™¯è‰²
          if (plot.growthStage === 1) {
            cropElement.style.backgroundColor = '#90EE90'; // æµ…ç»¿è‰²
          } else if (plot.growthStage === 2) {
            cropElement.style.backgroundColor = '#228B22'; // æ·±ç»¿è‰²
          } else if (plot.growthStage === 3) {
            cropElement.style.backgroundColor = '#FFD700'; // é‡‘é»„è‰²ï¼ˆæˆç†Ÿï¼‰
          }
          
          // è®¾ç½®å¥åº·çŠ¶æ€
          if (plot.health < 30) {
            cropElement.style.border = '2px solid red';
          } else if (plot.health < 70) {
            cropElement.style.border = '2px solid yellow';
          } else {
            cropElement.style.border = '2px solid green';
          }
          
          plotElement.appendChild(cropElement);
        }
      } else {
        // ç©ºåœ°å—
        plotElement.innerHTML = '<div class="empty-plot">ç©ºåœ°å—</div>';
      }
    }

    // æ”¶è·è›‹
    window.collectEgg = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];
      
      if (!stall.animal || stall.growthStage !== 2) {
        showNotification('æ— æ³•æ”¶è·', 'åªæœ‰æˆå¹´æœŸçš„é¸¡å’Œé¸­æ‰èƒ½æ”¶è·è›‹ï¼');
        return;
      }
      
      const animalData = livestockData.animals[stall.animal];
      if (animalData.product !== 'egg') {
        showNotification('æ— æ³•æ”¶è·', 'è¿™ç§åŠ¨ç‰©ä¸äº§è›‹ï¼');
        return;
      }
      
      // åˆ›å»ºæ”¶è·åŠ¨ç”»
      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
      const eggIndicator = stallElement.querySelector('.livestock-egg-indicator');
      
      // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
      if (eggIndicator) {
        eggIndicator.style.transform = 'scale(1.2)';
        eggIndicator.style.backgroundColor = '#48BB78';
        
        setTimeout(() => {
          eggIndicator.style.transform = 'scale(0.95)';
        }, 150);
      }
      
      // æ ¹æ®å¥åº·çŠ¶æ€å’Œç”Ÿäº§æ•ˆç‡è®¡ç®—è›‹çš„æ•°é‡ï¼ˆ1-3ä¸ªï¼‰
      let eggCount = 1; // åŸºç¡€äº§é‡
      
      // å¥åº·å€¼å½±å“
      if (stall.health >= 80) {
        eggCount = 3; // é«˜å¥åº·å€¼ï¼Œ3ä¸ªè›‹
      } else if (stall.health >= 50) {
        eggCount = 2; // ä¸­ç­‰å¥åº·å€¼ï¼Œ2ä¸ªè›‹
      } else if (stall.health <= 30) {
        // ä½å¥åº·å€¼ï¼Œæœ‰å‡ ç‡å¤±è´¥
        if (Math.random() > 0.7) {
          showNotification('æ”¶è·å¤±è´¥', 'åŠ¨ç‰©å¥åº·å€¼å¤ªä½ï¼Œæœªèƒ½äº§è›‹ï¼');
          if (eggIndicator) {
            eggIndicator.style.transform = 'scale(1)';
            eggIndicator.style.backgroundColor = '#E53E3E';
          }
          return;
        }
      }
      
      // ç”Ÿäº§æ•ˆç‡è°ƒæ•´ï¼ˆæœ€é«˜ä¸è¶…è¿‡3ä¸ªï¼‰
      if (stall.productivity >= 80) {
        eggCount = Math.min(3, eggCount + 1); // é«˜ç”Ÿäº§æ•ˆç‡+1è›‹
      } else if (stall.productivity <= 30) {
        eggCount = Math.max(1, eggCount - 1); // ä½ç”Ÿäº§æ•ˆç‡-1è›‹
      }
      
      // ç‰¹æ®ŠçŠ¶æ€å½±å“
      if (stall.specialState === 'high_production') {
        eggCount = Math.min(3, eggCount + 1); // é«˜äº§çŠ¶æ€+1è›‹
      }
      
      // æ·»åŠ è›‹åˆ°èµ„æº
      if (!gameData.resources.egg) {
        gameData.resources.egg = {
          name: 'è›‹',
          description: 'é¸¡æˆ–é¸­äº§ä¸‹çš„è›‹ï¼Œè¥å…»ä¸°å¯Œ',
          amount: 0,
          image: 'UI/è›‹.jpg',
          category: 'food'
        };
      }
      
      gameData.resources.egg.amount += eggCount;
      
      // é‡ç½®äº§è›‹çŠ¶æ€
      stall.lastProducedDay = gameData.day || 1;
      stall.produceCount = 0; // é‡ç½®äº§è›‹è®¡æ•°
      
      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      if (stallElement) {
        updateStallDisplay(stallElement, stall, stallIndex);
        
        // åˆ›å»ºæ”¶è·ç‰¹æ•ˆ
        createHarvestEffect(stallElement, eggCount);
      }
      
      // æ ¹æ®è›‹çš„æ•°é‡æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
      let harvestMessage = `ä½ æ”¶è·äº†${eggCount}ä¸ªè›‹ï¼`;
      if (eggCount === 3) {
        harvestMessage = `å¤ªæ£’äº†ï¼ä½ æ”¶è·äº†${eggCount}ä¸ªè›‹ï¼è¿™åªåŠ¨ç‰©çŠ¶æ€éå¸¸å¥½ï¼`;
      } else if (eggCount === 1 && stall.health < 50) {
        harvestMessage = `åªæ”¶è·äº†${eggCount}ä¸ªè›‹ã€‚åŠ¨ç‰©çš„å¥åº·çŠ¶å†µä¸å¤ªå¥½ï¼Œè®°å¾—ç…§æ–™å®ƒã€‚`;
      }
      
      showNotification('æ”¶è·æˆåŠŸ', harvestMessage);
      updateGameData();
    }
    
    // åˆ›å»ºæ”¶è·ç‰¹æ•ˆ
    function createHarvestEffect(stallElement, eggCount) {
      // åˆ›å»ºè›‹å›¾æ ‡é£æ•£æ•ˆæœ
      for (let i = 0; i < eggCount; i++) {
        setTimeout(() => {
          const egg = document.createElement('div');
          egg.innerHTML = 'ğŸ¥š';
          egg.style.position = 'absolute';
          egg.style.fontSize = '20px';
          egg.style.zIndex = '100';
          
          // è·å–è›‹æŒ‡ç¤ºå™¨çš„ä½ç½®ä½œä¸ºèµ·ç‚¹
          const eggIndicator = stallElement.querySelector('.livestock-egg-indicator');
          const rect = stallElement.getBoundingClientRect();
          
          egg.style.left = `${rect.right - 30}px`;
          egg.style.top = `${rect.top + 10}px`;
          egg.style.transition = 'all 1s ease-out';
          
          document.body.appendChild(egg);
          
          // é£å‘èµ„æºåŒºåŸŸ
          setTimeout(() => {
            const resourceGrid = document.querySelector('.resource-grid');
            if (resourceGrid) {
              const resourceRect = resourceGrid.getBoundingClientRect();
              egg.style.left = `${resourceRect.left + Math.random() * resourceRect.width}px`;
              egg.style.top = `${resourceRect.top + Math.random() * resourceRect.height}px`;
              egg.style.opacity = '0';
              egg.style.transform = 'scale(1.5)';
            }
          }, 100);
          
          // ç§»é™¤å…ƒç´ 
          setTimeout(() => {
            if (egg.parentNode) {
              egg.parentNode.removeChild(egg);
            }
          }, 1100);
        }, i * 200); // æ¯ä¸ªè›‹é—´éš”200ms
      }
    }

    // æ”¶è·æˆå¹´åŠ¨ç‰©
    window.harvestAnimal = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];
      
      if (!stall.animal || stall.growthStage !== 2) {
        showNotification('æ— æ³•æ”¶è·', 'åªæœ‰æˆå¹´æœŸçš„åŠ¨ç‰©æ‰èƒ½æ”¶è·ï¼');
        return;
      }
      
      const animalData = livestockData.animals[stall.animal];
      
      // è·å¾—å¯¹åº”çš„æˆå¹´åŠ¨ç‰©äº§ç‰©
      let productId = stall.animal === 'chick' ? 'chicken' : 
                    (stall.animal === 'duckling' ? 'duck' : 'pork');
      
      // æ·»åŠ äº§ç‰©åˆ°èµ„æº
      if (gameData.resources[productId]) {
        gameData.resources[productId].amount += 1;
      }
      
      // æ ¹æ®æ±¡æµŠåº¦è·å¾—è‚¥æ–™
      const fertilizerAmount = Math.floor(stall.cleanliness / 50) + animalData.fertilityBonus;
      if (gameData.resources.fertilizer) {
        gameData.resources.fertilizer.amount += fertilizerAmount;
      }
      
      // æ·»åŠ é¢å¤–å¥–åŠ±
      let extraRewards = [];
      
      // æ ¹æ®åŠ¨ç‰©å¥åº·åº¦å’Œç”Ÿäº§åŠ›ç»™äºˆé¢å¤–å¥–åŠ±
      if (stall.health > 80 && stall.productivity > 80) {
        // é«˜å“è´¨åŠ¨ç‰©å¥–åŠ±
        extraRewards.push('é¢å¤–2ä¸ªåŠ¨ç‰©äº§å“');
        if (gameData.resources[productId]) {
          gameData.resources[productId].amount += 2;
        }
      }
      
      // ç‰¹æ®ŠçŠ¶æ€å¥–åŠ±
      if (stall.specialState === 'high_production') {
        extraRewards.push('é«˜äº§å¥–åŠ±ï¼š1ä¸ªé¢å¤–äº§å“å’Œ3ä¸ªè‚¥æ–™');
        if (gameData.resources[productId]) {
          gameData.resources[productId].amount += 1;
        }
        if (gameData.resources.fertilizer) {
          gameData.resources.fertilizer.amount += 3;
        }
      }
      
      // æ ¹æ®åŠ¨ç‰©ç±»å‹ç»™äºˆç‰¹æ®Šå¥–åŠ±
      if (stall.animal === 'chick' || stall.animal === 'duckling') {
        // ç¦½ç±»æœ‰å‡ ç‡é¢å¤–è·å¾—è›‹
        if (Math.random() < 0.3) { // 30%æ¦‚ç‡
          const eggId = stall.animal === 'chick' ? 'egg' : 'egg';
          extraRewards.push('å¹¸è¿æ‰è½ï¼š1ä¸ªè›‹');
          if (gameData.resources.egg) {
            gameData.resources.egg.amount += 1;
          }
        }
      }
      
      // æ¸…ç©ºç‰²å£æ 
      stall.animal = null;
      stall.growthStage = 0;
      stall.health = 70;
      stall.productivity = 70;
      stall.cleanliness = 0;
      stall.startDay = null;
      stall.lastFedDay = null;
      stall.lastProducedDay = null;
      stall.produceCount = 0;
      stall.specialState = null;
      
      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
      if (stallElement) {
        updateStallDisplay(stallElement, stall, stallIndex);
      }
      
      // æ˜¾ç¤ºæ”¶è·ä¿¡æ¯å’Œé¢å¤–å¥–åŠ±
      let harvestMessage = `ä½ æ”¶è·äº†1ä¸ª${animalData.name}å’Œ${fertilizerAmount}ä¸ªè‚¥æ–™ï¼`;
      if (extraRewards.length > 0) {
        harvestMessage += `\né¢å¤–å¥–åŠ±ï¼š${extraRewards.join('ï¼Œ')}`;
      }
      showNotification('æ”¶è·æˆåŠŸ', harvestMessage);
      updateGameData();
      // æ›´æ–°é©¬å©çª—å£ä¸­çš„å…»æ®–ç”¨å“å¡ç‰Œæ˜¾ç¤º
      if (window.updateStableFeedCards) {
        window.updateStableFeedCards();
      }
    }

    // æ¸…ç†ç‰²å£æ 
    window.cleanStall = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];
      
      if (stall.cleanliness < 100) {
        showNotification('æ— éœ€æ¸…ç†', 'è¿™ä¸ªç‰²å£æ è¿˜ä¸å¤Ÿè„ï¼Œæš‚æ—¶ä¸éœ€è¦æ¸…ç†ï¼');
        return;
      }
      
      // è®¡ç®—è·å¾—çš„è‚¥æ–™æ•°é‡
      const fertilizerAmount = 2; // æ¯æ¬¡æ¸…ç†å›ºå®šè·å¾—2ä¸ªè‚¥æ–™
      
      // æ·»åŠ è‚¥æ–™åˆ°èµ„æº
      if (gameData.resources.fertilizer) {
        gameData.resources.fertilizer.amount += fertilizerAmount;
      }
      
      // é‡ç½®æ±¡æµŠåº¦
      stall.cleanliness = 0;
      
      // æ¸…ç†å¯ä»¥æ¢å¤å¥åº·å€¼
      if (stall.animal) {
        stall.health = Math.min(100, stall.health + 30);
      }
      
      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
      if (stallElement) {
        updateStallDisplay(stallElement, stall, stallIndex);
      }
      
      // æ›´æ–°å·¦ä¾§ç›¸å…³èµ„æºå¡ç‰Œæ˜¾ç¤ºï¼ˆå¦‚æœæœ‰æ›´æ–°å‡½æ•°ï¼‰
      if (window.updateLivestockRelatedResources) {
        window.updateLivestockRelatedResources();
      }
      
      showNotification('æ¸…ç†æˆåŠŸ', `ä½ æ¸…ç†äº†ç‰²å£æ ï¼Œè·å¾—äº†${fertilizerAmount}ä¸ªè‚¥æ–™ï¼`);
      updateGameData();
    }

    // ä½¿ç”¨è¯ä¸¸æ²»ç–—åŠ¨ç‰©
    // é€šç”¨é¥²æ–™å–‚é£Ÿ
    window.feedAnimalWithFood = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];
      
      if (!stall.animal) {
        showNotification('æ— æ³•å–‚å…»', 'è¿™ä¸ªç‰²å£æ æ˜¯ç©ºçš„ï¼');
        return;
      }
      
      if (!gameData.resources.animal_feed || gameData.resources.animal_feed.amount < 1) {
        showNotification('é¥²æ–™ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„é€šç”¨é¥²æ–™ï¼');
        return;
      }
      
      if (stall.satiety >= 100) {
        showNotification('é¥±é£Ÿåº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨å¾ˆé¥±ï¼Œä¸éœ€è¦å–‚é£Ÿï¼');
        return;
      }
      
      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
      
      gameData.resources.animal_feed.amount -= 1;
      stall.satiety = Math.min(100, stall.satiety + 30);
      stall.lastFedDay = gameData.day || 1;
      
      // æ·»åŠ å–‚é£ŸåŠ¨ç”»æ•ˆæœ
      if (stallElement) {
        stallElement.classList.add('feed-animation');

        // åˆ›å»ºå–‚é£Ÿæ¼‚æµ®æ–‡å­— - æ‰‹åŠ¨åŠ¨ç”»
        const rect = stallElement.getBoundingClientRect();
        const feedText = document.createElement('div');
        feedText.className = 'floating-text';
        feedText.textContent = 'å–‚é£ŸæˆåŠŸï¼ğŸŒ¾';
        feedText.style.color = '#ED8936';
        feedText.style.fontSize = '1.4rem';
        feedText.style.fontWeight = 'bold';
        feedText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 20px rgba(237, 137, 54, 0.8)';
        feedText.style.position = 'fixed';
        feedText.style.left = (rect.left + rect.width / 2) + 'px';
        feedText.style.top = (rect.top + rect.height / 2) + 'px';
        feedText.style.transform = 'translateX(-50%) translateY(-50%)';
        feedText.style.zIndex = '9999';
        feedText.style.opacity = '0';
        feedText.style.pointerEvents = 'none';
        feedText.style.whiteSpace = 'nowrap';
        feedText.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        document.body.appendChild(feedText);

        // åˆ›å»ºé£Ÿç‰©ç²’å­ç‰¹æ•ˆ - å¢åŠ ç²’å­æ•°é‡å’Œå¤šæ ·æ€§
        for (let i = 0; i < 15; i++) {
          const particle = document.createElement('div');
          particle.className = 'food-particle';
          const size = Math.random() * 14 + 6;
          particle.style.width = size + 'px';
          particle.style.height = size + 'px';
          particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
          particle.style.top = (rect.top + rect.height / 2 - 40) + 'px';
          particle.style.setProperty('--bounce-height', (Math.random() * 80 + 20) + 'px');
          particle.style.setProperty('--bounce-height-half', (Math.random() * 40 + 10) + 'px');
          particle.style.setProperty('--fall-distance', (Math.random() * 90 + 20) + 'px');

          // éšæœºé¢œè‰² - ä½¿ç”¨backgroundè€Œä¸æ˜¯backgroundColorä»¥è¦†ç›–CSSçš„æ¸å˜
          const foodColors = ['#F59E0B', '#F97316', '#EF4444', '#10B981', '#3B82F6'];
          const color = foodColors[Math.floor(Math.random() * foodColors.length)];
          particle.style.background = `radial-gradient(circle, ${color} 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%)`;
          particle.style.opacity = Math.random() * 0.3 + 0.7;

          const delay = Math.random() * 0.3;
          particle.style.animationDelay = delay + 's';
          document.body.appendChild(particle);

          setTimeout(() => {
            if (particle.parentNode === document.body) {
              document.body.removeChild(particle);
            }
          }, (800 + delay * 1000));
        }

        // åˆ›å»ºæ—‹è½¬çš„è°·ç²’ç‰¹æ•ˆ
        for (let i = 0; i < 8; i++) {
          const grain = document.createElement('div');
          grain.className = 'food-grain';
          const grainSize = Math.random() * 10 + 5;
          grain.style.cssText = `
            position: fixed;
            width: ${grainSize}px;
            height: ${grainSize}px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            pointer-events: none;
            z-index: 9998;
            animation: food-grain-spin 1s ease-out forwards;
          `;
          const angle = Math.random() * Math.PI * 2;
          const distance = Math.random() * 60 + 20;
          grain.style.left = (rect.left + rect.width / 2 + Math.cos(angle) * distance) + 'px';
          grain.style.top = (rect.top + rect.height / 2 + Math.sin(angle) * distance) + 'px';
          grain.style.animationDelay = (Math.random() * 0.2) + 's';
          document.body.appendChild(grain);

          setTimeout(() => {
            if (grain.parentNode === document.body) {
              document.body.removeChild(grain);
            }
          }, (1200 + Math.random() * 300));
        }

        // åˆ›å»ºé£Ÿç‰©æ˜Ÿå½¢ç‰¹æ•ˆ - å¢åŠ æ•°é‡å’Œå¤§å°
        for (let i = 0; i < 7; i++) {
          const star = document.createElement('div');
          star.className = 'food-star';
          const starSize = Math.random() * 20 + 12;
          star.style.width = starSize + 'px';
          star.style.height = starSize + 'px';
          const angle = (i / 7) * 360;
          const distance = Math.random() * 60 + 25;
          star.style.left = (rect.left + rect.width / 2 + Math.cos(angle * Math.PI / 180) * distance) + 'px';
          star.style.top = (rect.top + rect.height / 2 + Math.sin(angle * Math.PI / 180) * distance) + 'px';
          star.style.setProperty('--star-distance', (Math.random() * 80 + 30) + 'px');
          star.style.opacity = Math.random() * 0.3 + 0.7;
          const delay = Math.random() * 0.2;
          star.style.animationDelay = delay + 's';
          document.body.appendChild(star);

          setTimeout(() => {
            if (star.parentNode === document.body) {
              document.body.removeChild(star);
            }
          }, (1000 + delay * 1000));
        }

        // åˆ›å»ºé—ªçƒå…‰ç‚¹ç‰¹æ•ˆ
        for (let i = 0; i < 5; i++) {
          const sparkle = document.createElement('div');
          sparkle.style.cssText = `
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #FFD700 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: sparkle-burst 0.6s ease-out forwards;
          `;
          sparkle.style.left = (rect.left + Math.random() * rect.width) + 'px';
          sparkle.style.top = (rect.top + Math.random() * rect.height) + 'px';
          sparkle.style.animationDelay = (Math.random() * 0.3) + 's';
          document.body.appendChild(sparkle);

          setTimeout(() => {
            if (sparkle.parentNode === document.body) {
              document.body.removeChild(sparkle);
            }
          }, 900);
        }

        // ä½¿ç”¨setTimeoutè§¦å‘åŠ¨ç”»
        setTimeout(() => {
          feedText.style.opacity = '1';
          feedText.style.top = (rect.top + rect.height / 2 - 60) + 'px';
          feedText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.5) rotate(-5deg)';
        }, 10);

        setTimeout(() => {
          feedText.style.opacity = '0';
          feedText.style.top = (rect.top + rect.height / 2 - 120) + 'px';
          feedText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.3) rotate(5deg)';
        }, 500);

        setTimeout(() => {
          stallElement.classList.remove('feed-animation');
          if (feedText.parentNode === document.body) {
            document.body.removeChild(feedText);
          }
          updateStallDisplay(stallElement, stall, stallIndex);
        }, 1500);
      }

      renderResources();
      updateFeedDisplay();
      updateGameData();
      showNotification('å–‚é£ŸæˆåŠŸ', 'ä½ ç”¨é€šç”¨é¥²æ–™å–‚å…»äº†åŠ¨ç‰©ï¼Œé¥±é£Ÿåº¦å¢åŠ 30ç‚¹ï¼');
    }

    // æœ¨æ¡¶å–‚æ°´
    window.feedAnimalWithBucket = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];

      if (!stall.animal) {
        showNotification('æ— æ³•å–‚å…»', 'è¿™ä¸ªç‰²å£æ æ˜¯ç©ºçš„ï¼');
        return;
      }

      const bucket = gameData.resources.bucket;
      if (!bucket || bucket.amount <= 0) {
        showNotification('æ°´é‡ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„æœ¨æ¡¶ï¼');
        return;
      }

      // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ°´
      if (bucket.instances && bucket.instances.length > 0) {
        const totalWater = bucket.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        if (totalWater <= 0) {
          showNotification('æ°´é‡ä¸è¶³', 'æ‰€æœ‰æœ¨æ¡¶éƒ½æ˜¯ç©ºçš„ï¼');
          return;
        }
      } else if (bucket.waterLevel <= 0) {
        showNotification('æ°´é‡ä¸è¶³', 'æœ¨æ¡¶æ˜¯ç©ºçš„ï¼');
        return;
      }

      if (stall.thirst >= 100) {
        showNotification('å£æ¸´åº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨ä¸å£æ¸´ï¼Œä¸éœ€è¦å–‚æ°´ï¼');
        return;
      }

      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);

      // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹å¹¶å–‚æ°´
      if (bucket.instances && bucket.instances.length > 0) {
        for (const instance of bucket.instances) {
          if (instance.waterLevel > 0) {
            const waterUsed = Math.min(instance.waterLevel, 50);
            instance.waterLevel -= waterUsed;
            stall.thirst = Math.min(100, stall.thirst + 40);
            stall.lastFedDay = gameData.day || 1;

            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
            if (stallElement) {
              stallElement.classList.add('water-animation');

              // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
              if (!window.createWaterEffect || !window.createWaterFloatingText) {
                console.log('ç‰²å£æ£šæµ‡æ°´ï¼šæ°´ç‰¹æ•ˆå‡½æ•°æœªå®šä¹‰ï¼Œç«‹å³åˆå§‹åŒ–...');
                if (typeof initializeAnimationCSS === 'function') {
                  initializeAnimationCSS();
                }
                if (typeof initializeAnimationEffects === 'function') {
                  initializeAnimationEffects();
                }
              }

              // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
              if (window.createWaterEffect) {
                window.createWaterEffect(stallElement);
                console.log('ç‰²å£æ£šæœ¨æ¡¶ï¼šæ°´æ³¢çº¹ç‰¹æ•ˆå·²è§¦å‘');
              } else {
                console.warn('ç‰²å£æ£šæœ¨æ¡¶ï¼šcreateWaterEffectå‡½æ•°æœªå®šä¹‰ï¼');
              }
              if (window.createWaterFloatingText) {
                window.createWaterFloatingText(stallElement);
                console.log('ç‰²å£æ£šæœ¨æ¡¶ï¼šæµ‡æ°´æ¼‚æµ®æ–‡å­—å·²è§¦å‘');
              } else {
                console.warn('ç‰²å£æ£šæœ¨æ¡¶ï¼šcreateWaterFloatingTextå‡½æ•°æœªå®šä¹‰ï¼');
              }

              // 1500msåç§»é™¤åŠ¨ç”»ç±»
              setTimeout(() => {
                stallElement.classList.remove('water-animation');
              }, 1500);
            }

            // åŒæ­¥æ›´æ–°resource.waterLevel
            syncBucketWaterLevel();

            // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
            updateContainerImage('bucket');

            // æ›´æ–°ç‰²å£æ£šé¥²æ–™å¡ç‰Œæ˜¾ç¤º
            if (typeof updateFeedDisplay === 'function') {
              updateFeedDisplay();
            }

            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
            setTimeout(() => {
              // æ›´æ–°èƒŒåŒ…æ æ˜¾ç¤º
              renderResources();
              updateResourceCard('bucket');

              // å‡å°‘æœ¨æ¡¶è€ä¹…åº¦
              if (instance.durability === undefined) {
                instance.durability = 100;
              }
              instance.durability = Math.max(0, instance.durability - 2);

              // è®¡ç®—å‰©ä½™æ€»æ°´é‡
              const totalWater = bucket.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
              showNotification('å–‚æ°´æˆåŠŸ', `ä½ ç”¨æœ¨æ¡¶ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 40ç‚¹ï¼å‰©ä½™æ€»æ°´é‡: ${totalWater}/250ï¼Œå‰©ä½™è€ä¹…: ${instance.durability}%`);

              // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œåˆ é™¤è¿™ä¸ªå®ä¾‹
              if (instance.durability <= 0) {
                bucket.instances = bucket.instances.filter(inst => inst.id !== instance.id);
                bucket.amount--;
                showNotification('æœ¨æ¡¶æŸå', 'ä¸€ä¸ªæœ¨æ¡¶å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼');
              }
            }, 1500);

            break;
          }
        }
      } else {
        // å…¼å®¹æ—§ä»£ç 
        const waterUsed = Math.min(bucket.waterLevel, 50);
        bucket.waterLevel -= waterUsed;
        stall.thirst = Math.min(100, stall.thirst + 40);
        stall.lastFedDay = gameData.day || 1;

        // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
        if (stallElement) {
          stallElement.classList.add('water-animation');

          // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
          if (!window.createWaterEffect || !window.createWaterFloatingText) {
            if (typeof initializeAnimationCSS === 'function') {
              initializeAnimationCSS();
            }
            if (typeof initializeAnimationEffects === 'function') {
              initializeAnimationEffects();
            }
          }

          // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
          if (window.createWaterEffect) {
            window.createWaterEffect(stallElement);
          }
          if (window.createWaterFloatingText) {
            window.createWaterFloatingText(stallElement);
          }

          // 1500msåç§»é™¤åŠ¨ç”»ç±»
          setTimeout(() => {
            stallElement.classList.remove('water-animation');
          }, 1500);
        }

        // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
        setTimeout(() => {
          // å‡å°‘æœ¨æ¡¶è€ä¹…åº¦
          if (bucket.durability === undefined) {
            bucket.durability = 100;
          }
          bucket.durability = Math.max(0, bucket.durability - 2);

          // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
          updateContainerImage('bucket');

          // æ›´æ–°æ˜¾ç¤º
          renderResources();
          updateResourceCard('bucket');
          updateFeedDisplay();
          updateGameData();

          showNotification('å–‚æ°´æˆåŠŸ', `ä½ ç”¨æœ¨æ¡¶ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 40ç‚¹ï¼å‰©ä½™æ°´é‡: ${bucket.waterLevel}/250ï¼Œå‰©ä½™è€ä¹…: ${bucket.durability}%`);
        }, 1500);
      }

      // æ·»åŠ å–‚æ°´åŠ¨ç”»æ•ˆæœ
      if (stallElement) {
        stallElement.classList.add('water-animation');

        const rect = stallElement.getBoundingClientRect();
        const waterText = document.createElement('div');
        waterText.className = 'floating-text';
        waterText.textContent = 'å–‚æ°´æˆåŠŸï¼ğŸ’§';
        waterText.style.color = '#3B82F6';
        waterText.style.fontSize = '1.4rem';
        waterText.style.fontWeight = 'bold';
        waterText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 20px rgba(59, 130, 246, 0.8)';
        waterText.style.position = 'fixed';
        waterText.style.left = (rect.left + rect.width / 2) + 'px';
        waterText.style.top = (rect.top + rect.height / 2) + 'px';
        waterText.style.transform = 'translateX(-50%) translateY(-50%)';
        waterText.style.zIndex = '9999';
        waterText.style.opacity = '0';
        waterText.style.pointerEvents = 'none';
        waterText.style.whiteSpace = 'nowrap';
        waterText.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        document.body.appendChild(waterText);

        // åˆ›å»ºæ°´æ»´ç²’å­ç‰¹æ•ˆ - å¢åŠ ç²’å­æ•°é‡å’Œå¤šæ ·æ€§
        for (let i = 0; i < 18; i++) {
          const particle = document.createElement('div');
          particle.className = 'water-particle';
          const size = Math.random() * 18 + 8;
          particle.style.width = size + 'px';
          particle.style.height = size + 'px';
          particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
          particle.style.top = (rect.top + rect.height / 2 - 30) + 'px';
          particle.style.setProperty('--fall-distance', (Math.random() * 100 + 30) + 'px');
          
          // éšæœºæ°´æ»´é¢œè‰²
          const waterColors = [
            'rgba(59, 130, 246, 0.9)',
            'rgba(147, 197, 253, 0.8)',
            'rgba(96, 165, 250, 0.85)',
            'rgba(34, 211, 238, 0.9)'
          ];
          particle.style.background = `radial-gradient(circle, ${waterColors[Math.floor(Math.random() * waterColors.length)]} 0%, transparent 70%)`;
          particle.style.opacity = Math.random() * 0.3 + 0.7;
          
          const delay = Math.random() * 0.3;
          particle.style.animationDelay = delay + 's';
          document.body.appendChild(particle);

          setTimeout(() => {
            if (particle.parentNode === document.body) {
              document.body.removeChild(particle);
            }
          }, (800 + delay * 1000));
        }

        // åˆ›å»ºæ°´æ»´é£æº…ç‰¹æ•ˆ - å¢åŠ æ•°é‡å’Œå˜åŒ–
        for (let i = 0; i < 5; i++) {
          const splash = document.createElement('div');
          splash.className = 'water-splash';
          const size = Math.random() * 40 + 15;
          splash.style.width = size + 'px';
          splash.style.height = size + 'px';
          splash.style.left = (rect.left + rect.width / 2 - size / 2) + 'px';
          splash.style.top = (rect.top + rect.height / 2 - size / 2) + 'px';
          const delay = i * 0.12;
          splash.style.animationDelay = delay + 's';
          splash.style.opacity = Math.random() * 0.3 + 0.7;
          document.body.appendChild(splash);

          setTimeout(() => {
            if (splash.parentNode === document.body) {
              document.body.removeChild(splash);
            }
          }, (600 + delay * 1000));
        }

        // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆ
        for (let i = 0; i < 3; i++) {
          const ripple = document.createElement('div');
          ripple.style.cssText = `
            position: fixed;
            border-radius: 50%;
            border: 2px solid rgba(59, 130, 246, ${0.8 - i * 0.2});
            pointer-events: none;
            z-index: 9997;
            animation: water-ripple-expand 1s ease-out forwards;
          `;
          const rippleSize = 60 + i * 30;
          ripple.style.width = rippleSize + 'px';
          ripple.style.height = rippleSize + 'px';
          ripple.style.left = (rect.left + rect.width / 2 - rippleSize / 2) + 'px';
          ripple.style.top = (rect.top + rect.height / 2 - rippleSize / 2) + 'px';
          ripple.style.animationDelay = (i * 0.15) + 's';
          document.body.appendChild(ripple);

          setTimeout(() => {
            if (ripple.parentNode === document.body) {
              document.body.removeChild(ripple);
            }
          }, (1000 + i * 150));
        }

        // åˆ›å»ºæ°´é›¾ç‰¹æ•ˆ
        for (let i = 0; i < 4; i++) {
          const mist = document.createElement('div');
          mist.style.cssText = `
            position: fixed;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.4) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9997;
            animation: water-mist-float 1.2s ease-out forwards;
          `;
          const mistSize = Math.random() * 30 + 20;
          mist.style.width = mistSize + 'px';
          mist.style.height = mistSize + 'px';
          const angle = (i / 4) * Math.PI * 2;
          const distance = Math.random() * 40 + 20;
          mist.style.left = (rect.left + rect.width / 2 + Math.cos(angle) * distance) + 'px';
          mist.style.top = (rect.top + rect.height / 2 + Math.sin(angle) * distance) + 'px';
          mist.style.animationDelay = (Math.random() * 0.2) + 's';
          document.body.appendChild(mist);

          setTimeout(() => {
            if (mist.parentNode === document.body) {
              document.body.removeChild(mist);
            }
          }, 1400);
        }

        // åˆ›å»ºæ°´èŠ±å››æº…çš„å°ç²’å­
        for (let i = 0; i < 6; i++) {
          const droplet = document.createElement('div');
          droplet.className = 'water-droplet';
          const dropletSize = Math.random() * 6 + 3;
          droplet.style.cssText = `
            position: fixed;
            width: ${dropletSize}px;
            height: ${dropletSize}px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.9) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: water-droplet-splash 0.8s ease-out forwards;
          `;
          const angle = Math.random() * Math.PI * 2;
          const distance = Math.random() * 50 + 30;
          droplet.style.left = (rect.left + rect.width / 2 + Math.cos(angle) * distance) + 'px';
          droplet.style.top = (rect.top + rect.height / 2 + Math.sin(angle) * distance) + 'px';
          droplet.style.setProperty('--splash-x', Math.cos(angle) * distance + 'px');
          droplet.style.setProperty('--splash-y', Math.sin(angle) * distance + 'px');
          droplet.style.animationDelay = (Math.random() * 0.15) + 's';
          document.body.appendChild(droplet);

          setTimeout(() => {
            if (droplet.parentNode === document.body) {
              document.body.removeChild(droplet);
            }
          }, 950);
        }

        setTimeout(() => {
          waterText.style.opacity = '1';
          waterText.style.top = (rect.top + rect.height / 2 - 60) + 'px';
          waterText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.5) rotate(5deg)';
        }, 10);

        setTimeout(() => {
          waterText.style.opacity = '0';
          waterText.style.top = (rect.top + rect.height / 2 - 120) + 'px';
          waterText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.3) rotate(-5deg)';
        }, 500);

        setTimeout(() => {
          stallElement.classList.remove('water-animation');
          if (waterText.parentNode === document.body) {
            document.body.removeChild(waterText);
          }
          updateStallDisplay(stallElement, stall, stallIndex);
        }, 1500);
      }
      
      // å¦‚æœæœ¨æ¡¶æ°´é‡ç”¨å®Œï¼Œæ›´æ–°å›¾ç‰‡ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°ï¼‰
      if (bucket.waterLevel <= 0) {
        updateContainerImage('bucket');
      }
      
      // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œè‡ªåŠ¨é”€æ¯æœ¨æ¡¶
      if (bucket.durability <= 0) {
        bucket.amount--;
        if (bucket.amount <= 0) {
          bucket.durability = undefined;
        } else {
          bucket.durability = 100;
        }
        showNotification('æœ¨æ¡¶æŸå', 'æœ¨æ¡¶å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼');
      }

      renderResources();
      updateResourceCard('bucket');
      updateFeedDisplay();
      updateGameData();
      showNotification('å–‚æ°´æˆåŠŸ', `ä½ ç”¨æœ¨æ¡¶ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 40ç‚¹ï¼å‰©ä½™æ°´é‡: ${bucket.waterLevel}/250ï¼Œå‰©ä½™è€ä¹…: ${bucket.durability}%`);
    }

    // ç”¨è¯ä¸¸æ²»ç–—
    window.feedAnimalWithPill = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];
      
      if (!stall.animal) {
        showNotification('æ— æ³•æ²»ç–—', 'è¿™ä¸ªç‰²å£æ æ˜¯ç©ºçš„ï¼');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰è¯ä¸¸
      if (!gameData.resources.pill || gameData.resources.pill.amount < 1) {
        showNotification('è¯ä¸¸ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„è¯ä¸¸ï¼');
        return;
      }
      
      // æ¶ˆè€—ä¸€ä»½è¯ä¸¸
      gameData.resources.pill.amount -= 1;
      
      // æå‡å¥åº·å€¼
      stall.health = Math.min(100, stall.health + 30);
      
      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);
      if (stallElement) {
        updateStallDisplay(stallElement, stall, stallIndex);
      }
      
      // æ›´æ–°å·¦ä¾§é¥²æ–™å¡ç‰Œæ˜¾ç¤º
      updateFeedDisplay();
      
      showNotification('æ²»ç–—æˆåŠŸ', `ä½ ç”¨è¯ä¸¸æ²»ç–—äº†åŠ¨ç‰©ï¼Œå¥åº·å€¼å¢åŠ 30ç‚¹ï¼`);
      updateGameData();
    }

    // ç”¨æ°´è¢‹å–‚åŠ¨ç‰©
    window.feedAnimalWithWaterBag = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];

      if (!stall.animal) {
        showNotification('æ— æ³•å–‚å…»', 'è¿™ä¸ªç‰²å£æ æ˜¯ç©ºçš„ï¼');
        return;
      }

      const waterBag = gameData.resources.water_bag;
      if (!waterBag || waterBag.amount <= 0) {
        showNotification('æ°´è¢‹ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„æ°´è¢‹ï¼');
        return;
      }

      // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ°´
      if (waterBag.instances && waterBag.instances.length > 0) {
        const totalWater = waterBag.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        if (totalWater <= 0) {
          showNotification('æ°´è¢‹ä¸è¶³', 'æ‰€æœ‰æ°´è¢‹éƒ½æ˜¯ç©ºçš„ï¼');
          return;
        }
      } else if (waterBag.waterLevel <= 0) {
        showNotification('æ°´è¢‹ä¸è¶³', 'æ°´è¢‹æ˜¯ç©ºçš„ï¼');
        return;
      }

      // æ£€æŸ¥å£æ¸´åº¦æ˜¯å¦å·²æ»¡
      if (stall.thirst >= 100) {
        showNotification('å£æ¸´åº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨ä¸å£æ¸´ï¼Œä¸éœ€è¦å–‚æ°´ï¼');
        return;
      }

      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);

      // ä½¿ç”¨å®ä¾‹ç³»ç»Ÿï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ°´çš„å®ä¾‹å¹¶å–‚æ°´
      if (waterBag.instances && waterBag.instances.length > 0) {
        for (const instance of waterBag.instances) {
          if (instance.waterLevel > 0) {
            // å‡å°‘æ°´è¢‹æ°´é‡ï¼ˆæ¯æ¬¡ä½¿ç”¨20æ°´é‡ï¼‰
            const waterUsed = Math.min(instance.waterLevel, 20);
            instance.waterLevel -= waterUsed;
            stall.thirst = Math.min(100, stall.thirst + 30);
            stall.lastFedDay = gameData.day || 1;

            // æ·»åŠ æµ‡æ°´åŠ¨ç”»CSSç±»
            if (stallElement) {
              stallElement.classList.add('water-animation');

              // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
              if (!window.createWaterEffect || !window.createWaterFloatingText) {
                console.log('ç‰²å£æ£šæµ‡æ°´ï¼šæ°´ç‰¹æ•ˆå‡½æ•°æœªå®šä¹‰ï¼Œç«‹å³åˆå§‹åŒ–...');
                if (typeof initializeAnimationCSS === 'function') {
                  initializeAnimationCSS();
                }
                if (typeof initializeAnimationEffects === 'function') {
                  initializeAnimationEffects();
                }
              }

              // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
              if (window.createWaterEffect) {
                window.createWaterEffect(stallElement);
                console.log('ç‰²å£æ£šæœ¨æ¡¶ï¼šæ°´æ³¢çº¹ç‰¹æ•ˆå·²è§¦å‘');
              } else {
                console.warn('ç‰²å£æ£šæœ¨æ¡¶ï¼šcreateWaterEffectå‡½æ•°æœªå®šä¹‰ï¼');
              }
              if (window.createWaterFloatingText) {
                window.createWaterFloatingText(stallElement);
                console.log('ç‰²å£æ£šæœ¨æ¡¶ï¼šæµ‡æ°´æ¼‚æµ®æ–‡å­—å·²è§¦å‘');
              } else {
                console.warn('ç‰²å£æ£šæœ¨æ¡¶ï¼šcreateWaterFloatingTextå‡½æ•°æœªå®šä¹‰ï¼');
              }

              // 1500msåç§»é™¤åŠ¨ç”»ç±»
              setTimeout(() => {
                stallElement.classList.remove('water-animation');
              }, 1500);
            }

            // åŒæ­¥æ›´æ–°resource.waterLevel
            syncWaterBagWaterLevel();

            // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
            updateContainerImage('water_bag');

            // æ›´æ–°ç‰²å£æ£šé¥²æ–™å¡ç‰Œæ˜¾ç¤º
            if (typeof updateFeedDisplay === 'function') {
              updateFeedDisplay();
            }

            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿åŠ¨ç”»å…ˆæ’­æ”¾
            setTimeout(() => {
              // æ›´æ–°èƒŒåŒ…æ æ˜¾ç¤º
              renderResources();
              updateResourceCard('water_bag');

              // è®¡ç®—å‰©ä½™æ€»æ°´é‡
              const totalWater = waterBag.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
              showNotification('å–‚æ°´æˆåŠŸ', `ä½ ç”¨æ°´è¢‹ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 30ç‚¹ï¼å‰©ä½™æ€»æ°´é‡: ${totalWater}/100ï¼Œå‰©ä½™è€ä¹…: ${instance.durability}%`);

              // å‡å°‘æ°´è¢‹è€ä¹…åº¦ï¼ˆæ¯æ¬¡ä½¿ç”¨å‡å°‘1ï¼‰
              if (instance.durability === undefined) {
                instance.durability = 100;
              }
              instance.durability = Math.max(0, instance.durability - 1);

              // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œåˆ é™¤è¿™ä¸ªå®ä¾‹
              if (instance.durability <= 0) {
                waterBag.instances = waterBag.instances.filter(inst => inst.id !== instance.id);
                waterBag.amount--;
                showNotification('æ°´è¢‹æŸå', 'ä¸€ä¸ªæ°´è¢‹å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼');
              }
            }, 1500);

            break;
          }
        }

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å®ä¾‹çš„æ°´éƒ½ç”¨å®Œäº†ï¼Œå¦‚æœæ˜¯ï¼Œå°†ç¬¬ä¸€ä¸ªå®ä¾‹è½¬æ¢ä¸ºç©ºå®ä¾‹
        if (waterBag.instances && waterBag.instances.length > 0) {
          const allEmpty = waterBag.instances.every(inst => inst.waterLevel <= 0);
          if (allEmpty) {
            // å°†ç¬¬ä¸€ä¸ªå®ä¾‹è½¬æ¢ä¸ºç©ºå®ä¾‹
            waterBag.instances[0].waterLevel = 0;
          }
        }
      } else {
        // å…¼å®¹æ—§ä»£ç 
        const waterUsed = Math.min(waterBag.waterLevel, 20);
        waterBag.waterLevel -= waterUsed;
        stall.thirst = Math.min(100, stall.thirst + 30);

        // æ›´æ–°å›¾ç‰‡ï¼Œç¡®ä¿resource.imageæ­£ç¡®åæ˜ å½“å‰æ°´ä½
        updateContainerImage('water_bag');

        // æ›´æ–°å–‚å…»æ—¥æœŸ
        stall.lastFedDay = gameData.day || 1;

          // æ·»åŠ å–‚æ°´åŠ¨ç”»æ•ˆæœ
        if (stallElement) {
          stallElement.classList.add('water-animation');

          // åˆ›å»ºå–‚æ°´æ¼‚æµ®æ–‡å­— - æ‰‹åŠ¨åŠ¨ç”»
          const rect = stallElement.getBoundingClientRect();
          const waterText = document.createElement('div');
          waterText.className = 'floating-text';
          waterText.textContent = 'å–‚æ°´æˆåŠŸï¼ğŸ’§';
          waterText.style.color = '#3B82F6';
          waterText.style.fontSize = '1.4rem';
          waterText.style.fontWeight = 'bold';
          waterText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 20px rgba(59, 130, 246, 0.8)';
          waterText.style.position = 'fixed';
          waterText.style.left = (rect.left + rect.width / 2) + 'px';
          waterText.style.top = (rect.top + rect.height / 2) + 'px';
          waterText.style.transform = 'translateX(-50%) translateY(-50%)';
          waterText.style.zIndex = '9999';
          waterText.style.opacity = '0';
          waterText.style.pointerEvents = 'none';
          waterText.style.whiteSpace = 'nowrap';
          waterText.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
          document.body.appendChild(waterText);

          // åˆ›å»ºæ°´æ»´ç²’å­ç‰¹æ•ˆ - å¢åŠ ç²’å­æ•°é‡å’Œå¤šæ ·æ€§
          for (let i = 0; i < 18; i++) {
            const particle = document.createElement('div');
            particle.className = 'water-particle';
            const size = Math.random() * 18 + 8;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
            particle.style.top = (rect.top + rect.height / 2 - 30) + 'px';
            particle.style.setProperty('--fall-distance', (Math.random() * 100 + 30) + 'px');

            // éšæœºæ°´æ»´é¢œè‰²
            const waterColors = [
              'rgba(59, 130, 246, 0.9)',
              'rgba(147, 197, 253, 0.8)',
              'rgba(96, 165, 250, 0.85)',
              'rgba(34, 211, 238, 0.9)'
            ];
            particle.style.background = `radial-gradient(circle, ${waterColors[Math.floor(Math.random() * waterColors.length)]} 0%, transparent 70%)`;
            particle.style.opacity = Math.random() * 0.3 + 0.7;

            const delay = Math.random() * 0.3;
            particle.style.animationDelay = delay + 's';
            document.body.appendChild(particle);

            setTimeout(() => {
              if (particle.parentNode === document.body) {
                document.body.removeChild(particle);
              }
            }, (800 + delay * 1000));
          }

          // åˆ›å»ºæ°´æ»´é£æº…ç‰¹æ•ˆ - å¢åŠ æ•°é‡å’Œå˜åŒ–
          for (let i = 0; i < 5; i++) {
            const splash = document.createElement('div');
            splash.className = 'water-splash';
            const size = Math.random() * 40 + 15;
            splash.style.width = size + 'px';
            splash.style.height = size + 'px';
            splash.style.left = (rect.left + rect.width / 2 - size / 2) + 'px';
            splash.style.top = (rect.top + rect.height / 2 - size / 2) + 'px';
            const delay = i * 0.12;
            splash.style.animationDelay = delay + 's';
            splash.style.opacity = Math.random() * 0.3 + 0.7;
            document.body.appendChild(splash);

            setTimeout(() => {
              if (splash.parentNode === document.body) {
                document.body.removeChild(splash);
              }
            }, (600 + delay * 1000));
          }

          // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆ
          for (let i = 0; i < 3; i++) {
            const ripple = document.createElement('div');
            ripple.style.cssText = `
              position: fixed;
              border-radius: 50%;
              border: 2px solid rgba(59, 130, 246, ${0.8 - i * 0.2});
              pointer-events: none;
              z-index: 9997;
              animation: water-ripple-expand 1s ease-out forwards;
            `;
            const rippleSize = 60 + i * 30;
            ripple.style.width = rippleSize + 'px';
            ripple.style.height = rippleSize + 'px';
            ripple.style.left = (rect.left + rect.width / 2 - rippleSize / 2) + 'px';
            ripple.style.top = (rect.top + rect.height / 2 - rippleSize / 2) + 'px';
            const delay = i * 0.15;
            ripple.style.animationDelay = delay + 's';
            document.body.appendChild(ripple);

            setTimeout(() => {
              if (ripple.parentNode === document.body) {
                document.body.removeChild(ripple);
              }
            }, (1000 + delay * 1000));
          }

          // åˆ›å»ºæ°´é›¾ç‰¹æ•ˆ
          for (let i = 0; i < 4; i++) {
            const mist = document.createElement('div');
            mist.className = 'water-mist';
            const mistSize = Math.random() * 30 + 20;
            mist.style.width = mistSize + 'px';
            mist.style.height = mistSize + 'px';
            mist.style.left = (rect.left + rect.width / 2 - mistSize / 2 + (Math.random() - 0.5) * 60) + 'px';
            mist.style.top = (rect.top + rect.height / 2 - mistSize / 2 + (Math.random() - 0.5) * 60) + 'px';
            const delay = i * 0.1 + Math.random() * 0.1;
            mist.style.animationDelay = delay + 's';
            document.body.appendChild(mist);

            setTimeout(() => {
              if (mist.parentNode === document.body) {
                document.body.removeChild(mist);
              }
            }, (1200 + delay * 1000));
          }

          // åˆ›å»ºæ°´æ»´é£æº…ç‰¹æ•ˆ - å¢åŠ æ–¹å‘æ€§
          for (let i = 0; i < 6; i++) {
            const droplet = document.createElement('div');
            droplet.className = 'water-droplet';
            const dropletSize = Math.random() * 10 + 6;
            droplet.style.width = dropletSize + 'px';
            droplet.style.height = dropletSize + 'px';
            const angle = (i / 6) * 360;
            const distance = Math.random() * 40 + 20;
            droplet.style.left = (rect.left + rect.width / 2 - dropletSize / 2) + 'px';
            droplet.style.top = (rect.top + rect.height / 2 - dropletSize / 2) + 'px';
            droplet.style.setProperty('--splash-x', (Math.cos(angle * Math.PI / 180) * distance) + 'px');
            droplet.style.setProperty('--splash-y', (Math.sin(angle * Math.PI / 180) * distance) + 'px');
            const delay = i * 0.08;
            droplet.style.animationDelay = delay + 's';
            document.body.appendChild(droplet);

            setTimeout(() => {
              if (droplet.parentNode === document.body) {
                document.body.removeChild(droplet);
              }
            }, (800 + delay * 1000));
          }

          // ä½¿ç”¨setTimeoutè§¦å‘åŠ¨ç”»
          setTimeout(() => {
            waterText.style.opacity = '1';
            waterText.style.top = (rect.top + rect.height / 2 - 60) + 'px';
            waterText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.5) rotate(5deg)';
          }, 10);

          setTimeout(() => {
            waterText.style.opacity = '0';
            waterText.style.top = (rect.top + rect.height / 2 - 120) + 'px';
            waterText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.3) rotate(-5deg)';
          }, 500);

          setTimeout(() => {
            stallElement.classList.remove('water-animation');
            // ç§»é™¤æ¼‚æµ®æ–‡å­—
            if (waterText.parentNode === document.body) {
              document.body.removeChild(waterText);
            }
            updateStallDisplay(stallElement, stall, stallIndex);
          }, 1500);
        }

      // å¦‚æœæ°´è¢‹æ°´é‡ç”¨å®Œï¼Œåªè®¾ç½®æ°´é‡ä¸º0ï¼Œä¸è¿›è¡Œæ•°é‡è½¬ç§»
      if (waterBag.waterLevel <= 0) {
        waterBag.waterLevel = 0;
      }

      // å‡å°‘æ°´è¢‹è€ä¹…åº¦ï¼ˆæ¯æ¬¡ä½¿ç”¨å‡å°‘1ï¼‰
      if (waterBag.durability === undefined) {
        waterBag.durability = 100;
      }
      waterBag.durability = Math.max(0, waterBag.durability - 1);

      // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œè‡ªåŠ¨é”€æ¯æ°´è¢‹
      if (waterBag.durability <= 0) {
        waterBag.amount--;
        if (waterBag.amount <= 0) {
          waterBag.durability = undefined;
        } else {
          waterBag.durability = 100;
        }
        showNotification('æ°´è¢‹æŸå', 'æ°´è¢‹å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼');
      }

      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      updateResourceCard('bucket');
      updateResourceCard('water_bag');
      updateResourceCard('water_bag');
      updateFeedDisplay();
      updateGameData();

      showNotification('å–‚æ°´æˆåŠŸ', `ä½ ç”¨æ°´è¢‹ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 30ç‚¹ï¼å‰©ä½™æ°´é‡: ${waterBag.waterLevel}/100ï¼Œå‰©ä½™è€ä¹…: ${waterBag.durability}%`);
    }
  }

    // åˆ›å»ºæ‰«å¸šå¡ç‰Œ
    window.createBroomCard = function(broomId, resource) {
      const card = document.createElement('div');
      card.className = 'crafting-inventory-card livestock-feed-card';
      card.dataset.broomId = broomId;
      card.style.cursor = 'pointer';

      // æ˜¾ç¤ºè€ä¹…åº¦
      card.innerHTML = `
        <img src="${resource.image}" alt="${resource.name}" class="crafting-card-image">
        <div class="crafting-card-title">${resource.name}</div>
        <div class="crafting-card-count">æ•°é‡: ${resource.amount}</div>
        <div class="crafting-card-durability">è€ä¹…åº¦: ${resource.durability || 0}</div>
      `;

      // æ·»åŠ æ‚¬æµ®æ˜¾ç¤ºåŠŸèƒ½
      card.addEventListener('mouseenter', function() {
        // å…ˆéšè—æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å·¥å…·æç¤º
        hideLivestockTooltip();
        hideStableTooltip();

        const tooltip = document.createElement('div');
        tooltip.id = 'livestock-tooltip';
        tooltip.className = 'livestock-tooltip';

        tooltip.innerHTML = `
          <div class="livestock-tooltip-title">${resource.name}</div>
          <div class="livestock-tooltip-info">æ•°é‡: ${resource.amount}</div>
          <div class="livestock-tooltip-info">ç±»å‹: å…»æ®–ç”¨å“</div>
          <div class="livestock-tooltip-info">è€ä¹…åº¦: ${resource.durability || 0}</div>
          <div class="livestock-tooltip-action">æŒ‰ä½å¹¶æ‹–åŠ¨åˆ°æ±¡æµŠåº¦>50çš„ç‰²å£æ æˆ–é©¬å©æ è¿›è¡Œæ¸…æ´ï¼Œæ¯æ¬¡æ¶ˆè€—10è€ä¹…åº¦</div>
        `;

        document.body.appendChild(tooltip);

        // å®šä½å·¥å…·æç¤º
        const rect = card.getBoundingClientRect();
        tooltip.style.position = 'fixed';
        tooltip.style.left = rect.right + 10 + 'px';
        tooltip.style.top = rect.top + 'px';
        tooltip.style.zIndex = '2000';

        // æ·»åŠ æ·¡å…¥åŠ¨ç”»
        tooltip.style.opacity = '0';
        tooltip.style.transform = 'translateY(-5px)';
        setTimeout(() => {
          tooltip.style.opacity = '1';
          tooltip.style.transform = 'translateY(0)';
          tooltip.style.transition = 'all 0.3s ease-out';
        }, 10);
      });

      // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
      card.addEventListener('mouseleave', function() {
        hideLivestockTooltip();
        hideStableTooltip();
      });

      // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
      card.addEventListener('mousedown', function(e) {
        e.preventDefault();
        if (resource.amount <= 0 || (resource.durability !== undefined && resource.durability <= 0)) {
          showNotification('æ‰«å¸šä¸è¶³æˆ–å·²æŸå', 'ä½ æ²¡æœ‰å¯ç”¨çš„æ‰«å¸šï¼');
          return;
        }

        // åˆ›å»ºæ‰«å¸šå…‰æ ‡
        createLivestockCursor(broomId, 'broom');
      });

      return card;
    }

    // å–‚å…»åŠ¨ç‰©
    window.feedAnimal = function(stallIndex) {
      const livestockData = gameData.livestockData;
      const stall = livestockData.stalls[stallIndex];

      if (!stall.animal) {
        showNotification('æ— æ³•å–‚å…»', 'è¿™ä¸ªç‰²å£æ æ˜¯ç©ºçš„ï¼');
        return;
      }

      const stallElement = document.querySelector(`[data-stall-index="${stallIndex}"]`);

      // ä¼˜å…ˆä½¿ç”¨æœ¨æ¡¶å–‚æ°´
      const bucket = gameData.resources.bucket;
      if (bucket && bucket.amount > 0 && bucket.waterLevel > 0) {
        // æ£€æŸ¥å£æ¸´åº¦æ˜¯å¦å·²æ»¡
        if (stall.thirst >= 100) {
          showNotification('å£æ¸´åº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨ä¸å£æ¸´ï¼Œä¸éœ€è¦å–‚æ°´ï¼');
          return;
        }

        // å‡å°‘æœ¨æ¡¶æ°´é‡ï¼ˆæ¯æ¬¡ä½¿ç”¨50æ°´é‡ï¼‰
        const waterUsed = Math.min(bucket.waterLevel, 50);
        bucket.waterLevel -= waterUsed;
        stall.thirst = Math.min(100, stall.thirst + 40);

        // æ›´æ–°å–‚å…»æ—¥æœŸ
        stall.lastFedDay = gameData.day || 1;

        // æ·»åŠ å–‚æ°´åŠ¨ç”»æ•ˆæœ
        if (stallElement) {
          stallElement.classList.add('water-animation');

          // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åˆå§‹åŒ–
          if (!window.createWaterEffect || !window.createWaterFloatingText) {
            if (typeof initializeAnimationCSS === 'function') {
              initializeAnimationCSS();
            }
            if (typeof initializeAnimationEffects === 'function') {
              initializeAnimationEffects();
            }
          }

          // åˆ›å»ºæ°´æ³¢çº¹ç‰¹æ•ˆå’Œæ¼‚æµ®æ–‡å­—
          if (window.createWaterEffect) {
            window.createWaterEffect(stallElement);
          }
          if (window.createWaterFloatingText) {
            window.createWaterFloatingText(stallElement);
          }

          // 1500msåç§»é™¤åŠ¨ç”»ç±»
          setTimeout(() => {
            stallElement.classList.remove('water-animation');
          }, 1500);

          // 1500msåæ›´æ–°æ˜¾ç¤º
          setTimeout(() => {
            // æ›´æ–°æœ¨æ¡¶å›¾ç‰‡ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°ï¼‰
            updateContainerImage('bucket');

            // å‡å°‘æœ¨æ¡¶è€ä¹…åº¦ï¼ˆæ¯æ¬¡ä½¿ç”¨å‡å°‘2ï¼‰
            if (bucket.durability === undefined) {
              bucket.durability = 100;
            }
            bucket.durability = Math.max(0, bucket.durability - 2);

            // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œè‡ªåŠ¨é”€æ¯æœ¨æ¡¶
            if (bucket.durability <= 0) {
              bucket.amount--;
              if (bucket.amount <= 0) {
                bucket.durability = undefined;
              } else {
                bucket.durability = 100;
              }
              showNotification('æœ¨æ¡¶æŸå', 'æœ¨æ¡¶å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼');
            }

            // æ›´æ–°æ˜¾ç¤º
            renderResources();
            updateResourceCard('bucket');
            updateResourceCard('water_bag');
            updateFeedDisplay();
            updateGameData();

            showNotification('å–‚æ°´æˆåŠŸ', `ä½ ç”¨æœ¨æ¡¶ç»™åŠ¨ç‰©å–‚äº†æ°´ï¼Œå£æ¸´åº¦å¢åŠ 40ç‚¹ï¼å‰©ä½™æ°´é‡: ${bucket.waterLevel}/250ï¼Œå‰©ä½™è€ä¹…: ${bucket.durability}%`);
          }, 1500);
        }
      } // ç»“æŸæœ¨æ¡¶å–‚æ°´é€»è¾‘

      // å°è¯•ä½¿ç”¨æ°´è¢‹å–‚æ°´
      const waterBag = gameData.resources.water_bag;
      if (waterBag && waterBag.amount > 0 && waterBag.waterLevel > 0) {
        // æ£€æŸ¥å£æ¸´åº¦æ˜¯å¦å·²æ»¡
        if (stall.thirst >= 100) {
          showNotification('å£æ¸´åº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨ä¸å£æ¸´ï¼Œä¸éœ€è¦å–‚æ°´ï¼');
          return;
        }

        feedAnimalWithWaterBag(stallIndex);
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é¥²æ–™
      if (!gameData.resources.animal_feed || gameData.resources.animal_feed.amount < 1) {
        showNotification('é¥²æ–™ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„é€šç”¨é¥²æ–™ï¼');
        return;
      }
      
      // æ£€æŸ¥é¥±é£Ÿåº¦æ˜¯å¦å·²æ»¡
      if (stall.satiety >= 100) {
        showNotification('é¥±é£Ÿåº¦å·²æ»¡', 'è¿™åªåŠ¨ç‰©ç°åœ¨å¾ˆé¥±ï¼Œä¸éœ€è¦å–‚é£Ÿï¼');
        return;
      }
      
      // æ¶ˆè€—ä¸€ä»½é¥²æ–™
      gameData.resources.animal_feed.amount -= 1;
      
      // æ›´æ–°å–‚å…»æ—¥æœŸ
      stall.lastFedDay = gameData.day || 1;
      
      // æå‡é¥±é£Ÿåº¦ï¼ˆä¸æ˜¯å¥åº·å€¼ï¼‰
      stall.satiety = Math.min(100, stall.satiety + 30);

      // æ·»åŠ å–‚é£ŸåŠ¨ç”»æ•ˆæœ
      if (stallElement) {
        stallElement.classList.add('feed-animation');

        // åˆ›å»ºå–‚é£Ÿæ¼‚æµ®æ–‡å­— - æ‰‹åŠ¨åŠ¨ç”»
        const rect = stallElement.getBoundingClientRect();
        const feedText = document.createElement('div');
        feedText.className = 'floating-text';
        feedText.textContent = 'å–‚é£ŸæˆåŠŸï¼ğŸŒ¾';
        feedText.style.color = '#ED8936';
        feedText.style.fontSize = '1.4rem';
        feedText.style.fontWeight = 'bold';
        feedText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 20px rgba(237, 137, 54, 0.8)';
        feedText.style.position = 'fixed';
        feedText.style.left = (rect.left + rect.width / 2) + 'px';
        feedText.style.top = (rect.top + rect.height / 2) + 'px';
        feedText.style.transform = 'translateX(-50%) translateY(-50%)';
        feedText.style.zIndex = '9999';
        feedText.style.opacity = '0';
        feedText.style.pointerEvents = 'none';
        feedText.style.whiteSpace = 'nowrap';
        feedText.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        document.body.appendChild(feedText);

        // åˆ›å»ºé£Ÿç‰©ç²’å­ç‰¹æ•ˆ
        for (let i = 0; i < 10; i++) {
          const particle = document.createElement('div');
          particle.className = 'food-particle';
          const size = Math.random() * 12 + 8;
          particle.style.width = size + 'px';
          particle.style.height = size + 'px';
          particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
          particle.style.top = (rect.top + rect.height / 2 - 30) + 'px';
          particle.style.setProperty('--bounce-height', (Math.random() * 60 + 30) + 'px');
          particle.style.setProperty('--bounce-height-half', (Math.random() * 30 + 15) + 'px');
          particle.style.setProperty('--fall-distance', (Math.random() * 70 + 30) + 'px');

          // éšæœºé¢œè‰² - ä½¿ç”¨backgroundè€Œä¸æ˜¯backgroundColor
          const foodColors = ['#F59E0B', '#F97316', '#EF4444', '#10B981', '#3B82F6'];
          const color = foodColors[Math.floor(Math.random() * foodColors.length)];
          particle.style.background = `radial-gradient(circle, ${color} 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%)`;

          const delay = Math.random() * 0.2;
          particle.style.animationDelay = delay + 's';
          document.body.appendChild(particle);

          setTimeout(() => {
            if (particle.parentNode === document.body) {
              document.body.removeChild(particle);
            }
          }, (800 + delay * 1000));
        }

        // åˆ›å»ºé£Ÿç‰©æ˜Ÿå½¢ç‰¹æ•ˆ
        for (let i = 0; i < 5; i++) {
          const star = document.createElement('div');
          star.className = 'food-star';
          const size = Math.random() * 15 + 10;
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          const angle = (i / 5) * 360;
          const distance = Math.random() * 50 + 30;
          star.style.left = (rect.left + rect.width / 2 + Math.cos(angle * Math.PI / 180) * distance) + 'px';
          star.style.top = (rect.top + rect.height / 2 + Math.sin(angle * Math.PI / 180) * distance) + 'px';
          star.style.setProperty('--star-distance', (Math.random() * 60 + 40) + 'px');
          const delay = Math.random() * 0.15;
          star.style.animationDelay = delay + 's';
          document.body.appendChild(star);

          setTimeout(() => {
            if (star.parentNode === document.body) {
              document.body.removeChild(star);
            }
          }, (1000 + delay * 1000));
        }

        // ä½¿ç”¨setTimeoutè§¦å‘åŠ¨ç”»
        setTimeout(() => {
          feedText.style.opacity = '1';
          feedText.style.top = (rect.top + rect.height / 2 - 60) + 'px';
          feedText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.5) rotate(-5deg)';
        }, 10);

        setTimeout(() => {
          feedText.style.opacity = '0';
          feedText.style.top = (rect.top + rect.height / 2 - 120) + 'px';
          feedText.style.transform = 'translateX(-50%) translateY(-50%) scale(1.3) rotate(5deg)';
        }, 500);

        setTimeout(() => {
          stallElement.classList.remove('feed-animation');
          // ç§»é™¤æ¼‚æµ®æ–‡å­—
          if (feedText.parentNode === document.body) {
            document.body.removeChild(feedText);
          }
          updateStallDisplay(stallElement, stall, stallIndex);
        }, 1500);
      }

      // æ›´æ–°æ˜¾ç¤º
      renderResources();
      const stallElement2 = document.querySelector(`[data-stall-index="${stallIndex}"]`);
      if (stallElement2) {
        updateStallDisplay(stallElement2, stall, stallIndex);
      }

      // æ›´æ–°å·¦ä¾§é¥²æ–™å¡ç‰Œæ˜¾ç¤º
      updateFeedDisplay();
      // æ›´æ–°ä»“åº“çª—å£
      const storageModal = document.getElementById('storageModal');
      if (storageModal && storageModal.classList.contains('active')) {
        populateStorageModal();
      }
      // æ›´æ–°å†œç”°çª—å£
      if (window.updateFarmlandRelatedResources) {
        window.updateFarmlandRelatedResources();
      }

      showNotification('å–‚é£ŸæˆåŠŸ', `ä½ å–‚å…»äº†åŠ¨ç‰©ï¼Œé¥±é£Ÿåº¦å¢åŠ 30ç‚¹ï¼`);
      updateGameData();
    }

    // åˆ›å»ºç‰²å£æ ä¸“ç”¨çš„æ°´è¢‹/æœ¨æ¡¶å¡ç‰Œå‡½æ•°
    function createLivestockWaterCard(resourceKey, resource) {
      const resourceCard = document.createElement('div');
      resourceCard.className = 'crafting-inventory-card';
      resourceCard.dataset.resourceType = resourceKey;
      resourceCard.style.cursor = 'grab';
      resourceCard.draggable = false;

      // å¤„ç†æœ¨æ¡¶å’Œæ°´è¢‹çš„ç‰¹æ®Šæ˜¾ç¤ºé€»è¾‘
      let displayImage = resource.image;
      let displayName = resource.name;
      if (resourceKey === 'bucket') {
        // æ ¹æ®waterLevelæˆ–instancesåŠ¨æ€è®¾ç½®å›¾ç‰‡
        let waterLevel = 0;
        if (resource.instances && resource.instances.length > 0) {
          waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        } else if (resource.waterLevel !== undefined) {
          waterLevel = resource.waterLevel;
        }

        // æœ¨æ¡¶ï¼ˆ5æ ¼ï¼Œæ¯æ ¼50å•ä½ï¼‰ï¼šæ°´ä½ = 0æ˜¾ç¤ºç©ºæœ¨æ¡¶ï¼Œæ°´ä½ > 0ï¼ˆ1-5æ ¼ï¼‰æ˜¾ç¤ºæ»¡æ°´æœ¨æ¡¶
        if (waterLevel > 0) {
          displayImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
        } else {
          displayImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
        }
        displayName = 'æœ¨æ¡¶';
      } else if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
        // æ ¹æ®å®ä¾‹ç³»ç»Ÿæˆ–waterLevelåŠ¨æ€è®¾ç½®æ°´è¢‹å›¾ç‰‡
        let waterLevel = 0;
        if (resource.instances && resource.instances.length > 0) {
          waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        } else if (resource.waterLevel !== undefined) {
          waterLevel = resource.waterLevel;
        }

        if (waterLevel > 0) {
          displayImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
        } else {
          displayImage = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
        }
        displayName = 'æ°´è¢‹';
      }

      // èµ„æºå›¾ç‰‡
      const resourceImage = document.createElement('div');
      resourceImage.className = 'crafting-card-image';
      resourceImage.style.backgroundImage = `url('${displayImage}')`;
      resourceImage.style.position = 'relative';
      resourceImage.style.overflow = 'visible';

      // ä¸ºæœ¨æ¡¶æ·»åŠ æ°´ä½æŒ‡ç¤ºæ¡ï¼ˆåœ¨å›¾ç‰‡å·¦ä¾§ï¼‰
      if (resourceKey === 'bucket') {
        let waterLevel = 0;
        if (resource.instances && resource.instances.length > 0) {
          waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        } else if (resource.waterLevel !== undefined) {
          waterLevel = resource.waterLevel;
        }

        const waterIndicator = document.createElement('div');
        waterIndicator.className = 'water-level-indicator-backpack';
        waterIndicator.style.cssText = `
          position: absolute;
          left: -4px;
          top: 50%;
          transform: translateY(-50%);
          width: 12px;
          height: 70px;
          display: flex;
          flex-direction: column;
          gap: 2px;
          z-index: 10;
        `;

        // åˆ›å»º5ä¸ªæ°´ä½æ ¼
        const filledLevels = Math.floor(waterLevel / 50);

        for (let i = 0; i < 5; i++) {
          const waterCell = document.createElement('div');
          const isFilled = i >= (5 - filledLevels);
          waterCell.style.cssText = `
            flex: 1;
            border: 1px solid #8B4513;
            background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'};
            border-radius: 2px;
            transition: background-color 0.3s ease;
          `;
          waterIndicator.appendChild(waterCell);
        }

        resourceImage.appendChild(waterIndicator);
      }

      // ä¸ºæ°´è¢‹æ·»åŠ æ°´ä½æŒ‡ç¤ºæ¡ï¼ˆåœ¨å›¾ç‰‡å·¦ä¾§ï¼‰
      if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
        let waterLevel = 0;
        if (resource.instances && resource.instances.length > 0) {
          waterLevel = resource.instances.reduce((sum, inst) => sum + (inst.waterLevel || 0), 0);
        } else if (resource.waterLevel !== undefined) {
          waterLevel = resource.waterLevel;
        }

        const waterIndicator = document.createElement('div');
        waterIndicator.className = 'water-level-indicator-backpack';
        waterIndicator.style.cssText = `
          position: absolute;
          left: -4px;
          top: 50%;
          transform: translateY(-50%);
          width: 12px;
          height: 70px;
          display: flex;
          flex-direction: column;
          gap: 2px;
          z-index: 10;
        `;

        // æ°´è¢‹ï¼šæ»¡æ°´é‡100ï¼Œæ¯æ ¼20
        const filledLevels = Math.floor(waterLevel / 20);

        for (let i = 0; i < 5; i++) {
          const waterCell = document.createElement('div');
          const isFilled = i >= (5 - filledLevels);
          waterCell.style.cssText = `
            flex: 1;
            border: 1px solid #8B4513;
            background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'};
            border-radius: 2px;
            transition: background-color 0.3s ease;
          `;
          waterIndicator.appendChild(waterCell);
        }

        resourceImage.appendChild(waterIndicator);
      }

      resourceCard.appendChild(resourceImage);

      // ä¸ºæ°´è¢‹å’Œæœ¨æ¡¶æ·»åŠ ç«–ç€æ˜¾ç¤ºçš„è€ä¹…åº¦æ¡
      if (resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag' || resourceKey === 'bucket') {
        let durability = resource.durability;
        if (resource.instances && resource.instances.length > 0) {
          const totalDurability = resource.instances.reduce((sum, inst) => sum + (inst.durability || 100), 0);
          durability = Math.round(totalDurability / resource.instances.length);
        }

        if (durability !== undefined) {
          const durabilityContainer = document.createElement('div');
          durabilityContainer.className = 'card-durability';
          durabilityContainer.style.cssText = `
            position: absolute;
            right: 4px;
            top: 34px;
            width: 4px;
            height: 45px;
            background-color: #E2E8F0;
            border-radius: 2px;
            overflow: hidden;
            z-index: 10;
          `;

          const durabilityBar = document.createElement('div');
          durabilityBar.className = 'durability-bar';
          durabilityBar.style.cssText = `
            width: 100%;
            background-color: ${durability > 50 ? '#38A169' : durability > 20 ? '#D69E2E' : '#E53E3E'};
            position: absolute;
            left: 0;
            bottom: 0;
            border-radius: 0 0 2px 2px;
            transition: height 0.3s ease;
            height: ${durability}%;
          `;

          durabilityContainer.appendChild(durabilityBar);
          resourceCard.appendChild(durabilityContainer);
        }
      }

      // èµ„æºåç§°å’Œæ•°é‡
      const resourceName = document.createElement('div');
      resourceName.className = 'crafting-card-title';
      resourceName.textContent = displayName;
      resourceCard.appendChild(resourceName);

      // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
      resourceCard.addEventListener('mousedown', function(e) {
        e.preventDefault();

        // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ°´è€Œä¸æ˜¯æ£€æŸ¥æ•°é‡
        if (resourceKey === 'bucket' || resourceKey === 'water_bag' || resourceKey === 'water_bag_full' || resourceKey === 'empty_water_bag') {
          const totalWater = getContainerTotalWater(resourceKey);
          if (totalWater <= 0) {
            showNotification('æ²¡æœ‰æ°´', `${displayName}é‡Œæ²¡æœ‰æ°´ï¼Œè¯·å…ˆè£…æ°´ï¼`);
            return;
          }
        } else {
          const resourceAmount = gameData.resources[resourceKey]?.amount || 0;
          if (resourceAmount <= 0) {
            showNotification('èµ„æºä¸è¶³', `ä½ æ²¡æœ‰${displayName}ï¼`);
            return;
          }
        }

        // åˆ›å»ºç‰²å£å…‰æ ‡
        createLivestockCursor(resourceKey, 'feed');
      });

      return resourceCard;
    }

    // æ›´æ–°é¥²æ–™æ˜¾ç¤ºå‡½æ•°
    function updateFeedDisplay() {
      const feedContainer = document.getElementById('livestock-feed-container');
      if (!feedContainer) return;

      // æ¸…ç©ºç°æœ‰å†…å®¹
      feedContainer.innerHTML = '';

      // å®šä¹‰å…»æ®–ç”¨å“èµ„æºIDåˆ—è¡¨ï¼ˆåŒ…æ‹¬è¯ä¸¸å’Œæ‰«å¸šï¼Œæ’é™¤empty_bucketï¼Œå®ƒåªæ˜¯bucketçš„å¼•ç”¨ï¼‰
      const breedingResources = [
        'animal_feed',     // é€šç”¨é¥²æ–™
        'pill',            // è¯ä¸¸
        'broom',           // æ‰«å¸š
        'bucket',          // æ°´æ¡¶
        'water_bag',       // æ°´è¢‹
        'water_bag_full',  // æ°´è¢‹ï¼ˆæ»¡æ°´ï¼‰
        'empty_water_bag', // æ°´è¢‹ï¼ˆæ°´é‡0ï¼‰
        'fertilizer'       // è‚¥æ–™
      ];

      // ç¡®ä¿æ‰€æœ‰èµ„æºéƒ½å­˜åœ¨
      if (!gameData.resources.animal_feed) {
        gameData.resources.animal_feed = { name: 'é€šç”¨é¥²æ–™', description: 'ç”¨äºå–‚å…»åŠ¨ç‰©çš„é¥²æ–™ï¼Œå¯ä»¥ç»´æŒåŠ¨ç‰©çš„å¥åº·', amount: 0, image: 'UI/é€šç”¨é¥²æ–™.jpg', category: 'material' };
      }

      // åªæ˜¾ç¤ºæ•°é‡å¤§äº0æˆ–æœ‰æ°´çš„å…»æ®–ç”¨å“å¡ç‰Œ
      breedingResources.forEach(resourceId => {
        const resource = gameData.resources[resourceId];
        
        // å¦‚æœèµ„æºä¸å­˜åœ¨ï¼Œè·³è¿‡
        if (!resource) {
          console.warn(`updateFeedDisplay: èµ„æº ${resourceId} ä¸å­˜åœ¨ï¼Œè·³è¿‡`);
          return;
        }
        
        // å¯¹äºæ°´è¢‹å’Œæœ¨æ¡¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ°´æˆ–æ•°é‡å¤§äº0
        const isWaterContainer = (resourceId === 'bucket' || resourceId === 'water_bag' || resourceId === 'water_bag_full' || resourceId === 'empty_water_bag');
        let shouldDisplay = false;
        if (isWaterContainer) {
          // æ£€æŸ¥æ˜¯å¦æœ‰æ°´æˆ–æ•°é‡å¤§äº0
          let hasWater = false;
          if (resource.waterLevel !== undefined && resource.waterLevel > 0) {
            hasWater = true;
          }
          if (resource.instances && resource.instances.length > 0) {
            hasWater = resource.instances.some(inst => inst.waterLevel > 0);
          }
          shouldDisplay = hasWater || (resource.amount > 0);
        } else {
          // å…¶ä»–ç‰©å“ï¼Œåªæ£€æŸ¥æ•°é‡
          shouldDisplay = resource && resource.amount > 0;
        }

        if (shouldDisplay) {
          // å¦‚æœæ˜¯æ‰«å¸šï¼Œä½¿ç”¨ç‰¹æ®Šçš„å¡ç‰Œåˆ›å»ºå‡½æ•°
          if (resourceId === 'broom') {
            const broomCard = createBroomCard(resourceId, resource);
            broomCard.style.width = '100px';
            broomCard.style.height = '120px';
            broomCard.style.margin = '0.25rem';
            feedContainer.appendChild(broomCard);
          } else {
            // å¯¹äºæ°´è¢‹ã€æœ¨æ¡¶ç­‰å®¹å™¨ï¼Œä½¿ç”¨å†œç”°çª—å£ä¸“ç”¨çš„å¡ç‰Œåˆ›å»ºå‡½æ•°ï¼ˆæ›´å®Œå–„çš„å›¾ç‰‡å’Œæ°´ä½æŒ‡ç¤ºæ¡å¤„ç†ï¼‰
            if (resourceId === 'water_bag' || resourceId === 'water_bag_full' || resourceId === 'empty_water_bag' || resourceId === 'bucket') {
              const resourceCard = createLivestockWaterCard(resourceId, resource);
              resourceCard.style.width = '100px';
              resourceCard.style.height = '120px';
              resourceCard.style.margin = '0.25rem';
              feedContainer.appendChild(resourceCard);
            } else {
              const resourceCard = createResourceCard(resourceId, resource, false);

              // ç¡®ä¿å¡ç‰Œæœ‰æ­£ç¡®çš„æ ·å¼å’Œå°ºå¯¸
              resourceCard.style.width = '100px';
              resourceCard.style.height = '120px';
              resourceCard.style.margin = '0.25rem';

              // ç¡®ä¿æ°´ä½æŒ‡ç¤ºæ¡çš„å®¹å™¨æœ‰æ­£ç¡®çš„æ ·å¼ï¼ˆå…è®¸è¶…å‡ºè¾¹ç•Œæ˜¾ç¤ºï¼‰
              const resourceImage = resourceCard.querySelector('.crafting-card-image');
              if (resourceImage) {
                resourceImage.style.position = 'relative';
                resourceImage.style.overflow = 'visible';
              }

              // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - åˆ›å»ºè‡ªå®šä¹‰å…‰æ ‡
              resourceCard.addEventListener('mousedown', function(e) {
                e.preventDefault();
                const resourceAmount = gameData.resources[resourceId]?.amount || 0;
                if (resourceAmount <= 0) {
                  showNotification('èµ„æºä¸è¶³', `ä½ æ²¡æœ‰${resource.name}ï¼`);
                  return;
                }

                // æ£€æŸ¥æ‰«å¸šè€ä¹…åº¦
                if (resourceId === 'broom' && resource.durability !== undefined && resource.durability <= 0) {
                  showNotification('æ‰«å¸šå·²æŸå', 'æ‰«å¸šè€ä¹…åº¦å·²è€—å°½ï¼');
                  return;
                }

                // åˆ›å»ºç‰²å£å…‰æ ‡ï¼ˆåŒ…æ‹¬é¥²æ–™ã€è¯ä¸¸ã€æ°´æ¡¶ã€æ°´è¢‹ã€è‚¥æ–™ï¼‰
                createLivestockCursor(resourceId, 'feed');
              });

              feedContainer.appendChild(resourceCard);
            }
          }
        }
      });
    }

    // æ˜¾ç¤ºé©¬å©æ¨¡æ€æ¡†
    function showStableModal() {
      console.log('æ˜¾ç¤ºé©¬å©æ¨¡æ€æ¡†è¢«è°ƒç”¨');
      
      // ç¡®ä¿åŠ¨ç”»ç‰¹æ•ˆå‡½æ•°å’ŒCSSæ ·å¼è¢«æ­£ç¡®åˆå§‹åŒ–
      if (typeof initializeAnimationCSS === 'function') {
        initializeAnimationCSS();
        console.log('é©¬å©çª—å£ï¼šåŠ¨ç”»CSSæ ·å¼åˆå§‹åŒ–å®Œæˆ');
      }
      if (typeof initializeAnimationEffects === 'function') {
        initializeAnimationEffects();
        console.log('é©¬å©çª—å£ï¼šåŠ¨ç”»ç‰¹æ•ˆå‡½æ•°åˆå§‹åŒ–å®Œæˆ');
      }
      
      // åœ¨æ‰“å¼€é©¬å©æ¨¡æ€æ¡†ä¹‹å‰ï¼Œæ¸…ç†æ‰€æœ‰é—ç•™çš„tooltip
      hideLivestockTooltip();
      hideStableTooltip();
      
      // è·å–å½“å‰çš„é©¬å©æ•°æ®
      const stableData = gameData.stableData;
      
      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'stable-modal';
      modalContainer.id = 'stableModal';
      
      // åˆ›å»ºå¼¹çª—å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
      const modalContent = document.createElement('div');
      modalContent.className = 'stable-modal-content ink-border';
      
      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'stable-modal-header';
      
      // åˆ›å»ºæ ‡é¢˜ï¼Œä½¿ç”¨ink-textæ ·å¼
      const title = document.createElement('h2');
      title.className = 'stable-modal-title ink-text';
      title.textContent = 'é©¬å©ç®¡ç†';
      modalHeader.appendChild(title);
      
      // åˆ›å»ºå…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.className = 'stable-modal-close';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = function() {
        // æ¸…é™¤é©¬å©æ å’Œç‰²å£æ çš„æ‚¬åœæç¤º
        hideStableTooltip();
        hideLivestockTooltip();
        // æ¸…é™¤å®šæ—¶å™¨
        if (window.stableHoverTimer) {
          clearTimeout(window.stableHoverTimer);
          window.stableHoverTimer = null;
        }
        if (window.livestockHoverTimer) {
          clearTimeout(window.livestockHoverTimer);
          window.livestockHoverTimer = null;
        }
        window.stableTooltipVisible = false;
        window.livestockTooltipVisible = false;

        // ç§»é™¤æ‰€æœ‰é©¬å©æ çš„tooltipå…ƒç´ 
        const allStableTooltips = document.querySelectorAll('#stable-tooltip, .stable-tooltip-element');
        allStableTooltips.forEach(tooltip => {
          if (tooltip.parentNode) {
            tooltip.remove();
          }
        });

        // ç§»é™¤æ‰€æœ‰ç‰²å£æ çš„tooltipå…ƒç´ 
        const allLivestockTooltips = document.querySelectorAll('#livestock-tooltip, .livestock-tooltip-element');
        allLivestockTooltips.forEach(tooltip => {
          if (tooltip.parentNode) {
            tooltip.remove();
          }
        });

        // æ›´æ–°èƒŒåŒ…æ æ˜¾ç¤º
        if (typeof renderResources === 'function') {
          renderResources();
        }

        modalContainer.classList.remove('active');
        setTimeout(() => {
          // ä¿å­˜é©¬å©æ•°æ®
          gameData.stableData = stableData;
          updateGameData();
          modalContainer.remove();
        }, 300);
      };
      modalHeader.appendChild(closeButton);
      
      modalContent.appendChild(modalHeader);
      
      // åˆ›å»ºä¸»ä½“åŒºåŸŸï¼Œåˆ†ä¸ºå·¦å³ä¸¤æ 
      const modalBody = document.createElement('div');
      modalBody.className = 'stable-modal-body';
      modalBody.style.display = 'flex';
      modalBody.style.gap = '20px';
      
      // å·¦ä¾§ï¼šé©¬ç±»å¡ç‰Œã€å…»æ®–ç”¨å“å’Œäº§å‡ºç”¨å“
      const leftPanel = document.createElement('div');
      leftPanel.className = 'stable-left';
      leftPanel.style.padding = '1rem';
      leftPanel.style.width = '40%';
      
      // é©¬ç±»å¡ç‰Œæ ‡é¢˜
      const horseTitle = document.createElement('h3');
      horseTitle.className = 'stable-section-title';
      horseTitle.textContent = 'é©¬åŒ¹';
      leftPanel.appendChild(horseTitle);
      
      // é©¬ç±»å¡ç‰Œå®¹å™¨
      const horseContainer = document.createElement('div');
      horseContainer.className = 'stable-inventory';
      horseContainer.style.display = 'flex';
      horseContainer.style.flexWrap = 'wrap';
      horseContainer.style.gap = '0.5rem';
      horseContainer.style.padding = '0.5rem';
      horseContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
      horseContainer.style.borderRadius = '0.5rem';
      horseContainer.style.marginBottom = '1rem';
      horseContainer.style.maxHeight = '200px';
      horseContainer.style.overflowY = 'auto';
      horseContainer.id = 'stable-horse-container';
      
      // æ·»åŠ é©¬ç±»å¡ç‰Œï¼ˆåªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„å¡ç‰Œï¼‰
      const horseIds = ['native_horse', 'mongolian_horse', 'hequ_horse', 'ferghana_horse', 'super_ferghana_horse'];
      horseIds.forEach(horseId => {
        const horseAmount = gameData.resources[horseId]?.amount || 0;
        if (horseAmount > 0) {
          const horseCard = createHorseCard(horseId, stableData.horses[horseId]);
          horseContainer.appendChild(horseCard);
        }
      });
      
      leftPanel.appendChild(horseContainer);
      
      // ä¸ºé©¬åŒ¹å®¹å™¨æ·»åŠ æ»šåŠ¨æ¡
      const horseScrollbar = document.createElement('div');
      horseScrollbar.className = 'resource-scrollbar';
      horseScrollbar.innerHTML = '<div class="resource-scrollbar-thumb"></div>';
      leftPanel.appendChild(horseScrollbar);
      
      // å…»æ®–ç”¨å“æ ‡é¢˜
      const feedTitle = document.createElement('h3');
      feedTitle.className = 'stable-section-title';
      feedTitle.textContent = 'å…»æ®–ç”¨å“';
      leftPanel.appendChild(feedTitle);
      
      // å…»æ®–ç”¨å“å®¹å™¨
      const feedContainer = document.createElement('div');
      feedContainer.className = 'stable-inventory';
      feedContainer.style.display = 'flex';
      feedContainer.style.flexWrap = 'wrap';
      feedContainer.style.gap = '0.5rem';
      feedContainer.style.padding = '0.5rem';
      feedContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
      feedContainer.style.borderRadius = '0.5rem';
      feedContainer.style.maxHeight = '200px';
      feedContainer.style.overflowY = 'auto';
      
      // æ·»åŠ å…»æ®–ç”¨å“å¡ç‰Œ
      const feedIds = ['grass_feed', 'pill', 'bucket', 'water_bag', 'empty_water_bag', 'fertilizer'];
      feedIds.forEach(feedId => {
        const feedAmount = gameData.resources[feedId]?.amount || 0;
        if (feedAmount > 0) {
          const feedCard = createFeedCard(feedId);
          feedContainer.appendChild(feedCard);
        }
      });
      
      // æ·»åŠ å…»æ®–ç”¨å“å¡ç‰Œæ›´æ–°å‡½æ•°ï¼Œç”¨äºå®æ—¶æ›´æ–°å…»æ®–ç”¨å“å¡ç‰Œæ˜¾ç¤ºçŠ¶æ€
      window.updateStableFeedCards = function() {
        console.log('å¼€å§‹æ›´æ–°é©¬å©çª—å£å…»æ®–ç”¨å“å¡ç‰Œæ˜¾ç¤ºçŠ¶æ€');
        
        // è·å–é©¬å©çª—å£
        const stableModal = document.getElementById('stableModal');
        if (!stableModal) {
          console.warn('é©¬å©çª—å£æœªæ‰¾åˆ°ï¼Œæ— æ³•æ›´æ–°å…»æ®–ç”¨å“å¡ç‰Œ');
          return;
        }
        
        // æŸ¥æ‰¾å…»æ®–ç”¨å“å®¹å™¨
        const feedContainers = stableModal.querySelectorAll('.stable-inventory');
        let feedContainer = null;
        for (const container of feedContainers) {
          // æ£€æŸ¥å®¹å™¨ä¸­æ˜¯å¦æœ‰å…»æ®–ç”¨å“å¡ç‰Œ
          if (container.querySelector('[data-feed="grass_feed"]') ||
              container.querySelector('[data-feed="pill"]') ||
              container.querySelector('[data-feed="bucket"]') ||
              container.querySelector('[data-feed="water_bag"]') ||
              container.querySelector('[data-feed="fertilizer"]')) {
            feedContainer = container;
            break;
          }
        }
        
        if (!feedContainer) {
          console.warn('å…»æ®–ç”¨å“å®¹å™¨æœªæ‰¾åˆ°');
          return;
        }
        
        // æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºå…»æ®–ç”¨å“å¡ç‰Œ
        feedContainer.innerHTML = '';
        
        const feedIds = ['grass_feed', 'pill', 'bucket', 'water_bag', 'water_bag_full', 'empty_water_bag', 'fertilizer'];
        feedIds.forEach(feedId => {
          const feedAmount = gameData.resources[feedId]?.amount || 0;
          if (feedAmount > 0) {
            const feedCard = createFeedCard(feedId);
            feedContainer.appendChild(feedCard);
          }
        });
        
        console.log('å…»æ®–ç”¨å“å¡ç‰Œæ›´æ–°å®Œæˆ');
      };
      
      leftPanel.appendChild(feedContainer);
      
      // ä¸ºå…»æ®–ç”¨å“å®¹å™¨æ·»åŠ æ»šåŠ¨æ¡
      const stableFeedScrollbar = document.createElement('div');
      stableFeedScrollbar.className = 'resource-scrollbar';
      stableFeedScrollbar.innerHTML = '<div class="resource-scrollbar-thumb"></div>';
      leftPanel.appendChild(stableFeedScrollbar);
      
      // å³ä¾§ï¼šé©¬å©åŒºåŸŸï¼ˆå››ä¸ªæ ä½ï¼‰
      const rightPanel = document.createElement('div');
      rightPanel.className = 'stable-right';
      rightPanel.style.width = '60%';

      // åˆ›å»ºæ ‡é¢˜å’Œå‡çº§æŒ‰é’®çš„å®¹å™¨
      const titleContainer = document.createElement('div');
      titleContainer.style.display = 'flex';
      titleContainer.style.justifyContent = 'space-between';
      titleContainer.style.alignItems = 'center';
      titleContainer.style.marginBottom = '15px';

      const stableTitle = document.createElement('h3');
      stableTitle.className = 'stable-panel-title ink-text';
      stableTitle.textContent = 'é©¬å©æ ';
      stableTitle.style.margin = '0';
      titleContainer.appendChild(stableTitle);

      // æ·»åŠ å‡çº§æŒ‰é’®
      const upgradeBtn = document.createElement('button');
      upgradeBtn.className = 'upgrade-btn ink-button-small ink-button';
      upgradeBtn.id = 'stable-upgrade-btn';
      upgradeBtn.style.marginLeft = '10px';
      upgradeBtn.style.fontSize = '0.9rem';
      upgradeBtn.style.padding = '0.5rem 1rem';
      titleContainer.appendChild(upgradeBtn);

      // æ›´æ–°å‡çº§æŒ‰é’®æ˜¾ç¤ºçš„å‡½æ•°
      window.updateStableUpgradeBtn = function() {
        const level = gameData.stableData?.level || 1;
        if (level >= 4) {
          upgradeBtn.innerHTML = `<span>ç­‰çº§å·²è¾¾æ»¡çº§</span>`;
          upgradeBtn.disabled = true;
          upgradeBtn.style.opacity = '0.5';
        } else {
          upgradeBtn.innerHTML = `<span id="stable-level-text">${level}çº§</span><span class="upgrade-icon">â¬†ï¸</span> å‡çº§`;
          upgradeBtn.disabled = false;
          upgradeBtn.style.opacity = '1';
        }
      };
      updateStableUpgradeBtn();

      // å‡çº§æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      upgradeBtn.onclick = function() {
        showStableUpgradeModal();
      };

      rightPanel.appendChild(titleContainer);

      const stallsContainer = document.createElement('div');
      stallsContainer.className = 'stable-stalls';
      stallsContainer.style.display = 'grid';
      stallsContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
      stallsContainer.style.gridTemplateRows = 'repeat(2, 1fr)';
      stallsContainer.style.gap = '15px';
      
      // åˆ›å»º4ä¸ªé©¬å©æ 
      for (let i = 0; i < 4; i++) {
        const stall = createStableStall(i, stableData.stalls[i]);
        stallsContainer.appendChild(stall);
      }
      
      rightPanel.appendChild(stallsContainer);
      
      modalBody.appendChild(leftPanel);
      modalBody.appendChild(rightPanel);
      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      
      // åˆå§‹åŒ–å…¨å±€å˜é‡
      window.selectedHorse = null;
      window.selectedFeed = null;
      
      // æ·»åŠ åˆ°æ–‡æ¡£
      document.body.appendChild(modalContainer);
      
      // åˆå§‹åŒ–é©¬åŒ¹å¡ç‰Œæ˜¾ç¤ºçŠ¶æ€
      // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²ç»å®Œå…¨æ„å»º
      setTimeout(() => {
        if (window.updateHorseCards) {
          window.updateHorseCards();
        }
        if (window.updateStableFeedCards) {
          window.updateStableFeedCards();
        }
        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        if (window.initializeStableScrollbars) {
          window.initializeStableScrollbars();
        }
      }, 10);
      
      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .stable-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }
        
        .stable-modal.active {
          opacity: 1;
          visibility: visible;
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
        }
        
        .stable-modal-content {
          background-color: #FFFDF7;
          border-radius: 0.25rem;
          width: 95%;
          max-width: 900px;
          padding: 1.5rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          transform: translateY(-20px);
          transition: all 0.3s ease;
        }
        
        .stable-modal.active .stable-modal-content {
          transform: translateY(0);
        }
        
        .stable-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
        }
        
        .stable-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .stable-modal-close {
          background: none;
          border: none;
          font-size: 1.25rem;
          cursor: pointer;
          color: #4A5568;
        }
        
        .stable-section-title {
          font-size: 1.2rem;
          font-weight: normal;
          margin-bottom: 0.75rem;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .stable-panel-title {
          font-size: 1.2rem;
          font-weight: normal;
          color: #2D3748;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        /* é©¬å©æ»šåŠ¨æ¡æ ·å¼ */
        .stable-inventory::-webkit-scrollbar {
          width: 8px;
        }
        
        .stable-inventory::-webkit-scrollbar-track {
          background: rgba(0, 0, 0, 0.05);
          border-radius: 4px;
        }
        
        .stable-inventory::-webkit-scrollbar-thumb {
          background: #8D6E63;
          border-radius: 4px;
        }
        
        .stable-inventory::-webkit-scrollbar-thumb:hover {
          background: #6D4C41;
        }
        
        /* é©¬å©æ æ ·å¼ - ç«‹ä½“æ•ˆæœ */
        .stable-stall {
          width: 200px;
          height: 200px;
          border: 2px solid #8D6E63;
          border-radius: 0.5rem;
          background-image: url('UI/é©¬å©.jpg');
          background-size: cover;
          background-position: center;
          position: relative;
          display: flex;
          flex-direction: column;
          transition: all 0.3s ease;
          overflow: visible; /* ç¡®ä¿æµ‡æ°´ç‰¹æ•ˆå¯ä»¥è¶…å‡ºè¾¹ç•Œæ˜¾ç¤º */
          /* ç«‹ä½“æ•ˆæœ */
          box-shadow:
            0 8px 6px -6px rgba(0, 0, 0, 0.5),
            0 2px 4px rgba(0, 0, 0, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.3),
            inset 0 -1px 0 rgba(0, 0, 0, 0.2);
          cursor: pointer; /* é»˜è®¤æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
        }

        .stable-stall:hover {
          transform: translateY(-8px);
          box-shadow:
            0 12px 10px -8px rgba(0, 0, 0, 0.6),
            0 4px 8px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.4),
            inset 0 -1px 0 rgba(0, 0, 0, 0.3);
          cursor: pointer; /* æ‚¬åœæ—¶æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
        }

        /* æ”¾ç½®é©¬åŒ¹æ—¶çš„å¼¹è·³åŠ¨ç”» - æé«˜ä¼˜å…ˆçº§ */
        .stable-stall.placing {
          animation: place-bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
        }

        @keyframes place-bounce {
          0% {
            transform: scale(0.3) translateY(50px);
            opacity: 0;
          }
          25% {
            transform: scale(1.1) translateY(-10px);
            opacity: 1;
          }
          70% {
            transform: scale(0.95) translateY(5px);
          }
          100% {
            transform: scale(1) translateY(0);
          }
        }

        /* æ”¾ç½®æˆåŠŸæ—¶çš„é—ªå…‰ç‰¹æ•ˆ */
        .stable-stall.flash {
          position: relative;
        }

        .stable-stall.flash::after {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, transparent 70%);
          animation: flash-effect 0.8s ease-out forwards;
          pointer-events: none;
          z-index: 100;
        }

        @keyframes flash-effect {
          0% {
            opacity: 1;
            transform: scale(0);
          }
          50% {
            opacity: 0.8;
            transform: scale(1);
          }
          100% {
            opacity: 0;
            transform: scale(1.5);
          }
        }


        
        .stable-stall.active {
          border-color: #805AD5;
          box-shadow: 
            0 0 15px rgba(128, 90, 213, 0.5),
            0 8px 6px -6px rgba(128, 90, 213, 0.3),
            0 2px 4px rgba(128, 90, 213, 0.2),
            inset 0 0 10px rgba(128, 90, 213, 0.2);
        }
        
        .stable-stall-content {
          padding: 0px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          width: 100%;
          position: relative;
          z-index: auto; /* æ”¹ä¸ºautoï¼Œä¸ç‰²å£æ ä¿æŒä¸€è‡´ï¼Œé¿å…åˆ›å»ºå †å ä¸Šä¸‹æ–‡ */
          pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€å­å…ƒç´ ï¼Œç›´æ¥è§¦å‘çˆ¶å…ƒç´ çš„mouseenter/mouseleaveäº‹ä»¶ */
        }
        
        .stable-horse-image {
          width: 180px;
          height: 120px;
          object-fit: cover;
          border-radius: 0.25rem;
          margin-bottom: 0.5rem;
          transform-origin: center center;
        }
        
        .stable-horse-name {
          font-size: 1.2rem;
          font-weight: normal;
          color: #2D3748;
          margin-top: 10px;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
          text-align: center;
        }
        
        /* æ‚¬åœçŠ¶æ€æ˜¾ç¤º - ä¸å†œç”°æ ¼å­æ ·å¼ä¸€è‡´ */
        .hover-status {
          position: fixed;
          background-color: rgba(0, 0, 0, 0.85);
          backdrop-filter: blur(5px);
          color: #F7FAFC;
          padding: 12px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          font-size: 0.8rem;
          width: 220px;
          z-index: 2000;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
          pointer-events: auto;
        }
        
        /* ç§»é™¤åŸæ¥çš„:hoverä¼ªç±»æ§åˆ¶ï¼Œç”±JavaScriptæ§åˆ¶ */
        
        .hover-status-title {
          font-weight: bold;
          font-size: 16px;
          margin-bottom: 8px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
          padding-bottom: 6px;
          text-align: center;
          color: #F7FAFC;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

        .hover-status-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 6px;
          font-size: 0.8rem;
          color: rgba(255, 255, 255, 0.8);
        }

        .hover-status-value {
          font-weight: bold;
          color: #F7FAFC;
        }
        
        .hover-status-bar {
          width: 80px;
          height: 8px;
          background-color: rgba(255, 255, 255, 0.2);
          border-radius: 4px;
          margin-left: 0.5rem;
          overflow: hidden;
        }

        .hover-status-fill {
          height: 100%;
          border-radius: 4px;
          transition: width 0.3s ease;
        }

        .hover-health-fill {
          background-color: #38A169;
        }

        .hover-satiety-fill {
          background-color: #ED8936;
        }

        .stable-cleanliness-fill {
          background-color: #3182CE;
        }
        
        .stable-clean-indicator {
          position: absolute;
          bottom: 2px;
          right: 2px;
          width: 20px;
          height: 20px;
          background-color: #3182CE;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 0.6rem;
          cursor: pointer;
          z-index: 10;
        }
        
        .stable-feed-button {
          position: absolute;
          bottom: 2px;
          left: 2px;
          width: 20px;
          height: 20px;
          background-color: #ED8936;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.6rem;
          cursor: pointer;
          z-index: 10;
        }
        
        /* é©¬åŒ¹å¡ç‰Œæ ·å¼ */
        .stable-horse-card {
          width: 100px;
          height: 120px;
          border: 2px solid #8D6E63;
          border-radius: 0.5rem;
          background-color: #FFFDF7;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 0.5rem;
          cursor: grab;
          transition: all 0.3s ease;
        }
        
        .stable-horse-card:hover {
          transform: scale(1.05);
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stable-horse-card.dragging {
          opacity: 0.5;
          cursor: grabbing;
        }
        
        .stable-horse-card-image {
          width: 60px;
          height: 60px;
          object-fit: cover;
          border-radius: 0.25rem;
          margin-bottom: 0.25rem;
        }
        
        .stable-horse-card-name {
          font-size: 0.875rem;
          font-weight: normal;
          color: #2D3748;
          text-align: center;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .stable-horse-card-count {
          font-size: 0.75rem;
          color: #4A5568;
        }
        
        /* é¥²æ–™å¡ç‰Œæ ·å¼ */
        .stable-feed-card {
          width: 100px;
          height: 120px;
          border: 2px solid #8D6E63;
          border-radius: 0.5rem;
          background-color: #FFFDF7;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 0.5rem;
          cursor: grab;
          transition: all 0.3s ease;
        }
        
        .stable-feed-card:hover {
          transform: scale(1.05);
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stable-feed-card.dragging {
          opacity: 0.5;
          cursor: grabbing;
        }
        
        .stable-feed-card-image-container {
          position: relative;
          width: 100%;
          height: 70px;
          margin-bottom: 0.5rem;
          display: flex;
          justify-content: center;
          align-items: center;
          background-color: #E2E8F0;
          border-radius: 0.25rem;
          background-size: cover;
          background-position: center;
        }

        .stable-feed-card-image {
          width: 100%;
          height: 70px;
          object-fit: cover;
          border-radius: 0.25rem;
        }
        
        .stable-feed-card-name {
          font-size: 0.75rem;
          font-weight: normal;
          color: #2D3748;
          text-align: center;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .stable-feed-card-count {
          font-size: 0.625rem !important;
          color: #4A5568 !important;
          font-weight: normal !important;
        }

        .stable-feed-card-durability {
      font-size: 0.7rem;
      color: #ED8936;
    }

    /* ç¡®ä¿ç‰²å£æ£šçª—å£æ°´ä½æŒ‡ç¤ºæ¡å§‹ç»ˆå¯è§ */
    .stable-feed-card .water-level-indicator-backpack {
      opacity: 1 !important;
      display: flex !important;
      visibility: visible !important;
    }

    .stable-feed-card .water-level-indicator-backpack > div {
      opacity: 1 !important;
      visibility: visible !important;
    }
        
        /* å·¥å…·æç¤ºæ ·å¼ */
        .stable-tooltip {
          position: fixed;
          background-color: rgba(45, 55, 72, 0.95);
          backdrop-filter: blur(5px);
          color: #F7FAFC;
          padding: 12px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          font-size: 0.8rem;
          max-width: 220px;
          z-index: 2000;
          opacity: 0;
          transform: translateY(-5px);
          animation: fadeInTooltip 0.3s ease-out forwards;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
          pointer-events: auto; /* å…è®¸é¼ æ ‡ä¸å·¥å…·æç¤ºäº¤äº’ */
        }
        
        .stable-tooltip-title {
          font-weight: bold;
          font-size: 16px;
          margin-bottom: 8px;
          border-bottom: 1px solid rgba(255,255,255,0.3);
          padding-bottom: 6px;
        }
        
        .stable-tooltip-info {
          margin: 5px 0;
          display: block;
        }
        
        .stable-tooltip-info div {
          margin-bottom: 0.25rem;
        }
        
        .stable-tooltip-action {
          margin-top: 0.5rem;
          padding-top: 0.25rem;
          border-top: 1px solid rgba(255,255,255,0.3);
          color: white;
          font-style: italic;
        }
        
        .tooltip-label {
          color: rgba(255,255,255,0.8);
        }
        
        .tooltip-value {
          font-weight: bold;
        }
        
        .status-good { color: #4CAF50; }
        .status-warning { color: #FFC107; }
        .status-danger { color: #F44336; }

        /* æœªè§£é”çš„æ ä½æ ·å¼ */
        .livestock-stall.locked,
        .stable-stall.locked {
          opacity: 0.5;
          cursor: not-allowed;
          filter: grayscale(80%);
          pointer-events: none;
        }

        .livestock-stall.locked:hover,
        .stable-stall.locked:hover {
          transform: none;
          box-shadow: none;
          cursor: not-allowed;
        }

        .stall-lock-icon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 48px;
          text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
          z-index: 20;
        }

        /* æµ‡æ°´ç‰¹æ•ˆæ ·å¼ */
        .water-ripple {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          border: 2px solid rgba(135, 206, 250, 0.8);
          border-radius: 50%;
          animation: water-ripple-expand 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 180;
        }

        @keyframes water-ripple-expand {
          0% {
            width: 10px;
            height: 10px;
            opacity: 1;
          }
          100% {
            width: 150px;
            height: 150px;
            opacity: 0;
          }
        }

        .water-drop {
          position: absolute;
          width: 10px;
          height: 15px;
          background: radial-gradient(ellipse at 50% 30%, rgba(135, 206, 250, 0.9), rgba(70, 130, 180, 0.7));
          border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
          animation: water-drop-fall 1.2s ease-in forwards;
          pointer-events: none;
          z-index: 200;
        }

        @keyframes water-drop-fall {
          0% {
            transform: translateY(-50px) scale(0);
            opacity: 0;
          }
          20% {
            transform: translateY(0) scale(1);
            opacity: 1;
          }
          60% {
            transform: translateY(30px) scale(1.1);
            opacity: 0.8;
          }
          100% {
            transform: translateY(50px) scale(0.3);
            opacity: 0;
          }
        }

        .water-splash-particle {
          position: absolute;
          width: 8px;
          height: 8px;
          background: radial-gradient(circle, rgba(173, 216, 230, 0.9), transparent);
          border-radius: 50%;
          animation: water-splash 0.8s ease-out forwards;
          pointer-events: none;
          z-index: 190;
        }

        @keyframes water-splash {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--sx), var(--sy)) scale(0);
            opacity: 0;
          }
        }

        /* æ¼‚æµ®æ–‡å­—æ•ˆæœ */
        .floating-text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translateX(-50%) translateY(-50%);
          font-size: 1.2rem;
          font-weight: bold;
          color: #FFD700;
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
          animation: float-up 1.5s ease-out forwards;
          pointer-events: none;
          z-index: 1000;
          white-space: nowrap;
        }

        @keyframes float-up {
          0% {
            top: 50%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(0.5);
          }
          20% {
            opacity: 1;
            transform: translateX(-50%) translateY(-50%) scale(1.2);
          }
          100% {
            top: 10%;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) scale(1);
          }
        }
      `;
      document.head.appendChild(style);
      
      // æ’­æ”¾å†œåœºéŸ³æ•ˆ
      playFarmSound();
      
      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);
      
      // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          // æ¸…é™¤é©¬å©æ æ‚¬åœæç¤º
          hideStableTooltip();
          // æ¸…é™¤å®šæ—¶å™¨
          if (window.stableHoverTimer) {
            clearTimeout(window.stableHoverTimer);
            window.stableHoverTimer = null;
          }
          window.stableTooltipVisible = false;
          
          // ç§»é™¤æ‰€æœ‰é©¬å©æ çš„tooltipå…ƒç´ 
          const allStableTooltips = document.querySelectorAll('#stable-tooltip, .stable-tooltip-element');
          allStableTooltips.forEach(tooltip => {
            if (tooltip.parentNode) {
              tooltip.remove();
            }
          });
          
          // ç§»é™¤æ‰€æœ‰ç‰²å£æ çš„tooltipå…ƒç´ 
          const allLivestockTooltips = document.querySelectorAll('#livestock-tooltip, .livestock-tooltip-element');
          allLivestockTooltips.forEach(tooltip => {
            if (tooltip.parentNode) {
              tooltip.remove();
            }
          });
          
          modalContainer.classList.remove('active');
          setTimeout(() => {
            gameData.stableData = stableData;
            updateGameData();
            modalContainer.remove();
          }, 300);
        }
      };
      
      // åˆ é™¤é‡å¤çš„é©¬å©æ¨¡æ€æ¡†æ ·å¼å®šä¹‰ï¼Œå·²åœ¨å‰é¢çš„showStableModalå‡½æ•°ä¸­å®šä¹‰
      
      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);
    }

    // è§¦å‘éšæœºäº‹ä»¶
    function triggerRandomEvent() {
      const event = gameData.events[Math.floor(Math.random() * gameData.events.length)];

elements.eventTitle.textContent = event.name;
      elements.eventText.textContent = event.text;

// æ¸…ç©ºå¹¶æ·»åŠ é€‰é¡¹
      elements.eventOptions.innerHTML = '';

for (const option of event.options) {
        const optionElement = document.createElement('div');
        optionElement.className = 'event-modal-option';

optionElement.innerHTML = `
          <div class="event-modal-option-text">${option.text}</div>
          <div class="event-modal-option-description">${option.description}</div>
        `;

optionElement.addEventListener('click', () => {
          // åº”ç”¨é€‰é¡¹ç»“æœ
          for (const [resource, amount] of Object.entries(option.result)) {
            if (resource in gameData.resources) {
              gameData.resources[resource].amount = Math.max(0, gameData.resources[resource].amount + amount);
            } else if (resource in gameData.status) {
              gameData.status[resource] = Math.min(100, Math.max(0, gameData.status[resource] + amount));
            }
          }

// ç‰¹æ®Šå¤„ç†ï¼šå½“é€‰æ‹©"åæŠ—"é€‰é¡¹æ—¶ï¼Œå¢åŠ æ­¦æœ¯æŠ€èƒ½ç»éªŒå€¼
          if (option.text === 'åæŠ—') {
            gameData.skills.martial.experience += 1;
            checkSkillLevelUp('martial');
          }

// æ›´æ–°UI
          renderResources();
          updateGameData();

elements.eventModal.classList.remove('active');
          endTurn();
        });

elements.eventOptions.appendChild(optionElement);
      }

elements.eventModal.classList.add('active');
    }

    // æ˜¾ç¤ºæ”¾æ–‹æ—¥æç¤ºçª—å£
    function showFastingDayModal() {
      const modal = document.createElement('div');
      modal.className = 'fasting-day-modal active';
      modal.innerHTML = `
        <div class="fasting-day-modal-content ink-border">
          <h2 class="fasting-day-modal-title ink-text">æ”¾æ–‹æ—¥é€šçŸ¥</h2>
          <div class="ink-decoration">
            <p class="fasting-day-modal-text">ä»Šå¤©æ˜¯ä¸‡ä½›å¯ºæ”¾æ–‹æ—¥ï¼Œåˆ«å¿˜äº†å»é¢†å–é£Ÿç‰©ï¼</p>
          </div>
          <div class="fasting-day-modal-button ink-button ink-button-primary" id="closeFastingDayModal">ç¡®å®š</div>
        </div>
      `;
      
      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .fasting-day-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          opacity: 0;
          transition: opacity 0.3s;
          pointer-events: none;
        }
        
        .fasting-day-modal.active {
          opacity: 1;
          pointer-events: all;
        }
        
        .fasting-day-modal-content {
          background-color: #F7FAFC;
          border: 2px solid #38A169;
          border-radius: 0.75rem;
          padding: 2rem;
          max-width: 400px;
          width: 90%;
          text-align: center;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
          transform: translateY(-20px);
          transition: transform 0.3s;
        }
        
        .fasting-day-modal.active .fasting-day-modal-content {
          transform: translateY(0);
        }
        
        .fasting-day-modal-title {
          color: #38A169;
          font-size: 1.5rem;
          font-weight: normal;
          margin-bottom: 1rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .fasting-day-modal-text {
          color: #4A5568;
          font-size: 1.1rem;
          margin-bottom: 1.5rem;
          line-height: 1.5;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .fasting-day-modal-button {
          background-color: #38A169;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          display: inline-block;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .fasting-day-modal-button:hover {
          background-color: #2C5282;
        }
      `;
      
      document.body.appendChild(modal);
      document.head.appendChild(style);
      
      // å…³é—­æŒ‰é’®äº‹ä»¶
      const closeButton = document.getElementById('closeFastingDayModal');
      if (closeButton) {
        closeButton.addEventListener('click', function() {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        });
      }
      
      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        }
      });
    }

    // æ˜¾ç¤ºå£°æœ›ä¸è¶³æ¨¡æ€æ¡†
    function showReputationModal(locationName, requiredRep, currentRep) {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†
      const existingModal = document.querySelector('.reputation-modal');
      if (existingModal) {
        return; // å¦‚æœå·²å­˜åœ¨ï¼Œä¸å†åˆ›å»ºæ–°çš„æ¨¡æ€æ¡†
      }

      const modal = document.createElement('div');
      modal.className = 'reputation-modal active';
      modal.innerHTML = `
        <div class="reputation-modal-content ink-border">
          <h2 class="reputation-modal-title ink-text">å£°æœ›ä¸è¶³</h2>
          <div class="ink-decoration">
            <p class="reputation-modal-text">å£°æœ›ä¸è¶³ï¼Œæ— æ³•è¿›å…¥${locationName}ã€‚éœ€è¦è‡³å°‘${requiredRep}%å£°æœ›ï¼Œä½ ç›®å‰åªæœ‰${currentRep}%ã€‚</p>
          </div>
          <div class="reputation-modal-button ink-button ink-button-primary" id="closeReputationModal">ç¡®å®š</div>
        </div>
      `;
      
      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .reputation-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          opacity: 0;
          transition: opacity 0.3s;
          pointer-events: none;
        }
        
        .reputation-modal.active {
          opacity: 1;
          pointer-events: all;
        }
        
        .reputation-modal-content {
          background-color: #F7FAFC;
          border: 2px solid #E53E3E;
          border-radius: 0.75rem;
          padding: 2rem;
          max-width: 400px;
          width: 90%;
          text-align: center;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
          transform: translateY(-20px);
          transition: transform 0.3s;
        }
        
        .reputation-modal.active .reputation-modal-content {
          transform: translateY(0);
        }
        
        .reputation-modal-title {
          color: #E53E3E;
          font-size: 1.5rem;
          font-weight: normal;
          margin-bottom: 1rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .reputation-modal-text {
          color: #4A5568;
          font-size: 1.1rem;
          margin-bottom: 1.5rem;
          line-height: 1.5;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .reputation-modal-button {
          background-color: #E53E3E;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          display: inline-block;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }
        
        .reputation-modal-button:hover {
          background-color: #C53030;
        }
      `;
      
      document.body.appendChild(modal);
      document.head.appendChild(style);
      
      // å…³é—­æŒ‰é’®äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç¡®ä¿åªç»‘å®šä¸€æ¬¡
      const closeModal = function() {
        modal.classList.remove('active');
        setTimeout(function() {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
          if (style.parentNode) {
            style.parentNode.removeChild(style);
          }
        }, 300);
      };
      
      // è·å–å…³é—­æŒ‰é’®å¹¶æ·»åŠ äº‹ä»¶
      const closeButton = modal.querySelector('#closeReputationModal');
      if (closeButton) {
        closeButton.addEventListener('click', closeModal);
      }
      
      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
    }
    
    // é€è¿›ç‰¢æˆ¿
    function sendToPrison() {
      // è·å–å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);

      if (currentLocation) {
        currentLocation.currentLocation = false;
      }

      // æ‰¾åˆ°ç‰¢æˆ¿åœ°ç‚¹å¹¶è®¾ç½®ä¸ºå½“å‰åœ°ç‚¹
      const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
      if (prisonLocation) {
        prisonLocation.currentLocation = true;
        prisonLocation.available = true;

        // è®¾ç½®åˆ‘æœŸï¼ˆ4å¤©ï¼‰
        prisonLocation.sentenceDays = 4;

        // å‡å°‘å¥åº·å’Œç²¾ç¥
        gameData.status.health -= 20;
        checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
        gameData.status.spirit -= 30;

        // æ›´æ–°UI
        renderLocations();
        renderActions();
        updateGameData();

        // æ˜¾ç¤ºåœºæ™¯åˆ‡æ¢çª—å£
        showLocationImageModal('ç‰¢æˆ¿', 'UI/ç‰¢æˆ¿.jpg', () => {
          // åœºæ™¯åˆ‡æ¢çª—å£å…³é—­åæ˜¾ç¤ºè¿›å…¥é€šçŸ¥
          showNotification('è¿›å…¥åœ°ç‚¹', 'ä½ è¿›å…¥äº†ç‰¢æˆ¿ã€‚');
          // ç„¶åæ˜¾ç¤ºè¢«æ•å¼¹çª—
          setTimeout(() => {
            showPrisonSentenceModal(4);
          }, 500);
        });
      }
    }

// æ¨è¿›æ—¶é—´ï¼ˆåŸºäº24å°æ—¶åˆ¶ï¼‰
    function advanceTime(minutesToAdd = 30) {
      // å°†åˆ†é’Ÿæ•°åŠ åˆ°å½“å‰æ—¶é—´
      let totalMinutes = gameData.currentHour * 60 + gameData.currentMinute + minutesToAdd;

      // è®¡ç®—æ–°çš„ä¸€å¤©å’Œæ–°çš„æ—¶é—´
      const newDay = Math.floor(totalMinutes / (24 * 60));
      const remainingMinutes = totalMinutes % (24 * 60);

      // æ›´æ–°æ—¶é—´
      gameData.currentHour = Math.floor(remainingMinutes / 60);
      gameData.currentMinute = remainingMinutes % 60;

      // æ›´æ–°æ—¶é—´æ®µ
      gameData.timeOfDay = updateTimeOfDay(gameData.currentHour);

      // åº”ç”¨BUFFæ•ˆæœå’Œå¤œæ™šé™æ¸©é€»è¾‘
      processBuffs();

      // é¥±é£Ÿåº¦å’Œæ°´åˆ†æ¯å°æ—¶å‡å°‘2%
      if (minutesToAdd > 0) {
        const hoursElapsed = minutesToAdd / 60;
        const reduction = hoursElapsed * 2; // æ¯å°æ—¶å‡å°‘2%
        
        // å‡å°‘é¥±é£Ÿåº¦
        if (gameData.status.hunger > 0) {
          gameData.status.hunger = Math.max(0, Math.round(gameData.status.hunger - reduction));
        }
        
        // å‡å°‘æ°´åˆ†
        if (gameData.status.thirst > 0) {
          gameData.status.thirst = Math.max(0, Math.round(gameData.status.thirst - reduction));
        }
      }

      // ç¯ç«ç‡ƒæ–™æ¯åˆ†é’Ÿæ¶ˆè€—ï¼ˆåŸæ¥æ¯å›åˆå‡å°‘5ï¼Œç°åœ¨æŒ‰æ¯”ä¾‹è°ƒæ•´ï¼‰
      const fuelConsumption = Math.round(minutesToAdd / 60 * 5); // æŒ‰åˆ†é’Ÿæ¯”ä¾‹è®¡ç®—
      if (gameData.resources.fire && gameData.resources.fire.amount > 0) {
        gameData.resources.fire.fuel = Math.max(0, gameData.resources.fire.fuel - fuelConsumption);

        // å¦‚æœç‡ƒæ–™è€—å°½ï¼Œç¯ç«ç†„ç­ï¼ˆä¸å†ç§»é™¤ç¯ç«ï¼Œåªå°†fuelè®¾ä¸º0ï¼‰
        if (gameData.resources.fire.fuel <= 0) {
          gameData.resources.fire.fuel = 0;

          showNotification('ç¯ç«ç†„ç­', 'ä½ çš„ç¯ç«ç‡ƒæ–™å·²ç»è€—å°½ï¼Œç¯ç«ç†„ç­äº†ã€‚');

          // æ›´æ–°èµ„æºæ˜¾ç¤º
          renderResources();
        }
      }

      // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
      checkGameOver();

      // æ›´æ–°æ—¶é—´éŸ³æ•ˆï¼ˆéœ€è¦åœ¨æ—¶é—´å˜åŒ–æ—¶è°ƒç”¨ï¼‰
      updateTimeSoundEffects();
      
      // æ›´æ–°å¤©æ°”éŸ³æ•ˆï¼ˆéœ€è¦åœ¨æ—¶é—´å˜åŒ–æ—¶è°ƒç”¨ï¼‰
      updateWeatherSoundEffects();

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      updateGameData();

      // å¦‚æœè·¨å¤©ï¼Œæ‰§è¡Œæ–°ä¸€å¤©çš„é€»è¾‘
      if (newDay > 0) {
        gameData.day += newDay;

        // ç”Ÿæˆæ–°ä¸€å¤©çš„å¤©æ°”
        generateWeather();

        // æ›´æ–°ç‰²å£æ£šçŠ¶æ€
        updateLivestockDaily();

        // æ›´æ–°é©¬å©çŠ¶æ€
        updateStableDaily();

        // æ›´æ–°å†œç”°çŠ¶æ€ï¼ˆå†œä½œç‰©ç”Ÿé•¿ï¼‰
        updateFarmlandDaily();

        // æ£€æŸ¥é£Ÿç‰©è¿‡æœŸ
        checkFoodExpiration();

        // ç«‹å³æ›´æ–°ç‰²å£æ å’Œé©¬å©æ çš„æ˜¾ç¤ºï¼ˆç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°ä¸‹ä¸€å¤©åçš„å˜åŒ–ï¼‰
        updateAllLivestockStallDisplays();
        updateAllStableStallDisplays();

        // é‡ç½®è€ä¹ä¸å­¦ä¹ çŠ¶æ€
        gameData.learnedFromOldBeggarToday = false;

        // ç«‹å³åˆ·æ–°è¡ŒåŠ¨ç•Œé¢ï¼Œä½¿è€ä¹ä¸çŠ¶æ€æ¢å¤ç”Ÿæ•ˆ
        renderActions();

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©ã€ç¬¬6å¤©ã€ç¬¬10å¤©...ï¼‰
        // é‡ç½®é€šçŸ¥çŠ¶æ€ï¼Œä¸ºæ˜¾ç¤ºé€šçŸ¥åšå‡†å¤‡
        if (gameData.day >= 2 && (gameData.day - 2) % 4 === 0) {
          gameData.fastingDayClaimed = false;
          gameData.fastingDayNotified = false;
        }

        // æ›´æ–°å­£èŠ‚ï¼ˆåŸºäºå¤©æ•°è®¡ç®—ï¼‰
        const previousSeason = gameData.season;
        gameData.season = calculateSeason(gameData.day);

        // åªæœ‰å½“å­£èŠ‚å®é™…å˜åŒ–æ—¶æ‰æ˜¾ç¤ºé€šçŸ¥
        if (previousSeason !== gameData.season) {
          const seasonNames = {
            spring: 'æ˜¥å­£',
            summer: 'å¤å­£',
            autumn: 'ç§‹å­£',
            winter: 'å†¬å­£'
          };
          showNotification('å­£èŠ‚å˜åŒ–', `ç°åœ¨æ˜¯${seasonNames[gameData.season]}äº†ã€‚`);
        }

        // æ ¹æ®å­£èŠ‚æ¶ˆè€—èµ„æº
        switch (gameData.season) {
          case 'spring':
            gameData.status.hunger = Math.max(0, gameData.status.hunger - 5);  // é¥±é£Ÿåº¦å‡å°‘
            gameData.status.cold = Math.min(42, gameData.status.cold + 0.1);    // ä½“æ¸©é€‚ä¸­ï¼ˆæ˜¥å­£æ¸©æš–ï¼‰
            break;
          case 'summer':
            gameData.status.hunger = Math.max(0, gameData.status.hunger - 8);  // é¥±é£Ÿåº¦å‡å°‘æ›´å¤š
            gameData.status.cold = Math.min(42, gameData.status.cold + 0.3);   // ä½“æ¸©å‡é«˜ï¼ˆå¤å­£ç‚çƒ­ï¼‰
            gameData.status.health = Math.max(0, gameData.status.health - 3);  // å¤å­£å®¹æ˜“ç”Ÿç—…
            checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            break;
          case 'autumn':
            gameData.status.hunger = Math.max(0, gameData.status.hunger - 7);  // é¥±é£Ÿåº¦å‡å°‘
            gameData.status.cold = Math.max(34, gameData.status.cold - 0.1);    // ä½“æ¸©é™ä½ï¼ˆç§‹å­£å‡‰çˆ½ï¼‰
            break;
          case 'winter':
            gameData.status.hunger = Math.max(0, gameData.status.hunger - 10); // é¥±é£Ÿåº¦å‡å°‘æœ€å¤š
            gameData.status.cold = Math.max(34, gameData.status.cold - 0.3);   // ä½“æ¸©é™ä½ï¼ˆå†¬å­£å¯’å†·ï¼‰
            gameData.status.health = Math.max(0, gameData.status.health - 5);  // å†¬å­£å®¹æ˜“ç”Ÿç—…
            checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            break;
        }

        // åº”ç”¨BUFFæ•ˆæœ
        if (gameData.buffs) {
          // å…¶ä»–BUFFæ•ˆæœå¤„ç†å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
        }

        // ç‰©å“è€ä¹…åº¦å‡å°‘
        decreaseItemDurability();

        // å¥´éš¶è‡ªåŠ¨æ”¶é›†èµ„æº
        if (gameData.resources.slave.amount > 0) {
          const slaveResults = {
            resources: {},
            status: {},
            effects: []
          };

          // æ¯ä¸ªå¥´éš¶æ¯å¤©éšæœºæ”¶é›†ä¸€äº›èµ„æº
          for (let i = 0; i < gameData.resources.slave.amount; i++) {
            const resources = ['food', 'money', 'cloth', 'stick', 'black_cloth', 'thread'];
            const resource = resources[Math.floor(Math.random() * resources.length)];
            const amount = Math.floor(Math.random() * 2) + 1; // 1-2ä¸ªèµ„æº

            gameData.resources[resource].amount += amount;
            slaveResults.resources[resource] = (slaveResults.resources[resource] || 0) + amount;
          }

          // æ˜¾ç¤ºå¥´éš¶æ”¶é›†èµ„æºçš„é€šçŸ¥
            if (Object.keys(slaveResults.resources).length > 0) {
            let message = `ä½ çš„${gameData.resources.slave.amount}ä¸ªå¥´éš¶ä¸ºä½ æ”¶é›†äº†ï¼š`;
            for (const [resource, amount] of Object.entries(slaveResults.resources)) {
              if (gameData.resources[resource] && gameData.resources[resource].name) {
                message += `${gameData.resources[resource].name}x${amount}ï¼Œ`;
              } else {
                message += `${resource}x${amount}ï¼Œ`;
              }
            }
            message = message.slice(0, -1) + 'ã€‚';

            showNotification('å¥´éš¶çš„æ”¶è·', message);
            showEventResult('å¥´éš¶æ”¶è·', slaveResults);
          }
        }

        // æ”¾æ–‹æ—¥é€šçŸ¥ï¼ˆåªåœ¨æ¸…æ™¨æ˜¾ç¤ºä¸€æ¬¡ï¼‰
        if (gameData.day >= 2 && (gameData.day - 2) % 4 === 0 && !gameData.fastingDayNotified) {
          gameData.fastingDayClaimed = false;
          showFastingDayModal();
          gameData.fastingDayNotified = true;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¢æˆ¿ä¸­
        const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
        if (prisonLocation && prisonLocation.currentLocation) {
          // å‡å°‘åˆ‘æœŸ
          prisonLocation.sentenceDays -= newDay;

          if (prisonLocation.sentenceDays <= 0) {
            // åˆ‘æœŸç»“æŸï¼Œé‡Šæ”¾å‡ºç‹±
            releaseFromPrison();
          } else {
            // æ˜¾ç¤ºå‰©ä½™åˆ‘æœŸå¼¹çª—ï¼Œå‰©ä½™1å¤©æ˜¾ç¤ºä¸º"æœ€åä¸€å¤©"
            const daysMessage = prisonLocation.sentenceDays === 1 ? 'æœ€åä¸€å¤©' : `${prisonLocation.sentenceDays}å¤©`;
            showPrisonSentenceModal(prisonLocation.sentenceDays);

            // åœ¨ç‰¢æˆ¿ä¸­æ¯å¤©å‡å°‘å¥åº·å’Œç²¾ç¥
            for (let i = 0; i < newDay; i++) {
              gameData.status.health -= 5;
              checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
              gameData.status.spirit -= 5;
            }
          }
        }

        // æ£€æŸ¥BUFFæ˜¯å¦è¿‡æœŸ
        if (gameData.buffs && gameData.buffs['å°å¿ƒä¸€ç‚¹'] && gameData.buffs['å°å¿ƒä¸€ç‚¹'].active) {
          if (gameData.day > gameData.buffs['å°å¿ƒä¸€ç‚¹'].endDay) {
            gameData.buffs['å°å¿ƒä¸€ç‚¹'].active = false;
            showNotification('BUFFæ¶ˆå¤±', '"å°å¿ƒä¸€ç‚¹"çŠ¶æ€æ•ˆæœå·²è¿‡æœŸã€‚');
          }
        }
      }
    }

    // æ›´æ–°æ‰€æœ‰ç‰²å£æ çš„æ˜¾ç¤º
    function updateAllLivestockStallDisplays() {
      if (!gameData.livestockData) return;
      
      const stalls = document.querySelectorAll('[data-stall-index]');
      stalls.forEach(stall => {
        const stallIndex = parseInt(stall.dataset.stallIndex);
        const stallData = gameData.livestockData.stalls[stallIndex];
        if (stallData && stallData.animal) {
          updateStallDisplay(stall, stallData, stallIndex);
        }
      });
    }

    // æ›´æ–°æ‰€æœ‰é©¬å©æ çš„æ˜¾ç¤º
    function updateAllStableStallDisplays() {
      if (!gameData.stableData) return;
      
      const stalls = document.querySelectorAll('.stable-stall[data-stall-index]');
      stalls.forEach(stall => {
        const stallIndex = parseInt(stall.dataset.stallIndex);
        const stallData = gameData.stableData.stalls[stallIndex];
        if (stallData && stallData.horse) {
          updateStableStallDisplay(stall, stallData, stallIndex);
        }
      });
    }

// æ‰“å¼€é»‘å¸‚è´§æ¶
    function openBlackMarketShelf() {
      // åˆ›å»ºè´§æ¶å¼¹çª—
      const shelfModal = document.createElement('div');
      shelfModal.className = 'shelf-modal';
      shelfModal.id = 'blackMarketShelfModal';
      shelfModal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #1A202C;
        border: 2px solid #4A5568;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        width: 90%;
        max-width: 900px;
        max-height: 85vh;
        overflow-y: auto;
        transition: all 0.3s ease;
        background-image: linear-gradient(135deg, #1A202C 0%, #2D3748 100%);
      `;

// è´§æ¶å•†å“åˆ—è¡¨
      const shelfItems = [
        { id: 'medicine', name: 'çµè¯', price: 1, description: 'çè´µçš„è‰è¯ï¼Œèƒ½æ¢å¤å¤§é‡å¥åº·' },
        { id: 'house_deed', name: 'æˆ¿å±‹åœ°å¥‘', price: 1, description: 'æ‹¥æœ‰è‡ªå·±çš„æˆ¿äº§ï¼Œæé«˜å£°æœ›å’Œç²¾ç¥çŠ¶æ€', special: true },
        { id: 'fine_clothes', name: 'ç²¾ç¾åæœ', price: 1, description: 'åä¸½çš„æœè£…ï¼Œå¤§å¹…æé«˜å£°æœ›å’Œä¿æš–åº¦' },
        { id: 'silk_shoes', name: 'ç¼é‹', price: 1, description: 'ç²¾è‡´çš„ç¼é¢é‹å­ï¼Œæé«˜å£°æœ›å’Œå¥åº·' },
        { id: 'dog_beating_stick', name: 'æ‰“ç‹—æ£’æ³•', price: 1, description: 'ä¸å¸®ç»æŠ€ï¼Œæé«˜æˆ˜æ–—åŠ›å’Œå£°æœ›', special: true },
        { id: 'herbal_manual', name: 'æœ¬è‰çº²ç›®', price: 1, description: 'åŒ»å­¦ç»å…¸ï¼Œæé«˜å¥åº·æ¢å¤é€Ÿåº¦', special: true },
        { id: 'huangdi_canon', name: 'é»„å¸å†…ç»', price: 1, description: 'åŒ»å­¦ç»å…¸ï¼Œå¤§å¹…æé«˜å¥åº·ä¸Šé™', special: true },
        { id: 'stealth_book', name: 'å·å¤©æ¢æ—¥', price: 1, description: 'ç›—çªƒæŠ€å·§ï¼Œæé«˜å·çªƒæˆåŠŸç‡', special: true },
        { id: 'native_horse', name: 'æœ¬åœŸé©¬', price: 2, description: 'æ™®é€šçš„æœ¬åœŸé©¬åŒ¹ï¼Œé€‚åˆä½œä»£æ­¥å·¥å…·' },
        { id: 'mongolian_horse', name: 'è’™å¤é©¬', price: 3, description: 'è€åŠ›å‡ºè‰²çš„è’™å¤é©¬ï¼Œé€‚åˆé•¿é€”è·‹æ¶‰' },
        { id: 'hequ_horse', name: 'æ²³æ›²é©¬', price: 3, description: 'å¼ºå£®çš„æ²³æ›²é©¬ï¼Œè´Ÿé‡èƒ½åŠ›å¼º' },
        { id: 'ferghana_horse', name: 'æ±—è¡€å®é©¬', price: 5, description: 'çè´µçš„æ±—è¡€å®é©¬ï¼Œé€Ÿåº¦é£å¿«ï¼Œè€åŠ›æä½³' },
        { id: 'super_ferghana_horse', name: 'æå“æ±—è¡€å®é©¬', price: 8, description: 'ä¸‡é‡ŒæŒ‘ä¸€çš„æå“æ±—è¡€å®é©¬ï¼Œä¼ è¯´èƒ½æ—¥è¡Œåƒé‡Œ' }
      ];

// å¼¹çª—å†…å®¹
      shelfModal.innerHTML = `
        <div class="shelf-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #4A5568;">
          <h3 style="font-size: 1.5rem; font-weight: 700; color: #EDF2F7; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">é»‘å¸‚è´§æ¶</h3>
          <button id="closeShelfButton" class="ink-button ink-button-small" style="width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div class="shelf-modal-body">
          <div class="current-gold" style="margin-bottom: 1.5rem; text-align: center; font-size: 1.25rem; font-weight: 600; color: #E2E8F0;">
            <span style="background: linear-gradient(45deg, #D69E2E, #FBBF24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">ğŸ’°</span> å½“å‰é‡‘æ¡: <span id="currentGoldAmount" style="font-weight: bold; color: #D69E2E;">${gameData.resources.gold_bar.amount}</span> æ ¹
          </div>
          <div class="shelf-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem;">
            ${shelfItems.map(item => {
              const resource = gameData.resources[item.id];
              return `
                <div class="shelf-item" style="background-color: #2D3748; border: 1px solid #4A5568; border-radius: 0.75rem; padding: 1.25rem; display: flex; flex-direction: column; align-items: center; text-align: center; transition: all 0.3s ease; transform: translateY(0); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
                  <div class="item-image" style="width: 120px; height: 120px; margin-bottom: 0.75rem; background-color: #1A202C; border: 2px solid #4A5568; border-radius: 0.5rem; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                    <img src="${resource ? resource.image : ''}" alt="${resource ? resource.name : item.name}" style="width: 100%; height: 100%; object-fit: contain; padding: 8px;">
                  </div>
                  <div class="item-name" style="font-weight: 700; margin-bottom: 0.5rem; color: #EDF2F7; font-size: 1.1rem;">${resource ? resource.name : item.name}</div>
                  <div class="item-description" style="font-size: 0.875rem; color: #A0AEC0; margin-bottom: 0.75rem; line-height: 1.4; min-height: 40px;">${resource ? resource.description : item.description}</div>
                  <div class="item-price" style="font-weight: 700; color: #FBBF24; margin-bottom: 1rem; font-size: 1.1rem; display: flex; align-items: center; gap: 4px;">
                    <span>ğŸ’°</span> ä»·æ ¼: ${item.price} é‡‘æ¡
                  </div>
                  <button class="buy-button ink-button ink-button-small" data-item="${item.id}" data-price="${item.price}" ${item.special && resource.amount > 0 ? 'disabled' : ''}>
                    ${item.special && resource.amount > 0 ? 'å·²è´­ä¹°' : 'è´­ä¹°'}
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

// æ·»åŠ åˆ°æ–‡æ¡£
      document.body.appendChild(shelfModal);

      // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶å’Œæ‚¬åœæ•ˆæœ
      const closeButton = document.getElementById('closeShelfButton');
      closeButton.addEventListener('click', function() {
        // æ·»åŠ å…³é—­åŠ¨ç”»
        shelfModal.style.opacity = '0';
        shelfModal.style.transform = 'translate(-50%, -50%) scale(0.95)';
        setTimeout(() => {
          if (shelfModal.parentNode === document.body) {
            document.body.removeChild(shelfModal);
          }
        }, 200);
      });

      // æ·»åŠ ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­çª—å£çš„äº‹ä»¶
      shelfModal.addEventListener('click', function(e) {
        if (e.target === shelfModal) {
          // æ·»åŠ å…³é—­åŠ¨ç”»
          shelfModal.style.opacity = '0';
          shelfModal.style.transform = 'translate(-50%, -50%) scale(0.95)';
          setTimeout(() => {
            if (shelfModal.parentNode === document.body) {
              document.body.removeChild(shelfModal);
            }
          }, 200);
        }
      });

closeButton.addEventListener('mouseover', function() {
        this.style.backgroundColor = '#718096';
      });

closeButton.addEventListener('mouseout', function() {
        this.style.backgroundColor = '#4A5568';
      });

// æ·»åŠ å•†å“å¡ç‰‡æ‚¬åœæ•ˆæœ
      const shelfItemElements = shelfModal.querySelectorAll('.shelf-item');
      shelfItemElements.forEach(item => {
        item.addEventListener('mouseover', function() {
          this.style.transform = 'translateY(-5px)';
          this.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.25)';
          this.style.borderColor = '#63B3ED';
        });

item.addEventListener('mouseout', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
          this.style.borderColor = '#4A5568';
        });
      });

// æ·»åŠ è´­ä¹°æŒ‰é’®æ‚¬åœæ•ˆæœ
      const buyButtons = shelfModal.querySelectorAll('.buy-button:not(:disabled)');
      buyButtons.forEach(button => {
        button.addEventListener('mouseover', function() {
          this.style.backgroundColor = '#9F7AEA';
          this.style.transform = 'scale(1.05)';
        });

button.addEventListener('mouseout', function() {
          this.style.backgroundColor = '#805AD5';
          this.style.transform = 'scale(1)';
        });
      });

// æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶
      const allBuyButtons = shelfModal.querySelectorAll('.buy-button');
      allBuyButtons.forEach(button => {
        button.addEventListener('click', function() {
          const itemId = this.getAttribute('data-item');
          const price = parseInt(this.getAttribute('data-price'));

// æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘æ¡
          if (gameData.resources.gold_bar.amount >= price) {
            // æ¶ˆè€—é‡‘æ¡
            gameData.resources.gold_bar.amount -= price;

          // æ·»åŠ å•†å“åˆ°èƒŒåŒ…
            gameData.resources[itemId].amount += 1;

// ç‰¹æ®Šå­¦ä¹ ç‰©å“å·²åœ¨å®šä¹‰ä¸­è®¾ç½®äº†cannotDropå±æ€§ï¼Œç¡®ä¿è´­ä¹°é™åˆ¶æ­£ç¡®åº”ç”¨
            // æ‰€æœ‰ç‰¹æ®Šå­¦ä¹ ç‰©å“åœ¨è´§æ¶ä¸Šåªèƒ½è´­ä¹°ä¸€æ¬¡
            
            // å¦‚æœæ˜¯ç‰¹æ®Šå•†å“ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
            const shelfItem = shelfItems.find(item => item.id === itemId);
            if (shelfItem && shelfItem.special) {
              // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œç¦ç”¨çŠ¶æ€
              button.textContent = 'å·²è´­ä¹°';
              button.disabled = true;
              button.style.backgroundColor = '#4A5568';
            }

// æ›´æ–°é‡‘å¸æ˜¾ç¤º
            const currentGoldAmountElement = document.getElementById('currentGoldAmount');
            if (currentGoldAmountElement) currentGoldAmountElement.textContent = gameData.resources.gold_bar.amount;

// æ›´æ–°èƒŒåŒ…UI
            renderResources();
            updateResourceCard('gold_bar');

// æ˜¾ç¤ºè´­ä¹°æˆåŠŸé€šçŸ¥
            showNotification('è´­ä¹°æˆåŠŸ', `ä½ ç”¨${price}å¼ é‡‘æ¡è´­ä¹°äº†${gameData.resources[itemId].name}ï¼`);
            // è´­ä¹°æˆåŠŸå·²é€šè¿‡ç®€å•é€šçŸ¥æ˜¾ç¤º

// æ£€æŸ¥æ˜¯å¦æ˜¯çµè¯ï¼Œå¦‚æœæ˜¯ï¼Œç¡®ä¿æœ‰durabilityå±æ€§
            if (itemId === 'medicine') {
              if (!('durability' in gameData.resources.medicine)) {
                gameData.resources.medicine.durability = 100;
              }
            }
          } else {
            // æ˜¾ç¤ºé‡‘æ¡ä¸è¶³é€šçŸ¥
            showNotification('è´­ä¹°å¤±è´¥', `ä½ æ²¡æœ‰è¶³å¤Ÿçš„é‡‘æ¡ï¼éœ€è¦${price}æ ¹ï¼Œä½ åªæœ‰${gameData.resources.gold_bar.amount}æ ¹ã€‚`);
          }
        });
      });

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      shelfModal.addEventListener('click', function(e) {
        if (e.target === shelfModal && shelfModal.parentNode === document.body) {
          document.body.removeChild(shelfModal);
        }
      });
    }

// ä»ç‰¢æˆ¿é‡Šæ”¾
    function releaseFromPrison() {
      // è·å–ç‰¢æˆ¿åœ°ç‚¹
      const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');

      if (prisonLocation) {
        prisonLocation.currentLocation = false;
        prisonLocation.available = false;

        // å°†ç©å®¶é€å›ä¸œè¥¿å¸‚
        const streetLocation = gameData.locations.find(loc => loc.id === 'street');
        if (streetLocation) {
          streetLocation.currentLocation = true;
        }

        // å‡å°‘å£°æœ›
        gameData.status.reputation -= 20;

        // æ·»åŠ "å°å¿ƒä¸€ç‚¹"buffï¼ˆæŒç»­2å¤©ï¼‰
        gameData.buffs['å°å¿ƒä¸€ç‚¹'] = {
          active: true,
          startDay: gameData.day,
          endDay: gameData.day + 2,
          description: 'åˆ‘æ»¡é‡Šæ”¾åçŠ¶æ€ï¼Œå·çªƒæˆåŠŸç‡-20%'
        };

        // æ›´æ–°UI
        renderLocations();
        renderActions();
        updateGameData();

        // æ˜¾ç¤ºåœºæ™¯åˆ‡æ¢çª—å£
        showLocationImageModal('ä¸œè¥¿å¸‚', 'UI/ä¸œè¥¿å¸‚.jpg', () => {
          // åœºæ™¯åˆ‡æ¢çª—å£å…³é—­åæ˜¾ç¤ºè¿›å…¥é€šçŸ¥
          showNotification('è¿›å…¥åœ°ç‚¹', 'ä½ è¿›å…¥äº†ä¸œè¥¿å¸‚ã€‚');
          // ç„¶åæ˜¾ç¤ºåˆ‘æ»¡é‡Šæ”¾å¼¹çª—
          setTimeout(() => {
            showReleaseModal();
          }, 500);
        });
      }
    }

// æ˜¾ç¤ºåˆ‘æœŸå¼¹çª—
    function showPrisonSentenceModal(daysRemaining) {
      const modal = document.createElement('div');
      modal.className = 'prison-sentence-modal active';
      const daysMessage = daysRemaining === 1 ? 'æœ€åä¸€å¤©' : `${daysRemaining}å¤©`;
      modal.innerHTML = `
        <div class="prison-sentence-modal-content ink-border">
          <h2 class="prison-sentence-modal-title ink-text">ç‰¢æˆ¿åˆ‘æœŸ</h2>
          <div class="ink-decoration">
            <p class="prison-sentence-modal-text">ä½ è¢«å…³åœ¨ç‰¢æˆ¿ä¸­ï¼Œéœ€è¦æœåˆ‘${daysMessage}æ‰èƒ½å‡ºç‹±ã€‚</p>
            <p class="prison-sentence-modal-text">åœ¨ç‰¢æˆ¿ä¸­ï¼Œä½ çš„å¥åº·å’Œç²¾ç¥ä¼šæ¯å¤©ä¸‹é™ã€‚</p>
            <p class="prison-sentence-modal-text">ä½ å¯ä»¥é€šè¿‡"åŠ³ä½œ"æ¥è·å¾—æ®‹ç¾¹å‰©é¥­ã€‚</p>
          </div>
          <div class="prison-sentence-modal-button ink-button ink-button-primary" id="closePrisonSentenceModal">ç»§ç»­</div>
        </div>
      `;

      document.body.appendChild(modal);

      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .prison-sentence-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 500;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

.prison-sentence-modal.active {
          opacity: 1;
          pointer-events: auto;
        }

.prison-sentence-modal-content {
          background-color: #FFFDF7;
          padding: 2rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
          width: 300px;
          text-align: center;
          border-radius: 0.25rem;
        }

.prison-sentence-modal-title {
          font-size: 1.5rem;
          font-weight: normal;
          color: #5D4037;
          margin-bottom: 1rem;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.prison-sentence-modal-text {
          color: #7D6E63;
          margin-bottom: 1rem;
          line-height: 1.5;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.prison-sentence-modal-button {
          background-color: #8D6E63;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          display: inline-block;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.prison-sentence-modal-button:hover {
          background-color: #6D4C41;
        }
      `;

document.head.appendChild(style);

// å…³é—­æŒ‰é’®äº‹ä»¶
      const closePrisonSentenceModal = document.getElementById('closePrisonSentenceModal');
      if (closePrisonSentenceModal) {
        closePrisonSentenceModal.addEventListener('click', function() {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        });
      }

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        }
      });
    }

// æ˜¾ç¤ºåˆ‘æ»¡é‡Šæ”¾å¼¹çª—
    function showReleaseModal() {
      const modal = document.createElement('div');
      modal.className = 'release-modal active';
      modal.innerHTML = `
        <div class="release-modal-content ink-border">
          <h2 class="release-modal-title ink-text">åˆ‘æ»¡é‡Šæ”¾</h2>
          <div class="ink-decoration">
            <p class="release-modal-text">ä½ çš„åˆ‘æœŸå·²æ»¡ï¼Œè¢«é‡Šæ”¾å‡ºç‹±ï¼</p>
            <p class="release-modal-text">ç”±äºä½ çš„çŠ¯ç½ªè®°å½•ï¼Œå£°æœ›é™ä½äº†20ç‚¹ã€‚</p>
            <p class="release-modal-text">å‡ºå»ä¹‹åä¸€å®šè¦å¥½å¥½åšäººï¼è·å¾—"å°å¿ƒä¸€ç‚¹"BUFF</p>
          </div>
          <div class="release-modal-button ink-button ink-button-primary" id="closeReleaseModal">ç»§ç»­</div>
        </div>
      `;

      document.body.appendChild(modal);

      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .release-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 500;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

.release-modal.active {
          opacity: 1;
          pointer-events: auto;
        }

.release-modal-content {
          background-color: #fff;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          max-width: 400px;
          width: 90%;
          text-align: center;
          background-image: url('UI/ç›‘ç‹±.png');
          background-size: cover;
          background-position: center;
          color: #ff0000;
          font-weight: normal;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.release-modal-title {
          font-size: 24px;
          margin-bottom: 10px;
          color: #ff0000;
          font-weight: normal;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.release-modal-text {
          font-size: 16px;
          margin-bottom: 15px;
          line-height: 1.5;
          color: #ff0000;
          font-weight: normal;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.release-modal-button {
          background-color: #8B0000;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
          margin-top: 10px;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
        }

.release-modal-button:hover {
          background-color: #B22222;
        }
      `;

document.head.appendChild(style);

// æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
      const closeReleaseModal = document.getElementById('closeReleaseModal');
      if (closeReleaseModal) {
        closeReleaseModal.addEventListener('click', () => {
          modal.classList.remove('active');
          setTimeout(() => {
            if (modal.parentNode === document.body) {
        document.body.removeChild(modal);
      }
      if (style.parentNode === document.head) {
        document.head.removeChild(style);
      }
          }, 300);
        });
      }
    }

// æ£€æŸ¥å¹¶ç§»é™¤è¿‡æœŸçš„buff
    function checkAndRemoveExpiredBuffs() {
      if (!gameData.buffs) return;

for (const [buffId, buff] of Object.entries(gameData.buffs)) {
        if (buff.active && buff.endDay && buff.endDay <= gameData.day) {
          // ç§»é™¤è¿‡æœŸçš„buff
          buff.active = false;
          showNotification('çŠ¶æ€æ¶ˆå¤±', `${buff.description || buffId}æ•ˆæœå·²ç»“æŸã€‚`);
        }
      }
    }

// ç»“æŸå›åˆï¼ˆç°åœ¨æ”¹ä¸ºæ¨è¿›æ—¶é—´ï¼‰
    function endTurn() {
      // æ£€æŸ¥è¿‡æœŸbuff
      checkAndRemoveExpiredBuffs();

// éšæœºè§¦å‘äº‹ä»¶
      if (Math.random() > 0.7) {
        triggerRandomEvent();
      } else {
        advanceTime();
      }
    }

    // æ¸¸æˆç»“æŸ
    function gameOver(message, isVictory = false) {
      // æ— é™æ¨¡å¼ - æ¸¸æˆä¸ä¼šç»“æŸï¼Œåªæ˜¾ç¤ºé€šçŸ¥
      showNotification(isVictory ? 'é‡Œç¨‹ç¢‘è¾¾æˆ' : 'è­¦å‘Š', message);
    }

    // è¿”å›å¼€å§‹ç•Œé¢å¤„ç†å‡½æ•° - å¢å¼ºç‰ˆ
    // æ·»åŠ çŠ¶æ€æ ‡å¿—é˜²æ­¢é‡å¤è°ƒç”¨
    let isReturningToStart = false;

// æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ï¼Œæ•è·æœªå¤„ç†çš„å¼‚å¸¸
    window.addEventListener('error', function(event) {
      console.error('æœªæ•è·çš„å…¨å±€é”™è¯¯:', event.error);
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰å…·ä½“é”™è¯¯ä¿¡æ¯ï¼‰
      if (event.error && event.error.message) {
        showErrorDisplay(event.error.message);
      } else if (event.message) {
        showErrorDisplay(event.message);
      }
      
      // ç¡®ä¿çŠ¶æ€æ ‡å¿—è¢«é‡ç½®ï¼Œé˜²æ­¢ç•Œé¢å¡ä½
      if (isReturningToStart) {
        isReturningToStart = false;
        console.warn('å·²é‡ç½®è¿”å›å¼€å§‹ç•Œé¢çŠ¶æ€æ ‡å¿—');
      }
    });

    // é”™è¯¯ä¿¡æ¯ä»…è®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
    function showErrorDisplay(message) {
      console.error('æ¸¸æˆé”™è¯¯:', message);
    }

function handleBackToStart() {
      // é˜²æ­¢é‡å¤è°ƒç”¨
      if (isReturningToStart) {
        console.warn('è¿”å›å¼€å§‹ç•Œé¢æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
        return;
      }

// ç¡®ä¿documentå’Œbodyå­˜åœ¨ï¼Œé˜²æ­¢åœ¨æç«¯æƒ…å†µä¸‹å‡ºé”™
      if (!document || !document.body) {
        console.error('æ–‡æ¡£å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¿”å›å¼€å§‹ç•Œé¢æ“ä½œ');
        showNotification('ç³»ç»Ÿé”™è¯¯', 'æ— æ³•è®¿é—®é¡µé¢å…ƒç´ ', true, false);
        return;
      }

// åªæœ‰åœ¨ç”¨æˆ·ç¡®è®¤åæ‰æ‰§è¡Œæ“ä½œ
      // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ›¿ä»£confirm
      const confirmResult = showCustomConfirm('ç¡®è®¤æ“ä½œ', 'ç¡®å®šè¦è¿”å›å¼€å§‹ç•Œé¢å—ï¼Ÿå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¼šä¸¢å¤±ã€‚');
      if (confirmResult) {
        isReturningToStart = true;
        

try {
          // 1. æ¸…ç†æ—§çš„äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
          console.log('æ‰§è¡Œæ¸…ç†æ“ä½œ...');
          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ¸¸æˆå®šæ—¶å™¨å’Œå…¶ä»–å¾ªç¯å¼•ç”¨
          if (window.gameInterval) {
            clearInterval(window.gameInterval);
            window.gameInterval = null;
            console.log('æ¸¸æˆå®šæ—¶å™¨å·²æ¸…é™¤');
          }

// æ¸…ç†å¯èƒ½å­˜åœ¨çš„å…¶ä»–å¾ªç¯å¼•ç”¨
          if (window.gameLoop) {
            if (typeof window.gameLoop === 'function') {
              try {
                window.gameLoop = null;
                console.log('æ¸¸æˆå¾ªç¯å‡½æ•°å·²æ¸…ç†');
              } catch (e) {
                console.warn('æ¸…ç†æ¸¸æˆå¾ªç¯å‡½æ•°å¤±è´¥:', e);
              }
            }
          }

// 2. ç¡®ä¿DOMå…ƒç´ å­˜åœ¨å¹¶æ­£ç¡®å¤„ç†
          console.log('æ£€æŸ¥DOMå…ƒç´ ...');
          let startScreenElement = null;
          let gameContainerElement = null;

try {
            startScreenElement = document.getElementById('startScreen');
            gameContainerElement = document.getElementById('gameContainer');
          } catch (domError) {
            console.error('è·å–DOMå…ƒç´ æ—¶å‡ºé”™:', domError);
          }

// å¼ºåˆ¶æ£€æŸ¥å¹¶å¤„ç†DOMå…ƒç´  - ä¼˜åŒ–ç‰ˆæœ¬
          if (!startScreenElement) {
            console.error('ä¸¥é‡é”™è¯¯: å¼€å§‹ç•Œé¢å…ƒç´ ä¸å­˜åœ¨ï¼åˆ›å»ºä¸´æ—¶å…ƒç´ ');
            try {
              // åˆ›å»ºä¸€ä¸ªæ›´å®Œå–„çš„ä¸´æ—¶å¼€å§‹ç•Œé¢ï¼Œé¿å…å®Œå…¨æ¸…ç©ºbody
              startScreenElement = document.createElement('div');
              startScreenElement.id = 'startScreen';
              startScreenElement.className = 'start-screen';
              startScreenElement.style.display = 'flex';
              startScreenElement.style.position = 'fixed';
              startScreenElement.style.top = '0';
              startScreenElement.style.left = '0';
              startScreenElement.style.width = '100%';
              startScreenElement.style.height = '100%';
              startScreenElement.style.zIndex = '9999';
              startScreenElement.style.backgroundColor = '#f0e6d2';
              startScreenElement.style.color = '#333';
              startScreenElement.style.flexDirection = 'column';
              startScreenElement.style.alignItems = 'center';
              startScreenElement.style.justifyContent = 'center';
              startScreenElement.innerHTML = `
                <div class="start-screen-content" style="text-align: center; padding: 2rem;">
                  <h1 class="start-screen-title ink-text" style="font-size: 2.5em; margin-bottom: 20px;">ä¹ä¸æ±‚ç”Ÿ</h1>
                  <p class="start-screen-subtitle" style="font-size: 1.2em; margin-bottom: 30px;">æ°´å¢¨ç”»é£æ ¼çš„å¡ç‰Œç”Ÿå­˜æ¸¸æˆ</p>
                  <p class="start-screen-description" style="max-width: 600px; margin-bottom: 30px;">
                    åœ¨è¿™ä¸ªæ®‹é…·çš„å¤ä»£ä¸–ç•Œä¸­ï¼Œä½ æ‰®æ¼”ä¸€åä¹ä¸ï¼ŒæŒ£æ‰æ±‚ç”Ÿã€‚é€šè¿‡æ”¶é›†èµ„æºã€åˆ¶ä½œå·¥å…·ã€æ¢ç´¢åœ°ç‚¹å’Œåº”å¯¹äº‹ä»¶ï¼ŒåŠªåŠ›æ´»ä¸‹å»å¹¶å¯»æ‰¾æ”¹å˜å‘½è¿çš„æœºä¼šã€‚
                  </p>
                  <button id="startButton" class="start-screen-button ink-button ink-button-primary" style="font-size: 1.2em;">
                    å¼€å§‹æ¸¸æˆ
                  </button>
                </div>
              `;

// æ·»åŠ åˆ°bodyè€Œä¸æ˜¯æ¸…ç©ºbody
              document.body.appendChild(startScreenElement);
              console.log('ä¸´æ—¶å¼€å§‹ç•Œé¢å·²åˆ›å»º');
            } catch (createError) {
              console.error('åˆ›å»ºä¸´æ—¶å¼€å§‹ç•Œé¢å¤±è´¥:', createError);
              // å³ä½¿åˆ›å»ºå¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œå°è¯•å…¶ä»–æ¢å¤æ–¹æ³•
            }
          } else {
            // æ˜¾ç¤ºå¼€å§‹ç•Œé¢å¹¶éšè—æ¸¸æˆå®¹å™¨
            try {
              startScreenElement.style.display = 'flex';
              console.log('å¼€å§‹ç•Œé¢æ˜¾ç¤ºæˆåŠŸ');
            } catch (styleError) {
              console.error('è®¾ç½®å¼€å§‹ç•Œé¢æ ·å¼å¤±è´¥:', styleError);
            }
          }

if (gameContainerElement) {
            try {
              gameContainerElement.style.display = 'none';
              console.log('æ¸¸æˆå®¹å™¨éšè—æˆåŠŸ');
            } catch (styleError) {
              console.error('è®¾ç½®æ¸¸æˆå®¹å™¨æ ·å¼å¤±è´¥:', styleError);
            }
          } else {
            console.warn('æ¸¸æˆå®¹å™¨å…ƒç´ æœªæ‰¾åˆ°ï¼Œå¯èƒ½å·²éšè—');
          }

// 3. åœæ­¢æ‰€æœ‰éŸ³ä¹å’ŒéŸ³æ•ˆ
          try {
            console.log('åœæ­¢æ‰€æœ‰éŸ³é¢‘...');
            if (typeof stopAllAudio === 'function') {
              stopAllAudio();
              console.log('æ‰€æœ‰éŸ³é¢‘å·²åœæ­¢');
            }
          } catch(audioError) {
            console.error('åœæ­¢éŸ³é¢‘æ—¶å‡ºé”™:', audioError);
          }

// 4. å®Œæ•´é‡ç½®æ¸¸æˆæ•°æ®
          try {
            console.log('é‡ç½®æ¸¸æˆæ•°æ®...');
            // å°è¯•é‡æ–°åˆå§‹åŒ–gameData
            if (typeof resetGame === 'function') {
              try {
                console.log('è°ƒç”¨resetGameå‡½æ•°é‡ç½®æ¸¸æˆ');
                resetGame();
              } catch (resetFuncError) {
                console.error('è°ƒç”¨resetGameå‡½æ•°å¤±è´¥:', resetFuncError);
                // é‡ç½®å¤±è´¥æ—¶è¿›è¡Œæ‰‹åŠ¨é‡ç½®
                performManualGameReset();
              }
            } else {
              console.log('resetGameå‡½æ•°ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨é‡ç½®åŸºæœ¬æ•°æ®');
              performManualGameReset();
            }

// å°è¯•è°ƒç”¨initGameé‡æ–°åˆå§‹åŒ–
            if (typeof initGame === 'function') {
              console.log('å°è¯•è°ƒç”¨initGameå‡½æ•°é‡æ–°åˆå§‹åŒ–æ¸¸æˆ');
              try {
                initGame();
              } catch(initError) {
                console.warn('initGameè°ƒç”¨å¤±è´¥ï¼Œä½†ä¸å½±å“è¿”å›å¼€å§‹ç•Œé¢:', initError);
              }
            }
          } catch(resetError) {
            console.error('é‡ç½®æ¸¸æˆæ•°æ®æ—¶å‡ºé”™:', resetError);
          }

// 4. æ·»åŠ å¼€å§‹æ¸¸æˆå‡½æ•°çš„æ›¿ä»£å®ç°
          // å¦‚æœstartGameå‡½æ•°ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ
          if (typeof window.startGame !== 'function') {
            console.log('åˆ›å»ºä¸´æ—¶çš„startGameå‡½æ•°æ›¿ä»£å®ç°');
            window.startGame = function() {
              console.log('ä¸´æ—¶startGameå‡½æ•°è¢«è°ƒç”¨');
              try {
                // éšè—å¼€å§‹ç•Œé¢
                const startScreen = document.getElementById('startScreen');
                if (startScreen) {
                  startScreen.style.display = 'none';
                }

// æ˜¾ç¤ºæ¸¸æˆå®¹å™¨
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                  gameContainer.style.display = 'block';
                } else {
                  console.error('æ¸¸æˆå®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
                  showNotification('åˆå§‹åŒ–å¤±è´¥', 'æ¸¸æˆåˆå§‹åŒ–å¤±è´¥ï¼šæœªæ‰¾åˆ°æ¸¸æˆå®¹å™¨', true, false);
                  return;
                }

// å°è¯•é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                if (typeof resetGame === 'function') {
                  try {
                    resetGame();
                  } catch (e) {
                    console.error('é‡ç½®æ¸¸æˆå¤±è´¥:', e);
                    performManualGameReset();
                  }
                } else {
                  performManualGameReset();
                }

if (typeof initGame === 'function') {
                  try {
                    initGame();
                  } catch (e) {
                    console.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥:', e);
                    // å°è¯•åŸºæœ¬æ˜¾ç¤ºé€»è¾‘
                    performBasicGameRender();
                  }
                } else {
                  console.warn('initGameå‡½æ•°ä¸å­˜åœ¨ï¼Œæ¸¸æˆå¯èƒ½æ— æ³•æ­£å¸¸è¿è¡Œ');
                  performBasicGameRender();
                }
              } catch (error) {
                console.error('æ¸¸æˆå¯åŠ¨è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                showNotification('å¯åŠ¨å¤±è´¥', 'æ¸¸æˆå¯åŠ¨å¤±è´¥ï¼š' + error.message, true, false);
              }
            };
          }

// 5. é‡æ–°ç»‘å®šå¼€å§‹æ¸¸æˆäº‹ä»¶
          setTimeout(() => {
            try {
              // ç¡®ä¿startScreenElementä»ç„¶å­˜åœ¨
              if (!startScreenElement) {
                startScreenElement = document.getElementById('startScreen');
              }

if (startScreenElement) {
                const startGameButton = document.querySelector('#startScreen button, #startButton');
                if (startGameButton) {
                  // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                  const newButton = startGameButton.cloneNode(true);
                  startGameButton.parentNode.replaceChild(newButton, startGameButton);

// æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œç›´æ¥è°ƒç”¨window.startGameï¼ˆæˆ‘ä»¬åˆšåˆšç¡®ä¿å®ƒå­˜åœ¨ï¼‰
                  newButton.onclick = function() {
                    console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»');
                    // å†æ¬¡ç¡®è®¤startGameå‡½æ•°å­˜åœ¨
                    if (typeof window.startGame === 'function') {
                      window.startGame();
                    } else {
                      console.error('ä¸¥é‡é”™è¯¯ï¼šstartGameå‡½æ•°ä¸å­˜åœ¨');
                      alert('æ¸¸æˆåŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    }
                  };
                  console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®äº‹ä»¶å·²é‡æ–°ç»‘å®š');
                } else {
                  console.warn('æœªæ‰¾åˆ°å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼Œåˆ›å»ºä¸€ä¸ª');
                  try {
                    const button = document.createElement('button');
                    button.textContent = 'å¼€å§‹æ¸¸æˆ';
                    button.style.padding = '10px 20px';
                    button.onclick = function() {
                      if (typeof window.startGame === 'function') {
                        window.startGame();
                      } else {
                        alert('æ¸¸æˆåŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢');
                      }
                    };
                    startScreenElement.appendChild(button);
                  } catch (createButtonError) {
                    console.error('åˆ›å»ºå¼€å§‹æ¸¸æˆæŒ‰é’®å¤±è´¥:', createButtonError);
                  }
                }
              } else {
                console.error('å¼€å§‹ç•Œé¢å…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');
              }
            } catch(bindError) {
              console.error('ç»‘å®šå¼€å§‹æ¸¸æˆäº‹ä»¶å¤±è´¥:', bindError);
            } finally {
              // æ“ä½œå®Œæˆï¼Œé‡ç½®çŠ¶æ€æ ‡å¿—
              isReturningToStart = false;
              console.log('è¿”å›å¼€å§‹ç•Œé¢å¤„ç†å®Œæˆï¼ŒçŠ¶æ€æ ‡å¿—å·²é‡ç½®');
            }
          }, 300);

} catch(error) {
          console.error('è¿”å›å¼€å§‹ç•Œé¢è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯:', error);
          // ç¡®ä¿çŠ¶æ€æ ‡å¿—è¢«é‡ç½®
          isReturningToStart = false;

// æ˜¾ç¤ºä¸€ä¸ªåŸºæœ¬çš„æ¢å¤ç•Œé¢ï¼Œä½†ä¸ä½¿ç”¨innerHTMLè¦†ç›–æ•´ä¸ªbody
          try {
            const recoveryDiv = document.createElement('div');
            recoveryDiv.style.position = 'fixed';
            recoveryDiv.style.top = '0';
            recoveryDiv.style.left = '0';
            recoveryDiv.style.width = '100%';
            recoveryDiv.style.height = '100%';
            recoveryDiv.style.backgroundColor = '#f0e6d2';
            recoveryDiv.style.color = '#333';
            recoveryDiv.style.textAlign = 'center';
            recoveryDiv.style.padding = '50px';
            recoveryDiv.style.zIndex = '99999';
            recoveryDiv.style.boxSizing = 'border-box';
            recoveryDiv.innerHTML = '<h1>å‡ºç°é—®é¢˜</h1>' +
              '<p>è¿”å›å¼€å§‹ç•Œé¢æ—¶å‡ºé”™: ' + (error.message || 'æœªçŸ¥é”™è¯¯') + '</p>' +
              '<button onclick="location.reload()" class="ink-button ink-button-primary" style="margin-top: 20px;">åˆ·æ–°é¡µé¢é‡è¯•</button>';
            document.body.appendChild(recoveryDiv);
          } catch (recoveryError) {
            console.error('åˆ›å»ºæ¢å¤ç•Œé¢å¤±è´¥:', recoveryError);
            // æœ€åæ‰‹æ®µï¼šå°è¯•ä½¿ç”¨alerté€šçŸ¥ç”¨æˆ·
            showNotification('ä¸¥é‡é”™è¯¯', 'æ— æ³•æ˜¾ç¤ºæ¢å¤ç•Œé¢ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', true, false);
          }
        }
      }
      // ç‚¹å‡»å–æ¶ˆæ—¶ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›
      console.log('ç”¨æˆ·å–æ¶ˆè¿”å›å¼€å§‹ç•Œé¢æ“ä½œ');
    }

    // æ›´æ–°ç»„åˆæ§½æ˜¾ç¤º
    function updateCombinationSlots() {
      try {
        const slots = document.querySelectorAll('#combinationSlots .combination-slot');
        
        slots.forEach(slot => {
          const slotNumber = slot.getAttribute('data-slot');
          const resourceId = gameData.combinationSlots[slotNumber];
          
          slot.innerHTML = '';
          
          if (resourceId) {
            const resource = gameData.resources[resourceId];
            const resourceCard = document.createElement('div');
            resourceCard.className = 'card resource combination-card';
            
            resourceCard.innerHTML = `
              <div class="card-image" style="background-image: url('${resource.image}'); background-size: cover; background-position: center;"></div>
              <div class="card-content">
                <div class="card-title">${resource.name}</div>
              </div>
            `;
            
            slot.appendChild(resourceCard);
          }
        });
        console.log('ç»„åˆæ§½å·²æ›´æ–°');
      } catch (error) {
        console.error('æ›´æ–°ç»„åˆæ§½æ—¶å‡ºé”™:', error);
      }
    }

// è¾…åŠ©å‡½æ•°ï¼šæ‰‹åŠ¨é‡ç½®æ¸¸æˆæ•°æ®
    function performManualGameReset() {
      try {
        // ç¡®ä¿windowå¯¹è±¡å­˜åœ¨
        if (!window) {
          console.error('windowå¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•é‡ç½®æ¸¸æˆæ•°æ®');
          return;
        }

// ä¿å­˜åŸå§‹åœ°ç‚¹æ•°æ®ï¼Œå¦‚æœå­˜åœ¨çš„è¯
        let originalLocations = null;
        if (typeof gameData !== 'undefined' && gameData.locations) {
          originalLocations = JSON.parse(JSON.stringify(gameData.locations));
        }
        
        // ç¡®ä¿gameDataå­˜åœ¨å¹¶å®Œå…¨é‡ç½®
        window.gameData = {
          day: 1,
          currentHour: 7, // å½“å‰å°æ—¶æ•° (0-24)ï¼Œæ¸¸æˆä»è¾°æ—¶(07:00)å¼€å§‹
          currentMinute: 0, // å½“å‰åˆ†é’Ÿæ•° (0-59)
          season: 'spring',
          status: {
            hunger: 50,
            cold: 36.5,
            health: 80,
            spirit: 70,
            reputation: 20
          },
          discoveredRecipes: [],
          learnedFromOldBeggarToday: false,
          combinationSlots: {
            1: null,
            2: null
          },
          combinationSlotsSource: {
            1: null,
            2: null
          },
          stats: {},
          gameOver: false,
          resources: {},
          locations: []
        };
        
        // é‡ç½®åœ°ç‚¹ï¼Œç¡®ä¿ä¸œè¥¿å¸‚æ˜¯å½“å‰åœ°ç‚¹
        // ä½¿ç”¨åŸå§‹åœ°ç‚¹æ•°æ®ï¼Œä½†é‡ç½®çŠ¶æ€
        if (originalLocations) {
          window.gameData.locations = originalLocations.map(location => {
            const newLocation = { ...location };
            newLocation.currentLocation = false;
            // é‡ç½®ç‰¢æˆ¿çš„åˆ‘æœŸ
            if (newLocation.id === 'prison') {
              newLocation.sentenceDays = 0;
            }
            return newLocation;
          });
          
          // è®¾ç½®ä¸œè¥¿å¸‚ä¸ºå½“å‰åœ°ç‚¹
          const dongxishi = window.gameData.locations.find(loc => loc.id === 'street');
          if (dongxishi) {
            dongxishi.currentLocation = true;
          }
        }
        console.log('æ¸¸æˆæ•°æ®å·²æ‰‹åŠ¨é‡ç½®');
      } catch (e) {
        console.error('æ‰‹åŠ¨é‡ç½®æ¸¸æˆæ•°æ®å¤±è´¥:', e);
      }
    }

// è¾…åŠ©å‡½æ•°ï¼šæ‰§è¡ŒåŸºæœ¬çš„æ¸¸æˆæ¸²æŸ“
    function performBasicGameRender() {
      try {
        // å°è¯•è°ƒç”¨å¯èƒ½å­˜åœ¨çš„æ¸²æŸ“å‡½æ•°
        const renderFunctions = [
          { name: 'renderResources', func: renderResources },
          { name: 'renderLocations', func: renderLocations },
          { name: 'renderActions', func: renderActions },
          { name: 'updateGameData', func: updateGameData },
          { name: 'updateStatusDisplay', func: updateStatusDisplay }
        ];

renderFunctions.forEach(({ name, func }) => {
          if (typeof func === 'function') {
            try {
              func();
              console.log(`æˆåŠŸè°ƒç”¨${name}å‡½æ•°`);
            } catch (e) {
              console.warn(`è°ƒç”¨${name}å‡½æ•°å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•å…¶ä»–æ¸²æŸ“å‡½æ•°:`, e);
            }
          }
        });
      } catch (e) {
        console.error('æ‰§è¡ŒåŸºæœ¬æ¸¸æˆæ¸²æŸ“å¤±è´¥:', e);
      }
    }

    // é‡ç½®æ¸¸æˆ
    function resetGame() {
      gameData.day = 1;
      gameData.currentHour = 7; // è¾°æ—¶ 07:00
      gameData.currentMinute = 0;
      gameData.timeOfDay = updateTimeOfDay(7);
      gameData.season = calculateSeason(gameData.day);
      gameData.resources = {
        'cangenshengfan': { name: 'æ®‹ç¾¹å‰©é¥­', description: 'ä¹è®¨æˆ–æœå¯»è·å¾—çš„é£Ÿç‰©æ®‹æ¸£ï¼Œè™½ç„¶èƒ½å¢åŠ é¥±é£Ÿåº¦ï¼Œä½†å¯èƒ½å½±å“å¥åº·', amount: 0, image: 'UI/æ®‹ç¾¹å‰©é¥­.jpg', type: 'consumable', category: 'food', expirationDays: 2, isPerishable: true },
        'money': { name: 'é’±å¸', amount: 0, image: 'UI/é’±å¸.jpg', category: 'material' },
        'cloth': { name: 'ç ´å¸ƒ', amount: 0, image: 'UI/ç ´å¸ƒ.jpg', category: 'material' },
        'stick': { name: 'æœ¨æ£', amount: 4, image: 'UI/æœ¨æ£.jpg', category: 'material' },
        'paper': { name: 'åºŸçº¸', amount: 0, image: 'UI/åºŸçº¸.jpg', category: 'material' },
        'bowl': { name: 'ç ´ç¢—', amount: 1, image: 'UI/ç ´ç¢—.jpg', category: 'material' },
        'medicine': { name: 'çµè¯', description: 'çè´µçš„è‰è¯ï¼Œèƒ½æ¢å¤å¤§é‡å¥åº·', amount: 0, image: 'UI/çµè¯.jpg', type: 'consumable', category: 'other' },
        'house_deed': { name: 'æˆ¿å±‹åœ°å¥‘', description: 'æ‹¥æœ‰ä¸€å¤„æˆ¿äº§çš„è¯æ˜ï¼Œæå‡å£°æœ›å’Œç²¾ç¥çŠ¶æ€', amount: 1, image: 'UI/æˆ¿å±‹åœ°å¥‘.jpg', category: 'other' },
        'fine_clothes': { name: 'ç²¾ç¾åæœ', description: 'é«˜æ¡£çš„ä¸ç»¸æœè£…ï¼Œå¤§å¹…æå‡å£°æœ›å’Œä¿æš–åº¦', amount: 0, image: 'UI/ç²¾ç¾åæœ.jpg', equipmentSlot: 'clothes', durability: 100, category: 'equipment' },
        'silk_shoes': { name: 'ç¼é‹', description: 'ç²¾è‡´çš„ä¸ç¼é‹å­ï¼Œæå‡å¥åº·åº¦å’Œä¿æš–åº¦', amount: 0, image: 'UI/ç¼é‹.jpg', equipmentSlot: 'shoes', durability: 100, category: 'equipment' },
        'dog_beating_stick': { name: 'æ‰“ç‹—æ£’æ³•', description: 'ä¸å¸®é•‡å¸®ä¹‹å®ï¼Œæå‡å¥åº·åº¦å’Œå£°æœ›', amount: 0, image: 'UI/æ‰“ç‹—æ£’æ³•.jpg', equipmentSlot: 'weapon', durability: 100, category: 'other' },
        'herbal_manual': { name: 'æœ¬è‰çº²ç›®', description: 'å¤ä»£åŒ»å­¦åè‘—ï¼Œæå‡å¥åº·åº¦å’Œç²¾ç¥çŠ¶æ€', amount: 0, image: 'UI/æœ¬è‰çº²ç›®.jpg', durability: 100, category: 'other' },
        'huangdi_canon': { name: 'é»„å¸å†…ç»', description: 'ä¸­åŒ»ç»å…¸è‘—ä½œï¼Œå¤§å¹…æå‡å¥åº·åº¦', amount: 0, image: 'UI/é»„å¸å†…ç».jpg', durability: 100, category: 'other' },
        'stealth_book': { name: 'å·å¤©æ¢æ—¥', description: 'ç›—çªƒæŠ€å·§ç§˜ç±ï¼Œæé«˜å·çªƒæˆåŠŸç‡', amount: 0, image: 'UI/å·å¤©æ¢æ—¥.jpg', durability: 100, category: 'other' },
        'herbal_medicine_book': { name: 'æœ¬è‰çº²ç›®', description: 'åŒ»å­¦ç»å…¸ï¼Œæé«˜å¥åº·æ¢å¤é€Ÿåº¦', amount: 0, image: 'UI/æœ¬è‰çº²ç›®.jpg', equipmentSlot: 'special', category: 'other' },
        'huangdi_neijing': { name: 'é»„å¸å†…ç»', description: 'åŒ»å­¦ç»å…¸ï¼Œå¤§å¹…æé«˜å¥åº·ä¸Šé™', amount: 0, image: 'UI/é»„å¸å†…ç».jpg', equipmentSlot: 'special', category: 'other' },
        'simple_clothes': { name: 'ç ´è¡£æœ', amount: 0, image: 'UI/ç ´è¡£æœ.jpg', equipmentSlot: 'clothes', durability: 100, category: 'equipment' },
        'flint': { name: 'ç‡§çŸ³', amount: 2, image: 'UI/ç‡§çŸ³.jpg', category: 'material' },
        'mud': { name: 'æ³¥å·´', amount: 0, image: 'UI/æ³¥å·´.jpg', category: 'material' },
        'rotten_food': { name: 'è…çƒ‚ç‰©', description: 'è¿‡æœŸçš„é£Ÿç‰©ï¼Œå·²ç»å˜è´¨æ— æ³•é£Ÿç”¨ï¼Œä½†å¯èƒ½è¿˜æœ‰å…¶ä»–ç”¨é€”', amount: 0, image: 'UI/è…çƒ‚ç‰©.jpg', type: 'consumable', category: 'material' },
        'ice_block': { name: 'å†°å—', description: 'ç”¨äºå†°çª–ä¿é²œçš„å†°å—ï¼Œå…·æœ‰æ—¶æ•ˆæ€§', amount: 2, image: 'UI/å†°å—.jpg', type: 'consumable', category: 'food', expirationDays: 5, isPerishable: true, isIceBlock: true },
        'garbage': { name: 'åƒåœ¾', description: 'åœ¨ç°å‘ä¸­ç¿»æ‰¾è·å¾—çš„åƒåœ¾ï¼Œå¯èƒ½åŒ…å«æœ‰ä»·å€¼ç‰©å“', amount: 0, image: 'UI/åƒåœ¾.jpg', category: 'material' },
        'fire': { name: 'ç¯ç«', amount: 0, image: 'UI/ç¯ç«.jpg', durability: 100, fuel: 100, category: 'tool' },
        'clay_bowl': { name: 'æ³¥ç¢—', amount: 0, image: 'UI/æ³¥ç¢—.jpg', category: 'material' },
        'crutch': { name: 'æ‹æ–', amount: 0, image: 'UI/æ‹æ–.jpg', equipmentSlot: 'weapon', durability: 100, category: 'equipment' },
        'gold_bar': { name: 'é‡‘æ¡', amount: 0, image: 'UI/é‡‘æ¡.jpg', category: 'material' },
        'black_cloth': { name: 'é»‘å¸ƒ', amount: 0, image: 'UI/é»‘å¸ƒ.jpg', category: 'material' },
        'hide': { name: 'å…½çš®', description: 'åŠ¨ç‰©çš„çš®æ¯›ï¼Œå¯ä»¥ç”¨æ¥åˆ¶ä½œä¿æš–è¡£ç‰©å’Œå®¹å™¨', amount: 2, image: 'UI/å…½çš®.jpg', category: 'material' },
        'thread': { name: 'çº¿å›¢', amount: 1, image: 'UI/çº¿å›¢.jpg', category: 'material' },
        'water_bag': { name: 'æ°´è¢‹', description: 'å¯ä»¥å‚¨å­˜æ°´åˆ†ï¼Œè¡¥å……èº«ä½“æ°´åˆ†', amount: 0, image: 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg', durability: 100, waterLevel: 0, category: 'tool', instances: [] },
        'black_cloak': { name: 'é»‘è‰²æ–—ç¯·', amount: 0, image: 'UI/é»‘è‰²æ–—ç¯·.jpg', equipmentSlot: 'special', durability: 100, category: 'equipment' },
        'slave': { name: 'å¥´éš¶', amount: 0, image: 'UI/å¥´éš¶.jpg', category: 'other' },
        'shoes': { name: 'ç ´é‹', description: 'ç ´æ—§çš„é‹å­ï¼Œæä¾›åŸºæœ¬çš„è„šéƒ¨ä¿æŠ¤', amount: 0, image: 'UI/ç ´é‹.jpg', equipmentSlot: 'shoes', durability: 100, category: 'equipment' },
        'ornate_shoes': { name: 'é”¦å±¥', description: 'åä¸½çš„é”¦ç¼é‹å­ï¼Œå¤§å¹…æå‡å£°æœ›å’Œå¥åº·åº¦', amount: 0, image: 'UI/é”¦å±¥.jpg', equipmentSlot: 'shoes', durability: 100, category: 'equipment' },
        'cornbread': { name: 'çªçªå¤´', description: 'ç²—ç³™çš„è°·ç‰©åˆ¶å“ï¼Œèƒ½æä¾›è¾ƒå¥½çš„é¥±è…¹æ„Ÿ', amount: 0, image: 'UI/çªçªå¤´.jpg', type: 'consumable', category: 'food', expirationDays: 3, isPerishable: true },
        'porridge': { name: 'ç¨€ç²¥', description: 'æ¸…æ·¡çš„ç²¥å“ï¼Œå®¹æ˜“æ¶ˆåŒ–ï¼Œæä¾›åŸºæœ¬çš„é¥±è…¹æ„Ÿ', amount: 0, image: 'UI/ç¨€ç²¥.jpg', type: 'consumable', category: 'food', expirationDays: 1, isPerishable: true },
        // æ–°å¢èµ„æºå®šä¹‰
        'herb': { name: 'è‰è¯', description: 'å¯ä»¥ç”¨æ¥åˆ¶ä½œè¯å“çš„æ¤ç‰©', amount: 0, image: 'UI/è‰è¯.jpg', category: 'material' },
        'pill': { name: 'è¯ä¸¸', description: 'ç”±è‰è¯åˆ¶æˆçš„è¯å“ï¼Œå¯æ¢å¤å¤§é‡å¥åº·', amount: 0, image: 'UI/è¯ä¸¸.jpg', type: 'consumable', category: 'food', expirationDays: 15, isPerishable: true },
        'bamboo': { name: 'ç«¹å­', description: 'åšéŸ§çš„ç«¹å­ï¼Œå¯ç”¨äºåˆ¶ä½œå·¥å…·å’Œæ­¦å™¨', amount: 0, image: 'UI/ç«¹å­.jpg', category: 'material' },
        'bamboo_bow': { name: 'ç«¹å¼“', description: 'ç”¨ç«¹å­å’Œç‰›ç­‹åˆ¶æˆçš„å¼“ï¼Œæ”»å‡»åŠ›å¼º', amount: 0, image: 'UI/ç«¹å¼“.jpg', equipmentSlot: 'weapon', durability: 100, damage: 10, hitRate: 10, category: 'equipment' },
        'cow_tendon': { name: 'ç‰›ç­‹', description: 'åšéŸ§çš„ç‰›ç­‹ï¼Œç”¨äºåˆ¶ä½œå¼“å¼¦ç­‰', amount: 0, image: 'UI/ç‰›ç­‹.jpg', category: 'material' },
        'wild_buffalo': { name: 'é‡ç‰›', description: 'é‡ç”Ÿçš„æ°´ç‰›ï¼Œå¯ä»¥è·å–ç”Ÿè‚‰å’Œç‰›ç­‹', amount: 0, image: 'UI/é‡ç‰›.jpg', category: 'other' },
        'raw_meat': { name: 'ç”Ÿè‚‰', description: 'æœªåŠ å·¥çš„è‚‰ç±»ï¼Œéœ€è¦çƒ¹é¥ªåé£Ÿç”¨', amount: 0, image: 'UI/ç”Ÿè‚‰.jpg', type: 'consumable', category: 'food', isRaw: true, expirationDays: 1, isPerishable: true },
        'cooked_meat': { name: 'ç†Ÿè‚‰', description: 'çƒ¹é¥ªåçš„è‚‰ç±»ï¼Œæä¾›ä¸°å¯Œçš„è¥å…»', amount: 0, image: 'UI/ç†Ÿè‚‰.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 5, isPerishable: true },
        'grilled_fish': { name: 'çƒ¤é±¼', description: 'çƒ¤åˆ¶çš„é±¼ï¼Œç¾å‘³å¯å£', amount: 0, image: 'UI/çƒ¤é±¼.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 4, isPerishable: true },
        'grilled_egg': { name: 'çƒ¤è›‹', description: 'ç”¨ç¯ç«çƒ¤åˆ¶çš„è›‹ï¼Œè¥å…»ä¸°å¯Œ', amount: 0, image: 'UI/çƒ¤è›‹.jpg', type: 'consumable', category: 'food', isCooked: true, expirationDays: 2, isPerishable: true },
        'porcelain_bowl': { name: 'ç“·ç¢—', description: 'ç²¾è‡´çš„ç“·ç¢—ï¼Œå¤§å¹…æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/ç“·ç¢—.jpg', category: 'material' },
        'pottery_bowl': { name: 'é™¶ç¢—', description: 'åšå›ºçš„é™¶ç¢—ï¼Œæé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é™¶ç¢—.jpg', category: 'material' },
        'silver_bowl': { name: 'é“¶ç¢—', description: 'çè´µçš„é“¶ç¢—ï¼Œæ˜¾è‘—æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é“¶ç¢—.jpg', category: 'material' },
        'gold': { name: 'é‡‘å­', amount: 0, image: 'UI/é‡‘å­.jpg', category: 'material' },
        'gold_bowl': { name: 'é‡‘ç¢—', description: 'å¥¢åçš„é‡‘ç¢—ï¼Œæå¤§æé«˜ä¹è®¨æˆåŠŸç‡å’Œå£°æœ›', amount: 0, image: 'UI/é‡‘ç¢—.jpg', category: 'material' },
        'animal_feed': { name: 'é€šç”¨é¥²æ–™', description: 'ç”¨äºå–‚å…»åŠ¨ç‰©çš„é¥²æ–™ï¼Œå¯ä»¥ç»´æŒåŠ¨ç‰©çš„å¥åº·', amount: 0, image: 'UI/é€šç”¨é¥²æ–™.jpg', category: 'material' },
        'grass_feed': { name: 'è‰æ–™', description: 'é©¬åŒ¹å–œçˆ±çš„è‰æ–™ï¼Œå¯ä»¥ç»´æŒé©¬åŒ¹çš„é¥±é£Ÿåº¦', amount: 0, image: 'UI/è‰æ–™.jpg', category: 'material' },
        'saltpeter': { name: 'ç¡çŸ³', description: 'ç™½è‰²ç»“æ™¶ç‰©è´¨ï¼Œå¯ç”¨äºåˆ¶ä½œå†°å—', amount: 0, image: 'UI/ç¡çŸ³.jpg', category: 'material' },
        'native_horse': { name: 'æœ¬åœŸé©¬', description: 'æ™®é€šçš„æœ¬åœŸé©¬åŒ¹ï¼Œé€‚åˆä½œä»£æ­¥å·¥å…·', amount: 0, image: 'UI/æœ¬åœŸé©¬.jpg', category: 'animal' },
        'mongolian_horse': { name: 'è’™å¤é©¬', description: 'è€åŠ›å‡ºè‰²çš„è’™å¤é©¬ï¼Œé€‚åˆé•¿é€”è·‹æ¶‰', amount: 0, image: 'UI/è’™å¤é©¬.jpg', category: 'animal' },
        'hequ_horse': { name: 'æ²³æ›²é©¬', description: 'å¼ºå£®çš„æ²³æ›²é©¬ï¼Œè´Ÿé‡èƒ½åŠ›å¼º', amount: 0, image: 'UI/æ²³æ›²é©¬.jpg', category: 'animal' },
        'ferghana_horse': { name: 'æ±—è¡€å®é©¬', description: 'çè´µçš„æ±—è¡€å®é©¬ï¼Œé€Ÿåº¦é£å¿«ï¼Œè€åŠ›æä½³', amount: 0, image: 'UI/æ±—è¡€å®é©¬.jpg', category: 'animal' },
        'super_ferghana_horse': { name: 'æå“æ±—è¡€å®é©¬', description: 'ä¸‡é‡ŒæŒ‘ä¸€çš„æå“æ±—è¡€å®é©¬ï¼Œä¼ è¯´èƒ½æ—¥è¡Œåƒé‡Œ', amount: 0, image: 'UI/æå“æ±—è¡€å®é©¬.jpg', category: 'animal' },

        'day_stealing': { name: 'å·å¤©æ¢æ—¥', description: 'ç¥ç§˜çš„ç›—çªƒæŠ€å·§ç§˜ç±ï¼Œæå‡å·çªƒæˆåŠŸç‡', amount: 0, image: 'UI/å·å¤©æ¢æ—¥.jpg', category: 'other' },
        'æ–§å¤´': { name: 'æ–§å¤´', description: 'é”‹åˆ©çš„æ–§å¤´ï¼Œå¯ä»¥æé«˜ç ä¼æ•ˆç‡', amount: 1, image: 'UI/æ–§å¤´.jpg', category: 'tool', equipmentSlot: 'weapon', durability: 100, damage: 15, hitRate: 80 },
        'broom': { name: 'æ‰«å¸š', description: 'ç”¨äºæ¸…æ´ç‰²å£æ å’Œé©¬å©æ ï¼Œæ¯ä½¿ç”¨ä¸€æ¬¡æ¶ˆè€—10è€ä¹…åº¦', amount: 0, image: 'UI/æ‰«å¸š.jpg', category: 'material', durability: 100 }
      };
      gameData.status = {
        hunger: 100, // åˆå§‹é¥±é£Ÿåº¦ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        cold: 36.5, // åˆå§‹ä½“æ¸©ä¿æŒä¸å˜
        health: 100, // åˆå§‹å¥åº·åº¦ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        spirit: 100, // åˆå§‹ç²¾ç¥å€¼ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        blood: 100, // åˆå§‹è¡€é‡ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        reputation: 0, // åˆå§‹å£°æœ›ä¿æŒä¸å˜
        strength: 50,
        isSick: false,
        thirst: 100, // åˆå§‹æ°´åˆ†ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        digestion: 0, // åˆå§‹æ¶ˆåŒ–å€¼ä¸º0
        actionPoints: 20 // åˆå§‹è¡ŒåŠ¨ç‚¹ä¸º20ï¼ˆæ»¡å€¼ï¼‰
      };

      // é‡ç½®è€ä¹ä¸å­¦ä¹ çŠ¶æ€
      gameData.learnedFromOldBeggarToday = false;
      
      gameData.discoveredRecipes = [];
      gameData.combinationSlots = {
        1: null,
        2: null,
        3: null
      };
      gameData.combinationSlotsSource = {
        1: null,
        2: null,
        3: null
      };
      gameData.stats = {
        daysSurvived: 0,
        maxReputation: 0,
        resourcesCollected: 0,
        recipesDiscovered: 0
      };
      gameData.gameOver = false;

      // é‡ç½®åœ°é¢èµ„æº
      gameData.groundResources = {};

      // é‡ç½®åœ°ç‚¹ï¼Œç¡®ä¿ä¸œè¥¿å¸‚æ˜¯å½“å‰åœ°ç‚¹
      if (gameData.locations) {
        gameData.locations.forEach(location => {
          location.currentLocation = false;
          // é‡ç½®ç‰¢æˆ¿çš„åˆ‘æœŸ
          if (location.id === 'prison') {
            location.sentenceDays = 0;
          }
        });
        // è®¾ç½®ä¸œè¥¿å¸‚ä¸ºå½“å‰åœ°ç‚¹
        const dongxishi = gameData.locations.find(loc => loc.id === 'street');
        if (dongxishi) {
          dongxishi.currentLocation = true;
        }
      }

// æ¸…ç©ºç»„åˆæ§½
      updateCombinationSlots();

      // é‡ç½®æ‰€æœ‰çŠ¶æ€å’ŒBUFF
      gameData.buffs = {};

      // åˆå§‹åŒ–è½»é‡çº§é£Ÿç‰©æ—¶æ•ˆæ€§ç³»ç»Ÿ
      gameData.foodExpiry = {};

      // ä¸ºå†°å—åˆå§‹åŒ–æ—¶æ•ˆæ€§ä¿¡æ¯
      if (gameData.resources['ice_block'] && gameData.resources['ice_block'].amount > 0) {
        const obtainTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
        gameData.foodExpiry['ice_block'] = {
          totalAmount: gameData.resources['ice_block'].amount,
          earliestExpiry: obtainTimeInMinutes + 5 * 24 * 60, // 5å¤©åè¿‡æœŸ
          earliestDays: 5,
          obtainDay: gameData.day,
          lastUpdateDay: gameData.day
        };
      }

      // é‡ç½®å†œç”°æ•°æ®
      gameData.farmlandData = {
        level: 1,
        cells: Array(9).fill(null).map(() => ({
          crop: null,
          growthStage: 0,
          moisture: 0,
          fertility: 50,
          plantedDay: null
        })),
        seeds: {
          corn_seed: { name: 'ç‰ç±³ç§å­', growthTime: 6, image: 'UI/ç‰ç±³ç§å­.jpg',
            stages: ['UI/ç‰ç±³æ—©æœŸ.jpg', 'UI/ç‰ç±³ä¸­æœŸ.jpg', 'UI/ç‰ç±³æˆç†ŸæœŸ.jpg'],
            reward: 'corn', rewardCount: [2, 4, 6] },
          wheat_seed: { name: 'å°éº¦ç§å­', growthTime: 5, image: 'UI/å°éº¦ç§å­.jpg',
            stages: ['UI/å°éº¦æ—©æœŸ.jpg', 'UI/å°éº¦ä¸­æœŸ.jpg', 'UI/å°éº¦æˆç†ŸæœŸ.jpg'],
            reward: 'wheat', rewardCount: [3, 5, 8] },
          rice_seed: { name: 'æ°´ç¨»ç§å­', growthTime: 6, image: 'UI/æ°´ç¨»ç§å­.jpg',
            stages: ['UI/æ°´ç¨»æ—©æœŸ.jpg', 'UI/æ°´ç¨»ä¸­æœŸ.jpg', 'UI/æ°´ç¨»æˆç†ŸæœŸ.jpg'],
            reward: 'rice', rewardCount: [4, 6, 9] },
          vegetable_seed: { name: 'è”¬èœç§å­', growthTime: 4, image: 'UI/è”¬èœç§å­.jpg',
            stages: ['UI/è”¬èœæ—©æœŸ.jpg', 'UI/è”¬èœä¸­æœŸ.jpg', 'UI/è”¬èœæˆç†ŸæœŸ.jpg'],
            reward: 'vegetable', rewardCount: [2, 3, 5] },
          fruit_seed: { name: 'æ°´æœç§å­', growthTime: 7, image: 'UI/æ°´æœç§å­.jpg',
            stages: ['UI/æ°´æœæ—©æœŸ.jpg', 'UI/æ°´æœä¸­æœŸ.jpg', 'UI/æ°´æœæˆç†ŸæœŸ.jpg'],
            reward: 'fruit', rewardCount: [3, 5, 8] }
        }
      };

      // é‡ç½®ç‰²å£æ£šæ•°æ®
      gameData.livestockData = {
        level: 1,
        stalls: Array(4).fill(null).map(() => ({
          animal: null,
          growthStage: 0,
          health: 70,
          productivity: 70,
          cleanliness: 0,
          startDay: null,
          lastFedDay: null,
          lastProducedDay: null,
          produceCount: 0,
          specialState: null
        })),
        animals: {
          chick: {
            name: 'é¸¡',
            babyName: 'é¸¡å´½',
            adultName: 'é¸¡æˆå¹´æœŸ',
            growthTime: 3,
            babyImage: 'UI/é¸¡å¹¼å¹´æœŸ.jpg',
            adultImage: 'UI/é¸¡æˆå¹´æœŸ.jpg',
            product: 'egg',
            maxProduction: 15,
            fertilityBonus: 1
          },
          duckling: {
            name: 'é¸­',
            babyName: 'é¸­å´½',
            adultName: 'é¸­æˆå¹´æœŸ',
            growthTime: 5,
            babyImage: 'UI/é¸­å¹¼å¹´æœŸ.jpg',
            adultImage: 'UI/é¸­æˆå¹´æœŸ.jpg',
            product: 'egg',
            maxProduction: 12,
            fertilityBonus: 1
          },
          piglet: {
            name: 'çŒª',
            babyName: 'çŒªå´½',
            adultName: 'çŒªæˆå¹´æœŸ',
            growthTime: 10,
            babyImage: 'UI/çŒªå¹¼å¹´æœŸ.jpg',
            adultImage: 'UI/çŒªæˆå¹´æœŸ.jpg',
            product: null,
            maxProduction: 0,
            fertilityBonus: 2
          }
        }
      };

      // é‡ç½®é©¬å©æ•°æ®
      gameData.stableData = {
        level: 1,
        stalls: Array(4).fill(null).map(() => ({
          horse: null,
          health: 100,
          satiety: 100,
          thirst: 100,
          cleanliness: 0,
          startDay: null,
          lastFedDay: null,
          lastCleanedDay: null
        })),
        horses: {
          native_horse: {
            name: 'æœ¬åœŸé©¬',
            image: 'UI/æœ¬åœŸé©¬.jpg',
            maxHealth: 100,
            dailyHealthLoss: 2,
            dailySatietyLoss: 10,
            dailyCleanlinessIncrease: 5,
            produceInterval: 7
          },
          mongolian_horse: {
            name: 'è’™å¤é©¬',
            image: 'UI/è’™å¤é©¬.jpg',
            maxHealth: 120,
            dailyHealthLoss: 2,
            dailySatietyLoss: 8,
            dailyCleanlinessIncrease: 4,
            produceInterval: 6
          },
          hequ_horse: {
            name: 'æ²³æ›²é©¬',
            image: 'UI/æ²³æ›²é©¬.jpg',
            maxHealth: 140,
            dailyHealthLoss: 1,
            dailySatietyLoss: 12,
            dailyCleanlinessIncrease: 6,
            produceInterval: 8
          },
          ferghana_horse: {
            name: 'æ±—è¡€å®é©¬',
            image: 'UI/æ±—è¡€å®é©¬.jpg',
            maxHealth: 150,
            dailyHealthLoss: 1,
            dailySatietyLoss: 9,
            dailyCleanlinessIncrease: 5,
            produceInterval: 5
          },
          super_ferghana_horse: {
            name: 'æå“æ±—è¡€å®é©¬',
            image: 'UI/æå“æ±—è¡€å®é©¬.jpg',
            maxHealth: 180,
            dailyHealthLoss: 0,
            dailySatietyLoss: 7,
            dailyCleanlinessIncrease: 4,
            produceInterval: 4
          }
        }
      };
    }

    // å…³é—­äº‹ä»¶æ¨¡æ€æ¡†
    function closeEventModal() {
      elements.eventModal.classList.remove('active');
    }

    // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
    let backgroundMusic = null;

    // éŸ³æ•ˆæ§åˆ¶
    let soundEffects = {
      buttonClick: null,
      rain: null,
      dogBark: null,
      templeBell: null,
      farm: null,
      rooster: null,
      walking: null,
      landscape: null,
      dive: null,
      wolfHowl: null,
      bonfire: null,
      heartbeat: null,
      cicada: null,
      timerIntervals: {},
      soundQueue: [],
      isPlayingQueue: false,
      failedSounds: new Set() // è®°å½•æ’­æ”¾å¤±è´¥çš„éŸ³æ•ˆï¼Œé¿å…é‡å¤å°è¯•
    };
    
    function playBackgroundMusic() {
      if (!backgroundMusic) {
        backgroundMusic = new Audio('éŸ³æ•ˆ/ä¸»èƒŒæ™¯éŸ³ä¹.mp3');
        backgroundMusic.loop = true;
        backgroundMusic.volume = gameData.backgroundMusicVolume;
      }
      
      try {
        backgroundMusic.play().catch(error => {
          console.warn('èƒŒæ™¯éŸ³ä¹è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’:', error);
          // ç”¨æˆ·éœ€è¦ä¸é¡µé¢äº¤äº’åæ‰èƒ½æ’­æ”¾éŸ³ä¹
        });
      } catch (error) {
        console.error('æ’­æ”¾èƒŒæ™¯éŸ³ä¹é”™è¯¯:', error);
      }
    }
    
    function stopBackgroundMusic() {
      if (backgroundMusic) {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
      }
    }

    // åœæ­¢æ‰€æœ‰éŸ³ä¹å’ŒéŸ³æ•ˆ
    function stopAllAudio() {
      // åœæ­¢èƒŒæ™¯éŸ³ä¹
      stopBackgroundMusic();

      // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
      if (soundEffects) {
        // åœæ­¢æ‰€æœ‰å¾ªç¯éŸ³æ•ˆï¼ˆåŒ…æ‹¬å¿ƒè·³éŸ³æ•ˆï¼‰
        Object.keys(soundEffects).forEach(soundName => {
          if (soundEffects[soundName] && typeof soundEffects[soundName].pause === 'function') {
            soundEffects[soundName].pause();
            soundEffects[soundName].currentTime = 0;
            soundEffects[soundName] = null;
          }
        });

        // æ¸…ç©ºéŸ³æ•ˆé˜Ÿåˆ—
        soundEffects.soundQueue = [];
        soundEffects.isPlayingQueue = false;

        // æ¸…é™¤æ‰€æœ‰éŸ³æ•ˆå®šæ—¶å™¨
        if (soundEffects.timerIntervals) {
          Object.keys(soundEffects.timerIntervals).forEach(intervalName => {
            if (soundEffects.timerIntervals[intervalName]) {
              clearInterval(soundEffects.timerIntervals[intervalName]);
              soundEffects.timerIntervals[intervalName] = null;
            }
          });
        }

        // æ¸…ç©ºå¤±è´¥çš„éŸ³æ•ˆé›†åˆï¼ˆé‡æ–°åŠ è½½æ¸¸æˆåå¯èƒ½ä¼šæ·»åŠ éŸ³æ•ˆæ–‡ä»¶ï¼‰
        soundEffects.failedSounds.clear();
      }
    }

    // æ’­æ”¾éŸ³æ•ˆå‡½æ•°
    function playSoundEffect(soundName, filePath, options = {}) {
      // æ£€æŸ¥éŸ³æ•ˆå¼€å…³æ˜¯å¦å¯ç”¨
      if (!gameData.settings || !gameData.settings.soundEffects || !gameData.settings.soundEffects.enabled) {
        return null;
      }

      // æ£€æŸ¥è¯¥éŸ³æ•ˆæ˜¯å¦ä¹‹å‰æ’­æ”¾å¤±è´¥è¿‡
      if (soundEffects.failedSounds.has(soundName)) {
        console.log(`éŸ³æ•ˆ ${soundName} ä¹‹å‰æ’­æ”¾å¤±è´¥ï¼Œè·³è¿‡æ’­æ”¾`);
        return null;
      }

      try {
        console.log(`æ’­æ”¾éŸ³æ•ˆ: ${soundName}, è·¯å¾„: ${filePath}`);
        const audio = new Audio(filePath);
        // ä½¿ç”¨è®¾ç½®çš„éŸ³æ•ˆéŸ³é‡ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
        const volume = gameData.settings.soundEffects.volume * (options.volume || 1);
        audio.volume = volume;
        audio.loop = options.loop || false;

        if (options.onEnded) {
          audio.addEventListener('ended', options.onEnded);
        }

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ä»¥ä¾¿è°ƒè¯•
        audio.addEventListener('loadstart', () => console.log(`éŸ³æ•ˆ ${soundName} å¼€å§‹åŠ è½½`));
        audio.addEventListener('canplay', () => console.log(`éŸ³æ•ˆ ${soundName} å¯ä»¥æ’­æ”¾`));
        audio.addEventListener('error', (e) => {
          console.error(`éŸ³æ•ˆ ${soundName} åŠ è½½é”™è¯¯:`, e);
          // å°†å¤±è´¥çš„éŸ³æ•ˆæ·»åŠ åˆ°é›†åˆä¸­
          soundEffects.failedSounds.add(soundName);
        });

        // æ’­æ”¾éŸ³é¢‘
        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.warn(`éŸ³æ•ˆ ${soundName} æ’­æ”¾å¤±è´¥:`, error);
            // å°†å¤±è´¥çš„éŸ³æ•ˆæ·»åŠ åˆ°é›†åˆä¸­
            soundEffects.failedSounds.add(soundName);
          });
        }

        return audio;
      } catch (error) {
        console.error(`æ’­æ”¾éŸ³æ•ˆ ${soundName} é”™è¯¯:`, error);
        // å°†å¤±è´¥çš„éŸ³æ•ˆæ·»åŠ åˆ°é›†åˆä¸­
        soundEffects.failedSounds.add(soundName);
        return null;
      }
    }

    // åœæ­¢ç‰¹å®šéŸ³æ•ˆ
    function stopSoundEffect(soundName) {
      if (soundEffects[soundName]) {
        soundEffects[soundName].pause();
        soundEffects[soundName].currentTime = 0;
        soundEffects[soundName] = null;
      }
    }

    // æ’­æ”¾å€é€ŸéŸ³æ•ˆ
    function playSoundEffectWithSpeed(soundName, filePath, speed = 1.0, options = {}) {
      // æ£€æŸ¥éŸ³æ•ˆå¼€å…³æ˜¯å¦å¯ç”¨
      if (!gameData.settings || !gameData.settings.soundEffects || !gameData.settings.soundEffects.enabled) {
        return null;
      }

      // æ£€æŸ¥è¯¥éŸ³æ•ˆæ˜¯å¦ä¹‹å‰æ’­æ”¾å¤±è´¥è¿‡
      if (soundEffects.failedSounds.has(soundName)) {
        console.log(`éŸ³æ•ˆ ${soundName} ä¹‹å‰æ’­æ”¾å¤±è´¥ï¼Œè·³è¿‡æ’­æ”¾`);
        return null;
      }

      try {
        console.log(`æ’­æ”¾å€é€ŸéŸ³æ•ˆ: ${soundName}, è·¯å¾„: ${filePath}, å€é€Ÿ: ${speed}`);
        const audio = new Audio(filePath);
        // ä½¿ç”¨è®¾ç½®çš„éŸ³æ•ˆéŸ³é‡ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
        const volume = gameData.settings.soundEffects.volume * (options.volume || 1);
        audio.volume = volume;
        audio.loop = options.loop || false;
        audio.playbackRate = speed;

        if (options.onEnded) {
          audio.addEventListener('ended', options.onEnded);
        }

        // æ·»åŠ é”™è¯¯å¤„ç†
        audio.addEventListener('error', (e) => {
          console.error(`éŸ³æ•ˆ ${soundName} åŠ è½½é”™è¯¯:`, e);
          soundEffects.failedSounds.add(soundName);
        });

        // æ’­æ”¾éŸ³é¢‘
        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.warn(`éŸ³æ•ˆ ${soundName} æ’­æ”¾å¤±è´¥:`, error);
            soundEffects.failedSounds.add(soundName);
          });
        }

        return audio;
      } catch (error) {
        console.error(`æ’­æ”¾å€é€ŸéŸ³æ•ˆ ${soundName} é”™è¯¯:`, error);
        soundEffects.failedSounds.add(soundName);
        return null;
      }
    }

    // é˜Ÿåˆ—æ’­æ”¾éŸ³æ•ˆ
    function playSoundEffectInQueue(soundName, filePath, options = {}) {
      if (!gameData.settings || !gameData.settings.soundEffects || !gameData.settings.soundEffects.enabled) {
        return;
      }

      // æ£€æŸ¥è¯¥éŸ³æ•ˆæ˜¯å¦ä¹‹å‰æ’­æ”¾å¤±è´¥è¿‡
      if (soundEffects.failedSounds.has(soundName)) {
        console.log(`éŸ³æ•ˆ ${soundName} ä¹‹å‰æ’­æ”¾å¤±è´¥ï¼Œè·³è¿‡æ·»åŠ åˆ°é˜Ÿåˆ—`);
        return;
      }

      // æ·»åŠ åˆ°é˜Ÿåˆ—
      soundEffects.soundQueue.push({ soundName, filePath, options });
      console.log(`éŸ³æ•ˆ ${soundName} å·²æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é•¿åº¦: ${soundEffects.soundQueue.length}`);

      // å¦‚æœæ²¡æœ‰æ­£åœ¨æ’­æ”¾ï¼Œå¼€å§‹æ’­æ”¾é˜Ÿåˆ—
      if (!soundEffects.isPlayingQueue) {
        playNextSoundInQueue();
      }
    }

    // æ’­æ”¾é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªéŸ³æ•ˆ
    function playNextSoundInQueue() {
      if (soundEffects.soundQueue.length === 0) {
        soundEffects.isPlayingQueue = false;
        return;
      }

      soundEffects.isPlayingQueue = true;
      const { soundName, filePath, options } = soundEffects.soundQueue.shift();

      console.log(`ä»é˜Ÿåˆ—æ’­æ”¾éŸ³æ•ˆ: ${soundName}`);

      const audio = playSoundEffect(soundName, filePath, options);

      if (audio) {
        audio.addEventListener('ended', () => {
          playNextSoundInQueue();
        });
        audio.addEventListener('error', () => {
          console.error(`éŸ³æ•ˆ ${soundName} æ’­æ”¾é”™è¯¯ï¼Œè·³è¿‡`);
          playNextSoundInQueue();
        });
      } else {
        playNextSoundInQueue();
      }
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•çŠ¶æ€å¤„äºçº¢è‰²é¢„è­¦
    function isInDangerState() {
      // æ ¹æ®updateGameDataä¸­çš„çº¢è‰²é¢„è­¦æ¡ä»¶æ£€æŸ¥
      const isColdWarning = gameData.status.cold >= 40;
      const isHungerWarning = gameData.status.hunger < 50;
      const isHealthWarning = gameData.status.health < 50;
      const isBloodWarning = gameData.status.blood < 50;
      const isSpiritWarning = gameData.status.spirit < 50;
      const isThirstWarning = gameData.status.thirst < 50;

      return isColdWarning || isHungerWarning || isHealthWarning ||
             isBloodWarning || isSpiritWarning || isThirstWarning;
    }

    // å•ç‹¬çš„å¿ƒè·³éŸ³æ•ˆæ£€æŸ¥å‡½æ•°ï¼ˆåœ¨updateGameDataä¸­è°ƒç”¨ï¼Œç¡®ä¿çŠ¶æ€å˜åŒ–æ—¶åŠæ—¶å“åº”ï¼‰
    function updateHeartbeatSoundEffect() {
      if (isInDangerState()) {
        if (!soundEffects.heartbeat) {
          console.log('äººç‰©å¤„äºçº¢è‰²é¢„è­¦ï¼Œå¼€å§‹æ’­æ”¾å¿ƒè·³éŸ³æ•ˆ');
          soundEffects.heartbeat = playSoundEffect('heartbeat', 'éŸ³æ•ˆ/å¿ƒè·³.wav', {
            loop: true,
            volume: 0.5
          });
        }
      } else {
        if (soundEffects.heartbeat) {
          console.log('äººç‰©ä¸å†å¤„äºçº¢è‰²é¢„è­¦ï¼Œåœæ­¢æ’­æ”¾å¿ƒè·³éŸ³æ•ˆ');
          soundEffects.heartbeat.pause();
          soundEffects.heartbeat.currentTime = 0;
          soundEffects.heartbeat = null;
        }
      }
    }

    // æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
    function setupButtonSoundEffects() {
      document.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
          playSoundEffect('buttonClick', 'éŸ³æ•ˆ/æŒ‰é’®æŒ‰ä¸‹.mp3', { volume: 0.3 });
        }
      });
    }

    // å¤©æ°”éŸ³æ•ˆæ§åˆ¶
    function updateWeatherSoundEffects() {
      // ä¸‹é›¨éŸ³æ•ˆ
      if (gameData.weather === 'rainy') {
        if (!soundEffects.rain) {
          soundEffects.rain = playSoundEffect('rain', 'éŸ³æ•ˆ/ä¸‹é›¨.wav', { 
            loop: true, 
            volume: 0.4 
          });
        }
      } else {
        stopSoundEffect('rain');
      }
    }

    // æ—¶é—´éŸ³æ•ˆæ§åˆ¶
    function updateTimeSoundEffects() {
      const currentHour = gameData.currentHour;
      
      // ç¡®ä¿timerIntervalså¯¹è±¡å­˜åœ¨
      if (!soundEffects.timerIntervals) {
        soundEffects.timerIntervals = {};
      }
      
      // è·å–å½“å‰ä½ç½®
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      const isAtStreet = currentLocation && currentLocation.id === 'street'; // ä¸œè¥¿å¸‚
      
      // ä¸‘æ—¶ (1-3ç‚¹) çŠ¬å å£° - åªæœ‰åœ¨ä¸œè¥¿å¸‚æ—¶æ‰æ’­æ”¾
      if (currentHour >= 1 && currentHour < 3 && isAtStreet) {
        if (!soundEffects.timerIntervals.dogBark) {
          console.log('è®¾ç½®çŠ¬å å£°å®šæ—¶å™¨ï¼Œæ¯15ç§’æ’­æ”¾ä¸€æ¬¡');
          soundEffects.timerIntervals.dogBark = setInterval(() => {
            console.log('æ’­æ”¾çŠ¬å å£°');
            playSoundEffect('dogBark', 'éŸ³æ•ˆ/æ·±å¤œçŠ¬å å£°.wav', { volume: 0.9 }); // éŸ³é‡è°ƒæ•´åˆ°0.9
          }, 15000); // æ¯15ç§’æ’­æ”¾ä¸€æ¬¡
        }
      } else {
        if (soundEffects.timerIntervals.dogBark) {
          console.log('æ¸…é™¤çŠ¬å å£°å®šæ—¶å™¨');
          clearInterval(soundEffects.timerIntervals.dogBark);
          soundEffects.timerIntervals.dogBark = null;
        }
      }
      
      // å¯æ—¶ (5-7ç‚¹) é¸¡é¸£å£°
      if (currentHour >= 5 && currentHour < 7) {
        if (!soundEffects.timerIntervals.rooster) {
          soundEffects.timerIntervals.rooster = setInterval(() => {
            playSoundEffect('rooster', 'éŸ³æ•ˆ/é¸¡æ‰“é¸£.wav', { volume: 0.4 });
          }, 15000);
        }
      } else {
        if (soundEffects.timerIntervals.rooster) {
          clearInterval(soundEffects.timerIntervals.rooster);
          soundEffects.timerIntervals.rooster = null;
        }
      }

      // å¤å­£è‰é¸£éŸ³æ•ˆ - æ— è®ºåœ¨å“ªä¸ªåœºæ™¯ï¼Œæ¯30ç§’æ’­æ”¾ä¸€æ¬¡
      if (gameData.season === 'summer') {
        if (!soundEffects.timerIntervals.cicada) {
          console.log('è®¾ç½®å¤å­£è‰é¸£å®šæ—¶å™¨ï¼Œæ¯30ç§’æ’­æ”¾ä¸€æ¬¡');
          soundEffects.timerIntervals.cicada = setInterval(() => {
            console.log('æ’­æ”¾å¤å­£è‰é¸£');
            // ä½¿ç”¨é˜Ÿåˆ—æ’­æ”¾ï¼Œé¿å…ä¸å…¶ä»–éŸ³æ•ˆå†²çª
            playSoundEffectInQueue('cicada', 'éŸ³æ•ˆ/å¤å­£è‰é¸£.wav', { volume: 0.5 });
          }, 30000); // æ¯30ç§’æ’­æ”¾ä¸€æ¬¡
        }
      } else {
        if (soundEffects.timerIntervals.cicada) {
          console.log('æ¸…é™¤å¤å­£è‰é¸£å®šæ—¶å™¨');
          clearInterval(soundEffects.timerIntervals.cicada);
          soundEffects.timerIntervals.cicada = null;
        }
      }
    }

    // ä¸‡ä½›å¯ºéŸ³æ•ˆ
    function playTempleBellSound() {
      playSoundEffect('templeBell', 'éŸ³æ•ˆ/å¯ºåº™æ•²é’Ÿ.wav', { volume: 0.6 });
    }

    // å†œåœºçª—å£éŸ³æ•ˆ
    function playFarmSound() {
      if (!soundEffects.farm) {
        soundEffects.farm = playSoundEffect('farm', 'éŸ³æ•ˆ/å†œåœºéŸ³æ•ˆ.wav', { 
          loop: true, 
          volume: 0.3 
        });
      }
    }

    function stopFarmSound() {
      stopSoundEffect('farm');
    }

    // åœºæ™¯åˆ‡æ¢éŸ³æ•ˆ
    function playWalkingSound() {
      if (!soundEffects.walking) {
        soundEffects.walking = playSoundEffect('walking', 'éŸ³æ•ˆ/å¿«é€Ÿèµ°è·¯.wav', { 
          loop: true, 
          volume: 0.4 
        });
      }
    }

    function stopWalkingSound() {
      stopSoundEffect('walking');
    }

    // åŸå¤–å±±é‡åœºæ™¯å±±æ°´éŸ³æ•ˆ
    function updateSceneSoundEffects() {
      // åŸå¤–å±±é‡åœºæ™¯æ’­æ”¾å±±æ°´éŸ³æ•ˆ
      if (gameData.currentScene === 'åŸå¤–å±±é‡') {
        if (!soundEffects.landscape) {
          soundEffects.landscape = playSoundEffect('landscape', 'éŸ³æ•ˆ/å±±æ°´.wav', { 
            loop: true, 
            volume: 0.3 
          });
        }
      } else {
        stopSoundEffect('landscape');
      }
    }

    // æºªè¾¹-ä¸‹æ°´æ‘¸é±¼çš„è·³æ°´éŸ³æ•ˆ
    function playDiveSound() {
      playSoundEffect('dive', 'éŸ³æ•ˆ/è·³æ°´.wav', { volume: 0.5 });
    }

    // äº¥æ—¶æ·±å¤œç‹¼åšéŸ³æ•ˆ
    function updateTimeSoundEffects() {
      const currentHour = gameData.currentHour;
      
      // ä¸‘æ—¶ (1-3ç‚¹) çŠ¬å å£°
      if (currentHour >= 1 && currentHour < 3) {
        if (!soundEffects.timerIntervals.dogBark) {
          soundEffects.timerIntervals.dogBark = setInterval(() => {
            playSoundEffect('dogBark', 'éŸ³æ•ˆ/æ·±å¤œçŠ¬å å£°.wav', { volume: 0.3 });
          }, 15000);
        }
      } else {
        if (soundEffects.timerIntervals.dogBark) {
          clearInterval(soundEffects.timerIntervals.dogBark);
          soundEffects.timerIntervals.dogBark = null;
        }
      }
      
      // å¯æ—¶ (5-7ç‚¹) é¸¡é¸£å£°
      if (currentHour >= 5 && currentHour < 7) {
        if (!soundEffects.timerIntervals.rooster) {
          soundEffects.timerIntervals.rooster = setInterval(() => {
            playSoundEffect('rooster', 'éŸ³æ•ˆ/é¸¡æ‰“é¸£.wav', { volume: 0.4 });
          }, 15000);
        }
      } else {
        if (soundEffects.timerIntervals.rooster) {
          clearInterval(soundEffects.timerIntervals.rooster);
          soundEffects.timerIntervals.rooster = null;
        }
      }
      
      // äº¥æ—¶ (21-23ç‚¹) æ·±å¤œç‹¼åšéŸ³æ•ˆï¼ˆä»…åœ¨åŸå¤–å±±é‡åœºæ™¯ï¼‰
      if (currentHour >= 21 && currentHour < 23 && gameData.currentScene === 'åŸå¤–å±±é‡') {
        if (!soundEffects.timerIntervals.wolfHowl) {
          soundEffects.timerIntervals.wolfHowl = setInterval(() => {
            playSoundEffect('wolfHowl', 'éŸ³æ•ˆ/æ·±å¤œç‹¼åš.wav', { volume: 0.6 }); // éŸ³é‡æ”¾å¤§2å€
          }, 15000);
        }
      } else {
        if (soundEffects.timerIntervals.wolfHowl) {
          clearInterval(soundEffects.timerIntervals.wolfHowl);
          soundEffects.timerIntervals.wolfHowl = null;
        }
      }
    }

    // ç¯ç«å¡ç‰Œçš„çƒ¤ç«éŸ³æ•ˆ
    function updateBonfireSoundEffect() {
      // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰ç¯ç«å¡ç‰Œä¸”ç‡ƒæ–™å¤§äº0
      const bonfireCard = gameData.inventory.find(item => 
        item.name === 'ç¯ç«' || item.name === 'ç¯ç«å¡ç‰Œ'
      );
      const hasFuel = bonfireCard && bonfireCard.fuel > 0;
      
      if (hasFuel) {
        if (!soundEffects.bonfire) {
          soundEffects.bonfire = playSoundEffect('bonfire', 'éŸ³æ•ˆ/çƒ¤ç«.wav', { 
            loop: true, 
            volume: 0.4 
          });
        }
      } else {
        stopSoundEffect('bonfire');
      }
    }

    // æ˜¾ç¤ºé€šçŸ¥ - ç®€å•æ–‡å­—æç¤º
    function showNotification(title, message, isCentral = false, manualCloseOnly = false) {
      // åˆ›å»ºç®€å•çš„é€šçŸ¥å…ƒç´ 
      const notification = document.createElement('div');
      notification.className = 'simple-notification';
      notification.textContent = `${title}: ${message}`;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification);
      
      // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      // 2ç§’åå¼€å§‹æ¶ˆå¤±åŠ¨ç”»
      setTimeout(() => {
        notification.classList.add('hide');
        // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 2000);
    }

    // æ˜¾ç¤ºç‰²å£æ å’Œå†œç”°æé†’
    function showLivestockFarmlandAlert(title, message, type = 'warning') {
      // ä½¿ç”¨ç°æœ‰çš„é€šçŸ¥ç³»ç»Ÿï¼Œä½†è®¾ç½®ä¸ºä¸­å¤®æ˜¾ç¤º
      showNotification(title, message, true, false);
    }

    // æ£€æŸ¥ç‰²å£æ çŠ¶æ€å¹¶æ˜¾ç¤ºæé†’
    function checkLivestockAlerts() {
      const livestockData = gameData.livestockData;
      
      // æ£€æŸ¥æ¯ä¸ªç‰²å£æ 
      livestockData.stalls.forEach((stall, index) => {
        if (stall.animal) {
          const animalData = livestockData.animals[stall.animal];
          const stallNumber = index + 1;
          
          // æ£€æŸ¥å¥åº·çŠ¶æ€ä½äº10%
          if (stall.health <= 10) {
            showLivestockFarmlandAlert(
              'åŠ¨ç‰©å¥åº·è­¦æŠ¥', 
              `ç¬¬${stallNumber}å·ç‰²å£æ çš„${animalData.name}å¥åº·çŠ¶æ€è¿‡ä½ï¼ˆ${stall.health}%ï¼‰ï¼è¯·å°½å¿«å–‚å…»ã€‚`,
              'danger'
            );
          }
          
          // æ£€æŸ¥æ¸…æ´åº¦é«˜äº90%
          if (stall.cleanliness >= 90) {
            showLivestockFarmlandAlert(
              'åŠ¨ç‰©æ¸…æ´åº¦è­¦æŠ¥', 
              `ç¬¬${stallNumber}å·ç‰²å£æ çš„${animalData.name}æ¸…æ´åº¦è¿‡é«˜ï¼ˆ${stall.cleanliness}%ï¼‰ï¼è¯·å°½å¿«æ¸…æ´ã€‚`,
              'warning'
            );
          }
          
          // æ£€æŸ¥æ˜¯å¦æˆå¹´
          if (stall.growthStage === 2 && !stall.adultNotified) {
            showLivestockFarmlandAlert(
              'åŠ¨ç‰©æˆå¹´æé†’', 
              `ç¬¬${stallNumber}å·ç‰²å£æ çš„${animalData.name}å·²ç»æˆå¹´ï¼å¯ä»¥æ”¶è·${animalData.product}äº†ã€‚`,
              'success'
            );
            // æ ‡è®°ä¸ºå·²é€šçŸ¥
            stall.adultNotified = true;
          }
        }
      });
    }

    // æ£€æŸ¥å†œç”°çŠ¶æ€å¹¶æ˜¾ç¤ºæé†’
    function checkFarmlandAlerts() {
      const farmlandData = gameData.farmlandData;
      
      if (!farmlandData || !farmlandData.cells) return;
      
      // æ£€æŸ¥æ¯ä¸ªå†œç”°æ ¼å­
      farmlandData.cells.forEach((cell, index) => {
        if (cell.crop !== null && cell.growthStage === 3 && !cell.harvestNotified) {
          const seedData = farmlandData.seeds[cell.crop];
          const gridPosition = Math.floor(index / 3) + 1;
          const cellPosition = (index % 3) + 1;
          
          showLivestockFarmlandAlert(
            'å†œä½œç‰©æˆç†Ÿæé†’', 
            `ç¬¬${gridPosition}æ’ç¬¬${cellPosition}åˆ—çš„${seedData.name.replace('ç§å­', '')}å·²ç»æˆç†Ÿï¼è¯·å°½å¿«æ”¶è·ã€‚`,
            'success'
          );
          
          // æ ‡è®°ä¸ºå·²é€šçŸ¥
          cell.harvestNotified = true;
        }
      });
    }

    // ç»Ÿä¸€æ£€æŸ¥æ‰€æœ‰æé†’
    function checkAllAlerts() {
      checkLivestockAlerts();
      checkFarmlandAlerts();
    }

// æ˜¾ç¤ºè´­ä¹°ç»“æœå¼¹çª—
    function showPurchaseResult(title, message, isSuccess) {
      // åˆ›å»ºæ¨¡æ€æ¡†
      const purchaseModal = document.createElement('div');
      purchaseModal.className = 'purchase-result-modal';
      purchaseModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1500;
        animation: fadeIn 0.3s ease;
      `;

// å¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'purchase-result-content';
      modalContent.style.cssText = `
        background-color: ${isSuccess ? '#1A202C' : '#2D3748'};
        border: 2px solid ${isSuccess ? '#38A169' : '#E53E3E'};
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease;
        background-image: linear-gradient(135deg, ${isSuccess ? '#1A202C 0%, #2D3748 100%' : '#2D3748 0%, #1A202C 100%'});
      `;

// æ ‡é¢˜
      const modalTitle = document.createElement('h3');
      modalTitle.className = 'purchase-result-title';
      modalTitle.style.cssText = `
        font-size: 1.5rem;
        font-weight: normal;
        color: ${isSuccess ? '#38A169' : '#E53E3E'};
        margin-bottom: 1rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      `;
      modalTitle.textContent = title;

// æ¶ˆæ¯
      const modalMessage = document.createElement('p');
      modalMessage.className = 'purchase-result-message';
      modalMessage.style.cssText = `
        font-size: 1.1rem;
        color: #EDF2F7;
        margin-bottom: 1.5rem;
        line-height: 1.6;
      `;
      modalMessage.textContent = message;

// å›¾æ ‡
      const iconContainer = document.createElement('div');
      iconContainer.style.cssText = `
        font-size: 3rem;
        margin-bottom: 1rem;
      `;
      iconContainer.textContent = isSuccess ? 'âœ“' : 'âœ—';

// ç¡®è®¤æŒ‰é’®
      const confirmButton = document.createElement('button');
      confirmButton.className = 'purchase-result-button';
      confirmButton.style.cssText = `
        background-color: ${isSuccess ? '#38A169' : '#E53E3E'};
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        font-size: 1rem;
        font-weight: normal;
        cursor: pointer;
        transition: all 0.3s ease;
      `;
      confirmButton.textContent = 'ç¡®è®¤';

// æ·»åŠ æ‚¬åœæ•ˆæœ
      confirmButton.addEventListener('mouseover', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
      });

confirmButton.addEventListener('mouseout', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
      });

// å…³é—­å¼¹çª—
      confirmButton.addEventListener('click', function() {
        purchaseModal.style.animation = 'fadeOut 0.3s ease';
        modalContent.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (purchaseModal.parentNode === document.body) {
            document.body.removeChild(purchaseModal);
          }
        }, 300);
      });

// æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­
      purchaseModal.addEventListener('click', function(e) {
        if (e.target === purchaseModal) {
          purchaseModal.style.animation = 'fadeOut 0.3s ease';
          modalContent.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (purchaseModal.parentNode === document.body) {
              document.body.removeChild(purchaseModal);
            }
          }, 300);
        }
      });

// ç»„è£…å¼¹çª—
      modalContent.appendChild(iconContainer);
      modalContent.appendChild(modalTitle);
      modalContent.appendChild(modalMessage);
      modalContent.appendChild(confirmButton);
      purchaseModal.appendChild(modalContent);

// æ·»åŠ åŠ¨ç”»æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
        @keyframes slideIn {
          from { transform: translateY(-50px) scale(0.9); opacity: 0; }
          to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateY(0) scale(1); opacity: 1; }
          to { transform: translateY(50px) scale(0.9); opacity: 0; }
        }
      `;
      document.head.appendChild(style);

// æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(purchaseModal);
    }

// æ˜¾ç¤ºäº‹ä»¶ç»“æœæç¤º
    function showEventResult(title, results) {
      // æ£€æŸ¥å¹¶å…³é—­å·²å­˜åœ¨çš„äº‹ä»¶ç»“æœæ¨¡æ€æ¡†
      const existingModal = document.querySelector('.event-result-modal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // åˆ›å»ºç»“æœè¯¦æƒ…å­—ç¬¦ä¸²
      let details = '';

// æ·»åŠ èµ„æºå˜åŒ–
      if (results.resources && Object.keys(results.resources).length > 0) {
        details += '<div class="event-result-section"><ul class="event-result-list">';
        for (const [resource, amount] of Object.entries(results.resources)) {
          if (amount > 0) {
            if (gameData.resources[resource] && gameData.resources[resource].name) {
              const resourceName = gameData.resources[resource].name;
              details += `<li>+${amount} ${resourceName}</li>`;
            } else {
              // å¦‚æœèµ„æºä¸å­˜åœ¨æˆ–æ²¡æœ‰åç§°ï¼Œä½¿ç”¨èµ„æºIDä½œä¸ºåå¤‡
              details += `<li>+${amount} ${resource}</li>`;
            }
          }
        }
        details += '</ul></div>';
      }

// æ·»åŠ çŠ¶æ€å˜åŒ–
      if (results.status && Object.keys(results.status).length > 0) {
        details += '<div class="event-result-section"><strong>çŠ¶æ€å˜åŒ–ï¼š</strong><ul class="event-result-list">';
        const statusNames = {
          hunger: 'é¥±é£Ÿ',
          cold: 'å¯’å†·',
          health: 'å¥åº·',
          spirit: 'ç²¾ç¥',
          reputation: 'å£°æœ›'
        };

for (const [status, amount] of Object.entries(results.status)) {
          const statusName = statusNames[status] || status;
          const changeSign = amount >= 0 ? '+' : '';
          // å¯¹äºå¥åº·å’Œç²¾ç¥çŠ¶æ€å€¼ï¼Œæ˜¾ç¤ºä¸ºå…·ä½“ç‚¹æ•°è€Œéç™¾åˆ†æ¯”
          if (status === 'health' || status === 'spirit') {
            details += `<li>${statusName}: ${changeSign}${amount}ç‚¹</li>`;
          } else {
            details += `<li>${statusName}: ${changeSign}${amount}%</li>`;
          }
        }
        details += '</ul></div>';
      }

// æ·»åŠ ç‰¹æ®Šæ•ˆæœ
      if (results.effects && results.effects.length > 0) {
        details += '<div class="event-result-section"><strong>ç‰¹æ®Šæ•ˆæœï¼š</strong><ul class="event-result-list">';
        for (const effect of results.effects) {
          details += `<li>${effect}</li>`;
        }
        details += '</ul></div>';

// æ£€æŸ¥æ˜¯å¦è§£é”äº†é»‘å¸‚åœ°ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œæ·»åŠ é¢å¤–æç¤º
        if (results.effects.includes('è§£é”äº†é»‘å¸‚åœ°ç‚¹')) {
          details += '<div class="event-result-section">ä½ éœ€è¦ç©¿æˆ´é»‘è¡£æ–—ç¯·ï¼Œæ‰èƒ½è¿›å…¥é»‘å¸‚ï¼Œé»‘è¡£æ–—ç¯·çš„é…æ–¹æ˜¯ï¼š2ä¸ªé»‘å¸ƒåŠ 1ä¸ªçº¿å›¢</div>';
        }
      }

// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç‰©å“ä¸”æ˜¯æœå¯»ç»“æœï¼Œæ˜¾ç¤ºç‰¹å®šæ–‡å­—
      if (title === 'æœå¯»ç»“æœ' && (!results.resources || Object.keys(results.resources).length === 0)) {
        // å¦‚æœdetailsä¸ä¸ºç©ºï¼ˆæœ‰çŠ¶æ€å˜åŒ–æˆ–ç‰¹æ®Šæ•ˆæœï¼‰ï¼Œåˆ™åœ¨å…¶å‰é¢æ·»åŠ æ–‡å­—
        if (details) {
          details = '<div class="event-result-empty">ä½ çš„è¿æ°”ä¼¼ä¹ä¸å¤ªå¥½å“¦ï¼Œå•¥ä¹Ÿæ²¡ç¿»åˆ°ï¼å˜»å˜»~</div><br/>' + details;
        } else {
          details = '<div class="event-result-empty">ä½ çš„è¿æ°”ä¼¼ä¹ä¸å¤ªå¥½å“¦ï¼Œå•¥ä¹Ÿæ²¡ç¿»åˆ°ï¼å˜»å˜»~</div>';
        }
      }

// å¦‚æœæ²¡æœ‰ä¹è®¨åˆ°ä»»ä½•ç‰©å“ä¸”æ˜¯ä¹è®¨ç»“æœï¼Œæ˜¾ç¤ºç‰¹å®šæ–‡å­—
      if (title === 'ä¹è®¨ç»“æœ' && (!results.resources || Object.keys(results.resources).length === 0)) {
        // å¦‚æœdetailsä¸ä¸ºç©ºï¼ˆæœ‰çŠ¶æ€å˜åŒ–æˆ–ç‰¹æ®Šæ•ˆæœï¼‰ï¼Œåˆ™åœ¨å…¶å‰é¢æ·»åŠ æ–‡å­—
        if (details) {
          details = '<div class="event-result-empty">è·¯äººå«Œå¼ƒçš„ä¸Šä¸‹çœ‹äº†çœ‹ä½ ï¼Œç´§å¿™å¾€å‰èµ°äº†ï¼å“ˆå“ˆï¼Œä½ å•¥ä¹Ÿæ²¡æœ‰è®¨åˆ°ã€‚</div><br/>' + details;
        } else {
          details = '<div class="event-result-empty">è·¯äººå«Œå¼ƒçš„ä¸Šä¸‹çœ‹äº†çœ‹ä½ ï¼Œç´§å¿™å¾€å‰èµ°äº†ï¼å“ˆå“ˆï¼Œä½ å•¥ä¹Ÿæ²¡æœ‰è®¨åˆ°ã€‚</div>';
        }
      }

// åˆ›å»ºæ¨¡æ€æ¡†
      const eventResultModal = document.createElement('div');
      eventResultModal.className = 'event-result-modal';
      eventResultModal.innerHTML = `
        <div class="event-result-modal-content ink-border">
          <div class="event-result-modal-header">
            <h3 class="event-result-modal-title ink-text">${title}</h3>
            <button class="event-result-modal-close ink-button ink-button-small">&times;</button>
          </div>
          <div class="event-result-modal-body">
            ${details}
          </div>
          <div class="event-result-modal-footer">
            <button class="event-result-modal-confirm ink-button-carved ink-button-primary">æˆ‘çŸ¥é“äº†</button>
          </div>
        </div>
      `;

document.body.appendChild(eventResultModal);

// åˆ›å»ºç»Ÿä¸€çš„å…³é—­å‡½æ•°ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨
      let isClosing = false;
      const closeModal = () => {
        if (isClosing) return;
        isClosing = true;
        eventResultModal.classList.add('closing');
        setTimeout(() => {
          if (eventResultModal && eventResultModal.parentNode === document.body) {
            document.body.removeChild(eventResultModal);
          }
        }, 300);
      };

// æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
      const closeButton = eventResultModal.querySelector('.event-result-modal-close');
      closeButton.addEventListener('click', (e) => {
        e.stopPropagation();
        closeModal();
      });

// æ·»åŠ "æˆ‘çŸ¥é“äº†"æŒ‰é’®äº‹ä»¶
      const confirmButton = eventResultModal.querySelector('.event-result-modal-confirm');
      confirmButton.addEventListener('click', (e) => {
        e.stopPropagation();
        closeModal();
      });

// æ·»åŠ ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­
      eventResultModal.addEventListener('click', (e) => {
        if (e.target === eventResultModal) {
          closeModal();
        }
      });

// æ·»åŠ activeç±»ä»¥æ˜¾ç¤ºå¼¹çª—ï¼ˆé€šè¿‡setTimeoutç¡®ä¿DOMå·²ç»å‡†å¤‡å¥½ï¼‰
      setTimeout(() => {
        eventResultModal.classList.add('active');
      }, 10);
    }

    // æ˜¾ç¤ºæˆå°±
    function showAchievement(title, description) {
      elements.achievementTitle.textContent = title;
      elements.achievementDescription.textContent = description;

elements.achievementModal.classList.add('active');

setTimeout(() => {
        elements.achievementModal.classList.remove('active');
      }, 7000);
    }

// å‡å°‘ç‰©å“è€ä¹…åº¦
    function decreaseItemDurability() {
      const results = {
        resources: {},
        status: {},
        effects: []
      };

// éå†æ‰€æœ‰èµ„æºï¼Œå‡å°‘è€ä¹…åº¦
      for (const [id, resource] of Object.entries(gameData.resources)) {
        // åªå¤„ç†æœ‰è€ä¹…åº¦å±æ€§çš„ç‰©å“
        if (resource.durability !== undefined && resource.amount > 0) {
          // æ¯å¤©å‡å°‘2ç‚¹è€ä¹…åº¦
          resource.durability -= 2;

// å¦‚æœè€ä¹…åº¦é™è‡³0æˆ–ä»¥ä¸‹ï¼Œç‰©å“æŸå
          if (resource.durability <= 0) {
            // è®°å½•æŸåçš„ç‰©å“
            results.resources[id] = -resource.amount;

// æ£€æŸ¥ç‰©å“æ˜¯å¦æ­£åœ¨è£…å¤‡ä¸­
            if (resource.equipped) {
              // ç§»é™¤è£…å¤‡æ•ˆæœ
              applyEquipmentEffect(id, 'unequip');
              // ç§»é™¤è£…å¤‡çŠ¶æ€
              resource.equipped = false;
              results.effects.push(`ä½ çš„${resource.name}æŸåäº†ï¼Œå·²è‡ªåŠ¨å¸ä¸‹ã€‚`);
            }

// ç§»é™¤æŸåçš„ç‰©å“
            if (resource && typeof resource.amount === 'number') {
              resource.amount = 0;
            } else {
              console.warn('èµ„æºå¯¹è±¡ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§');
            }
            resource.durability = 100; // é‡ç½®è€ä¹…åº¦ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ¶ä½œæ—¶ä½¿ç”¨
          }
        }
      }

// å¦‚æœæœ‰ç‰©å“æŸåï¼Œæ˜¾ç¤ºé€šçŸ¥
      if (Object.keys(results.resources).length > 0) {
        let message = 'ç‰©å“æŸåï¼š';
        for (const [resource, amount] of Object.entries(results.resources)) {
          message += `${gameData.resources[resource].name}x${Math.abs(amount)}ï¼Œ`;

// æ›´æ–°æŸåç‰©å“çš„æ˜¾ç¤º
          updateResourceCard(resource);
        }
        message = message.slice(0, -1) + 'ã€‚';

showNotification('ç‰©å“æŸå', message);
      }
    }

// ç«¹å¼“ä½¿ç”¨æ—¶æ¶ˆè€—è€ä¹…åº¦
    function decreaseBambooBowDurability() {
      const bambooBow = gameData.resources.bamboo_bow;
      if (bambooBow && bambooBow.equipped && bambooBow.durability !== undefined) {
        // æ¯æ¬¡ä½¿ç”¨æ¶ˆè€—2ç‚¹è€ä¹…åº¦
        bambooBow.durability -= 2;

// å¦‚æœè€ä¹…åº¦é™è‡³0æˆ–ä»¥ä¸‹ï¼Œç‰©å“æŸå
        if (bambooBow.durability <= 0) {
          // ç§»é™¤è£…å¤‡æ•ˆæœ
          applyEquipmentEffect('bamboo_bow', 'unequip');
          // ç§»é™¤è£…å¤‡çŠ¶æ€
          bambooBow.equipped = false;
          // ç§»é™¤æŸåçš„ç‰©å“
          bambooBow.amount = 0;
          bambooBow.durability = 100; // é‡ç½®è€ä¹…åº¦ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ¶ä½œæ—¶ä½¿ç”¨
          showNotification('è£…å¤‡æŸå', 'ä½ çš„ç«¹å¼“è€ä¹…åº¦è€—å°½ï¼Œå·²æŸåå¹¶è‡ªåŠ¨å¸ä¸‹ã€‚');
        } else if (bambooBow.durability <= 20) {
          // è€ä¹…åº¦ä½æ—¶æé†’
          showNotification('è€ä¹…åº¦è­¦å‘Š', `ç«¹å¼“è€ä¹…åº¦å·²ä½è‡³${bambooBow.durability}%ï¼Œè¯·æ³¨æ„ï¼`);
        }

// æ›´æ–°UI
        updateResourceCard('bamboo_bow');
      }
    }

// æ˜¾ç¤ºé’±å¸ä¸è¶³å¼¹çª—
// åˆ¶ä½œçª—å£åŠŸèƒ½
    const craftingModal = document.getElementById('craftingModal');
    const craftingButton = document.getElementById('craftingButton');
    const closeCraftingModal = document.getElementById('closeCraftingButton');
    const craftingInventory = document.getElementById('craftingInventory');
    const craftingSlots = document.querySelectorAll('#craftingModal .crafting-slot');
    const craftingCombineButton = document.getElementById('craftButton');
    const craftingRecipeButton = document.getElementById('craftRecipeButton');

// åˆ¶ä½œçª—å£çš„ç»„åˆæ§½æ•°æ®
    const craftingSlotsData = {1: null, 2: null, 3: null};

    // ç”¨äºè·Ÿè¸ªç»„åˆæ§½ä¸­ç‰©å“çš„æ¥æºï¼ˆbackpackæˆ–groundï¼‰
    const craftingSlotsSource = {1: null, 2: null, 3: null};

// æ‰“å¼€åˆ¶ä½œçª—å£
    craftingButton.addEventListener('click', function() {
      craftingModal.classList.add('active');
      renderCraftingInventory();
      updateCraftingSlots();
    });

// å…³é—­åˆ¶ä½œçª—å£
    closeCraftingModal.addEventListener('click', function() {
      craftingModal.classList.remove('active');
      clearCraftingSlots();
    });

// ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
    craftingModal.addEventListener('click', function(e) {
      if (e.target === craftingModal) {
        craftingModal.classList.remove('active');
        clearCraftingSlots();
      }
    });

// æ¸²æŸ“åˆ¶ä½œçª—å£çš„å·¦ä¾§å¡ç‰Œåˆ—è¡¨ï¼ˆåŒ…æ‹¬èƒŒåŒ…å’Œåœ°é¢æ ï¼‰
    function renderCraftingInventory() {
      craftingInventory.innerHTML = '';

      // æ¸²æŸ“èƒŒåŒ…æ å¡ç‰Œ
      // è·å–æ‰€æœ‰æ•°é‡å¤§äº0çš„èµ„æºï¼ˆæ’é™¤empty_bucketï¼Œå› ä¸ºå®ƒåªæ˜¯bucketçš„å¼•ç”¨ï¼‰
      const ownedResources = [];
      for (const [id, resource] of Object.entries(gameData.resources)) {
        if (resource.amount > 0 && id !== 'empty_bucket') {
          ownedResources.push({ id, resource });
        }
      }

      // åˆ›å»ºå¡ç‰Œå…ƒç´ 
      ownedResources.forEach(({ id, resource }) => {
        const card = document.createElement('div');
        card.className = 'crafting-inventory-card';
        card.dataset.resourceId = id;
        card.dataset.source = 'backpack'; // æ ‡è®°æ¥æºä¸ºèƒŒåŒ…

        card.innerHTML = `
          <div class="crafting-card-image" style="background-image: url('${resource.image}');"></div>
          <div class="crafting-card-title">${resource.name}</div>
        `;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        card.addEventListener('click', function() {
          addToCraftingSlot(id, 'backpack');
        });

        craftingInventory.appendChild(card);
      });

      // æ¸²æŸ“åœ°é¢æ å¡ç‰Œ
      const craftingGroundInventory = document.getElementById('craftingGroundInventory');
      if (craftingGroundInventory) {
        craftingGroundInventory.innerHTML = '';

        // è·å–å½“å‰åœºæ™¯
        const currentLocation = gameData.locations.find(loc => loc.currentLocation);
        if (currentLocation) {
          const locationId = currentLocation.id;
          const groundResources = gameData.groundResources[locationId] || [];

          // åˆ›å»ºåœ°é¢å¡ç‰Œå…ƒç´ 
          groundResources.forEach(({ resourceId, resource, amount = 1 }) => {
            const card = document.createElement('div');
            card.className = 'crafting-inventory-card';
            card.dataset.resourceId = resourceId;
            card.dataset.source = 'ground'; // æ ‡è®°æ¥æºä¸ºåœ°é¢
            card.dataset.amount = amount;

            card.innerHTML = `
              <div class="crafting-card-image" style="background-image: url('${resource.image}');"></div>
              <div class="crafting-card-title">${resource.name}</div>
              <div class="crafting-card-count">x${amount}</div>
            `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            card.addEventListener('click', function() {
              addToCraftingSlot(resourceId, 'ground');
            });

            craftingGroundInventory.appendChild(card);
          });
        }
      }
    }

// å°†å¡ç‰Œæ·»åŠ åˆ°åˆ¶ä½œçª—å£çš„ç»„åˆæ§½
    function addToCraftingSlot(resourceId, source = 'backpack') {
      // æ£€æŸ¥èµ„æºæ•°é‡
      if (source === 'backpack') {
        // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æº
        if (gameData.resources[resourceId].amount <= 0) {
          return;
        }
      } else if (source === 'ground') {
        // æ£€æŸ¥åœ°é¢æ ä¸­æ˜¯å¦æœ‰è¯¥èµ„æº
        const currentLocation = gameData.locations.find(loc => loc.currentLocation);
        if (!currentLocation) return;
        const locationId = currentLocation.id;
        const groundItem = gameData.groundResources[locationId]?.find(item => item.resourceId === resourceId);
        if (!groundItem || groundItem.amount <= 0) {
          return;
        }
      }

      // å¯»æ‰¾ç¬¬ä¸€ä¸ªç©ºæ§½ä½
      for (const slotNumber in craftingSlotsData) {
        if (craftingSlotsData[slotNumber] === null) {
          craftingSlotsData[slotNumber] = resourceId;
          craftingSlotsSource[slotNumber] = source; // è®°å½•æ¥æº

          // æ ¹æ®æ¥æºå‡å°‘èµ„æºæ•°é‡
          if (source === 'backpack') {
            // å‡å°‘èƒŒåŒ…ä¸­çš„èµ„æºæ•°é‡
            if (gameData.resources[resourceId] && typeof gameData.resources[resourceId].amount === 'number') {
              gameData.resources[resourceId].amount--;
            } else {
              console.warn(`èµ„æº ${resourceId} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ amount å±æ€§`);
            }
          } else if (source === 'ground') {
            // å‡å°‘åœ°é¢æ ä¸­çš„èµ„æºæ•°é‡
            const currentLocation = gameData.locations.find(loc => loc.currentLocation);
            if (currentLocation) {
              const locationId = currentLocation.id;
              const groundIndex = gameData.groundResources[locationId]?.findIndex(item => item.resourceId === resourceId);
              if (groundIndex !== -1 && groundIndex !== undefined) {
                gameData.groundResources[locationId][groundIndex].amount--;
                // å¦‚æœåœ°é¢æ•°é‡ä¸º0ï¼Œä»åœ°é¢æ ç§»é™¤
                if (gameData.groundResources[locationId][groundIndex].amount <= 0) {
                  gameData.groundResources[locationId].splice(groundIndex, 1);
                }
              }
            }
          }
          break;
        }
      }

      // é‡æ–°æ¸²æŸ“åˆ¶ä½œçª—å£çš„å·¦ä¾§å¡ç‰Œåˆ—è¡¨ï¼ˆæ•°é‡å˜åŒ–åå¯èƒ½éœ€è¦éšè—æŸäº›å¡ç‰Œï¼‰
      renderCraftingInventory();
      updateCraftingSlots();
      checkCraftingCombination();
    }

// æ›´æ–°åˆ¶ä½œçª—å£çš„ç»„åˆæ§½æ˜¾ç¤º
    function updateCraftingSlots() {
      craftingSlots.forEach(slot => {
        const slotNumber = slot.getAttribute('data-slot');
        const resourceId = craftingSlotsData[slotNumber];

        slot.innerHTML = '';

        if (resourceId) {
          const resource = gameData.resources[resourceId];
          const resourceCard = document.createElement('div');
          resourceCard.className = 'card resource combination-card';

          resourceCard.innerHTML = `
            <div class="card-image" style="background-image: url('${resource.image}'); background-size: cover; background-position: center;">
            </div>
            <div class="card-content">
              <div class="card-title">${resource.name}</div>
            </div>
          `;

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç§»é™¤å¡ç‰Œ
          resourceCard.addEventListener('click', function(e) {
            e.stopPropagation();
            // æ ¹æ®æ¥æºå°†èµ„æºæ”¾å›èƒŒåŒ…æˆ–åœ°é¢æ 
            const source = craftingSlotsSource[slotNumber];
            if (source === 'backpack') {
              // å°†èµ„æºæ”¾å›èƒŒåŒ…
              gameData.resources[resourceId].amount++;
            } else if (source === 'ground') {
              // å°†èµ„æºæ”¾å›åœ°é¢æ 
              const currentLocation = gameData.locations.find(loc => loc.currentLocation);
              if (currentLocation) {
                const locationId = currentLocation.id;
                addResourceToGround(resourceId, 1, locationId);
              }
            }

            // æ¸…ç©ºæ§½ä½
            craftingSlotsData[slotNumber] = null;
            craftingSlotsSource[slotNumber] = null;
            // é‡æ–°æ¸²æŸ“å·¦ä¾§å¡ç‰Œåˆ—è¡¨å’Œå³ä¾§æ§½ä½
            renderCraftingInventory();
            updateCraftingSlots();
            checkCraftingCombination();
          });

          slot.appendChild(resourceCard);
        }
      });
    }

// æ›´æ–°å•ä¸ªèµ„æºå¡ç‰Œçš„æ˜¾ç¤º
    function updateResourceCard(resourceId) {
      const resourceCards = document.querySelectorAll('.resource-card');
      resourceCards.forEach(card => {
        if (card.getAttribute('data-resource') === resourceId) {
          const resource = gameData.resources[resourceId];
          const titleElement = card.querySelector('.card-title');
          const imageElement = card.querySelector('.card-image');
          if (titleElement) {
            // å¦‚æœæ˜¯æœ¨æ¡¶æˆ–æ°´è¢‹ï¼Œæ˜¾ç¤ºç»Ÿä¸€åç§°
            const displayName = (resourceId === 'bucket') ? 'æœ¨æ¡¶' :
              (resourceId === 'water_bag') ? 'æ°´è¢‹' : resource.name;
            titleElement.textContent = `${displayName}Ã—${resource.amount || 0}`;
          }

          // æ›´æ–°æœ¨æ¡¶çš„å›¾ç‰‡å’Œæ°´ä½æŒ‡ç¤ºæ¡
          if (resourceId === 'bucket' && resource.waterLevel !== undefined) {
            let bucketImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
            if (resource.waterLevel >= 200) {
              bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
            } else if (resource.waterLevel > 0) {
              bucketImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
            }
            if (imageElement) {
              imageElement.style.backgroundImage = `url('${bucketImage}')`;
            }
            
            const waterIndicator = card.querySelector('.water-level-indicator-backpack');
            if (waterIndicator) {
              // æ›´æ–°æ¯ä¸ªæ ¼å­ï¼Œç”±ä¸‹å¾€ä¸Šå¡«å……
              const cells = waterIndicator.querySelectorAll('div');
              const filledLevels = Math.floor((resource.waterLevel || 0) / 50);
              cells.forEach((cell, index) => {
                const isFilled = index >= (5 - filledLevels);
                cell.style.backgroundColor = isFilled ? '#3B82F6' : '#FFFFFF';
              });
            }
          }

          // æ›´æ–°å·²ç©¿æˆ´æ ‡è¯†
          const equippedBadge = card.querySelector('.equipped-badge');
          if (resource.equipmentSlot) {
            if (resource.equipped) {
              // å¦‚æœå·²ç©¿æˆ´ä½†æ ‡è¯†ä¸å­˜åœ¨ï¼Œæ·»åŠ æ ‡è¯†
              if (!equippedBadge) {
                const imageContainer = card.querySelector('.card-image');
                if (imageContainer) {
                  const badge = document.createElement('div');
                  badge.className = 'equipped-badge';
                  badge.style.cssText = 'position: absolute; bottom: 0.25rem; right: 0.25rem; background-color: #38A169; color: white; border-radius: 4px; padding: 0.1rem 0.3rem; font-size: 0.6rem; font-weight: normal; font-family: "HuiWenMingChaoTi", "FangSong", "ä»¿å®‹", serif !important; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); z-index: 10;';
                  badge.textContent = 'å·²ç©¿æˆ´';
                  imageContainer.appendChild(badge);
                }
              }
            } else {
              // å¦‚æœæœªç©¿æˆ´ä½†æ ‡è¯†å­˜åœ¨ï¼Œç§»é™¤æ ‡è¯†
              if (equippedBadge) {
                equippedBadge.remove();
              }
            }
          } else {
            // å¦‚æœä¸æ˜¯è£…å¤‡ï¼Œç§»é™¤æ ‡è¯†
            if (equippedBadge) {
              equippedBadge.remove();
            }
          }

          // å¦‚æœæ•°é‡ä¸º0ï¼Œç§»é™¤å¡ç‰Œ
          if (resource.amount <= 0 && !resource.cannotDrop) {
            card.remove();
          }
        }
      });
    }

// æ£€æŸ¥æ˜¯å¦å¯ä»¥çƒ¹é¥ªé£Ÿç‰©
    function canCookWithFire(foodId) {
      // æ£€æŸ¥æ˜¯å¦æœ‰ç¯ç«
      if (!gameData.resources.fire || gameData.resources.fire.amount <= 0) {
        return false;
      }
      
      // æ£€æŸ¥é£Ÿç‰©æ˜¯å¦ä¸ºç”Ÿé£Ÿ
      const food = gameData.resources[foodId];
      return food && (food.isRaw === true || foodId === 'raw_meat' || foodId === 'fish');
    }
    
    // å¤„ç†ç¯ç«çƒ¹é¥ª
    function cookWithFire(foodId) {
      if (!canCookWithFire(foodId)) {
        showNotification('çƒ¹é¥ªå¤±è´¥', 'ä½ éœ€è¦ç¯ç«æ¥çƒ¹é¥ªé£Ÿç‰©ï¼Œæˆ–è€…è¯¥é£Ÿç‰©ä¸èƒ½çƒ¹é¥ªã€‚');
        return;
      }
      
      let cookedFoodId = null;
      
      // æ ¹æ®ç”Ÿé£Ÿç±»å‹ç¡®å®šç†Ÿé£Ÿç±»å‹
      if (foodId === 'raw_meat') {
        cookedFoodId = 'cooked_meat';
      } else if (foodId === 'fish') {
        cookedFoodId = 'grilled_fish';
      }
      
      if (!cookedFoodId) {
        showNotification('çƒ¹é¥ªå¤±è´¥', 'æ— æ³•çƒ¹é¥ªè¿™ç§é£Ÿç‰©ã€‚');
        return;
      }
      
      // æ¶ˆè€—ç”Ÿé£Ÿï¼Œè·å¾—ç†Ÿé£Ÿ
      if (gameData.resources[foodId].amount > 0) {
        gameData.resources[foodId].amount--;
        gameData.resources[cookedFoodId].amount = (gameData.resources[cookedFoodId].amount || 0) + 1;
        
        // æ›´æ–°UI
        renderResources();
        updateResourceCard(foodId);
        updateResourceCard(cookedFoodId);
        
        showNotification('çƒ¹é¥ªæˆåŠŸ', `ä½ æˆåŠŸçƒ¹é¥ªäº†${gameData.resources[cookedFoodId].name}ï¼`);
      }
    }
    
    // ç»™ç¯ç«æ·»åŠ ç‡ƒæ–™
    function addFuelToFire() {
      // æ£€æŸ¥æ˜¯å¦æœ‰ç¯ç«
      if (!gameData.resources.fire || gameData.resources.fire.amount <= 0) {
        showNotification('æ·»åŠ ç‡ƒæ–™å¤±è´¥', 'ä½ æ²¡æœ‰ç¯ç«ã€‚');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æœ¨æ£
      if (!gameData.resources.stick || gameData.resources.stick.amount <= 0) {
        showNotification('æ·»åŠ ç‡ƒæ–™å¤±è´¥', 'ä½ æ²¡æœ‰æœ¨æ£ã€‚');
        return;
      }
      
      // æ£€æŸ¥ç‡ƒæ–™æ˜¯å¦å·²æ»¡
      if (gameData.resources.fire.fuel >= 100) {
        showNotification('æ·»åŠ ç‡ƒæ–™å¤±è´¥', 'ç¯ç«ç‡ƒæ–™å·²æ»¡ï¼Œä¸éœ€è¦æ·»åŠ æ›´å¤šç‡ƒæ–™ã€‚');
        return;
      }
      
      // æ¶ˆè€—ä¸€ä¸ªæœ¨æ£ï¼Œæ·»åŠ 20%ç‡ƒæ–™
      gameData.resources.stick.amount--;
      gameData.resources.fire.fuel = Math.min(100, gameData.resources.fire.fuel + 20);
      
      // æ›´æ–°UI
      renderResources();
      updateResourceCard('fire');
      
      showNotification('æ·»åŠ ç‡ƒæ–™æˆåŠŸ', `ä½ æ·»åŠ äº†ä¸€æ ¹æœ¨æ£ï¼Œç¯ç«ç‡ƒæ–™å¢åŠ åˆ°${gameData.resources.fire.fuel}%`);
    }
    
    // é‡æ–°ç‚¹ç‡ƒç†„ç­çš„ç¯ç«
    function relightFire() {
      // æ£€æŸ¥æ˜¯å¦æœ‰ç¯ç«
      if (!gameData.resources.fire || gameData.resources.fire.amount <= 0) {
        showNotification('ç‚¹ç‡ƒå¤±è´¥', 'ä½ æ²¡æœ‰ç¯ç«ã€‚');
        return;
      }
      
      // æ£€æŸ¥ç¯ç«æ˜¯å¦å·²ç»ç‚¹ç‡ƒ
      if (gameData.resources.fire.fuel > 0) {
        showNotification('ç‚¹ç‡ƒå¤±è´¥', 'ä½ çš„ç¯ç«å·²ç»ç‚¹ç‡ƒäº†ã€‚');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰ç‡§çŸ³
      if (!gameData.resources.flint || gameData.resources.flint.amount <= 0) {
        showNotification('ç‚¹ç‡ƒå¤±è´¥', 'ä½ æ²¡æœ‰ç‡§çŸ³ã€‚');
        return;
      }
      
      // æ¶ˆè€—ä¸€ä¸ªç‡§çŸ³ï¼Œé‡æ–°ç‚¹ç‡ƒç¯ç«
      gameData.resources.flint.amount--;
      
      // è®¾ç½®ç¯ç«ç‡ƒæ–™ä¸º20%
      gameData.resources.fire.fuel = 20;
      
      // æ›´æ–°UI
      updateResourceCard('fire');
      
      showNotification('ç‚¹ç‡ƒæˆåŠŸ', `ä½ ç”¨ç‡§çŸ³é‡æ–°ç‚¹ç‡ƒäº†ç¯ç«ï¼Œç‡ƒæ–™ä¸º20%`);
    }

// æ£€æŸ¥åˆ¶ä½œçª—å£çš„ç»„åˆ
    function checkCraftingCombination() {
      const slots = Object.values(craftingSlotsData).filter(Boolean);

if (slots.length >= 2) {
        craftingCombineButton.disabled = false;
      } else {
        craftingCombineButton.disabled = true;
      }
    }

// åˆ¶ä½œçª—å£çš„ç»„åˆåŠŸèƒ½
    craftingCombineButton.addEventListener('click', function() {
      const slots = Object.values(craftingSlotsData).filter(Boolean);

if (slots.length < 2) {
        showNotification('ç»„åˆå¤±è´¥', 'éœ€è¦è‡³å°‘ä¸¤å¼ å¡ç‰Œæ‰èƒ½ç»„åˆã€‚');
        return;
      }

// æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•é…æ–¹
      let matchedRecipe = null;

for (const recipe of gameData.recipes) {
        const ingredients = Object.keys(recipe.ingredients);

// æ£€æŸ¥é…æ–¹æ‰€éœ€çš„æ‰€æœ‰èµ„æºæ˜¯å¦éƒ½åœ¨ç»„åˆæ§½ä¸­
        let hasAllIngredients = true;
        const slotCounts = {};

// ç»Ÿè®¡æ§½ä½ä¸­æ¯ç§èµ„æºçš„æ•°é‡
        slots.forEach(resourceId => {
          slotCounts[resourceId] = (slotCounts[resourceId] || 0) + 1;
        });

// æ£€æŸ¥æ¯ç§æˆåˆ†æ˜¯å¦è¶³å¤Ÿ
        for (const ingredientId of ingredients) {
          const requiredAmount = recipe.ingredients[ingredientId];
          const availableAmount = slotCounts[ingredientId] || 0;

if (availableAmount < requiredAmount) {
            hasAllIngredients = false;
            break;
          }
        }

if (hasAllIngredients) {
          matchedRecipe = recipe;
          break;
        }
      }

if (matchedRecipe) {
        // ä¿å­˜å½“å‰é…æ–¹å¼•ç”¨ï¼Œä»¥ä¾¿åœ¨å›è°ƒä¸­ä½¿ç”¨
        const currentRecipe = matchedRecipe;
        
        // å¯¹æ‰€æœ‰åŒ¹é…çš„é…æ–¹éƒ½è§¦å‘æ»‘å—æ¸¸æˆ
        // æ£€æŸ¥æ˜¯å¦åŒ…å«è£…å¤‡ç±»ç‰©å“ - æ£€æŸ¥äº§ç‰©æ˜¯å¦ä¸ºè£…å¤‡ç±»ç‰©å“
        const hasEquipment = Object.keys(currentRecipe.result).some(resultId => gameData.resources[resultId] && gameData.resources[resultId].category === 'equipment');
        // åˆ›å»ºæ¸¸æˆé…ç½®
        const gameConfig = {
          speed: hasEquipment ? 4 : 2, // è£…å¤‡ç±»ç‰©å“é€Ÿåº¦ä¸º4ï¼Œéè£…å¤‡ç±»ç‰©å“é€Ÿåº¦ä¸º2
          targetWidth: hasEquipment ? 0.08 : 0.1, // è£…å¤‡ç±»ç‰©å“ç›®æ ‡åŒºåŸŸå®½åº¦ä¸º0.08ï¼Œéè£…å¤‡ç±»ç‰©å“ç›®æ ‡åŒºåŸŸå®½åº¦ä¸º0.1
          timeLimit: 10 // æ—¶é—´é™åˆ¶ï¼ˆç§’ï¼‰
        };
        console.log('æ»‘å—æ¸¸æˆé…ç½®:', gameConfig);

// è°ƒç”¨æ»‘å—æ¸¸æˆ
        startSliderGame(gameConfig, (success) => {
          if (success) {
            // æ¶ˆè€—ææ–™
            for (const [ingredientId, amount] of Object.entries(currentRecipe.ingredients)) {
              let used = 0;
              for (let i = 1; i <= 3; i++) {
                if (craftingSlotsData[i] === ingredientId && used < amount) {
                  craftingSlotsData[i] = null;
                  used++;
                }
              }
            }

// å¢åŠ äº§ç‰©
            let firstResultId = null;
            if (currentRecipe.result) {
              // å¤„ç†resultå¯¹è±¡ - å®ƒçš„ç»“æ„æ˜¯{ resourceId: amount }ï¼Œä¾‹å¦‚{ pill: 1 }
              for (const [resultId, resultAmount] of Object.entries(currentRecipe.result)) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯èµ„æºIDè¿˜æ˜¯ç‰¹æ®Šå±æ€§ï¼ˆæ’é™¤æ¸¸æˆå±æ€§å’Œéèµ„æºé¡¹ï¼‰
                if (resultId === 'name' || resultId === 'description' ||
                    resultId === 'reputation' || resultId === 'begging_chance' ||
                    resultId === 'begging_level' || resultId === 'max_hunger' ||
                    resultId === 'max_thirst' || resultId === 'max_health' ||
                    resultId === 'hunger_rate' || resultId === 'thirst_rate' ||
                    resultId === 'health_rate' || resultId === 'cold' || resultId === 'health' ||
                    resultId === 'thirst' || resultId === 'hunger' || resultId === 'spirit') {
                  // è¿™äº›æ˜¯æ¸¸æˆå±æ€§ï¼Œç›´æ¥åº”ç”¨åˆ°gameData
                  if (resultId in gameData.status) {
                    gameData.status[resultId] = Math.min(100, Math.max(0, gameData.status[resultId] + resultAmount));
                  } else if (resultId in gameData) {
                    gameData[resultId] += resultAmount;
                  }
                  continue;
                }

// è®°å½•ç¬¬ä¸€ä¸ªç»“æœIDç”¨äºæ˜¾ç¤º
                if (!firstResultId) firstResultId = resultId;

// ç¡®ä¿äº§ç‰©èµ„æºå­˜åœ¨äºgameData.resourcesä¸­
                if (gameData.resources[resultId]) {
                  // ç‰¹æ®Šå¤„ç†ï¼šåˆ¶ä½œæ°´è¢‹å’Œæœ¨æ¡¶æ—¶ï¼Œä¸ºæ¯ä¸ªæ–°åˆ¶ä½œåˆ›å»ºå®ä¾‹ï¼ˆéƒ½å¸¦æ°´ä½æŒ‡ç¤ºæ¡ï¼‰
                  if (resultId === 'water_bag' || resultId === 'bucket') {
                    if (!gameData.resources[resultId].instances) {
                      gameData.resources[resultId].instances = [];
                    }
                    for (let i = 0; i < resultAmount; i++) {
                      const newInstanceId = Date.now() + Math.random().toString(36).substr(2, 9);
                      gameData.resources[resultId].instances.push({
                        id: newInstanceId,
                        waterLevel: 0, // åˆå§‹ä¸ºç©º
                        durability: 100, // åˆå§‹è€ä¹…åº¦100
                        createdAt: Date.now()
                      });
                    }
                    // å®ä¾‹æ•°é‡ç­‰äºå®é™…æ•°é‡
                    gameData.resources[resultId].amount = gameData.resources[resultId].instances.length;
                  } else {
                    gameData.resources[resultId].amount += resultAmount;
                  }
                } else {
                  // å¦‚æœèµ„æºä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                  // ç‰¹æ®Šå¤„ç†ä¸€äº›å·²çŸ¥èµ„æº
                  let resourceName, resourceImage;
                  switch(resultId) {
                    case 'pill':
                      resourceName = 'è¯ä¸¸';
                      resourceImage = 'UI/è¯ä¸¸.jpg';
                      break;
                    case 'gold':
                      resourceName = 'é‡‘å­';
                      resourceImage = 'UI/é‡‘å­.jpg';
                      break;
                    case 'silver_piece':
                      resourceName = 'ç¢é“¶å­';
                      resourceImage = 'UI/ç¢é“¶å­.jpg';
                      break;
                    case 'black_cloak':
                      resourceName = 'é»‘è‰²æ–—ç¯·';
                      resourceImage = 'UI/é»‘è‰²æ–—ç¯·.jpg';
                      break;
                    default:
                      resourceName = resultId.charAt(0).toUpperCase() + resultId.slice(1).replace('_', ' ');
                      resourceImage = `UI/${resultId}.jpg`;
                  }

                  // ç‰¹æ®Šå¤„ç†ï¼šåˆ¶ä½œæ°´è¢‹å’Œæœ¨æ¡¶æ—¶ï¼Œåˆ›å»ºå®ä¾‹ï¼ˆéƒ½å¸¦æ°´ä½æŒ‡ç¤ºæ¡ï¼‰
                  let instances = null;
                  if (resultId === 'water_bag' || resultId === 'bucket') {
                    instances = [];
                    for (let i = 0; i < resultAmount; i++) {
                      const newInstanceId = Date.now() + Math.random().toString(36).substr(2, 9);
                      instances.push({
                        id: newInstanceId,
                        waterLevel: 0, // åˆå§‹ä¸ºç©º
                        durability: 100, // åˆå§‹è€ä¹…åº¦100
                        createdAt: Date.now()
                      });
                    }
                  }

                  gameData.resources[resultId] = {
                    id: resultId,
                    name: resourceName,
                    amount: resultAmount,
                    image: resourceImage,
                    category: 'material', // é»˜è®¤åˆ†ç±»
                    pinned: false, // æ–°åˆ¶ä½œçš„ç‰©å“ä¸å›ºå®š
                    instances: instances // æ°´è¢‹å’Œæœ¨æ¡¶çš„å®ä¾‹
                  };
                }
              }
            }

// ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯use_bucketé…æ–¹ï¼Œå‡å°‘æœ¨æ¡¶çš„æ°´é‡
            if (currentRecipe.id === 'use_bucket' && gameData.resources.bucket) {
              const bucket = gameData.resources.bucket;
              if (bucket.waterLevel >= 50) {
                bucket.waterLevel -= 50;
              } else {
                bucket.waterLevel = 0;
              }

              // æ›´æ–°æœ¨æ¡¶å›¾ç‰‡ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å‡½æ•°ï¼‰
              updateContainerImage('bucket');

              // å‡å°‘æœ¨æ¡¶è€ä¹…åº¦ï¼ˆæ¯æ¬¡ä½¿ç”¨å‡å°‘2ï¼‰
              if (bucket.durability === undefined) {
                bucket.durability = 100;
              }
              bucket.durability = Math.max(0, bucket.durability - 2);

              // å¦‚æœè€ä¹…åº¦ä¸º0ï¼Œè‡ªåŠ¨é”€æ¯æœ¨æ¡¶
              if (bucket.durability <= 0) {
                bucket.amount--;
                if (bucket.amount <= 0) {
                  bucket.durability = undefined;
                } else {
                  bucket.durability = 100;
                }
                showNotification('æœ¨æ¡¶æŸå', 'æœ¨æ¡¶å·²æŸåå¹¶è‡ªåŠ¨é”€æ¯ï¼');
              }
            }

            // å¦‚æœæ˜¯use_bucketé…æ–¹ï¼Œæ›´æ–°æ‰€æœ‰çª—å£ä¸­çš„æœ¨æ¡¶å¡ç‰Œå’Œæ°´è¢‹å¡ç‰Œ
            if (currentRecipe.id === 'use_bucket') {
              updateResourceCard('bucket');
              updateResourceCard('water_bag');
              // æ›´æ–°ä»“åº“çª—å£
              const storageModal = document.getElementById('storageModal');
              if (storageModal && storageModal.classList.contains('active')) {
                populateStorageModal();
              }
              // æ›´æ–°ç‰²å£æ£šçª—å£
              const livestockModal = document.getElementById('livestockModal');
              if (livestockModal && livestockModal.classList.contains('active')) {
                updateFeedDisplay();
              }
              // æ›´æ–°å†œç”°çª—å£
              if (window.updateFarmlandRelatedResources) {
                window.updateFarmlandRelatedResources();
              }
            }

// æ˜¾ç¤ºè·å¾—æ–°å¡ç‰Œçš„å¼¹çª—å‡½æ•°
            function showCardAcquiredModal(resource) {
              // åˆ›å»ºæ¨¡æ€æ¡†å…ƒç´ 
              const cardModal = document.createElement('div');
              cardModal.className = 'card-acquired-modal';
              
              // ç¡®ä¿å›¾ç‰‡è·¯å¾„æ­£ç¡®
              let imageUrl = resource.image;
              if (!imageUrl.startsWith('UI/') && !imageUrl.startsWith('http')) {
                imageUrl = 'UI/' + imageUrl;
              }
              
              // æ£€æŸ¥æ˜¯å¦æ˜¯è£…å¤‡å¹¶ä¸”å·²ç©¿æˆ´
              const isEquipped = resource.equipmentSlot && resource.equipped;
              
              cardModal.innerHTML = `
                <div class="card-acquired-modal-content">
                  <div class="card-acquired-modal-header">
                    <h3 class="card-acquired-modal-title">æ­å–œä½ ï¼Œè·å¾—æ–°çš„å¡ç‰Œ</h3>
                    <button class="card-acquired-modal-close ink-button ink-button-small">&times;</button>
                  </div>
                  <div class="card-acquired-modal-body">
                    <div class="acquired-card">
                      <div class="card-image-container">
                        <img class="card-image" src="${imageUrl}" alt="${resource.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="image-fallback">
                          å›¾ç‰‡åŠ è½½å¤±è´¥
                        </div>
                        ${isEquipped ? `<div class="equipped-badge">å·²ç©¿æˆ´</div>` : ''}
                      </div>
                      <div class="card-info">
                        <div class="card-name">${resource.name}</div>
                        <div class="card-amount">è·å¾—æ•°é‡: ${resource.amount > 1 ? resource.amount : 1}</div>
                        ${resource.equipmentSlot ? `<div class="card-equipment-slot">è£…å¤‡æ§½ä½: ${resource.equipmentSlot}</div>` : ''}
                      </div>
                    </div>
                  </div>
                </div>
              `;

// æ·»åŠ æ ·å¼
              const style = document.createElement('style');
              style.textContent = `
                .card-acquired-modal {
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background-color: rgba(0, 0, 0, 0.5);
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  z-index: 1500;
                  opacity: 0;
                  pointer-events: none;
                  transition: opacity 0.3s ease;
                }

.card-acquired-modal.active {
                  opacity: 1;
                  pointer-events: auto;
                }

.card-acquired-modal.closing {
                  opacity: 0;
                }

.card-acquired-modal-content {
                  background-color: white;
                  border-radius: 8px;
                  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                  max-width: 400px;
                  width: 90%;
                  transform: translateY(-20px);
                  transition: transform 0.3s ease;
                }

.card-acquired-modal.active .card-acquired-modal-content {
                  transform: translateY(0);
                }

.card-acquired-modal.closing .card-acquired-modal-content {
                  transform: translateY(-20px);
                }

.card-acquired-modal-header {
                  padding: 16px 20px;
                  border-bottom: 1px solid #e0e0e0;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                }

.card-acquired-modal-title {
                  font-size: 20px;
                  font-weight: normal;
                  margin: 0;
                  color: #333;
                  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
                }

.card-acquired-modal-close {
                  background: none;
                  border: none;
                  font-size: 24px;
                  cursor: pointer;
                  color: #999;
                  line-height: 1;
                  padding: 0;
                  width: 30px;
                  height: 30px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 4px;
                  transition: background-color 0.2s ease, color 0.2s ease;
                }

.card-acquired-modal-close:hover {
                  background-color: #f0f0f0;
                  color: #333;
                }

.card-acquired-modal-body {
                  padding: 20px;
                }

.acquired-card {
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                }

.card-image-container {
                  width: 180px;
                  height: 250px;
                  border-radius: 8px;
                  margin-bottom: 16px;
                  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
                  background-color: #e2e8f0; /* æ·»åŠ é»˜è®¤èƒŒæ™¯è‰² */
                  position: relative;
                  overflow: hidden;
                }

                .card-image {
                  width: 100%;
                  height: 100%;
                  object-fit: cover;
                  display: block;
                }

                .image-fallback {
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background-color: #e2e8f0;
                  display: none;
                  align-items: center;
                  justify-content: center;
                  color: #4a5568;
                  font-size: 0.8rem;
                  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
                }

                .equipped-badge {
                  position: absolute;
                  bottom: 0.5rem;
                  right: 0.5rem;
                  background-color: #38A169;
                  color: white;
                  border-radius: 4px;
                  padding: 0.25rem 0.5rem;
                  font-size: 0.7rem;
                  font-weight: normal;
                  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                  z-index: 10;
                }

.card-info {
                  text-align: center;
                }

.card-name {
                  font-size: 18px;
                  font-weight: normal;
                  margin-bottom: 8px;
                  color: #333;
                  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
                }

.card-amount {
                  font-size: 14px;
                  font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
                  color: #666;
                }
              `;

// æ·»åŠ åˆ°DOM
              document.head.appendChild(style);
              document.body.appendChild(cardModal);

// æ˜¾ç¤ºæ¨¡æ€æ¡†
              setTimeout(() => {
                cardModal.classList.add('active');
              }, 10);

// å…³é—­æŒ‰é’®äº‹ä»¶
              const closeButton = cardModal.querySelector('.card-acquired-modal-close');
              closeButton.addEventListener('click', closeModal);

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
              cardModal.addEventListener('click', (e) => {
                if (e.target === cardModal) {
                  closeModal();
                }
              });

// å…³é—­æ¨¡æ€æ¡†å‡½æ•°
              function closeModal() {
                cardModal.classList.add('closing');
                setTimeout(() => {
                  if (cardModal.parentNode === document.body) {
            document.body.removeChild(cardModal);
          }
          if (style.parentNode === document.head) {
            document.head.removeChild(style);
          }
                }, 300);
              }
            }

// åœ¨æ»‘å—æ¸¸æˆå›è°ƒå†…éƒ¨æ˜¾ç¤ºè·å¾—æ–°å¡ç‰Œçš„å¼¹çª—
            if (firstResultId) {
              showCardAcquiredModal(gameData.resources[firstResultId]);
            }

// æ›´æ–°ç•Œé¢
            renderResources();
            renderCraftingInventory();
            updateCraftingSlots();
            checkCraftingCombination();
          } else {
            // æ¸¸æˆå¤±è´¥ï¼Œæ¶ˆè€—å½“å‰åˆ¶ä½œé¢æ¿çš„å¡ç‰Œ
            console.log('æ»‘å—æ¸¸æˆå¤±è´¥ï¼Œå¼€å§‹æ¶ˆè€—åˆ¶ä½œé¢æ¿çš„å¡ç‰Œ');
            console.log('å½“å‰åˆ¶ä½œæ§½:', craftingSlotsData);
            console.log('åŒ¹é…çš„é…æ–¹:', currentRecipe);
            
            // æ¶ˆè€—èƒŒåŒ…ä¸­çš„èµ„æº
            for (const [resource, requiredAmount] of Object.entries(currentRecipe.ingredients)) {
              if (resource in gameData.resources && !nonConsumableBowls.includes(resource)) {
                const originalAmount = gameData.resources[resource].amount;
                gameData.resources[resource].amount = Math.max(0, originalAmount - requiredAmount);
                console.log(`æ¶ˆè€—äº†${requiredAmount}ä¸ª${resource}ï¼Œå‰©ä½™${gameData.resources[resource].amount}ä¸ª`);

// æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦æ­£åœ¨è£…å¤‡ä¸­
                if (gameData.resources[resource].equipped) {
                  // å¦‚æœç‰©å“æ•°é‡å˜ä¸º0ï¼Œè‡ªåŠ¨å¸ä¸‹è£…å¤‡
                  if (gameData.resources[resource].amount === 0) {
                    // ç§»é™¤è£…å¤‡æ•ˆæœ
                    applyEquipmentEffect(resource, 'unequip');
                    // ç§»é™¤è£…å¤‡çŠ¶æ€
                    gameData.resources[resource].equipped = false;
                  }
                }
              } else if (nonConsumableBowls.includes(resource)) {
                console.log(`${resource}æ˜¯ç¢—ç±»å¡ç‰Œï¼Œä¸å¯æ¶ˆè€—`);
              }
            }

// æ¸…ç©ºåˆ¶ä½œæ§½ï¼ˆä¿ç•™ç¢—ç±»å¡ç‰Œï¼‰
            for (const slot in craftingSlotsData) {
              const resourceId = craftingSlotsData[slot];
              if (resourceId && !nonConsumableBowls.includes(resourceId)) {
                craftingSlotsData[slot] = null;
              } else if (resourceId && nonConsumableBowls.includes(resourceId)) {
                console.log(`ç¢—ç±»å¡ç‰Œ ${resourceId} ä¿ç•™åœ¨åˆ¶ä½œæ§½ä¸­`);
              }
            }

// æ›´æ–°UI
            updateCraftingSlots();
            renderCraftingInventory();
            renderResources();
            checkCraftingCombination();

// å¼¹å‡ºæ¸¸æˆå¤±è´¥æç¤ºçª—å£
            showNotification('æ¸¸æˆå¤±è´¥', 'æ¸¸æˆå¤±è´¥ï¼Œæœªèƒ½åˆ¶ä½œå‡ºæ–°çš„å¡ç‰Œ', 'error');
          }
        });
      } else {
        // æ²¡æœ‰åŒ¹é…çš„é…æ–¹
        showNotification('ç»„åˆå¤±è´¥', 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é…æ–¹ã€‚');
      }
    });

// åˆ¶ä½œçª—å£çš„é…æ–¹åŠŸèƒ½
    function showRecipeModal() {
      renderRecipes();
      elements.recipeModal.classList.add('active');
    }

// è‡ªåŠ¨å¡«å……åˆ¶ä½œæ§½ï¼ˆç”¨äºé…æ–¹ç‚¹å‡»ï¼‰
    function autoFillCraftingSlots(recipe) {
      // å…ˆæ¸…ç©ºåˆ¶ä½œæ§½
      for (const slotNumber in craftingSlotsData) {
        const resourceId = craftingSlotsData[slotNumber];
        if (resourceId) {
          // å°†åˆ¶ä½œæ§½ä¸­çš„ç‰©å“æ”¾å›èƒŒåŒ…
          gameData.resources[resourceId].amount++;
          craftingSlotsData[slotNumber] = null;
        }
      }

      // å°†é…æ–¹æ‰€éœ€ç‰©å“æ”¾å…¥åˆ¶ä½œæ§½
      for (const [resourceId, amount] of Object.entries(recipe.ingredients)) {
        // æ£€æŸ¥èƒŒåŒ…æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç‰©å“
        if (gameData.resources[resourceId] && gameData.resources[resourceId].amount >= amount) {
          // å°†ç‰©å“æ”¾å…¥åˆ¶ä½œæ§½
          for (let i = 0; i < amount; i++) {
            // å¯»æ‰¾ç¬¬ä¸€ä¸ªç©ºæ§½ä½
            for (const slotNumber in craftingSlotsData) {
              if (craftingSlotsData[slotNumber] === null) {
                craftingSlotsData[slotNumber] = resourceId;
                gameData.resources[resourceId].amount--;
                break;
              }
            }
          }
        } else {
          showNotification('èµ„æºä¸è¶³', `${gameData.resources[resourceId]?.name || resourceId} æ•°é‡ä¸è¶³ï¼`);
          // èµ„æºä¸è¶³æ—¶ï¼Œåœæ­¢æ‰§è¡Œ
          renderCraftingInventory();
          updateCraftingSlots();
          checkCraftingCombination();
          return;
        }
      }

      // æ›´æ–°UI
      renderCraftingInventory();
      updateCraftingSlots();
      checkCraftingCombination();
    }

craftingRecipeButton.addEventListener('click', function() {
      showRecipeModal();
    });

// æ¸…ç©ºåˆ¶ä½œçª—å£çš„ç»„åˆæ§½
    function clearCraftingSlots() {
      for (const slotNumber in craftingSlotsData) {
        const resourceId = craftingSlotsData[slotNumber];
        if (resourceId) {
          // æ ¹æ®æ¥æºå°†èµ„æºæ”¾å›èƒŒåŒ…æˆ–åœ°é¢æ 
          const source = craftingSlotsSource[slotNumber];
          if (source === 'backpack') {
            // æ£€æŸ¥æ˜¯å¦ä¸ºç¢—ç±»å¡ç‰Œ
            if (nonConsumableBowls.includes(resourceId)) {
              console.log('å°†ç¢—ç±»å¡ç‰Œæ”¾å›èƒŒåŒ…:', resourceId);
              // å°†ç¢—ç±»å¡ç‰Œæ”¾å›èƒŒåŒ…
              gameData.resources[resourceId].amount++;
            } else {
              console.log('å°†éç¢—ç±»èµ„æºæ”¾å›èƒŒåŒ…:', resourceId);
              // å°†éç¢—ç±»èµ„æºæ”¾å›èƒŒåŒ…
              gameData.resources[resourceId].amount++;
            }
          } else if (source === 'ground') {
            // å°†èµ„æºæ”¾å›åœ°é¢æ 
            const currentLocation = gameData.locations.find(loc => loc.currentLocation);
            if (currentLocation) {
              const locationId = currentLocation.id;
              addResourceToGround(resourceId, 1, locationId);
            }
          }
          // æ¸…ç©ºæ§½ä½å’Œæ¥æº
          craftingSlotsData[slotNumber] = null;
          craftingSlotsSource[slotNumber] = null;
        }
      }
      // é‡æ–°æ¸²æŸ“å·¦ä¾§å¡ç‰Œåˆ—è¡¨å’Œå³ä¾§æ§½ä½
      renderCraftingInventory();
      updateCraftingSlots();
      // æ›´æ–°ä¸»é¡µèƒŒåŒ…æ˜¾ç¤º
      renderResources();
    }

    // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
    function checkGameOver() {
      if (!gameData.status) return;
      
      // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å·²ç»ç»“æŸï¼Œé¿å…é‡å¤è§¦å‘
      if (gameData.gameOver) {
        console.log('æ¸¸æˆå·²ç»“æŸï¼Œè·³è¿‡æ£€æŸ¥');
        return;
      }
      
      // æµ‹è¯•å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨
      console.log('checkGameOverå‡½æ•°è¢«è°ƒç”¨');
      console.log('å½“å‰æ¸¸æˆçŠ¶æ€:', gameData.status);
      
      // æ£€æŸ¥é¥±é£Ÿã€ç²¾ç¥ã€è¡€é‡ã€å¥åº·ã€æ°´åˆ†çŠ¶æ€ä¸º0æˆ–ä½“æ¸©å¼‚å¸¸
      if (gameData.status.health <= 0 || 
          gameData.status.hunger <= 0 || // é¥±é£Ÿåº¦é™è‡³0
          gameData.status.spirit <= 0 || // ç²¾ç¥çŠ¶æ€ä¸º0
          gameData.status.blood <= 0 || // è¡€é‡ä¸º0
          gameData.status.thirst <= 0 || // æ°´åˆ†è€—å°½ï¼ˆå®Œå…¨ç¼ºæ°´ï¼‰
          gameData.status.cold <= 34 || gameData.status.cold >= 42) { // ä½“æ¸©å¼‚å¸¸ï¼ˆä½äº34â„ƒæˆ–é«˜äº42â„ƒï¼‰
        
        // è®¾ç½®æ¸¸æˆç»“æŸçŠ¶æ€
        gameData.gameOver = true;
        
        // è§¦å‘æ¸¸æˆå¤±è´¥å¹¶æ˜¾ç¤ºå…·ä½“åŸå› 
        console.log('æ¸¸æˆç»“æŸæ¡ä»¶æ»¡è¶³ï¼Œæ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—');
        showGameOverModal();
      }
    }

    // æ˜¾ç¤ºæ¸¸æˆå¤±è´¥å¼¹çª—
    function showGameOverModal() {
      // æµ‹è¯•å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨
      console.log('showGameOverModalå‡½æ•°è¢«è°ƒç”¨');

      // åœæ­¢æ‰€æœ‰éŸ³ä¹å’ŒéŸ³æ•ˆ
      try {
        console.log('åœæ­¢æ‰€æœ‰éŸ³é¢‘...');
        if (typeof stopAllAudio === 'function') {
          stopAllAudio();
          console.log('æ‰€æœ‰éŸ³é¢‘å·²åœæ­¢');
        }
      } catch(audioError) {
        console.error('åœæ­¢éŸ³é¢‘æ—¶å‡ºé”™:', audioError);
      }

      // è·å–å·²å­˜åœ¨çš„æ¸¸æˆç»“æŸæ¨¡æ€æ¡†
      const gameOverModal = document.getElementById('gameOverModal');
      if (!gameOverModal) {
        console.error('æ— æ³•æ‰¾åˆ°æ¸¸æˆç»“æŸæ¨¡æ€æ¡†');
        return;
      }

      // ç¡®å®šæ¸¸æˆç»“æŸçš„å…·ä½“åŸå› 
      let gameOverReason = "æ‚¨çš„çŠ¶æ€å·²è¾¾åˆ°å±é™©æ°´å¹³ï¼";
      
      if (gameData.status.health <= 0) {
        gameOverReason = "æ‚¨çš„å¥åº·çŠ¶å†µå·²ä¸¥é‡æ¶åŒ–ï¼Œæ— æ³•ç»§ç»­æ¸¸æˆï¼";
      } else if (gameData.status.hunger <= 0) {
        gameOverReason = "æ‚¨å·²ç»é¥¿å¾—æ— æ³•ç»§ç»­å‰è¿›äº†ï¼";
      } else if (gameData.status.spirit <= 0) {
        gameOverReason = "æ‚¨çš„ç²¾ç¥çŠ¶æ€å·²å´©æºƒï¼Œæ— æ³•ç»§ç»­æ¸¸æˆï¼";
      } else if (gameData.status.blood <= 0) {
        gameOverReason = "æ‚¨å¤±è¡€è¿‡å¤šï¼Œæ— æ³•ç»§ç»­æ¸¸æˆï¼";
      } else if (gameData.status.thirst <= 0) {
        gameOverReason = "æ‚¨å·²ç»ä¸¥é‡è„±æ°´ï¼Œæ— æ³•ç»§ç»­å‰è¿›äº†ï¼";
      } else if (gameData.status.cold == 30 || gameData.status.cold == 50) {
        gameOverReason = gameData.status.cold <= 34 ? "æ‚¨çš„ä½“æ¸©è¿‡ä½ï¼Œæ— æ³•ç»§ç»­æ¸¸æˆï¼" : "æ‚¨çš„ä½“æ¸©è¿‡é«˜ï¼Œæ— æ³•ç»§ç»­æ¸¸æˆï¼";
      }
      
      // æ›´æ–°æ¸¸æˆç»“æŸåŸå› 
      const gameOverText = document.getElementById('gameOverText');
      if (gameOverText) {
        gameOverText.textContent = gameOverReason;
      }
      
      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      const daysSurvived = document.getElementById('daysSurvived');
      const maxReputation = document.getElementById('maxReputation');
      const resourcesCollected = document.getElementById('resourcesCollected');
      const recipesDiscovered = document.getElementById('recipesDiscovered');
      
      if (daysSurvived) daysSurvived.textContent = gameData.stats.daysSurvived || 0;
      if (maxReputation) maxReputation.textContent = (gameData.stats.maxReputation || 0) + '%';
      if (resourcesCollected) resourcesCollected.textContent = gameData.stats.resourcesCollected || 0;
      if (recipesDiscovered) recipesDiscovered.textContent = gameData.stats.recipesDiscovered || 0;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      gameOverModal.classList.add('active');
    }

    // è¿”å›å¼€å§‹æ¸¸æˆé¡µé¢
    function returnToStartPage() {
      console.log('returnToStartPageå‡½æ•°è¢«è°ƒç”¨ï¼Œå¼€å§‹é‡ç½®æ¸¸æˆæ•°æ®...');

      // åœæ­¢æ‰€æœ‰éŸ³ä¹å’ŒéŸ³æ•ˆ
      try {
        console.log('åœæ­¢æ‰€æœ‰éŸ³é¢‘...');
        if (typeof stopAllAudio === 'function') {
          stopAllAudio();
          console.log('æ‰€æœ‰éŸ³é¢‘å·²åœæ­¢');
        }
      } catch(audioError) {
        console.error('åœæ­¢éŸ³é¢‘æ—¶å‡ºé”™:', audioError);
      }

      // éšè—æ¸¸æˆå¤±è´¥å¼¹çª—
      const gameOverModal = document.querySelector('.game-over-modal');
      if (gameOverModal) {
        gameOverModal.classList.remove('active');
        console.log('æ¸¸æˆç»“æŸå¼¹çª—å·²éšè—');
      }

      // éšè—æ¸¸æˆå®¹å™¨
      const gameContainer = document.getElementById('gameContainer');
      if (gameContainer) {
        gameContainer.style.display = 'none';
        console.log('æ¸¸æˆå®¹å™¨å·²éšè—');
      }

      // æ˜¾ç¤ºå¼€å§‹æ¸¸æˆç•Œé¢
      const startScreen = document.getElementById('startScreen');
      if (startScreen) {
        startScreen.style.display = 'flex';
        startScreen.style.opacity = '1';
        console.log('å¼€å§‹æ¸¸æˆç•Œé¢å·²æ˜¾ç¤º');
      }

      // å®Œæ•´é‡ç½®æ¸¸æˆæ•°æ®
      try {
        console.log('å¼€å§‹é‡ç½®æ¸¸æˆæ•°æ®...');
        
        // ä½¿ç”¨resetGameå‡½æ•°è¿›è¡Œå®Œæ•´é‡ç½®
        if (typeof resetGame === 'function') {
          try {
            console.log('è°ƒç”¨resetGameå‡½æ•°é‡ç½®æ¸¸æˆ');
            resetGame();
            console.log('resetGameå‡½æ•°è°ƒç”¨æˆåŠŸ');
          } catch (resetFuncError) {
            console.error('è°ƒç”¨resetGameå‡½æ•°å¤±è´¥:', resetFuncError);
            // é‡ç½®å¤±è´¥æ—¶è¿›è¡Œæ‰‹åŠ¨é‡ç½®
            performManualGameReset();
          }
        } else {
          console.log('resetGameå‡½æ•°ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨é‡ç½®åŸºæœ¬æ•°æ®');
          performManualGameReset();
        }
        
        // å°è¯•è°ƒç”¨initGameé‡æ–°åˆå§‹åŒ–
        if (typeof initGame === 'function') {
          console.log('å°è¯•è°ƒç”¨initGameå‡½æ•°é‡æ–°åˆå§‹åŒ–æ¸¸æˆ');
          try {
            initGame();
            console.log('initGameå‡½æ•°è°ƒç”¨æˆåŠŸ');
          } catch(initError) {
            console.warn('initGameè°ƒç”¨å¤±è´¥ï¼Œä½†ä¸å½±å“è¿”å›å¼€å§‹ç•Œé¢:', initError);
          }
        }
      } catch(resetError) {
        console.error('é‡ç½®æ¸¸æˆæ•°æ®æ—¶å‡ºé”™:', resetError);
      }
    }

    // é‡ç½®æ¸¸æˆæ•°æ®
    function resetGameData() {
      // é‡ç½®æ¸¸æˆçŠ¶æ€
      gameData.status = {
        health: 100, // åˆå§‹å¥åº·åº¦ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        hunger: 100, // åˆå§‹é¥±é£Ÿåº¦ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        cold: 100, // åˆå§‹ä½“æ¸©ä¿æŒä¸å˜
        thirst: 100, // åˆå§‹æ°´åˆ†ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        spirit: 100, // åˆå§‹ç²¾ç¥å€¼ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        blood: 100, // åˆå§‹è¡€é‡ä¸º100ï¼ˆæ»¡å€¼ï¼‰
        actionPoints: 20 // åˆå§‹è¡ŒåŠ¨ç‚¹ä¸º20ï¼ˆæ»¡å€¼ï¼‰
      };

      // é‡ç½®èµ„æº
      gameData.resources = {
        food: { amount: 0, equipped: false },
        stick: { amount: 0, equipped: false },
        herb: { amount: 0, equipped: false },
        money: { amount: 0, equipped: false }
      };

      // é‡ç½®æŠ€èƒ½
      gameData.skills = {
        search: { level: 0, experience: 0 },
        steal: { level: 0, experience: 0 },
        rest: { level: 0, experience: 0 },
        cook: { level: 0, experience: 0 },
        fight: { level: 0, experience: 0 },
        collect: { level: 0, experience: 0 },
        craft: { level: 0, experience: 0 }
      };

      // é‡ç½®å¡ç‰Œ
      gameData.cards = [];

      // é‡ç½®åˆ¶ä½œæ§½
      craftingSlotsData = {
        slot1: null,
        slot2: null,
        slot3: null,
        slot4: null,
        slot5: null
      };

      // é‡ç½®åœ°ç‚¹çŠ¶æ€
      gameData.locations.forEach(location => {
        // é‡ç½®æ‰€æœ‰åœ°ç‚¹çš„availableçŠ¶æ€ä¸ºåˆå§‹å€¼
        switch(location.id) {
          case 'black_market':
            location.available = false; // é»‘å¸‚åˆå§‹ä¸ºä¸å¯ç”¨
            break;
          case 'prison':
            location.available = false; // ç›‘ç‹±åˆå§‹ä¸ºä¸å¯ç”¨
            location.sentenceDays = 0;
            break;
          default:
            location.available = true; // å…¶ä»–åœ°ç‚¹åˆå§‹ä¸ºå¯ç”¨
        }
        location.currentLocation = false;
      });

      // å°†ä¸œè¥¿å¸‚è®¾ç½®ä¸ºåˆå§‹å½“å‰åœ°ç‚¹
      const streetLocation = gameData.locations.find(loc => loc.id === 'street');
      if (streetLocation) {
        streetLocation.currentLocation = true;
      }

      // é‡ç½®è§£é”æ ‡å¿—
      gameData.flags = {
        blackMarketUnlocked: false,
        gameOver: false
      };
    }

    // æ’¬é”æ¸¸æˆç›¸å…³ä»£ç 
    function showLockpickGame() {
      const lockpickModal = document.createElement('div');
      lockpickModal.className = 'lockpick-game-modal';
      lockpickModal.innerHTML = `
        <div class="lockpick-game-content">
          <h2>æ’¬é”å°æ¸¸æˆ</h2>
          <div class="timer-container">
            <div class="timer-bar" id="timerBar">
              <div class="timer-bar-fill" id="timerBarFill"></div>
            </div>
            <div class="timer-text" id="timerText">å‰©ä½™æ—¶é—´: 10ç§’</div>
          </div>
          <div class="lock-container">
            <canvas id="lockCanvas" width="300" height="300"></canvas>
          </div>
          <div class="lock-controls">
            <button class="unlock-btn" id="unlockBtn">å¼€é”</button>
            <button class="give-up-btn" id="giveUpBtn">æ”¾å¼ƒ</button>
          </div>
        </div>
      `;

      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .lockpick-game-modal {
          display: flex;
          justify-content: center;
          align-items: center;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          animation: fadeIn 0.3s ease;
        }

        .lockpick-game-content {
          background: linear-gradient(45deg, #F8F4E8 0%, #F5EFDD 25%, #F2E9D2 50%, #F0E5CC 75%, #EDE0C5 100%);
          border: 1px solid #D6C8A5;
          border-radius: 4px;
          padding: 2rem;
          box-shadow: 0 8px 32px rgba(139, 69, 19, 0.15), 
                      0 2px 8px rgba(139, 69, 19, 0.1),
                      inset 0 1px 0 rgba(255, 255, 255, 0.3);
          text-align: center;
          max-width: 500px;
          width: 90%;
          position: relative;
          overflow: hidden;
        }

        .lockpick-game-content::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: 
            radial-gradient(circle at 20% 20%, rgba(210, 180, 140, 0.1) 2px, transparent 2px),
            radial-gradient(circle at 80% 80%, rgba(210, 180, 140, 0.08) 1px, transparent 1px),
            radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.05) 3px, transparent 3px);
          background-size: 50px 50px, 30px 30px, 70px 70px;
          pointer-events: none;
        }

        .lockpick-game-content::after {
          content: '';
          position: absolute;
          top: 10px;
          left: 10px;
          right: 10px;
          bottom: 10px;
          border: 1px solid rgba(139, 69, 19, 0.1);
          border-radius: 2px;
          pointer-events: none;
        }

        .lockpick-game-content h2 {
          margin-top: 0;
          margin-bottom: 1rem;
          color: #8B4513;
          font-family: "HuiWenMingChaoTi", "FangSong", "ä»¿å®‹", serif;
          font-weight: normal;
          text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
        }

        .timer-container {
          margin-bottom: 1rem;
        }

        .timer-bar {
          width: 100%;
          height: 20px;
          background-color: #E2E8F0;
          border-radius: 10px;
          overflow: hidden;
          margin-bottom: 0.5rem;
        }

        .timer-bar-fill {
          height: 100%;
          background-color: #48BB78;
          width: 100%;
          transition: width 0.1s linear;
        }

        .timer-text {
          font-size: 0.875rem;
          color: #4A5568;
        }

        .lock-container {
          display: flex;
          justify-content: center;
          margin: 1.5rem 0;
        }

        #lockCanvas {
          border: 1px solid #E2E8F0;
          border-radius: 50%;
          cursor: crosshair;
        }

        .lock-controls {
          display: flex;
          justify-content: center;
          gap: 1rem;
        }

        .unlock-btn {
          background-color: #48BB78;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          border: none;
          font-size: 1rem;
        }

        .unlock-btn:hover {
          background-color: #38A169;
        }

        .give-up-btn {
          background-color: #E53E3E;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          border: none;
          font-size: 1rem;
        }

        .give-up-btn:hover {
          background-color: #C53030;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes success-pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.1); }
          100% { transform: scale(1); }
        }
      `;

      document.body.appendChild(lockpickModal);
      document.head.appendChild(style);

      // åˆå§‹åŒ–æ’¬é”æ¸¸æˆ
      initLockpickGame();

      // å¼€é”æŒ‰é’®äº‹ä»¶
      const unlockBtn = document.getElementById('unlockBtn');
      unlockBtn.addEventListener('click', function() {
        tryUnlock();
      });

      // æ”¾å¼ƒæŒ‰é’®äº‹ä»¶
      const giveUpBtn = document.getElementById('giveUpBtn');
      giveUpBtn.addEventListener('click', function() {
        endLockpickGame(false);
      });

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨ä¸å…³é—­ï¼ˆå¿…é¡»é€‰æ‹©æˆåŠŸæˆ–å¤±è´¥ï¼‰
    }

    // æ’¬é”æ¸¸æˆåˆå§‹åŒ–å‡½æ•°
    function initLockpickGame() {
      const canvas = document.getElementById('lockCanvas');
      const ctx = canvas.getContext('2d');
      
      // æ¸¸æˆçŠ¶æ€
      window.lockpickGameState = {
        // åœ†å¿ƒå’ŒåŠå¾„
        centerX: canvas.width / 2,
        centerY: canvas.height / 2,
        outerRadius: 100,
        innerRadius: 50,
        
        // é”èŠ¯çŠ¶æ€
        lockRotation: 0,
        maxLockRotation: 45,
        
        // æœ¨æ£çŠ¶æ€
        pickAngle: 0,
        
        // æ­£ç¡®åŒºåŸŸ (éšæœº30åº¦èŒƒå›´)
        correctZoneStart: Math.random() * 360,
        correctZoneEnd: 0,
        
        // æ—¶é—´é™åˆ¶ (10ç§’)
        timeLimit: 10000,
        startTime: Date.now(),
        timerInterval: null,
        
        // æ¸¸æˆçŠ¶æ€
        gameActive: true,
        
        // é¼ æ ‡/è§¦æ‘¸çŠ¶æ€
        isDragging: false,
        
        // ç”»å¸ƒå…ƒç´ å’Œä¸Šä¸‹æ–‡
        canvas: canvas,
        ctx: ctx
      };
      
      // è®¡ç®—æ­£ç¡®åŒºåŸŸçš„ç»“æŸä½ç½®
      window.lockpickGameState.correctZoneEnd = 
        (window.lockpickGameState.correctZoneStart + 30) % 360;
      
      // è®¾ç½®å®šæ—¶å™¨
      window.lockpickGameState.timerInterval = setInterval(updateTimer, 100);
      
      // ç»˜åˆ¶åˆå§‹çŠ¶æ€
      drawLockpickGame();
      
      // æ·»åŠ é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨
      canvas.addEventListener('click', handleMouseClick);
      canvas.addEventListener('mousemove', handleMouseMove);
      
      // æ·»åŠ å…¨å±€é¼ æ ‡ç§»åŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼Œè¿™æ ·å³ä½¿é¼ æ ‡ç§»å‡ºç”»å¸ƒä¹Ÿèƒ½æ§åˆ¶
      document.addEventListener('mousemove', handleGlobalMouseMove);
      
      // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
      canvas.addEventListener('touchstart', handleTouchStart);
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', handleTouchEnd);
      
      // æ·»åŠ å…¨å±€è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
      document.addEventListener('touchmove', handleGlobalTouchMove);
      document.addEventListener('touchend', handleGlobalTouchEnd);
    }
    
    // æ›´æ–°è®¡æ—¶å™¨
    function updateTimer() {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive) return;
      
      const elapsed = Date.now() - window.lockpickGameState.startTime;
      const remaining = Math.max(0, window.lockpickGameState.timeLimit - elapsed);
      
      const percentage = (remaining / window.lockpickGameState.timeLimit) * 100;
      const timerBarFill = document.getElementById('timerBarFill');
      const timerText = document.getElementById('timerText');
      
      timerBarFill.style.width = `${percentage}%`;
      timerText.textContent = `å‰©ä½™æ—¶é—´: ${(remaining / 1000).toFixed(1)}ç§’`;
      
      // æ—¶é—´å¿«ç”¨å®Œæ—¶å˜çº¢è‰²
      if (percentage < 30) {
        timerBarFill.style.backgroundColor = '#E53E3E';
      }
      
      // æ—¶é—´ç”¨å®Œ
      if (remaining <= 0) {
        endLockpickGame(false);
      }
    }
    
    // ç»˜åˆ¶æ¸¸æˆç•Œé¢
    function drawLockpickGame() {
      if (!window.lockpickGameState) return;
      
      const { centerX, centerY, outerRadius, innerRadius, lockRotation, pickAngle } = window.lockpickGameState;
      const ctx = window.lockpickGameState.ctx;
      const canvas = window.lockpickGameState.canvas;
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // ç»˜åˆ¶å¤–åœ† (å¤§åœ†)
      ctx.beginPath();
      ctx.arc(centerX, centerY, outerRadius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#CBD5E0';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // ç»˜åˆ¶å†…åœ† (å°åœ†)
      ctx.beginPath();
      ctx.arc(centerX, centerY, innerRadius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#A0AEC0';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // ç»˜åˆ¶é”èŠ¯ (ä¸­å¿ƒ)
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate((lockRotation * Math.PI) / 180);
      
      // é”èŠ¯ä¸»ä½“
      ctx.fillStyle = '#718096';
      ctx.fillRect(-15, -15, 30, 30);
      
      // é”èŠ¯è£…é¥°
      ctx.fillStyle = '#4A5568';
      ctx.fillRect(-10, -10, 20, 20);
      
      ctx.restore();
      
      // ç»˜åˆ¶æœ¨æ£ (ä»ä¸­å¿ƒå»¶ä¼¸)
      const pickLength = outerRadius - 10;
      const pickEndX = centerX + Math.cos((pickAngle * Math.PI) / 180) * pickLength;
      const pickEndY = centerY + Math.sin((pickAngle * Math.PI) / 180) * pickLength;
      
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(pickEndX, pickEndY);
      ctx.strokeStyle = '#8B4513';
      ctx.lineWidth = 4;
      ctx.stroke();
      
      // æœ¨æ£æœ«ç«¯
      ctx.beginPath();
      ctx.arc(pickEndX, pickEndY, 6, 0, 2 * Math.PI);
      ctx.fillStyle = '#8B4513';
      ctx.fill();
      
      // ç»˜åˆ¶é”èŠ¯æ—‹è½¬æŒ‡ç¤ºå™¨
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate((lockRotation * Math.PI) / 180);
      
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(20, 0);
      ctx.strokeStyle = '#E53E3E';
      ctx.lineWidth = 3;
      ctx.stroke();
      
      ctx.restore();
    }
    
    // å¤„ç†é¼ æ ‡ç‚¹å‡» - æ‰§è¡Œå¼€é”æ“ä½œ
    function handleMouseClick(e) {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive) return;
      e.preventDefault();
      tryUnlock();
    }
    
    // å¤„ç†é¼ æ ‡ç§»åŠ¨ - ç›´æ¥æ§åˆ¶æœ¨æ£æ—‹è½¬
    function handleMouseMove(e) {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive) return;
      
      // é¼ æ ‡ç§»åŠ¨ç›´æ¥æ›´æ–°æœ¨æ£è§’åº¦
      updatePickAngle(e);
    }
    
    // å¤„ç†è§¦æ‘¸å¼€å§‹
    function handleTouchStart(e) {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive) return;
      e.preventDefault();
      window.lockpickGameState.isDragging = true;
      updatePickAngleTouch(e);
    }
    
    // å¤„ç†è§¦æ‘¸ç§»åŠ¨ - æ— è®ºæ˜¯å¦å¼€å§‹éƒ½æ›´æ–°è§’åº¦
    function handleTouchMove(e) {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive) return;
      e.preventDefault();
      
      // è§¦æ‘¸æ—¶æ€»æ˜¯æ›´æ–°è§’åº¦
      updatePickAngleTouch(e);
      window.lockpickGameState.isDragging = true;
    }
    
    // å¤„ç†è§¦æ‘¸ç»“æŸ
    function handleTouchEnd(e) {
      if (!window.lockpickGameState) return;
      e.preventDefault();
      window.lockpickGameState.isDragging = false;
    }
    
    // å¤„ç†å…¨å±€é¼ æ ‡ç§»åŠ¨
    function handleGlobalMouseMove(e) {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive) return;
      
      // é¼ æ ‡ç§»åŠ¨ç›´æ¥æ›´æ–°æœ¨æ£è§’åº¦
      updatePickAngle(e);
    }
    
    // å¤„ç†å…¨å±€è§¦æ‘¸ç§»åŠ¨
    function handleGlobalTouchMove(e) {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive || !window.lockpickGameState.isDragging) return;
      e.preventDefault();
      
      // è§¦æ‘¸æ—¶æ€»æ˜¯æ›´æ–°è§’åº¦
      updatePickAngleTouch(e);
    }
    
    // å¤„ç†å…¨å±€è§¦æ‘¸ç»“æŸ
    function handleGlobalTouchEnd(e) {
      if (!window.lockpickGameState) return;
      e.preventDefault();
      window.lockpickGameState.isDragging = false;
    }
    
    // æ ¹æ®é¼ æ ‡ä½ç½®æ›´æ–°æœ¨æ£è§’åº¦
    function updatePickAngle(e) {
      if (!window.lockpickGameState) return;
      
      const canvas = window.lockpickGameState.canvas;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // è®¡ç®—ä»ä¸­å¿ƒåˆ°é¼ æ ‡ç‚¹çš„è§’åº¦
      const dx = x - window.lockpickGameState.centerX;
      const dy = y - window.lockpickGameState.centerY;
      let angle = Math.atan2(dy, dx) * (180 / Math.PI);
      
      // ç¡®ä¿è§’åº¦åœ¨0-360èŒƒå›´å†…
      if (angle < 0) angle += 360;
      
      window.lockpickGameState.pickAngle = angle;
      drawLockpickGame();
    }
    
    // æ ¹æ®è§¦æ‘¸ä½ç½®æ›´æ–°æœ¨æ£è§’åº¦
    function updatePickAngleTouch(e) {
      if (!window.lockpickGameState || e.touches.length === 0) return;
      
      const touch = e.touches[0];
      const canvas = window.lockpickGameState.canvas;
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      
      // è®¡ç®—ä»ä¸­å¿ƒåˆ°è§¦æ‘¸ç‚¹çš„è§’åº¦
      const dx = x - window.lockpickGameState.centerX;
      const dy = y - window.lockpickGameState.centerY;
      let angle = Math.atan2(dy, dx) * (180 / Math.PI);
      
      // ç¡®ä¿è§’åº¦åœ¨0-360èŒƒå›´å†…
      if (angle < 0) angle += 360;
      
      window.lockpickGameState.pickAngle = angle;
      drawLockpickGame();
    }
    
    // å°è¯•å¼€é”
    function tryUnlock() {
      if (!window.lockpickGameState || !window.lockpickGameState.gameActive) return;
      
      const { pickAngle, correctZoneStart, correctZoneEnd, maxLockRotation } = window.lockpickGameState;
      
      // æ£€æŸ¥æœ¨æ£æ˜¯å¦åœ¨æ­£ç¡®åŒºåŸŸå†…
      let isInRange = false;
      
      if (correctZoneStart < correctZoneEnd) {
        // ä¸è·¨è¶Š360åº¦çš„æƒ…å†µ
        isInRange = pickAngle >= correctZoneStart && pickAngle <= correctZoneEnd;
      } else {
        // è·¨è¶Š360åº¦çš„æƒ…å†µ
        isInRange = pickAngle >= correctZoneStart || pickAngle <= correctZoneEnd;
      }
      
      if (isInRange) {
        // å®Œå…¨æ­£ç¡®ï¼Œé”èŠ¯æ—‹è½¬45åº¦
        window.lockpickGameState.lockRotation = maxLockRotation;
        
        // åŠ¨ç”»æ˜¾ç¤ºå¼€é”æˆåŠŸ
        showLockpickSuccess();
        
        // æ¸¸æˆæˆåŠŸ
        setTimeout(() => {
          endLockpickGame(true);
        }, 1000);
      } else {
        // è®¡ç®—ç¦»æ­£ç¡®åŒºåŸŸçš„è·ç¦»
        let distance = calculateAngleDistance(pickAngle, correctZoneStart, correctZoneEnd);
        
        // æ ¹æ®è·ç¦»å†³å®šé”èŠ¯æ—‹è½¬è§’åº¦
        // è·ç¦»è¶Šè¿‘ï¼Œæ—‹è½¬è§’åº¦è¶Šå¤§ï¼Œä½†ä¸è¶…è¿‡45åº¦
        const rotationRatio = 1 - Math.min(distance / 180, 1);
        const rotationAmount = rotationRatio * maxLockRotation;
        
        // æ›´æ–°é”èŠ¯æ—‹è½¬
        window.lockpickGameState.lockRotation = rotationAmount;
        drawLockpickGame();
        
        // çŸ­æš‚å›å¼¹
        setTimeout(() => {
          if (window.lockpickGameState) {
            window.lockpickGameState.lockRotation = 0;
            drawLockpickGame();
          }
        }, 300);
      }
    }
    
    // è®¡ç®—è§’åº¦åˆ°æ­£ç¡®åŒºåŸŸçš„è·ç¦»
    function calculateAngleDistance(angle, zoneStart, zoneEnd) {
      // è®¡ç®—è§’åº¦åˆ°åŒºé—´èµ·ç‚¹çš„è·ç¦»
      let distance1 = Math.min(Math.abs(angle - zoneStart), 360 - Math.abs(angle - zoneStart));
      
      // è®¡ç®—è§’åº¦åˆ°åŒºé—´ç»ˆç‚¹çš„è·ç¦»
      let distance2 = Math.min(Math.abs(angle - zoneEnd), 360 - Math.abs(angle - zoneEnd));
      
      // è¿”å›æœ€å°è·ç¦»
      return Math.min(distance1, distance2);
    }
    
    // æ˜¾ç¤ºå¼€é”æˆåŠŸåŠ¨ç”»
    function showLockpickSuccess() {
      const canvas = window.lockpickGameState.canvas;
      canvas.style.animation = 'success-pulse 0.5s ease';
      
      setTimeout(() => {
        canvas.style.animation = '';
      }, 500);
    }
    
    // æ˜¾ç¤ºå¼€é”æˆåŠŸè‡ªå®šä¹‰æç¤º
    function showLockpickSuccessModal(rewardName) {
      // è®¡ç®—è·å¾—çš„æŠ€èƒ½ç»éªŒå€¼
      const experienceGain = 2;
      
      const modal = document.createElement('div');
      modal.className = 'lockpick-result-modal';
      modal.innerHTML = `
        <div class="lockpick-result-content success">
          <h2>å¤ªå‰å®³äº†ï¼Œå¼€é”æˆåŠŸï¼</h2>
          <div class="rewards-container">
            <div class="reward-icon">
              <img src="${gameData.resources[rewardName]?.image || ''}" alt="${rewardName}" onerror="this.style.display='none'">
            </div>
            <div class="rewards-text">
              <p class="reward-text">ä½ è·å¾—äº† 1 ä¸ª ${gameData.resources[rewardName]?.name || rewardName}ï¼</p>
              <p class="experience-text">å·çªƒæŠ€èƒ½ç»éªŒ +${experienceGain}</p>
            </div>
          </div>
          <button class="confirm-btn">ç¡®å®š</button>
        </div>
      `;
      
      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .lockpick-result-modal {
          display: flex;
          justify-content: center;
          align-items: center;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 2000;
          animation: fadeIn 0.3s ease;
        }
        
        .lockpick-result-content {
          background: linear-gradient(45deg, #F8F4E8 0%, #F5EFDD 25%, #F2E9D2 50%, #F0E5CC 75%, #EDE0C5 100%);
          border: 1px solid #D6C8A5;
          border-radius: 4px;
          padding: 2rem;
          box-shadow: 0 8px 32px rgba(139, 69, 19, 0.15), 
                      0 2px 8px rgba(139, 69, 19, 0.1),
                      inset 0 1px 0 rgba(255, 255, 255, 0.3);
          text-align: center;
          max-width: 400px;
          width: 90%;
          position: relative;
          overflow: hidden;
        }

        .lockpick-result-content::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: 
            radial-gradient(circle at 20% 20%, rgba(210, 180, 140, 0.1) 2px, transparent 2px),
            radial-gradient(circle at 80% 80%, rgba(210, 180, 140, 0.08) 1px, transparent 1px),
            radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.05) 3px, transparent 3px);
          background-size: 50px 50px, 30px 30px, 70px 70px;
          pointer-events: none;
        }

        .lockpick-result-content::after {
          content: '';
          position: absolute;
          top: 10px;
          left: 10px;
          right: 10px;
          bottom: 10px;
          border: 1px solid rgba(139, 69, 19, 0.1);
          border-radius: 2px;
          pointer-events: none;
        }
        
        .lockpick-result-content.success {
          border-left: 5px solid #48BB78;
        }
        
        .lockpick-result-content.failure {
          border-left: 5px solid #E53E3E;
        }
        
        .lockpick-result-content h2 {
          margin-top: 0;
          margin-bottom: 1.5rem;
        }
        
        .lockpick-result-content.success h2 {
          color: #38A169;
        }
        
        .lockpick-result-content.failure h2 {
          color: #E53E3E;
        }
        
        .rewards-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-bottom: 1.5rem;
        }
        
        .reward-icon {
          margin-bottom: 1rem;
        }
        
        .reward-icon img {
          width: 80px;
          height: 80px;
          object-fit: contain;
        }
        
        .rewards-text {
          text-align: center;
        }
        
        .reward-text {
          font-size: 1.1rem;
          color: #4A5568;
          margin-bottom: 0.5rem;
        }
        
        .experience-text {
          font-size: 1rem;
          color: #38A169;
          font-weight: normal;
        }
        
        .confirm-btn {
          background-color: #4299E1;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: normal;
          transition: background-color 0.2s;
          border: none;
          font-size: 1rem;
        }
        
        .confirm-btn:hover {
          background-color: #3182CE;
        }
      `;
      
      document.body.appendChild(modal);
      document.head.appendChild(style);
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      const confirmBtn = modal.querySelector('.confirm-btn');
      confirmBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    }
    
    // æ˜¾ç¤ºå¼€é”å¤±è´¥è‡ªå®šä¹‰æç¤º
    function showLockpickFailureModal() {
      const modal = document.createElement('div');
      modal.className = 'lockpick-result-modal';
      modal.innerHTML = `
        <div class="lockpick-result-content failure">
          <h2>å¾ˆé—æ†¾ï¼Œå¼€é”å¤±è´¥</h2>
          <div class="rewards-container">
            <div class="reward-icon">
              <span style="font-size: 3rem; color: #E53E3E;">ğŸš¨</span>
            </div>
            <div class="rewards-text">
              <p class="reward-text">ä½ è¢«å·¡é€»å£«å…µå‘ç°å¹¶æŠ“è¿›å¤§ç‰¢</p>
            </div>
          </div>
          <button class="confirm-btn">ç¡®å®š</button>
        </div>
      `;
      
      // æ·»åŠ æ ·å¼ï¼ˆå¦‚æœæ ·å¼å·²å­˜åœ¨ï¼Œåˆ™è·³è¿‡ï¼‰
      if (!document.querySelector('style[data-lockpick-failure]')) {
        const style = document.createElement('style');
        style.setAttribute('data-lockpick-failure', 'true');
        style.textContent = `
          .lockpick-result-modal {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
          }
          
          .lockpick-result-content {
            background: 
              linear-gradient(45deg, #F8F4E8 0%, #F5EFDD 25%, #F2E9D2 50%, #F0E5CC 75%, #EDE0C5 100%),
              url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><defs><filter id="shadow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur"/><feOffset in="blur" dx="2" dy="2" result="offsetBlur"/><feFlood flood-color="%238B4513" flood-opacity="0.1" result="offsetColor"/><feComposite in="offsetColor" in2="offsetBlur" operator="in" result="offsetBlur"/><feMerge><feMergeNode in="offsetBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path d="M50,250 Q100,200 150,220 Q200,240 250,230 Q300,220 350,250" stroke="%23A0522D" stroke-width="2" fill="none" opacity="0.3" filter="url(%23shadow)"/><path d="M30,200 Q80,180 120,190 Q160,200 200,185 Q240,170 280,180 Q320,190 370,200" stroke="%23966F33" stroke-width="1.5" fill="none" opacity="0.2"/><path d="M100,100 Q150,80 200,90 Q250,100 300,85" stroke="%23CD853F" stroke-width="1" fill="none" opacity="0.15"/><path d="M50,150 C100,120 150,130 200,140 C250,150 300,145 350,150" stroke="%23DEB887" stroke-width="0.8" fill="none" opacity="0.1"/></svg>');
            background-size: cover, 100% 100%;
            background-blend-mode: multiply;
            border: 1px solid #D6C8A5;
            border-radius: 4px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(139, 69, 19, 0.15), 
                        0 2px 8px rgba(139, 69, 19, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
            overflow: hidden;
          }

          .lockpick-result-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
              radial-gradient(circle at 20% 20%, rgba(210, 180, 140, 0.1) 2px, transparent 2px),
              radial-gradient(circle at 80% 80%, rgba(210, 180, 140, 0.08) 1px, transparent 1px),
              radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.05) 3px, transparent 3px);
            background-size: 50px 50px, 30px 30px, 70px 70px;
            pointer-events: none;
          }

          .lockpick-result-content::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px solid rgba(139, 69, 19, 0.1);
            border-radius: 2px;
            pointer-events: none;
          }
          
          .lockpick-result-content.failure {
            border-left: 5px solid #E53E3E;
          }
          
          .lockpick-result-content h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #E53E3E;
          }
          
          .rewards-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
          }
          
          .reward-icon {
            margin-bottom: 1rem;
          }
          
          .reward-icon span {
            font-size: 3rem;
          }
          
          .reward-text {
            font-size: 1.1rem;
            color: #4A5568;
            margin-bottom: 0.5rem;
          }
          
          .confirm-btn {
            background-color: #4299E1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: normal;
            transition: background-color 0.2s;
            border: none;
            font-size: 1rem;
          }
          
          .confirm-btn:hover {
            background-color: #3182CE;
          }
          
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(modal);
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      const confirmBtn = modal.querySelector('.confirm-btn');
      confirmBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
        // å¼¹çª—å…³é—­åæ˜¾ç¤ºåœ°å›¾åˆ‡æ¢
        showLocationImageModal('ç‰¢æˆ¿', 'UI/ç‰¢æˆ¿.jpg', () => {
          // åœ°å›¾åˆ‡æ¢å®Œæˆåå¯ä»¥æ‰§è¡Œå…¶ä»–é€»è¾‘
          console.log('å·²åˆ‡æ¢åˆ°ç‰¢æˆ¿åœºæ™¯');
        });
      });
    }
    
    // ç»“æŸæ’¬é”æ¸¸æˆ
    function endLockpickGame(success) {
      if (!window.lockpickGameState) return;
      
      // æ¸…ç†è®¡æ—¶å™¨
      if (window.lockpickGameState.timerInterval) {
        clearInterval(window.lockpickGameState.timerInterval);
      }
      
      // æ ‡è®°æ¸¸æˆç»“æŸ
      window.lockpickGameState.gameActive = false;
      
      // è·å–ç”»å¸ƒå’Œæ¸…ç†äº‹ä»¶ç›‘å¬å™¨
      const canvas = window.lockpickGameState.canvas;
      if (canvas) {
        canvas.removeEventListener('click', handleMouseClick);
        canvas.removeEventListener('mousemove', handleMouseMove);
        canvas.removeEventListener('touchstart', handleTouchStart);
        canvas.removeEventListener('touchmove', handleTouchMove);
        canvas.removeEventListener('touchend', handleTouchEnd);
      }
      
      // æ¸…ç†å…¨å±€äº‹ä»¶ç›‘å¬å™¨
      document.removeEventListener('mousemove', handleGlobalMouseMove);
      document.removeEventListener('touchmove', handleGlobalTouchMove);
      document.removeEventListener('touchend', handleGlobalTouchEnd);
      
      // è·å–æ¨¡æ€æ¡†
      const modal = document.querySelector('.lockpick-game-modal');
      if (!modal) return;
      
      // æ˜¾ç¤ºç»“æœ
      if (success) {
        // å¼€é”æˆåŠŸï¼Œéšæœºé€‰æ‹©å¥–åŠ±ç‰©å“
        const rewards = [
          { resource: 'gold_bar', name: 'é‡‘æ¡' },
          { resource: 'gold', name: 'é‡‘å­' },
          { resource: 'silver_piece', name: 'ç¢é“¶å­' }
        ];
        
        // éšæœºé€‰æ‹©ä¸€ä¸ªå¥–åŠ±
        const reward = rewards[Math.floor(Math.random() * rewards.length)];
        
        // ç¡®ä¿èµ„æºå¯¹è±¡å­˜åœ¨
        if (!gameData.resources[reward.resource]) {
          gameData.resources[reward.resource] = { 
            name: reward.name, 
            amount: 0, 
            image: `UI/${reward.name}.jpg`,
            category: 'material'
          };
        }
        
        // æ·»åŠ å¥–åŠ±åˆ°ç©å®¶èµ„æº
        if (typeof gameData.resources[reward.resource].amount === 'number') {
          gameData.resources[reward.resource].amount += 1;
        } else {
          gameData.resources[reward.resource].amount = 1;
        }
        
        // å¢åŠ å·çªƒæŠ€èƒ½ç»éªŒ
        if (gameData.skills.steal) {
          const experienceGain = 2;
          gameData.skills.steal.experience = (gameData.skills.steal.experience || 0) + experienceGain;
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§
          checkSkillLevelUp('steal');
          
          // æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
          updateSkillDisplay();
        }
        
        // æ›´æ–°æ¸¸æˆæ•°æ®
        updateGameData();
        
        // æ›´æ–°èƒŒåŒ…æ æ˜¾ç¤º
        if (typeof renderResources === 'function') {
          renderResources();
        }
        
        // æ˜¾ç¤ºæˆåŠŸè‡ªå®šä¹‰æç¤º
        showLockpickSuccessModal(reward.resource);
      } else {
        // å¼€é”å¤±è´¥
        // å°†ç©å®¶é€å¾€ç‰¢æˆ¿
        sendToPrison();
        
        // æ˜¾ç¤ºå¤±è´¥è‡ªå®šä¹‰æç¤º
        showLockpickFailureModal();
      }
      
      // ç§»é™¤æ¨¡æ€æ¡†
      setTimeout(() => {
        if (document.body.contains(modal)) {
          document.body.removeChild(modal);
        }
      }, 500);
      
      // æ¸…ç†æ¸¸æˆçŠ¶æ€
      window.lockpickGameState = null;
    }

    // ç¿»æ‰¾æ¸¸æˆç›¸å…³ä»£ç 
    function showGarbageGame() {
      const garbageModal = document.createElement('div');
      garbageModal.className = 'garbage-game-modal';
      garbageModal.innerHTML = `
        <div class="garbage-game-content">
          <div class="garbage-grid-container">
            <div class="garbage-grid" id="garbageGrid"></div>
          </div>
          <button class="garbage-game-end-btn" id="garbageGameEndBtn">ç»“æŸç¿»åƒåœ¾</button>
        </div>
      `;

      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .garbage-game-modal {
          display: flex;
          justify-content: center;
          align-items: center;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          animation: fadeIn 0.3s ease;
        }

        .garbage-game-content {
          background-color: #FFFDF7;
          border: 2px solid #8D6E63;
          border-radius: 0.25rem;
          padding: 1.5rem;
          box-shadow: 0 0 15px rgba(141, 110, 99, 0.2);
          text-align: center;
          max-width: 400px;
          width: 90%;
          position: relative;
        }

        .garbage-game-content::before {
          content: '';
          position: absolute;
          top: -3px;
          left: -3px;
          right: -3px;
          bottom: -3px;
          border: 1px solid #8D6E63;
          border-radius: 0.375rem;
          z-index: -1;
          opacity: 0.5;
        }
        
        .garbage-game-content::after {
          content: 'â—†';
          position: absolute;
          top: -12px;
          left: 50%;
          transform: translateX(-50%);
          color: #8D6E63;
          font-size: 16px;
          background-color: #FFFDF7;
          padding: 0 8px;
          z-index: 1;
        }

.garbage-grid-container {
          display: flex;
          justify-content: center;
          margin-bottom: 2rem;
        }

        .garbage-grid {
          display: grid;
          grid-template-columns: repeat(5, 1fr);
          grid-template-rows: repeat(5, 1fr);
          gap: 0;
          width: 300px;
          height: 300px;
        }

        .garbage-grid-item {
          background-color: #E2E8F0;
          background-image: url('UI/å¡ç‰Œå°é¢.jpg');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          border: 1px solid #CBD5E0;
          border-radius: 0.375rem;
          cursor: pointer;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 1.5rem;
          font-weight: normal;
          transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
          position: relative;
          overflow: hidden;
          transform-style: preserve-3d;
          perspective: 1000px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .garbage-grid-item::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(145deg, rgba(255,255,255,0.3), rgba(0,0,0,0.1));
          border-radius: 0.375rem;
          opacity: 0.5;
          transition: all 0.3s ease;
        }

        /* ç‚¹å‡»æ¶Ÿæ¼ªæ•ˆæœ */
        .garbage-grid-item::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 0;
          height: 0;
          background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
          border-radius: 50%;
          transform: translate(-50%, -50%);
          opacity: 0;
          transition: all 0.5s ease;
          pointer-events: none;
        }

        .garbage-grid-item.clicked::after {
          width: 200%;
          height: 200%;
          opacity: 1;
          transition: all 0.5s ease;
        }

        .garbage-grid-item:hover {
          background-color: #CBD5E0;
          transform: translateY(-3px) scale(1.02);
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .garbage-grid-item:hover::before {
          opacity: 0.7;
        }

        .garbage-grid-item:active {
          transform: translateY(-1px) scale(0.98);
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          transition: all 0.1s ease;
        }

        .garbage-grid-item.flipped {
          background-color: #FFFFFF;
          background-image: none;
          cursor: default;
          transform: scale(0.95);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .garbage-grid-item.flipped::before {
          opacity: 0;
        }

        /* ç¿»è½¬åŠ¨ç”»å…³é”®å¸§ */
        @keyframes flip3d {
          0% {
            transform: rotateY(0deg) scale(1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }
          50% {
            transform: rotateY(90deg) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
          }
          100% {
            transform: rotateY(0deg) scale(0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          }
        }

        @keyframes flipGlow {
          0% {
            box-shadow: 0 0 0 rgba(72, 187, 120, 0);
          }
          50% {
            box-shadow: 0 0 20px rgba(72, 187, 120, 0.8);
          }
          100% {
            box-shadow: 0 0 0 rgba(72, 187, 120, 0);
          }
        }

        /* å½“å‰é€‰ä¸­æ ¼å­çš„ç»¿è‰²è¾¹æ¡†å’Œé˜´å½±æ•ˆæœ */
        .garbage-grid-item.current {
          border: 3px solid #48BB78;
          box-shadow: 0 0 15px rgba(72, 187, 120, 0.8), 0 0 0 3px rgba(72, 187, 120, 0.3);
          transform: scale(1.08) translateY(-5px);
          animation: currentPulse 2s infinite ease-in-out, currentGlow 1.5s infinite alternate;
          z-index: 5;
          position: relative;
        }

        /* å½“å‰é€‰ä¸­æ ¼å­çš„è„‰æåŠ¨ç”» */
        @keyframes currentPulse {
          0%, 100% {
            transform: scale(1.08) translateY(-5px);
            box-shadow: 0 0 15px rgba(72, 187, 120, 0.8), 0 0 0 3px rgba(72, 187, 120, 0.3);
          }
          50% {
            transform: scale(1.12) translateY(-7px);
            box-shadow: 0 0 25px rgba(72, 187, 120, 0.9), 0 0 0 5px rgba(72, 187, 120, 0.5);
          }
        }

        /* å½“å‰é€‰ä¸­æ ¼å­çš„å‘å…‰æ•ˆæœ */
        @keyframes currentGlow {
          0% {
            filter: brightness(1);
          }
          100% {
            filter: brightness(1.2);
          }
        }

        /* æ ¼å­ç§»åŠ¨åŠ¨ç”» */
        @keyframes gridMove {
          0% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(-2px);
          }
          100% {
            transform: translateY(0);
          }
        }

        /* ç¿»è½¬ç²’å­æ•ˆæœ */
        .flip-particle {
          position: absolute;
          width: 4px;
          height: 4px;
          background: radial-gradient(circle, #48BB78 0%, transparent 70%);
          border-radius: 50%;
          pointer-events: none;
          animation: particleFloat 1s ease-out forwards;
          z-index: 10;
        }

        @keyframes particleFloat {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(var(--tx, 0), var(--ty, -50px)) scale(0);
            opacity: 0;
          }
        }

        /* ç‰©å“ç±»å‹ç‰¹æ•ˆ */
        .positive-effect {
          animation: positiveGlow 0.8s ease-out;
        }

        .negative-effect {
          animation: negativeShake 0.5s ease-out;
        }

        .neutral-effect {
          animation: neutralPulse 0.6s ease-out;
        }

        @keyframes positiveGlow {
          0% {
            box-shadow: 0 0 0 rgba(72, 187, 120, 0);
          }
          50% {
            box-shadow: 0 0 30px rgba(72, 187, 120, 0.8);
          }
          100% {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          }
        }

        @keyframes negativeShake {
          0%, 100% {
            transform: translateX(0) rotateY(180deg) scale(0.95);
          }
          25% {
            transform: translateX(-5px) rotateY(180deg) scale(0.95);
          }
          75% {
            transform: translateX(5px) rotateY(180deg) scale(0.95);
          }
        }

        @keyframes neutralPulse {
          0%, 100% {
            transform: rotateY(180deg) scale(0.95);
          }
          50% {
            transform: rotateY(180deg) scale(1.05);
          }
        }

/* çº¢è‰²è¾¹æ¡†é˜´å½±è­¦ç¤ºæ ·å¼ */
        .garbage-grid-item.danger-tip {
          box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3) !important;
          border: 3px solid red !important;
          animation: danger-pulse 1.5s infinite !important;
          z-index: 10 !important;
        }

/* å±é™©è­¦ç¤ºåŠ¨ç”»æ•ˆæœ */
        @keyframes danger-pulse {
          0% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3) !important; }
          50% { box-shadow: 0 0 15px 5px red, inset 0 0 15px 5px rgba(255, 0, 0, 0.5) !important; }
          100% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3) !important; }
        }

        .garbage-grid-item.flipped .item-content {
          opacity: 1;
          transition: opacity 0.2s ease;
        }

        .garbage-game-end-btn {
          background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
          border: 2px solid #5D4037 !important;
          border-radius: 16px !important;
          padding: 0.75rem 1.5rem;
          font-size: 1rem;
          font-weight: normal !important;
          cursor: pointer;
          transition: all 0.3s ease;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
          color: white !important;
          text-shadow: none !important;
          letter-spacing: 1px !important;
          overflow: hidden !important;
          box-shadow: 
            0 0 25px rgba(141, 110, 99, 0.5),
            0 4px 12px rgba(139, 69, 19, 0.3),
            inset 0 1px 3px rgba(255, 255, 255, 0.4),
            inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
          margin-top: 2rem;
          margin-bottom: 1.5rem;
        }

        .garbage-game-end-btn:hover {
          background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
          transform: translateY(-2px) !important;
          box-shadow: 
            0 0 35px rgba(141, 110, 99, 0.7),
            0 6px 16px rgba(139, 69, 19, 0.4),
            inset 0 1px 4px rgba(255, 255, 255, 0.5),
            inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
          border-radius: 18px !important;
        }

        .garbage-game-end-btn:active {
          transform: translateY(0) !important;
          box-shadow: 
            0 0 15px rgba(141, 110, 99, 0.3);
        }

        .notification-button {
          background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%) !important;
          border: 2px solid #5D4037 !important;
          border-radius: 16px !important;
          padding: 0.5rem 1.5rem !important;
          font-size: 0.875rem !important;
          font-weight: normal !important;
          cursor: pointer !important;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important;
          color: white !important;
          text-shadow: none !important;
          letter-spacing: 1px !important;
          overflow: hidden !important;
          box-shadow: 
            0 0 25px rgba(141, 110, 99, 0.5),
            0 4px 12px rgba(139, 69, 19, 0.3),
            inset 0 1px 3px rgba(255, 255, 255, 0.4),
            inset 0 -2px 4px rgba(0, 0, 0, 0.2) !important;
          transition: all 0.3s ease !important;
        }

        .notification-button:hover {
          background: linear-gradient(135deg, #7D6E63 0%, #5D4037 100%) !important;
          transform: translateY(-2px) !important;
          box-shadow: 
            0 0 35px rgba(141, 110, 99, 0.7),
            0 6px 16px rgba(139, 69, 19, 0.4),
            inset 0 1px 4px rgba(255, 255, 255, 0.5),
            inset 0 -3px 6px rgba(0, 0, 0, 0.3) !important;
          border-radius: 18px !important;
        }

        .notification-button:active {
          transform: translateY(0) !important;
          box-shadow: 
            0 0 15px rgba(141, 110, 99, 0.3),
            0 2px 6px rgba(139, 69, 19, 0.2),
            inset 0 1px 2px rgba(255, 255, 255, 0.2),
            inset 0 -1px 3px rgba(0, 0, 0, 0.2) !important;
        }
        }

/* ç‰©å“å¡ç‰‡æ ·å¼ */
        .item-card {
          background-color: white;
          border-radius: 0.25rem;
          padding: 0.25rem;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        }

        /* éç©ºå¡ç‰Œç‰¹æ®Šæ ·å¼ - å¢åŠ å®½åº¦ä»¥é€‚åº”æ ¼å­å¹¶ç§»é™¤è¾¹æ¡† */
        .garbage-grid-item.flipped .item-card:not(:has(.loot-item-neutral)) {
          padding: 0.125rem;
          width: 100%;
          height: 100%;
          border: none;
          box-shadow: none;
        }

        /* éç©ºå¡ç‰Œå›¾ç‰‡æ ·å¼ - è°ƒæ•´å¤§å°ä»¥é€‚åº”æ›´å¤§çš„å¡ç‰Œ */
        .garbage-grid-item.flipped .item-card:not(:has(.loot-item-neutral)) img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          margin-bottom: 0;
        }

        /* ç©ºå¡ç‰Œç‰¹æ®Šæ ·å¼ - ä¸æ˜¾ç¤ºè¾¹æ¡†ï¼Œä»…æ”¾å¤§å­—ä½“ */
        .item-card .item-name.loot-item-neutral {
          font-size: 1.5rem; /* æ”¾å¤§å­—ä½“å¤§å°ä»¥é€‚åº”æ ¼å­ */
        }

        /* ç©ºå¡ç‰Œçš„item-cardä¸æ˜¾ç¤ºè¾¹æ¡† */
        .garbage-grid-item.flipped .item-card:has(.loot-item-neutral) {
          border: none;
          box-shadow: none;
          padding: 0;
        }

.item-card .item-name {
          font-size: 0.75rem;
          font-weight: normal;
          text-align: center;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          margin-bottom: 0;
        }

        .item-card .item-effect {
          font-size: 0.75rem;
          color: #4A5568;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes flipIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        /* ä¸åŒç±»å‹ç‰©å“çš„æ ·å¼ */
        .loot-item-positive {
          color: #38A169;
        }

        .loot-item-negative {
          color: #E53E3E;
        }

        .loot-item-neutral {
          color: #718096;
        }
      `;

      document.body.appendChild(garbageModal);
      document.head.appendChild(style);

      // åˆå§‹åŒ–ç¿»æ‰¾æ¸¸æˆ
      initGarbageGame();

      // æ¸¸æˆç»“æŸæŒ‰é’®äº‹ä»¶
      const garbageGameEndBtn = document.getElementById('garbageGameEndBtn');
      garbageGameEndBtn.addEventListener('click', function() {
        endGarbageGame();
      });

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      garbageModal.addEventListener('click', function(e) {
        if (e.target === garbageModal) {
          endGarbageGame();
        }
      });

      // é”®ç›˜æ§åˆ¶åŠŸèƒ½
      // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
      let currentSelectedRow = 0;
      let currentSelectedCol = 0;

      // åˆå§‹åŒ–å½“å‰ä½ç½®ä¸ºä¸­å¿ƒ
      function initializePosition() {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');
        const gridSize = Math.sqrt(allItems.length);
        const centerRow = Math.floor(gridSize / 2);
        const centerCol = Math.floor(gridSize / 2);

        currentSelectedRow = centerRow;
        currentSelectedCol = centerCol;

        // ä¸ºåˆå§‹ä½ç½®æ·»åŠ ç»¿è‰²è¾¹æ¡†å’Œé˜´å½±
        const centerItem = Array.from(allItems).find(item => {
          return parseInt(item.dataset.row) === centerRow && parseInt(item.dataset.col) === centerCol;
        });

        if (centerItem) {
          // ç§»é™¤æ‰€æœ‰æ ¼å­çš„currentç±»
          allItems.forEach(item => item.classList.remove('current'));
          // ä¸ºä¸­å¿ƒæ ¼å­æ·»åŠ currentç±»
          centerItem.classList.add('current');
        }
      }

      // åˆå§‹åŒ–ä½ç½®
      initializePosition();

      // é”®ç›˜äº‹ä»¶å¤„ç†å‡½æ•°
      function handleKeyboard(event) {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');
        const gridSize = Math.sqrt(allItems.length);

        // è®¡ç®—æ–°ä½ç½®
        let newRow = currentSelectedRow;
        let newCol = currentSelectedCol;

        switch (event.key.toLowerCase()) {
          case 'w': // ä¸Š
            newRow = currentSelectedRow > 0 ? currentSelectedRow - 1 : currentSelectedRow;
            break;
          case 'a': // å·¦
            newCol = currentSelectedCol > 0 ? currentSelectedCol - 1 : currentSelectedCol;
            break;
          case 's': // ä¸‹
            newRow = currentSelectedRow < gridSize - 1 ? currentSelectedRow + 1 : currentSelectedRow;
            break;
          case 'd': // å³
            newCol = currentSelectedCol < gridSize - 1 ? currentSelectedCol + 1 : currentSelectedCol;
            break;
          default:
            return;
        }

        // å¦‚æœä½ç½®æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
        if (newRow === currentSelectedRow && newCol === currentSelectedCol) {
          return;
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§»åŠ¨åˆ°æ–°ä½ç½®ï¼ˆä¸å·²ç¿»å¼€çš„æ ¼å­ç›¸é‚»ï¼‰
        const canMove = checkCanFlip(newRow, newCol);

        if (!canMove) {
          console.log('é”®ç›˜æ§åˆ¶ï¼šæ— æ³•ç§»åŠ¨åˆ°è¯¥ä½ç½®ï¼Œå¿…é¡»ä¸å·²ç¿»å¼€çš„æ ¼å­ç›¸é‚»');
          return;
        }

        // æ‰¾åˆ°æ–°ä½ç½®çš„æ ¼å­
        const targetItem = Array.from(allItems).find(item => {
          return parseInt(item.dataset.row) === newRow && parseInt(item.dataset.col) === newCol;
        });

        if (!targetItem) return;

        // è·å–æ ¼å­ç‰©å“æ•°æ®
        const item = JSON.parse(targetItem.dataset.item);

        // æ£€æŸ¥æ˜¯å¦æ˜¯å±é™©ç‰©å“
        const isDanger = item.name === 'å—ä¼¤' || item.name === 'å‘•å';

        // æ£€æŸ¥æ˜¯å¦å·²æ˜¾ç¤ºè­¦ç¤º
        const hasWarning = targetItem.classList.contains('danger-tip');

        // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®è¯¥æ ¼å­
        const firstVisit = targetItem.dataset.firstVisit === 'false';

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ˜¾ç¤ºè­¦ç¤ºï¼ˆæ ¹æ®å·²æ˜¾ç¤ºçš„è­¦ç¤ºæ•°é‡å’Œæœ€å¤§è­¦ç¤ºæ•°é‡ï¼‰
        const canShowWarning = window.garbageGameWarningCount < window.garbageGameMaxWarningCount;

        console.log('é”®ç›˜å¤„ç†æ ¼å­:', newRow, newCol, 'ç‰©å“:', item.name, 'å±é™©:', isDanger, 'å·²è­¦ç¤º:', hasWarning, 'å¯æ˜¾ç¤ºè­¦ç¤º:', canShowWarning, 'é¦–æ¬¡è®¿é—®:', firstVisit);

        // å¦‚æœæ˜¯å±é™©ç‰©å“ä¸”å°šæœªæ˜¾ç¤ºè­¦ç¤ºä¸”æ˜¯é¦–æ¬¡è®¿é—®
        if (isDanger && !hasWarning && firstVisit) {
          // æ ‡è®°ä¸ºå·²è®¿é—®
          targetItem.dataset.firstVisit = 'true';

          // å¦‚æœå…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œåˆ™æ˜¾ç¤ºè­¦ç¤º
          if (canShowWarning) {
            // å¢åŠ è­¦ç¤ºè®¡æ•°
            window.garbageGameWarningCount++;
            console.log('å½“å‰è­¦ç¤ºè®¡æ•°:', window.garbageGameWarningCount, 'æœ€å¤§è­¦ç¤ºæ•°é‡:', window.garbageGameMaxWarningCount);

            // æ˜¾ç¤ºè­¦ç¤º
            targetItem.classList.add('danger-tip');

            console.log('é”®ç›˜é¢„è§ˆï¼šå³å°†ç§»åŠ¨åˆ°å±é™©æ ¼å­', newRow, newCol, 'ç‰©å“:', item.name, 'å·²æ˜¾ç¤ºè­¦ç¤º');
          } else {
            // ä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ‰§è¡Œç¿»ç‰Œ
            console.log('é”®ç›˜æ§åˆ¶ï¼šä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ‰§è¡Œç¿»ç‰Œ');
            // å®é™…ç§»åŠ¨åˆ°æ–°ä½ç½®
            currentSelectedRow = newRow;
            currentSelectedCol = newCol;

            // æ›´æ–°æ‰€æœ‰æ ¼å­çš„å½“å‰é€‰ä¸­æ ·å¼
            const allGridItems = document.querySelectorAll('.garbage-grid-item');
            allGridItems.forEach(item => item.classList.remove('current'));
            targetItem.classList.add('current');

            // æ£€æŸ¥æ˜¯å¦ç§»åŠ¨åˆ°å·²ç¿»å¼€çš„å—ä¼¤æˆ–å‘•åå¡ç‰Œ
            if (targetItem.classList.contains('flipped') && (item.name === 'å—ä¼¤' || item.name === 'å‘•å')) {
              // æ‰£é™¤å¥åº·åº¦
              if (item.name === 'å—ä¼¤') {
                gameData.status.health -= 3;
              } else if (item.name === 'å‘•å') {
                gameData.status.health -= 2;
              }

              // ç¡®ä¿å¥åº·åº¦ä¸ä½äº0
              if (gameData.status.health < 0) {
                gameData.status.health = 0;
              }

              // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
              checkGameOver();

              // æ›´æ–°å¥åº·åº¦æ˜¾ç¤º
              elements.healthPercentage.textContent = `${gameData.status.health}%`;
              elements.healthBar.style.width = `${gameData.status.health}%`;

              // æ›´æ–°æ¸¸æˆæ•°æ®
              updateGameData();

              console.log('é”®ç›˜ç§»åŠ¨åˆ°å·²ç¿»å¼€çš„å±é™©å¡ç‰Œï¼Œå¥åº·åº¦å‡å°‘:', item.name === 'å—ä¼¤' ? 3 : 2, 'å½“å‰å¥åº·åº¦:', gameData.status.health);
            }

            // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
            flipCurrentPosition();
          }
        }
        // å¦‚æœå·²æ˜¾ç¤ºè­¦ç¤ºæˆ–ä¸æ˜¯å±é™©ç‰©å“
        else {
          // ç§»é™¤è­¦ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
          targetItem.classList.remove('danger-tip');

          // å®é™…ç§»åŠ¨åˆ°æ–°ä½ç½®
          currentSelectedRow = newRow;
          currentSelectedCol = newCol;

          // æ›´æ–°æ‰€æœ‰æ ¼å­çš„å½“å‰é€‰ä¸­æ ·å¼
          const allGridItems = document.querySelectorAll('.garbage-grid-item');
          allGridItems.forEach(item => item.classList.remove('current'));
          targetItem.classList.add('current');

          // æ£€æŸ¥æ˜¯å¦ç§»åŠ¨åˆ°å·²ç¿»å¼€çš„å—ä¼¤æˆ–å‘•åå¡ç‰Œ
          if (targetItem.classList.contains('flipped') && (item.name === 'å—ä¼¤' || item.name === 'å‘•å')) {
            // æ‰£é™¤å¥åº·åº¦
            if (item.name === 'å—ä¼¤') {
              gameData.status.health -= 3;
            } else if (item.name === 'å‘•å') {
              gameData.status.health -= 2;
            }

            // ç¡®ä¿å¥åº·åº¦ä¸ä½äº0
            if (gameData.status.health < 0) {
              gameData.status.health = 0;
            }

            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            checkGameOver();

            // æ›´æ–°å¥åº·åº¦æ˜¾ç¤º
            elements.healthPercentage.textContent = `${gameData.status.health}%`;
            elements.healthBar.style.width = `${gameData.status.health}%`;

            // æ›´æ–°æ¸¸æˆæ•°æ®
            updateGameData();

            console.log('é”®ç›˜ç§»åŠ¨åˆ°å·²ç¿»å¼€çš„å±é™©å¡ç‰Œï¼Œå¥åº·åº¦å‡å°‘:', item.name === 'å—ä¼¤' ? 3 : 2, 'å½“å‰å¥åº·åº¦:', gameData.status.health);
          }

          // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
          flipCurrentPosition();
        }

        // é˜²æ­¢é»˜è®¤è¡Œä¸º
        event.preventDefault();
      }

      // å¤„ç†æ ¼å­ç‚¹å‡»çš„å‡½æ•°
      function handleGridItemClick(gridItem) {
        // è·å–æ ¼å­çš„è¡Œå’Œåˆ—
        const itemRow = parseInt(gridItem.dataset.row);
        const itemCol = parseInt(gridItem.dataset.col);

        // è·å–æ ¼å­ç‰©å“æ•°æ®
        const item = JSON.parse(gridItem.dataset.item);

        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å·²ç¿»å¼€çš„å—ä¼¤æˆ–å‘•åå¡ç‰Œ
        if (gridItem.classList.contains('flipped') && (item.name === 'å—ä¼¤' || item.name === 'å‘•å')) {
          // æ‰£é™¤å¥åº·åº¦
          if (item.name === 'å—ä¼¤') {
            gameData.status.health -= 3;
          } else if (item.name === 'å‘•å') {
            gameData.status.health -= 2;
          }

// ç¡®ä¿å¥åº·åº¦ä¸ä½äº0
          if (gameData.status.health < 0) {
            gameData.status.health = 0;
          }

// æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
          checkGameOver();

// æ›´æ–°å¥åº·åº¦æ˜¾ç¤º
            elements.healthPercentage.textContent = `${gameData.status.health}%`;
            elements.healthBar.style.width = `${gameData.status.health}%`;

// æ›´æ–°æ¸¸æˆæ•°æ®
          updateGameData();

console.log('ç‚¹å‡»å·²ç¿»å¼€çš„å±é™©å¡ç‰Œï¼Œå¥åº·åº¦å‡å°‘:', item.name === 'å—ä¼¤' ? 3 : 2, 'å½“å‰å¥åº·åº¦:', gameData.status.health);
          return; // ç‚¹å‡»å·²ç¿»å¼€çš„å±é™©å¡ç‰Œä¸éœ€è¦æ£€æŸ¥ç›¸é‚»ä½ç½®
        }

// æ£€æŸ¥æ˜¯å¦æ˜¯å±é™©ç‰©å“
        const isDanger = item.name === 'å—ä¼¤' || item.name === 'å‘•å';

// æ£€æŸ¥æ˜¯å¦å·²æ˜¾ç¤ºè­¦ç¤º
        const hasWarning = gridItem.classList.contains('danger-tip');

// æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®è¯¥æ ¼å­ï¼ˆåˆå§‹å€¼ä¸ºfalseè¡¨ç¤ºæœªè®¿é—®è¿‡ï¼‰
        const firstVisit = gridItem.dataset.firstVisit === 'false';

// æ£€æŸ¥æ˜¯å¦å¯ä»¥æ˜¾ç¤ºè­¦ç¤ºï¼ˆæ ¹æ®å·²æ˜¾ç¤ºçš„è­¦ç¤ºæ•°é‡å’Œæœ€å¤§è­¦ç¤ºæ•°é‡ï¼‰
        const canShowWarning = window.garbageGameWarningCount < window.garbageGameMaxWarningCount;

console.log('å¤„ç†æ ¼å­ç‚¹å‡»:', itemRow, itemCol, 'ç‰©å“:', item.name, 'å±é™©:', isDanger, 'å·²è­¦ç¤º:', hasWarning, 'å¯æ˜¾ç¤ºè­¦ç¤º:', canShowWarning, 'é¦–æ¬¡è®¿é—®:', firstVisit);

// æ£€æŸ¥æ˜¯å¦å¯ä»¥ç‚¹å‡»è¯¥ä½ç½®ï¼ˆä¸å·²ç¿»å¼€çš„æ ¼å­ç›¸é‚»ï¼‰
        const canClick = checkCanFlip(itemRow, itemCol);

if (!canClick) {
          console.log('ç‚¹å‡»æ§åˆ¶ï¼šæ— æ³•ç‚¹å‡»è¯¥ä½ç½®ï¼Œå¿…é¡»ä¸å·²ç¿»å¼€çš„æ ¼å­ç›¸é‚»');
          return;
        }

// ç§»é™¤æ‰€æœ‰æ ¼å­çš„å½“å‰é€‰ä¸­æ ·å¼
        const allGridItems = document.querySelectorAll('.garbage-grid-item');
        allGridItems.forEach(item => item.classList.remove('current'));

// ä¸ºå½“å‰ç‚¹å‡»çš„æ ¼å­æ·»åŠ å½“å‰é€‰ä¸­æ ·å¼
        gridItem.classList.add('current');

// å¦‚æœæ˜¯å±é™©ç‰©å“ä¸”å°šæœªæ˜¾ç¤ºè­¦ç¤ºä¸”æ˜¯é¦–æ¬¡è®¿é—®
        if (isDanger && !hasWarning && firstVisit) {
          // æ ‡è®°ä¸ºå·²è®¿é—®
          gridItem.dataset.firstVisit = 'true';

// å¦‚æœå…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œåˆ™æ˜¾ç¤ºè­¦ç¤º
          if (canShowWarning) {
            console.log('æ˜¾ç¤ºå±é™©è­¦ç¤º:', item.name);
            // å¢åŠ è­¦ç¤ºè®¡æ•°
            window.garbageGameWarningCount++;
            console.log('å½“å‰è­¦ç¤ºè®¡æ•°:', window.garbageGameWarningCount, 'æœ€å¤§è­¦ç¤ºæ•°é‡:', window.garbageGameMaxWarningCount);
            // æ·»åŠ çº¢è‰²è¾¹æ¡†é˜´å½±è­¦ç¤ºç±»
            gridItem.classList.add('danger-tip');
          } else {
            // ä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ‰§è¡Œç¿»ç‰Œ
            console.log('ä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ‰§è¡Œç¿»ç‰Œ');
            // ç§»é™¤è­¦ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
            gridItem.classList.remove('danger-tip');
            // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
            flipItem(gridItem);
          }
        }
        // å¦‚æœå·²æ˜¾ç¤ºè­¦ç¤ºæˆ–ä¸æ˜¯å±é™©ç‰©å“
        else {
          // ç§»é™¤è­¦ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
          gridItem.classList.remove('danger-tip');

          console.log('æ‰§è¡Œç¿»ç‰Œ:', item.name);
          // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
          flipItem(gridItem);
        }
      }

// æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¿»ç‰Œ
      function checkCanFlip(itemRow, itemCol) {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');
        const gridSize = Math.sqrt(allItems.length);

// æ‰¾åˆ°æ‰€æœ‰å·²ç¿»å¼€çš„æ ¼å­
        const flippedItems = Array.from(allItems).filter(gridItem => gridItem.classList.contains('flipped'));

// å¦‚æœæ²¡æœ‰å·²ç¿»å¼€çš„æ ¼å­ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æ˜¯ä¸­å¿ƒæ ¼å­
        if (flippedItems.length === 0) {
          const centerRow = Math.floor(gridSize / 2);
          const centerCol = Math.floor(gridSize / 2);
          return itemRow === centerRow && itemCol === centerCol;
        }

// æ£€æŸ¥æ˜¯å¦ä¸ä»»ä½•å·²ç¿»å¼€çš„æ ¼å­ä¸Šä¸‹å·¦å³ç›¸é‚»
        for (const gridItem of flippedItems) {
          const gridRow = parseInt(gridItem.dataset.row);
          const gridCol = parseInt(gridItem.dataset.col);

// æ£€æŸ¥æ˜¯å¦ä¸Šä¸‹å·¦å³ç›¸é‚»
          const isAdjacent = 
            (Math.abs(gridRow - itemRow) === 1 && gridCol === itemCol) ||
            (Math.abs(gridCol - itemCol) === 1 && gridRow === itemRow);

if (isAdjacent) {
            return true;
          }
        }

return false;
      }

// ç¿»ç‰Œå½“å‰ä½ç½®çš„å‡½æ•°
      function flipCurrentPosition() {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');

// ç§»é™¤æ‰€æœ‰æ ¼å­çš„currentç±»
        allItems.forEach(item => item.classList.remove('current'));

// æ‰¾åˆ°å½“å‰ä½ç½®çš„æ ¼å­
        const targetItem = Array.from(allItems).find(item => {
          return parseInt(item.dataset.row) === currentSelectedRow && parseInt(item.dataset.col) === currentSelectedCol;
        });

if (targetItem) {
          // ä¸ºå½“å‰æ ¼å­æ·»åŠ ç»¿è‰²è¾¹æ¡†å’Œé˜´å½±
          targetItem.classList.add('current');

console.log('é”®ç›˜æ§åˆ¶ï¼šç§»åŠ¨åˆ°æ ¼å­', currentSelectedRow, currentSelectedCol);
          // è°ƒç”¨ç‚¹å‡»å¤„ç†å‡½æ•°
          handleGridItemClick(targetItem);
        }
      }

// æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
      document.addEventListener('keydown', handleKeyboard);

// ä¿å­˜ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨ç»“æŸæ¸¸æˆæ—¶ç§»é™¤
      window.currentGarbageGameKeyboardListener = handleKeyboard;

      // åˆå§‹åŒ–ç¿»åƒåœ¾æ¸¸æˆçš„å‡½æ•°
      function initGarbageGame() {
        // éšæœºé€‰æ‹©3x3æˆ–5x5ç½‘æ ¼
        const gridSize = Math.random() > 0.5 ? 3 : 5;
        const garbageGrid = document.getElementById('garbageGrid');
        garbageGrid.innerHTML = '';

        // è®¾ç½®ç½‘æ ¼å¤§å°
        garbageGrid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
        garbageGrid.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;

        // åˆ›å»ºç‰©å“æ± 
        const items = generateGarbageItems(gridSize * gridSize);

        // æ‰“ä¹±ç‰©å“é¡ºåº
        shuffleArray(items);

        // åˆ›å»ºç½‘æ ¼é¡¹
        const gridItems = [];
        items.forEach((item, index) => {
          const gridItem = document.createElement('div');
          gridItem.className = 'garbage-grid-item';
          gridItem.dataset.item = JSON.stringify(item);
          gridItem.dataset.index = index;
          gridItem.dataset.row = Math.floor(index / gridSize);
          gridItem.dataset.col = index % gridSize;
          gridItem.dataset.flipped = 'false';
          gridItem.dataset.firstVisit = 'false'; // æ·»åŠ é¦–æ¬¡è®¿é—®æ ‡è®°

          // è®¡ç®—æ˜¯å¦æ˜¯ä¸­å¿ƒä½ç½®
          const centerRow = Math.floor(gridSize / 2);
          const centerCol = Math.floor(gridSize / 2);
          const isCenter = Math.floor(index / gridSize) === centerRow && index % gridSize === centerCol;

          // å¦‚æœæ˜¯ä¸­å¿ƒä½ç½®ï¼Œç›´æ¥ç¿»å¼€
          if (isCenter) {
            flipItem(gridItem, true);
          }

          // ä¸ºæ¯ä¸ªæ ¼å­æ·»åŠ ç‚¹å‡»äº‹ä»¶
          gridItem.addEventListener('click', function() {
            handleGridItemClick(this);
          });

          garbageGrid.appendChild(gridItem);
          gridItems.push(gridItem);
        });

        // ä¿å­˜å±é™©æ ¼å­åˆ—è¡¨ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
        const dangerItems = gridItems.filter(item => {
          const itemData = JSON.parse(item.dataset.item);
          return itemData.name === 'å—ä¼¤' || itemData.name === 'å‘•å';
        });

// æ ¹æ®æœå¯»æŠ€èƒ½ç­‰çº§ç¡®å®šå¯æç¤ºçš„å±é™©æ ¼å­æ•°é‡
        let maxWarningCount = 0;
        const searchSkill = gameData.skills.search || { level: 0 };
        const searchLevel = searchSkill.level || 0;

if (searchLevel >= 0 && searchLevel <= 4) {
          maxWarningCount = 1;
        } else if (searchLevel >= 5 && searchLevel <= 8) {
          maxWarningCount = 2;
        } else if (searchLevel >= 9) {
          maxWarningCount = 3;
        }

// æ·»åŠ è°ƒè¯•æ—¥å¿—
        console.log('å±é™©æ ¼å­æ€»æ•°:', dangerItems.length);
        console.log('æœå¯»æŠ€èƒ½ç­‰çº§:', searchLevel);
        console.log('æœ€å¤§è­¦ç¤ºæ•°é‡:', maxWarningCount);

// ä¿å­˜å±é™©æ ¼å­ä¿¡æ¯å’Œæœ€å¤§è­¦ç¤ºæ•°é‡åˆ°å…¨å±€å˜é‡
        window.garbageGameDangerItems = dangerItems;
        window.garbageGameMaxWarningCount = maxWarningCount;
        window.garbageGameWarningCount = 0; // è·Ÿè¸ªå·²ç»æ˜¾ç¤ºçš„è­¦ç¤ºæ•°é‡
      }

      // ç”Ÿæˆç¿»åƒåœ¾ç‰©å“
      function generateGarbageItems(totalItems) {
        const items = [];

        // æœ‰ä»·å€¼çš„ç‰©å“å¡ç‰Œï¼ˆä¸åŒ…æ‹¬ç§å­å’Œåƒåœ¾ï¼‰
        const valuableItems = [
          { type: 'positive', name: 'çªçªå¤´', effect: '+1çªçªå¤´' },
          { type: 'positive', name: 'æœ¨æ£', effect: '+1æœ¨æ£' },
          { type: 'positive', name: 'è‰è¯', effect: '+1è‰è¯' },
          { type: 'positive', name: 'é’±å¸', effect: '+1é’±å¸' }
        ];

        // æœ‰å®³çš„ç‰©å“å¡ç‰Œ
        const harmfulItems = [
          { type: 'negative', name: 'å—ä¼¤', effect: 'è·å¾—å—ä¼¤çŠ¶æ€ï¼Œå¥åº·-10' },
          { type: 'negative', name: 'å‘•å', effect: 'è·å¾—å‘•åçŠ¶æ€ï¼Œå¥åº·-5' },
          { type: 'negative', name: 'åƒåœ¾', effect: 'è·å¾—åƒåœ¾ï¼Œå¥åº·-3' }
        ];

        // ç§å­ç‰©å“ï¼ˆæ¯ç§1%æ¦‚ç‡ï¼‰
        const seedItems = [
          { type: 'positive', name: 'ç‰ç±³ç§å­', effect: '+1ç‰ç±³ç§å­' },
          { type: 'positive', name: 'å°éº¦ç§å­', effect: '+1å°éº¦ç§å­' },
          { type: 'positive', name: 'æ°´ç¨»ç§å­', effect: '+1æ°´ç¨»ç§å­' },
          { type: 'positive', name: 'è”¬èœç§å­', effect: '+1è”¬èœç§å­' },
          { type: 'positive', name: 'æ°´æœç§å­', effect: '+1æ°´æœç§å­' }
        ];

        // ç©ºåŒºåŸŸ
        const emptyItem = { type: 'neutral', name: 'ç©º', effect: 'æ— ' };

        // è®¡ç®—è‡³å°‘éœ€è¦çš„å¥–åŠ±ç‰©å“å’Œå±é™©ç‰©å“æ•°é‡ï¼ˆ20%ï¼Œå‘ä¸Šå–æ•´ï¼‰
        const minPositiveItems = Math.ceil(totalItems * 0.2);
        const minNegativeItems = Math.ceil(totalItems * 0.2);

        // ç¬¬ä¸€æ­¥ï¼šå¡«å……è‡³å°‘æ•°é‡çš„å¥–åŠ±ç‰©å“ï¼ˆä½¿ç”¨åŸºç¡€æœ‰ä»·å€¼ç‰©å“ï¼‰
        for (let i = 0; i < minPositiveItems; i++) {
          items.push(randomChoice(valuableItems));
        }

        // ç¬¬äºŒæ­¥ï¼šå¡«å……è‡³å°‘æ•°é‡çš„å±é™©ç‰©å“
        for (let i = 0; i < minNegativeItems; i++) {
          items.push(randomChoice(harmfulItems));
        }

        // ç¬¬ä¸‰æ­¥ï¼šç”¨å‰©ä½™çš„ç‰©å“å¡«å……æ•°ç»„
        const remainingItems = totalItems - minPositiveItems - minNegativeItems;
        for (let i = 0; i < remainingItems; i++) {
          const random = Math.random();
          if (random < 0.05) {
            // ç§å­ç‰©å“ï¼ˆ5%æ€»æ¦‚ç‡ï¼Œæ¯ç§ç§å­1%ï¼‰
            items.push(randomChoice(seedItems));
          } else if (random < 0.35) {
            // æœ‰ä»·å€¼çš„ç‰©å“ï¼ˆ30%ï¼‰
            items.push(randomChoice(valuableItems));
          } else if (random < 0.65) {
            // æœ‰å®³çš„ç‰©å“ï¼ˆ30%ï¼‰
            items.push(randomChoice(harmfulItems));
          } else {
            // ç©ºåŒºåŸŸï¼ˆ35%ï¼‰
            items.push(emptyItem);
          }
        }

        // æ‰“ä¹±æ•°ç»„ï¼Œç¡®ä¿ç‰©å“éšæœºåˆ†å¸ƒ
        shuffleArray(items);

        return items;
      }

      // éšæœºé€‰æ‹©å‡½æ•°
      function randomChoice(array) {
        return array[Math.floor(Math.random() * array.length)];
      }

      // æ‰“ä¹±æ•°ç»„å‡½æ•°
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

// ç¿»åƒåœ¾ç‰©å“
      function flipItem(itemElement, isCenter = false) {
        if (itemElement.classList.contains('flipped')) {
          return;
        }

        // è·å–æ ¼å­çš„è¡Œå’Œåˆ—
        const itemRow = parseInt(itemElement.dataset.row);
        const itemCol = parseInt(itemElement.dataset.col);

// æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¿»ç‰Œï¼ˆé™¤äº†ä¸­å¿ƒæ ¼å­ï¼Œå…¶ä»–æƒ…å†µç”±è°ƒç”¨æ–¹æ£€æŸ¥ï¼‰
        if (!isCenter && !checkCanFlip(itemRow, itemCol)) {
          return;
        }

        // æ·»åŠ ç‚¹å‡»åé¦ˆæ•ˆæœ
        itemElement.style.transform = 'translateY(-2px) scale(0.95)';
        itemElement.style.boxShadow = '0 0 0 rgba(72, 187, 120, 0)';
        
        // æ·»åŠ ç‚¹å‡»æ¶Ÿæ¼ªæ•ˆæœ
        itemElement.classList.add('clicked');
        setTimeout(() => {
          itemElement.classList.remove('clicked');
        }, 500);
        
        // åº”ç”¨ç¿»è½¬åŠ¨ç”»
        itemElement.style.animation = 'flip3d 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards, flipGlow 0.3s ease 0.3s';
        
        // æ·»åŠ ç¿»è½¬éŸ³æ•ˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        playFlipSound();

        // å»¶è¿Ÿæ‰§è¡Œç¿»è½¬å†…å®¹æ˜¾ç¤ºï¼ˆåœ¨åŠ¨ç”»ä¸­é€”åˆ‡æ¢ï¼‰
        setTimeout(() => {
          const item = JSON.parse(itemElement.dataset.item);

          // ç«‹å³ç§»é™¤èƒŒæ™¯å›¾ç‰‡ï¼Œé¿å…ç¿»å›æ¥æ—¶é—ªä¸€ä¸‹å°é¢
          itemElement.style.backgroundImage = 'none';

          // ç§»é™¤ä¹‹å‰æ·»åŠ çš„æ„Ÿå¹å·å¡ç‰Œå†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const existingContent = itemElement.querySelector('.item-content');
          if (existingContent) {
            itemElement.removeChild(existingContent);
          }

          // æ·»åŠ ç‰©å“å†…å®¹
          const itemContent = document.createElement('div');
          itemContent.className = 'item-content';
          itemContent.style.opacity = '0';

          // æ·»åŠ å›¾ç‰‡æ˜¾ç¤º
          let itemImage = '';
          // ä¸ºæœ‰ä»·å€¼ç‰©å“å’Œæœ‰å®³ç‰©å“æ·»åŠ å¯¹åº”å¡ç‰Œå›¾ç‰‡
          if (item.type !== 'neutral') {
            // æ ¹æ®ç‰©å“åç§°è·å–å¯¹åº”çš„å¡ç‰Œå›¾ç‰‡
            let imageName = item.name;
            if (item.name === 'é£Ÿç‰©') {
              // é£Ÿç‰©ä½¿ç”¨çªçªå¤´ä½œä¸ºé»˜è®¤å›¾ç‰‡
              imageName = 'çªçªå¤´';
            }
            itemImage = `<img src="UI/${imageName}.jpg" alt="${item.name}" style="width: 100%; height: 100%; object-fit: contain;">`;
          }

          itemContent.innerHTML = `
            <div class="item-card">
              ${itemImage}
            </div>
          `;

          itemElement.appendChild(itemContent);

          // å»¶è¿Ÿæ˜¾ç¤ºå†…å®¹ï¼Œç­‰å¾…ç¿»è½¬åŠ¨ç”»æ¥è¿‘å®Œæˆæ—¶
          setTimeout(() => {
            itemContent.style.opacity = '1';
          }, 200);

          // ç§»é™¤è­¦ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
          itemElement.classList.remove('danger-tip');

          // æ ¹æ®ç‰©å“ç±»å‹æ·»åŠ ç‰¹æ®Šæ•ˆæœ
          addItemFlipEffect(itemElement, item.type);

          // æ·»åŠ ç²’å­æ•ˆæœ
          createFlipParticles(itemElement);

          // æ·»åŠ ç‰©å“ç±»å‹ç‰¹æ•ˆ
          addItemTypeEffect(itemElement, item.type);

          // åº”ç”¨ç‰©å“æ•ˆæœ
          applyItemEffect(item);
        }, 300); // åœ¨åŠ¨ç”»ä¸­é€”ï¼ˆ300msï¼‰åˆ‡æ¢å†…å®¹

        // åŠ¨ç”»ç»“æŸåè®¾ç½®flippedçŠ¶æ€
        setTimeout(() => {
          itemElement.classList.add('flipped');
        }, 600); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      }

      // æ’­æ”¾ç¿»è½¬éŸ³æ•ˆ
      function playFlipSound() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ éŸ³é¢‘æ’­æ”¾é€»è¾‘
        // ä¾‹å¦‚ï¼šnew Audio('sounds/flip.mp3').play();
        console.log('æ’­æ”¾ç¿»è½¬éŸ³æ•ˆ');
      }

      // æ ¹æ®ç‰©å“ç±»å‹æ·»åŠ ç¿»è½¬ç‰¹æ•ˆ
      function addItemFlipEffect(element, itemType) {
        switch (itemType) {
          case 'positive':
            // æ­£é¢ç‰©å“ï¼šç»¿è‰²å…‰æ•ˆ
            element.style.boxShadow = '0 0 20px rgba(72, 187, 120, 0.6)';
            setTimeout(() => {
              element.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            }, 1000);
            break;
          case 'negative':
            // è´Ÿé¢ç‰©å“ï¼šçº¢è‰²å…‰æ•ˆ
            element.style.boxShadow = '0 0 20px rgba(255, 0, 0, 0.6)';
            setTimeout(() => {
              element.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            }, 1000);
            break;
          case 'neutral':
            // ä¸­æ€§ç‰©å“ï¼šè“è‰²å…‰æ•ˆ
            element.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.6)';
            setTimeout(() => {
              element.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            }, 1000);
            break;
        }
      }

      // åˆ›å»ºç¿»è½¬ç²’å­æ•ˆæœ
      function createFlipParticles(element) {
        const particleCount = 8;
        const rect = element.getBoundingClientRect();
        
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'flip-particle';
          
          // éšæœºç²’å­ä½ç½®å’Œæ–¹å‘
          const angle = (Math.PI * 2 * i) / particleCount;
          const distance = Math.random() * 30 + 20;
          const tx = Math.cos(angle) * distance;
          const ty = Math.sin(angle) * distance - 30;
          
          particle.style.setProperty('--tx', `${tx}px`);
          particle.style.setProperty('--ty', `${ty}px`);
          particle.style.left = '50%';
          particle.style.top = '50%';
          
          // éšæœºé¢œè‰²ï¼ˆæ ¹æ®ç‰©å“ç±»å‹ï¼‰
          const colors = ['#48BB78', '#4299E1', '#ED8936', '#9F7AEA'];
          particle.style.background = `radial-gradient(circle, ${colors[Math.floor(Math.random() * colors.length)]} 0%, transparent 70%)`;
          
          element.appendChild(particle);
          
          // ç§»é™¤ç²’å­
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 1000);
        }
      }

      // æ·»åŠ ç‰©å“ç±»å‹ç‰¹æ•ˆ
      function addItemTypeEffect(element, itemType) {
        const effectClass = `${itemType}-effect`;
        element.classList.add(effectClass);
        
        // ç§»é™¤ç‰¹æ•ˆç±»
        setTimeout(() => {
          element.classList.remove(effectClass);
        }, 1000);
      }

      // åº”ç”¨ç‰©å“æ•ˆæœ
      function applyItemEffect(item) {
        switch (item.name) {
          case 'çªçªå¤´':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'æœ¨æ£':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'è‰è¯':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'é’±å¸':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'åƒåœ¾':
            // åƒåœ¾å±äºæœ‰å®³ç‰©å“ï¼Œå‡å°‘å¥åº·3ç‚¹
            if (gameData.status) {
              gameData.status.health = Math.max(0, gameData.status.health - 3);
              checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            }
            break;
          case 'ç‰ç±³ç§å­':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'å°éº¦ç§å­':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'æ°´ç¨»ç§å­':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'è”¬èœç§å­':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'æ°´æœç§å­':
            // ä¸å†ç«‹å³æ·»åŠ åˆ°èƒŒåŒ…ï¼Œç­‰å¾…æ¸¸æˆç»“æŸæ—¶ç»Ÿä¸€æ·»åŠ 
            break;
          case 'å—ä¼¤':
            // æ£€æŸ¥æ¸¸æˆæ•°æ®ä¸­æ˜¯å¦æœ‰å¡ç‰Œç³»ç»Ÿ
            if (gameData.cards && Array.isArray(gameData.cards)) {
              // æ·»åŠ å—ä¼¤å¡ç‰Œ
              gameData.cards.push('å—ä¼¤');
            } else if (gameData.status) {
              // å¦‚æœæ²¡æœ‰å¡ç‰Œç³»ç»Ÿï¼Œç›´æ¥å‡å°‘å¥åº·å€¼
              gameData.status.health -= 10;
              checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            }
            break;
          case 'å‘•å':
            // æ£€æŸ¥æ¸¸æˆæ•°æ®ä¸­æ˜¯å¦æœ‰å¡ç‰Œç³»ç»Ÿ
            if (gameData.cards && Array.isArray(gameData.cards)) {
              // æ·»åŠ å‘•åå¡ç‰Œ
              gameData.cards.push('å‘•å');
            } else if (gameData.status) {
              // å¦‚æœæ²¡æœ‰å¡ç‰Œç³»ç»Ÿï¼Œç›´æ¥å‡å°‘å¥åº·å€¼
              gameData.status.health -= 5;
              checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            }
            break;
          // ç©ºåŒºåŸŸä¸éœ€è¦å¤„ç†
        }

        // æ›´æ–°æ¸¸æˆæ•°æ®
        updateGameData();

        // æ£€æŸ¥æ¸¸æˆçŠ¶æ€æ˜¯å¦å¤±è´¥
        checkGameOver();
      }



      // ç»“æŸç¿»åƒåœ¾æ¸¸æˆ
      function endGarbageGame() {
        // é˜²æ­¢é‡å¤è°ƒç”¨
        if (window.garbageGameEnded) return;
        window.garbageGameEnded = true;

        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
        if (window.currentGarbageGameKeyboardListener) {
          document.removeEventListener('keydown', window.currentGarbageGameKeyboardListener);
          delete window.currentGarbageGameKeyboardListener;
        }

// æ”¶é›†ç»“æœå¹¶æ˜¾ç¤ºå¼¹çª—
        showLootResultsModal();

        // å…³é—­ç¿»åƒåœ¾æ¸¸æˆçª—å£
        const garbageModal = document.querySelector('.garbage-game-modal');
        const style = document.querySelector('style[innerText*="garbage-game-modal"]');
        if (garbageModal) {
          garbageModal.classList.add('closing');
          setTimeout(() => {
            if (garbageModal.parentNode) {
              garbageModal.parentNode.removeChild(garbageModal);
            }
            if (style && style.parentNode) {
              style.parentNode.removeChild(style);
            }
            // é‡ç½®æ ‡å¿—ï¼Œå…è®¸ä¸‹æ¬¡æ¸¸æˆ
            window.garbageGameEnded = false;
          }, 300);
        }
      }

      // æ˜¾ç¤ºç¿»åƒåœ¾ç»“æœå¼¹çª—
      function showLootResultsModal() {
        const flippedItems = document.querySelectorAll('.garbage-grid-item.flipped');
        const results = [];

        flippedItems.forEach(item => {
          const itemData = JSON.parse(item.dataset.item);
          results.push(itemData);
        });

        // ç»Ÿè®¡ç»“æœ - åªç»Ÿè®¡æœ‰ä»·å€¼çš„ç‰©å“
        const valuableItems = results.filter(item => item.type === 'positive');

        // è®¡ç®—å„ç§æœ‰ä»·å€¼ç‰©å“çš„æ•°é‡
        const itemCounts = {};

        // è·å–å½“å‰åœºæ™¯ID
        const currentLocation = gameData.locations.find(loc => loc.currentLocation);
        const locationId = currentLocation ? currentLocation.id : 'street';

        valuableItems.forEach(item => {
          // æ ¹æ®ç‰©å“åç§°è·å–å¯¹åº”çš„èµ„æºID
          const resourceId = Object.keys(gameData.resources).find(id => gameData.resources[id].name === item.name);

          // å°†ç‰©å“æ·»åŠ åˆ°åœ°é¢æ ä¸­
          if (resourceId) {
            addResourceToGround(resourceId, 1, locationId);
          }

          // ç»Ÿè®¡æ•°é‡
          itemCounts[item.name] = (itemCounts[item.name] || 0) + 1;
        });

// æ›´æ–°èƒŒåŒ…UI
        renderResources();

        // æ”¹ä¸ºé€šçŸ¥æ˜¾ç¤º
        if (valuableItems.length > 0) {
          let message = 'ç¿»åƒåœ¾æ”¶è·ï¼š';
          const itemDetails = [];
          Object.entries(itemCounts).forEach(([itemName, count]) => {
            itemDetails.push(`${itemName}Ã—${count}`);
          });
          message += itemDetails.join('ã€');
          showNotification('ç¿»åƒåœ¾æ”¶è·', message, true);
        } else {
          showNotification('ç¿»åƒåœ¾æ”¶è·', 'æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰ä»·å€¼çš„ç‰©å“ã€‚', false);
        }
      }

    }

    // åœå¦ç³»ç»Ÿ - å…¨å±€é¢„åŠ è½½çŠ¶æ€
    let divinationPreloadedImages = [];
    let isDivinationPreloading = false;
    
    // é¢„åŠ è½½åœå¦å›¾ç‰‡
    function startDivinationPreload() {
      if (isDivinationPreloading) return;
      isDivinationPreloading = true;
      
      const totalSigns = 20;
      const promises = [];
      
      for (let i = 1; i <= totalSigns; i++) {
        const promise = new Promise((resolve) => {
          const img = new Image();
          img.src = `å¸§åºåˆ—/åœå¦/${i}.png`;
          img.onload = () => {
            divinationPreloadedImages[i] = img;
            resolve();
          };
          img.onerror = () => {
            console.warn(`é¢„åŠ è½½å¤±è´¥: å¸§åºåˆ—/åœå¦/${i}.png`);
            resolve(); // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
          };
        });
        promises.push(promise);
      }
      
      Promise.all(promises).then(() => {
        console.log('åœå¦å›¾ç‰‡é¢„åŠ è½½å®Œæˆ');
      });
    }
    
    function showDivinationModal() {
      // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»åœå¦è¿‡
      if (gameData.divinationDoneToday) {
        showNotification('ä»Šæ—¥å·²åœå¦', 'ä½ å·²ç»åœè¿‡å¦äº†ï¼Œæ˜å¤©å†æ¥å§ï¼');
        return;
      }

      const divinationModal = document.createElement('div');
      divinationModal.className = 'divination-modal';
      divinationModal.innerHTML = `
        <div class="divination-content">
          <div class="divination-image-container">
            <img src="UI/ç®—å¦ç•Œé¢.jpg" alt="ç®—å¦ç•Œé¢" class="divination-bg-image">
            <div class="divination-sign-container" id="divinationSignContainer"></div>
          </div>
          <button class="divination-button" id="divinationButton">ç®—ä¸€å¦</button>
        </div>
      `;

      // åœ¨æ˜¾ç¤ºç•Œé¢æ—¶å°±å¼€å§‹é¢„åŠ è½½å›¾ç‰‡
      startDivinationPreload();

      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .divination-modal {
          display: flex;
          justify-content: center;
          align-items: center;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.8);
          z-index: 1000;
          animation: fadeIn 0.3s ease;
        }

        .divination-content {
          position: relative;
          max-width: 800px;
          width: 90%;
          text-align: center;
        }

        .divination-image-container {
          position: relative;
          width: 100%;
          background-size: cover;
          background-position: center;
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .divination-bg-image {
          width: 100%;
          height: auto;
          display: block;
        }

        .divination-sign-container {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 500px;
          height: 500px;
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .divination-sign {
          max-width: 100%;
          max-height: 100%;
          object-fit: contain;
        }

        .divination-button {
          position: absolute;
          bottom: 20%;
          left: 50%;
          transform: translateX(-50%);
          padding: 15px 40px;
          font-size: 1.2rem;
          font-weight: bold;
          color: white;
          background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
          border: 2px solid #D2691E;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
          z-index: 10;
        }

        .divination-button:hover {
          background: linear-gradient(135deg, #A0522D 0%, #CD853F 100%);
          transform: translateX(-50%) translateY(-2px);
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .divination-button:active {
          transform: translateX(-50%) translateY(0);
        }

        .divination-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          pointer-events: none;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }
      `;

      document.body.appendChild(divinationModal);
      document.head.appendChild(style);

      // ç‚¹å‡»"ç®—ä¸€å¦"æŒ‰é’®
      const divinationButton = document.getElementById('divinationButton');
      divinationButton.addEventListener('click', function() {
        divinationButton.disabled = true;
        startDivination();
      });

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      divinationModal.addEventListener('click', function(e) {
        if (e.target === divinationModal) {
          closeDivinationModal();
        }
      });
    }

    function startDivination() {
      const signContainer = document.getElementById('divinationSignContainer');
      const totalSigns = 20;
      const frameTime = 80; // 80msæ¯å¸§ï¼ŒåŠ å¿«æ’­æ”¾é€Ÿåº¦
      let currentSign = 1;
      let lastTime = performance.now();

      // å¼€å§‹åŠ¨ç”»
      function playAnimation() {
        // åˆ›å»ºå¹¶ç¼“å­˜æ‰€æœ‰å›¾ç‰‡å…ƒç´ 
        const imageElements = [];
        for (let i = 1; i <= totalSigns; i++) {
          const img = document.createElement('img');
          img.className = 'divination-sign';
          img.alt = `æŠ½ç­¾ ${i}`;
          img.style.display = 'none'; // åˆå§‹éšè—
          
          // ä¼˜å…ˆä½¿ç”¨å…¨å±€é¢„åŠ è½½çš„å›¾ç‰‡ï¼Œå¦‚æœæœªåŠ è½½åˆ™æŒ‰éœ€åŠ è½½
          if (divinationPreloadedImages[i]) {
            img.src = divinationPreloadedImages[i].src;
          } else {
            // æŒ‰éœ€åŠ è½½
            img.src = `å¸§åºåˆ—/åœå¦/${i}.png`;
          }
          
          signContainer.appendChild(img);
          imageElements.push(img);
        }

        function showNextSign(currentTime) {
          if (currentSign > totalSigns) {
            // æ‰€æœ‰ç­¾æ˜¾ç¤ºå®Œæ¯•ï¼Œæ˜¾ç¤ºç»“æœ
            setTimeout(() => {
              showDivinationResult();
            }, 300);
            return;
          }

          // æ§åˆ¶å¸§é—´éš”
          const deltaTime = currentTime - lastTime;
          if (deltaTime >= frameTime) {
            lastTime = currentTime;

            // éšè—æ‰€æœ‰å›¾ç‰‡
            imageElements.forEach(img => img.style.display = 'none');
            
            // æ˜¾ç¤ºå½“å‰å¸§
            if (imageElements[currentSign - 1]) {
              imageElements[currentSign - 1].style.display = 'block';
            }

            currentSign++;
          }

          // ä½¿ç”¨requestAnimationFrameç»§ç»­ä¸‹ä¸€å¸§
          requestAnimationFrame(showNextSign);
        }

        requestAnimationFrame(showNextSign);
      }

      // ç›´æ¥æ’­æ”¾åŠ¨ç”»ï¼Œä½¿ç”¨ä¼˜åŒ–åçš„å›¾ç‰‡åŠ è½½ç­–ç•¥
      playAnimation();
    }

    function showDivinationResult() {
      // éšæœºå†³å®šç­¾çš„ç±»å‹
      const random = Math.random() * 100;
      let signType;
      let signTypeName;

      if (random < 33.33) {
        signType = 'ä¸Šä¸Šç­¾';
        signTypeName = 'ä¸Šä¸Šç­¾';
      } else if (random < 66.66) {
        signType = 'ä¸­ç­¾';
        signTypeName = 'ä¸­ç­¾';
      } else {
        signType = 'ä¸‹ä¸‹ç­¾';
        signTypeName = 'ä¸‹ä¸‹ç­¾';
      }

      // æ ¹æ®ç­¾çš„ç±»å‹å†³å®šå…·ä½“æ•ˆæœ
      let resultText = '';
      let effectResult = {};

      if (signType === 'ä¸Šä¸Šç­¾') {
        // ä¸Šä¸Šç­¾ï¼š4ç§ç»“æœï¼ˆå‡ ç‡é€’å‡ï¼‰
        const upperRandom = Math.random() * 100;
        if (upperRandom < 40) {
          // 40%å‡ ç‡ï¼šå¹¸è¿å„¿BUFF
          resultText = 'è·å¾—"å¹¸è¿å„¿"BUFFï¼Œä»è·å¾—å¼€å§‹3å¤©ä»¥å†…ï¼Œé”£é¼“å··è¿›è¡Œå·çªƒï¼Œè‹¥å·çªƒæˆåŠŸå¿…å®šè·å¾—é‡‘å­æˆ–é“¶å­æˆ–é‡‘æ¡ä¸­çš„ä¸€ä¸ªã€‚';
          effectResult = {
            type: 'lucky',
            description: 'å¹¸è¿å„¿ï¼š3å¤©å†…é”£é¼“å··å·çªƒæˆåŠŸå¿…å®šè·å¾—é‡‘å­ã€é“¶å­æˆ–é‡‘æ¡'
          };
        } else if (upperRandom < 70) {
          // 30%å‡ ç‡ï¼šè¢«ç½©äº†BUFF
          resultText = 'è·å¾—"è¢«ç½©äº†"BUFFï¼Œä»è·å¾—å¼€å§‹3å¤©ä»¥å†…æ— è®ºæ˜¯ä¸‹é›¨å¤©è¿˜æ˜¯ä¸‹é›ªå¤©ï¼Œä¹Ÿä¸ä¼šè·å¾—"å…¨èº«æ¹¿é€"çš„BUFFã€‚';
          effectResult = {
            type: 'protected',
            description: 'è¢«ç½©äº†ï¼š3å¤©å†…æ— è®ºé›¨é›ªå¤©æ°”éƒ½ä¸ä¼šå…¨èº«æ¹¿é€'
          };
        } else if (upperRandom < 95) {
          // 25%å‡ ç‡ï¼šéšæœºè·å¾—10-100é’±å¸
          const moneyAmount = Math.floor(Math.random() * 91) + 10; // 10-100
          gameData.resources.money.amount += moneyAmount;
          resultText = `ç«‹å³è·å¾—${moneyAmount}é’±å¸ã€‚`;
          effectResult = {
            type: 'money',
            amount: moneyAmount,
            description: `è·å¾—${moneyAmount}é’±å¸`
          };
        } else {
          // 5%å‡ ç‡ï¼šç¥ç§˜é“å…·ï¼ˆçµè¯1ç“¶ï¼‰
          if (gameData.resources.medicine) {
            gameData.resources.medicine.amount += 1;
          }
          resultText = 'è·å¾—ç¥ç§˜é“å…·ï¼šçµè¯1ç“¶ï¼';
          effectResult = {
            type: 'medicine',
            description: 'è·å¾—çµè¯1ç“¶'
          };
        }
      } else if (signType === 'ä¸­ç­¾') {
        // ä¸­ç­¾ï¼šæ— äº‹å‘ç”Ÿ
        resultText = 'æ— äº‹å‘ç”Ÿã€‚';
        effectResult = {
          type: 'nothing',
          description: 'æ— äº‹å‘ç”Ÿ'
        };
      } else {
        // ä¸‹ä¸‹ç­¾ï¼š3ç§äº‹ä»¶ï¼ˆå‡ ç‡ä¸€æ ·ï¼‰
        const lowerRandom = Math.random();
        if (lowerRandom < 0.33) {
          // æ‰€æœ‰çŠ¶æ€å‡åŠï¼ˆé™¤äº†æ¶ˆåŒ–ã€ä½“æ¸©å’Œå£°æœ›ï¼‰
          const statusToHalve = ['hunger', 'health', 'blood', 'spirit', 'thirst'];
          statusToHalve.forEach(status => {
            if (status in gameData.status) {
              gameData.status[status] = Math.floor(gameData.status[status] / 2);
            }
          });
          resultText = 'æ‰€æœ‰çŠ¶æ€å‡åŠï¼';
          effectResult = {
            type: 'status_halve',
            description: 'æ‰€æœ‰çŠ¶æ€å‡åŠ'
          };
        } else if (lowerRandom < 0.66) {
          // éšæœºå¤±å»10-50é’±å¸
          const lossAmount = Math.floor(Math.random() * 41) + 10; // 10-50
          const currentMoney = gameData.resources.money.amount;
          const actualLoss = Math.min(lossAmount, currentMoney);
          gameData.resources.money.amount -= actualLoss;
          resultText = `å¤±å»${actualLoss}é’±å¸ã€‚`;
          effectResult = {
            type: 'money_loss',
            amount: actualLoss,
            description: `å¤±å»${actualLoss}é’±å¸`
          };
        } else {
          // è¢«å°å·å·èµ°ä¸€ä»¶ç‰©å“ï¼ˆç¢—ç±»ä¸å¯ä»¥è¢«å·çªƒï¼‰
          const stealableResources = Object.keys(gameData.resources).filter(resourceId => {
            const resource = gameData.resources[resourceId];
            return resource.amount > 0 && !resourceId.includes('bowl');
          });

          if (stealableResources.length > 0) {
            const stolenResourceId = stealableResources[Math.floor(Math.random() * stealableResources.length)];
            const stolenResource = gameData.resources[stolenResourceId];
            gameData.resources[stolenResourceId].amount -= 1;
            resultText = `è¢«å°å·å·èµ°äº†1ä¸ª${stolenResource.name}ï¼`;
            effectResult = {
              type: 'item_stolen',
              item: stolenResource.name,
              description: `è¢«å°å·å·èµ°äº†1ä¸ª${stolenResource.name}`
            };
          } else {
            resultText = 'è™½ç„¶é­é‡äº†å°å·ï¼Œä½†ä½ èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œä»€ä¹ˆä¹Ÿæ²¡æœ‰è¢«å·èµ°ã€‚';
            effectResult = {
              type: 'nothing',
              description: 'æ— äº‹å‘ç”Ÿ'
            };
          }
        }
      }

      // æ ‡è®°ä»Šå¤©å·²åœå¦
      gameData.divinationDoneToday = true;

      // æ˜¾ç¤ºç»“æœçª—å£
      const resultModal = document.createElement('div');
      resultModal.className = 'divination-result-modal';
      resultModal.innerHTML = `
        <div class="divination-result-content">
          <div class="divination-result-title">${signTypeName}</div>
          <div class="divination-result-text">${resultText}</div>
          <button class="divination-result-button" id="divinationResultButton">ç¡®å®š</button>
        </div>
      `;

      const resultStyle = document.createElement('style');
      resultStyle.textContent = `
        .divination-result-modal {
          display: flex;
          justify-content: center;
          align-items: center;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.8);
          z-index: 1100;
          animation: fadeIn 0.3s ease;
        }

        .divination-result-content {
          background: linear-gradient(135deg, #FFFDF7 0%, #F5E6D3 100%);
          border: 3px solid #8B4513;
          border-radius: 12px;
          padding: 30px;
          max-width: 500px;
          width: 90%;
          text-align: center;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .divination-result-title {
          font-size: 2.5rem;
          font-weight: bold;
          color: #8B4513;
          margin-bottom: 20px;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .divination-result-text {
          font-size: 1.2rem;
          color: #333;
          margin-bottom: 30px;
          line-height: 1.6;
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .divination-result-button {
          padding: 12px 40px;
          font-size: 1.1rem;
          font-weight: bold;
          color: white;
          background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
          border: 2px solid #D2691E;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif;
        }

        .divination-result-button:hover {
          background: linear-gradient(135deg, #A0522D 0%, #CD853F 100%);
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
      `;

      document.body.appendChild(resultModal);
      document.head.appendChild(resultStyle);

      // åº”ç”¨BUFFæ•ˆæœ
      applyDivinationEffect(effectResult);

      // ç‚¹å‡»ç¡®å®šæŒ‰é’®
      const resultButton = document.getElementById('divinationResultButton');
      resultButton.addEventListener('click', function() {
        // ç§»é™¤ç»“æœçª—å£
        resultModal.remove();
        resultStyle.remove();

        // ç§»é™¤åœå¦çª—å£
        closeDivinationModal();

        // æ›´æ–°èƒŒåŒ…UI
        renderResources();

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        updateGameData();

        // åˆ·æ–°è¡ŒåŠ¨ç•Œé¢ï¼Œéšè—å·²åœå¦çš„æŒ‰é’®
        renderActions();

        // æ¶ˆè€—æ—¶é—´
        advanceTime(30);
      });
    }

    function applyDivinationEffect(effect) {
      if (effect.type === 'lucky') {
        // å¹¸è¿å„¿BUFF
        gameData.buffs['å¹¸è¿å„¿'] = {
          active: true,
          days: 3,
          description: effect.description
        };
      } else if (effect.type === 'protected') {
        // è¢«ç½©äº†BUFF
        if (gameData.buffs['è¢«ç½©äº†'] && gameData.buffs['è¢«ç½©äº†'].active) {
          // å¦‚æœå·²å­˜åœ¨ï¼Œå åŠ å‰©ä½™å¤©æ•°
          gameData.buffs['è¢«ç½©äº†'].days += 3;
        } else {
          gameData.buffs['è¢«ç½©äº†'] = {
            active: true,
            days: 3,
            description: effect.description
          };
        }
      }
    }

    function closeDivinationModal() {
      const divinationModal = document.querySelector('.divination-modal');
      const style = document.querySelector('style[innerText*="divination-modal"]');
      if (divinationModal) {
        divinationModal.classList.add('closing');
        setTimeout(() => {
          if (divinationModal.parentNode) {
            divinationModal.parentNode.removeChild(divinationModal);
          }
          if (style && style.parentNode) {
            style.parentNode.removeChild(style);
          }
        }, 300);
      }
    }

    // æ‰§è¡Œè¡ŒåŠ¨
    function calculateSeason(day) {
        // è®¡ç®—å¤©æ•°åœ¨40å¤©å‘¨æœŸä¸­çš„ä½ç½®ï¼ˆä»0å¼€å§‹ï¼‰
        const cycleDay = (day - 1) % 40;
        
        // å®šä¹‰å­£èŠ‚èŒƒå›´
        if (cycleDay >= 0 && cycleDay < 10) {
            return 'spring'; // ç¬¬1-10å¤©ï¼šæ˜¥å­£
        } else if (cycleDay >= 10 && cycleDay < 20) {
            return 'summer'; // ç¬¬11-20å¤©ï¼šå¤å­£
        } else if (cycleDay >= 20 && cycleDay < 30) {
            return 'autumn'; // ç¬¬21-30å¤©ï¼šç§‹å­£
        } else { // cycleDay >= 30 && cycleDay < 40
            return 'winter'; // ç¬¬31-40å¤©ï¼šå†¬å­£
        }
    }

    // è¿›å…¥ä¸‹ä¸€å¤©å‡½æ•°
    function goToNextDay() {
        // è®¡ç®—è¿˜å‰©ä¸‹å‡ ä¸ªæ—¶é—´æ®µåˆ°ç¬¬äºŒå¤©ï¼Œå¹¶å‡å»ç›¸åº”çš„æ•°å€¼
        const timeOrder = ['early_morning', 'morning', 'afternoon', 'evening', 'night'];
        const currentTimeIndex = timeOrder.indexOf(gameData.timeOfDay);
        const remainingPeriods = 5 - currentTimeIndex - 1; // è®¡ç®—å‰©ä½™æ—¶é—´æ®µæ•°é‡
        
        if (remainingPeriods > 0) {
            // æ¯ä¸ªå‰©ä½™æ—¶é—´æ®µï¼Œé¥±é£Ÿã€æ°´åˆ†ã€ç²¾ç¥å€¼ä¸‹é™5
            const decreaseAmount = remainingPeriods * 5;
            gameData.status.hunger = Math.max(0, gameData.status.hunger - decreaseAmount);
            gameData.status.thirst = Math.max(0, gameData.status.thirst - decreaseAmount); // å‡å°‘æ°´åˆ†å€¼ï¼ˆæ°´åˆ†æ¶ˆè€—ï¼‰
            gameData.status.spirit = Math.max(0, gameData.status.spirit - decreaseAmount);
            
            // å†œç”°æ¹¿æ¶¦åº¦æ ¹æ®å‰©ä½™æ—¶é—´æ®µå‡å°‘ï¼ˆæ¯ä¸ªæ—¶é—´æ®µå‡å°‘5ï¼‰
            if (gameData.farmlandData && gameData.farmlandData.cells) {
                const moistureDecrease = remainingPeriods * 5;
                gameData.farmlandData.cells.forEach(cell => {
                    cell.moisture = Math.max(0, cell.moisture - moistureDecrease);
                });
            }
            
            // ç¯ç«ç‡ƒæ–™æ ¹æ®å‰©ä½™æ—¶é—´æ®µæ¶ˆè€—ï¼ˆæ¯ä¸ªæ—¶é—´æ®µå‡å°‘5ï¼‰
            if (gameData.resources.fire && gameData.resources.fire.amount > 0) {
                const fuelDecrease = remainingPeriods * 5;
                gameData.resources.fire.fuel = Math.max(0, gameData.resources.fire.fuel - fuelDecrease);
                
                // å¦‚æœç‡ƒæ–™è€—å°½ï¼Œç¯ç«ç†„ç­
                if (gameData.resources.fire.fuel <= 0) {
                    // è®°å½•è€ä¹…åº¦
                    const durability = gameData.resources.fire.durability;
                    // ç§»é™¤ç¯ç«
                    // ç‡ƒæ–™è€—å°½ï¼Œç¯ç«ç†„ç­
                    gameData.resources.fire.fuel = 0;

                    showNotification('ç¯ç«ç†„ç­', 'ä½ çš„ç¯ç«ç‡ƒæ–™å·²ç»è€—å°½ï¼Œç¯ç«ç†„ç­äº†ã€‚');
                }
            }
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
            checkGameOver();

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateGameData();

            // æ›´æ–°èµ„æºæ˜¾ç¤ºï¼ˆå¦‚æœç¯ç«ç‡ƒæ–™æœ‰å˜åŒ–ï¼‰
            if (gameData.resources.fire && gameData.resources.fire.amount > 0) {
                renderResources();
            }
        }

        // å¢åŠ å¤©æ•°
        gameData.day++;

        // é‡ç½®æ—¶é—´ä¸ºè¾°æ—¶ 07:00
        gameData.currentHour = 7;
        gameData.currentMinute = 0;
        gameData.timeOfDay = updateTimeOfDay(7);

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©ã€ç¬¬6å¤©ã€ç¬¬10å¤©...ï¼‰
        // é‡ç½®é€šçŸ¥çŠ¶æ€ï¼Œä¸ºæ˜¾ç¤ºé€šçŸ¥åšå‡†å¤‡
        if (gameData.day >= 2 && (gameData.day - 2) % 4 === 0) {
            gameData.fastingDayClaimed = false;
            gameData.fastingDayNotified = false;
        }

        // é‡ç½®åœå¦çŠ¶æ€
        gameData.divinationDoneToday = false;

        // é‡ç½®è¡ŒåŠ¨ç‚¹ä¸ºæ»¡å€¼
        gameData.status.actionPoints = 20;

        // é‡ç½®è€ä¹ä¸å­¦ä¹ çŠ¶æ€
        gameData.learnedFromOldBeggarToday = false;

        // ç«‹å³åˆ·æ–°è¡ŒåŠ¨ç•Œé¢ï¼Œä½¿è€ä¹ä¸çŠ¶æ€æ¢å¤ç”Ÿæ•ˆ
        renderActions();

        // æ ¹æ®å½“å‰å¤©æ•°è®¡ç®—å­£èŠ‚å¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†å­£èŠ‚å˜åŒ–
        const previousSeason = calculateSeason(gameData.day - 1);
        gameData.season = calculateSeason(gameData.day);
        
        // å¦‚æœå­£èŠ‚å‘ç”Ÿå˜åŒ–ï¼Œæ˜¾ç¤ºé€šçŸ¥å¹¶é‡ç½®æ–°å­£èŠ‚çš„ç»Ÿè®¡æ•°æ®
        if (previousSeason !== gameData.season) {
            // ç¡®ä¿å­£èŠ‚ç»Ÿè®¡æ•°æ®å­˜åœ¨
            if (!gameData.seasonWeatherStats) {
                gameData.seasonWeatherStats = {
                    spring: { rainyDays: 0, totalDays: 0 },
                    summer: { rainyDays: 0, totalDays: 0 },
                    autumn: { rainyDays: 0, totalDays: 0 },
                    winter: { snowyDays: 0, totalDays: 0 }
                };
            }
            
            // é‡ç½®æ–°å­£èŠ‚çš„ç»Ÿè®¡æ•°æ®
            if (!gameData.seasonWeatherStats[gameData.season]) {
                gameData.seasonWeatherStats[gameData.season] = { rainyDays: 0, totalDays: 0, snowyDays: 0 };
            } else {
                gameData.seasonWeatherStats[gameData.season].rainyDays = 0;
                gameData.seasonWeatherStats[gameData.season].snowyDays = 0;
                gameData.seasonWeatherStats[gameData.season].totalDays = 0;
            }
            
            // å®šä¹‰å­£èŠ‚åç§°æ˜ å°„ï¼ˆè‹±æ–‡åˆ°ä¸­æ–‡ï¼‰
            const seasonNames = {
                'spring': 'æ˜¥å­£',
                'summer': 'å¤å­£', 
                'autumn': 'ç§‹å­£',
                'winter': 'å†¬å­£'
            };
            showNotification(`å­£èŠ‚å˜æ›´ä¸º${seasonNames[gameData.season]}ï¼Œèµ„æºè·å–æ•ˆç‡å¯èƒ½ä¼šå˜åŒ–ã€‚`, 'info');
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        const dayNumberElement = document.getElementById('dayNumber');
        if (dayNumberElement) dayNumberElement.textContent = gameData.day;

        // æ›´æ–°å­£èŠ‚æ˜¾ç¤º
        updateGameData();
        
        // ç”Ÿæˆæ–°ä¸€å¤©çš„å¤©æ°”
        generateWeather();
        
        // å‡å°‘è£…å¤‡è€ä¹…åº¦
        decreaseItemDurability();

        // æ›´æ–°ç‰²å£æ å’Œé©¬å©çš„æ¯æ—¥çŠ¶æ€ï¼ˆé¥±é£Ÿåº¦ä¸‹é™ç­‰ï¼‰
        updateLivestockDaily();
        updateStableDaily();
        
        // æ›´æ–°å†œç”°çŠ¶æ€ï¼ˆå†œä½œç‰©ç”Ÿé•¿ã€æ¹¿æ¶¦åº¦å˜åŒ–ç­‰ï¼‰
        if (gameData.farmlandData && window.updateFarmlandDaily) {
          window.updateFarmlandDaily();
        }
        
        // æ›´æ–°å†œç”°æ˜¾ç¤º
        if (window.updateFarmlandDisplay) {
          window.updateFarmlandDisplay();
        }

        // æ›´æ–°æ—¶æ•ˆæ€§é£Ÿç‰©å’Œå†°çª–
        updatePerishableFood();
        updateIcehouse();

        // æ›´æ–°é£Ÿç‰©å€’è®¡æ—¶æ˜¾ç¤º
        updateAllExpiryTimers();

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©ã€ç¬¬6å¤©ã€ç¬¬10å¤©...ï¼‰
        // æ˜¾ç¤ºæ”¾æ–‹æ—¥é€šçŸ¥ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
        if (gameData.day >= 2 && (gameData.day - 2) % 4 === 0 && !gameData.fastingDayNotified) {
            showFastingDayModal();
            gameData.fastingDayNotified = true;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¢æˆ¿ä¸­
        const currentLocation = gameData.locations.find(loc => loc.currentLocation);
        if (currentLocation && currentLocation.id === 'prison') {
            // æ¯æ—¥å‡å°‘åˆ‘æœŸ
            currentLocation.sentenceDays = Math.max(0, currentLocation.sentenceDays - 1);

            // ç‰¢æˆ¿ä¸­çš„æƒ©ç½šï¼šå¥åº·å’Œç²¾ç¥å€¼å‡å°‘
            gameData.status.health = Math.max(0, gameData.status.health - 5);
            gameData.status.spirit = Math.max(0, gameData.status.spirit - 5);

            updateGameData();

            if (currentLocation.sentenceDays === 0) {
                showNotification('åˆ‘æœŸå·²æ»¡ï¼Œä½ è¢«é‡Šæ”¾äº†ï¼', 'success');
                // åˆ‡æ¢åˆ°ä¸œè¥¿å¸‚
                currentLocation.currentLocation = false;
                const streetLocation = gameData.locations.find(loc => loc.id === 'street');
                if (streetLocation) {
                    streetLocation.currentLocation = true;
                }
                renderLocations();
                renderActions();

                // æ˜¾ç¤ºåœºæ™¯åˆ‡æ¢çª—å£
                showLocationImageModal('ä¸œè¥¿å¸‚', 'UI/ä¸œè¥¿å¸‚.jpg', () => {
                  // åœºæ™¯åˆ‡æ¢çª—å£å…³é—­åæ˜¾ç¤ºè¿›å…¥é€šçŸ¥
                  showNotification('è¿›å…¥åœ°ç‚¹', 'ä½ è¿›å…¥äº†ä¸œè¥¿å¸‚ã€‚');
                });
            } else {
                showNotification(`ç‰¢ç‹±ç”Ÿæ´»è‰°è‹¦... å¥åº·å’Œç²¾ç¥éƒ½å—åˆ°äº†æŠ˜ç£¨ã€‚è¿˜éœ€æœåˆ‘${currentLocation.sentenceDays}å¤©ã€‚`, 'danger');
            }
        } else {
            // éç‰¢æˆ¿ç¯å¢ƒçš„æ¯æ—¥æ¶ˆè€—
            if (gameData.season === 'winter') {
                // å†¬å­£é¢å¤–æ¶ˆè€—
                gameData.status.health = Math.max(0, gameData.status.health - 3);
                checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
                showNotification('å¯’å†·çš„å†¬å­£ï¼Œå¥åº·å€¼æœ‰æ‰€ä¸‹é™ã€‚', 'warning');
            }
        }
        
        // æ£€æŸ¥ç‰²å£æ å’Œå†œç”°çš„æé†’
        checkAllAlerts();

        // æ˜¾ç¤ºè¿›å…¥æ–°ä¸€å¤©çš„é€šçŸ¥ï¼ˆæ”¾åœ¨æœ€åï¼Œç¡®ä¿ä¸è¢«è¦†ç›–ï¼‰
        // å·²åˆ é™¤"æ–°çš„ä¸€å¤©"é€šçŸ¥

        // å¤„ç†åŸºäºå¤©æ•°çš„BUFFï¼ˆå¹¸è¿å„¿ã€è¢«ç½©äº†ç­‰ï¼‰
        handleDailyBuffs();
    }

    // å¤„ç†åŸºäºå¤©æ•°çš„BUFF
    function handleDailyBuffs() {
      if (!gameData.buffs) return;

      const buffsToRemove = [];

      // éå†æ‰€æœ‰BUFF
      for (const [buffId, buff] of Object.entries(gameData.buffs)) {
        // åªå¤„ç†activeçš„BUFF
        if (buff && buff.active) {
          // å¦‚æœBUFFæœ‰dayså±æ€§ï¼Œå‡å°‘å¤©æ•°
          if (buff.days !== undefined && buff.days > 0) {
            buff.days--;
            // å¦‚æœå¤©æ•°å‡åˆ°0ï¼Œç§»é™¤BUFF
            if (buff.days <= 0) {
              buffsToRemove.push(buffId);
            }
          }
        }
      }

      // ç§»é™¤è¿‡æœŸçš„BUFF
      buffsToRemove.forEach(buffId => {
        const buff = gameData.buffs[buffId];
        gameData.buffs[buffId].active = false;
        delete gameData.buffs[buffId];
        showNotification('çŠ¶æ€æ¶ˆå¤±', `${buff.description || buffId}æ•ˆæœå·²ç»“æŸã€‚`);
      });
    }

    // æ›´æ–°æ—¶æ•ˆæ€§é£Ÿç‰©
    function updatePerishableFood() {
      // ä½¿ç”¨æ–°çš„æ‰¹æ¬¡ç³»ç»Ÿæ£€æŸ¥è¿‡æœŸ
      checkFoodExpiration();
    }

    // æ›´æ–°å†°çª–çŠ¶æ€
    function updateIcehouse() {
      if (!gameData.icehouse) {
        gameData.icehouse = {
          items: {},
          iceBlock: null
        };
      }

      // æ›´æ–°å†°å—å‰©ä½™å¤©æ•°
      if (gameData.icehouse.iceBlock && gameData.icehouse.iceBlock.remainingDays > 0) {
        gameData.icehouse.iceBlock.remainingDays--;

        // å¦‚æœå†°å—ç”¨å®Œï¼Œç§»é™¤å†°å—
        if (gameData.icehouse.iceBlock.remainingDays <= 0) {
          // åªç§»é™¤å†°çª–ä¸­çš„å†°å—ï¼Œä¸é‡å¤æ‰£é™¤èƒŒåŒ…ä¸­çš„å†°å—
          gameData.icehouse.iceBlock = null;
          showNotification('å†°å—å·²è€—å°½', 'å†°çª–ä¸­çš„å†°å—å·²è€—å°½ï¼Œä¿é²œåŠŸèƒ½å·²åœæ­¢ï¼', 'warning');
        }
      }

      // æ›´æ–°å†°çª–ä¸­é£Ÿç‰©çš„è¿‡æœŸæ—¶é—´
      for (const [resourceId, items] of Object.entries(gameData.icehouse.items)) {
        items.forEach(item => {
          if (gameData.icehouse.iceBlock && gameData.icehouse.iceBlock.remainingDays > 0) {
            // æœ‰å†°å—ï¼Œé£Ÿç‰©ä¸è…çƒ‚ï¼Œå»¶é•¿è¿‡æœŸæ—¶é—´
            item.expirationDay = gameData.day + item.originalExpirationDays;
          }
        });
      }

      // å¦‚æœå†°çª–çª—å£æ‰“å¼€ï¼Œæ›´æ–°æ˜¾ç¤º
      const icehouseModal = document.getElementById('icehouseModal');
      if (icehouseModal && icehouseModal.classList.contains('active')) {
        populateIcehouseModal();
      }
    }

    // è‡ªå®šä¹‰æ»šåŠ¨æ¡åŠŸèƒ½
    function initializeResourceScrollbar() {
        const resourceContainer = document.querySelector('.resource-container');
        const resourceGrid = document.getElementById('resourceGrid');
        const scrollbar = document.querySelector('.resource-scrollbar');
        const scrollbarThumb = document.querySelector('.resource-scrollbar-thumb');

        if (!resourceGrid || !scrollbar || !scrollbarThumb) return;

        // æ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        function updateScrollBar() {
            const maxScrollLeft = resourceGrid.scrollWidth - resourceGrid.clientWidth;
            const scrollPercent = resourceGrid.scrollLeft / maxScrollLeft;
            const thumbWidth = scrollbar.clientWidth * (resourceGrid.clientWidth / resourceGrid.scrollWidth);
            
            scrollbarThumb.style.width = `${thumbWidth}px`;
            scrollbarThumb.style.left = `${scrollPercent * (scrollbar.clientWidth - thumbWidth)}px`;
        }

        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        updateScrollBar();

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        resourceGrid.addEventListener('scroll', updateScrollBar);

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', updateScrollBar);

        // ç‚¹å‡»æ»šåŠ¨æ¡è½¨é“
        scrollbar.addEventListener('click', function(e) {
            const clickX = e.clientX - scrollbar.getBoundingClientRect().left;
            const scrollbarWidth = scrollbar.clientWidth;
            const thumbWidth = scrollbarThumb.clientWidth;
            
            const maxScrollLeft = resourceGrid.scrollWidth - resourceGrid.clientWidth;
            const scrollPercent = clickX / scrollbarWidth;
            
            resourceGrid.scrollLeft = scrollPercent * maxScrollLeft;
        });

        // æ‹–æ‹½æ»šåŠ¨æ¡æ‹‡æŒ‡
        let isScrollbarDragging = false; // æ»šåŠ¨æ¡æ‹–æ‹½çŠ¶æ€ï¼Œé¿å…ä¸å¡ç‰Œæ‹–æ‹½å†²çª
        let startX = 0;
        let startScrollLeft = 0;
        let startThumbLeft = 0;

        scrollbarThumb.addEventListener('mousedown', function(e) {
            isScrollbarDragging = true;
            startX = e.clientX;
            startScrollLeft = resourceGrid.scrollLeft;
            startThumbLeft = parseFloat(scrollbarThumb.style.left) || 0;
            
            // æ·»åŠ æ‹–æ‹½æ ·å¼
            scrollbarThumb.classList.add('dragging');
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isScrollbarDragging) return;
            
            const deltaX = e.clientX - startX;
            const scrollbarWidth = scrollbar.clientWidth;
            const thumbWidth = scrollbarThumb.clientWidth;
            const maxThumbLeft = scrollbarWidth - thumbWidth;
            const maxScrollLeft = resourceGrid.scrollWidth - resourceGrid.clientWidth;
            
            const newThumbLeft = Math.max(0, Math.min(maxThumbLeft, startThumbLeft + deltaX));
            const scrollPercent = newThumbLeft / maxThumbLeft;
            
            resourceGrid.scrollLeft = scrollPercent * maxScrollLeft;
        });

        document.addEventListener('mouseup', function() {
            if (!isScrollbarDragging) return;
            
            isScrollbarDragging = false;
            scrollbarThumb.classList.remove('dragging');
            document.body.style.userSelect = '';
        });
    }


    // é€šç”¨çš„è‡ªå®šä¹‰æ»šåŠ¨æ¡åˆå§‹åŒ–å‡½æ•°
    function initializeCustomScrollbar(containerSelector, scrollbarSelector, thumbSelector) {
        const container = document.querySelector(containerSelector);
        const scrollbar = document.querySelector(scrollbarSelector);
        const thumb = document.querySelector(thumbSelector);

        if (!container || !scrollbar || !thumb) return;

        // æ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        function updateScrollbar() {
            const maxScrollTop = container.scrollHeight - container.clientHeight;
            if (maxScrollTop <= 0) {
                thumb.style.height = '100%';
                thumb.style.top = '0';
                return;
            }
            const scrollPercent = container.scrollTop / maxScrollTop;
            const thumbHeight = scrollbar.clientHeight * (container.clientHeight / container.scrollHeight);
            
            thumb.style.height = `${thumbHeight}px`;
            thumb.style.top = `${scrollPercent * (scrollbar.clientHeight - thumbHeight)}px`;
        }

        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        updateScrollbar();

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        container.addEventListener('scroll', updateScrollbar);

        // ç‚¹å‡»æ»šåŠ¨æ¡è½¨é“
        scrollbar.addEventListener('click', function(e) {
            const clickY = e.clientY - scrollbar.getBoundingClientRect().top;
            const scrollbarHeight = scrollbar.clientHeight;
            const thumbHeight = thumb.clientHeight;
            
            const maxScrollTop = container.scrollHeight - container.clientHeight;
            const scrollPercent = clickY / scrollbarHeight;
            
            container.scrollTop = scrollPercent * maxScrollTop;
        });

        // æ‹–æ‹½æ»šåŠ¨æ¡æ‹‡æŒ‡
        let isDragging = false;
        let startY = 0;
        let startScrollTop = 0;
        let startThumbTop = 0;

        thumb.addEventListener('mousedown', function(e) {
            isDragging = true;
            startY = e.clientY;
            startScrollTop = container.scrollTop;
            startThumbTop = parseFloat(thumb.style.top) || 0;
            
            thumb.classList.add('dragging');
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaY = e.clientY - startY;
            const scrollbarHeight = scrollbar.clientHeight;
            const thumbHeight = thumb.clientHeight;
            const maxThumbTop = scrollbarHeight - thumbHeight;
            const maxScrollTop = container.scrollHeight - container.clientHeight;
            
            const newThumbTop = Math.max(0, Math.min(maxThumbTop, startThumbTop + deltaY));
            const scrollPercent = newThumbTop / maxThumbTop;
            
            container.scrollTop = scrollPercent * maxScrollTop;
        });

        document.addEventListener('mouseup', function() {
            if (!isDragging) return;

            isDragging = false;
            thumb.classList.remove('dragging');
            document.body.style.userSelect = '';
        });
    }


    // é€šç”¨çš„è‡ªå®šä¹‰æ»šåŠ¨æ¡åˆå§‹åŒ–å‡½æ•°ï¼ˆç›´æ¥ä½¿ç”¨å…ƒç´ å¯¹è±¡ï¼‰
    function initializeCustomScrollbarFromElements(container, scrollbar, thumb) {
        if (!container || !scrollbar || !thumb) return;

        // æ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        function updateScrollbar() {
            const maxScrollTop = container.scrollHeight - container.clientHeight;
            if (maxScrollTop <= 0) {
                thumb.style.height = '100%';
                thumb.style.top = '0';
                return;
            }
            const scrollPercent = container.scrollTop / maxScrollTop;
            const thumbHeight = scrollbar.clientHeight * (container.clientHeight / container.scrollHeight);

            thumb.style.height = `${thumbHeight}px`;
            thumb.style.top = `${scrollPercent * (scrollbar.clientHeight - thumbHeight)}px`;
        }

        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        updateScrollbar();

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        container.addEventListener('scroll', updateScrollbar);

        // ç‚¹å‡»æ»šåŠ¨æ¡è½¨é“
        scrollbar.addEventListener('click', function(e) {
            const clickY = e.clientY - scrollbar.getBoundingClientRect().top;
            const scrollbarHeight = scrollbar.clientHeight;
            const thumbHeight = thumb.clientHeight;

            const maxScrollTop = container.scrollHeight - container.clientHeight;
            const scrollPercent = clickY / scrollbarHeight;

            container.scrollTop = scrollPercent * maxScrollTop;
        });

        // æ‹–æ‹½æ»šåŠ¨æ¡æ‹‡æŒ‡
        let isDragging = false;
        let startY = 0;
        let startScrollTop = 0;
        let startThumbTop = 0;

        thumb.addEventListener('mousedown', function(e) {
            isDragging = true;
            startY = e.clientY;
            startScrollTop = container.scrollTop;
            startThumbTop = parseFloat(thumb.style.top) || 0;

            thumb.classList.add('dragging');
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;

            const deltaY = e.clientY - startY;
            const scrollbarHeight = scrollbar.clientHeight;
            const thumbHeight = thumb.clientHeight;
            const maxThumbTop = scrollbarHeight - thumbHeight;
            const maxScrollTop = container.scrollHeight - container.clientHeight;

            const newThumbTop = Math.max(0, Math.min(maxThumbTop, startThumbTop + deltaY));
            const scrollPercent = newThumbTop / maxThumbTop;

            container.scrollTop = scrollPercent * maxScrollTop;
        });

        document.addEventListener('mouseup', function() {
            if (!isDragging) return;

            isDragging = false;
            thumb.classList.remove('dragging');
            document.body.style.userSelect = '';
        });
    }

    // å½“çª—å£æ‰“å¼€æ—¶åˆå§‹åŒ–å¯¹åº”çš„æ»šåŠ¨æ¡
    window.initializeFarmlandScrollbars = function() {
        setTimeout(() => {
            const farmlandModal = document.getElementById('farmlandModal');
            if (!farmlandModal) return;

            const seedContainer = farmlandModal.querySelector('.crafting-inventory:not(.farmland-related-resources)');
            const relatedContainer = farmlandModal.querySelector('.farmland-related-resources');

            if (seedContainer && seedContainer.nextElementSibling && seedContainer.nextElementSibling.classList.contains('resource-scrollbar')) {
                const seedScrollbar = seedContainer.nextElementSibling;
                const seedThumb = seedScrollbar.querySelector('.resource-scrollbar-thumb');
                if (seedThumb) {
                    initializeCustomScrollbarFromElements(seedContainer, seedScrollbar, seedThumb);
                }
            }

            if (relatedContainer && relatedContainer.nextElementSibling && relatedContainer.nextElementSibling.classList.contains('resource-scrollbar')) {
                const relatedScrollbar = relatedContainer.nextElementSibling;
                const relatedThumb = relatedScrollbar.querySelector('.resource-scrollbar-thumb');
                if (relatedThumb) {
                    initializeCustomScrollbarFromElements(relatedContainer, relatedScrollbar, relatedThumb);
                }
            }
        }, 100);
    };
    
    window.initializeLivestockScrollbars = function() {
        setTimeout(() => {
            const livestockModal = document.getElementById('livestockModal');
            if (!livestockModal) return;

            const animalContainer = livestockModal.querySelector('#livestock-animal-container');
            const feedContainer = livestockModal.querySelector('#livestock-feed-container');

            if (animalContainer && animalContainer.nextElementSibling && animalContainer.nextElementSibling.classList.contains('resource-scrollbar')) {
                const animalScrollbar = animalContainer.nextElementSibling;
                const animalThumb = animalScrollbar.querySelector('.resource-scrollbar-thumb');
                if (animalThumb) {
                    initializeCustomScrollbarFromElements(animalContainer, animalScrollbar, animalThumb);
                }
            }

            if (feedContainer && feedContainer.nextElementSibling && feedContainer.nextElementSibling.classList.contains('resource-scrollbar')) {
                const feedScrollbar = feedContainer.nextElementSibling;
                const feedThumb = feedScrollbar.querySelector('.resource-scrollbar-thumb');
                if (feedThumb) {
                    initializeCustomScrollbarFromElements(feedContainer, feedScrollbar, feedThumb);
                }
            }
        }, 100);
    };

    window.initializeStableScrollbars = function() {
        setTimeout(() => {
            const stableModal = document.getElementById('stableModal');
            if (!stableModal) return;

            const horseContainer = stableModal.querySelector('#stable-horse-container');
            const feedContainers = stableModal.querySelectorAll('.stable-inventory');
            let feedContainer = null;
            if (feedContainers.length >= 2) {
                feedContainer = feedContainers[1];
            }

            if (horseContainer && horseContainer.nextElementSibling && horseContainer.nextElementSibling.classList.contains('resource-scrollbar')) {
                const horseScrollbar = horseContainer.nextElementSibling;
                const horseThumb = horseScrollbar.querySelector('.resource-scrollbar-thumb');
                if (horseThumb) {
                    initializeCustomScrollbarFromElements(horseContainer, horseScrollbar, horseThumb);
                }
            }

            if (feedContainer && feedContainer.nextElementSibling && feedContainer.nextElementSibling.classList.contains('resource-scrollbar')) {
                const feedScrollbar = feedContainer.nextElementSibling;
                const feedThumb = feedScrollbar.querySelector('.resource-scrollbar-thumb');
                if (feedThumb) {
                    initializeCustomScrollbarFromElements(feedContainer, feedScrollbar, feedThumb);
                }
            }
        }, 100);
    };

    // è¡ŒåŠ¨æ è‡ªå®šä¹‰æ»šåŠ¨æ¡åŠŸèƒ½
    let actionScrollbarInitialized = false;
    
    function initializeActionScrollbar() {
        const actionGrid = document.getElementById('actionGrid');
        const actionScrollbar = document.getElementById('actionScrollbar');
        const actionScrollbarThumb = document.getElementById('actionScrollbarThumb');

        if (!actionGrid || !actionScrollbar || !actionScrollbarThumb) {
            console.log('è¡ŒåŠ¨æ æ»šåŠ¨æ¡åˆå§‹åŒ–å¤±è´¥ï¼šæœªæ‰¾åˆ°å…ƒç´ ');
            return;
        }

        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œåªæ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        if (actionScrollbarInitialized) {
            updateActionScrollBar();
            return;
        }

        // æ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        function updateActionScrollBar() {
            const maxScrollLeft = actionGrid.scrollWidth - actionGrid.clientWidth;
            
            // å¦‚æœæ²¡æœ‰æ»šåŠ¨å†…å®¹ï¼Œéšè—æ»šåŠ¨æ¡
            if (maxScrollLeft <= 0) {
                actionScrollbar.style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºæ»šåŠ¨æ¡
            actionScrollbar.style.display = 'block';
            
            const scrollPercent = actionGrid.scrollLeft / maxScrollLeft;
            const thumbWidth = actionScrollbar.clientWidth * (actionGrid.clientWidth / actionGrid.scrollWidth);
            
            actionScrollbarThumb.style.width = `${thumbWidth}px`;
            actionScrollbarThumb.style.left = `${scrollPercent * (actionScrollbar.clientWidth - thumbWidth)}px`;
        }

        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        updateActionScrollBar();

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        actionGrid.addEventListener('scroll', updateActionScrollBar);

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', updateActionScrollBar);

        // ç‚¹å‡»æ»šåŠ¨æ¡è½¨é“
        actionScrollbar.addEventListener('click', function(e) {
            const clickX = e.clientX - actionScrollbar.getBoundingClientRect().left;
            const scrollbarWidth = actionScrollbar.clientWidth;
            const thumbWidth = actionScrollbarThumb.clientWidth;
            
            const maxScrollLeft = actionGrid.scrollWidth - actionGrid.clientWidth;
            const scrollPercent = clickX / scrollbarWidth;
            
            actionGrid.scrollLeft = scrollPercent * maxScrollLeft;
        });

        // æ‹–æ‹½æ»šåŠ¨æ¡æ‹‡æŒ‡
        let isActionScrollbarDragging = false;
        let startX = 0;
        let startScrollLeft = 0;
        let startThumbLeft = 0;

        actionScrollbarThumb.addEventListener('mousedown', function(e) {
            isActionScrollbarDragging = true;
            startX = e.clientX;
            startScrollLeft = actionGrid.scrollLeft;
            startThumbLeft = parseFloat(actionScrollbarThumb.style.left) || 0;
            
            // æ·»åŠ æ‹–æ‹½æ ·å¼
            actionScrollbarThumb.classList.add('dragging');
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isActionScrollbarDragging) return;
            
            const deltaX = e.clientX - startX;
            const scrollbarWidth = actionScrollbar.clientWidth;
            const thumbWidth = actionScrollbarThumb.clientWidth;
            const maxThumbLeft = scrollbarWidth - thumbWidth;
            const maxScrollLeft = actionGrid.scrollWidth - actionGrid.clientWidth;
            
            const newThumbLeft = Math.max(0, Math.min(maxThumbLeft, startThumbLeft + deltaX));
            const scrollPercent = newThumbLeft / maxThumbLeft;
            
            actionGrid.scrollLeft = scrollPercent * maxScrollLeft;
        });

        document.addEventListener('mouseup', function() {
            if (!isActionScrollbarDragging) return;
            
            isActionScrollbarDragging = false;
            actionScrollbarThumb.classList.remove('dragging');
            document.body.style.userSelect = '';
        });

        // é¼ æ ‡æ»šè½®äº‹ä»¶ç›‘å¬å™¨ï¼Œå°†å‚ç›´æ»šåŠ¨è½¬æ¢ä¸ºæ°´å¹³æ»šåŠ¨
        actionGrid.addEventListener('wheel', function(e) {
            // å¦‚æœæ­£åœ¨æ‹–æ‹½æ»šåŠ¨æ¡ï¼Œè®©æ‹–æ‹½äº‹ä»¶å¤„ç†
            if (isActionScrollbarDragging) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }

            e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º

            const container = actionGrid;
            const maxScrollLeft = container.scrollWidth - container.clientWidth;

            // æ ¹æ®æ»šè½®æ–¹å‘å†³å®šæ»šåŠ¨æ–¹å‘
            // å‘ä¸Šæ»šåŠ¨ï¼ˆe.deltaY < 0ï¼‰- å‘å·¦æ»šåŠ¨
            // å‘ä¸‹æ»šåŠ¨ï¼ˆe.deltaY > 0ï¼‰- å‘å³æ»šåŠ¨
            const scrollSpeed = 50; // æ»šåŠ¨é€Ÿåº¦
            
            // ç¡®ä¿maxScrollLeftæ˜¯æœ‰æ•ˆå€¼
            const validMaxScrollLeft = Math.max(0, maxScrollLeft);
            const newScrollLeft = e.deltaY < 0
                ? Math.max(0, container.scrollLeft - scrollSpeed)
                : Math.min(validMaxScrollLeft, container.scrollLeft + scrollSpeed);

            container.scrollLeft = newScrollLeft;

            // æ›´æ–°è‡ªå®šä¹‰æ»šåŠ¨æ¡ä½ç½®
            updateActionScrollBar();
        });

        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
        actionScrollbarInitialized = true;
    }

    // åœ°é¢çª—å£è‡ªå®šä¹‰æ»šåŠ¨æ¡åŠŸèƒ½
    let groundScrollbarInitialized = false;

    function initializeGroundScrollbar() {
        const groundGrid = document.getElementById('groundGrid');
        const groundScrollbar = document.getElementById('groundScrollbar');
        const groundScrollbarThumb = document.getElementById('groundScrollbarThumb');

        if (!groundGrid || !groundScrollbar || !groundScrollbarThumb) {
            console.log('åœ°é¢æ æ»šåŠ¨æ¡åˆå§‹åŒ–å¤±è´¥ï¼šæœªæ‰¾åˆ°å…ƒç´ ');
            return;
        }

        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œåªæ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        if (groundScrollbarInitialized) {
            updateGroundScrollBar();
            return;
        }

        // æ›´æ–°æ»šåŠ¨æ¡ä½ç½®
        function updateGroundScrollBar() {
            const maxScrollLeft = groundGrid.scrollWidth - groundGrid.clientWidth;

            // å¦‚æœæ²¡æœ‰æ»šåŠ¨å†…å®¹æˆ–å®¹å™¨å®½åº¦å¼‚å¸¸ï¼Œéšè—æ»šåŠ¨æ¡
            if (maxScrollLeft <= 0 || groundGrid.scrollWidth <= 0 || groundGrid.clientWidth <= 0) {
                groundScrollbar.style.display = 'none';
                return;
            }

            // æ˜¾ç¤ºæ»šåŠ¨æ¡
            groundScrollbar.style.display = 'block';

            const scrollPercent = groundGrid.scrollLeft / maxScrollLeft;
            const thumbWidth = Math.max(10, groundScrollbar.clientWidth * (groundGrid.clientWidth / groundGrid.scrollWidth));

            groundScrollbarThumb.style.width = `${thumbWidth}px`;
            groundScrollbarThumb.style.left = `${scrollPercent * (groundScrollbar.clientWidth - thumbWidth)}px`;
        }

        // åˆå§‹åŒ–æ»šåŠ¨æ¡
        updateGroundScrollBar();

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        groundGrid.addEventListener('scroll', updateGroundScrollBar);

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', updateGroundScrollBar);

        // ç‚¹å‡»æ»šåŠ¨æ¡è½¨é“
        groundScrollbar.addEventListener('click', function(e) {
            const clickX = e.clientX - groundScrollbar.getBoundingClientRect().left;
            const scrollbarWidth = groundScrollbar.clientWidth;
            const thumbWidth = groundScrollbarThumb.clientWidth;

            const maxScrollLeft = groundGrid.scrollWidth - groundGrid.clientWidth;
            const scrollPercent = clickX / scrollbarWidth;

            groundGrid.scrollLeft = scrollPercent * maxScrollLeft;
        });

        // æ‹–æ‹½æ»šåŠ¨æ¡æ‹‡æŒ‡
        let isGroundScrollbarDragging = false;
        let startX = 0;
        let startScrollLeft = 0;
        let startThumbLeft = 0;

        groundScrollbarThumb.addEventListener('mousedown', function(e) {
            isGroundScrollbarDragging = true;
            startX = e.clientX;
            startScrollLeft = groundGrid.scrollLeft;
            startThumbLeft = parseFloat(groundScrollbarThumb.style.left) || 0;

            // æ·»åŠ æ‹–æ‹½æ ·å¼
            groundScrollbarThumb.classList.add('dragging');
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isGroundScrollbarDragging) return;

            const deltaX = e.clientX - startX;
            const scrollbarWidth = groundScrollbar.clientWidth;
            const thumbWidth = groundScrollbarThumb.clientWidth;
            const maxThumbLeft = scrollbarWidth - thumbWidth;
            const maxScrollLeft = groundGrid.scrollWidth - groundGrid.clientWidth;

            const newThumbLeft = Math.max(0, Math.min(maxThumbLeft, startThumbLeft + deltaX));
            const scrollPercent = newThumbLeft / maxThumbLeft;

            groundGrid.scrollLeft = scrollPercent * maxScrollLeft;
        });

        document.addEventListener('mouseup', function() {
            if (!isGroundScrollbarDragging) return;

            isGroundScrollbarDragging = false;
            groundScrollbarThumb.classList.remove('dragging');
            document.body.style.userSelect = '';
        });

        // é¼ æ ‡æ»šè½®äº‹ä»¶ç›‘å¬å™¨ï¼Œå°†å‚ç›´æ»šåŠ¨è½¬æ¢ä¸ºæ°´å¹³æ»šåŠ¨
        groundGrid.addEventListener('wheel', function(e) {
            // å¦‚æœæ­£åœ¨æ‹–æ‹½æ»šåŠ¨æ¡ï¼Œè®©æ‹–æ‹½äº‹ä»¶å¤„ç†
            if (isGroundScrollbarDragging) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }

            e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢å½±å“å…¶ä»–å…ƒç´ 

            const container = groundGrid;
            const maxScrollLeft = container.scrollWidth - container.clientWidth;

            // æ ¹æ®æ»šè½®æ–¹å‘å†³å®šæ»šåŠ¨æ–¹å‘
            // å‘ä¸Šæ»šåŠ¨ï¼ˆe.deltaY < 0ï¼‰- å‘å·¦æ»šåŠ¨
            // å‘ä¸‹æ»šåŠ¨ï¼ˆe.deltaY > 0ï¼‰- å‘å³æ»šåŠ¨
            const scrollSpeed = 50; // æ»šåŠ¨é€Ÿåº¦
            
            // ç¡®ä¿maxScrollLeftæ˜¯æœ‰æ•ˆå€¼
            const validMaxScrollLeft = Math.max(0, maxScrollLeft);
            const newScrollLeft = e.deltaY < 0
                ? Math.max(0, container.scrollLeft - scrollSpeed)
                : Math.min(validMaxScrollLeft, container.scrollLeft + scrollSpeed);

            container.scrollLeft = newScrollLeft;

            // æ›´æ–°è‡ªå®šä¹‰æ»šåŠ¨æ¡ä½ç½®
            updateGroundScrollBar();
        });

        // åœ°é¢æ‹–æ‹½æ’åºå’Œè‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½
        let groundDraggedElement = null;
        let groundDragOverElement = null;
        let groundAutoScrollTimer = null;
        let groundIsDragging = false;

        // åœ°é¢æ è§¦æ‘¸æ‹–æ‹½å…¨å±€çŠ¶æ€å˜é‡
        window.groundTouchDragClone = null;
        window.groundTouchStartX = 0;
        window.groundTouchStartY = 0;
        window.groundIsTouchDragging = false;

        function groundStartAutoScroll(e) {
            // åªåœ¨æ‹–æ‹½å¡ç‰Œæ—¶æ‰è§¦å‘è‡ªåŠ¨æ»šåŠ¨
            if (!groundIsDragging) return;

            const container = groundGrid;
            if (!container) return;

            // ç¡®ä¿é¼ æ ‡åœ¨åœ°é¢æ å®¹å™¨å†…
            const containerRect = container.getBoundingClientRect();
            if (e.clientX < containerRect.left || e.clientX > containerRect.right ||
                e.clientY < containerRect.top || e.clientY > containerRect.bottom) {
                groundStopAutoScroll();
                return;
            }

            const mousePosX = e.clientX;

            // è¾¹ç•Œæ£€æµ‹å’Œè‡ªåŠ¨æ»šåŠ¨
            const scrollZoneWidth = 50; // è§¦å‘è‡ªåŠ¨æ»šåŠ¨çš„è¾¹ç•ŒåŒºåŸŸå®½åº¦
            const scrollSpeed = 15; // æ»šåŠ¨é€Ÿåº¦

            // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨å·¦è¾¹ç•Œ
            if (mousePosX < containerRect.left + scrollZoneWidth) {
                // å‘å·¦æ»šåŠ¨
                if (container.scrollLeft > 0) {
                    container.scrollLeft = Math.max(0, container.scrollLeft - scrollSpeed);
                    groundAutoScrollTimer = requestAnimationFrame(() => groundStartAutoScroll(e));
                } else {
                    groundStopAutoScroll();
                }
            }
            // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨å³è¾¹ç•Œ
            else if (mousePosX > containerRect.right - scrollZoneWidth) {
                // å‘å³æ»šåŠ¨
                const maxScrollLeft = container.scrollWidth - container.clientWidth;
                if (container.scrollLeft < maxScrollLeft) {
                    container.scrollLeft = Math.min(maxScrollLeft, container.scrollLeft + scrollSpeed);
                    groundAutoScrollTimer = requestAnimationFrame(() => groundStartAutoScroll(e));
                } else {
                    groundStopAutoScroll();
                }
            } else {
                // ä¸åœ¨è¾¹ç•ŒåŒºåŸŸï¼Œåœæ­¢è‡ªåŠ¨æ»šåŠ¨
                groundStopAutoScroll();
            }
        }

        function groundStopAutoScroll() {
            if (groundAutoScrollTimer) {
                cancelAnimationFrame(groundAutoScrollTimer);
                groundAutoScrollTimer = null;
            }
        }

        // ç›‘å¬dragoveräº‹ä»¶ï¼Œå®ç°è‡ªåŠ¨æ»šåŠ¨
        groundGrid.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            // æ£€æŸ¥æ‹–æ‹½æ¥æº
            const source = e.dataTransfer.getData('source');
            if (source !== 'backpack' && source !== '') {
                return;
            }

            // æ·»åŠ åœ°é¢æ é«˜äº®æ•ˆæœ
            elements.groundGrid.classList.add('drag-over-highlight');

            groundStartAutoScroll(e);
        });

        // ç›‘å¬dragleaveäº‹ä»¶ï¼Œåœæ­¢è‡ªåŠ¨æ»šåŠ¨
        groundGrid.addEventListener('dragleave', function(e) {
            // æ£€æŸ¥æ˜¯å¦çœŸæ­£ç¦»å¼€äº†groundGridå®¹å™¨ï¼ˆä¸æ˜¯ä»å­å…ƒç´ ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå­å…ƒç´ ï¼‰
            if (e.target === groundGrid && !groundGrid.contains(e.relatedTarget)) {
                // åœæ­¢åœ°é¢æ è‡ªåŠ¨æ»šåŠ¨
                groundStopAutoScroll();
                // åŒæ—¶ä¹Ÿåœæ­¢èƒŒåŒ…æ è‡ªåŠ¨æ»šåŠ¨ï¼ˆåŒé‡ä¿é™©ï¼‰
                if (typeof stopAutoScroll === 'function') {
                    stopAutoScroll();
                }

                // ç§»é™¤åœ°é¢æ é«˜äº®
                elements.groundGrid.classList.remove('drag-over-highlight');
            }
        });

        // ç›‘å¬dropäº‹ä»¶ï¼Œåœæ­¢è‡ªåŠ¨æ»šåŠ¨
        groundGrid.addEventListener('drop', function(e) {
            // åœæ­¢åœ°é¢æ è‡ªåŠ¨æ»šåŠ¨
            groundStopAutoScroll();
            // åŒæ—¶ä¹Ÿåœæ­¢èƒŒåŒ…æ è‡ªåŠ¨æ»šåŠ¨ï¼ˆåŒé‡ä¿é™©ï¼‰
            if (typeof stopAutoScroll === 'function') {
                stopAutoScroll();
            }
            // é‡ç½®èƒŒåŒ…æ çš„æ‹–æ‹½çŠ¶æ€
            if (typeof window.isDragging !== 'undefined') {
                window.isDragging = false;
            }

            // ç§»é™¤åœ°é¢æ é«˜äº®
            elements.groundGrid.classList.remove('drag-over-highlight');
        });

        // å…¨å±€mousemoveäº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨äºè‡ªåŠ¨æ»šåŠ¨
        document.addEventListener('mousemove', (e) => {
            if (groundIsDragging) {
                groundStartAutoScroll(e);
            }
        });

        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
        groundScrollbarInitialized = true;
    }

    // åœ°é¢æ‹–æ”¾åŠŸèƒ½ - æ¥æ”¶æ¥è‡ªèƒŒåŒ…çš„èµ„æº
    function initializeGroundDrop() {
        const groundGrid = elements.groundGrid;
        if (!groundGrid) return;

        groundGrid.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            // æ£€æŸ¥æ‹–æ‹½æ¥æº
            const source = e.dataTransfer.getData('source');
            if (source !== 'backpack' && source !== '') return;

            // æ£€æŸ¥æ‹–æ‹½æ—¶é•¿
            const dragDuration = Date.now() - (window.dragStartTime || 0);
            if (dragDuration < 500) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»å¯åŠ¨è¿ç»­ç§»åŠ¨
            if (window.isContinuousMoving) return;

            // è·å–èµ„æºID
            const resourceId = e.dataTransfer.getData('text/plain');
            if (!resourceId) return;

            // è·å–å½“å‰åœºæ™¯ID
            const currentLocation = gameData.locations.find(loc => loc.currentLocation);
            if (!currentLocation) return;
            const locationId = currentLocation.id;

            // åˆå§‹åŒ–å½“å‰åœºæ™¯çš„åœ°é¢èµ„æºæ•°ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!gameData.groundResources[locationId]) {
                gameData.groundResources[locationId] = [];
            }

            // å¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°åœ°é¢
            console.log('dragoverè§¦å‘ï¼Œæ‹–æ‹½æ—¶é•¿:', dragDuration, 'msï¼Œå¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°åœ°é¢');
            startContinuousMoveToGround(resourceId, locationId);
        });

        groundGrid.addEventListener('dragleave', function(e) {
            // æ£€æŸ¥æ˜¯å¦çœŸæ­£ç¦»å¼€äº†groundGridå®¹å™¨ï¼ˆä¸æ˜¯ä»å­å…ƒç´ ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå­å…ƒç´ ï¼‰
            if (e.target === groundGrid && !groundGrid.contains(e.relatedTarget)) {
                // çœŸæ­£ç¦»å¼€äº†å®¹å™¨ï¼Œåœæ­¢è¿ç»­ç§»åŠ¨
                if (window.isContinuousMoving) {
                    console.log('dragleaveè§¦å‘ï¼ˆçœŸæ­£ç¦»å¼€å®¹å™¨ï¼‰ï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
                    stopContinuousMove();
                }

                // ç§»é™¤åœ°é¢æ é«˜äº®
                groundGrid.classList.remove('drag-over-highlight');
            }
        });

        groundGrid.addEventListener('drop', function(e) {
            e.preventDefault();
            const resourceId = e.dataTransfer.getData('text/plain');
            const source = e.dataTransfer.getData('source');

            if (!resourceId) return;

            const resource = gameData.resources[resourceId];
            if (!resource || resource.amount <= 0) return;

            // æ£€æŸ¥æ¥æº
            if (source === 'ground') {
                // ä»åœ°é¢æ‹–æ‹½åˆ°åœ°é¢ï¼Œä¸å¤„ç†
                return;
            }

            // è·å–å½“å‰åœºæ™¯ID
            const currentLocation = gameData.locations.find(loc => loc.currentLocation);
            if (!currentLocation) return;
            const locationId = currentLocation.id;

            // åˆå§‹åŒ–å½“å‰åœºæ™¯çš„åœ°é¢èµ„æºæ•°ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!gameData.groundResources[locationId]) {
                gameData.groundResources[locationId] = [];
            }

            // ä»èƒŒåŒ…æ‹–æ‹½åˆ°åœ°é¢
            if (source === 'backpack' || !source) {
                // è®¡ç®—æ‹–æ‹½æ—¶é•¿
                const dragDuration = Date.now() - (window.dragStartTime || 0);
                console.log('dropè§¦å‘ï¼Œæ‹–æ‹½æ—¶é•¿:', dragDuration, 'ms, æ‹–æ‹½å¼€å§‹æ—¶é—´:', window.dragStartTime);

                // åªåœ¨æ‹–æ‹½æ—¶é•¿å°äº500msæ—¶æ‰å¤„ç†å•æ¬¡ç§»åŠ¨
                if (dragDuration < 500) {
                    // æ‹–æ‹½æ—¶é—´å°äº500msï¼Œç§»åŠ¨ä¸€å¼ 
                    console.log('æ‰§è¡Œå•æ¬¡ç§»åŠ¨åˆ°åœ°é¢');
                    moveOneToGround(resourceId, locationId);
                } else {
                    // æ‹–æ‹½æ—¶é—´å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­å¼€å§‹ï¼Œè¿™é‡Œä¸éœ€è¦åšä»»ä½•å¤„ç†
                    console.log('æ‹–æ‹½æ—¶é•¿å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­å¼€å§‹');
                }

                // åœæ­¢è¿ç»­ç§»åŠ¨
                stopContinuousMove();
            }

            // ç§»é™¤åœ°é¢æ é«˜äº®
            elements.groundGrid.classList.remove('drag-over-highlight');
        });
    }

    // æ›´æ–°èƒŒåŒ…å¡ç‰Œæ•°é‡æ˜¾ç¤º
    function updateResourceCardAmount(resourceId) {
        const resourceGrid = elements.resourceGrid;
        if (!resourceGrid) {
            console.log(`updateResourceCardAmount: resourceGridä¸å­˜åœ¨`);
            return;
        }

        // æ‰“å°æ‰€æœ‰èƒŒåŒ…å¡ç‰Œçš„data-resourceå±æ€§
        const allCards = resourceGrid.querySelectorAll('.resource-card');
        console.log(`updateResourceCardAmount: æ‰€æœ‰èƒŒåŒ…å¡ç‰Œçš„data-resource:`, Array.from(allCards).map(card => card.getAttribute('data-resource')));

        const card = resourceGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
        if (!card) {
            console.log(`updateResourceCardAmount: æœªæ‰¾åˆ°å¡ç‰Œ resourceId=${resourceId}`);
            return;
        }

        const amountBadge = card.querySelector('.amount-badge');
        if (amountBadge) {
            const resource = gameData.resources[resourceId];
            if (resource) {
                const oldText = amountBadge.textContent.trim();
                const newAmount = resource.amount;
                // å¼ºåˆ¶æ›´æ–°ä¸ºgameData.resourcesä¸­çš„æ•°é‡
                amountBadge.textContent = newAmount;
                console.log(`updateResourceCardAmount: æ›´æ–°å¡ç‰Œæ•°é‡ resourceId=${resourceId}, DOMæ˜¾ç¤º=${oldText}, æ•°æ®=${newAmount}, å¼ºåˆ¶æ›´æ–°ä¸º${newAmount}`);
                // æ›´æ–°æ—¶æ•ˆæ€§å€’è®¡æ—¶
                updateExpiryTimer(card, resourceId);
            } else {
                console.log(`updateResourceCardAmount: èµ„æºæ•°æ®ä¸å­˜åœ¨ resourceId=${resourceId}`);
            }
        } else {
            console.log(`updateResourceCardAmount: amountBadgeä¸å­˜åœ¨`);
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„å¡ç‰Œï¼Œå¦‚æœæœ‰åˆ™ç§»é™¤
        const allSameCards = resourceGrid.querySelectorAll(`.resource-card[data-resource="${resourceId}"]`);
        if (allSameCards.length > 1) {
            console.warn(`updateResourceCardAmount: å‘ç°${allSameCards.length}ä¸ª${resourceId}å¡ç‰Œï¼Œç§»é™¤é‡å¤çš„`);
            // ä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–çš„
            for (let i = 1; i < allSameCards.length; i++) {
                allSameCards[i].remove();
            }
            // æ›´æ–°ç¬¬ä¸€ä¸ªå¡ç‰Œçš„æ•°é‡
            const remainingCard = allSameCards[0];
            const amountBadge = remainingCard.querySelector('.amount-badge');
            if (amountBadge) {
                const resource = gameData.resources[resourceId];
                if (resource) {
                    amountBadge.textContent = resource.amount;
                }
            }
            // æ›´æ–°æ—¶æ•ˆæ€§å€’è®¡æ—¶
            updateExpiryTimer(remainingCard, resourceId);
        }
    }

    // ============ è½»é‡çº§é£Ÿç‰©æ—¶æ•ˆæ€§ç®¡ç†ç³»ç»Ÿ ============

    // æ·»åŠ é£Ÿç‰©å¹¶è®°å½•æ—¶æ•ˆæ€§ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function addFoodWithBatches(resourceId, amount) {
        if (!gameData.resources[resourceId]) {
            console.warn(`èµ„æº ${resourceId} ä¸å­˜åœ¨`);
            return;
        }

        const resource = gameData.resources[resourceId];
        if (!resource.isPerishable) {
            // éæ—¶æ•ˆæ€§é£Ÿç‰©ï¼Œç›´æ¥æ·»åŠ æ•°é‡
            resource.amount += amount;
            return;
        }

        // åˆå§‹åŒ–è½»é‡çº§æ—¶æ•ˆæ€§è¿½è¸ª
        if (!gameData.foodExpiry) {
            gameData.foodExpiry = {};
        }
        if (!gameData.foodExpiry[resourceId]) {
            gameData.foodExpiry[resourceId] = {
                totalAmount: 0,
                earliestExpiry: null,
                lastUpdateDay: gameData.day
            };
        }

        const currentExpiry = gameData.foodExpiry[resourceId];
        const expirationDays = resource.expirationDays || 1;
        const obtainTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
        const expirationTimeInMinutes = obtainTimeInMinutes + expirationDays * 24 * 60;

        // æ›´æ–°æ€»æ•°é‡
        currentExpiry.totalAmount += amount;
        resource.amount += amount;

        // æ›´æ–°æœ€æ—©è¿‡æœŸæ—¶é—´ï¼ˆåªä¿ç•™æœ€æ—©çš„è¿‡æœŸæ—¶é—´ï¼‰
        if (!currentExpiry.earliestExpiry || expirationTimeInMinutes < currentExpiry.earliestExpiry) {
            currentExpiry.earliestExpiry = expirationTimeInMinutes;
            currentExpiry.earliestDays = expirationDays;
            currentExpiry.obtainDay = gameData.day;
        }

        // è®°å½•æœ€åæ›´æ–°æ—¥æœŸï¼Œç”¨äºå®šæœŸæ¸…ç†
        currentExpiry.lastUpdateDay = gameData.day;
        
        console.log(`è½»é‡çº§æ·»åŠ é£Ÿç‰©: ${resource.name} +${amount}, å½“å‰æ€»æ•°: ${resource.amount}, æœ€æ—©è¿‡æœŸæ—¶é—´: ${new Date(currentExpiry.earliestExpiry * 60000).toLocaleString()}`);
    }

    // ä»æ—¶æ•ˆæ€§ç³»ç»Ÿä¸­æ¶ˆè€—é£Ÿç‰©ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function consumeFoodFromBatches(resourceId, amount) {
        if (!gameData.foodExpiry || !gameData.foodExpiry[resourceId]) {
            // æ²¡æœ‰æ—¶æ•ˆæ€§ä¿¡æ¯ï¼Œç›´æ¥ä»æ€»æ•°é‡æ‰£é™¤
            if (gameData.resources[resourceId]) {
                gameData.resources[resourceId].amount -= amount;
            }
            return;
        }

        const expiryInfo = gameData.foodExpiry[resourceId];
        
        // æ›´æ–°æ€»æ•°é‡
        expiryInfo.totalAmount = Math.max(0, expiryInfo.totalAmount - amount);
        
        // å¦‚æœæ•°é‡ä¸º0ï¼Œæ¸…ç©ºæ—¶æ•ˆæ€§ä¿¡æ¯
        if (expiryInfo.totalAmount <= 0) {
            delete gameData.foodExpiry[resourceId];
        }

        // æ›´æ–°èµ„æºæ€»æ•°é‡
        if (gameData.resources[resourceId]) {
            gameData.resources[resourceId].amount = Math.max(0, gameData.resources[resourceId].amount - amount);
        }
        
        console.log(`è½»é‡çº§æ¶ˆè€—é£Ÿç‰©: ${resourceId} -${amount}, å‰©ä½™æ•°é‡: ${expiryInfo.totalAmount || 0}`);
    }

    // è·å–é£Ÿç‰©çš„å‰©ä½™æ—¶æ•ˆæ—¶é—´ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function getEarliestExpiryTime(resourceId) {
        if (!gameData.foodExpiry || !gameData.foodExpiry[resourceId]) {
            return null;
        }

        const expiryInfo = gameData.foodExpiry[resourceId];
        
        // å¦‚æœæ²¡æœ‰æœ€æ—©è¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨é»˜è®¤æ—¶æ•ˆæœŸ
        if (!expiryInfo.earliestExpiry) {
            const resource = gameData.resources[resourceId];
            const expirationDays = resource?.expirationDays || 1;
            const currentTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
            const expirationTimeInMinutes = currentTimeInMinutes + expirationDays * 24 * 60;
            const remainingTimeInMinutes = expirationTimeInMinutes - currentTimeInMinutes;
            
            return {
                days: Math.floor(remainingTimeInMinutes / (24 * 60)),
                hours: Math.floor((remainingTimeInMinutes % (24 * 60)) / 60),
                minutes: remainingTimeInMinutes % 60,
                totalMinutes: remainingTimeInMinutes
            };
        }

        // è®¡ç®—å‰©ä½™æ—¶é—´
        const currentTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;
        const remainingTimeInMinutes = Math.max(0, expiryInfo.earliestExpiry - currentTimeInMinutes);
        
        return {
            days: Math.floor(remainingTimeInMinutes / (24 * 60)),
            hours: Math.floor((remainingTimeInMinutes % (24 * 60)) / 60),
            minutes: remainingTimeInMinutes % 60,
            totalMinutes: remainingTimeInMinutes
        };
    }

    // æ ¼å¼åŒ–å‰©ä½™æ—¶é—´æ˜¾ç¤º
    function formatRemainingTime(remainingTime) {
        if (!remainingTime) {
            return '0åˆ†';
        }

        // å¦‚æœå‰©ä½™æ—¶é—´å¤§äº24å°æ—¶ï¼Œæ˜¾ç¤ºå¤©
        if (remainingTime.totalMinutes >= 24 * 60) {
            return `${remainingTime.days}å¤©`;
        }
        // å¦‚æœå‰©ä½™æ—¶é—´å¤§äº60åˆ†é’Ÿï¼Œæ˜¾ç¤ºå°æ—¶
        if (remainingTime.totalMinutes >= 60) {
            return `${remainingTime.hours}å°æ—¶`;
        }
        // å¦åˆ™æ˜¾ç¤ºåˆ†é’Ÿ
        return `${remainingTime.minutes}åˆ†é’Ÿ`;
    }

    // æ£€æŸ¥æ‰€æœ‰é£Ÿç‰©æ˜¯å¦è¿‡æœŸï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function checkFoodExpiration() {
        let expiredFoods = [];
        let evaporatedIceBlocks = 0;

        if (!gameData.foodExpiry) return;

        // éå†è½»é‡çº§æ—¶æ•ˆæ€§ç³»ç»Ÿ
        for (const resourceId in gameData.foodExpiry) {
            const resource = gameData.resources[resourceId];
            if (!resource || !resource.isPerishable) continue;

            const expiryInfo = gameData.foodExpiry[resourceId];
            if (!expiryInfo.earliestExpiry) continue;

            // è®¡ç®—å½“å‰æ—¶é—´
            const currentTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;

            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if (currentTimeInMinutes >= expiryInfo.earliestExpiry) {
                const expiredAmount = expiryInfo.totalAmount;

                // æ£€æŸ¥æ˜¯å¦æ˜¯å†°å—
                if (resource.isIceBlock) {
                    // å†°å—ç›´æ¥è’¸å‘ï¼Œä¸è½¬æ¢ä¸ºè…çƒ‚ç‰©
                    evaporatedIceBlocks += expiredAmount;
                } else {
                    // å…¶ä»–é£Ÿç‰©è½¬æ¢ä¸ºè…çƒ‚ç‰©
                    expiredFoods.push({
                        resourceId: resourceId,
                        amount: expiredAmount
                    });

                    // æ·»åŠ è…çƒ‚ç‰©
                    if (gameData.resources.rotten_food) {
                        gameData.resources.rotten_food.amount += expiredAmount;
                        console.log(`è…çƒ‚ç‰©æ•°é‡å¢åŠ : ${expiredAmount}, å½“å‰è…çƒ‚ç‰©æ•°é‡: ${gameData.resources.rotten_food.amount}`);
                    } else {
                        console.warn('rotten_food èµ„æºä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ è…çƒ‚ç‰©');
                    }
                }

                // å‡å°‘èµ„æºæ•°é‡
                resource.amount -= expiredAmount;
                if (resource.amount < 0) resource.amount = 0;

                // æ¸…ç©ºæ—¶æ•ˆæ€§ä¿¡æ¯
                delete gameData.foodExpiry[resourceId];

                console.log(`é£Ÿç‰©è¿‡æœŸ: ${resource.name} ${expiredAmount}ä¸ª`);
            }
        }

        // æ„å»ºè¿‡æœŸé€šçŸ¥
        let notificationMessage = '';
        let hasExpired = false;

        // å¤„ç†å†°å—è’¸å‘
        if (evaporatedIceBlocks > 0) {
            notificationMessage += `${evaporatedIceBlocks}ä¸ªå†°å—å·²è’¸å‘æ¶ˆå¤±ã€‚`;
            hasExpired = true;
        }

        // å¤„ç†é£Ÿç‰©è¿‡æœŸ
        if (expiredFoods.length > 0) {
            if (hasExpired) {
                notificationMessage += '\n';
            }
            notificationMessage += 'éƒ¨åˆ†é£Ÿç‰©å·²è¿‡æœŸï¼Œå˜ä¸ºè…çƒ‚ç‰©ï¼š';
            let expiredCount = 0;
            for (const expired of expiredFoods) {
                const resource = gameData.resources[expired.resourceId];
                if (resource) {
                    expiredCount += expired.amount;
                    notificationMessage += `${resource.name} ${expired.amount}ä¸ªã€`;
                }
            }
            // ç§»é™¤æœ€åçš„é¡¿å·
            if (notificationMessage.endsWith('ã€')) {
                notificationMessage = notificationMessage.slice(0, -1);
            }
            notificationMessage += `ã€‚å…±${expiredCount}ä¸ªè¿‡æœŸé£Ÿç‰©å·²è½¬æ¢ä¸ºè…çƒ‚ç‰©ã€‚`;
            hasExpired = true;
        }

        // å¦‚æœæœ‰è¿‡æœŸæˆ–è’¸å‘ï¼Œæ˜¾ç¤ºé€šçŸ¥
        if (hasExpired) {
            // ä½¿ç”¨isCentralå‚æ•°ç¡®ä¿é€šçŸ¥æ˜¾ç¤º
            showNotification('é£Ÿç‰©å˜åŒ–', notificationMessage, true);

            // åˆ·æ–°UI
            renderResources();
        }
    }

    // æ›´æ–°å¡ç‰Œçš„æ—¶æ•ˆæ€§å€’è®¡æ—¶
    function updateExpiryTimer(card, resourceId) {
        const resource = gameData.resources[resourceId];
        if (!resource) return;

        let expiryTimer = card.querySelector('.expiry-timer');
        if (resource.isPerishable && resource.expirationDays && resource.amount > 0) {
            if (!expiryTimer) {
                // å¦‚æœæ²¡æœ‰è¿‡æœŸå€’è®¡æ—¶ï¼Œåˆ›å»ºæ–°çš„
                expiryTimer = document.createElement('div');
                expiryTimer.className = 'expiry-timer';
                card.appendChild(expiryTimer);
            }
            
            // ä½¿ç”¨æ‰¹æ¬¡ç³»ç»Ÿè·å–æœ€æ—©è¿‡æœŸçš„å‰©ä½™æ—¶é—´
            const remainingTime = getEarliestExpiryTime(resourceId);
            if (remainingTime) {
                expiryTimer.textContent = formatRemainingTime(remainingTime);
                
                // å¦‚æœå‰©ä½™æ—¶é—´å°äº60åˆ†é’Ÿï¼Œæ·»åŠ è­¦å‘Šæ ·å¼ï¼ˆçº¢è‰²å¾½ç« å¸¦è„‰å†²åŠ¨ç”»ï¼‰
                if (remainingTime.totalMinutes < 60) {
                    expiryTimer.classList.add('warning');
                } else {
                    expiryTimer.classList.remove('warning');
                }
            } else {
                expiryTimer.textContent = 'è¿‡æœŸ';
                expiryTimer.classList.add('warning');
            }
        } else if (expiryTimer) {
            // å¦‚æœä¸å†æœ‰æ—¶æ•ˆæ€§ï¼Œç§»é™¤è¿‡æœŸå€’è®¡æ—¶
            expiryTimer.remove();
        }
    }

    // æ›´æ–°æ‰€æœ‰æ—¶æ•ˆæ€§é£Ÿç‰©çš„å€’è®¡æ—¶
    function updateAllExpiryTimers() {
        const resourceCards = document.querySelectorAll('.resource-card');
        resourceCards.forEach(card => {
            const resourceId = card.getAttribute('data-resource');
            if (resourceId) {
                const resource = gameData.resources[resourceId];
                if (resource && resource.isPerishable && resource.expirationDays && resource.amount > 0) {
                    updateExpiryTimer(card, resourceId);
                }
            }
        });
    }

    // å¯åŠ¨æ—¶æ•ˆæ€§å€’è®¡æ—¶å®šæœŸæ›´æ–°å®šæ—¶å™¨
    function startExpiryTimerUpdate() {
        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        updateAllExpiryTimers();
        
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ‰€æœ‰æ—¶æ•ˆæ€§å€’è®¡æ—¶
        if (!window.expiryTimerInterval) {
            window.expiryTimerInterval = setInterval(() => {
                // æ£€æŸ¥æ‰€æœ‰é£Ÿç‰©æ˜¯å¦è¿‡æœŸå¹¶è½¬æ¢ä¸ºè…çƒ‚ç‰©
                checkFoodExpiration();
                // æ›´æ–°UIå€’è®¡æ—¶æ˜¾ç¤º
                updateAllExpiryTimers();
            }, 1000);
        }
    }

    // æ›´æ–°åœ°é¢å¡ç‰Œæ•°é‡æ˜¾ç¤º - å®Œå…¨å‚ç…§èƒŒåŒ…æ çš„å®ç°
    function updateGroundCardAmount(resourceId, locationId, groundIndex = null) {
        if (!gameData.groundResources[locationId]) {
            console.log(`updateGroundCardAmount: locationId=${locationId} çš„åœ°é¢èµ„æºä¸å­˜åœ¨`);
            return;
        }

        // å¦‚æœæ²¡æœ‰æä¾›groundIndexï¼Œåˆ™æŸ¥æ‰¾
        if (groundIndex === null) {
            groundIndex = gameData.groundResources[locationId].findIndex(item => item.resourceId === resourceId);
        }
        if (groundIndex === -1) {
            console.log(`updateGroundCardAmount: resourceId=${resourceId} åœ¨åœ°é¢èµ„æºä¸­ä¸å­˜åœ¨`);
            return;
        }

        const groundItem = gameData.groundResources[locationId][groundIndex];

        // ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„åœ°é¢å¡ç‰Œå¼•ç”¨
        if (window.draggedGroundCard && window.draggedGroundCard.parentNode) {
            const card = window.draggedGroundCard;
            const amountBadge = card.querySelector('.amount-badge');
            if (amountBadge) {
                const oldText = amountBadge.textContent;
                amountBadge.textContent = groundItem.amount;
                console.log(`updateGroundCardAmount: é€šè¿‡å¼•ç”¨æ›´æ–°åœ°é¢å¡ç‰Œæ•°é‡ resourceId=${resourceId}, ä» ${oldText} æ”¹ä¸º ${groundItem.amount}`);
            } else {
                console.log(`updateGroundCardAmount: amountBadgeä¸å­˜åœ¨`);
            }
            return;
        }

        // æ²¡æœ‰ä¿å­˜çš„å¼•ç”¨ï¼Œé€šè¿‡querySelectoræŸ¥æ‰¾
        const groundGrid = elements.groundGrid;
        if (!groundGrid) {
            console.log(`updateGroundCardAmount: groundGridä¸å­˜åœ¨`);
            return;
        }

        const card = groundGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
        if (!card) {
            console.log(`updateGroundCardAmount: æœªæ‰¾åˆ°åœ°é¢å¡ç‰Œ resourceId=${resourceId}`);
            return;
        }

        const amountBadge = card.querySelector('.amount-badge');
        if (amountBadge) {
            const oldText = amountBadge.textContent;
            amountBadge.textContent = groundItem.amount;
            console.log(`updateGroundCardAmount: æ›´æ–°åœ°é¢å¡ç‰Œæ•°é‡ resourceId=${resourceId}, ä» ${oldText} æ”¹ä¸º ${groundItem.amount}`);
        } else {
            console.log(`updateGroundCardAmount: amountBadgeä¸å­˜åœ¨`);
        }

        // æ›´æ–°æ—¶æ•ˆæ€§å€’è®¡æ—¶
        let expiryTimer = card.querySelector('.expiry-timer');
        if (groundItem.resource.isPerishable && groundItem.resource.expirationDays && groundItem.resource.amount > 0) {
            if (!expiryTimer) {
                // å¦‚æœæ²¡æœ‰è¿‡æœŸå€’è®¡æ—¶ï¼Œåˆ›å»ºæ–°çš„
                expiryTimer = document.createElement('div');
                expiryTimer.className = 'expiry-timer';
                card.appendChild(expiryTimer);
            }
            // ä½¿ç”¨æ‰¹æ¬¡ç³»ç»Ÿè·å–æœ€æ—©è¿‡æœŸçš„å‰©ä½™æ—¶é—´
            const remainingTime = getEarliestExpiryTime(resourceId);
            if (remainingTime) {
                expiryTimer.textContent = formatRemainingTime(remainingTime);
                // å¦‚æœå‰©ä½™æ—¶é—´å°äº60åˆ†é’Ÿï¼Œæ·»åŠ è­¦å‘Šæ ·å¼ï¼ˆçº¢è‰²å¾½ç« å¸¦è„‰å†²åŠ¨ç”»ï¼‰
                if (remainingTime.totalMinutes < 60) {
                    expiryTimer.classList.add('warning');
                } else {
                    expiryTimer.classList.remove('warning');
                }
            } else {
                expiryTimer.textContent = 'è¿‡æœŸ';
                expiryTimer.classList.add('warning');
            }
        } else if (expiryTimer) {
            // å¦‚æœä¸å†æœ‰æ—¶æ•ˆæ€§ï¼Œç§»é™¤è¿‡æœŸå€’è®¡æ—¶
            expiryTimer.remove();
        }
    }

    // å…¨å±€mouseupäº‹ä»¶ - ç”¨äºåœæ­¢è¿ç»­ç§»åŠ¨
    document.addEventListener('mouseup', function(e) {
        if (window.isContinuousMoving) {
            console.log('mouseupäº‹ä»¶è§¦å‘ï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
            stopContinuousMove();
        }
    });

    // åˆ›å»ºå½±å­å½’æ‹¢åŠ¨ç”» - ä»èƒŒåŒ…åˆ°åœ°é¢
    function createCardShadowMerge(sourceCard, targetCard) {
        console.log('åˆ›å»ºå½±å­åŠ¨ç”»ï¼šèƒŒåŒ…->åœ°é¢');
        if (!sourceCard || !targetCard) {
            console.log('å½±å­åŠ¨ç”»åˆ›å»ºå¤±è´¥ï¼šsourceCardæˆ–targetCardä¸å­˜åœ¨');
            return;
        }

        const sourceRect = sourceCard.getBoundingClientRect();
        const targetRect = targetCard.getBoundingClientRect();

        console.log('èµ·å§‹ä½ç½®:', sourceRect, 'ç›®æ ‡ä½ç½®:', targetRect);

        // è®¡ç®—ç›®æ ‡ä½ç½®çš„åç§»é‡
        const targetX = targetRect.left - sourceRect.left;
        const targetY = targetRect.top - sourceRect.top;

        // åˆ›å»ºå½±å­å…ƒç´ 
        const shadow = document.createElement('div');
        shadow.className = 'card-shadow-merge card resource-card';
        shadow.style.position = 'fixed';
        shadow.style.left = `${sourceRect.left}px`;
        shadow.style.top = `${sourceRect.top}px`;
        shadow.style.width = `${sourceRect.width}px`;
        shadow.style.height = `${sourceRect.height}px`;
        shadow.style.setProperty('--target-x', `${targetX}px`);
        shadow.style.setProperty('--target-y', `${targetY}px`);
        shadow.style.zIndex = '9999';
        shadow.style.pointerEvents = 'none';
        shadow.style.overflow = 'hidden';

        // å¤åˆ¶å¡ç‰Œçš„å†…å®¹
        shadow.innerHTML = sourceCard.innerHTML;
        shadow.style.border = sourceCard.style.border;
        shadow.style.borderRadius = sourceCard.style.borderRadius;
        shadow.style.boxShadow = sourceCard.style.boxShadow;
        shadow.style.background = sourceCard.style.background;

        document.body.appendChild(shadow);
        console.log('å½±å­å…ƒç´ å·²æ·»åŠ åˆ°DOM');

        // åŠ¨ç”»ç»“æŸåç§»é™¤å½±å­
        setTimeout(() => {
            if (shadow.parentNode) {
                shadow.parentNode.removeChild(shadow);
                console.log('å½±å­å…ƒç´ å·²ç§»é™¤');
            }
        }, 400);
    }

    // åˆ›å»ºå½±å­å½’æ‹¢åŠ¨ç”» - ä»åœ°é¢åˆ°èƒŒåŒ…
    function createGroundShadowMerge(sourceCard, targetCard) {
        console.log('åˆ›å»ºå½±å­åŠ¨ç”»ï¼šåœ°é¢->èƒŒåŒ…');
        if (!sourceCard || !targetCard) {
            console.log('å½±å­åŠ¨ç”»åˆ›å»ºå¤±è´¥ï¼šsourceCardæˆ–targetCardä¸å­˜åœ¨');
            return;
        }

        const sourceRect = sourceCard.getBoundingClientRect();
        const targetRect = targetCard.getBoundingClientRect();

        console.log('èµ·å§‹ä½ç½®:', sourceRect, 'ç›®æ ‡ä½ç½®:', targetRect);

        // è®¡ç®—ç›®æ ‡ä½ç½®çš„åç§»é‡
        const targetX = targetRect.left - sourceRect.left;
        const targetY = targetRect.top - sourceRect.top;

        // åˆ›å»ºå½±å­å…ƒç´ 
        const shadow = document.createElement('div');
        shadow.className = 'ground-shadow-merge card resource-card';
        shadow.style.position = 'fixed';
        shadow.style.left = `${sourceRect.left}px`;
        shadow.style.top = `${sourceRect.top}px`;
        shadow.style.width = `${sourceRect.width}px`;
        shadow.style.height = `${sourceRect.height}px`;
        shadow.style.setProperty('--target-x', `${targetX}px`);
        shadow.style.setProperty('--target-y', `${targetY}px`);
        shadow.style.zIndex = '9999';
        shadow.style.pointerEvents = 'none';
        shadow.style.overflow = 'hidden';

        // å¤åˆ¶å¡ç‰Œçš„å†…å®¹
        shadow.innerHTML = sourceCard.innerHTML;
        shadow.style.border = sourceCard.style.border;
        shadow.style.borderRadius = sourceCard.style.borderRadius;
        shadow.style.boxShadow = sourceCard.style.boxShadow;
        shadow.style.background = sourceCard.style.background;

        document.body.appendChild(shadow);
        console.log('å½±å­å…ƒç´ å·²æ·»åŠ åˆ°DOM');

        // åŠ¨ç”»ç»“æŸåç§»é™¤å½±å­
        setTimeout(() => {
            if (shadow.parentNode) {
                shadow.parentNode.removeChild(shadow);
                console.log('å½±å­å…ƒç´ å·²ç§»é™¤');
            }
        }, 400);
    }

    // ç›´æ¥å°†èµ„æºæ·»åŠ åˆ°åœ°é¢æ ï¼ˆç”¨äºè¡ŒåŠ¨è·å¾—èµ„æºæ—¶ï¼‰
    function addResourceToGround(resourceId, amount, locationId) {
        const resource = gameData.resources[resourceId];
        if (!resource) {
            console.warn(`èµ„æº ${resourceId} ä¸å­˜åœ¨`);
            return;
        }

        // ç¡®ä¿åœ°é¢èµ„æºæ•°ç»„å­˜åœ¨
        if (!gameData.groundResources[locationId]) {
            gameData.groundResources[locationId] = [];
        }

        // æ£€æŸ¥å½“å‰åœºæ™¯çš„åœ°é¢æ˜¯å¦å·²æœ‰è¯¥èµ„æº
        const existingGroundItem = gameData.groundResources[locationId].find(item => item.resourceId === resourceId);

        if (existingGroundItem) {
            // åœ°é¢å·²æœ‰è¯¥èµ„æºï¼Œå¢åŠ åœ°é¢æ•°é‡
            existingGroundItem.amount = (existingGroundItem.amount || 0) + amount;
            // æ›´æ–°resourceå¼•ç”¨ï¼Œé˜²æ­¢å®ƒå˜æˆundefined
            existingGroundItem.resource = resource;
        } else {
            // è®¡ç®—è·å¾—æ—¶é—´ï¼ˆç”¨äºæ—¶æ•ˆæ€§é£Ÿç‰©ï¼‰
            const currentTimeInMinutes = gameData.day * 24 * 60 + gameData.currentHour * 60 + gameData.currentMinute;

            // åœ°é¢æ²¡æœ‰è¯¥èµ„æºï¼Œåˆ›å»ºæ–°é¡¹
            gameData.groundResources[locationId].push({
                resourceId: resourceId,
                resource: resource,
                amount: amount,
                obtainTime: currentTimeInMinutes // è®°å½•è·å¾—æ—¶é—´
            });
        }

        // æ³¨æ„ï¼šè¿™é‡Œä¸æ·»åŠ åˆ°èƒŒåŒ…ï¼Œä¹Ÿä¸æ·»åŠ æ‰¹æ¬¡ä¿¡æ¯
        // æ‰¹æ¬¡ä¿¡æ¯ä¼šåœ¨ä»åœ°é¢æ‹–åˆ°èƒŒåŒ…æ—¶æ·»åŠ 

        // æ›´æ–°åœ°é¢æ æ˜¾ç¤º
        renderGroundResources();
    }

    // ç§»åŠ¨ä¸€å¼ èµ„æºåˆ°åœ°é¢
    function moveOneToGround(resourceId, locationId, showNotificationFlag = true) {
        const resource = gameData.resources[resourceId];
        if (!resource || resource.amount <= 0) return;

        // æ£€æŸ¥å½“å‰åœºæ™¯çš„åœ°é¢æ˜¯å¦å·²æœ‰è¯¥èµ„æº
        const existingGroundItem = gameData.groundResources[locationId].find(item => item.resourceId === resourceId);

        if (existingGroundItem) {
            // åœ°é¢å·²æœ‰è¯¥èµ„æºï¼Œå¢åŠ åœ°é¢æ•°é‡
            existingGroundItem.amount = (existingGroundItem.amount || 0) + 1;
            // æ›´æ–°resourceå¼•ç”¨ï¼Œé˜²æ­¢å®ƒå˜æˆundefined
            existingGroundItem.resource = resource;
        } else {
            // åœ°é¢æ²¡æœ‰è¯¥èµ„æºï¼Œåˆ›å»ºæ–°é¡¹
            gameData.groundResources[locationId].push({
                resourceId: resourceId,
                resource: resource,
                amount: 1
            });
        }

        // å‡å°‘èƒŒåŒ…ä¸­çš„æ•°é‡
        resource.amount--;

        // åªæœ‰åœ¨æŒ‡å®šæ—¶æ‰æ˜¾ç¤ºé€šçŸ¥
        // å·²åˆ é™¤æ‹–æ‹½é€šçŸ¥

        // å¦‚æœèµ„æºæ•°é‡é™ä¸º0ï¼Œç›´æ¥ä»DOMä¸­ç§»é™¤è¯¥å¡ç‰Œ
        if (resource.amount === 0) {
            const resourceGrid = elements.resourceGrid;
            if (resourceGrid) {
                const card = resourceGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
                if (card) {
                    // æ£€æŸ¥å¡ç‰Œæ˜¯å¦æ­£åœ¨è¢«æ‹–æ‹½ï¼ˆè§¦å±æ‹–æ‹½æˆ–æ¡Œé¢æ‹–æ‹½ï¼‰
                    // å¦‚æœæ­£åœ¨è¢«æ‹–æ‹½ï¼Œä¸è¦ç§»é™¤å®ƒï¼Œç­‰touchendæˆ–dragendæ—¶å†å¤„ç†
                    if (!card.classList.contains('dragging')) {
                        card.remove();
                    } else {
                        console.log('moveOneToGround: èƒŒåŒ…æ•°é‡ä¸º0ï¼Œä½†å¡ç‰Œæ­£åœ¨è¢«æ‹–æ‹½ï¼Œæš‚ä¸ç§»é™¤ï¼Œç­‰æ‹–æ‹½ç»“æŸæ—¶å†å¤„ç†');
                    }
                }
            }
        } else {
            // åªæ›´æ–°èƒŒåŒ…æ•°é‡æ˜¾ç¤ºï¼ˆç›´æ¥æ›´æ–°ï¼Œé¿å…è°ƒç”¨updateResourceCardAmountä»¥é˜²æ­¢é‡å¤æ£€æµ‹ï¼‰
            const resourceGrid = elements.resourceGrid;
            if (resourceGrid) {
                const card = resourceGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
                if (card) {
                    const amountBadge = card.querySelector('.amount-badge');
                    if (amountBadge) {
                        amountBadge.textContent = resource.amount;
                    }
                }
            }
        }

        // å…ˆæ£€æŸ¥DOMä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥åœ°é¢å¡ç‰Œï¼Œå¦‚æœå­˜åœ¨å°±ç›´æ¥æ›´æ–°æ•°é‡
        const groundGrid = elements.groundGrid;
        if (groundGrid) {
            const existingGroundCard = groundGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
            console.log(`moveOneToGround: æŸ¥è¯¢åœ°é¢å¡ç‰Œ resourceId=${resourceId}, existingGroundCard=${existingGroundCard ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}, isContinuousMoving=${window.isContinuousMoving}`);

            // å½“åœ°é¢å·²æœ‰å¡ç‰Œæ—¶ï¼Œåˆ›å»ºå½±å­å½’æ‹¢åŠ¨ç”»
            if (existingGroundCard && window.isContinuousMoving) {
                console.log('moveOneToGround: æ¡ä»¶æ»¡è¶³ï¼Œå‡†å¤‡åˆ›å»ºå½±å­åŠ¨ç”»');
                const backpackCard = elements.resourceGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
                console.log('moveOneToGround: backpackCard=', backpackCard ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                if (backpackCard) {
                    createCardShadowMerge(backpackCard, existingGroundCard);
                }
            }

            if (existingGroundCard) {
                // DOMä¸­å·²å­˜åœ¨è¯¥åœ°é¢å¡ç‰Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å¡ç‰Œ
                const allSameCards = groundGrid.querySelectorAll(`.resource-card[data-resource="${resourceId}"]`);
                if (allSameCards.length > 1) {
                    console.warn(`moveOneToGround: å‘ç°${allSameCards.length}ä¸ª${resourceId}åœ°é¢å¡ç‰Œï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–`);
                    // ç§»é™¤é‡å¤çš„å¡ç‰Œ
                    for (let i = 1; i < allSameCards.length; i++) {
                        allSameCards[i].remove();
                    }
                }

                // DOMä¸­å·²å­˜åœ¨è¯¥åœ°é¢å¡ç‰Œï¼Œç›´æ¥æ›´æ–°æ•°é‡æ˜¾ç¤ºï¼ˆä¼˜å…ˆä½¿ç”¨å¼•ç”¨ï¼‰
                console.log(`moveOneToGround: æ›´æ–°ç°æœ‰åœ°é¢å¡ç‰Œæ•°é‡ï¼ŒresourceId=${resourceId}, åœ°é¢æ•°é‡=${existingGroundItem.amount}`);
                // ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„åœ°é¢å¡ç‰Œå¼•ç”¨
                if (window.draggedGroundCard && window.draggedGroundCard.parentNode) {
                    const card = window.draggedGroundCard;
                    const amountBadge = card.querySelector('.amount-badge');
                    if (amountBadge) {
                        amountBadge.textContent = existingGroundItem.amount;
                    }
                } else {
                    const amountBadge = allSameCards[0].querySelector('.amount-badge');
                    if (amountBadge) {
                        amountBadge.textContent = existingGroundItem.amount;
                    }
                }
            } else {
                // DOMä¸­ä¸å­˜åœ¨è¯¥åœ°é¢å¡ç‰Œï¼Œéœ€è¦åˆ›å»ºæ–°å¡ç‰Œ
                console.log(`moveOneToGround: åˆ›å»ºæ–°åœ°é¢å¡ç‰Œï¼ŒresourceId=${resourceId}`);
                createAndAddGroundCard(resourceId, locationId);
            }
        } else {
            // groundGridä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»ºæ–°å¡ç‰Œ
            console.log(`moveOneToGround: groundGridä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åœ°é¢å¡ç‰Œï¼ŒresourceId=${resourceId}`);
            createAndAddGroundCard(resourceId, locationId);
        }

        updateGameData();
    }

    // å¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°åœ°é¢çš„å®šæ—¶å™¨
    function startContinuousMoveToGround(resourceId, locationId) {
        const resource = gameData.resources[resourceId];
        if (!resource || resource.amount <= 0) return;

        console.log('å¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°åœ°é¢å®šæ—¶å™¨ï¼Œèµ„æº:', resourceId, 'å‰©ä½™æ•°é‡:', resource.amount);

        // æ ‡è®°æ­£åœ¨è¿ç»­ç§»åŠ¨
        window.isContinuousMoving = true;
        window.continuousMoveTimer = setInterval(() => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœæ­¢è¿ç»­ç§»åŠ¨æˆ–èµ„æºå·²ç»ç”¨å®Œ
            if (!window.isContinuousMoving || !resource || resource.amount <= 0) {
                console.log('åœæ­¢è¿ç»­ç§»åŠ¨åˆ°åœ°é¢ï¼ŒisContinuousMoving:', window.isContinuousMoving, 'èµ„æºæ•°é‡:', resource ? resource.amount : 'undefined');
                stopContinuousMove();
                return;
            }

            // ç§»åŠ¨èµ„æºï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
            console.log('startContinuousMoveToGround: è°ƒç”¨moveOneToGroundï¼ŒresourceId=', resourceId, ', èƒŒåŒ…å‰©ä½™æ•°é‡=', resource.amount);
            moveOneToGround(resourceId, locationId, false);
        }, 100); // æ¯100msç§»åŠ¨ä¸€å¼ 
    }

    // åˆ›å»ºåœ°é¢å¡ç‰Œå¹¶æ·»åŠ åˆ°DOM
    function createAndAddGroundCard(resourceId, locationId) {
        if (!gameData.groundResources[locationId]) return;

        const groundItem = gameData.groundResources[locationId].find(item => item.resourceId === resourceId);
        if (!groundItem) return;

        // ç›´æ¥ä»gameData.resourcesè·å–èµ„æºï¼Œé¿å…ä½¿ç”¨å¯èƒ½å¤±æ•ˆçš„groundItem.resourceå¼•ç”¨
        const resource = gameData.resources[resourceId];
        const amount = groundItem.amount || 1;
        const groundGrid = elements.groundGrid;
        if (!groundGrid) return;

        // æ£€æŸ¥DOMä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥åœ°é¢å¡ç‰Œ
        const existingCard = groundGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
        console.log(`createAndAddGroundCard: æ£€æŸ¥åœ°é¢å¡ç‰Œï¼ŒresourceId=${resourceId}, existingCard=${existingCard ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
        if (existingCard) {
            console.log(`createAndAddGroundCard: DOMä¸­å·²å­˜åœ¨åœ°é¢å¡ç‰Œ ${resourceId}ï¼Œä¸åˆ›å»ºæ–°å¡ç‰Œï¼Œåªæ›´æ–°æ•°é‡`);

            // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å¡ç‰Œï¼Œå¦‚æœæœ‰å°±ç§»é™¤å¤šä½™çš„
            const allSameCards = groundGrid.querySelectorAll(`.resource-card[data-resource="${resourceId}"]`);
            if (allSameCards.length > 1) {
                console.warn(`createAndAddGroundCard: å‘ç°${allSameCards.length}ä¸ª${resourceId}åœ°é¢å¡ç‰Œï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–`);
                for (let i = 1; i < allSameCards.length; i++) {
                    allSameCards[i].remove();
                }
            }

            updateGroundCardAmount(resourceId, locationId);
            return;
        }

        // æœ¨æ¡¶å’Œæ°´è¢‹çš„å›¾ç‰‡å¤„ç†
        let displayImage = resource ? resource.image : '';
        let displayName = resource ? resource.name : resourceId;

        if (resourceId === 'bucket') {
            const waterLevel = getContainerTotalWater('bucket');
            if (waterLevel > 0) {
                displayImage = 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg';
            } else {
                displayImage = 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg';
            }
            displayName = 'æœ¨æ¡¶';
        } else if (resourceId === 'water_bag' || resourceId === 'empty_water_bag') {
            const waterLevel = getContainerTotalWater('water_bag');
            if (waterLevel > 0) {
                displayImage = 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
            } else {
                displayImage = 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
            }
            displayName = 'æ°´è¢‹';
        }

        // åˆ›å»ºå¡ç‰Œå…ƒç´ 
        const resourceCard = document.createElement('div');
        resourceCard.className = `card resource resource-card ${resource.pinned ? 'pinned' : ''}`;
        resourceCard.setAttribute('draggable', 'true');
        resourceCard.setAttribute('data-resource', resourceId);
        resourceCard.setAttribute('data-ground-index', gameData.groundResources[locationId].indexOf(groundItem));
        resourceCard.setAttribute('data-amount', amount);

        resourceCard.innerHTML = `
          <div class="card-content">
            <div class="card-title">${displayName}</div>
          </div>
          <div class="amount-badge" style="position: absolute; top: -10px; right: -8px; background-color: white; border: 2px solid #5D4037; border-radius: 12px; padding: 3px 8px; font-size: 0.75rem; font-weight: bold; color: #5D4037; min-width: 22px; text-align: center; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            ${amount}
          </div>
          <div class="card-image" style="background-image: url('${displayImage}'); background-size: cover; background-position: center; position: relative; height: 95px; width: 85px; margin: 0 auto; display: block; align-self: center;">
            <div class="image-fallback" style="display: none; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
            ${resource.durability !== undefined ? `
              <div class="card-durability" style="position: absolute; right: 4px; top: 34px; width: 4px; height: 45px; background-color: #E2E8F0; border-radius: 2px; overflow: hidden; z-index: 10;">
                <div class="durability-bar" style="width: 100%; height: ${resource.durability}%; background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'}; position: absolute; left: 0; bottom: 0; border-radius: 0 0 2px 2px; transition: height 0.3s ease;"></div>
              </div>
            ` : ''}
            <div class="pin-button ${resource.pinned ? 'pinned' : ''}" data-resource="${resourceId}" style="position: absolute; top: 4px; right: 4px; background-color: ${resource.pinned ? '#38A169' : '#CBD5E0'}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 100; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); pointer-events: auto; transition: all 0.2s ease; user-select: none;">
              ğŸ“Œ
            </div>
            ${resource.equipped ? `
              <div class="equipped-badge" style="position: absolute; bottom: 0.25rem; right: 0.25rem; background-color: #38A169; color: white; border-radius: 4px; padding: 0.1rem 0.3rem; font-size: 0.6rem; font-weight: normal; font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); z-index: 10;">
                å·²ç©¿æˆ´
              </div>
            ` : ''}
            ${resourceId === 'fire' ? `
              <div class="fuel-indicator" style="position: absolute; top: 0.25rem; left: 0.25rem; background-color: rgba(220, 38, 38, 0.9); color: white; border-radius: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.9rem; font-weight: bold;">
                ${resource.fuel || 0}%
              </div>
            ` : ''}
            ${resourceId === 'bucket' ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${(() => {
                  const waterLevel = getContainerTotalWater('bucket');
                  return Array.from({length: 5}, (_, i) => {
                    const isFilled = i >= (5 - Math.floor(waterLevel / 50));
                    return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                  }).join('');
                })()}
              </div>
            ` : ''}
            ${(resourceId === 'water_bag' || resourceId === 'empty_water_bag') ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${(() => {
                  const waterLevel = getContainerTotalWater('water_bag');
                  return Array.from({length: 5}, (_, i) => {
                    const isFilled = i >= (5 - Math.floor(waterLevel / 20));
                    return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                  }).join('');
                })()}
              </div>
            ` : ''}
          </div>
        `;

        // å›¾ç‰‡åŠ è½½å¤„ç†é€»è¾‘
        const cardImage = resourceCard.querySelector('.card-image');
        const fallback = resourceCard.querySelector('.image-fallback');
        const imgUrl = displayImage;

        // å°è¯•åŠ è½½å›¾ç‰‡
        const img = new Image();
        img.onload = function() {
          console.log(`åœ°é¢èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½æˆåŠŸ: ${imgUrl}`);
          if (fallback) fallback.style.display = 'none';
        };
        img.onerror = function() {
          console.log(`åœ°é¢èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½å¤±è´¥: ${imgUrl}`);
          if (fallback) fallback.style.display = 'flex';
        };
        img.src = imgUrl;

        // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
        resourceCard.addEventListener('dragstart', function(e) {
          const resourceId = this.getAttribute('data-resource');
          const resource = gameData.resources[resourceId];

          e.dataTransfer.setData('text/plain', resourceId);
          e.dataTransfer.effectAllowed = 'move';
          this.classList.add('dragging');
          groundIsDragging = true;

          e.dataTransfer.setData('source', 'ground');

          // åœæ­¢ä¹‹å‰çš„è¿ç»­ç§»åŠ¨ï¼ˆé¿å…çŠ¶æ€å†²çªï¼‰
          if (window.isContinuousMoving) {
            stopContinuousMove();
            console.log('åœ°é¢æ æ‹–æ‹½å¼€å§‹ï¼Œåœæ­¢ä¹‹å‰çš„è¿ç»­ç§»åŠ¨');
          }

          // è®°å½•æ‹–æ‹½å¼€å§‹æ—¶é—´
          window.dragStartTime = Date.now();
          window.dragResourceId = resourceId;
          window.dragSource = 'ground';
          // ä¿å­˜è¢«æ‹–æ‹½çš„åœ°é¢å¡ç‰Œå¼•ç”¨ï¼Œç”¨äºåœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­ç›´æ¥æ›´æ–°
          window.draggedGroundCard = this;
          console.log('åœ°é¢æ æ‹–æ‹½å¼€å§‹ï¼Œå¼€å§‹æ—¶é—´:', window.dragStartTime, 'èµ„æºID:', resourceId);
        });

        resourceCard.addEventListener('dragend', function(e) {
          console.log('åœ°é¢æ dragendè§¦å‘');
          this.classList.remove('dragging');
          groundIsDragging = false;

          // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
          if (typeof clearDragEffects === 'function') {
            clearDragEffects();
          }

          // ç§»é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
          if (elements.groundGrid) {
            elements.groundGrid.classList.remove('drag-over-highlight');
          }
          if (elements.resourceGrid) {
            elements.resourceGrid.classList.remove('drag-over-highlight');
          }

          // æ¸…ç†åœ°é¢æ çš„é‡å¤å¡ç‰Œ
          setTimeout(() => {
            const groundGrid = elements.groundGrid;
            if (groundGrid) {
              const allCards = groundGrid.querySelectorAll('.resource-card');
              const resourceIdMap = new Map();
              allCards.forEach(card => {
                const resourceId = card.getAttribute('data-resource');
                if (resourceIdMap.has(resourceId)) {
                  resourceIdMap.get(resourceId).push(card);
                } else {
                  resourceIdMap.set(resourceId, [card]);
                }
              });
              // ç§»é™¤é‡å¤çš„å¡ç‰Œ
              resourceIdMap.forEach((cards, resourceId) => {
                if (cards.length > 1) {
                  console.warn(`åœ°é¢æ dragend: å‘ç°${cards.length}ä¸ª${resourceId}åœ°é¢å¡ç‰Œï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–`);
                  for (let i = 1; i < cards.length; i++) {
                    cards[i].remove();
                  }
                }
              });
            }
          }, 50);

          // å»¶è¿Ÿæ¸…é™¤åœ°é¢å¡ç‰Œå¼•ç”¨ï¼Œç¡®ä¿æ‰€æœ‰æ›´æ–°æ“ä½œéƒ½å·²å®Œæˆ
          setTimeout(() => {
            window.draggedGroundCard = null;
            console.log('å»¶è¿Ÿæ¸…é™¤åœ°é¢å¡ç‰Œå¼•ç”¨');
          }, 100);

          // åœæ­¢è¿ç»­ç§»åŠ¨
          stopContinuousMove();
        });

        // æ·»åŠ å›¾é’‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const pinButton = resourceCard.querySelector('.pin-button');
        if (pinButton) {
            pinButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('åœ°é¢å¡ç‰Œå›¾é’‰æŒ‰é’®è¢«ç‚¹å‡»ï¼Œèµ„æºID:', resourceId);
                togglePinResource(resourceId);
                return false;
            }, true);
        }

        // æ·»åŠ åˆ°åœ°é¢ç½‘æ ¼
        groundGrid.appendChild(resourceCard);
    }

    // åœæ­¢è¿ç»­ç§»åŠ¨
    function stopContinuousMove() {
        if (window.isContinuousMoving) {
            console.log('åœæ­¢è¿ç»­ç§»åŠ¨');
        }
        if (window.continuousMoveTimer) {
            clearInterval(window.continuousMoveTimer);
            window.continuousMoveTimer = null;
        }
        window.isContinuousMoving = false;

        // æ¸…ç†æ‰€æœ‰æ‹–æ‹½å…‹éš†å…ƒç´ ï¼Œé˜²æ­¢å¡é¡¿
        if (window.groundTouchDragClone) {
            window.groundTouchDragClone.remove();
            window.groundTouchDragClone = null;
        }
        if (window.backpackTouchDragClone) {
            window.backpackTouchDragClone.remove();
            window.backpackTouchDragClone = null;
        }

        // ä¿®å¤BUGï¼šæ¸…ç†æ‰€æœ‰æ‹–æ‹½çŠ¶æ€ï¼Œé˜²æ­¢çŠ¶æ€æ®‹ç•™å¯¼è‡´åç»­æ‹–æ‹½å¼‚å¸¸
        window.isDragging = false;
        window.groundIsTouchDragging = false;
        window.backpackIsTouchDragging = false;
        window.dragResourceId = null;
        window.dragSource = null;
        window.dragStartTime = null;

        // ç§»é™¤æ‰€æœ‰å¡ç‰Œçš„ dragging ç±»
        const allDraggingCards = document.querySelectorAll('.resource-card.dragging');
        allDraggingCards.forEach(card => {
            card.classList.remove('dragging');
            card.enteredBackpackTime = null;
            card.enteredGroundTime = null;
        });

        // ç§»é™¤æ‰€æœ‰é«˜äº®
        if (elements.resourceGrid) {
            elements.resourceGrid.classList.remove('drag-over-highlight');
        }
        if (elements.groundGrid) {
            elements.groundGrid.classList.remove('drag-over-highlight');
        }

        // è¿ç»­æ‹–æ‹½ç»“æŸåï¼Œåˆ·æ–°èƒŒåŒ…å’Œåœ°é¢æ æ˜¾ç¤ºï¼Œç¡®ä¿æ‰€æœ‰å¡ç‰Œæ­£ç¡®æ˜¾ç¤º
        setTimeout(() => {
            renderResources();
            renderGroundResources();
        }, 100);
    }

    // èƒŒåŒ…æ‹–æ”¾åŠŸèƒ½ - æ¥æ”¶æ¥è‡ªåœ°é¢çš„èµ„æº
    function initializeResourceDropFromGround() {
        const resourceGrid = elements.resourceGrid;
        if (!resourceGrid) return;

        // ç§»é™¤ç°æœ‰çš„dragoveräº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤
        resourceGrid.removeEventListener('dragover', resourceGrid._groundDragOverHandler);

        resourceGrid._groundDragOverHandler = function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            // æ£€æŸ¥æ‹–æ‹½æ¥æº
            const source = e.dataTransfer.getData('source');
            if (source !== 'ground') {
                return;
            }

            // æ·»åŠ èƒŒåŒ…æ ç»¿è‰²é«˜äº®æ•ˆæœ
            resourceGrid.classList.add('drag-over-highlight', 'from-ground');

            // æ£€æŸ¥æ‹–æ‹½æ—¶é•¿
            const dragDuration = Date.now() - (window.dragStartTime || 0);
            if (dragDuration < 500) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»å¯åŠ¨è¿ç»­ç§»åŠ¨
            if (window.isContinuousMoving) return;

            // è·å–èµ„æºID
            const resourceId = e.dataTransfer.getData('text/plain');
            if (!resourceId) return;

            // è·å–å½“å‰åœºæ™¯ID
            const currentLocation = gameData.locations.find(loc => loc.currentLocation);
            if (!currentLocation) return;
            const locationId = currentLocation.id;

            console.log('dragover: locationId=', locationId, 'groundResources=', gameData.groundResources);

            // åˆå§‹åŒ–å½“å‰åœºæ™¯çš„åœ°é¢èµ„æºæ•°ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!gameData.groundResources[locationId]) {
                console.log('dragover: åˆå§‹åŒ–groundResources[', locationId, ']ä¸ºç©ºæ•°ç»„');
                gameData.groundResources[locationId] = [];
            }

            // å¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°èƒŒåŒ…
            console.log('dragoverè§¦å‘ï¼Œæ‹–æ‹½æ—¶é•¿:', dragDuration, 'msï¼Œå¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°èƒŒåŒ…');
            startContinuousMoveToBackpack(resourceId, locationId);
        };

        resourceGrid.addEventListener('dragover', resourceGrid._groundDragOverHandler);

        // æ·»åŠ dragleaveäº‹ä»¶
        resourceGrid.addEventListener('dragleave', function(e) {
            // æ£€æŸ¥æ˜¯å¦çœŸæ­£ç¦»å¼€äº†resourceGridå®¹å™¨ï¼ˆä¸æ˜¯ä»å­å…ƒç´ ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå­å…ƒç´ ï¼‰
            if (e.target === resourceGrid && !resourceGrid.contains(e.relatedTarget)) {
                // çœŸæ­£ç¦»å¼€äº†å®¹å™¨ï¼Œåœæ­¢è¿ç»­ç§»åŠ¨
                if (window.isContinuousMoving) {
                    console.log('dragleaveè§¦å‘ï¼ˆçœŸæ­£ç¦»å¼€å®¹å™¨ï¼‰ï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
                    stopContinuousMove();
                }

                // ç§»é™¤èƒŒåŒ…æ é«˜äº®
                resourceGrid.classList.remove('drag-over-highlight', 'from-ground');
            }
        });

        // ç§»é™¤ç°æœ‰çš„dropäº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤
        resourceGrid.removeEventListener('drop', resourceGrid._groundDropHandler);

        resourceGrid._groundDropHandler = function(e) {
            const source = e.dataTransfer.getData('source');

            // å¦‚æœä¸æ˜¯ä»åœ°é¢æ‹–æ‹½æ¥çš„ï¼Œä¸å¤„ç†
            if (source !== 'ground') return;

            e.preventDefault();

            const resourceId = e.dataTransfer.getData('text/plain');
            if (!resourceId) return;

            // è·å–å½“å‰åœºæ™¯ID
            const currentLocation = gameData.locations.find(loc => loc.currentLocation);
            if (!currentLocation) return;
            const locationId = currentLocation.id;

            // åˆå§‹åŒ–å½“å‰åœºæ™¯çš„åœ°é¢èµ„æºæ•°ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!gameData.groundResources[locationId]) {
                gameData.groundResources[locationId] = [];
            }

            // ä»åœ°é¢æ‹–æ‹½åˆ°èƒŒåŒ…ï¼Œè®¡ç®—æ‹–æ‹½æ—¶é•¿
            const dragDuration = Date.now() - (window.dragStartTime || 0);
            console.log('dropè§¦å‘ï¼Œæ‹–æ‹½æ—¶é•¿:', dragDuration, 'ms, æ‹–æ‹½å¼€å§‹æ—¶é—´:', window.dragStartTime);

            // åªåœ¨æ‹–æ‹½æ—¶é•¿å°äº500msæ—¶æ‰å¤„ç†å•æ¬¡ç§»åŠ¨
            if (dragDuration < 500) {
                // æ‹–æ‹½æ—¶é—´å°äº500msï¼Œç§»åŠ¨ä¸€å¼ 
                console.log('æ‰§è¡Œå•æ¬¡ç§»åŠ¨åˆ°èƒŒåŒ…');
                moveOneToBackpack(resourceId, locationId);
            } else {
                // æ‹–æ‹½æ—¶é—´å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­å¼€å§‹ï¼Œè¿™é‡Œä¸éœ€è¦åšä»»ä½•å¤„ç†
                console.log('æ‹–æ‹½æ—¶é•¿å¤§äº500msï¼Œè¿ç»­ç§»åŠ¨å·²ç»åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­å¼€å§‹');
            }

            // åœæ­¢è¿ç»­ç§»åŠ¨
            stopContinuousMove();

            // ç§»é™¤èƒŒåŒ…æ é«˜äº®
            resourceGrid.classList.remove('drag-over-highlight', 'from-ground');
        };

        resourceGrid.addEventListener('drop', resourceGrid._groundDropHandler);
    }

    // ç§»åŠ¨ä¸€å¼ èµ„æºåˆ°èƒŒåŒ…
    function moveOneToBackpack(resourceId, locationId, showNotificationFlag = true) {
        // æ£€æŸ¥èƒŒåŒ…æ æ˜¯å¦å·²è¾¾åˆ°5ç§å¡ç‰Œçš„é™åˆ¶
        const resourceGrid = elements.resourceGrid;
        if (resourceGrid) {
            const existingCards = resourceGrid.querySelectorAll('.resource-card');
            const existingResourceIds = new Set(Array.from(existingCards).map(card => card.getAttribute('data-resource')));
            
            // å¦‚æœè¯¥èµ„æºä¸åœ¨èƒŒåŒ…ä¸­ï¼Œä¸”èƒŒåŒ…å·²ç»æœ‰5ç§ä¸åŒçš„èµ„æºï¼Œåˆ™ä¸å…è®¸æ·»åŠ 
            if (!existingResourceIds.has(resourceId) && existingResourceIds.size >= 5) {
                if (showNotificationFlag) {
                    showNotification('èƒŒåŒ…å·²æ»¡', 'èƒŒåŒ…æ åªèƒ½æºå¸¦5ç§å¡ç‰Œï¼Œè¯·å…ˆæ¸…ç†ä¸€äº›ç©ºé—´ã€‚');
                }
                return;
            }
        }

        // é‡æ–°è·å–åœ°é¢ç´¢å¼•ï¼Œå› ä¸ºå¯èƒ½åœ¨è¿ç»­ç§»åŠ¨è¿‡ç¨‹ä¸­ç´¢å¼•å‘ç”Ÿå˜åŒ–
        const groundIndex = gameData.groundResources[locationId].findIndex(item => item.resourceId === resourceId);
        if (groundIndex === -1) {
            console.log(`moveOneToBackpack: æœªæ‰¾åˆ°åœ°é¢èµ„æº resourceId=${resourceId}`);
            return;
        }

        const groundItem = gameData.groundResources[locationId][groundIndex];
        console.log(`moveOneToBackpack: groundItemè¯¦æƒ…`, {
            resourceId: groundItem.resourceId,
            amount: groundItem.amount,
            resource: groundItem.resource ? groundItem.resource.id : 'undefined'
        });

        // ç›´æ¥ä»gameData.resourcesè·å–èµ„æºï¼Œé¿å…ä½¿ç”¨å¯èƒ½å¤±æ•ˆçš„groundItem.resourceå¼•ç”¨
        let resource = gameData.resources[resourceId];
        if (!resource) {
            console.error(`moveOneToBackpack: æ— æ³•æ‰¾åˆ°èµ„æº resourceId=${resourceId}`);
            return;
        }

        // æ‰“å°å½“å‰èƒŒåŒ…æ•°é‡ï¼ˆåœ¨å¢åŠ ä¹‹å‰ï¼‰
        console.log(`moveOneToBackpack: å¼€å§‹å¤„ç† resourceId=${resourceId}, èƒŒåŒ…å½“å‰æ•°é‡=${resource.amount}`);

        // å¢åŠ èƒŒåŒ…ä¸­çš„æ•°é‡
        const oldAmount = resource.amount;

        // å¦‚æœæ˜¯æ—¶æ•ˆæ€§é£Ÿç‰©ï¼Œä½¿ç”¨addFoodWithBatchesæ¥å¢åŠ æ•°é‡å’Œæ·»åŠ æ‰¹æ¬¡ä¿¡æ¯
        if (resource.isPerishable && resource.expirationDays) {
            addFoodWithBatches(resourceId, 1);
        } else {
            // éæ—¶æ•ˆæ€§é£Ÿç‰©ï¼Œç›´æ¥å¢åŠ æ•°é‡
            if (resource.amount === undefined || resource.amount === 0) {
                resource.amount = 1;
            } else {
                resource.amount++;
            }
        }

        // å‡å°‘åœ°é¢ä¸Šçš„æ•°é‡
        groundItem.amount--;

        console.log(`moveOneToBackpack: æ›´æ–°å resourceId=${resourceId}, èƒŒåŒ…æ–°æ•°é‡=${resource.amount}, åœ°é¢å‰©ä½™æ•°é‡=${groundItem.amount}`);

        // åªæœ‰åœ¨æŒ‡å®šæ—¶æ‰æ˜¾ç¤ºé€šçŸ¥
        // å·²åˆ é™¤æ‹–æ‹½é€šçŸ¥

        // æ£€æŸ¥åœ°é¢æ•°é‡æ˜¯å¦ä¸º0
        if (groundItem.amount <= 0) {
            // åœ°é¢æ•°é‡ä¸º0ï¼Œä»DOMä¸­ç§»é™¤è¯¥å¡ç‰Œ
            // å‚ç…§èƒŒåŒ…æ çš„å®ç°ï¼Œä½¿ç”¨data-resourceå±æ€§æŸ¥æ‰¾
            const groundGrid = elements.groundGrid;
            if (groundGrid) {
                const card = groundGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
                if (card) {
                    // æ£€æŸ¥å¡ç‰Œæ˜¯å¦æ­£åœ¨è¢«æ‹–æ‹½ï¼ˆè§¦å±æ‹–æ‹½æˆ–æ¡Œé¢æ‹–æ‹½ï¼‰
                    // å¦‚æœæ­£åœ¨è¢«æ‹–æ‹½ï¼Œä¸è¦ç§»é™¤å®ƒï¼Œç­‰touchendæˆ–dragendæ—¶å†å¤„ç†
                    if (!card.classList.contains('dragging')) {
                        card.remove();
                    } else {
                        console.log('moveOneToBackpack: åœ°é¢æ•°é‡ä¸º0ï¼Œä½†å¡ç‰Œæ­£åœ¨è¢«æ‹–æ‹½ï¼Œæš‚ä¸ç§»é™¤ï¼Œç­‰æ‹–æ‹½ç»“æŸæ—¶å†å¤„ç†');
                    }
                }
            }
            // ä»æ•°æ®ä¸­ç§»é™¤
            gameData.groundResources[locationId].splice(groundIndex, 1);

            // æ›´æ–°æ‰€æœ‰åç»­åœ°é¢å¡ç‰Œçš„data-ground-indexå±æ€§
            if (groundGrid) {
                const remainingCards = groundGrid.querySelectorAll('.resource-card[data-ground-index]');
                remainingCards.forEach((card) => {
                    const cardGroundIndex = parseInt(card.getAttribute('data-ground-index'));
                    if (cardGroundIndex > groundIndex) {
                        card.setAttribute('data-ground-index', cardGroundIndex - 1);
                    }
                });
            }
        } else {
            // åªæ›´æ–°åœ°é¢æ•°é‡æ˜¾ç¤ºï¼ˆç›´æ¥ä½¿ç”¨å¼•ç”¨ï¼Œé¿å…æ›´æ–°é”™è¯¯çš„å¡ç‰Œï¼‰
            if (window.draggedGroundCard && window.draggedGroundCard.parentNode) {
                const card = window.draggedGroundCard;
                const amountBadge = card.querySelector('.amount-badge');
                if (amountBadge) {
                    amountBadge.textContent = groundItem.amount;
                    console.log(`moveOneToBackpack: é€šè¿‡å¼•ç”¨æ›´æ–°åœ°é¢å¡ç‰Œæ•°é‡ resourceId=${resourceId}, æ–°æ•°é‡=${groundItem.amount}`);
                }
            } else {
                updateGroundCardAmount(resourceId, locationId);
            }
        }

        // æ£€æŸ¥DOMä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥å¡ç‰Œï¼Œå¦‚æœå­˜åœ¨å°±ç›´æ¥æ›´æ–°æ•°é‡
        if (resourceGrid) {
            // æ‰“å°å½“å‰æ‰€æœ‰èƒŒåŒ…å¡ç‰Œï¼Œç”¨äºè°ƒè¯•
            const allCards = resourceGrid.querySelectorAll('.resource-card');
            console.log(`moveOneToBackpack: æ‹–æ‹½æ£€æŸ¥å‰æ‰€æœ‰èƒŒåŒ…å¡ç‰Œ:`, Array.from(allCards).map(card => card.getAttribute('data-resource')));

            const existingCard = resourceGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
            console.log(`moveOneToBackpack: æŸ¥è¯¢èƒŒåŒ…å¡ç‰Œ resourceId=${resourceId}, existingCard=${existingCard ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}, isContinuousMoving=${window.isContinuousMoving}`);

            // å½“èƒŒåŒ…å·²æœ‰å¡ç‰Œæ—¶ï¼Œåˆ›å»ºå½±å­å½’æ‹¢åŠ¨ç”»
            if (existingCard && window.isContinuousMoving) {
                console.log('moveOneToBackpack: æ¡ä»¶æ»¡è¶³ï¼Œå‡†å¤‡åˆ›å»ºå½±å­åŠ¨ç”»');
                const groundCard = elements.groundGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);
                console.log('moveOneToBackpack: groundCard=', groundCard ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                if (groundCard) {
                    createGroundShadowMerge(groundCard, existingCard);
                }
            }

            if (existingCard) {
                // DOMä¸­å·²å­˜åœ¨è¯¥å¡ç‰Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å¡ç‰Œ
                const allSameCards = resourceGrid.querySelectorAll(`.resource-card[data-resource="${resourceId}"]`);
                if (allSameCards.length > 1) {
                    console.warn(`moveOneToBackpack: å‘ç°${allSameCards.length}ä¸ª${resourceId}å¡ç‰Œï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–`);
                    // ç§»é™¤é‡å¤çš„å¡ç‰Œ
                    for (let i = 1; i < allSameCards.length; i++) {
                        allSameCards[i].remove();
                    }
                }

                // æ›´æ–°ç¬¬ä¸€ä¸ªå¡ç‰Œçš„æ•°é‡æ˜¾ç¤º
                console.log(`moveOneToBackpack: æ›´æ–°ç°æœ‰å¡ç‰Œæ•°é‡ï¼ŒresourceId=${resourceId}, æ–°æ•°é‡=${resource.amount}`);
                const amountBadge = allSameCards[0].querySelector('.amount-badge');
                if (amountBadge) {
                    amountBadge.textContent = resource.amount;
                }
            } else {
                // DOMä¸­ä¸å­˜åœ¨è¯¥å¡ç‰Œï¼Œéœ€è¦åˆ›å»ºæ–°å¡ç‰Œ
                console.log(`moveOneToBackpack: åˆ›å»ºæ–°å¡ç‰Œï¼ŒresourceId=${resourceId}, oldAmount=${oldAmount}, å½“å‰amount=${resource.amount}`);
                createAndAddBackpackCard(resourceId);
            }
        } else {
            // resourceGridä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»ºæ–°å¡ç‰Œ
            console.log(`moveOneToBackpack: resourceGridä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å¡ç‰Œï¼ŒresourceId=${resourceId}`);
            createAndAddBackpackCard(resourceId);
        }

        updateGameData();
    }

    // åˆ›å»ºèƒŒåŒ…å¡ç‰Œå¹¶æ·»åŠ åˆ°DOM
    function createAndAddBackpackCard(resourceId) {
        const resource = gameData.resources[resourceId];
        if (!resource) {
            console.log(`createAndAddBackpack: èµ„æºä¸å­˜åœ¨ resourceId=${resourceId}`);
            return;
        }

        const resourceGrid = elements.resourceGrid;
        if (!resourceGrid) {
            console.log(`createAndAddBackpack: resourceGridä¸å­˜åœ¨`);
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¯¥å¡ç‰Œ
        const existingCard = resourceGrid.querySelector(`.resource-card[data-resource="${resourceId}"]`);

        // å¦‚æœæ­£åœ¨è¿ç»­æ‹–æ‹½ä¸”å¡ç‰Œå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºï¼ˆåªæ›´æ–°æ•°é‡ï¼‰
        if (window.isContinuousMoving && existingCard) {
            console.log(`createAndAddBackpack: æ­£åœ¨è¿ç»­ç§»åŠ¨ä¸”å¡ç‰Œå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º${resourceId}å¡ç‰Œ`);
            return;
        }

        // å¦‚æœå¡ç‰Œå·²å­˜åœ¨ï¼Œæ›´æ–°æ•°é‡
        if (existingCard) {
            console.log(`createAndAddBackpack: èƒŒåŒ…ä¸­å·²å­˜åœ¨${resourceId}å¡ç‰Œï¼Œè·³è¿‡åˆ›å»ºï¼Œåªæ›´æ–°æ•°é‡`);
            // æ›´æ–°æ‰€æœ‰é‡å¤å¡ç‰Œçš„æ•°é‡ï¼Œç„¶åç§»é™¤å¤šä½™çš„
            const allSameCards = resourceGrid.querySelectorAll(`.resource-card[data-resource="${resourceId}"]`);
            if (allSameCards.length > 1) {
                console.warn(`createAndAddBackpack: å‘ç°${allSameCards.length}ä¸ª${resourceId}å¡ç‰Œï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–`);
                for (let i = 1; i < allSameCards.length; i++) {
                    allSameCards[i].remove();
                }
            }
            // æ›´æ–°ç¬¬ä¸€ä¸ªå¡ç‰Œçš„æ•°é‡
            const amountBadge = allSameCards[0].querySelector('.amount-badge');
            if (amountBadge && resource) {
                amountBadge.textContent = resource.amount;
            }
            return;
        }

        // æ£€æŸ¥èµ„æºæ•°é‡æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯0åˆ™ä¸åˆ›å»º
        if (resource.amount === undefined || resource.amount <= 0) {
            console.log(`createAndAddBackpack: èµ„æº${resourceId}æ•°é‡ä¸º0æˆ–ä¸å­˜åœ¨ï¼Œä¸åˆ›å»ºå¡ç‰Œ`);
            return;
        }

        // å¤„ç†æœ¨æ¡¶å’Œæ°´è¢‹çš„å›¾ç‰‡å’Œåç§°
        let displayImage = resource.image;
        let displayName = resource.name;
        let actualResourceId = resourceId; // å®é™…ä½¿ç”¨çš„èµ„æºID

        // æ‰“å°å½“å‰æ‰€æœ‰èƒŒåŒ…å¡ç‰Œçš„data-resource
        const allBackpackCards = resourceGrid.querySelectorAll('.resource-card');
        const allDataResources = Array.from(allBackpackCards).map(card => card.getAttribute('data-resource'));
        console.log(`createAndAddBackpack: å½“å‰æ‰€æœ‰èƒŒåŒ…å¡ç‰Œçš„data-resource:`, allDataResources);

        // å¤„ç†è£…äº†æ°´çš„æœ¨æ¡¶/æ°´è¢‹
        if (resourceId === 'bucket_with_water' || resourceId === 'water_bag_with_water') {
            actualResourceId = resource.originalId;
            displayImage = resource.originalId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg';
            displayName = resource.originalId === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹';
        }
        // å¤„ç†æ²¡è£…æ°´çš„æœ¨æ¡¶/æ°´è¢‹
        else if (resourceId === 'empty_bucket' || resourceId === 'empty_water_bag') {
            actualResourceId = resource.originalId || resourceId.replace('empty_', '');
            displayImage = resource.originalId === 'bucket' || actualResourceId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg';
            displayName = resource.originalId === 'bucket' || actualResourceId === 'bucket' ? 'æœ¨æ¡¶' : 'æ°´è¢‹';
        }
        // å¤„ç†æ™®é€šæœ¨æ¡¶/æ°´è¢‹ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        else if (resourceId === 'bucket' || resourceId === 'water_bag') {
            if (resource.waterLevel !== undefined) {
                displayImage = resource.waterLevel > 0 ? (resource.originalId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆæ»¡ï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg') : (resource.originalId === 'bucket' ? 'UI/æœ¨æ¡¶ï¼ˆç©ºï¼‰.jpg' : 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg');
                displayName = resource.originalId === 'bucket' ? (resource.waterLevel > 0 ? 'æœ¨æ¡¶' : 'æœ¨æ¡¶') : (resource.waterLevel > 0 ? 'æ°´è¢‹' : 'æ°´è¢‹');
            }
        }

        // æ£€æŸ¥DOMä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå¡ç‰Œ
        const allSameCards = resourceGrid.querySelectorAll(`.resource-card[data-resource="${actualResourceId}"]`);
        console.log(`createAndAddBackpack: æ£€æŸ¥å¡ç‰Œï¼ŒresourceId=${resourceId}, actualResourceId=${actualResourceId}, æ‰¾åˆ°${allSameCards.length}ä¸ªç›¸åŒå¡ç‰Œ`);
        
        if (allSameCards.length > 0) {
            // å¦‚æœå­˜åœ¨ç›¸åŒå¡ç‰Œï¼Œæ‰“å°è¯¦ç»†ä¿¡æ¯å¹¶æ¸…ç†
            console.warn(`createAndAddBackpack: å‘ç°${allSameCards.length}ä¸ª${actualResourceId}å¡ç‰Œï¼Œå°†ä¿ç•™ç¬¬ä¸€ä¸ªå¹¶ç§»é™¤å…¶ä½™çš„`);
            
            // æ‰“å°æ‰€æœ‰å¡ç‰Œçš„å½“å‰æ˜¾ç¤ºæ•°é‡
            allSameCards.forEach((card, index) => {
                const badge = card.querySelector('.amount-badge');
                const text = badge ? badge.textContent.trim() : 'N/A';
                console.log(`  å¡ç‰Œ[${index}] æ˜¾ç¤ºæ•°é‡: ${text}`);
            });
            
            // ä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä»–çš„
            for (let i = 1; i < allSameCards.length; i++) {
                console.log(`createAndAddBackpack: ç§»é™¤é‡å¤å¡ç‰Œ[${i}]`);
                allSameCards[i].remove();
            }
            
            // æ›´æ–°ç¬¬ä¸€ä¸ªå¡ç‰Œçš„æ•°é‡ï¼ˆå¼ºåˆ¶ä½¿ç”¨gameData.resourcesä¸­çš„å€¼ï¼‰
            const firstCard = allSameCards[0];
            const amountBadge = firstCard.querySelector('.amount-badge');
            if (amountBadge && resource) {
                const oldText = amountBadge.textContent.trim();
                amountBadge.textContent = resource.amount;
                console.log(`createAndAddBackpack: æ›´æ–°ä¿ç•™å¡ç‰Œçš„æ•°é‡ ä» ${oldText} æ”¹ä¸º ${resource.amount}`);
            }
            
            // æ›´æ–°æ•°ç»„
            if (allBackpackCards) {
                const updatedAllCards = resourceGrid.querySelectorAll('.resource-card');
                const updatedDataResources = Array.from(updatedAllCards).map(card => card.getAttribute('data-resource'));
                console.log(`createAndAddBackpack: æ¸…ç†åèƒŒåŒ…å¡ç‰Œ:`, updatedDataResources);
            }
            
            return; // ä¸åˆ›å»ºæ–°å¡ç‰Œ
        }

        // åˆå§‹åŒ–å›ºå®šçŠ¶æ€
        if (resource.pinned === undefined) {
            resource.pinned = false;
        }

        // åˆ›å»ºå¡ç‰Œå…ƒç´ 
        const resourceCard = document.createElement('div');
        resourceCard.className = `card resource resource-card ${resource.pinned ? 'pinned' : ''}`;
        resourceCard.setAttribute('draggable', 'true');
        resourceCard.setAttribute('data-resource', actualResourceId);
        resourceCard.setAttribute('data-display-id', resourceId);

        resourceCard.innerHTML = `
          <div class="card-content">
            <div class="card-title">${displayName}</div>
          </div>
          <div class="amount-badge" style="position: absolute; top: -10px; right: -8px; background-color: white; border: 2px solid #5D4037; border-radius: 12px; padding: 3px 8px; font-size: 0.75rem; font-weight: bold; color: #5D4037; min-width: 22px; text-align: center; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            ${resource.amount}
          </div>
          <div class="card-image" style="background-image: url('${displayImage}'); background-size: cover; background-position: center; position: relative; height: 95px; width: 85px; margin: 0 auto; display: block; align-self: center;">
            <div class="image-fallback" style="display: none; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
            ${resource.durability !== undefined ? `
              <div class="card-durability" style="position: absolute; right: 4px; top: 34px; width: 4px; height: 45px; background-color: #E2E8F0; border-radius: 2px; overflow: hidden; z-index: 10;">
                <div class="durability-bar" style="width: 100%; height: ${resource.durability}%; background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'}; position: absolute; left: 0; bottom: 0; border-radius: 0 0 2px 2px; transition: height 0.3s ease;"></div>
              </div>
            ` : ''}
            <div class="pin-button ${resource.pinned ? 'pinned' : ''}" data-resource="${resourceId}" style="position: absolute; top: 4px; right: 4px; background-color: ${resource.pinned ? '#38A169' : '#CBD5E0'}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 100; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); pointer-events: auto; transition: all 0.2s ease; user-select: none;">
              ğŸ“Œ
            </div>
            ${resource.equipped ? `
              <div class="equipped-badge" style="position: absolute; bottom: 0.25rem; right: 0.25rem; background-color: #38A169; color: white; border-radius: 4px; padding: 0.1rem 0.3rem; font-size: 0.6rem; font-weight: normal; font-family: 'HuiWenMingChaoTi', 'FangSong', 'ä»¿å®‹', serif !important; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); z-index: 10;">
                å·²ç©¿æˆ´
              </div>
            ` : ''}
            ${resourceId === 'fire' ? `
              <div class="fuel-indicator" style="position: absolute; top: 0.25rem; left: 0.25rem; background-color: rgba(220, 38, 38, 0.9); color: white; border-radius: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.9rem; font-weight: bold;">
                ${resource.fuel || 0}%
              </div>
            ` : ''}
            ${((resourceId === 'bucket' || resourceId === 'bucket_with_water' || resourceId === 'empty_bucket') && resource.waterLevel !== undefined) ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${Array.from({length: 5}, (_, i) => {
                  const isFilled = i >= (5 - Math.floor((resource.waterLevel || 0) / 50));
                  return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                }).join('')}
              </div>
            ` : ''}
            ${((resourceId === 'water_bag' || resourceId === 'water_bag_with_water' || resourceId === 'empty_water_bag') && resource.waterLevel !== undefined) ? `
              <div class="water-level-indicator-backpack" style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 12px; height: 50px; display: flex; flex-direction: column; gap: 2px; z-index: 10;">
                ${Array.from({length: 5}, (_, i) => {
                  const isFilled = i >= (5 - Math.floor((resource.waterLevel || 0) / 20));
                  return `<div style="flex: 1; border: 1px solid #8B4513; background-color: ${isFilled ? '#3B82F6' : '#FFFFFF'}; border-radius: 2px; transition: background-color 0.3s ease;"></div>`;
                }).join('')}
              </div>
            ` : ''}
          </div>
        `;

        // å›¾ç‰‡åŠ è½½å¤„ç†é€»è¾‘
        const cardImage = resourceCard.querySelector('.card-image');
        const fallback = resourceCard.querySelector('.image-fallback');
        const imgUrl = displayImage;

        // ç›´æ¥è®¾ç½®èƒŒæ™¯å›¾ç‰‡
        cardImage.style.backgroundImage = `url('${imgUrl}')`;

        // å°è¯•åŠ è½½å›¾ç‰‡
        const img = new Image();
        img.onload = function() {
          console.log(`èƒŒåŒ…èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½æˆåŠŸ: ${imgUrl}`);
          if (fallback) fallback.style.display = 'none';
        };
        img.onerror = function() {
          console.log(`èƒŒåŒ…èµ„æº ${resource.name} å›¾ç‰‡åŠ è½½å¤±è´¥: ${imgUrl}`);
          if (fallback) fallback.style.display = 'flex';
        };
        img.src = imgUrl;

        // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
        resourceCard.addEventListener('dragstart', function(e) {
            const resourceId = this.getAttribute('data-resource');
            const resource = gameData.resources[resourceId];

            // æ£€æŸ¥å¡ç‰Œæ˜¯å¦è¢«å›ºå®š
            if (resource && resource.pinned) {
                e.preventDefault();
                showNotification('å¡ç‰Œå·²å›ºå®š', 'è¯¥å¡ç‰Œå·²è¢«å›ºå®šï¼Œæ— æ³•æ‹–æ‹½ç§»åŠ¨ã€‚');
                return;
            }

            e.dataTransfer.setData('text/plain', resourceId);
            e.dataTransfer.setData('source', 'backpack'); // è®¾ç½®æ¥æºä¸ºèƒŒåŒ…
            e.target.classList.add('dragging');
            // è®¾ç½®æ‹–æ‹½æ•ˆæœ
            e.dataTransfer.effectAllowed = 'move';

            // è®¾ç½®æ‹–æ‹½çŠ¶æ€
            window.isDragging = true;

            // è®°å½•æ‹–æ‹½å¼€å§‹æ—¶é—´
            window.dragStartTime = Date.now();
            window.dragResourceId = resourceId;
            window.dragSource = 'backpack';
            console.log('èƒŒåŒ…æ æ‹–æ‹½å¼€å§‹ï¼Œå¼€å§‹æ—¶é—´:', window.dragStartTime, 'èµ„æºID:', resourceId);
        });

        resourceCard.addEventListener('dragend', function(e) {
            console.log('èƒŒåŒ…æ dragendè§¦å‘');
            this.classList.remove('dragging');

            // æ¸…ç†æ‹–æ‹½ç‰¹æ•ˆï¼ˆåŒ…æ‹¬å…‰åœˆï¼‰
            if (typeof clearDragEffects === 'function') {
              clearDragEffects();
            }

            // åœæ­¢è¿ç»­ç§»åŠ¨
            stopContinuousMove();
        });

        // æ·»åŠ å›¾é’‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const pinButton = resourceCard.querySelector('.pin-button');
        if (pinButton) {
            pinButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('å›¾é’‰æŒ‰é’®è¢«ç‚¹å‡»ï¼Œèµ„æºID:', resourceId);
                togglePinResource(resourceId);
                return false;
            }, true);
        }

        // æ·»åŠ åˆ°èƒŒåŒ…ç½‘æ ¼
        resourceGrid.appendChild(resourceCard);

        // å¼ºåˆ¶æµè§ˆå™¨ç«‹å³æ¸²æŸ“æ–°å¡ç‰Œ
        if (resourceCard.style.display === 'none') {
            resourceCard.style.display = '';
        }
        resourceCard.style.visibility = 'visible';
        resourceCard.style.opacity = '1';
    }


    // å¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°èƒŒåŒ…çš„å®šæ—¶å™¨
    function startContinuousMoveToBackpack(resourceId, locationId) {
        console.log('å¯åŠ¨è¿ç»­ç§»åŠ¨åˆ°èƒŒåŒ…å®šæ—¶å™¨ï¼Œèµ„æº:', resourceId, 'locationId:', locationId);

        // æ£€æŸ¥groundResources
        if (!gameData.groundResources) {
            console.error('startContinuousMoveToBackpack: gameData.groundResourcesä¸å­˜åœ¨');
            return;
        }
        if (!gameData.groundResources[locationId]) {
            console.error('startContinuousMoveToBackpack: gameData.groundResources[locationId]ä¸å­˜åœ¨, locationId=', locationId);
            return;
        }

        // æ ‡è®°æ­£åœ¨è¿ç»­ç§»åŠ¨
        window.isContinuousMoving = true;
        window.continuousMoveTimer = setInterval(() => {
            console.log('å®šæ—¶å™¨å›è°ƒè§¦å‘ï¼ŒresourceId=', resourceId, 'locationId=', locationId);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœæ­¢è¿ç»­ç§»åŠ¨æˆ–åœ°é¢å·²ç»æ²¡æœ‰è¯¥èµ„æº
            const groundIndex = gameData.groundResources[locationId].findIndex(item => item.resourceId === resourceId);
            console.log('å®šæ—¶å™¨å›è°ƒï¼šgroundIndex=', groundIndex);
            if (!window.isContinuousMoving || groundIndex === -1) {
                console.log('åœæ­¢è¿ç»­ç§»åŠ¨åˆ°èƒŒåŒ…ï¼ŒisContinuousMoving:', window.isContinuousMoving, 'groundIndex:', groundIndex);
                stopContinuousMove();
                return;
            }

            const groundItem = gameData.groundResources[locationId][groundIndex];
            console.log('å®šæ—¶å™¨å›è°ƒï¼šgroundItem.amount=', groundItem.amount);
            
            // å¦‚æœåœ°é¢æ•°é‡<=0ï¼Œåœæ­¢ç§»åŠ¨
            if (groundItem.amount <= 0) {
                console.log('åœ°é¢èµ„æºæ•°é‡<=0ï¼Œåœæ­¢è¿ç»­ç§»åŠ¨');
                stopContinuousMove();
                return;
            }

            // ç§»åŠ¨èµ„æºï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
            console.log('startContinuousMoveToBackpack: è°ƒç”¨moveOneToBackpackï¼ŒresourceId=', resourceId, ', åœ°é¢å‰©ä½™æ•°é‡=', groundItem.amount);
            moveOneToBackpack(resourceId, locationId, false);
        }, 100); // æ¯100msç§»åŠ¨ä¸€å¼ 
    }
    
    // åªæ›´æ–°æ»šåŠ¨æ¡ä½ç½®ï¼Œä¸é‡å¤æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    function updateActionScrollBarIfNeeded() {
        if (!actionScrollbarInitialized) {
            initializeActionScrollbar();
        } else {
            const actionGrid = document.getElementById('actionGrid');
            const actionScrollbar = document.getElementById('actionScrollbar');
            const actionScrollbarThumb = document.getElementById('actionScrollbarThumb');
            
            if (actionGrid && actionScrollbar && actionScrollbarThumb) {
                const maxScrollLeft = actionGrid.scrollWidth - actionGrid.clientWidth;
                
                if (maxScrollLeft <= 0) {
                    actionScrollbar.style.display = 'none';
                    return;
                }
                
                actionScrollbar.style.display = 'block';
                
                const scrollPercent = actionGrid.scrollLeft / maxScrollLeft;
                const thumbWidth = actionScrollbar.clientWidth * (actionGrid.clientWidth / actionGrid.scrollWidth);
                
                actionScrollbarThumb.style.width = `${thumbWidth}px`;
                actionScrollbarThumb.style.left = `${scrollPercent * (actionScrollbar.clientWidth - thumbWidth)}px`;
            }
        }
    }

    // åªæ›´æ–°åœ°é¢æ æ»šåŠ¨æ¡ä½ç½®ï¼Œä¸é‡å¤æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    function updateGroundScrollBarIfNeeded() {
        if (!groundScrollbarInitialized) {
            initializeGroundScrollbar();
        } else {
            const groundGrid = document.getElementById('groundGrid');
            const groundScrollbar = document.getElementById('groundScrollbar');
            const groundScrollbarThumb = document.getElementById('groundScrollbarThumb');

            if (groundGrid && groundScrollbar && groundScrollbarThumb) {
                const maxScrollLeft = groundGrid.scrollWidth - groundGrid.clientWidth;

                // å¦‚æœæ²¡æœ‰æ»šåŠ¨å†…å®¹æˆ–å®¹å™¨å®½åº¦å¼‚å¸¸ï¼Œéšè—æ»šåŠ¨æ¡
                if (maxScrollLeft <= 0 || groundGrid.scrollWidth <= 0 || groundGrid.clientWidth <= 0) {
                    groundScrollbar.style.display = 'none';
                    return;
                }

                // æ˜¾ç¤ºæ»šåŠ¨æ¡
                groundScrollbar.style.display = 'block';

                const scrollPercent = groundGrid.scrollLeft / maxScrollLeft;
                const thumbWidth = Math.max(10, groundScrollbar.clientWidth * (groundGrid.clientWidth / groundGrid.scrollWidth));

                groundScrollbarThumb.style.width = `${thumbWidth}px`;
                groundScrollbarThumb.style.left = `${scrollPercent * (groundScrollbar.clientWidth - thumbWidth)}px`;
            }
        }
    }

    // å½“é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ä¸»é¡µæ»šåŠ¨æ¡
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initializeResourceScrollbar();
            // å»¶è¿Ÿåˆå§‹åŒ–è¡ŒåŠ¨æ æ»šåŠ¨æ¡ï¼Œç¡®ä¿è¡ŒåŠ¨å¡ç‰Œå®Œå…¨æ¸²æŸ“
            setTimeout(function() {
                initializeActionScrollbar();
            }, 100);
            // å»¶è¿Ÿåˆå§‹åŒ–åœ°é¢æ æ»šåŠ¨æ¡ï¼Œç¡®ä¿åœ°é¢å¡ç‰Œå®Œå…¨æ¸²æŸ“
            setTimeout(function() {
                initializeGroundScrollbar();
                initializeGroundDrop();
                initializeResourceDropFromGround();
            }, 150);
        });
    } else {
        initializeResourceScrollbar();
        // å»¶è¿Ÿåˆå§‹åŒ–è¡ŒåŠ¨æ æ»šåŠ¨æ¡ï¼Œç¡®ä¿è¡ŒåŠ¨å¡ç‰Œå®Œå…¨æ¸²æŸ“
        setTimeout(function() {
            initializeActionScrollbar();
        }, 100);
        // å»¶è¿Ÿåˆå§‹åŒ–åœ°é¢æ æ»šåŠ¨æ¡ï¼Œç¡®ä¿åœ°é¢å¡ç‰Œå®Œå…¨æ¸²æŸ“
        setTimeout(function() {
            initializeGroundScrollbar();
            initializeGroundDrop();
            initializeResourceDropFromGround();
        }, 150);
    }

  </script>
  
  <!-- æ·»åŠ å†œç”°äº¤äº’å¢å¼ºæ ·å¼ -->
  <style>
    /* è‡ªå®šä¹‰æ‹–æ‹½å…‰æ ‡æ ·å¼ */
    .seed-drag-cursor {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transition: transform 0.1s ease;
    }
    
    /* æ•°é‡æŒ‡ç¤ºå™¨æ ·å¼ */
    .seed-count-indicator {
      position: absolute;
      bottom: -5px;
      left: -5px;
      background-color: #E53E3E;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* ç§å­ä¸º0æ—¶çš„è„‰å†²åŠ¨ç”» */
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* å…‰æ ‡æ¶ˆå¤±åŠ¨ç”» */
    @keyframes fade-out {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    }
    
    /* æˆç†Ÿä½œç‰©çš„æ‚¬åœæ•ˆæœ */
    .farmland-cell.ready-for-harvest {
      cursor: pointer;
      position: relative;
      animation: gentle-sway 2s infinite ease-in-out;
    }
    
    /* è½»å¾®æ™ƒåŠ¨åŠ¨ç”» */
    @keyframes gentle-sway {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(1deg); }
      50% { transform: rotate(0deg); }
      75% { transform: rotate(-1deg); }
      100% { transform: rotate(0deg); }
    }
    
    /* æ”¶è·æ—¶çš„é«˜äº®æ•ˆæœ */
    .farmland-cell:hover.ready-for-harvest {
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.5), 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: scale(1.05);
    }
    
    /* æ‰‹å‹å…‰æ ‡æ ·å¼ */
    .harvest-cursor {
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%234CAF50"><path d="M12.5 5.5C11.67 5.5 11 6.17 11 7V11C11 11.55 10.55 12 10 12S9 11.55 9 11V7C9 6.17 8.33 5.5 7.5 5.5S6 6.17 6 7V12C6 13.1 6.9 14 8 14H9.5C10.33 14 11 13.33 11 12.5V12C11 13.1 10.1 14 9 14H8C6.9 14 6 13.1 6 12V7C6 6.17 5.33 5.5 4.5 5.5S3 6.17 3 7V12C3 14.21 4.79 16 7 16H11.5C13.43 16 15 14.43 15 12.5V7C15 6.17 14.33 5.5 13.5 5.5S12 6.17 12 7V11.5C12 11.78 12.22 12 12.5 12Z"/></svg>'), auto;
    }
    
    /* æ”¶è·æˆåŠŸåŠ¨ç”» */
    @keyframes harvest-success {
      0% { transform: scale(1) translateY(0); }
      50% { transform: scale(1.2) translateY(-10px); }
      100% { transform: scale(1) translateY(0); }
    }
    
    .harvest-success {
      animation: harvest-success 0.6s ease-out;
    }
  </style>

  <!-- å±±é‡é€‰é¡¹å¼¹çª—å’Œç ä¼åŠŸèƒ½ -->
  <script>
    // æ¢ç´¢åœ°å›¾çª—å£å‡½æ•° - é‡æ–°è®¾è®¡æ‘„åƒæœºè·Ÿéšç³»ç»Ÿ
    let explorationData = {
      character: null,
      weapon: null,
      background: null,
      isMoving: false,
      currentDirection: null,
      lastDirection: null, // è®°å½•æœ€åä½¿ç”¨çš„æ–¹å‘
      frameIndex: 0,
      animationInterval: null,
      moveSpeed: 80, // æ¯ç§’ç§»åŠ¨åƒç´ æ•°
      lastUpdateTime: 0,
      weaponRotation: 0, // æ­¦å™¨æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰
      weaponRotationSpeed: 50, // æ­¦å™¨æ—‹è½¬é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰
      weaponRadius: 100, // æ­¦å™¨æ—‹è½¬åŠå¾„
      keys: { w: false, a: false, s: false, d: false },
      characterWorldX: 600, // äººç‰©åœ¨ä¸–ç•Œåæ ‡ç³»çš„ä½ç½®ï¼ˆåœ°å›¾ä¸­å¿ƒ 1200/2ï¼‰
      characterWorldY: 400, // äººç‰©åœ¨ä¸–ç•Œåæ ‡ç³»çš„ä½ç½®ï¼ˆåœ°å›¾ä¸­å¿ƒ 800/2ï¼‰
      characterWidth: 100, // äººç‰©å®½åº¦ï¼ˆä¼°è®¡å€¼ï¼‰
      characterHeight: 300, // äººç‰©é«˜åº¦
      mapScale: 2, // åœ°å›¾æ”¾å¤§2å€
      mapWidth: 1200, // åœ°å›¾ä¸–ç•Œå®½åº¦
      mapHeight: 800, // åœ°å›¾ä¸–ç•Œé«˜åº¦
      actualMapWidth: 0, // åœ°å›¾å®é™…åƒç´ å®½åº¦ï¼ˆåŠ è½½åè·å–ï¼‰
      actualMapHeight: 0 // åœ°å›¾å®é™…åƒç´ é«˜åº¦ï¼ˆåŠ è½½åè·å–ï¼‰
    };

    function showExplorationModal() {
      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;

      // åˆ›å»ºåœ°å›¾å®¹å™¨ï¼ˆè§†å£ï¼‰- 1200x800åƒç´ 
      const mapContainer = document.createElement('div');
      mapContainer.style.cssText = `
        position: relative;
        width: 1200px;
        height: 800px;
        border-radius: 10px;
        overflow: hidden;
        background: #2a4a2a;
      `;

      // åˆ›å»ºåœ°å›¾èƒŒæ™¯å±‚ - åœ°å›¾æ”¾å¤§2å€æ˜¾ç¤º
      const mapBackground = document.createElement('div');
      mapBackground.style.cssText = `
        position: absolute;
        width: 2400px; /* 1200 * 2 */
        height: 1600px; /* 800 * 2 */
        background: url('æ¢ç´¢/åœ°å›¾/ç»¿åœ°.png') no-repeat center center;
        background-size: 2400px 1600px;
        transform-origin: center center;
      `;

      // è·å–åœ°å›¾å›¾ç‰‡çš„å®é™…å°ºå¯¸
      const mapImg = new Image();
      mapImg.src = 'æ¢ç´¢/åœ°å›¾/ç»¿åœ°.png';
      mapImg.onload = function() {
        explorationData.actualMapWidth = mapImg.width;
        explorationData.actualMapHeight = mapImg.height;
        
        // å¦‚æœå®é™…åœ°å›¾å°ºå¯¸ä¸é¢„è®¾ä¸åŒï¼Œè°ƒæ•´ä¸–ç•Œå°ºå¯¸å’ŒèƒŒæ™¯å±‚å°ºå¯¸
        if (explorationData.actualMapWidth !== 1200 || explorationData.actualMapHeight !== 800) {
          explorationData.mapWidth = explorationData.actualMapWidth;
          explorationData.mapHeight = explorationData.actualMapHeight;
          explorationData.characterWorldX = explorationData.mapWidth / 2;
          explorationData.characterWorldY = explorationData.mapHeight / 2;
          
          // æ›´æ–°èƒŒæ™¯å±‚å°ºå¯¸ä¸ºå®é™…åœ°å›¾å°ºå¯¸çš„2å€
          const scaledWidth = explorationData.mapWidth * explorationData.mapScale;
          const scaledHeight = explorationData.mapHeight * explorationData.mapScale;
          mapBackground.style.width = scaledWidth + 'px';
          mapBackground.style.height = scaledHeight + 'px';
          mapBackground.style.backgroundSize = scaledWidth + 'px ' + scaledHeight + 'px';
          
          // ç«‹å³æ›´æ–°æ‘„åƒæœºè§†å›¾ï¼Œç¡®ä¿åˆå§‹ç”»é¢æ­£ç¡®å±…ä¸­
          updateCameraView();
        }

        console.log('åœ°å›¾å®é™…å°ºå¯¸:', explorationData.actualMapWidth, 'x', explorationData.actualMapHeight);
        console.log('è§†å£å°ºå¯¸: 1200 x 800');
        console.log('ç¼©æ”¾æ¯”ä¾‹: 2');
      };

      // åˆ›å»ºäººç‰©å…ƒç´  - é«˜åº¦300px
      const character = document.createElement('img');
      character.src = 'æ¢ç´¢/æ­£é¢.png';
      character.style.cssText = `
        position: absolute;
        left: 50%; /* å±å¹•ä¸­å¿ƒ */
        top: 50%; /* å±å¹•ä¸­å¿ƒ */
        width: auto;
        height: auto;
        max-width: 100px;
        max-height: 300px;
        object-fit: contain; /* ä¿æŒæ¯”ä¾‹å®Œæ•´æ˜¾ç¤º */
        object-position: center; /* å›¾ç‰‡å†…å®¹å±…ä¸­ */
        z-index: 100;
        transition: none;
        transform-origin: center center;
        transform: translate(-50%, -50%) scale(2.5) translate(-2px, -7px); /* æ”¾å¤§2.5å€ï¼Œäººç‰©ç•¥å¾®ä¸Šç§» */
      `;
      character.id = 'exploration-character';

      // åˆ›å»ºæ­¦å™¨å…ƒç´  - ä½¿ç”¨æœ¨é”¤.png
      const weapon = document.createElement('img');
      weapon.src = 'æ¢ç´¢/æ­¦å™¨/æœ¨é”¤.png';
      weapon.style.cssText = `
        position: absolute;
        width: auto;
        height: 100px;
        z-index: 99;
        transition: none;
        transform-origin: center center;
        pointer-events: none;
        /* åˆå§‹ä½ç½®è®¾ç½®ä¸ºäººç‰©ä¸­å¿ƒ */
        left: 600px;
        top: 400px;
      `;
      weapon.id = 'exploration-weapon';

      // åˆ›å»ºæ§åˆ¶è¯´æ˜
      const controlInfo = document.createElement('div');
      controlInfo.style.cssText = `
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 15px;
        border-radius: 5px;
        font-size: 14px;
        z-index: 200;
      `;
      controlInfo.innerHTML = `
        <div><strong>æ§åˆ¶è¯´æ˜:</strong></div>
        <div>W - å‘ä¸Šç§»åŠ¨</div>
        <div>A - å‘å·¦ç§»åŠ¨</div>
        <div>S - å‘ä¸‹ç§»åŠ¨</div>
        <div>D - å‘å³ç§»åŠ¨</div>
        <div>ESC - å…³é—­çª—å£</div>
      `;

      // åˆ›å»ºå…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.textContent = 'å…³é—­';
      closeButton.style.cssText = `
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        z-index: 300;
      `;
      closeButton.onclick = closeExplorationModal;

      // ç»„è£…å…ƒç´ 
      mapContainer.appendChild(mapBackground);
      mapContainer.appendChild(character);
      mapContainer.appendChild(weapon);
      mapContainer.appendChild(controlInfo);
      mapContainer.appendChild(closeButton);
      modalContainer.appendChild(mapContainer);
      document.body.appendChild(modalContainer);

      // åˆå§‹åŒ–æ¢ç´¢æ•°æ®
      explorationData.character = character;
      explorationData.weapon = weapon;
      explorationData.background = mapBackground;
      explorationData.container = mapContainer;
      explorationData.modal = modalContainer;

      // åˆå§‹æ›´æ–°è§†å›¾
      updateCameraView();

      // è®¾ç½®é”®ç›˜äº‹ä»¶ç›‘å¬
      document.addEventListener('keydown', handleExplorationKeyDown);
      document.addEventListener('keyup', handleExplorationKeyUp);

      // å¯åŠ¨æ¸¸æˆå¾ªç¯
      requestAnimationFrame(gameLoop);
    }

    function handleExplorationKeyDown(event) {
      if (!explorationData.modal || !explorationData.modal.parentNode) return;

      const key = event.key.toLowerCase();
      if (['w', 'a', 's', 'd'].includes(key)) {
        explorationData.keys[key] = true;
        event.preventDefault();
      }

      if (key === 'escape') {
        closeExplorationModal();
      }
    }

    function handleExplorationKeyUp(event) {
      const key = event.key.toLowerCase();
      if (['w', 'a', 's', 'd'].includes(key)) {
        explorationData.keys[key] = false;
      }
    }

    // æ›´æ–°æ‘„åƒæœºè§†å›¾ - æ‘„åƒæœºè·Ÿéšç³»ç»Ÿ
    function updateCameraView() {
      const containerWidth = explorationData.container.offsetWidth; // 1200px
      const containerHeight = explorationData.container.offsetHeight; // 800px
      const mapWidth = explorationData.actualMapWidth || explorationData.mapWidth;
      const mapHeight = explorationData.actualMapHeight || explorationData.mapHeight;
      const scale = explorationData.mapScale; // 2å€

      // äººç‰©åœ¨å±å¹•ä¸Šçš„å›ºå®šä½ç½®ï¼ˆä¸­å¿ƒï¼‰
      const screenCharacterX = containerWidth / 2; // 600px
      const screenCharacterY = containerHeight / 2; // 400px

      // è®¡ç®—èƒŒæ™¯ä½ç½® - æ‘„åƒæœºè·Ÿéšç³»ç»Ÿ
      // èƒŒæ™¯éœ€è¦å‘ç›¸åæ–¹å‘ç§»åŠ¨ï¼Œä½¿äººç‰©ä¿æŒåœ¨è§†é‡ä¸­å¿ƒ
      // æ­£ç¡®çš„è®¡ç®—å…¬å¼ï¼šèƒŒæ™¯ä½ç½® = -äººç‰©ä¸–ç•Œåæ ‡ * ç¼©æ”¾æ¯”ä¾‹ + å±å¹•ä¸­å¿ƒä½ç½®
      let bgPositionX = -explorationData.characterWorldX * scale + screenCharacterX;
      let bgPositionY = -explorationData.characterWorldY * scale + screenCharacterY;

      // é™åˆ¶èƒŒæ™¯ä½ç½®ï¼Œä¸è®©èƒŒæ™¯è¶…å‡ºè§†å£
      // å½“äººç‰©æ¥è¿‘åœ°å›¾è¾¹ç¼˜æ—¶ï¼Œæ‘„åƒæœºä¼šè‡ªåŠ¨åœæ­¢
      const maxBgPositionX = 0;
      const maxBgPositionY = 0;
      const minBgPositionX = containerWidth - mapWidth * scale;
      const minBgPositionY = containerHeight - mapHeight * scale;

      bgPositionX = Math.max(minBgPositionX, Math.min(maxBgPositionX, bgPositionX));
      bgPositionY = Math.max(minBgPositionY, Math.min(maxBgPositionY, bgPositionY));

      // æ›´æ–°èƒŒæ™¯ä½ç½®
      explorationData.background.style.transform = `translate(${bgPositionX}px, ${bgPositionY}px)`;

      // äººç‰©å›ºå®šåœ¨å±å¹•ä¸­å¿ƒ
      explorationData.character.style.left = screenCharacterX + 'px';
      explorationData.character.style.top = screenCharacterY + 'px';
    }

    // æ›´æ–°æ­¦å™¨ä½ç½®å’Œæ—‹è½¬
    function updateWeaponPosition(deltaTime) {
      if (!explorationData.weapon) return;
      
      // æ›´æ–°æ­¦å™¨æ—‹è½¬è§’åº¦ï¼ˆæ¯ç§’50åº¦ï¼‰
      explorationData.weaponRotation += (explorationData.weaponRotationSpeed * deltaTime) / 1000;
      
      // ç¡®ä¿è§’åº¦åœ¨0-360åº¦èŒƒå›´å†…
      explorationData.weaponRotation = explorationData.weaponRotation % 360;
      
      // ç®€å•ç›´æ¥çš„æ–¹æ³•ï¼šä½¿ç”¨å›ºå®šçš„å±å¹•ä¸­å¿ƒç‚¹ä½œä¸ºäººç‰©ä¸­å¿ƒ
      const containerWidth = explorationData.container.offsetWidth; // 1200px
      const containerHeight = explorationData.container.offsetHeight; // 800px
      const characterCenterX = containerWidth / 2; // 600px
      const characterCenterY = containerHeight / 2; // 400px
      
      // å°†è§’åº¦è½¬æ¢ä¸ºå¼§åº¦
      const radian = (explorationData.weaponRotation * Math.PI) / 180;
      
      // è®¡ç®—æ­¦å™¨ç›¸å¯¹äºäººç‰©ä¸­å¿ƒçš„ä½ç½®
      const weaponOffsetX = Math.cos(radian) * explorationData.weaponRadius;
      const weaponOffsetY = Math.sin(radian) * explorationData.weaponRadius;
      
      // è®¡ç®—æ­¦å™¨çš„ä½ç½®ï¼Œä»¥äººç‰©ä¸­å¿ƒä¸ºåŸºå‡†
      const weaponX = characterCenterX + weaponOffsetX;
      const weaponY = characterCenterY + weaponOffsetY;
      
      // æ›´æ–°æ­¦å™¨ä½ç½®ï¼Œä½¿ç”¨ä¸äººç‰©ç›¸åŒçš„å±…ä¸­æ–¹å¼
      explorationData.weapon.style.left = weaponX + 'px';
      explorationData.weapon.style.top = weaponY + 'px';
      explorationData.weapon.style.transform = `translate(-50%, -50%) rotate(${explorationData.weaponRotation + 90}deg)`;
    }

    function gameLoop(timestamp) {
      if (!explorationData.modal || !explorationData.modal.parentNode) return;

      const deltaTime = timestamp - explorationData.lastUpdateTime;
      explorationData.lastUpdateTime = timestamp;

      let moving = false;
      let moveX = 0;
      let moveY = 0;

      // è®¡ç®—ç§»åŠ¨æ–¹å‘
      if (explorationData.keys.w) {
        moveY -= 1;
        moving = true;
      }
      if (explorationData.keys.s) {
        moveY += 1;
        moving = true;
      }
      if (explorationData.keys.a) {
        moveX -= 1;
        moving = true;
      }
      if (explorationData.keys.d) {
        moveX += 1;
        moving = true;
      }

      // å¦‚æœæœ‰ç§»åŠ¨è¾“å…¥
      if (moving) {
        // å½’ä¸€åŒ–å¯¹è§’çº¿ç§»åŠ¨é€Ÿåº¦
        const length = Math.sqrt(moveX * moveX + moveY * moveY);
        moveX /= length;
        moveY /= length;

        // è®¡ç®—ç§»åŠ¨è·ç¦»ï¼ˆåŸºäºæ—¶é—´ï¼‰
        const moveDistance = (explorationData.moveSpeed * deltaTime) / 1000;

        // æ›´æ–°äººç‰©åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½ç½®
        explorationData.characterWorldX += moveX * moveDistance;
        explorationData.characterWorldY += moveY * moveDistance;

        // é™åˆ¶åœ¨ä¸–ç•Œåœ°å›¾èŒƒå›´å†…
        const effectiveMapWidth = explorationData.actualMapWidth || explorationData.mapWidth;
        const effectiveMapHeight = explorationData.actualMapHeight || explorationData.mapHeight;

        explorationData.characterWorldX = Math.max(0, Math.min(effectiveMapWidth, explorationData.characterWorldX));
        explorationData.characterWorldY = Math.max(0, Math.min(effectiveMapHeight, explorationData.characterWorldY));

      // æ›´æ–°æ‘„åƒæœºè§†å›¾
      updateCameraView();

      // æ›´æ–°æ­¦å™¨ä½ç½®å’Œæ—‹è½¬
      updateWeaponPosition(deltaTime);

      // ç¡®å®šå½“å‰æ–¹å‘å¹¶æ’­æ”¾åŠ¨ç”»
        let direction = '';
        if (Math.abs(moveX) > Math.abs(moveY)) {
          direction = moveX > 0 ? 'D' : 'A';
        } else {
          direction = moveY > 0 ? 'S' : 'W';
        }

        // å¦‚æœæ–¹å‘æ”¹å˜ï¼Œé‡ç½®åŠ¨ç”»
        if (explorationData.currentDirection !== direction) {
          explorationData.currentDirection = direction;
          explorationData.frameIndex = 0;
        }

        // è®°å½•æœ€åä½¿ç”¨çš„æ–¹å‘
        explorationData.lastDirection = direction;

        // æ’­æ”¾åŠ¨ç”»å¸§
        playCharacterAnimation(direction);

        // å¦‚æœä¸åœ¨ç§»åŠ¨ä¸­ï¼Œå¯åŠ¨åŠ¨ç”»å¾ªç¯
        if (!explorationData.animationInterval) {
          explorationData.animationInterval = setInterval(() => {
            if (explorationData.currentDirection) {
              playCharacterAnimation(explorationData.currentDirection);
            }
          }, 400); // å‡æ…¢2å€ï¼Œä»200mså¢åŠ åˆ°400ms
        }
      } else {
        // åœæ­¢ç§»åŠ¨ï¼Œæ¸…é™¤åŠ¨ç”»å¾ªç¯å¹¶æ˜¾ç¤ºé™æ­¢å›¾åƒ
        if (explorationData.animationInterval) {
          clearInterval(explorationData.animationInterval);
          explorationData.animationInterval = null;
        }
        explorationData.currentDirection = null;
        explorationData.frameIndex = 0;

        // å¦‚æœæœ‰è®°å½•æœ€åæ–¹å‘ï¼Œæ˜¾ç¤ºè¯¥æ–¹å‘çš„ç¬¬ä¸€å¸§ï¼›å¦åˆ™æ˜¾ç¤ºæ­£é¢å›¾
        if (explorationData.lastDirection) {
          explorationData.character.src = `æ¢ç´¢/åŠ¨ä½œ/${explorationData.lastDirection}/1.png`;
        } else {
          explorationData.character.src = 'æ¢ç´¢/æ­£é¢.png';
        }
        
        // å³ä½¿äººç‰©åœæ­¢ç§»åŠ¨ï¼Œæ­¦å™¨ä¹Ÿè¦ç»§ç»­æ—‹è½¬
        updateWeaponPosition(deltaTime);
      }

      requestAnimationFrame(gameLoop);
    }

    function playCharacterAnimation(direction) {
      if (!explorationData.character) return;

      // è·å–è¯¥æ–¹å‘çš„å¸§æ•°
      const frameCounts = { 'W': 13, 'A': 11, 'S': 14, 'D': 11 };
      const frameCount = frameCounts[direction] || 11;

      // å‘å·¦å’Œå‘å³æ–¹å‘åŠ¨ç”»é€Ÿåº¦å‡æ…¢1å€
      const isLeftRight = direction === 'A' || direction === 'D';
      let frameIncrement = 1; // å…¶ä»–æ–¹å‘æ­£å¸¸é€Ÿåº¦
      
      if (isLeftRight) {
        // å‘å·¦å’Œå‘å³æ–¹å‘æ¯ä¸¤æ¬¡è°ƒç”¨æ‰æ›´æ–°ä¸€å¸§ï¼Œå®ç°1å€å‡é€Ÿ
        if (explorationData.frameSkipCounter === undefined) {
          explorationData.frameSkipCounter = 0;
        }
        
        explorationData.frameSkipCounter++;
        if (explorationData.frameSkipCounter % 2 === 0) {
          frameIncrement = 1;
        } else {
          frameIncrement = 0; // è·³è¿‡è¿™æ¬¡å¸§æ›´æ–°
        }
      }

      // æ›´æ–°å¸§ç´¢å¼•
      if (frameIncrement > 0) {
        explorationData.frameIndex = (explorationData.frameIndex + frameIncrement) % frameCount;
      }

      // åŠ è½½å¯¹åº”çš„å¸§å›¾ç‰‡
      const framePath = `æ¢ç´¢/åŠ¨ä½œ/${direction}/${explorationData.frameIndex + 1}.png`;
      explorationData.character.src = framePath;
    }

    function closeExplorationModal() {
      if (explorationData.animationInterval) {
        clearInterval(explorationData.animationInterval);
        explorationData.animationInterval = null;
      }
      document.removeEventListener('keydown', handleExplorationKeyDown);
      document.removeEventListener('keyup', handleExplorationKeyUp);
      if (explorationData.modal && explorationData.modal.parentNode) {
        document.body.removeChild(explorationData.modal);
      }
      explorationData.modal = null;
      explorationData.character = null;
      explorationData.weapon = null;
      explorationData.background = null;
    }

    // å±±é‡é€‰é¡¹å¼¹çª—å‡½æ•°
    function showMountainOptionsModal() {
      // åˆ›å»ºå¼¹çª—å®¹å™¨ï¼Œä½¿ç”¨æ ‡å‡†æ ·å¼
      const modalContainer = document.createElement('div');
      modalContainer.className = 'event-modal';
      
      // åˆ›å»ºå¼¹çª—å†…å®¹ï¼Œä½¿ç”¨ink-borderæ ·å¼ä¿æŒä¸€è‡´æ€§
      const modalContent = document.createElement('div');
      modalContent.className = 'event-modal-content ink-border';
      
      // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
      const modalHeader = document.createElement('div');
      modalHeader.className = 'event-modal-header';
      modalHeader.innerHTML = '<h3>å±±é‡è¡ŒåŠ¨</h3>';
      
      // åˆ›å»ºå†…å®¹åŒºåŸŸ
      const modalBody = document.createElement('div');
      modalBody.className = 'event-modal-body';
      
      // æ·»åŠ æè¿°æ–‡æœ¬
      const description = document.createElement('p');
      description.textContent = 'ä½ æ¥åˆ°äº†å±±æ—ä¹‹ä¸­ï¼Œå¯ä»¥é€‰æ‹©ä»¥ä¸‹è¡ŒåŠ¨ï¼š';
      modalBody.appendChild(description);
      
      // åˆ›å»ºæŒ‰é’®å®¹å™¨
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'event-modal-options';
      
      // ç ä¼æŒ‰é’®
      const chopButton = document.createElement('div');
      chopButton.className = 'event-modal-option';
      chopButton.innerHTML = `
        <div class="event-modal-option-text">ç ä¼æ ‘æœ¨</div>
        <div class="event-modal-option-description">éœ€è¦è£…å¤‡æ–§å¤´ï¼Œæ¶ˆè€—æ–§å¤´è€ä¹…åº¦è·å¾—åŸæœ¨</div>
      `;
      chopButton.onclick = function() {
        // æ‰§è¡Œç ä¼é€»è¾‘
        chopWood();
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      
      // æ¢ç´¢æŒ‰é’®ï¼ˆåŸæ¥çš„è¿›å±±è¡ŒåŠ¨ï¼‰
      const exploreButton = document.createElement('div');
      exploreButton.className = 'event-modal-option';
      exploreButton.innerHTML = `
        <div class="event-modal-option-text">æ¢ç´¢å±±æ—</div>
        <div class="event-modal-option-description">åœ¨å±±æ—ä¸­æ¢ç´¢ï¼Œå¯èƒ½ä¼šæœ‰æ„å¤–å‘ç°</div>
      `;
      exploreButton.onclick = function() {
        // æ‰§è¡Œæ¢ç´¢é€»è¾‘
        exploreMountain();
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      
      // å…³é—­æŒ‰é’®
      const closeButton = document.createElement('div');
      closeButton.className = 'event-modal-option';
      closeButton.innerHTML = `
        <div class="event-modal-option-text">å–æ¶ˆ</div>
        <div class="event-modal-option-description">è¿”å›ä¹‹å‰çš„ç•Œé¢</div>
      `;
      closeButton.onclick = function() {
        modalContainer.classList.remove('active');
        setTimeout(() => modalContainer.remove(), 300);
      };
      
      buttonContainer.appendChild(chopButton);
      buttonContainer.appendChild(exploreButton);
      buttonContainer.appendChild(closeButton);
      modalBody.appendChild(buttonContainer);
      
      modalContent.appendChild(modalHeader);
      modalContent.appendChild(modalBody);
      modalContainer.appendChild(modalContent);
      
      document.body.appendChild(modalContainer);
      
      // è§¦å‘åŠ¨ç”»
      setTimeout(() => modalContainer.classList.add('active'), 10);
      
      // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          modalContainer.classList.remove('active');
          setTimeout(() => modalContainer.remove(), 300);
        }
      };
    }

    // æ£€æŸ¥æ–§å¤´æ˜¯å¦è£…å¤‡åˆ°æ­¦å™¨åŒºåŸŸ
    function isAxeEquipped() {
      // æ£€æŸ¥æ–§å¤´èµ„æºæ˜¯å¦å­˜åœ¨ä¸”è£…å¤‡åˆ°æ­¦å™¨åŒºåŸŸ
      const axe = gameData.resources['æ–§å¤´'];
      if (!axe || !axe.equipped || axe.equipmentSlot !== 'weapon') {
        return false;
      }
      return true;
    }

    // æ˜¾ç¤ºæ²¡æœ‰è£…å¤‡æ–§å¤´çš„æç¤ºçª—å£
    function showNoAxeEquippedModal() {
      // åˆ›å»ºå¼¹çª—å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'modal';
      modalContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
      `;

      // åˆ›å»ºå¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background-color: #f0e6d6;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        min-width: 280px;
      `;

      // æ·»åŠ æ ‡é¢˜
      const title = document.createElement('h3');
      title.textContent = 'æ— æ³•ç ä¼';
      title.style.marginBottom = '15px';
      modalContent.appendChild(title);

      // æ·»åŠ æç¤ºä¿¡æ¯
      const message = document.createElement('p');
      message.textContent = 'ä½ éœ€è¦å…ˆå°†æ–§å¤´è£…å¤‡åˆ°æ­¦å™¨åŒºåŸŸæ‰èƒ½ç ä¼æ ‘æœ¨ã€‚';
      message.style.marginBottom = '20px';
      modalContent.appendChild(message);

      // åˆ›å»ºç¡®å®šæŒ‰é’®
      const confirmButton = document.createElement('button');
      confirmButton.textContent = 'ç¡®å®š';
      confirmButton.style.cssText = `
        padding: 10px 30px;
        background-color: #8b5a2b;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      `;
      confirmButton.onclick = function() {
        modalContainer.remove();
      };

      modalContent.appendChild(confirmButton);
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);

      // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
      modalContainer.onclick = function(e) {
        if (e.target === modalContainer) {
          modalContainer.remove();
        }
      };

      // é˜²æ­¢ç‚¹å‡»å¼¹çª—å†…å®¹æ—¶è§¦å‘å…³é—­
      modalContent.onclick = function(e) {
        e.stopPropagation();
      };
    }

    // ç ä¼æ ‘æœ¨åŠŸèƒ½
    function chopWood() {
      // æ£€æŸ¥æ–§å¤´æ˜¯å¦è£…å¤‡åˆ°æ­¦å™¨åŒºåŸŸ
      if (!isAxeEquipped()) {
        showNoAxeEquippedModal();
        return;
      }
      
      // æ£€æŸ¥æ–§å¤´è€ä¹…åº¦
      if (gameData.resources['æ–§å¤´'].durability < 10) {
        showNotification('æ–§å¤´æŸå', 'æ–§å¤´å·²ç»æŸåï¼Œæ— æ³•ä½¿ç”¨ã€‚');
        return;
      }
      
      // æ‰§è¡Œç ä¼é€»è¾‘
      const chopResults = {
        resources: {},
        status: {},
        effects: []
      };
      
      // æ¶ˆè€—æ–§å¤´è€ä¹…åº¦
      gameData.resources['æ–§å¤´'].durability -= 10;
      chopResults.resources['æ–§å¤´'] = -10;
      chopResults.effects.push('æ–§å¤´è€ä¹…åº¦å‡å°‘äº†10ç‚¹');
      
      // æ£€æŸ¥æ–§å¤´æ˜¯å¦æŸå
      if (gameData.resources['æ–§å¤´'].durability <= 0) {
        gameData.resources['æ–§å¤´'].durability = 0;
        chopResults.effects.push('æ–§å¤´å·²ç»æŸåï¼');
      }

      // è·å¾—åŸæœ¨ï¼Œæ·»åŠ åˆ°åœ°é¢æ 
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      const locationId = currentLocation ? currentLocation.id : 'wilderness';

      if (!gameData.resources.log) {
        // åˆå§‹åŒ–åŸæœ¨èµ„æº
        gameData.resources.log = {
          name: 'åŸæœ¨',
          description: 'ç ä¼æ ‘æœ¨å¾—åˆ°çš„åŸæœ¨ï¼Œå¯ä»¥ç”¨æ¥åˆ¶ä½œå„ç§ç‰©å“',
          amount: 0,
          image: 'UI/åŸæœ¨.jpg',
          type: 'material',
          category: 'material',
          id: 'log',
          cannotDrop: false
        };
      }

      addResourceToGround('log', 1, locationId);
      chopResults.resources.log = 1;
      chopResults.effects.push('è·å¾—1æ ¹åŸæœ¨');

      // ä½“åŠ›æ¶ˆè€—
      gameData.status.health = Math.max(0, gameData.status.health - 8);
      checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
      chopResults.status.health = -8;
      chopResults.effects.push('ç ä¼æ ‘æœ¨æ¶ˆè€—äº†ä½“åŠ›');
      
      // ä¿å­˜æ¸¸æˆæ•°æ®
      updateGameData();
      
       const logName = gameData.resources.log.name || 'åŸæœ¨';
       showNotification('ç ä¼æˆåŠŸ', `ä½ æˆåŠŸç ä¼äº†ä¸€æ£µæ ‘ï¼Œè·å¾—äº†ä¸€æ ¹${logName}ã€‚`);
      
      // æ›´æ–°UI
      renderResources();
      renderActions();
      
      // æ¶ˆè€—æ—¶é—´
      advanceTime();
    }

    // æ¢ç´¢å±±æ—åŠŸèƒ½ï¼ˆåŸæ¥çš„è¿›å±±è¡ŒåŠ¨ï¼‰
    function exploreMountain() {
      const mountainResults = {
        resources: {},
        status: {},
        effects: []
      };

      const mountainSuccess = Math.random() > 0.5;
      if (mountainSuccess) {
        // æˆåŠŸæ—¶éšæœºè·å¾—ä¸€ç§èµ„æºï¼Œæ·»åŠ åˆ°åœ°é¢æ 
        const currentLocation = gameData.locations.find(loc => loc.currentLocation);
        const locationId = currentLocation ? currentLocation.id : 'wilderness';

        const rand = Math.random();
        if (rand < 0.4) {
          addResourceToGround('herb', 1, locationId);
          mountainResults.resources.herb = 1;
          mountainResults.effects.push('æ‰¾åˆ°äº†ä¸€äº›è‰è¯');
        } else if (rand < 0.6) {
          addResourceToGround('stick', 1, locationId);
          mountainResults.resources.stick = 1;
          mountainResults.effects.push('æ‰¾åˆ°äº†ä¸€æ ¹æœ¨æ£');
        } else if (rand < 0.8) {
          addResourceToGround('bamboo', 1, locationId);
          mountainResults.resources.bamboo = 1;
          mountainResults.effects.push('æ‰¾åˆ°äº†ä¸€æ ¹ç«¹å­');
        } else {
          addResourceToGround('hide', 1, locationId);
          mountainResults.resources.hide = 1;
          mountainResults.effects.push('å‘ç°äº†ä¸€å¼ å…½çš®');
        }
      } else {
        mountainResults.effects.push('ä¸€æ— æ‰€è·');
      }

      // ä½“åŠ›æ¶ˆè€—
      gameData.status.health = Math.max(0, gameData.status.health - 5);
      checkGameOver(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¤±è´¥
      mountainResults.status.health = -5;
      mountainResults.effects.push('åœ¨å±±æ—ä¸­è¡Œèµ°æ¶ˆè€—äº†ä½“åŠ›');

      // ä¿å­˜æ¸¸æˆæ•°æ®
      updateGameData();

      // æ„å»ºé€šçŸ¥æ¶ˆæ¯ï¼Œæ˜¾ç¤ºè·å¾—çš„å¡ç‰Œ
      let notificationMessage = 'ä½ åœ¨å±±æ—ä¸­æ¢ç´¢äº†ä¸€ç•ªã€‚';
      if (mountainResults.resources && Object.keys(mountainResults.resources).length > 0) {
        const acquiredItems = [];
        Object.entries(mountainResults.resources).forEach(([resourceId, amount]) => {
          const resource = gameData.resources[resourceId];
          if (resource) {
            acquiredItems.push(`${resource.name} Ã— ${amount}`);
          }
        });
        if (acquiredItems.length > 0) {
          notificationMessage += '\n\nè·å¾—ï¼š' + acquiredItems.join('ã€');
        }
      }
      showNotification('è¿›å±±æ¢ç´¢', notificationMessage);

      // æ›´æ–°UI
      renderResources();
      renderActions();
      
      // æ¶ˆè€—æ—¶é—´
      advanceTime();
    }
  </script>
  
  <!-- Notification Modal -->
  <div id="notification" class="notification">
    <div class="notification-content">
      <h3 id="notificationTitle" class="notification-title">é€šçŸ¥æ ‡é¢˜</h3>
      <p id="notificationMessage" class="notification-message">é€šçŸ¥å†…å®¹</p>
      <div class="notification-actions">
        <button id="closeNotificationButton" class="notification-button">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal" style="display: none;">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <h2>è®¾ç½®</h2>
        <button id="closeSettingsButton" class="settings-close-button">Ã—</button>
      </div>
      <div class="settings-modal-body">
        <!-- éŸ³æ•ˆè®¾ç½® -->
        <div class="settings-section">
          <h3>éŸ³æ•ˆè®¾ç½®</h3>
          
          <!-- èƒŒæ™¯éŸ³ä¹è®¾ç½® -->
          <div class="setting-item">
            <div class="setting-label">
              <span>èƒŒæ™¯éŸ³ä¹</span>
              <label class="toggle-switch">
                <input type="checkbox" id="backgroundMusicToggle" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="setting-control">
              <input type="range" id="backgroundMusicVolume" min="0" max="100" value="50" class="volume-slider">
              <span id="backgroundMusicVolumeValue" class="volume-value">50%</span>
            </div>
          </div>
          
          <!-- éŸ³æ•ˆè®¾ç½® -->
          <div class="setting-item">
            <div class="setting-label">
              <span>æ¸¸æˆéŸ³æ•ˆ</span>
              <label class="toggle-switch">
                <input type="checkbox" id="soundEffectsToggle" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="setting-control">
              <input type="range" id="soundEffectsVolume" min="0" max="100" value="50" class="volume-slider">
              <span id="soundEffectsVolumeValue" class="volume-value">50%</span>
            </div>
          </div>
        </div>
        
        <!-- ä¿å­˜å’ŒåŠ è½½ -->
        <div class="settings-section">
          <h3>æ¸¸æˆå­˜æ¡£</h3>
          <div class="save-load-controls">
            <button id="settingsSaveButton" class="ink-button ink-button-primary">ä¿å­˜æ¸¸æˆ</button>
            <button id="settingsLoadButton" class="ink-button ink-button-secondary">åŠ è½½æ¸¸æˆ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
