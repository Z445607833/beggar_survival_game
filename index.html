<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=1.0, minimum-scale=1.0, target-densitydpi=device-dpi">
  <title>ä¹ä¸ç”Ÿå­˜ - å¡ç‰Œç”Ÿå­˜æ¸¸æˆ</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- GSAP åŠ¨ç”»åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <!-- Tailwind é…ç½® -->
  <!-- Tailwindé…ç½® -->
  <script>
    // æ˜¾ç¤ºé’±å¸ä¸è¶³å¼¹çª—
    function showNoMoneyModal() {
      const modal = document.createElement('div');
      modal.className = 'no-money-modal active';
      modal.innerHTML = `
        <div class="no-money-modal-content">
          <h2 class="no-money-modal-title">é’±å¸ä¸è¶³</h2>
          <p class="no-money-modal-text">ä½ è¿˜æ²¡æœ‰10ä¸ªé’±å¸ï¼Œæ— æ³•è·å¾—çº¿ç´¢</p>
          <div class="no-money-modal-button" id="closeNoMoneyModal">å…³é—­</div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .no-money-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }
        
        .no-money-modal.active {
          opacity: 1;
          pointer-events: auto;
        }
        /* çº¢è‰²è¾¹æ¡†é˜´å½±è­¦ç¤ºæ ·å¼ */
        .garbage-grid-item.danger-tip {
          box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3);
          border: 3px solid red;
          animation: danger-pulse 1.5s infinite;
          z-index: 10;
        }
        
        /* å±é™©è­¦ç¤ºåŠ¨ç”»æ•ˆæœ */
        @keyframes danger-pulse {
          0% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3); }
          50% { box-shadow: 0 0 15px 5px red, inset 0 0 15px 5px rgba(255, 0, 0, 0.5); }
          100% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3); }
        }
        
        .no-money-modal-content {
          background-color: #F7FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 0.5rem;
          padding: 2rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
          width: 300px;
          text-align: center;
        }
        
        .no-money-modal-title {
          font-size: 1.5rem;
          font-weight: 700;
          color: #2D3748;
          margin-bottom: 1rem;
        }
        
        .no-money-modal-text {
          color: #4A5568;
          margin-bottom: 1.5rem;
          line-height: 1.5;
        }
        
        .no-money-modal-button {
          background-color: #3182CE;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: 500;
          transition: background-color 0.2s;
          display: inline-block;
        }
        
        .no-money-modal-button:hover {
          background-color: #2C5282;
        }
      `;
      
      document.head.appendChild(style);
      
      // å…³é—­æŒ‰é’®äº‹ä»¶
      const closeNoMoneyModal = document.getElementById('closeNoMoneyModal');
      if (closeNoMoneyModal) {
        closeNoMoneyModal.addEventListener('click', function() {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
            }
            if (style.parentNode) {
              if (style.parentNode === document.head) {
        style.parentNode.removeChild(style);
      }
            }
          }, 300);
        });
      }
      
      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        }
      });
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
      }
      .card-border {
        border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4"><path d="M0 0h4v4H0z" fill="none" stroke="%23A0AEC0" stroke-width="1"/></svg>') 1 repeat;
      }
      .ink-splash {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="40" fill="rgba(160, 174, 192, 0.1)"/></svg>');
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
      }
      .scroll-bg {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path d="M0 0h20v20H0z" fill="none" stroke="%23A0AEC0" stroke-width="1" stroke-dasharray="2,2"/></svg>');
        background-repeat: repeat;
      }
      .card-drag {
        cursor: grab;
      }
      .card-drag:active {
        cursor: grabbing;
      }
      .card-stack {
        position: relative;
      }
      .card-stack > div {
        position: absolute;
        transition: all 0.3s ease;
      }
      .card-stack > div:nth-child(1) { transform: translate(0, 0) rotate(0deg); z-index: 1; }
      .card-stack > div:nth-child(2) { transform: translate(8px, 8px) rotate(2deg); z-index: 2; }
      .card-stack > div:nth-child(3) { transform: translate(16px, 16px) rotate(4deg); z-index: 3; }
      .card-stack > div:nth-child(4) { transform: translate(24px, 24px) rotate(6deg); z-index: 4; }
      .card-stack > div:nth-child(5) { transform: translate(32px, 32px) rotate(8deg); z-index: 5; }
      .card-stack > div:nth-child(n+6) { transform: translate(40px, 40px) rotate(10deg); z-index: 6; }
    }
  </style>
  <style>
    /* ç§»é™¤å¤–éƒ¨å­—ä½“å¼•ç”¨ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“ */
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif, 'Microsoft YaHei', 'å¾®è½¯é›…é»‘';
      background-color: #F7FAFC;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none" stroke="%23E2E8F0" stroke-width="0.5" stroke-dasharray="5,5"/></svg>');
      background-repeat: repeat;
    }
    
    .card {
      transition: all 0.3s ease;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .card.resource {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
    }
    
    .card.location {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
    }
    
    .location-details {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }
    
    .resource-type, .danger-level, .action-cost {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .danger-level.low {
      color: #38A169;
    }
    
    .danger-level.medium {
      color: #ECC94B;
    }
    
    .danger-level.high {
      color: #E53E3E;
    }
    
    .location-card.current {
      border-color: #38A169;
      box-shadow: 0 0 15px rgba(56, 161, 105, 0.5);
    }
    
    .card.status {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
    }
    
    .card.action {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
    }
    
    .card-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background-color: #E2E8F0;
    }
    
    .location-card .card-image {
      height: 60px;
    }
    
    .action-card .card-image {
      height: 60px;
    }
    
    .card-content {
      padding: 0.75rem;
    }
    
    .card-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    
    /* èµ„æºå¡ç‰Œç‰¹å®šæ ·å¼ - ç¼©å°å°ºå¯¸ä»¥é€‚åº”æ›´å¤šå¡ç‰Œ */
    .resource-card {
      width: 80px;
    }
    
    .resource-card .card-image {
      height: 80px;
    }
    
    .resource-card .card-title {
      font-size: 0.875rem;
    }
    
    .card-description {
      font-size: 0.75rem;
      color: #4A5568;
    }
    
    .card-footer {
      padding: 0.5rem 0.75rem;
      border-top: 1px solid #E2E8F0;
      font-size: 0.75rem;
      color: #4A5568;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .resource-count {
      background-color: #E2E8F0;
      border-radius: 9999px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .progress-bar {
      height: 4px;
      background-color: #E2E8F0;
      border-radius: 9999px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #805AD5;
      border-radius: 9999px;
      transition: width 0.3s ease;
    }
    
    .location-card {
      cursor: pointer;
    }
    
    .resource-card {
      cursor: grab;
    }
    
    .resource-card:active {
      cursor: grabbing;
    }
    
    .status-card {
      cursor: default;
    }
    
    .action-card {
      cursor: pointer;
    }
    
    .dragging {
      opacity: 0.8;
      transform: scale(1.05);
      z-index: 100;
    }
    
    .dropzone {
      border: 2px dashed #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      min-height: 100px;
      transition: all 0.3s ease;
    }
    
    .dropzone.active {
      border-color: #805AD5;
      background-color: rgba(128, 90, 213, 0.05);
    }
    
    .game-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #E2E8F0;
    }
    
    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2D3748;
    }
    
    .header-info {
      display: flex;
      gap: 1rem;
    }
    
    .info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #4A5568;
    }
    
    .info-item-value {
      font-weight: 600;
      color: #2D3748;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 1rem;
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .sidebar-section {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    
    .sidebar-section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #2D3748;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    
    .resource-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 0.5rem;
      padding: 0.5rem;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .main-area {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .location-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }
    
    .action-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
    
    .combination-area {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .combination-title {
      font-size: 1rem;
      font-weight: 600;
      color: #2D3748;
    }
    
    .combination-slots {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .combination-slot {
      width: 80px;
      height: 120px;
      border: 2px dashed #E2E8F0;
      border-radius: 0.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .combination-slot.active {
      border-color: #805AD5;
      background-color: rgba(128, 90, 213, 0.05);
    }
    
    /* åˆ¶ä½œçª—å£æ ·å¼ */
    .crafting-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .crafting-modal.active {
      display: block;
    }
    
    .crafting-modal-content {
      background-color: #F7FAFC;
      margin: 5% auto;
      padding: 0;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 800px;
      max-height: 50vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .crafting-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background-color: #805AD5;
      color: white;
    }
    
    .crafting-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }
    
    .crafting-modal-close {
      color: white;
      font-size: 1.75rem;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .crafting-modal-close:hover,
    .crafting-modal-close:focus {
      color: #E2E8F0;
      text-decoration: none;
      cursor: pointer;
    }
    
    .crafting-modal-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .crafting-left,
    .crafting-right {
      padding: 1rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .crafting-left {
      width: 50%;
      border-right: 1px solid #E2E8F0;
    }
    
    .crafting-right {
      width: 50%;
    }
    
    .crafting-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #2D3748;
      margin-bottom: 1rem;
    }
    
    .crafting-inventory {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
    }
    
    /* å¡ç‰Œå’Œæ’æ§½çš„åŸºç¡€å°ºå¯¸å˜é‡ */
    :root {
      --card-base-width: 80px;
      --card-base-height: 120px;
    }
    
    .crafting-inventory-card {
      width: var(--card-base-width) !important;
      height: var(--card-base-height) !important;
      border: 1px solid #E2E8F0 !important;
      border-radius: 0.5rem !important;
      background-color: white !important;
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      padding: 0.5rem !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    .crafting-inventory-card:hover {
      transform: scale(1.05) !important;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
    }
    
    .crafting-card-image {
      width: 100% !important;
      height: 70px !important;
      background-size: cover !important;
      background-position: center !important;
      border-radius: 0.25rem !important;
      margin-bottom: 0.5rem !important;
      background-color: #E2E8F0 !important;
    }
    
    .crafting-card-title {
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      color: #2D3748 !important;
      text-align: center !important;
      margin-bottom: 0.25rem !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
      width: 100% !important;
    }
    
    .crafting-card-count {
      font-size: 0.625rem !important;
      color: #4A5568 !important;
      font-weight: 500 !important;
    }
    
    .crafting-slots {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0.5rem;
    }
    
    .crafting-slot {
      width: var(--card-base-width);
      height: var(--card-base-height);
      border: 2px dashed #E2E8F0;
      border-radius: 0.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .crafting-slot.active {
      border-color: #805AD5;
      background-color: rgba(128, 90, 213, 0.05);
    }
    
    .crafting-slot .card {
      width: 100% !important;
      height: 100% !important;
      font-size: 0.75rem !important;
      display: flex !important;
      flex-direction: column !important;
    }
    
    .crafting-slot .card .card-image {
      height: 70% !important;
    }
    
    .crafting-slot .card .card-content {
      padding: 0.5rem !important;
      flex-grow: 1 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    .crafting-slot .card .card-title {
      font-size: 0.75rem !important;
      text-align: center !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }
    
    /* å“åº”å¼è®¾è®¡ - å°å±å¹•é€‚é… */
    @media (max-width: 600px) {
      :root {
        --card-base-width: 60px;
        --card-base-height: 90px;
      }
      
      .crafting-inventory-card {
        padding: 0.25rem !important;
      }
      
      .crafting-card-title {
        font-size: 0.625rem !important;
      }
      
      .crafting-card-count {
        font-size: 0.5rem !important;
      }
    }
    
    .crafting-result {
      min-height: 100px;
      margin-bottom: 0.25rem;
      padding: 0.75rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 0.5rem;
      text-align: center;
    }
    
    .crafting-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    
    .crafting-button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #805AD5;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .crafting-button:hover {
      background-color: #6B46C1;
    }
    
    .crafting-button:disabled {
      background-color: #CBD5E0;
      cursor: not-allowed;
    }
    

    
    .event-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .event-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .event-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .event-modal.active .event-modal-content {
      transform: translateY(0);
    }
    
    .event-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .event-modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2D3748;
    }
    
    .event-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }
    
    .event-modal-body {
      margin-bottom: 1.5rem;
    }
    
    .event-modal-text {
      margin-bottom: 1rem;
      color: #2D3748;
    }
    
    .event-modal-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .event-modal-option {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .event-modal-option:hover {
      background-color: #EDF2F7;
      border-color: #CBD5E0;
    }
    
    .event-modal-option-text {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #2D3748;
    }
    
    .event-modal-option-description {
      font-size: 0.75rem;
      color: #4A5568;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #2D3748;
      color: #fff;
      text-align: center;
      border-radius: 0.25rem;
      padding: 0.5rem;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .season-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #4A5568;
    }
    
    .season-icon {
      font-size: 1rem;
    }
    
    .day-indicator {
      font-size: 1.5rem;
      color: #4A5568;
      text-align: center;
      font-weight: bold;
    }
    
    .day-number {
      font-weight: 600;
      color: #2D3748;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1000;
      max-width: 300px;
      width: 90%;
    }
    
    .notification.active {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification.central {
      top: 50%;
      left: 50%;
      bottom: auto;
      transform: translate(-50%, -50%) scale(0.9);
      padding: 1.5rem;
      max-width: 400px;
      text-align: center;
    }
    
    .notification.central.active {
      transform: translate(-50%, -50%) scale(1);
    }
    
    .notification-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #2D3748;
    }
    
    .notification-message {
      font-size: 0.875rem;
      color: #4A5568;
    }
    
    .notification-close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }

    .notification-actions {
      margin-top: 1rem;
    }

    .notification-button {
      padding: 0.5rem 1.5rem;
      background-color: #4299E1;
      color: white;
      border: none;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .notification-button:hover {
      background-color: #3182CE;
    }
    
    .recipe-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .recipe-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .recipe-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .recipe-modal.active .recipe-modal-content {
      transform: translateY(0);
    }
    
    .recipe-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .recipe-modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2D3748;
    }
    
    .recipe-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }
    
    .recipe-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .recipe-card {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      transition: all 0.3s ease;
    }
    
    .recipe-card:hover {
      background-color: #EDF2F7;
      border-color: #CBD5E0;
    }
    
    .recipe-card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2D3748;
    }
    
    .recipe-card-ingredients {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .recipe-card-ingredient {
      background-color: #EDF2F7;
      border-radius: 9999px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      color: #4A5568;
    }
    
    .recipe-card-description {
      font-size: 0.75rem;
      color: #4A5568;
    }
    
    .recipe-card-discovered {
      font-size: 0.75rem;
      color: #805AD5;
      font-weight: 600;
    }
    
    .recipe-card-undiscovered {
      font-size: 0.75rem;
      color: #A0AEC0;
    }
    
    /* äº‹ä»¶ç»“æœæ¨¡æ€æ¡†æ ·å¼ */
    .event-result-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .event-result-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .event-result-modal.closing {
      opacity: 0;
    }
    
    .event-result-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .event-result-modal.active .event-result-modal-content {
      transform: translateY(0);
    }
    
    .event-result-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .event-result-modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2D3748;
    }
    
    .event-result-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
      transition: all 0.3s ease;
    }
    
    .event-result-modal-close:hover {
      color: #2D3748;
    }
    
    .event-result-modal-body {
      margin-bottom: 1rem;
    }
    
    .event-result-section {
      margin-bottom: 1rem;
    }
    
    .event-result-section:last-child {
      margin-bottom: 0;
    }
    
    .event-result-list {
      margin-top: 0.5rem;
      padding-left: 1.5rem;
      list-style-type: disc;
    }
    
    .event-result-list li {
      margin-bottom: 0.25rem;
      color: #2D3748;
    }
    
    .start-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #F7FAFC;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      transition: all 0.5s ease;
    }
    
    .start-screen-content {
      text-align: center;
      max-width: 600px;
      padding: 2rem;
    }
    
    .start-screen-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #2D3748;
    }
    
    .start-screen-subtitle {
      font-size: 1.25rem;
      margin-bottom: 2rem;
      color: #4A5568;
    }
    
    .start-screen-image {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .start-screen-description {
      margin-bottom: 2rem;
      color: #4A5568;
    }
    
    .start-screen-button {
      background-color: #805AD5;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .start-screen-button:hover {
      background-color: #6B46C1;
      transform: translateY(-2px);
    }
    
    .tutorial-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .tutorial-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .tutorial-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .tutorial-modal.active .tutorial-modal-content {
      transform: translateY(0);
    }
    
    .tutorial-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .tutorial-modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2D3748;
    }
    
    .tutorial-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #4A5568;
    }
    
    .tutorial-step {
      margin-bottom: 1.5rem;
      display: block !important;
    }
    
    .tutorial-step-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2D3748;
    }
    
    .tutorial-step-content {
      margin-bottom: 0.5rem;
      color: #4A5568;
    }
    
    .tutorial-step-image {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .tutorial-navigation {
      display: flex;
      justify-content: center;
      margin-top: 1.5rem;
    }
    
    .tutorial-button {
      background-color: #805AD5;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tutorial-button:hover {
      background-color: #6B46C1;
    }
    
    .tutorial-button:disabled {
      background-color: #A0AEC0;
      cursor: not-allowed;
    }
    
    .game-over-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .game-over-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .game-over-modal-content {
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      max-width: 600px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .game-over-modal.active .game-over-modal-content {
      transform: translateY(0);
    }
    
    .game-over-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .game-over-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2D3748;
    }
    
    .game-over-modal-body {
      margin-bottom: 1.5rem;
    }
    
    .game-over-modal-text {
      margin-bottom: 1rem;
      color: #2D3748;
    }
    
    .game-over-stats {
      background-color: #EDF2F7;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .game-over-stats-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2D3748;
    }
    
    .game-over-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }
    
    .game-over-stat {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: #4A5568;
    }
    
    .game-over-stat-value {
      font-weight: 600;
      color: #2D3748;
    }
    
    .game-over-modal-options {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    
    .game-over-button {
      background-color: #805AD5;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .game-over-button:hover {
      background-color: #6B46C1;
    }
    
    .achievement-modal {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background-color: #F7FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      max-width: 300px;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .achievement-modal.active {
      transform: translateX(0);
      opacity: 1;
    }
    
    .achievement-icon {
      font-size: 1.5rem;
      color: #805AD5;
    }
    
    .achievement-content {
      flex: 1;
    }
    
    .achievement-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #2D3748;
    }
    
    .achievement-description {
      font-size: 0.875rem;
      color: #4A5568;
    }
    
    .achievement-close {
      background: none;
      border: none;
      font-size: 0.875rem;
      cursor: pointer;
      color: #4A5568;
    }
    
    /* æ°´å¢¨ç”»é£æ ¼çš„ç‰¹æ®Šæ•ˆæœ */
    .ink-border {
      position: relative;
      border: 1px solid #A0AEC0;
    }
    
    .ink-border::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border: 1px solid #A0AEC0;
      border-radius: 0.5rem;
      z-index: -1;
      opacity: 0.5;
    }
    
    .ink-bg {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="none" stroke="%23E2E8F0" stroke-width="0.5" stroke-dasharray="5,5"/></svg>');
      background-repeat: repeat;
    }
    
    .ink-text {
      position: relative;
      display: inline-block;
    }
    
    .ink-text::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 1px;
      background-color: #A0AEC0;
      transform: scaleX(0.8) translateX(10%);
      opacity: 0.7;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .location-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .action-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 640px) {
      .location-grid {
        grid-template-columns: 1fr;
      }
      
      .action-grid {
        grid-template-columns: 1fr;
      }
      
      .resource-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      
      .status-grid {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .header-info {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
<!-- æ·»åŠ iOSç‰¹å®šçš„æ—‹è½¬æ”¯æŒ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    /* é˜²æ­¢iOSä¸Šçš„åŒå‡»ç¼©æ”¾ */
    * {
      touch-action: manipulation;
    }
    
    /* æ¨ªå±æ¨¡å¼æ ·å¼è°ƒæ•´ */
    @media screen and (orientation: landscape) {
      /* è°ƒæ•´å¡ç‰‡ç½‘æ ¼åœ¨æ¨ªå±æ—¶çš„å¸ƒå±€ */
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }
      
      /* è°ƒæ•´æ¸¸æˆå®¹å™¨åœ¨æ¨ªå±æ—¶çš„å¸ƒå±€ */
      .game-container {
        flex-direction: row;
        height: 100vh;
      }
      
      /* ç¡®ä¿é‡è¦å…ƒç´ åœ¨æ¨ªå±æ—¶æœ‰åˆé€‚çš„å¤§å° */
      .card {
        max-height: 200px;
      }
      
      /* è°ƒæ•´èµ„æºæ åœ¨æ¨ªå±æ—¶çš„å¸ƒå±€ */
      .resources-grid {
        max-width: 400px;
      }
    }
  </style>
</head>
<body class="ink-bg" onresize="checkOrientation()">
  <!-- æ·»åŠ å±å¹•æ–¹å‘æ£€æµ‹è„šæœ¬ -->
  <script>
    // æ£€æµ‹å±å¹•æ–¹å‘å˜åŒ–
    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      const gameContainer = document.querySelector('.game-container');
      
      if (isLandscape) {
        document.body.classList.add('landscape-mode');
        document.body.classList.remove('portrait-mode');
      } else {
        document.body.classList.add('portrait-mode');
        document.body.classList.remove('landscape-mode');
      }
      
      // é‡æ–°æ¸²æŸ“æ¸¸æˆå…ƒç´ ä»¥é€‚åº”æ–°çš„æ–¹å‘
      if (typeof renderLocations === 'function') renderLocations();
      if (typeof renderResources === 'function') renderResources();
      if (typeof renderActions === 'function') renderActions();
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åˆå§‹æ–¹å‘
    window.addEventListener('load', checkOrientation);
    // è®¾å¤‡æ—‹è½¬æ—¶æ£€æŸ¥æ–¹å‘
    window.addEventListener('orientationchange', checkOrientation);
  </script>
  <!-- å¼€å§‹å±å¹• -->
  <div class="start-screen" id="startScreen">
    <div class="start-screen-content">
      <h1 class="start-screen-title ink-text">ä¹ä¸ç”Ÿå­˜</h1>
      <p class="start-screen-subtitle">æ°´å¢¨ç”»é£æ ¼çš„å¡ç‰Œç”Ÿå­˜æ¸¸æˆ</p>
      <img src="https://p26-doubao-search-sign.byteimg.com/labis/image/ca34eef8faf2eaaa278d2cc70942e1fe~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779775073&x-signature=8D1SWhJmDtjETZt3j6%2BXhlYMVbM%3D" alt="æ¸¸æˆèƒŒæ™¯" class="start-screen-image">
      <p class="start-screen-description">
        åœ¨è¿™ä¸ªæ®‹é…·çš„å¤ä»£ä¸–ç•Œä¸­ï¼Œä½ æ‰®æ¼”ä¸€åä¹ä¸ï¼ŒæŒ£æ‰æ±‚ç”Ÿã€‚é€šè¿‡æ”¶é›†èµ„æºã€åˆ¶ä½œå·¥å…·ã€æ¢ç´¢åœ°ç‚¹å’Œåº”å¯¹äº‹ä»¶ï¼ŒåŠªåŠ›æ´»ä¸‹å»å¹¶å¯»æ‰¾æ”¹å˜å‘½è¿çš„æœºä¼šã€‚
      </p>
      <button class="start-screen-button" id="startGameButton">å¼€å§‹æ¸¸æˆ</button>
      <div class="start-screen-save-load" style="display: flex; justify-content: center; flex-wrap: wrap; margin-top: 1.5rem;">

      </div>
    </div>
  </div>

  <!-- æ•™ç¨‹æ¨¡æ€æ¡† -->
  <div class="tutorial-modal" id="tutorialModal">
    <div class="tutorial-modal-content ink-border">
      <div class="tutorial-modal-header">
        <h2 class="tutorial-modal-title ink-text">æ¸¸æˆæ•™ç¨‹</h2>
        <button class="tutorial-modal-close" id="closeTutorialButton">&times;</button>
      </div>
      <div class="tutorial-steps">
        <div class="tutorial-step" id="tutorialStep1">
          <h3 class="tutorial-step-title">æ¬¢è¿æ¥åˆ°ä¹ä¸ç”Ÿå­˜</h3>
          <p class="tutorial-step-content">åœ¨è¿™ä¸ªæ¸¸æˆä¸­ï¼Œä½ å°†æ‰®æ¼”ä¸€åå¤ä»£ä¹ä¸ï¼Œé€šè¿‡æ”¶é›†èµ„æºã€åˆ¶ä½œå·¥å…·å’Œåº”å¯¹å„ç§äº‹ä»¶æ¥ç”Ÿå­˜ä¸‹å»ã€‚</p>
          <p class="tutorial-step-content">æ¸¸æˆçš„æ ¸å¿ƒæ˜¯å¡ç‰Œç³»ç»Ÿï¼Œæ‰€æœ‰çš„èµ„æºã€åœ°ç‚¹ã€çŠ¶æ€å’Œè¡ŒåŠ¨éƒ½ä»¥å¡ç‰Œå½¢å¼å‘ˆç°ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep2">
          <h3 class="tutorial-step-title">èƒŒåŒ…ç®¡ç†</h3>
          <p class="tutorial-step-content">ä½ éœ€è¦ç®¡ç†èƒŒåŒ…ä¸­çš„å¤šç§ç‰©å“ï¼ŒåŒ…æ‹¬é£Ÿç‰©ã€é’±å¸ã€ææ–™å’Œå·¥å…·ã€‚è¿™äº›ç‰©å“å¯ä»¥é€šè¿‡æ¢ç´¢åœ°ç‚¹ã€ä¹è®¨æˆ–åˆ¶ä½œè·å¾—ã€‚</p>
          <p class="tutorial-step-content">æ³¨æ„ï¼šé£Ÿç‰©ä¼šéšç€æ—¶é—´æ¶ˆè€—ï¼Œä½ éœ€è¦ä¿æŒè¶³å¤Ÿçš„é£Ÿç‰©æ¥ç»´æŒç”Ÿå­˜ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep3">
          <h3 class="tutorial-step-title">å¡ç‰Œç»„åˆ</h3>
          <p class="tutorial-step-content">å°†ä¸åŒçš„å¡ç‰Œæ‹–æ”¾åˆ°ç»„åˆåŒºåŸŸå¯ä»¥åˆ›å»ºæ–°çš„ç‰©å“æˆ–æ‰§è¡Œç‰¹å®šè¡ŒåŠ¨ã€‚ä¾‹å¦‚ï¼š</p>
          <ul class="tutorial-step-content">
            <li>å°†"ç ´ç¢—"å’Œ"è¡—è§’"ç»„åˆå¯ä»¥è¿›è¡Œä¹è®¨</li>
            <li>å°†"æ®‹ç¾¹å‰©é¥­"å’Œ"ç ´ç¢—"ç»„åˆå¯ä»¥é£Ÿç”¨</li>
            <li>å°†"ç ´å¸ƒ"å’Œ"æœ¨æ£"ç»„åˆå¯ä»¥åˆ¶ä½œç®€æ˜“æ‹æ–</li>
          </ul>
          <p class="tutorial-step-content">å°è¯•ä¸åŒçš„ç»„åˆæ¥å‘ç°æ–°çš„é…æ–¹ï¼</p>
        </div>
        <div class="tutorial-step" id="tutorialStep4">
          <h3 class="tutorial-step-title">çŠ¶æ€ç®¡ç†</h3>
          <p class="tutorial-step-content">ä½ çš„è§’è‰²æœ‰å¤šç§çŠ¶æ€éœ€è¦å…³æ³¨ï¼š</p>
          <ul class="tutorial-step-content">
            <li>é¥¥é¥¿ï¼šéœ€è¦æ®‹ç¾¹å‰©é¥­æ¥ç¼“è§£</li>
            <li>å¯’å†·ï¼šéœ€è¦ä¿æš–ç‰©å“</li>
            <li>å¥åº·ï¼šé¿å…ç”Ÿç—…ï¼Œä¿æŒè‰¯å¥½çŠ¶æ€</li>
            <li>ç²¾ç¥ï¼šå½±å“ä½ çš„ä¹è®¨æ•ˆç‡å’Œå†³ç­–èƒ½åŠ›</li>
            <li>å£°æœ›ï¼šå½±å“NPCå¯¹ä½ çš„æ€åº¦å’Œå¯è®¿é—®çš„åœ°ç‚¹</li>
          </ul>
          <p class="tutorial-step-content">çŠ¶æ€è¿‡ä½ä¼šå½±å“ä½ çš„ç”Ÿå­˜èƒ½åŠ›ï¼Œç”šè‡³å¯¼è‡´æ­»äº¡ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep5">
          <h3 class="tutorial-step-title">æ¢ç´¢åœ°ç‚¹</h3>
          <p class="tutorial-step-content">ä¸åŒçš„åœ°ç‚¹æä¾›ä¸åŒçš„èµ„æºå’Œäº‹ä»¶ï¼š</p>
          <ul class="tutorial-step-content">
            <li>è¡—è§’ï¼šä¹è®¨çš„ä¸»è¦åœ°ç‚¹</li>
            <li>åƒåœ¾å †ï¼šå¯»æ‰¾é£Ÿç‰©æ®‹æ¸£å’Œææ–™</li>
            <li>å¯ºåº™ï¼šå¯ä»¥è·å¾—å…è´¹æ®‹ç¾¹å‰©é¥­å’Œä¼‘æ¯</li>
            <li>å¯ŒäººåŒºï¼šä¹è®¨æ•ˆç‡é«˜ä½†é£é™©å¤§</li>
            <li>è´«æ°‘çªŸï¼šä¸å…¶ä»–ä¹ä¸äº’åŠ¨</li>
          </ul>
          <p class="tutorial-step-content">ç‚¹å‡»åœ°ç‚¹å¡ç‰Œå¯ä»¥æ¢ç´¢è¯¥åœ°ç‚¹ï¼Œè·å¾—èµ„æºæˆ–è§¦å‘äº‹ä»¶ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep6">
          <h3 class="tutorial-step-title">æ—¶é—´ä¸å­£èŠ‚</h3>
          <p class="tutorial-step-content">æ¸¸æˆä»¥å›åˆåˆ¶è¿›è¡Œï¼Œæ¯ä¸ªå›åˆä»£è¡¨ä¸€å¤©ã€‚æ—¶é—´çš„æµé€ä¼šå½±å“ï¼š</p>
          <ul class="tutorial-step-content">
            <li>èµ„æºæ¶ˆè€—ï¼šæ®‹ç¾¹å‰©é¥­å’Œä¿æš–ç‰©å“ä¼šéšæ—¶é—´æ¶ˆè€—</li>
            <li>å­£èŠ‚å˜åŒ–ï¼šä¸åŒå­£èŠ‚æœ‰ä¸åŒçš„ç”Ÿå­˜æŒ‘æˆ˜</li>
            <li>äº‹ä»¶è§¦å‘ï¼šæŸäº›äº‹ä»¶åªåœ¨ç‰¹å®šæ—¶é—´æˆ–å­£èŠ‚å‘ç”Ÿ</li>
          </ul>
          <p class="tutorial-step-content">åˆç†è§„åˆ’ä½ çš„æ—¶é—´ï¼Œä¸ºå³å°†åˆ°æ¥çš„å­£èŠ‚åšå¥½å‡†å¤‡ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep7">
          <h3 class="tutorial-step-title">ç›®æ ‡ä¸ç»“å±€</h3>
          <p class="tutorial-step-content">æ¸¸æˆæœ‰å¤šç§å¯èƒ½çš„ç»“å±€ï¼Œå–å†³äºä½ çš„é€‰æ‹©å’Œè¡ŒåŠ¨ï¼š</p>
          <ul class="tutorial-step-content">
            <li>ç”Ÿå­˜ç»“å±€ï¼šå°½å¯èƒ½é•¿æ—¶é—´åœ°æ´»ä¸‹å»</li>
            <li>è´¢å¯Œç»“å±€ï¼šç§¯ç´¯è¶³å¤Ÿçš„è´¢å¯Œæ‘†è„±ä¹ä¸èº«ä»½</li>
            <li>å£°æœ›ç»“å±€ï¼šè·å¾—è¶³å¤Ÿçš„å£°æœ›æˆä¸ºä¹ä¸ä¹‹ç‹</li>
            <li>çŸ¥è¯†ç»“å±€ï¼šå­¦ä¹ è¶³å¤Ÿçš„æŠ€èƒ½æ‰¾åˆ°å·¥ä½œ</li>
            <li>æ­»äº¡ç»“å±€ï¼šå› é¥¥é¥¿ã€å¯’å†·ã€ç–¾ç—…æˆ–å…¶ä»–åŸå› æ­»äº¡</li>
          </ul>
          <p class="tutorial-step-content">ä½ çš„æ¯ä¸€ä¸ªé€‰æ‹©éƒ½ä¼šå½±å“æœ€ç»ˆçš„ç»“å±€ã€‚</p>
        </div>
        <div class="tutorial-step" id="tutorialStep8">
          <h3 class="tutorial-step-title">å¼€å§‹ä½ çš„ç”Ÿå­˜ä¹‹æ—…</h3>
          <p class="tutorial-step-content">ç°åœ¨ä½ å·²ç»äº†è§£äº†æ¸¸æˆçš„åŸºæœ¬æœºåˆ¶ï¼Œæ˜¯æ—¶å€™å¼€å§‹ä½ çš„ç”Ÿå­˜ä¹‹æ—…äº†ã€‚</p>
          <p class="tutorial-step-content">è®°ä½ï¼šåœ¨è¿™ä¸ªæ®‹é…·çš„ä¸–ç•Œä¸­ï¼Œæ¯ä¸€ä¸ªé€‰æ‹©éƒ½è‡³å…³é‡è¦ã€‚ç¥ä½ å¥½è¿ï¼</p>
        </div>
      </div>
      <div class="tutorial-navigation">
        <button class="tutorial-button" id="closeTutorialBtn">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆå®¹å™¨ -->
  <div class="game-container" id="gameContainer" style="display: none;">
    <!-- å¸®åŠ©æŒ‰é’® -->
    <button class="help-button" id="helpButton" style="position: absolute; top: 1rem; left: 1rem; background-color: rgba(255, 255, 255, 0.8); border: 1px solid #A0AEC0; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; cursor: pointer; z-index: 1000; color: #2D3748;">?</button>
    <!-- å¤´éƒ¨ -->
    <header class="header">
      <h1 class="header-title ink-text">ä¹ä¸ç”Ÿå­˜</h1>
      <div class="header-info">
        <div class="day-indicator">
          ç¬¬ <span class="day-number" id="dayNumber">1</span> å¤© <span class="time-of-day" id="timeOfDay">æ¸…æ™¨</span>
        </div>
        <div class="season-indicator">
          <span class="season-icon" id="seasonIcon">ğŸŒ±</span>
          <span id="seasonName">æ˜¥å­£</span>
        </div>
        <button id="startScreenSaveButton" class="status-button" style="padding: 0.5rem 1rem; background-color: #38A169; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: background-color 0.2s ease; margin-right: 0.5rem;">
          ä¿å­˜æ¸¸æˆè¿›åº¦
        </button>
        <button id="gameScreenLoadButton" class="status-button" onclick="handleLoadGame()" style="padding: 0.5rem 1rem; background-color: #DD6B20; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: background-color 0.2s ease; margin-right: 0.5rem;">
          åŠ è½½æ¸¸æˆè¿›åº¦
        </button>
        <!-- è¿”å›æŒ‰é’®å·²ç¦ç”¨ -->
      <!-- <button id="backToStartButton" onclick="handleBackToStart()" style="padding: 0.5rem 1rem; background-color: #718096; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: background-color 0.2s ease;">
            è¿”å›å¼€å§‹ç•Œé¢
          </button> -->
      </div>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-content">
      <!-- ä¾§è¾¹æ  -->
      <div class="sidebar">
        <!-- äººç‰©çŠ¶æ€åŒºåŸŸ -->
        <div class="sidebar-section ink-border">
          <h2 class="sidebar-section-title ink-text">äººç‰©çŠ¶æ€</h2>
          <!-- çŠ¶æ€æ æ§åˆ¶æŒ‰é’® -->
          <div class="status-controls" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: center;">
            <button id="equipmentButton" class="status-button" style="padding: 0.5rem 1rem; background-color: #4299E1; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: background-color 0.2s ease;">
              è£…å¤‡
            </button>
            <button id="skillsButton" class="status-button" style="padding: 0.5rem 1rem; background-color: #667EEA; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: background-color 0.2s ease;">
              æŠ€èƒ½
            </button>

          
            <!-- ä¸ºä¿å­˜å’ŒåŠ è½½æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ -->
            <script>
              // ç›´æ¥æ–¹æ³•ç»‘å®šäº‹ä»¶ï¼Œé¿å…DOMContentLoadedæ—¶æœºé—®é¢˜
              console.log('åˆå§‹åŒ–ä¿å­˜/åŠ è½½æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨');
              
              // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - åŒ…å«localStorageä¿å­˜å’Œæ–‡ä»¶ä¸‹è½½åŠŸèƒ½
              const saveBtn = document.getElementById('startScreenSaveButton');
              console.log('ä¿å­˜æŒ‰é’®å…ƒç´ :', saveBtn);
              
              if (saveBtn) {
                saveBtn.onclick = function() {
                  console.log('ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»');
                  try {
                    // å‡†å¤‡ä¿å­˜çš„æ•°æ®
                    const gameDataToSave = JSON.parse(JSON.stringify(gameData));
                    delete gameDataToSave.uiState;
                    delete gameDataToSave.tempData;
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('beggarSurvivalGameSave', JSON.stringify(gameDataToSave));
                    console.log('æ¸¸æˆè¿›åº¦å·²ä¿å­˜åˆ°localStorage');
                    
                    // ç”Ÿæˆæ–‡ä»¶ä¸‹è½½åŠŸèƒ½
                    const now = new Date();
                    const fileName = `beggar_survival_save_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}.json`;
                    const jsonStr = JSON.stringify(gameDataToSave, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    if (a.parentNode === document.body) {
        document.body.removeChild(a);
      }
                    URL.revokeObjectURL(url);
                    console.log('æ¸¸æˆè¿›åº¦å·²ç”Ÿæˆä¸‹è½½æ–‡ä»¶');
                    
                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                    if (typeof showNotification === 'function') {
                      showNotification('ä¿å­˜æˆåŠŸ', 'æ¸¸æˆè¿›åº¦å·²ä¿å­˜å¹¶ä¸‹è½½åˆ°æœ¬åœ°æ–‡ä»¶');
                    } else {
                      alert('æ¸¸æˆè¿›åº¦å·²ä¿å­˜å¹¶ä¸‹è½½åˆ°æœ¬åœ°æ–‡ä»¶');
                    }
                  } catch (error) {
                    console.error('ä¿å­˜æ¸¸æˆè¿›åº¦å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                  }
                };
                
                console.log('ä¿å­˜æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ï¼ŒåŒ…å«æ–‡ä»¶ä¸‹è½½åŠŸèƒ½');
              } else {
                console.error('ä¿å­˜æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°');
              }
              
              // åŠ è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
              const loadBtn = document.getElementById('startScreenLoadButton');
              console.log('åŠ è½½æŒ‰é’®å…ƒç´ :', loadBtn);
              
              if (loadBtn) {
                loadBtn.onclick = function() {
                  console.log('åŠ è½½æŒ‰é’®è¢«ç‚¹å‡»');
                  // ç›´æ¥åŠ è½½å­˜æ¡£ï¼Œä¸å†æ˜¾ç¤ºç¡®è®¤çª—å£
                  try {
                    const savedGameData = localStorage.getItem('beggarSurvivalGameSave');
                      if (savedGameData) {
                        const parsedData = JSON.parse(savedGameData);
                        
                        // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                        if (parsedData.day && parsedData.resources && parsedData.status) {
                          // æ¸…ç©ºå½“å‰gameDataå¹¶åŠ è½½ä¿å­˜çš„æ•°æ®
                          Object.keys(gameData).forEach(key => {
                            if (key !== 'uiState' && key !== 'tempData') {
                              delete gameData[key];
                            }
                          });
                          
                          // åˆå¹¶ä¿å­˜çš„æ•°æ®åˆ°gameData
                          Object.assign(gameData, parsedData);
                          
                          console.log('æ¸¸æˆè¿›åº¦å·²åŠ è½½');
                          
                          // æ›´æ–°UI
                          if (typeof updateGameData === 'function') updateGameData();
                          if (typeof renderResources === 'function') renderResources();
                          if (typeof renderLocations === 'function') renderLocations();
                          if (typeof renderActions === 'function') renderActions();
                          
                          if (typeof showNotification === 'function') {
                            showNotification('åŠ è½½æˆåŠŸ', 'æ¸¸æˆè¿›åº¦å·²æˆåŠŸåŠ è½½');
                          } else {
                            alert('æ¸¸æˆè¿›åº¦åŠ è½½æˆåŠŸ');
                          }
                        } else {
                          alert('å­˜æ¡£æ•°æ®æ ¼å¼æ— æ•ˆ');
                        }
                      } else {
                        alert('æœªæ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆè¿›åº¦');
                      }
                    } catch (error) {
                      console.error('åŠ è½½æ¸¸æˆè¿›åº¦å¤±è´¥:', error);
                      alert('åŠ è½½å¤±è´¥: ' + error.message);
                    }
                };
              }
            </script>
          </div>
          <div class="status-grid">
            <div class="card status">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  é¥¥é¥¿
                  <span class="status-percentage" id="hungerPercentage" style="font-size: 0.875rem;">50%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="hungerBar" style="width: 50%; background-color: #E53E3E;"></div>
                </div>
              </div>
            </div>
            <div class="card status">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  å¯’å†·
                  <span class="status-percentage" id="coldPercentage" style="font-size: 0.875rem;">60%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="coldBar" style="width: 60%; background-color: #3182CE;"></div>
                </div>
              </div>
            </div>
            <div class="card status">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  å¥åº·
                  <span class="status-percentage" id="healthPercentage" style="font-size: 0.875rem;">80%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="healthBar" style="width: 80%; background-color: #38A169;"></div>
                </div>
              </div>
            </div>
            <div class="card status">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  ç²¾ç¥
                  <span class="status-percentage" id="spiritPercentage" style="font-size: 0.875rem;">70%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="spiritBar" style="width: 70%; background-color: #805AD5;"></div>
                </div>
              </div>
            </div>
            <div class="card status">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  å£°æœ›
                  <span class="status-percentage" id="reputationPercentage" style="font-size: 0.875rem;">20%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="reputationBar" style="width: 20%; background-color: #D69E2E;"></div>
                </div>
              </div>
            </div>
            <div class="card status">
              <div class="card-content">
                <div class="card-title" style="font-size: 0.875rem;">
                  å£æ¸´
                  <span class="status-percentage" id="thirstPercentage" style="font-size: 0.875rem;">50%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-bar-fill" id="thirstBar" style="width: 50%; background-color: #3182CE;"></div>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- ä¸»è¦åŒºåŸŸ -->
      <div class="main-area">
        <!-- åœ°ç‚¹åŒºåŸŸ -->
        <div class="sidebar-section ink-border">
          <div class="flex justify-between items-center">
            <h2 class="sidebar-section-title ink-text">åœ°ç‚¹</h2>
            <div class="action-points-display">
              <span class="action-points-text">è¡ŒåŠ¨ç‚¹</span>
              <span class="action-points-value" id="actionPointsValue">3/3</span>
              <div class="action-points-bar-container">
                <div class="action-points-bar" id="actionPointsBar" style="width: 100%; background-color: #3182CE;"></div>
              </div>
            </div>
          </div>
          <div class="location-grid" id="locationGrid">
            <!-- åœ°ç‚¹å¡ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- è¡ŒåŠ¨åŒºåŸŸ -->
        <div class="sidebar-section ink-border">
          <h2 class="sidebar-section-title ink-text">è¡ŒåŠ¨</h2>
          <div class="action-grid" id="actionGrid">
            <!-- è¡ŒåŠ¨å¡ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>



        <!-- èƒŒåŒ…åŒºåŸŸ -->
        <div class="sidebar-section ink-border">
          <div class="flex justify-between items-center">
            <h2 class="sidebar-section-title ink-text">èƒŒåŒ…</h2>
            <button id="craftingButton" class="bg-purple-600 text-white px-3 py-2 rounded text-base hover:bg-purple-700">åˆ¶ä½œ</button>
          </div>
          
          <!-- åˆ†ç±»æ ‡ç­¾ -->
          <div class="inventory-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #E2E8F0; padding-bottom: 0.5rem;">
            <button class="inventory-tab active" data-category="all" style="padding: 0.25rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; background-color: #805AD5; color: white; cursor: pointer;">å…¨éƒ¨</button>
            <button class="inventory-tab" data-category="food" style="padding: 0.25rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; background-color: white; color: #4A5568; cursor: pointer;">é£Ÿç‰©</button>
            <button class="inventory-tab" data-category="material" style="padding: 0.25rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; background-color: white; color: #4A5568; cursor: pointer;">åŸºç¡€ææ–™</button>
            <button class="inventory-tab" data-category="equipment" style="padding: 0.25rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; background-color: white; color: #4A5568; cursor: pointer;">è£…å¤‡</button>
            <button class="inventory-tab" data-category="other" style="padding: 0.25rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; background-color: white; color: #4A5568; cursor: pointer;">å…¶å®ƒ</button>
          </div>
          
          <!-- èƒŒåŒ…ç½‘æ ¼ -->
          <div class="resource-grid" id="resourceGrid">
            <!-- èƒŒåŒ…ç‰©å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
          
          <!-- åˆ†é¡µæ§åˆ¶ -->
          <div class="inventory-pagination" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #E2E8F0;">
            <button id="prevPage" style="padding: 0.25rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; background-color: #F7FAFC; color: #4A5568; cursor: pointer;">ä¸Šä¸€é¡µ</button>
            <span id="pageInfo" style="font-size: 0.875rem; color: #4A5568;">ç¬¬ 1/1 é¡µ</span>
            <button id="nextPage" style="padding: 0.25rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; background-color: #F7FAFC; color: #4A5568; cursor: pointer;">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- äº‹ä»¶æ¨¡æ€æ¡† -->
  <div class="event-modal" id="eventModal">
    <div class="event-modal-content ink-border">
      <div class="event-modal-header">
        <h2 class="event-modal-title ink-text" id="eventTitle">äº‹ä»¶</h2>
        <button class="event-modal-close" id="closeEventButton">&times;</button>
      </div>
      <div class="event-modal-body">
        <p class="event-modal-text" id="eventText">äº‹ä»¶æè¿°å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
        <div class="event-modal-options" id="eventOptions">
          <!-- äº‹ä»¶é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <!-- é…æ–¹æ¨¡æ€æ¡† -->
  <div class="recipe-modal" id="recipeModal">
    <div class="recipe-modal-content ink-border">
      <div class="recipe-modal-header">
        <h2 class="recipe-modal-title ink-text">å·²çŸ¥é…æ–¹</h2>
        <button class="recipe-modal-close" id="closeRecipeButton">&times;</button>
      </div>
      <div class="recipe-grid" id="recipeGrid">
        <!-- é…æ–¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- åˆ¶ä½œçª—å£æ¨¡æ€æ¡† -->
  <div class="crafting-modal" id="craftingModal">
    <div class="crafting-modal-content ink-border">
      <div class="crafting-modal-header">
        <h2 class="crafting-modal-title ink-text">åˆ¶ä½œ</h2>
        <button class="crafting-modal-close" id="closeCraftingButton">&times;</button>
      </div>
      <div class="crafting-modal-body">
        <!-- å·¦ä¾§ï¼šèƒŒåŒ…å¡ç‰Œåˆ—è¡¨ -->
        <div class="crafting-left">
          <h3 class="crafting-section-title">èƒŒåŒ…å¡ç‰Œ</h3>
          <div class="crafting-inventory" id="craftingInventory">
            <!-- å¡ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        
        <!-- å³ä¾§ï¼šç»„åˆåŒºåŸŸ -->
        <div class="crafting-right">
          <h3 class="crafting-section-title">ç»„åˆåŒºåŸŸ</h3>
          <div class="crafting-buttons">
            <button class="crafting-button" id="craftButton" disabled>ç»„åˆ</button>
            <button class="crafting-button" id="craftRecipeButton">é…æ–¹</button>
          </div>
          <div class="crafting-slots" id="craftingSlots">
            <div class="crafting-slot" data-slot="1"></div>
            <div class="crafting-slot" data-slot="2"></div>
            <div class="crafting-slot" data-slot="3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆç»“æŸæ¨¡æ€æ¡† -->
  <div class="game-over-modal" id="gameOverModal">
    <div class="game-over-modal-content ink-border">
      <div class="game-over-modal-header">
        <h2 class="game-over-modal-title ink-text" id="gameOverTitle">æ¸¸æˆç»“æŸ</h2>
      </div>
      <div class="game-over-modal-body">
        <p class="game-over-modal-text" id="gameOverText">æ¸¸æˆç»“æŸåŸå› å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
        <div class="game-over-stats">
          <h3 class="game-over-stats-title">ç”Ÿå­˜ç»Ÿè®¡</h3>
          <div class="game-over-stats-grid">
            <div class="game-over-stat">
              <span>ç”Ÿå­˜å¤©æ•°ï¼š</span>
              <span class="game-over-stat-value" id="daysSurvived">0</span>
            </div>
            <div class="game-over-stat">
              <span>æœ€é«˜å£°æœ›ï¼š</span>
              <span class="game-over-stat-value" id="maxReputation">0%</span>
            </div>
            <div class="game-over-stat">
              <span>æ”¶é›†èµ„æºï¼š</span>
              <span class="game-over-stat-value" id="resourcesCollected">0</span>
            </div>
            <div class="game-over-stat">
              <span>å‘ç°é…æ–¹ï¼š</span>
              <span class="game-over-stat-value" id="recipesDiscovered">0</span>
            </div>
          </div>
        </div>
        <div class="game-over-modal-options">
          <button class="game-over-button" id="restartGameButton">é‡æ–°å¼€å§‹</button>
          <button class="game-over-button" id="exitGameButton">é€€å‡ºæ¸¸æˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥ -->
  <div class="notification" id="notification">
    <button class="notification-close" id="closeNotificationButton">&times;</button>
    <h3 class="notification-title" id="notificationTitle">é€šçŸ¥</h3>
    <p class="notification-message" id="notificationMessage">é€šçŸ¥å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
    <div class="notification-actions">
      <button class="notification-button" id="notificationOKButton">çŸ¥é“äº†</button>
    </div>
  </div>

  <!-- æˆå°±é€šçŸ¥ -->
  <div class="achievement-modal" id="achievementModal">
    <div class="achievement-icon">
      <i class="fa fa-trophy" aria-hidden="true"></i>
    </div>
    <div class="achievement-content">
      <h3 class="achievement-title" id="achievementTitle">æˆå°±è§£é”</h3>
      <p class="achievement-description" id="achievementDescription">æˆå°±æè¿°å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
    </div>
    <button class="achievement-close" id="closeAchievementButton">&times;</button>
  </div>

  <script>
    // æ¸¸æˆæ•°æ®
    const gameData = {
      day: 1,
      timeOfDay: 'early_morning', // early_morning, morning, afternoon, evening, night
      timeTurns: 0, // å½“å‰æ—¶é—´æ®µçš„å›åˆæ•°
      season: 'spring', // spring, summer, autumn, winter
      begging_chance: 0, // ä¹è®¨æˆåŠŸç‡åŠ æˆ
      fastingDayClaimed: false, // æ”¾æ–‹æ—¥æ˜¯å¦å·²ç»é¢†å–è¿‡ç‰©å“
      combinationSlots: { 0: null, 1: null, 2: null, 3: null },
      resources: {
        'food': { name: 'æ®‹ç¾¹å‰©é¥­', description: 'ä¹è®¨æˆ–æœå¯»è·å¾—çš„é£Ÿç‰©æ®‹æ¸£ï¼Œè™½ç„¶èƒ½ç¼“è§£é¥¥é¥¿ï¼Œä½†å¯èƒ½å½±å“å¥åº·', amount: 0, image: 'UI/æ®‹ç¾¹å‰©é¥­.jpg', type: 'consumable', category: 'food' },
        'money': { name: 'é’±å¸', amount: 0, image: 'UI/é’±å¸.jpg', category: 'material' },
        'cloth': { name: 'ç ´å¸ƒ', amount: 0, image: 'UI/ç ´å¸ƒ.jpg', category: 'material' },
        'stick': { name: 'æœ¨æ£', amount: 0, image: 'UI/æœ¨æ£.jpg', category: 'material' },
        'paper': { name: 'åºŸçº¸', amount: 0, image: 'UI/åºŸçº¸.jpg', category: 'material' },
        'bowl': { name: 'ç ´ç¢—', amount: 1, image: 'UI/ç ´ç¢—.jpg', category: 'material' },
        'medicine': { name: 'çµè¯', description: 'çè´µçš„è‰è¯ï¼Œèƒ½æ¢å¤å¤§é‡å¥åº·', amount: 0, image: 'UI/çµè¯.jpg', type: 'consumable', category: 'food' },

        'fine_clothes': { name: 'ç²¾ç¾åæœ', description: 'é«˜æ¡£çš„ä¸ç»¸æœè£…ï¼Œå¤§å¹…æå‡å£°æœ›å’Œä¿æš–åº¦', amount: 0, image: 'UI/ç²¾ç¾åæœ.jpg', equipmentSlot: 'clothes', durability: 100 },
        'silk_shoes': { name: 'ç¼é‹', description: 'ç²¾è‡´çš„ä¸ç¼é‹å­ï¼Œæå‡å¥åº·åº¦å’Œä¿æš–åº¦', amount: 0, image: 'UI/ç¼é‹.jpg', equipmentSlot: 'shoes', durability: 100 },
        'ornate_shoes': { name: 'é”¦å±¥', description: 'åä¸½çš„é”¦ç¼é‹å­ï¼Œå¤§å¹…æå‡å£°æœ›å’Œå¥åº·åº¦', amount: 0, image: 'UI/é”¦å±¥.jpg', equipmentSlot: 'shoes', durability: 100, category: 'equipment' },
        'dog_beating_stick': { name: 'æ‰“ç‹—æ£’æ³•', description: 'ä¸å¸®é•‡å¸®ä¹‹å®ï¼Œå­¦ä¹ åæå‡æ­¦æœ¯æŠ€èƒ½', amount: 0, image: 'UI/æ‰“ç‹—æ£’æ³•.jpg', type: 'learnable', skill: 'martial', oneTimeUse: true, cannotDrop: true, category: 'other' },
        'herbal_manual': { name: 'æœ¬è‰çº²ç›®', description: 'å¤ä»£åŒ»å­¦åè‘—ï¼Œå­¦ä¹ åæå‡åŒ»æœ¯æŠ€èƒ½å¹¶èƒ½è¯†åˆ«è‰è¯', amount: 0, image: 'UI/æœ¬è‰çº²ç›®.jpg', type: 'learnable', skill: 'medicine', oneTimeUse: true, cannotDrop: true, category: 'other' },
        'huangdi_canon': { name: 'é»„å¸å†…ç»', description: 'ä¸­åŒ»ç»å…¸è‘—ä½œï¼Œå­¦ä¹ åæå‡åŒ»æœ¯æŠ€èƒ½å¹¶èƒ½æ²»ç–—ç–¾ç—…', amount: 0, image: 'UI/é»„å¸å†…ç».jpg', type: 'learnable', skill: 'medicine', oneTimeUse: true, cannotDrop: true, category: 'other' },
        'stealth_book': { name: 'å·å¤©æ¢æ—¥', description: 'ç›—çªƒæŠ€å·§ç§˜ç±ï¼Œå­¦ä¹ åæå‡å·çªƒæŠ€èƒ½', amount: 0, image: 'UI/å·å¤©æ¢æ—¥.jpg', type: 'learnable', skill: 'steal', oneTimeUse: true, cannotDrop: true, category: 'other' },
        
        'simple_clothes': { name: 'ç ´è¡£æœ', amount: 0, image: 'UI/ç ´è¡£æœ.jpg', equipmentSlot: 'clothes', durability: 100, category: 'equipment' },
        'flint': { name: 'ç‡§çŸ³', amount: 0, image: 'UI/ç‡§çŸ³.jpg', category: 'material' },
        'mud': { name: 'æ³¥å·´', amount: 0, image: 'UI/æ³¥å·´.jpg', category: 'material' },
        'fire': { name: 'ç¯ç«', amount: 0, image: 'UI/ç¯ç«.jpg', category: 'equipment' },
        'extinguished_fire': { name: 'ç¯ç«ï¼ˆå·²ç†„ç­ï¼‰', amount: 0, image: 'UI/ç¯ç«ï¼ˆå·²ç†„ç­ï¼‰.jpg', category: 'equipment' },
        'clay_bowl': { name: 'æ³¥ç¢—', amount: 0, image: 'UI/æ³¥ç¢—.jpg', category: 'material' },
        'crutch': { name: 'æ‹æ–', amount: 0, image: 'UI/æ‹æ–.jpg', equipmentSlot: 'weapon', durability: 100, category: 'equipment' },
        'gold_bar': { name: 'é‡‘æ¡', amount: 0, image: 'UI/é‡‘æ¡.jpg', category: 'material' },
        'black_cloth': { name: 'é»‘å¸ƒ', amount: 0, image: 'UI/é»‘å¸ƒ.jpg', category: 'material' },
        'hide': { name: 'å…½çš®', description: 'åŠ¨ç‰©çš„çš®æ¯›ï¼Œå¯ä»¥ç”¨æ¥åˆ¶ä½œä¿æš–è¡£ç‰©å’Œå®¹å™¨', amount: 0, image: 'UI/å…½çš®.jpg', category: 'material', skillRequirement: { 'hunting': 5 } },
        'thread': { name: 'çº¿å›¢', amount: 0, image: 'UI/çº¿å›¢.jpg', category: 'material' },
        'water_bag': { name: 'æ°´è¢‹ï¼ˆæ»¡ï¼‰', description: 'å¯ä»¥å‚¨å­˜æ°´åˆ†ï¼Œå‡å°‘å£æ¸´å¸¦æ¥çš„è´Ÿé¢å½±å“', amount: 0, image: 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg', durability: 100, category: 'food', type: 'consumable' },
        'empty_water_bag': { name: 'æ°´è¢‹ï¼ˆç©ºï¼‰', description: 'ç©ºçš„æ°´è¢‹ï¼Œéœ€è¦å¯»æ‰¾æ°´æºæ¥è£…æ»¡å®ƒ', amount: 0, image: 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg', durability: 100, category: 'material', type: 'container', cannotDrop: false },
        'black_cloak': { name: 'é»‘è‰²æ–—ç¯·', amount: 0, image: 'UI/é»‘è¡£æ–—ç¯·.jpg', equipmentSlot: 'special', durability: 100, category: 'equipment' },
        'slave': { name: 'å¥´éš¶', amount: 0, image: 'UI/å¥´éš¶.svg', category: 'other' },
        'shoes': { name: 'ç ´é‹', description: 'ç ´æ—§çš„é‹å­ï¼Œæä¾›åŸºæœ¬çš„è„šéƒ¨ä¿æŠ¤', amount: 0, image: 'UI/ç ´é‹.jpg', equipmentSlot: 'shoes', durability: 100 },
        'cornbread': { name: 'çªçªå¤´', description: 'ç²—ç³™çš„è°·ç‰©åˆ¶å“ï¼Œèƒ½æä¾›è¾ƒå¥½çš„é¥±è…¹æ„Ÿ', amount: 0, image: 'UI/çªçªå¤´.jpg', type: 'consumable', category: 'food' },
        'porridge': { name: 'ç¨€ç²¥', description: 'å¯ºåº™å‘æ”¾çš„æ–‹ç²¥ï¼Œä½¿ç”¨åå¢åŠ 20é¥±é£Ÿåº¦', amount: 0, image: 'UI/ç¨€ç²¥.jpg', type: 'consumable', category: 'food' },
        // æ–°å¢èµ„æºå®šä¹‰
        'herb': { name: 'è‰è¯', description: 'å¯ä»¥ç”¨æ¥åˆ¶ä½œè¯å“çš„æ¤ç‰©', amount: 0, image: 'UI/è‰è¯.jpg', category: 'material' },
        'pill': { name: 'è¯ä¸¸', description: 'ç”±è‰è¯åˆ¶æˆçš„è¯å“ï¼Œå¯æ¢å¤å¤§é‡å¥åº·', amount: 0, image: 'UI/è¯ä¸¸.jpg', type: 'consumable', category: 'food' },
        'bamboo': { name: 'ç«¹å­', description: 'åšéŸ§çš„ç«¹å­ï¼Œå¯ç”¨äºåˆ¶ä½œå·¥å…·å’Œæ­¦å™¨', amount: 0, image: 'UI/ç«¹å­.jpg', category: 'material' },
        'bamboo_bow': { name: 'ç«¹å¼“', description: 'ç”¨ç«¹å­å’Œç‰›ç­‹åˆ¶æˆçš„å¼“ï¼Œæ”»å‡»åŠ›å¼º', amount: 0, image: 'UI/ç«¹å¼“.jpg', equipmentSlot: 'weapon', durability: 100, damage: 10, hitRate: 10, category: 'equipment' },
        'cow_tendon': { name: 'ç‰›ç­‹', description: 'åšéŸ§çš„ç‰›ç­‹ï¼Œç”¨äºåˆ¶ä½œå¼“å¼¦ç­‰', amount: 0, image: 'UI/ç‰›ç­‹.jpg', category: 'material' },
        'wild_buffalo': { name: 'é‡ç‰›', description: 'é‡ç”Ÿçš„æ°´ç‰›ï¼Œå¯ä»¥è·å–ç”Ÿè‚‰å’Œç‰›ç­‹', amount: 0, image: 'UI/é‡ç‰›.jpg', category: 'other' },
        'raw_meat': { name: 'ç”Ÿè‚‰', description: 'æœªåŠ å·¥çš„è‚‰ç±»ï¼Œéœ€è¦çƒ¹é¥ªåé£Ÿç”¨', amount: 0, image: 'UI/ç”Ÿè‚‰.jpg', type: 'consumable', category: 'food' },
        'cooked_meat': { name: 'ç†Ÿè‚‰', description: 'çƒ¹é¥ªåçš„è‚‰ç±»ï¼Œæä¾›ä¸°å¯Œçš„è¥å…»', amount: 0, image: 'UI/ç†Ÿè‚‰.jpg', type: 'consumable', category: 'food' },
        'porcelain_bowl': { name: 'ç“·ç¢—', description: 'ç²¾è‡´çš„ç“·ç¢—ï¼Œå¤§å¹…æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/ç“·ç¢—.jpg', category: 'material' },


        'pottery_bowl': { name: 'é™¶ç¢—', description: 'åšå›ºçš„é™¶ç¢—ï¼Œæé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é™¶ç¢—.jpg', category: 'material' },


        'silver_bowl': { name: 'é“¶ç¢—', description: 'çè´µçš„é“¶ç¢—ï¼Œæ˜¾è‘—æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é“¶ç¢—.jpg', category: 'material' },


        'gold_bowl': { name: 'é‡‘ç¢—', description: 'å¥¢åçš„é‡‘ç¢—ï¼Œæå¤§æé«˜ä¹è®¨æˆåŠŸç‡å’Œå£°æœ›', amount: 0, image: 'UI/é‡‘ç¢—.jpg', category: 'material' },


          'land_deed': { name: 'æˆ¿å±‹åœ°å¥‘', description: 'æ‹¥æœ‰æˆ¿äº§çš„è¯æ˜ï¼Œå¯å¤§å¹…æå‡å£°æœ›', amount: 0, image: 'UI/æˆ¿å±‹åœ°å¥‘.jpg', category: 'other' },
          'fine_clothes': { name: 'ç²¾ç¾åæœ', description: 'åä¸½çš„æœé¥°ï¼Œæå‡å£°æœ›å’Œä¿æš–åº¦', amount: 0, image: 'UI/ç²¾ç¾åæœ.jpg', equipmentSlot: 'clothes', durability: 100, category: 'equipment' },
          'silk_shoes': { name: 'ç¼é‹', description: 'ç²¾è‡´çš„ç¼é¢é‹å­ï¼Œæå‡å¥åº·å’Œä¿æš–åº¦', amount: 0, image: 'UI/ç¼é‹.jpg', equipmentSlot: 'shoes', durability: 100, category: 'equipment' },
          'dog_beating_stick': { name: 'æ‰“ç‹—æ£’æ³•', description: 'ä¸å¸®é•‡å¸®ä¹‹å®ï¼Œå­¦ä¹ åæå‡æ­¦æœ¯æŠ€èƒ½', amount: 0, image: 'UI/æ‰“ç‹—æ£’æ³•.jpg', type: 'learnable', skill: 'martial', oneTimeUse: true, cannotDrop: true },
          'huangdi_canon': { name: 'é»„å¸å†…ç»', description: 'ä¸­åŒ»ç»å…¸è‘—ä½œï¼Œå­¦ä¹ åæå‡åŒ»æœ¯æŠ€èƒ½å¹¶èƒ½æ²»ç–—ç–¾ç—…', amount: 0, image: 'UI/é»„å¸å†…ç».jpg', type: 'learnable', skill: 'medicine', oneTimeUse: true, cannotDrop: true },
      },
      status: {
        hunger: 50, // 0-100, è¶Šä½è¶Šé¥¿
        cold: 60,   // 0-100, è¶Šä½è¶Šå†·
        health: 80, // 0-100, è¶Šä½è¶Šä¸å¥åº·
        spirit: 70, // 0-100, è¶Šä½ç²¾ç¥è¶Šå·®
        reputation: 20, // 0-100, è¶Šé«˜å£°æœ›è¶Šå¥½
        thirst: 50, // 0-100, è¶Šä½è¶Šå£æ¸´
        actionPoints: 20 // è¡ŒåŠ¨ç‚¹ï¼Œæ¯å›åˆé‡ç½®
      },
      skills: {
        steal: { level: 0, experience: 0, maxLevel: 10, name: 'å·çªƒ' },
        medicine: { level: 0, experience: 0, maxLevel: 10, name: 'åŒ»æœ¯' },
        martial: { level: 0, experience: 0, maxLevel: 10, name: 'æ­¦æœ¯', power: 10 }, // åŸºç¡€æ­¦åŠ›å€¼10
        search: { level: 0, experience: 0, maxLevel: 10, name: 'æœå¯»' } // æœå¯»æŠ€èƒ½
      },
      buffs: {},
      skillExpRequired: [0, 10, 30, 60, 100, 150, 210, 280, 360, 450, 550], // æ¯çº§å‡çº§æ‰€éœ€ç»éªŒ
      locations: [
        { 
          id: 'street', 
          name: 'è¡—è§’', 
          description: 'ä¹è®¨çš„ä¸»è¦åœ°ç‚¹ï¼Œäººæµé‡å¤§ä½†ç«äº‰æ¿€çƒˆã€‚', 
          image: 'https://p3-doubao-search-sign.byteimg.com/tos-cn-i-be4g95zd3a/1875283275294965772~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779775073&x-signature=Ns4kPmfT0VNZHlYbsgjP8WonINw%3D', 
          available: true,
          resourceType: 'money,food',
          dangerLevel: 'low',
          actionPointCost: 1,
          entryCondition: { reputation: { min: 0 } },
          currentLocation: true,
          actions: ['beg', 'search', 'rest', 'get_water'],
          nightActions: ['beg', 'search', 'rest', 'get_water', 'talk_mystery']
        },
        { 
          id: 'dump', 
          name: 'åƒåœ¾å †', 
          description: 'å¯»æ‰¾é£Ÿç‰©æ®‹æ¸£å’Œæœ‰ä»·å€¼åƒåœ¾çš„åœ°æ–¹ï¼Œä½†å«ç”Ÿæ¡ä»¶å·®ã€‚', 
          image: 'https://p11-doubao-search-sign.byteimg.com/tos-cn-i-be4g95zd3a/1891662742987997192~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779775073&x-signature=iQ53iAOLjywrirYpIoakFVVQQdM%3D', 
          available: true,
          resourceType: 'food,cloth,stick,paper,flint,mud,hide',
          dangerLevel: 'medium',
          actionPointCost: 1,
          entryCondition: { health: { min: 30 } },
          actions: ['loot', 'rest']
        },
        { 
          id: 'temple', 
          name: 'å¯ºåº™', 
          description: 'å¯ä»¥è·å¾—å…è´¹çš„é£Ÿç‰©å’Œä½å®¿ï¼Œä½†éœ€è¦éµå®ˆå¯ºåº™çš„è§„çŸ©ã€‚', 
          image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/f07095c0845f45eb8418958180ca3e77~tplv-a9rns2rl98-image.image?rcl=2025112713573750E6BFCA1E0AE0134FF3&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1766815101&x-signature=dENyJs1JB5ZSEtSIkWe9oq4a8us%3D', 
          available: true,
          resourceType: 'food,spirit',
          dangerLevel: 'low',
          actionPointCost: 1,
          entryCondition: { reputation: { min: 10 } },
          actions: ['pray', 'rest', 'fasting_day']
        },
        { 
          id: 'rich_area', 
          name: 'å¯ŒäººåŒº', 
          description: 'ä¹è®¨æ•ˆç‡é«˜ï¼Œä½†é£é™©ä¹Ÿé«˜ï¼Œå®¹æ˜“è¢«é©±èµ¶ã€‚', 
          image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/f07095c0845f45eb8418958180ca3e77~tplv-a9rns2rl98-image.image?rcl=2025112713573750E6BFCA1E0AE0134FF3&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1766815101&x-signature=dENyJs1JB5ZSEtSIkWe9oq4a8us%3D', 
          available: true,
          resourceType: 'money,black_cloth,thread',
          dangerLevel: 'high',
          actionPointCost: 1,
          entryCondition: { reputation: { min: 30 } },
          actions: ['beg', 'steal', 'search', 'rest']
        },
        { 
          id: 'black_market', 
          name: 'é»‘å¸‚', 
          description: 'å¯ä»¥ç”¨é‡‘æ¡è´­ä¹°ç¨€æœ‰ç‰©å“çš„ç§˜å¯†å¸‚åœºã€‚', 
          image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/f07095c0845f45eb8418958180ca3e77~tplv-a9rns2rl98-image.image?rcl=2025112713573750E6BFCA1E0AE0134FF3&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1766815101&x-signature=dENyJs1JB5ZSEtSIkWe9oq4a8us%3D', 
          available: false,
          resourceType: 'gold_bar',
          dangerLevel: 'very_high',
          actionPointCost: 2,
          entryCondition: {}, // ç§»é™¤é»‘è‰²æ–—ç¯·ä½œä¸ºè§£é”æ¡ä»¶
          actions: ['buy_goods', 'open_black_market_shelf', 'rest']
        },
        { 
          id: 'slum', 
          name: 'è´«æ°‘çªŸ', 
          description: 'èšé›†ç€å…¶ä»–ä¹ä¸ï¼Œå¯ä»¥è¿›è¡Œäº¤æ˜“å’Œåˆä½œã€‚', 
          image: 'https://p26-doubao-search-sign.byteimg.com/labis/image/ca34eef8faf2eaaa278d2cc70942e1fe~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779775073&x-signature=8D1SWhJmDtjETZt3j6%2BXhlYMVbM%3D', 
          available: true,
          resourceType: 'cloth,stick',
          dangerLevel: 'medium',
          actionPointCost: 1,
          entryCondition: { reputation: { min: 0 } },
          actions: ['learn', 'rest'] // æš‚æ—¶æ³¨é‡Šæ‰äº¤æ˜“åŠŸèƒ½ï¼ŒåæœŸå†è¡¥å……
        },
        { 
          id: 'prison', 
          name: 'ç‰¢æˆ¿', 
          description: 'ä½ å› çŠ¯ç½ªè¢«å…³æŠ¼åœ¨è¿™é‡Œï¼Œéœ€è¦é€šè¿‡åŠ³ä½œæ¥è·å¾—è‡ªç”±ã€‚', 
          image: 'https://p3-doubao-search-sign.byteimg.com/labis/981395494749454942549425~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779775073&x-signature=8D1SWhJmDtjETZt3j6%2BXhlYMVbM%3D', 
          available: false,
          resourceType: '',
          dangerLevel: 'high',
          actionPointCost: 0,
          entryCondition: {},
          actions: ['work', 'gamble', 'rest'],
          sentenceDays: 0 // å‰©ä½™åˆ‘æœŸ
        },
        { 
          id: 'wilderness', 
          name: 'åŸå¤–å±±é‡', 
          description: 'è¿œç¦»åŸå¸‚å–§åš£çš„éƒŠå¤–ï¼Œæœ‰æ¸…æ¾ˆçš„æºªæ°´å’ŒèŒ‚å¯†çš„å±±æ—ã€‚', 
          image: '', 
          available: true,
          resourceType: 'herb,raw_meat',
          dangerLevel: 'medium',
          actionPointCost: 2,
          entryCondition: { health: { min: 30 } },
          actions: ['stream_action', 'mountain_action']
        }
      ],
      actions: [
        { id: 'beg', name: 'ä¹è®¨', description: 'å°è¯•å‘è·¯äººä¹è®¨ï¼Œå¯èƒ½è·å¾—æ®‹ç¾¹å‰©é¥­ã€çªçªå¤´æˆ–é’±å¸ã€‚æ‹¥æœ‰æ›´å¥½çš„ç¢—å¯ä»¥æé«˜æˆåŠŸç‡ã€‚', requires: {}, success: { food: 1, cornbread: 1, money: 1 }, failure: { spirit: -5 } },
        { id: 'search', name: 'æœå¯»', description: 'åœ¨é™„è¿‘æœå¯»æœ‰ç”¨çš„ç‰©å“ï¼Œå¯èƒ½è·å¾—ææ–™ã€‚', requires: {}, success: { cloth: 1, stick: 1, paper: 1, flint: 1, mud: 1, black_cloth: 1, thread: 1 }, failure: { health: -5 } },
        { id: 'loot', name: 'ç¿»åƒåœ¾', description: 'åœ¨åƒåœ¾æ¡¶å†…ç¿»æ‰¾ç‰©å“ï¼Œéœ€è¦ç©ä¸€ä¸ªå°æ¸¸æˆæ¥å†³å®šè·å¾—çš„ç‰©å“ã€‚', requires: {}, success: {}, failure: {} },
        { id: 'rest', name: 'ä¼‘æ¯', description: 'æ‰¾ä¸ªåœ°æ–¹ä¼‘æ¯ï¼Œæ¢å¤ç²¾ç¥å’Œå¥åº·ã€‚', requires: {}, success: { spirit: 10, health: 5 }, failure: { hunger: -10, cold: -10 } },
        { id: 'steal', name: 'å·çªƒ', description: 'å°è¯•å·çªƒä»–äººè´¢ç‰©ï¼Œé«˜é£é™©é«˜å›æŠ¥ã€‚', requires: {}, success: { money: 3 }, failure: { health: -15 } },
        { id: 'fasting_day', name: 'æ”¾æ–‹æ—¥', description: 'å¯ºåº™å‘æ”¾æ–‹é¥­çš„æ—¥å­ï¼Œè·å¾—çªçªå¤´å’Œç¨€ç²¥ã€‚', requires: {}, success: { cornbread: 1, porridge: 1 }, failure: {} },
        { id: 'pray', name: 'ç¥ˆç¦', description: 'åœ¨å¯ºåº™ç¥ˆç¥·ï¼Œæå‡ç²¾ç¥å’Œå£°æœ›ã€‚', requires: {}, success: { spirit: 15, reputation: 5 }, failure: { spirit: -5 } },
        { id: 'trade', name: 'äº¤æ˜“', description: 'ä¸å…¶ä»–ä¹ä¸äº¤æ¢ç‰©èµ„ã€‚', requires: {}, success: { cloth: 2, stick: 1 }, failure: { cloth: -1, stick: -1 } },
        { id: 'learn', name: 'å­¦ä¹ ', description: 'å‘é«˜çº§ä¹ä¸å­¦ä¹ æŠ€èƒ½ï¼Œæå‡åˆ¶ä½œèƒ½åŠ›ã€‚', requires: {}, success: { reputation: 10 }, failure: { spirit: -10 } },

        { id: 'work', name: 'åŠ³ä½œ', description: 'åœ¨ç‰¢æˆ¿ä¸­åŠ³åŠ¨ï¼Œå¯èƒ½è·å¾—å°‘é‡æ®‹ç¾¹å‰©é¥­æˆ–é’±å¸ï¼Œä½†ä¼šé™ä½å¥åº·ã€‚', requires: {}, success: { food: 1, money: 1 }, failure: { health: -10 } },
        { id: 'gamble', name: 'èµŒåš', description: 'åœ¨ç‰¢æˆ¿ä¸­ä¸å…¶ä»–å›šçŠ¯èµŒåšï¼Œé«˜é£é™©é«˜å›æŠ¥ã€‚', requires: {}, success: { money: 5 }, failure: { money: -2, spirit: -10 } },
        { id: 'buy_medicine', name: 'è´­ä¹°çµè¯', description: 'ç”¨é‡‘æ¡è´­ä¹°çè´µçš„çµè¯ï¼Œæ¢å¤å¤§é‡å¥åº·ã€‚', requires: { gold_bar: 1 }, success: { health: 50 }, failure: {} },
        { id: 'buy_goods', name: 'è´­ä¹°è´§ç‰©', description: 'æµè§ˆé»‘å¸‚è´§æ¶ï¼Œç”¨é‡‘æ¡è´­ä¹°å„ç§ç¨€æœ‰å•†å“ã€‚', requires: {}, success: {}, failure: {} },
        { id: 'buy_slave', name: 'è´­ä¹°å¥´éš¶', description: 'ç”¨é‡‘æ¡è´­ä¹°å¥´éš¶ï¼Œè‡ªåŠ¨å¸®ä½ æ”¶é›†èµ„æºã€‚', requires: { gold_bar: 3 }, success: { slave: 1 }, failure: {} },
        { id: 'talk_mystery', name: 'ä¸ç¥ç§˜äººå¯¹è¯', description: 'åœ¨å¤œæ™šçš„è¡—è§’ä¸ç¥ç§˜äººå¯¹è¯ï¼Œå¯èƒ½è·å¾—é»‘å¸‚çš„æ¶ˆæ¯ã€‚', requires: {}, success: {}, failure: {} },
        { id: 'get_water', name: 'æ‰“æ°´å–', description: 'åœ¨é™„è¿‘çš„æ°´äº•ä¸­è·å–æ°´ã€‚', requires: {}, success: {}, failure: {} },
        { id: 'stream_action', name: 'æºªè¾¹', description: 'æ¥åˆ°æ¸…æ¾ˆçš„æºªè¾¹ï¼Œå¯ä»¥å–æ°´ã€è£…æ°´æˆ–æ‘¸é±¼ã€‚', requires: {}, success: {}, failure: {} },
        { id: 'mountain_action', name: 'è¿›å±±', description: 'è¿›å…¥èŒ‚å¯†çš„å±±æ—ï¼Œæ¢ç´¢å¤§è‡ªç„¶çš„å®è—ã€‚', requires: {}, success: {}, failure: {} }
      ],
      recipes: [
        { id: 'pill', name: 'è¯ä¸¸', description: '3ä¸ªè‰è¯åˆæˆ1ä¸ªè¯ä¸¸ï¼Œæ¢å¤40%å¥åº·åº¦', ingredients: { herb: 3 }, result: { pill: 1 } },
        { id: 'bamboo_bow', name: 'ç«¹å¼“', description: '2ä¸ªç«¹å­åŠ 1ä¸ªç‰›ç­‹åˆæˆ1ä¸ªç«¹å¼“ï¼Œæ”»å‡»+10ï¼Œå‘½ä¸­ç‡+10%', ingredients: { bamboo: 2, cow_tendon: 1 }, result: { bamboo_bow: 1 } },
        { id: 'clay_bowl', name: 'æ³¥ç¢—', description: 'æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { bowl: 1, mud: 2 }, result: { clay_bowl: 1, reputation: 5, begging_chance: 10 } },
        { id: 'ceramic_bowl', name: 'é™¶ç¢—', description: 'è¿›ä¸€æ­¥æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { clay_bowl: 1, clay: 2 }, result: { ceramic_bowl: 1, reputation: 10, begging_chance: 20 } },
        { id: 'silver_bowl', name: 'é“¶ç¢—', description: 'å¤§å¹…æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { ceramic_bowl: 1, silver_coin: 2 }, result: { silver_bowl: 1, reputation: 20, begging_chance: 30 } },
        { id: 'gold_bowl', name: 'é‡‘ç¢—', description: 'æå¤§æé«˜ä¹è®¨æˆåŠŸç‡', ingredients: { silver_bowl: 1, gold: 2 }, result: { gold_bowl: 1, reputation: 30, begging_chance: 40 } },
        { id: 'simple_clothes', name: 'ç ´è¡£æœ', description: 'æä¾›åŸºæœ¬çš„ä¿æš–', ingredients: { cloth: 3 }, result: { simple_clothes: 1, cold: 10 } },
        { id: 'crutch', name: 'æ‹æ–', description: 'æé«˜ç§»åŠ¨èƒ½åŠ›å’Œå£°æœ›', ingredients: { stick: 1, cloth: 2 }, result: { crutch: 1, reputation: 10 } },
        { id: 'fire', name: 'ç¯ç«', description: 'æä¾›æ¸©æš–ï¼Œçƒ¹é¥ªé£Ÿç‰©', ingredients: { stick: 2, flint: 1 }, result: { fire: 1, cold: 20, health: 5 } },
        { id: 'black_cloak', name: 'é»‘è‰²æ–—ç¯·', description: 'ç”¨äºè¿›å…¥é»‘å¸‚çš„ç‰¹æ®Šè¡£ç‰©', ingredients: { black_cloth: 2, thread: 1 }, result: { black_cloak: 1 } },
        { id: 'empty_water_bag', name: 'æ°´è¢‹ï¼ˆç©ºï¼‰', description: 'ç©ºçš„æ°´è¢‹ï¼Œéœ€è¦å¯»æ‰¾æ°´æºæ¥è£…æ»¡å®ƒ', ingredients: { hide: 2, thread: 1 }, result: { empty_water_bag: 1 } },
        { id: 'use_water_bag', name: 'ä½¿ç”¨æ°´è¢‹', description: 'é¥®ç”¨å‚¨å­˜åœ¨æ°´è¢‹ä¸­çš„æ°´', ingredients: { water_bag: 1 }, result: { empty_water_bag: 1, thirst: 30, health: 5 } },
        { id: 'fill_water_bag', name: 'è£…æ»¡æ°´è¢‹', description: 'ç”¨æ°´æºè£…æ»¡æ°´è¢‹', ingredients: { empty_water_bag: 1, water: 1 }, result: { water_bag: 1 } }
      ],
      events: [
        {
          id: 'kind_person',
          name: 'å–„è‰¯çš„è·¯äºº',
          text: 'ä¸€ä½çœ‹èµ·æ¥å–„è‰¯çš„è·¯äººæ³¨æ„åˆ°äº†ä½ ï¼Œæƒ³è¦å¸®åŠ©ä½ ã€‚',
          options: [
            { text: 'è¯·æ±‚æ®‹ç¾¹å‰©é¥­', result: { food: 2, reputation: 5 }, description: 'è·å¾—2ä»½æ®‹ç¾¹å‰©é¥­ï¼Œæé«˜å°‘é‡å£°æœ›' },
            { text: 'è¯·æ±‚é’±è´¢', result: { money: 2, reputation: -5 }, description: 'è·å¾—2æšé’±å¸ï¼Œä½†é™ä½å°‘é‡å£°æœ›' },
            { text: 'æ‹’ç»å¸®åŠ©', result: { spirit: 10, reputation: 10 }, description: 'ç»´æŠ¤å°Šä¸¥ï¼Œæé«˜ç²¾ç¥å’Œå£°æœ›' }
          ]
        },
        {
          id: 'bully',
          name: 'æ¶éœ¸',
          text: 'ä¸€ä¸ªæ¶éœ¸å‘ä½ èµ°æ¥ï¼Œçœ‹èµ·æ¥æƒ³è¦æ¬ºè´Ÿä½ å¹¶æŠ¢èµ°ä½ çš„ä¸œè¥¿ã€‚',
          options: [
            { text: 'åæŠ—', result: { health: -10, reputation: 10 }, description: 'å¯èƒ½å—ä¼¤ï¼Œä½†èµ¢å¾—å£°æœ›' },
            { text: 'é€ƒè·‘', result: { spirit: -5, money: -1 }, description: 'æŸå¤±1æšé’±å¸ï¼Œé™ä½ç²¾ç¥' },
            { text: 'å±ˆæœ', result: { money: -2, reputation: -10 }, description: 'æŸå¤±2æšé’±å¸ï¼Œé™ä½å£°æœ›' }
          ]
        },
        {
          id: 'temple_offer',
          name: 'å¯ºåº™çš„é‚€è¯·',
          text: 'å¯ºåº™çš„åƒ§äººæ³¨æ„åˆ°äº†ä½ ï¼Œé‚€è¯·ä½ å»å¯ºåº™å¸®å¿™ï¼Œä»¥æ¢å–é£Ÿç‰©å’Œä½å®¿ã€‚',
          options: [
            { text: 'æ¥å—é‚€è¯·', result: { food: 3, health: 10, spirit: 10 }, description: 'è·å¾—æ®‹ç¾¹å‰©é¥­ï¼Œæ¢å¤å¥åº·å’Œç²¾ç¥' },
            { text: 'æ‹’ç»é‚€è¯·', result: { reputation: -5, money: 1 }, description: 'è·å¾—1æšé’±å¸ï¼Œä½†é™ä½å£°æœ›' }
          ]
        },
        {
          id: 'sick',
          name: 'ç”Ÿç—…',
          text: 'ä½ æ„Ÿè§‰å¾ˆä¸èˆ’æœï¼Œå¯èƒ½æ˜¯å› ä¸ºåƒäº†å˜è´¨çš„é£Ÿç‰©æˆ–æš´éœ²åœ¨å¯’å†·ä¸­ã€‚',
          options: [
            { text: 'ä¼‘æ¯', result: { health: 5, spirit: 5 }, description: 'ä¼‘æ¯ä¸€å¤©ï¼Œæ¢å¤å°‘é‡å¥åº·' },
            { text: 'å¯»æ±‚å¸®åŠ©', result: { reputation: -5, health: 10 }, description: 'è·å¾—æ²»ç–—ï¼Œä½†é™ä½å£°æœ›' },
            { text: 'ç»§ç»­ä¹è®¨', result: { health: -15, money: 1 }, description: 'è·å¾—1æšé’±å¸ï¼Œä½†å¥åº·çŠ¶å†µæ¶åŒ–' }
          ]
        }
      ],
      discoveredRecipes: [],

      stats: {
        daysSurvived: 0,
        maxReputation: 0,
        resourcesCollected: 0,
        recipesDiscovered: 0
      },
      gameOver: false
    };

    // DOM å…ƒç´ 
    const elements = {
      startScreen: document.getElementById('startScreen'),
      startGameButton: document.getElementById('startGameButton'),
      tutorialModal: document.getElementById('tutorialModal'),
      closeTutorialButton: document.getElementById('closeTutorialButton'),
      tutorialStep1: document.getElementById('tutorialStep1'),
      tutorialStep2: document.getElementById('tutorialStep2'),
      tutorialStep3: document.getElementById('tutorialStep3'),
      tutorialStep4: document.getElementById('tutorialStep4'),
      tutorialStep5: document.getElementById('tutorialStep5'),
      tutorialStep6: document.getElementById('tutorialStep6'),
      tutorialStep7: document.getElementById('tutorialStep7'),
      tutorialStep8: document.getElementById('tutorialStep8'),
      prevTutorialButton: document.getElementById('prevTutorialButton'),
      nextTutorialButton: document.getElementById('nextTutorialButton'),
      gameContainer: document.getElementById('gameContainer'),
      dayNumber: document.getElementById('dayNumber'),
      timeOfDay: document.getElementById('timeOfDay'),
      seasonIcon: document.getElementById('seasonIcon'),
      seasonName: document.getElementById('seasonName'),

      hungerBar: document.getElementById('hungerBar'),
      coldBar: document.getElementById('coldBar'),
      healthBar: document.getElementById('healthBar'),
      spiritBar: document.getElementById('spiritBar'),
      reputationBar: document.getElementById('reputationBar'),
      thirstBar: document.getElementById('thirstBar'),
      actionPointsValue: document.getElementById('actionPointsValue'),
      actionPointsBar: document.getElementById('actionPointsBar'),
      hungerPercentage: document.getElementById('hungerPercentage'),
      coldPercentage: document.getElementById('coldPercentage'),
      healthPercentage: document.getElementById('healthPercentage'),
      spiritPercentage: document.getElementById('spiritPercentage'),
      reputationPercentage: document.getElementById('reputationPercentage'),
      thirstPercentage: document.getElementById('thirstPercentage'),
      resourceGrid: document.getElementById('resourceGrid'),
      locationGrid: document.getElementById('locationGrid'),
      actionGrid: document.getElementById('actionGrid'),

      eventModal: document.getElementById('eventModal'),
      closeEventButton: document.getElementById('closeEventButton'),
      eventTitle: document.getElementById('eventTitle'),
      eventText: document.getElementById('eventText'),
      eventOptions: document.getElementById('eventOptions'),
      recipeModal: document.getElementById('recipeModal'),
      closeRecipeButton: document.getElementById('closeRecipeButton'),
      recipeGrid: document.getElementById('recipeGrid'),
      gameOverModal: document.getElementById('gameOverModal'),
      gameOverTitle: document.getElementById('gameOverTitle'),
      gameOverText: document.getElementById('gameOverText'),
      daysSurvived: document.getElementById('daysSurvived'),
      maxReputation: document.getElementById('maxReputation'),
      resourcesCollected: document.getElementById('resourcesCollected'),
      recipesDiscovered: document.getElementById('recipesDiscovered'),
      restartGameButton: document.getElementById('restartGameButton'),
      exitGameButton: document.getElementById('exitGameButton'),
      craftButton: document.getElementById('craftButton'),
      notification: document.getElementById('notification'),
      closeNotificationButton: document.getElementById('closeNotificationButton'),
      notificationTitle: document.getElementById('notificationTitle'),
      notificationMessage: document.getElementById('notificationMessage'),
      notificationOKButton: document.getElementById('notificationOKButton'),
      achievementModal: document.getElementById('achievementModal'),
      closeAchievementButton: document.getElementById('closeAchievementButton'),
      achievementTitle: document.getElementById('achievementTitle'),
      achievementDescription: document.getElementById('achievementDescription'),
      startScreenSaveButton: document.getElementById('startScreenSaveButton'),
      backToStartButton: document.getElementById('backToStartButton')
    };

    // æ·»åŠ å¸®åŠ©æŒ‰é’®å…ƒç´ åˆ°elementså¯¹è±¡
    elements.helpButton = document.getElementById('helpButton');

    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
      debugLog('å¼€å§‹initGame()å‡½æ•°æ‰§è¡Œ');
      try {
        debugLog('è°ƒç”¨updateGameData()');
        updateGameData();
        debugLog('updateGameData()æ‰§è¡Œå®Œæˆ');
        
        // ç¡®ä¿gameData.resourceså¯¹è±¡å­˜åœ¨
        if (!gameData.resources) {
          gameData.resources = {};
        }
        
        // åˆå§‹åŒ–æµ‹è¯•å¡ç‰Œèµ„æºï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        const testResources = {
          'bowl': { name: 'ç ´ç¢—', amount: 0, image: 'UI/ç ´ç¢—.jpg', category: 'material' },
          'herb': { name: 'è‰è¯', description: 'å¯ä»¥ç”¨æ¥åˆ¶ä½œè¯å“çš„æ¤ç‰©', amount: 0, image: 'UI/è‰è¯.jpg', category: 'material' },
          'raw_meat': { name: 'ç”Ÿè‚‰', description: 'æœªåŠ å·¥çš„è‚‰ç±»ï¼Œéœ€è¦çƒ¹é¥ªåé£Ÿç”¨', amount: 0, image: 'UI/ç”Ÿè‚‰.jpg', type: 'consumable', category: 'food' },
          'cooked_meat': { name: 'ç†Ÿè‚‰', description: 'çƒ¹é¥ªåçš„è‚‰ç±»ï¼Œæä¾›ä¸°å¯Œçš„è¥å…»', amount: 0, image: 'UI/ç†Ÿè‚‰.jpg', type: 'consumable', category: 'food' },
          'porcelain_bowl': { name: 'ç“·ç¢—', description: 'ç²¾è‡´çš„ç“·ç¢—ï¼Œå¤§å¹…æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/ç“·ç¢—.jpg', durability: 100, category: 'material' },
          'clay_bowl_clean': { name: 'æ³¥ç¢—ï¼ˆå‡€æ°´ï¼‰', description: 'ç››æœ‰å¹²å‡€æ°´çš„æ³¥ç¢—ï¼Œå¯ä»¥å®‰å…¨åœ°ç¼“è§£å£æ¸´', amount: 0, image: 'UI/æ³¥ç¢—ï¼ˆå‡€æ°´ï¼‰.jpg', type: 'consumable', category: 'food' },
          'pottery_bowl': { name: 'é™¶ç¢—', description: 'åšå›ºçš„é™¶ç¢—ï¼Œæé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é™¶ç¢—.jpg', durability: 100, category: 'material' },
          'silver_bowl': { name: 'é“¶ç¢—', description: 'çè´µçš„é“¶ç¢—ï¼Œæ˜¾è‘—æé«˜ä¹è®¨æˆåŠŸç‡', amount: 0, image: 'UI/é“¶ç¢—.jpg', durability: 100, category: 'material' },
          'gold_bowl': { name: 'é‡‘ç¢—', description: 'å¥¢åçš„é‡‘ç¢—ï¼Œæå¤§æé«˜ä¹è®¨æˆåŠŸç‡å’Œå£°æœ›', amount: 0, image: 'UI/é‡‘ç¢—.jpg', durability: 100, category: 'material' }
        };
        
        // è®¾ç½®æµ‹è¯•å¡ç‰Œåˆå§‹æ•°é‡
        debugLog('è®¾ç½®æµ‹è¯•å¡ç‰Œåˆå§‹æ•°é‡');
        for (const [resourceId, defaultValue] of Object.entries(testResources)) {
          if (!gameData.resources[resourceId]) {
            gameData.resources[resourceId] = { ...defaultValue };
          }
        }
        
        // è®¾ç½®å…·ä½“æ•°é‡ - åªæœ‰ç ´ç¢—æ•°é‡ä¸º1ï¼Œå…¶ä»–ç‰©å“æ•°é‡ä¸º0
        gameData.resources['bowl'].amount = 1;
        gameData.resources['herb'].amount = 0;
        gameData.resources['raw_meat'].amount = 0;
        gameData.resources['cooked_meat'].amount = 0;
        gameData.resources['porcelain_bowl'].amount = 0;
        gameData.resources['clay_bowl_clean'].amount = 0;
        gameData.resources['pottery_bowl'].amount = 0;
        gameData.resources['silver_bowl'].amount = 0;
        gameData.resources['gold_bowl'].amount = 0;
        
        // åˆå§‹åŒ–æ°´è¢‹èµ„æºç”¨äºæµ‹è¯•
        if (!gameData.resources.water_bag_empty) {
          gameData.resources.water_bag_empty = {
            name: 'æ°´è¢‹ï¼ˆç©ºï¼‰',
            description: 'ä¸€ä¸ªç©ºçš„æ°´è¢‹ï¼Œå¯ä»¥ç”¨æ¥è£…æ°´',
            amount: 0,
            image: 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg',
            type: 'tool',
            category: 'tool',
            id: 'water_bag_empty',
            cannotDrop: false
          };
        } else {
          gameData.resources.water_bag_empty.amount = 0;
        }
        
        if (!gameData.resources.water_bag_full) {
          gameData.resources.water_bag_full = {
            name: 'æ°´è¢‹ï¼ˆæ»¡ï¼‰',
            description: 'ä¸€ä¸ªè£…æ»¡æ°´çš„æ°´è¢‹ï¼Œå¯ä»¥é¥®ç”¨',
            amount: 0,
            image: 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg',
            type: 'consumable',
            category: 'food',
            id: 'water_bag_full',
            cannotDrop: false,
            useEffect: function() {
              gameData.status.thirst = Math.min(100, gameData.status.thirst + 20);
              return { thirst: 20 };
            }
          };
        } else {
          gameData.resources.water_bag_full.amount = 0;
        }
        
        debugLog('è°ƒç”¨renderResources()');
        renderResources();
        debugLog('renderResources()æ‰§è¡Œå®Œæˆ');
        
        debugLog('è°ƒç”¨renderLocations()');
        renderLocations();
        debugLog('renderLocations()æ‰§è¡Œå®Œæˆ');
        
        debugLog('è°ƒç”¨renderActions()');
        renderActions();
        debugLog('renderActions()æ‰§è¡Œå®Œæˆ');
        
        debugLog('è°ƒç”¨renderEquipmentSlots()');
        renderEquipmentSlots(); // åˆå§‹åŒ–è£…å¤‡æ 
        debugLog('renderEquipmentSlots()æ‰§è¡Œå®Œæˆ');
        
        debugLog('è°ƒç”¨setupCategoryTabs()');
        setupCategoryTabs(); // è®¾ç½®åˆ†ç±»æ ‡ç­¾äº‹ä»¶
        debugLog('setupCategoryTabs()æ‰§è¡Œå®Œæˆ');
        
        debugLog('è°ƒç”¨setupPaginationButtons()');
        setupPaginationButtons(); // è®¾ç½®åˆ†é¡µæŒ‰é’®äº‹ä»¶
        debugLog('setupPaginationButtons()æ‰§è¡Œå®Œæˆ');
        
        debugLog('è°ƒç”¨updateSkillDisplay()');
        updateSkillDisplay(); // åˆå§‹åŒ–æŠ€èƒ½æ˜¾ç¤º
        debugLog('updateSkillDisplay()æ‰§è¡Œå®Œæˆ');
        
        debugLog('initGame()å‡½æ•°æ‰§è¡Œå®Œæˆ');
      } catch (error) {
        console.error('initGame()é”™è¯¯:', error);
        let errorDiv = document.getElementById('error-display');
        if (!errorDiv) {
          errorDiv = document.createElement('div');
          errorDiv.id = 'error-display';
          errorDiv.style.cssText = 'position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 10px; z-index: 9999; font-size: 14px;';
          document.body.appendChild(errorDiv);
        }
        errorDiv.innerHTML += `<p>åˆå§‹åŒ–æ¸¸æˆé”™è¯¯: ${error.message}</p>`;
        // è®°å½•è¯¦ç»†çš„é”™è¯¯å †æ ˆ
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
      }
    }
    
    // æ¸²æŸ“è£…å¤‡æ 
    function renderEquipmentSlots() {
      const equipmentSlots = document.querySelectorAll('.equipment-slots .combination-slot');
      
      equipmentSlots.forEach(slot => {
        const slotType = slot.getAttribute('data-slot');
        updateEquipmentSlot(slotType);
      });
    }
    
    // æ›´æ–°å•ä¸ªè£…å¤‡æ§½
    function updateEquipmentSlot(slotType, resourceId = null) {
      const slot = document.querySelector(`.equipment-slots .combination-slot[data-slot="${slotType}"]`);
      
      if (!slot) return;
      
      // å¦‚æœæŒ‡å®šäº†èµ„æºIDï¼Œç›´æ¥ä½¿ç”¨è¯¥èµ„æº
      if (resourceId && gameData.resources[resourceId]) {
        const resource = gameData.resources[resourceId];
        
        if (resource.equipmentSlot === slotType && resource.equipped) {
          // åœ¨æ§½ä½ä¸­æ˜¾ç¤ºè£…å¤‡ï¼Œç§»é™¤ç‚¹å‡»äº‹ä»¶å’Œæ‹–æ‹½åŠŸèƒ½
          slot.innerHTML = `
            <div class="equipment-item" data-resource="${resourceId}" data-slot="${slotType}" style="position: relative; width: 100%; height: 80px; cursor: not-allowed; pointer-events: none;">
              <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 0.25rem;">
              <div class="equipment-name" style="text-align: center; font-size: 0.75rem; margin-top: 0.25rem;">${resource.name}</div>
            </div>
          `;
          return;
        }
      }
      
      // å¦‚æœæ²¡æœ‰æŒ‡å®šèµ„æºIDæˆ–èµ„æºä¸åŒ¹é…ï¼ŒæŸ¥æ‰¾è¯¥æ§½ä½çš„è£…å¤‡
      let hasEquipment = false;
      
      // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰å¯è£…å¤‡çš„ç‰©å“
      for (const [currentResourceId, resource] of Object.entries(gameData.resources)) {
        if (resource.equipmentSlot === slotType) {
          // æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦å·²ç»è£…å¤‡ï¼ˆå³ä½¿æ•°é‡ä¸º0ï¼Œå·²è£…å¤‡çš„ç‰©å“ä¹Ÿåº”æ˜¾ç¤ºï¼‰
          if (resource.equipped) {
            // åœ¨æ§½ä½ä¸­æ˜¾ç¤ºè£…å¤‡ï¼Œç§»é™¤ç‚¹å‡»äº‹ä»¶å’Œæ‹–æ‹½åŠŸèƒ½
            slot.innerHTML = `
              <div class="equipment-item" data-resource="${currentResourceId}" data-slot="${slotType}" style="position: relative; width: 100%; height: 80px; cursor: not-allowed; pointer-events: none;">
                <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 0.25rem;">
                <div class="equipment-name" style="text-align: center; font-size: 0.75rem; margin-top: 0.25rem;">${resource.name}</div>
              </div>
            `;
            
            hasEquipment = true;
            break;
          }
        }
      }
      
      // å¦‚æœæ²¡æœ‰è£…å¤‡ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
      if (!hasEquipment) {
        slot.innerHTML = `
          <div class="equipment-icon" style="text-align: center; font-size: 1.5rem; margin-bottom: 0.25rem;">${slotType === 'clothes' ? 'ğŸ‘•' : slotType === 'shoes' ? 'ğŸ‘¢' : slotType === 'weapon' ? 'ğŸ—¡ï¸' : 'âœ¨'}</div>
        `;
      }
      
      // æ·»åŠ CSSæ ·å¼ç¦ç”¨æ‹–æ‹½åŠŸèƒ½
      slot.style.pointerEvents = 'none';
      slot.style.userSelect = 'none';
      slot.style.touchAction = 'none';
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†å™¨
    window.addEventListener('error', function(e) {
      console.error('JavaScripté”™è¯¯:', e.message, 'åœ¨æ–‡ä»¶:', e.filename, 'è¡Œ:', e.lineno);
      // åˆ›å»ºé”™è¯¯æ˜¾ç¤ºå…ƒç´ 
      let errorDiv = document.getElementById('error-display');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'error-display';
        errorDiv.style.cssText = 'position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 10px; z-index: 9999; font-size: 14px;';
        document.body.appendChild(errorDiv);
      }
      errorDiv.innerHTML += `<p>${e.message} åœ¨ ${e.filename} ç¬¬ ${e.lineno} è¡Œ</p>`;
    });
    
    // æ·»åŠ è°ƒè¯•æ—¥å¿—å‡½æ•°
    function debugLog(message) {
      // ç”Ÿäº§ç¯å¢ƒç¦ç”¨è°ƒè¯•æ—¥å¿—æ˜¾ç¤º
      // ä¿ç•™console.logä»¥ä¾¿åœ¨éœ€è¦è°ƒè¯•æ—¶å¯ä»¥å¯ç”¨
      console.log('è°ƒè¯•:', message);
      // æ³¨é‡Šæ‰DOMæ˜¾ç¤ºéƒ¨åˆ†ï¼Œä¸å†åˆ›å»ºå’Œæ›´æ–°æ—¥å¿—çª—å£
      /*
      let logDiv = document.getElementById('debug-log');
      if (!logDiv) {
        logDiv = document.createElement('div');
        logDiv.id = 'debug-log';
        logDiv.style.cssText = 'position: fixed; bottom: 10px; left: 10px; background: black; color: green; padding: 10px; z-index: 9999; font-size: 12px; max-height: 200px; overflow-y: auto;';
        document.body.appendChild(logDiv);
      }
      logDiv.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
      */
    }

    // ç®€å•çš„å¯ŒäººåŒºå·çªƒåŠŸèƒ½æµ‹è¯•å‡½æ•°
    function testRichAreaStealing() {
      console.log("===== å¼€å§‹æµ‹è¯•å¯ŒäººåŒºå·çªƒåŠŸèƒ½ =====");
      console.log("æµ‹è¯•å®Œæˆï¼šå¯ŒäººåŒºå·çªƒåŠŸèƒ½å·²å®ç°");
      console.log("æˆåŠŸé€»è¾‘ï¼šè·å¾—éšæœºç‰©å“ + 5ç‚¹å·çªƒæŠ€èƒ½ç»éªŒ");
      console.log("å¤±è´¥é€»è¾‘ï¼šç›´æ¥è¢«æŠ“å¹¶å…³å…¥ç‰¢æˆ¿");
      console.log("===== æµ‹è¯•å®Œæˆ =====");
      return true;
    }

    document.addEventListener('DOMContentLoaded', () => {
      debugLog('DOMå·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–...');
      try {
        setupEventListeners();
        debugLog('äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        setupResourceCardClickEvents();
        debugLog('èµ„æºå¡ç‰Œç‚¹å‡»äº‹ä»¶è®¾ç½®å®Œæˆ');
        setupHelpButton();
        debugLog('å¸®åŠ©æŒ‰é’®è®¾ç½®å®Œæˆ');
      } catch (error) {
        console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        let errorDiv = document.getElementById('error-display');
        if (!errorDiv) {
          errorDiv = document.createElement('div');
          errorDiv.id = 'error-display';
          errorDiv.style.cssText = 'position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 10px; z-index: 9999; font-size: 14px;';
          document.body.appendChild(errorDiv);
        }
        errorDiv.innerHTML += `<p>åˆå§‹åŒ–é”™è¯¯: ${error.message}</p>`;
      }
    });
    
    // æ‰“å¼€è£…å¤‡çª—å£
    function openEquipmentWindow() {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è£…å¤‡çª—å£
      let equipmentWindow = document.getElementById('equipmentWindow');
      if (equipmentWindow) {
        equipmentWindow.remove();
      }
      
      // åˆ›å»ºè£…å¤‡çª—å£
      equipmentWindow = document.createElement('div');
      equipmentWindow.id = 'equipmentWindow';
      equipmentWindow.className = 'modal';
      equipmentWindow.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      // åˆ›å»ºçª—å£å†…å®¹
      const windowContent = document.createElement('div');
      windowContent.className = 'modal-content';
      windowContent.style.cssText = `
        background-color: white;
        padding: 2rem;
        border-radius: 1rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      `;
      
      // çª—å£æ ‡é¢˜
      const title = document.createElement('h2');
      title.textContent = 'è£…å¤‡';
      title.style.cssText = `
        font-size: 1.5rem;
        font-weight: 700;
        color: #2D3748;
        margin-bottom: 1.5rem;
        text-align: center;
      `;
      windowContent.appendChild(title);
      
      // è£…å¤‡æ§½å®¹å™¨
      const equipmentSlotsDiv = document.createElement('div');
      equipmentSlotsDiv.className = 'equipment-slots';
      equipmentSlotsDiv.style.cssText = `
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        border: 1px dashed #A0AEC0;
        border-radius: 0.5rem;
        justify-content: center;
      `;
      equipmentSlotsDiv.id = 'equipmentSlots';
      
      // åˆ›å»ºå››ä¸ªè£…å¤‡æ§½
      const slotTypes = [
        { type: 'clothes', icon: 'ğŸ‘•', name: 'è¡£ç‰©' },
        { type: 'shoes', icon: 'ğŸ‘¢', name: 'é´å­' },
        { type: 'weapon', icon: 'ğŸ—¡ï¸', name: 'æ­¦å™¨' },
        { type: 'special', icon: 'âœ¨', name: 'ç‰¹æ®Š' }
      ];
      
      slotTypes.forEach(slotInfo => {
        const slot = document.createElement('div');
        slot.className = 'combination-slot';
        slot.setAttribute('data-slot', slotInfo.type);
        slot.style.cssText = `
          width: 100px;
          height: 140px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          border: 1px solid #E2E8F0;
          border-radius: 0.5rem;
          background-color: #F7FAFC;
          padding: 0.5rem;
        `;
        
        const icon = document.createElement('div');
        icon.className = 'equipment-icon';
        icon.style.cssText = `
          text-align: center;
          font-size: 2rem;
          margin-bottom: 0.5rem;
        `;
        icon.textContent = slotInfo.icon;
        
        const slotName = document.createElement('div');
        slotName.className = 'slot-name';
        slotName.style.cssText = `
          font-size: 0.875rem;
          color: #4A5568;
          text-align: center;
          margin-bottom: 0.5rem;
        `;
        slotName.textContent = slotInfo.name;
        
        slot.appendChild(icon);
        slot.appendChild(slotName);
        equipmentSlotsDiv.appendChild(slot);
      });
      
      windowContent.appendChild(equipmentSlotsDiv);
      
      // å…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.textContent = 'å…³é—­';
      closeButton.style.cssText = `
        background-color: #4299E1;
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-top: 1rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
      `;
      
      closeButton.addEventListener('click', function() {
        equipmentWindow.remove();
      });
      
      windowContent.appendChild(closeButton);
      equipmentWindow.appendChild(windowContent);
      
      // ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      equipmentWindow.addEventListener('click', function(e) {
        if (e.target === equipmentWindow) {
          equipmentWindow.remove();
        }
      });
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(equipmentWindow);
      
      // é‡æ–°æ¸²æŸ“è£…å¤‡æ§½å†…å®¹
      renderEquipmentSlots();
    }
    
    // æ‰“å¼€æŠ€èƒ½çª—å£
    function openSkillsWindow() {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æŠ€èƒ½çª—å£
      let skillsWindow = document.getElementById('skillsWindow');
      if (skillsWindow) {
        skillsWindow.remove();
      }
      
      // åˆ›å»ºæŠ€èƒ½çª—å£
      skillsWindow = document.createElement('div');
      skillsWindow.id = 'skillsWindow';
      skillsWindow.className = 'modal';
      skillsWindow.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      // åˆ›å»ºçª—å£å†…å®¹
      const windowContent = document.createElement('div');
      windowContent.className = 'modal-content';
      windowContent.style.cssText = `
        background-color: white;
        padding: 2rem;
        border-radius: 1rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      `;
      
      // çª—å£æ ‡é¢˜
      const title = document.createElement('h2');
      title.textContent = 'æŠ€èƒ½ä¸Buff';
      title.style.cssText = `
        font-size: 1.5rem;
        font-weight: 700;
        color: #2D3748;
        margin-bottom: 1.5rem;
        text-align: center;
      `;
      windowContent.appendChild(title);
      
      // æŠ€èƒ½éƒ¨åˆ†
      const skillsSection = document.createElement('div');
      skillsSection.className = 'skills-section';
      skillsSection.style.cssText = `
        margin-bottom: 2rem;
      `;
      
      const skillsTitle = document.createElement('h3');
      skillsTitle.textContent = 'æŠ€èƒ½';
      skillsTitle.style.cssText = `
        font-size: 1.125rem;
        font-weight: 600;
        color: #4A5568;
        margin-bottom: 1rem;
      `;
      skillsSection.appendChild(skillsTitle);
      
      // åˆ›å»ºæŠ€èƒ½åˆ—è¡¨
      const skillsList = document.createElement('div');
      skillsList.className = 'skills-list';
      skillsList.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      `;
      skillsSection.appendChild(skillsList);
      
      // Bufféƒ¨åˆ†
      const buffsSection = document.createElement('div');
      buffsSection.className = 'buffs-section';
      
      const buffsTitle = document.createElement('h3');
      buffsTitle.textContent = 'çŠ¶æ€æ•ˆæœ (Buff)';
      buffsTitle.style.cssText = `
        font-size: 1.125rem;
        font-weight: 600;
        color: #4A5568;
        margin-bottom: 1rem;
      `;
      buffsSection.appendChild(buffsTitle);
      
      // åˆ›å»ºBuffåˆ—è¡¨
      const buffsList = document.createElement('div');
      buffsList.className = 'buffs-list';
      buffsList.style.cssText = `
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      `;
      buffsSection.appendChild(buffsList);
      
      windowContent.appendChild(skillsSection);
      windowContent.appendChild(buffsSection);
      
      // å…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.textContent = 'å…³é—­';
      closeButton.style.cssText = `
        background-color: #667EEA;
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-top: 1rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
      `;
      
      closeButton.addEventListener('click', function() {
        skillsWindow.remove();
      });
      
      windowContent.appendChild(closeButton);
      skillsWindow.appendChild(windowContent);
      
      // ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      skillsWindow.addEventListener('click', function(e) {
        if (e.target === skillsWindow) {
          skillsWindow.remove();
        }
      });
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(skillsWindow);
      
      // æ¸²æŸ“æŠ€èƒ½å’ŒBuff
      renderSkillsInWindow(skillsList);
      renderBuffsInWindow(buffsList);
    }
    
    // æ¸²æŸ“çª—å£ä¸­çš„æŠ€èƒ½
    function renderSkillsInWindow(container) {
      // éå†æ‰€æœ‰æŠ€èƒ½
      for (const [skillId, skill] of Object.entries(gameData.skills)) {
        const skillItem = document.createElement('div');
        skillItem.className = 'skill-item';
        skillItem.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem;
          background-color: #EDF2F7;
          border-radius: 0.5rem;
        `;
        
        // æŠ€èƒ½åç§°å’Œç­‰çº§
        const skillInfo = document.createElement('div');
        skillInfo.style.cssText = `
          font-size: 0.875rem;
          color: #4A5568;
          flex: 1;
        `;
        skillInfo.textContent = `${skill.name} (ç­‰çº§ ${skill.level}/${skill.maxLevel})`;
        
        // ç»éªŒæ¡
        const expContainer = document.createElement('div');
        expContainer.style.cssText = `
          width: 150px;
          height: 0.5rem;
          background-color: #E2E8F0;
          border-radius: 0.25rem;
          overflow: hidden;
          margin-left: 1rem;
        `;
        
        const expBar = document.createElement('div');
        expBar.className = 'exp-bar';
        
        // è®¡ç®—ç»éªŒç™¾åˆ†æ¯”
        let expPercentage = 0;
        
        if (skill.level < skill.maxLevel) {
          // è·å–å‡åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„æ€»ç»éªŒå€¼
          const expNeededForNextLevel = gameData.skillExpRequired[skill.level + 1];
          
          // ç»éªŒæ¡ç™¾åˆ†æ¯”=å½“å‰ç»éªŒå€¼/å‡çº§æ‰€éœ€ç»éªŒå€¼Ã—100%
          if (expNeededForNextLevel > 0) {
            expPercentage = (skill.experience / expNeededForNextLevel) * 100;
          } else {
            expPercentage = 0;
          }
          
          // ç¡®ä¿ç™¾åˆ†æ¯”ä¸è¶…è¿‡100%
          expPercentage = Math.min(expPercentage, 100);
        } else if (skill.level >= skill.maxLevel) {
          // å·²ç»æ˜¯æœ€é«˜ç­‰çº§ï¼Œç»éªŒæ¡æ»¡
          expPercentage = 100;
        }
        
        expBar.style.cssText = `
          height: 100%;
          background-color: #48BB78;
          width: ${expPercentage}%;
          transition: width 0.3s ease;
        `;
        
        expContainer.appendChild(expBar);
        
        // ç»éªŒå€¼æ–‡æœ¬
        const expText = document.createElement('span');
        expText.style.cssText = `
          margin-left: 0.5rem;
          font-size: 0.8rem;
          color: #4A5568;
        `;
        
        // è®¾ç½®ç»éªŒå€¼æ–‡æœ¬
        if (skill.level < skill.maxLevel) {
          // è·å–å‡åˆ°ä¸‹ä¸€çº§éœ€è¦çš„æ€»ç»éªŒå€¼
          // å¯¹äºç­‰çº§ 0ï¼Œéœ€è¦ä½¿ç”¨ level + 1 çš„å€¼æ¥è·å–æ­£ç¡®çš„å‡çº§ç»éªŒ
          const expNeededForNextLevel = gameData.skillExpRequired[skill.level + 1];
          expText.textContent = `${skill.experience}/${expNeededForNextLevel}`;
        } else if (skill.level >= skill.maxLevel) {
          expText.textContent = 'MAX';
        } else {
          expText.textContent = '0/0';
        }
        
        skillItem.appendChild(skillInfo);
        skillItem.appendChild(expContainer);
        skillItem.appendChild(expText);
        container.appendChild(skillItem);
      }
    }
    
    // æ¸²æŸ“çª—å£ä¸­çš„Buff
    function renderBuffsInWindow(container) {
      // æ£€æŸ¥æ˜¯å¦æœ‰"å°å¿ƒä¸€ç‚¹"Buff
      if (gameData.buffs && gameData.buffs.careful && gameData.buffs.careful.active) {
        const buffItem = document.createElement('div');
        buffItem.className = 'buff-item';
        buffItem.style.cssText = `
          position: relative;
          width: 80px;
          height: 80px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          background-color: #EBF8FF;
          border: 2px solid #90CDF4;
          border-radius: 0.5rem;
          cursor: pointer;
          transition: transform 0.2s ease;
        `;
        
        // æ·»åŠ æ‚¬åœæ•ˆæœ
        buffItem.addEventListener('mouseover', function() {
          this.style.transform = 'scale(1.05)';
        });
        
        buffItem.addEventListener('mouseout', function() {
          this.style.transform = 'scale(1)';
        });
        
        // Buffå›¾æ ‡
        const buffIcon = document.createElement('div');
        buffIcon.style.cssText = `
          font-size: 2rem;
          margin-bottom: 0.25rem;
        `;
        buffIcon.textContent = 'âš ï¸';
        
        // Buffåç§°
        const buffName = document.createElement('div');
        buffName.style.cssText = `
          font-size: 0.75rem;
          color: #2B6CB0;
          text-align: center;
        `;
        buffName.textContent = 'å°å¿ƒä¸€ç‚¹';
        
        // åˆ›å»ºå·¥å…·æç¤º
        const tooltip = document.createElement('div');
        tooltip.className = 'buff-tooltip';
        tooltip.style.cssText = `
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          background-color: #2D3748;
          color: white;
          padding: 0.5rem;
          border-radius: 0.25rem;
          font-size: 0.75rem;
          white-space: nowrap;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
          margin-bottom: 0.5rem;
          z-index: 1001;
        `;
        
        let remainingDays = 2;
        if (gameData.buffs.careful.endDay) {
          remainingDays = Math.max(0, gameData.buffs.careful.endDay - gameData.day);
        }
        
        tooltip.textContent = `åˆ‘æ»¡é‡Šæ”¾åçŠ¶æ€ï¼Œå·çªƒæˆåŠŸç‡-20%ï¼Œå‰©ä½™${remainingDays}å¤©`;
        
        // æ·»åŠ å·¥å…·æç¤ºæ˜¾ç¤º/éšè—äº‹ä»¶
        buffItem.addEventListener('mouseover', function() {
          tooltip.style.opacity = '1';
        });
        
        buffItem.addEventListener('mouseout', function() {
          tooltip.style.opacity = '0';
        });
        
        buffItem.appendChild(tooltip);
        buffItem.appendChild(buffIcon);
        buffItem.appendChild(buffName);
        container.appendChild(buffItem);
      }
      
      // å¦‚æœæ²¡æœ‰Buffï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
      if (container.children.length === 0) {
        const noBuffText = document.createElement('div');
        noBuffText.textContent = 'å½“å‰æ²¡æœ‰çŠ¶æ€æ•ˆæœ';
        noBuffText.style.cssText = `
          color: #718096;
          font-size: 0.875rem;
          text-align: center;
          padding: 1rem;
        `;
        container.appendChild(noBuffText);
      }
    }
    
    // è®¾ç½®å¸®åŠ©æŒ‰é’®
    function setupHelpButton() {
      // éšè—æ‰€æœ‰æ•™ç¨‹æ­¥éª¤çš„æ˜¾ç¤ºæ§åˆ¶
      for (let i = 1; i <= 8; i++) {
        const step = document.getElementById(`tutorialStep${i}`);
        if (step) {
          step.style.display = 'block';
        }
      }
      
      // æ·»åŠ å¸®åŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if (elements.helpButton) {
        elements.helpButton.addEventListener('click', () => {
          if (elements.tutorialModal) {
            elements.tutorialModal.classList.add('active');
          }
        });
      }
    }
    
    // è®¾ç½®èµ„æºå¡ç‰Œç‚¹å‡»äº‹ä»¶
    function setupResourceCardClickEvents() {
      // ä¸ºèµ„æºå¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶
      document.addEventListener('click', function(e) {
        const resourceCard = e.target.closest('.resource-card');
        if (resourceCard) {
          const resourceId = resourceCard.getAttribute('data-resource');
          const resource = gameData.resources[resourceId];
          
          // å¦‚æœæ˜¯é£Ÿç‰©ï¼Œç›´æ¥æ¶ˆè€—
          if (resource && resourceId === 'food') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯çªçªå¤´ï¼Œç›´æ¥æ¶ˆè€—
          else if (resource && resourceId === 'cornbread') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯ç¨€ç²¥ï¼Œç›´æ¥æ¶ˆè€—
          else if (resource && resourceId === 'porridge') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯è¯ä¸¸ï¼Œç›´æ¥æ¶ˆè€—
          else if (resource && resourceId === 'pill') {
            consumeFood(resourceId);
          }
          // å¦‚æœæ˜¯çµè¯ï¼Œæ˜¾ç¤ºä½¿ç”¨ç¡®è®¤çª—å£
          else if (resource && resourceId === 'medicine') {
            showMedicineWindow();
          }
          // å¦‚æœæ˜¯å¯å­¦ä¹ ç‰©å“ï¼Œæ˜¾ç¤ºå­¦ä¹ ç¡®è®¤çª—å£
          else if (resource && resource.type === 'learnable') {
            showLearnWindow(resourceId);
          }
          // å¦‚æœæ˜¯å¯è£…å¤‡ç‰©å“ï¼Œæ˜¾ç¤ºè£…å¤‡/å¸ä¸‹çª—å£
          else if (resource && resource.equipmentSlot) {
            showEquipmentWindow(resourceId);
          }
        }
      });
    }
    
    // æ¶ˆè€—é£Ÿç‰©
    function consumeFood(resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (resource.amount <= 0) {
        showNotification('æ— æ³•é£Ÿç”¨', `ä½ æ²¡æœ‰${resource.name}å¯ä»¥é£Ÿç”¨`);
        return;
      }
      
      // æ¶ˆè€—ä¸€ä¸ªé£Ÿç‰©
      resource.amount--;
      
      // åº”ç”¨æ•ˆæœ
      if (resourceId === 'food') {
        // é£Ÿç”¨æ®‹ç¾¹å‰©é¥­
        gameData.status.hunger = Math.max(0, gameData.status.hunger - 15); // å¢åŠ é¥±é£Ÿåº¦ï¼ˆå‡å°‘é¥¥é¥¿å€¼ï¼‰
        gameData.status.health = Math.max(0, gameData.status.health - 8);   // å‡å°‘å¥åº·åº¦
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨æ®‹ç¾¹å‰©é¥­', 'ä½ åƒäº†ä¸€äº›æ®‹ç¾¹å‰©é¥­ï¼Œç¼“è§£äº†é¥¥é¥¿ï¼Œä½†é£Ÿç‰©ä¸å¤ªæ–°é²œï¼Œå¥åº·æœ‰æ‰€ä¸‹é™');
        
        // æ›´æ–°UI
        updateResourceCard('food');
      } else if (resourceId === 'cornbread') {
        // é£Ÿç”¨çªçªå¤´
        gameData.status.hunger = Math.max(0, gameData.status.hunger - 25); // å¢åŠ è¾ƒå¤šé¥±é£Ÿåº¦
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨çªçªå¤´', 'ä½ åƒäº†ä¸€ä¸ªçªçªå¤´ï¼Œæ„Ÿè§‰é¥±å¤šäº†');
        
        // æ›´æ–°UI
        updateResourceCard('cornbread');
      } else if (resourceId === 'porridge') {
        // é£Ÿç”¨ç¨€ç²¥
        gameData.status.hunger = Math.max(0, gameData.status.hunger - 20); // å¢åŠ 20é¥±é£Ÿåº¦
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨ç¨€ç²¥', 'ä½ å–äº†ä¸€ç¢—ç¨€ç²¥ï¼Œå¢åŠ äº†20é¥±é£Ÿåº¦');
        
        // æ›´æ–°UI
        updateResourceCard('porridge');
      } else if (resourceId === 'pill') {
        // é£Ÿç”¨è¯ä¸¸
        const healthIncrease = 40; // ç›´æ¥æ¢å¤40ç‚¹å¥åº·åº¦
        gameData.status.health = Math.min(100, gameData.status.health + healthIncrease);
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('é£Ÿç”¨è¯ä¸¸', `ä½ åƒäº†ä¸€é¢—è¯ä¸¸ï¼Œå¥åº·åº¦æ¢å¤äº†${healthIncrease}ç‚¹ï¼ˆ40%ï¼‰ï¼`);
        
        // æ›´æ–°UI
        updateResourceCard('pill');
      }
      
      updateGameData();
    }
    
    // æ˜¾ç¤ºä½¿ç”¨çµè¯ç¡®è®¤çª—å£ï¼ˆå·²åºŸå¼ƒï¼‰
    // function showMedicineWindow() {
    //   const resource = gameData.resources.medicine;
    //   // æ­¤åŠŸèƒ½å·²ç§»é™¤
    // }
    
    // å¤„ç†èµ„æºç‚¹å‡»äº‹ä»¶
    function handleResourceClick(resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (!resource || resource.amount <= 0) {
        showNotification('æ— æ³•ä½¿ç”¨', `ä½ æ²¡æœ‰${resource?.name || 'è¯¥ç‰©å“'}å¯ä»¥ä½¿ç”¨`);
        return;
      }
      
      // ä¸ºæ°´è¢‹ï¼ˆæ»¡ï¼‰æ·»åŠ ç‰¹æ®Šå¤„ç†
      if (resourceId === 'water_bag_full') {
        showWaterBagConfirmWindow(resourceId);
      }
    }
    
    // æ˜¾ç¤ºæ°´è¢‹ï¼ˆæ»¡ï¼‰ç¡®è®¤ä½¿ç”¨çª—å£
    function showWaterBagConfirmWindow(resourceId) {
      const resource = gameData.resources[resourceId];
      
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      if (confirm(`æ˜¯å¦è¦é¥®ç”¨${resource.name}ï¼Ÿ\n\né¥®ç”¨åå°†æ¢å¤å£æ¸´çŠ¶æ€ï¼Œå¹¶è·å¾—ç©ºæ°´è¢‹ã€‚`)) {
        drinkWaterBag(resourceId);
      }
      // å–æ¶ˆåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    }
    
    // å®ç°é¥®ç”¨è£…æ»¡æ°´çš„æ°´è¢‹åŠŸèƒ½
    function drinkWaterBag(resourceId) {
      const fullWaterBag = gameData.resources[resourceId];
      const emptyWaterBag = gameData.resources.water_bag_empty;
      
      if (!fullWaterBag || fullWaterBag.amount <= 0) {
        showNotification('æ— æ³•ä½¿ç”¨', 'ä½ æ²¡æœ‰æ°´è¢‹ï¼ˆæ»¡ï¼‰å¯ä»¥ä½¿ç”¨');
        return;
      }
      
      // æ¶ˆè€—ä¸€ä¸ªæ°´è¢‹ï¼ˆæ»¡ï¼‰
      fullWaterBag.amount--;
      
      // å¢åŠ ä¸€ä¸ªæ°´è¢‹ï¼ˆç©ºï¼‰
      if (emptyWaterBag) {
        emptyWaterBag.amount++;
      }
      
      // å¢åŠ å£æ¸´çŠ¶æ€30%
      const thirstIncrease = 30;
      gameData.status.thirst = Math.min(100, gameData.status.thirst + thirstIncrease);
      
      // æ˜¾ç¤ºé€šçŸ¥
      showNotification('é¥®ç”¨æˆåŠŸ', `ä½ é¥®ç”¨äº†æ°´è¢‹ä¸­çš„æ°´ï¼Œå£æ¸´çŠ¶æ€æ¢å¤äº†${thirstIncrease}%ï¼Œå¹¶è·å¾—äº†ä¸€ä¸ªç©ºæ°´è¢‹ã€‚`);
      
      // æ›´æ–°UI
      updateResourceCard('water_bag_full');
      updateResourceCard('water_bag_empty');
      updateGameData(); // æ›´æ–°æ¸¸æˆçŠ¶æ€UI
    }
    
    // æ˜¾ç¤ºé£Ÿç‰©ç¡®è®¤çª—å£ï¼ˆå·²åºŸå¼ƒï¼‰
    // function showFoodWindow(resourceId) {
    //   // æ­¤åŠŸèƒ½å·²ç§»é™¤
    // }
    
    // ä½¿ç”¨çµè¯
    function useMedicine(resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (!resource || resource.amount <= 0) {
        showNotification('æ— æ³•ä½¿ç”¨', `ä½ æ²¡æœ‰${resource?.name || 'è¯¥ç‰©å“'}å¯ä»¥ä½¿ç”¨`);
        return;
      }
      
      // æ¶ˆè€—ä¸€ä¸ªçµè¯
      resource.amount--;
      
      // åº”ç”¨æ•ˆæœ
      gameData.status.health = Math.min(100, gameData.status.health + 50); // æ¢å¤50ç‚¹å¥åº·å€¼
      
      // æ˜¾ç¤ºé€šçŸ¥
      showNotification('ä½¿ç”¨çµè¯', 'ä½ ä½¿ç”¨äº†çµè¯ï¼Œæ¢å¤äº†50ç‚¹å¥åº·å€¼ï¼');
      
      // æ›´æ–°UI
      updateResourceCard(resourceId);
      
      updateGameData();
    }
    
    // è·å–è£…å¤‡æè¿°
    function getEquipmentDescription(resourceId) {
      const resource = gameData.resources[resourceId];
      
      // æ ¹æ®è£…å¤‡ç±»å‹æ·»åŠ å±æ€§åŠ æˆæè¿°
      switch(resourceId) {
        case 'simple_clothes': // ç ´è¡£æœ
          return 'æä¾›åŸºæœ¬çš„ä¿æš–ï¼Œè£…å¤‡åï¼š<br>ä¿æš–åº¦ +10';
        case 'shoes': // ç ´é‹
          return 'æä¾›åŸºæœ¬çš„è„šéƒ¨ä¿æŠ¤ï¼Œè£…å¤‡åï¼š<br>å¥åº·åº¦ +5<br>ä¿æš–åº¦ +5';
        case 'crutch': // æ‹æ–
          return 'æé«˜ç§»åŠ¨èƒ½åŠ›å’Œå£°æœ›ï¼Œè£…å¤‡åï¼š<br>å¥åº·åº¦ +10<br>å£°æœ› +10';
        case 'black_cloak': // é»‘è‰²æ–—ç¯·
          return 'ç”¨äºè¿›å…¥é»‘å¸‚çš„ç‰¹æ®Šè¡£ç‰©ï¼Œè£…å¤‡åï¼š<br>ç²¾ç¥çŠ¶æ€ +15<br>è§£é”é»‘å¸‚è®¿é—®æƒé™';
        case 'fire': // ç¯ç«
          return 'æä¾›æ¸©æš–ï¼Œçƒ¹é¥ªé£Ÿç‰©ï¼Œæ”¾ç½®åï¼š<br>ä¿æš–åº¦ +20<br>å¥åº·åº¦ +5';
        case 'clay_bowl': // æ³¥ç¢—
          return 'æé«˜ä¹è®¨æˆåŠŸç‡ï¼Œä½¿ç”¨åï¼š<br>ä¹è®¨æˆåŠŸç‡ +10%';
        case 'bamboo_bow': // ç«¹å¼“
          return 'ä¸´æ—¶æé«˜æˆ˜æ–—åŠ›ï¼Œè£…å¤‡åï¼š<br>æ”»å‡»åŠ› +10<br>å‘½ä¸­ç‡ +10%<br>è€ä¹…åº¦ï¼š' + (resource.durability || 100) + '/100';
        default:
          return resource.description || 'æ— ç‰¹æ®Šæ•ˆæœ';
      }
    }
    
    // æ˜¾ç¤ºè£…å¤‡/å¸ä¸‹çª—å£
    function showEquipmentWindow(resourceId) {
      const resource = gameData.resources[resourceId];
      
      // åˆ›å»ºè£…å¤‡çª—å£å…ƒç´ 
      const equipmentWindow = document.createElement('div');
      equipmentWindow.className = 'equipment-window';
      equipmentWindow.id = 'equipmentWindow';
      equipmentWindow.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #F7FAFC;
        border: 1px solid #E2E8F0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        width: 300px;
        text-align: center;
      `;
      
      // çª—å£å†…å®¹
      const isBambooBow = resourceId === 'bamboo_bow';
      equipmentWindow.innerHTML = `
        <div class="equipment-window-header" style="margin-bottom: 1rem;">
          <h3 style="font-size: 1.25rem; font-weight: 700; color: #2D3748;">${resource.name}</h3>
        </div>
        <div class="equipment-window-body" style="margin-bottom: 1.5rem;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1rem; background-color: #E2E8F0; border-radius: 0.25rem; overflow: hidden;">
            <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          <p style="color: #4A5568; margin-bottom: 1rem;">${getEquipmentDescription(resourceId)}</p>
          <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <button class="equipment-button" id="equipButton" style="background-color: #805AD5; color: white; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
              ${resource.equipped ? 'å¸ä¸‹' : 'ç©¿æˆ´'}
            </button>
            ${isBambooBow ? `
            <button class="equipment-button" id="useButton" style="background-color: #38A169; color: white; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
              ä½¿ç”¨
            </button>
            ` : ''}
            <button class="equipment-button" id="cancelButton" style="background-color: #E2E8F0; color: #4A5568; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      `;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(equipmentWindow);
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      const equipButton = equipmentWindow.querySelector('#equipButton');
      const cancelButton = equipmentWindow.querySelector('#cancelButton');
      
      equipButton.addEventListener('click', function() {
        if (resource.equipped) {
          // å¸ä¸‹è£…å¤‡
          unequipItem(resource.equipmentSlot, resourceId);
        } else {
          // è£…å¤‡ç‰©å“
          equipItem(resourceId);
        }
        
        // å…³é—­çª—å£
        closeEquipmentWindow();
      });
      
      // ä¸ºç«¹å¼“æ·»åŠ ä½¿ç”¨æŒ‰é’®äº‹ä»¶
      if (isBambooBow) {
        const useButton = equipmentWindow.querySelector('#useButton');
        useButton.addEventListener('click', function() {
          // ä½¿ç”¨ç«¹å¼“ï¼Œæ¶ˆè€—è€ä¹…åº¦
          decreaseBambooBowDurability();
          
          // é‡æ–°æ¸²æŸ“è£…å¤‡çª—å£ä»¥æ›´æ–°è€ä¹…åº¦æ˜¾ç¤º
          closeEquipmentWindow();
          showEquipmentWindow(resourceId);
        });
      }
      
      cancelButton.addEventListener('click', function() {
        closeEquipmentWindow();
      });
      
      // ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      equipmentWindow.addEventListener('click', function(e) {
        if (e.target === equipmentWindow) {
          closeEquipmentWindow();
        }
      });
    }
    
    // å…³é—­è£…å¤‡çª—å£
    function closeEquipmentWindow() {
      const equipmentWindow = document.getElementById('equipmentWindow');
      if (equipmentWindow) {
        equipmentWindow.remove();
      }
    }
    
    // æ˜¾ç¤ºå­¦ä¹ ç¡®è®¤çª—å£
    function showLearnWindow(resourceId) {
      const resource = gameData.resources[resourceId];
      
      // åˆ›å»ºå­¦ä¹ çª—å£å…ƒç´ 
      const learnWindow = document.createElement('div');
      learnWindow.className = 'learn-window';
      learnWindow.id = 'learnWindow';
      learnWindow.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #F7FAFC;
        border: 1px solid #E2E8F0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        width: 300px;
        text-align: center;
      `;
      
      // çª—å£å†…å®¹
      learnWindow.innerHTML = `
        <div class="learn-window-header" style="margin-bottom: 1rem;">
          <h3 style="font-size: 1.25rem; font-weight: 700; color: #2D3748;">${resource.name}</h3>
        </div>
        <div class="learn-window-body" style="margin-bottom: 1.5rem;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1rem; background-color: #E2E8F0; border-radius: 0.25rem; overflow: hidden;">
            <img src="${resource.image}" alt="${resource.name}" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          <p style="color: #4A5568; margin-bottom: 1rem;">${resource.description}</p>
          <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="learn-button" id="learnButton" style="background-color: #805AD5; color: white; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
              å­¦ä¹ 
            </button>
            <button class="learn-button" id="cancelLearnButton" style="background-color: #E2E8F0; color: #4A5568; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      `;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(learnWindow);
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      const learnButton = learnWindow.querySelector('#learnButton');
      const cancelButton = learnWindow.querySelector('#cancelLearnButton');
      
      learnButton.addEventListener('click', function() {
        // å­¦ä¹ ç‰©å“
        learnItem(resourceId);
        
        // å…³é—­çª—å£
        closeLearnWindow();
      });
      
      cancelButton.addEventListener('click', function() {
        closeLearnWindow();
      });
      
      // ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
      learnWindow.addEventListener('click', function(e) {
        if (e.target === learnWindow) {
          closeLearnWindow();
        }
      });
    }
    
    // å…³é—­å­¦ä¹ çª—å£
    function closeLearnWindow() {
      const learnWindow = document.getElementById('learnWindow');
      if (learnWindow) {
        learnWindow.remove();
      }
    }
    
    // æ£€æŸ¥æŠ€èƒ½æ˜¯å¦éœ€è¦å‡çº§
    function checkSkillLevelUp(skillId, eventResults) {
      const skill = gameData.skills[skillId];
      if (!skill) return;
      
      // æ£€æŸ¥æŠ€èƒ½æ˜¯å¦å·²ç»è¾¾åˆ°æœ€é«˜ç­‰çº§
      if (skill.level >= skill.maxLevel) return;
      
      // æ£€æŸ¥å½“å‰ç»éªŒæ˜¯å¦è¾¾åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„ç»éªŒ
      if (gameData.skillExpRequired[skill.level + 1] && skill.experience >= gameData.skillExpRequired[skill.level + 1]) {
        // æå‡æŠ€èƒ½ç­‰çº§
        skill.level++;
        
        // æ­¦æœ¯æŠ€èƒ½å‡çº§æ—¶å¢åŠ æ­¦åŠ›å€¼ï¼šæ¯çº§+5
        if (skillId === 'martial') {
            if (!skill.power) {
                skill.power = 10; // ç¡®ä¿åŸºç¡€æ­¦åŠ›å€¼æ­£ç¡®
            } else {
                skill.power += 5;
                levelUpEffect += `\næ­¦åŠ›å€¼å¢åŠ 5ç‚¹ï¼Œå½“å‰æ­¦åŠ›å€¼ï¼š${skill.power}`;
            }
        }
        
        // è·å–æŠ€èƒ½åç§°
        const skillName = skill.name || skillId;
        
        // æ›´æ–°æ•ˆæœæè¿°
        let levelUpEffect = `${skillName}æŠ€èƒ½å‡çº§åˆ° ${skill.level} çº§ï¼`;
        
        // æ·»åŠ åˆ°äº‹ä»¶ç»“æœï¼ˆå¦‚æœå½“å‰æ­£åœ¨å¤„ç†äº‹ä»¶ï¼‰
        if (eventResults) {
          eventResults.effects.push(levelUpEffect);
        }
        
        // æ˜¾ç¤ºå‡çº§é€šçŸ¥
        showNotification('æŠ€èƒ½å‡çº§', levelUpEffect);
        
        // æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºUI
        updateSkillDisplay();
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç»§ç»­å‡çº§
        checkSkillLevelUp(skillId, eventResults);
      }
    }
    
    // æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
    function updateSkillDisplay() {
      // æŠ€èƒ½æ˜¾ç¤ºç°åœ¨é€šè¿‡æŠ€èƒ½æŒ‰é’®å’Œçª—å£å®Œæˆï¼Œä¸å†åœ¨çŠ¶æ€æ ä¸­æ˜¾ç¤º
      // ç§»é™¤ç°æœ‰çš„æŠ€èƒ½å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const existingSkillsContainer = document.getElementById('skillsContainer');
      if (existingSkillsContainer) {
        existingSkillsContainer.remove();
      }
      
      // å¦‚æœæŠ€èƒ½çª—å£å·²æ‰“å¼€ï¼Œæ›´æ–°æŠ€èƒ½åˆ—è¡¨ä¸­çš„ç»éªŒæ¡
      const skillsWindow = document.getElementById('skillsWindow');
      if (skillsWindow) {
        const skillsList = skillsWindow.querySelector('.skills-list');
        if (skillsList) {
          skillsList.innerHTML = '';
          renderSkillsInWindow(skillsList);
        }
      }
      
      return;
      // ä»¥ä¸‹æ˜¯åŸå‡½æ•°å†…å®¹ï¼Œå·²è¢«æ³¨é‡Šæ‰
      /*
      try {
        // åˆ›å»ºæˆ–è·å–æŠ€èƒ½æ˜¾ç¤ºå®¹å™¨
        let skillsContainer = document.getElementById('skillsContainer');
        if (!skillsContainer) {
          // åœ¨çŠ¶æ€æ ä¸­åˆ›å»ºæŠ€èƒ½æ˜¾ç¤ºåŒºåŸŸ - ä¿®æ­£é€‰æ‹©å™¨ä¸ºstatus-grid
          const statusDiv = document.querySelector('.status-grid');
          
          // å¥å£®çš„é”™è¯¯æ£€æŸ¥
          if (!statusDiv) {
            console.warn('æ— æ³•æ‰¾åˆ°çŠ¶æ€å®¹å™¨å…ƒç´ (.status-grid)ï¼Œè·³è¿‡æŠ€èƒ½æ˜¾ç¤ºåˆ›å»º');
            return;
          }
          
          skillsContainer = document.createElement('div');
          skillsContainer.id = 'skillsContainer';
          skillsContainer.className = 'skills-container';
          skillsContainer.style.cssText = `
            margin-top: 1rem;
            padding: 1rem;
            background-color: #F7FAFC;
            border-radius: 0.5rem;
            border: 1px solid #E2E8F0;
          `;
          
          // æ·»åŠ æ ‡é¢˜
          const title = document.createElement('h3');
          title.textContent = 'æŠ€èƒ½';
          title.style.cssText = `
            font-size: 1rem;
            font-weight: 600;
            color: #2D3748;
            margin-bottom: 0.75rem;
          `;
          skillsContainer.appendChild(title);
          
          statusDiv.appendChild(skillsContainer);
        }
      
      // æ¸…ç©ºç°æœ‰å†…å®¹
      while (skillsContainer.children.length > 1) { // ä¿ç•™æ ‡é¢˜
        skillsContainer.removeChild(skillsContainer.lastChild);
      }
      
      // åˆ›å»ºæŠ€èƒ½åˆ—è¡¨
      const skillsList = document.createElement('div');
      skillsList.className = 'skills-list';
      skillsList.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      `;
      
      // éå†æ‰€æœ‰æŠ€èƒ½
      for (const [skillId, skill] of Object.entries(gameData.skills)) {
        const skillItem = document.createElement('div');
        skillItem.className = 'skill-item';
        skillItem.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem;
          background-color: #EDF2F7;
          border-radius: 0.25rem;
        `;
        
        // æŠ€èƒ½åç§°å’Œç­‰çº§
        const skillInfo = document.createElement('div');
        skillInfo.style.cssText = `
          font-size: 0.875rem;
          color: #4A5568;
        `;
        skillInfo.textContent = `${skill.name} (ç­‰çº§ ${skill.level}/${skill.maxLevel})`;
        
        // ç»éªŒæ¡
        const expContainer = document.createElement('div');
        expContainer.style.cssText = `
          width: 120px;
          height: 0.5rem;
          background-color: #E2E8F0;
          border-radius: 0.25rem;
          overflow: hidden;
        `;
        
        const expBar = document.createElement('div');
        expBar.className = 'exp-bar';
        
        // è®¡ç®—ç»éªŒè¿›åº¦ç™¾åˆ†æ¯”
        let expPercentage = 0;
        if (skill.level < skill.maxLevel) {
          const currentExp = skill.experience - (skill.level > 1 ? gameData.skillExpRequired[skill.level - 1] : 0);
          const requiredExp = gameData.skillExpRequired[skill.level] - (skill.level > 1 ? gameData.skillExpRequired[skill.level - 1] : 0);
          expPercentage = requiredExp > 0 ? (currentExp / requiredExp) * 100 : 100;
        }
        
        expBar.style.cssText = `
          height: 100%;
          width: ${expPercentage}%;
          background-color: #805AD5;
          transition: width 0.3s ease;
        `;
        
        expContainer.appendChild(expBar);
        skillItem.appendChild(skillInfo);
        skillItem.appendChild(expContainer);
        skillsList.appendChild(skillItem);
      }
      
      skillsContainer.appendChild(skillsList);
      }
      catch (error) {
        console.error('æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
      }
      */
    }
    
    // è£…å¤‡ç‰©å“
    function equipItem(resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (!resource || !resource.equipmentSlot) {
        showNotification('è£…å¤‡å¤±è´¥', 'è¿™ä¸æ˜¯å¯è£…å¤‡ç‰©å“');
        return;
      }
      
      // æ£€æŸ¥ç‰©å“æ•°é‡
      if (resource.amount <= 0) {
        showNotification('è£…å¤‡å¤±è´¥', `ä½ æ²¡æœ‰${resource.name}å¯ä»¥è£…å¤‡`);
        return;
      }
      
      // æ£€æŸ¥è¯¥æ§½ä½æ˜¯å¦å·²æœ‰è£…å¤‡
      const slotType = resource.equipmentSlot;
      const slot = document.querySelector(`.equipment-slots .combination-slot[data-slot="${slotType}"]`);
      
      // æ£€æŸ¥è¯¥æ§½ä½æ˜¯å¦å·²æœ‰è£…å¤‡
      for (const [currentResourceId, currentResource] of Object.entries(gameData.resources)) {
        if (currentResource.equipmentSlot === slotType && currentResource.equipped) {
          // å¸ä¸‹å½“å‰è£…å¤‡
          unequipItem(slotType, currentResourceId);
          break;
        }
      }
      
      // è£…å¤‡æ–°ç‰©å“
      resource.equipped = true;
      
      // åº”ç”¨è£…å¤‡æ•ˆæœ
      applyEquipmentEffect(resourceId, 'equip');
      
      // æ›´æ–°å½“å‰è£…å¤‡æ§½
      updateEquipmentSlot(slotType, resourceId);
      
      // æ›´æ–°èƒŒåŒ…
      updateResourceCard(resourceId);
      
      // æ˜¾ç¤ºé€šçŸ¥
      showNotification('è£…å¤‡æˆåŠŸ', `æˆåŠŸè£…å¤‡äº†${resource.name}`);
    }
    
    // å­¦ä¹ ç‰©å“
    function learnItem(resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (!resource || resource.type !== 'learnable') {
        showNotification('å­¦ä¹ å¤±è´¥', 'è¿™ä¸æ˜¯å¯å­¦ä¹ ç‰©å“');
        return;
      }
      
      // æ£€æŸ¥ç‰©å“æ•°é‡
      if (resource.amount <= 0) {
        showNotification('å­¦ä¹ å¤±è´¥', `ä½ æ²¡æœ‰${resource.name}å¯ä»¥å­¦ä¹ `);
        return;
      }
      
      // è·å–å…³è”çš„æŠ€èƒ½
      const skillType = resource.skill;
      if (!skillType || !gameData.skills[skillType]) {
        showNotification('å­¦ä¹ å¤±è´¥', 'æ­¤ç‰©å“æ²¡æœ‰å…³è”çš„æŠ€èƒ½');
        return;
      }
      
      // æå‡æŠ€èƒ½ç­‰çº§ï¼ˆå­¦ä¹ æŠ€èƒ½ä¹¦ç›´æ¥æå‡1çº§ï¼‰
      const skill = gameData.skills[skillType];
      if (skill.level < skill.maxLevel) {
        // å¢åŠ 1çº§
        skill.level += 1;
        
        // é‡ç½®ç»éªŒå€¼ä¸ºå½“å‰ç­‰çº§æ‰€éœ€çš„åŸºç¡€å€¼
        if (skill.level > 1) {
          skill.experience = gameData.skillExpRequired[skill.level - 1];
        }
        
        // ç‰¹æ®Šæ•ˆæœå¤„ç†
        let specialEffect = '';
        switch(resourceId) {
          case 'day_stealing':
            specialEffect = 'å·çªƒæˆåŠŸç‡å¢åŠ 30%';
            gameData.skills.thievery.successRateBonus = 0.3; // 30%æˆåŠŸç‡åŠ æˆ
            break;
          case 'herbal_canon':
            specialEffect = 'è·å¾—è‰è¯è¯†åˆ«èƒ½åŠ›';
            // æ ‡è®°å·²å­¦ä¼šè¯†åˆ«è‰è¯
            gameData.skills.medicine.canIdentifyHerbs = true;
            break;
          case 'huangdi_canon':
            specialEffect = 'è·å¾—ç–¾ç—…æ²»ç–—èƒ½åŠ›ï¼ˆæˆåŠŸç‡40%ï¼‰';
            // æ ‡è®°å·²å­¦ä¼šæ²»ç–—ç–¾ç—…
            gameData.skills.medicine.canTreatDisease = true;
            gameData.skills.medicine.cureSuccessRate = 0.4; // 40%æ²»ç–—æˆåŠŸç‡
            
            // æ·»åŠ æ²»ç–—ç–¾ç—…çš„åŠŸèƒ½ï¼ˆå¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ç›¸å…³æŒ‰é’®æˆ–åŠŸèƒ½ï¼‰
            if (!window.hasOwnProperty('handleDiseaseTreatment')) {
              window.handleDiseaseTreatment = function() {
                if (!gameData.skills.medicine.canTreatDisease) {
                  showNotification('æ— æ³•æ²»ç–—', 'ä½ è¿˜æ²¡æœ‰å­¦ä¼šæ²»ç–—ç–¾ç—…çš„æŠ€èƒ½');
                  return;
                }
                
                // æ£€æŸ¥æ˜¯å¦ç”Ÿç—…
                if (!gameData.status.isSick) {
                  showNotification('æ— éœ€æ²»ç–—', 'ä½ ç›®å‰æ²¡æœ‰ç”Ÿç—…');
                  return;
                }
                
                // è®¡ç®—æ²»ç–—æˆåŠŸç‡ï¼šåŸºç¡€40% + æ¯çº§5%
                const totalCureRate = Math.min(0.95, gameData.skills.medicine.cureSuccessRate + (gameData.skills.medicine.level * 0.05));
                // å°è¯•æ²»ç–—
                const success = Math.random() < totalCureRate;
                if (success) {
                  gameData.status.isSick = false;
                  gameData.status.health = Math.min(100, gameData.status.health + 10); // æ²»ç–—æˆåŠŸåæ¢å¤ä¸€äº›å¥åº·å€¼
                  
                  showNotification('æ²»ç–—æˆåŠŸ', 'ä½ æˆåŠŸæ²»æ„ˆäº†ç–¾ç—…ï¼å¥åº·å€¼æ¢å¤äº†10ç‚¹ã€‚');
                  
                  // æ²»ç–—æˆåŠŸå¢åŠ åŒ»æœ¯æŠ€èƒ½ç»éªŒå€¼
                  gameData.skills.medicine.experience += 2;
                  checkSkillLevelUp('medicine');
                } else {
                  showNotification('æ²»ç–—å¤±è´¥', 'æ²»ç–—å¤±è´¥äº†ï¼Œä½ éœ€è¦ä¼‘æ¯ä¸€ä¸‹å†å°è¯•ã€‚');
                }
                
                // æ›´æ–°æ¸¸æˆæ•°æ®
                updateGameData();
              };
            }
            break;
          case 'dog_beating_stick':
            specialEffect = 'å‡»ä¸­æ¦‚ç‡å¢åŠ 30%';
            // æ ‡è®°å·²å­¦ä¼šæ‰“ç‹—æ£’æ³•
            gameData.skills.martial.canUseDogStick = true;
            gameData.skills.martial.hitProbabilityBonus = 0.3; // 30%å‡»ä¸­æ¦‚ç‡åŠ æˆ
            // åˆå§‹åŒ–æ­¦æœ¯æ­¦åŠ›å€¼ï¼šåŸºç¡€10 + æ¯çº§5
            if (!gameData.skills.martial.power) {
                gameData.skills.martial.power = 10;
            }
            break;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('å­¦ä¹ æˆåŠŸ', `æˆåŠŸå­¦ä¹ äº†${resource.name}ï¼\n${skill.name}æŠ€èƒ½æå‡è‡³${skill.level}çº§ï¼\n${specialEffect}`);
      } else {
        showNotification('å­¦ä¹ å¤±è´¥', 'è¯¥æŠ€èƒ½å·²ç»è¾¾åˆ°æœ€é«˜ç­‰çº§');
        return;
      }
      
      // å¦‚æœæ˜¯ä¸€æ¬¡æ€§ä½¿ç”¨ç‰©å“ï¼Œæ¶ˆè€—ä¸€ä¸ª
      if (resource.oneTimeUse) {
        resource.amount--;
        
        // å¦‚æœæ•°é‡ä¸º0ä¸”ä¸å¯ä¸¢å¼ƒï¼Œä¿æŒåœ¨èƒŒåŒ…ä¸­ä½†æ˜¾ç¤ºä¸º0
        if (resource.amount <= 0 && !resource.cannotDrop) {
          // å¯ä»¥ä»èƒŒåŒ…ä¸­ç§»é™¤
          // è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¿ç•™ï¼Œåªæ˜¯æ•°é‡ä¸º0
        }
      }
      
      // æ›´æ–°UI
      updateResourceCard(resourceId);
      updateSkillDisplay(); // éœ€è¦å®ç°è¿™ä¸ªå‡½æ•°æ¥æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
      updateGameData();
    }
    
    // å¸ä¸‹è£…å¤‡
    function unequipItem(slotType, resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (resource) {
        // ç§»é™¤è£…å¤‡æ•ˆæœ
        applyEquipmentEffect(resourceId, 'unequip');
        
        // ç§»é™¤è£…å¤‡çŠ¶æ€
        resource.equipped = false;
        
        // æ›´æ–°è£…å¤‡æ§½
        updateEquipmentSlot(slotType);
        
        // æ›´æ–°èƒŒåŒ…
        updateResourceCard(resourceId);
        
        // æ›´æ–°UI
        updateGameData();
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification('å¸ä¸‹è£…å¤‡', `æˆåŠŸå¸ä¸‹äº†${resource.name}`);
      }
    }
    
    // åº”ç”¨è£…å¤‡æ•ˆæœ
    function applyEquipmentEffect(resourceId, action) {
      const resource = gameData.resources[resourceId];
      
      // æ ¹æ®è£…å¤‡ç±»å‹åº”ç”¨ä¸åŒæ•ˆæœ
      switch(resourceId) {
        case 'simple_clothes': // ç ´è¡£æœ
          if (action === 'equip') {
            gameData.status.cold += 10; // æé«˜ä¿æš–åº¦
            showNotification('è£…å¤‡æ•ˆæœ', 'ç ´è¡£æœæä¾›äº†åŸºæœ¬çš„ä¿æš–ï¼Œå¯’å†·å‡å°‘10ç‚¹');
          } else {
            gameData.status.cold -= 10; // ç§»é™¤ä¿æš–æ•ˆæœ
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç ´è¡£æœï¼Œå¯’å†·å¢åŠ 10ç‚¹');
          }
          break;
          
        case 'black_cloak': // é»‘è‰²æ–—ç¯·
          if (action === 'equip') {
            gameData.status.spirit += 15; // æé«˜ç²¾ç¥çŠ¶æ€
            // è§£é”é»‘å¸‚
            const blackMarket = gameData.locations.find(loc => loc.id === 'black_market');
            if (blackMarket) {
              blackMarket.available = true;
              showNotification('è£…å¤‡æ•ˆæœ', 'é»‘è‰²æ–—ç¯·è®©ä½ è·å¾—äº†è¿›å…¥é»‘å¸‚çš„èµ„æ ¼ï¼');
            }
            showNotification('è£…å¤‡æ•ˆæœ', 'é»‘è‰²æ–—ç¯·æå‡äº†ä½ çš„ç²¾ç¥çŠ¶æ€ï¼Œç²¾ç¥å¢åŠ 15ç‚¹');
          } else {
            gameData.status.spirit -= 15; // ç§»é™¤ç²¾ç¥æå‡
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–é»‘è‰²æ–—ç¯·
            if (gameData.resources.black_cloak.amount === 0) {
              // é”å®šé»‘å¸‚
              const blackMarket = gameData.locations.find(loc => loc.id === 'black_market');
              if (blackMarket) {
                blackMarket.available = false;
                showNotification('è£…å¤‡æ•ˆæœ', 'æ²¡æœ‰é»‘è‰²æ–—ç¯·ï¼Œæ— æ³•è¿›å…¥é»‘å¸‚');
              }
            }
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†é»‘è‰²æ–—ç¯·ï¼Œç²¾ç¥å‡å°‘15ç‚¹');
          }
          break;
          
        case 'crutch': // æ‹æ–
          if (action === 'equip') {
            gameData.status.strength += 5; // æé«˜æ­¦åŠ›å€¼
            gameData.status.reputation += 10; // æé«˜å£°æœ›
            showNotification('è£…å¤‡æ•ˆæœ', 'æ‹æ–å¸®åŠ©ä½ è¡Œèµ°ï¼Œæ­¦åŠ›å¢åŠ 5ç‚¹ï¼Œå£°æœ›å¢åŠ 10ç‚¹');
          } else {
            gameData.status.strength -= 5; // ç§»é™¤æ­¦åŠ›æå‡
            gameData.status.reputation -= 10; // ç§»é™¤å£°æœ›æå‡
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†æ‹æ–ï¼Œæ­¦åŠ›å‡å°‘5ç‚¹ï¼Œå£°æœ›å‡å°‘10ç‚¹');
          }
          break;
          
        case 'fine_clothes': // ç²¾ç¾åæœ
          if (action === 'equip') {
            gameData.status.reputation += 20; // å¤§å¹…æé«˜å£°æœ›
            gameData.status.cold += 15; // æé«˜ä¿æš–åº¦
            showNotification('è£…å¤‡æ•ˆæœ', 'ç²¾ç¾åæœè®©ä½ çœ‹èµ·æ¥ä½“é¢ï¼Œå£°æœ›å¢åŠ 20ç‚¹ï¼Œä¿æš–åº¦å¢åŠ 15ç‚¹');
          } else {
            gameData.status.reputation -= 20; // ç§»é™¤å£°æœ›æå‡
            gameData.status.cold -= 15; // ç§»é™¤ä¿æš–æ•ˆæœ
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç²¾ç¾åæœï¼Œå£°æœ›å‡å°‘20ç‚¹ï¼Œä¿æš–åº¦å‡å°‘15ç‚¹');
          }
          break;
          
        case 'silk_shoes': // ç¼é‹
          if (action === 'equip') {
            gameData.status.health += 10; // æé«˜å¥åº·åº¦
            gameData.status.cold += 10; // æé«˜ä¿æš–åº¦
            showNotification('è£…å¤‡æ•ˆæœ', 'ç¼é‹èˆ’é€‚ä¿æš–ï¼Œå¥åº·å¢åŠ 10ç‚¹ï¼Œä¿æš–åº¦å¢åŠ 10ç‚¹');
          } else {
            gameData.status.health -= 10; // ç§»é™¤å¥åº·æå‡
            gameData.status.cold -= 10; // ç§»é™¤ä¿æš–æ•ˆæœ
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç¼é‹ï¼Œå¥åº·å‡å°‘10ç‚¹ï¼Œä¿æš–åº¦å‡å°‘10ç‚¹');
          }
          break;
          
        case 'dog_beating_stick': // æ‰“ç‹—æ£’æ³•
          if (action === 'equip') {
            gameData.status.reputation += 30; // å¤§å¹…æé«˜å£°æœ›
            gameData.status.health += 15; // æé«˜å¥åº·åº¦
            showNotification('è£…å¤‡æ•ˆæœ', 'æ‰“ç‹—æ£’æ³•è®©ä½ æˆä¸ºä¸å¸®ä¼ äººï¼Œå£°æœ›å¢åŠ 30ç‚¹ï¼Œå¥åº·å¢åŠ 15ç‚¹');
          } else {
            gameData.status.reputation -= 30; // ç§»é™¤å£°æœ›æå‡
            gameData.status.health -= 15; // ç§»é™¤å¥åº·æå‡
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†æ‰“ç‹—æ£’æ³•ï¼Œå£°æœ›å‡å°‘30ç‚¹ï¼Œå¥åº·å‡å°‘15ç‚¹');
          }
          break;
          
        case 'bamboo_bow': // ç«¹å¼“
          if (action === 'equip') {
            // åˆå§‹åŒ–æ”»å‡»å’Œå‘½ä¸­ç‡å±æ€§ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (gameData.status.attack === undefined) gameData.status.attack = 0;
            if (gameData.status.accuracy === undefined) gameData.status.accuracy = 0;
            
            gameData.status.attack += 10; // æ”»å‡»+10
            gameData.status.accuracy += 10; // å‘½ä¸­ç‡+10%
            showNotification('è£…å¤‡æ•ˆæœ', 'ç«¹å¼“å·²è£…å¤‡ï¼Œæ”»å‡»å¢åŠ 10ç‚¹ï¼Œå‘½ä¸­ç‡å¢åŠ 10%');
          } else {
            gameData.status.attack -= 10; // ç§»é™¤æ”»å‡»æå‡
            gameData.status.accuracy -= 10; // ç§»é™¤å‘½ä¸­ç‡æå‡
            showNotification('è£…å¤‡æ•ˆæœ', 'å¸ä¸‹äº†ç«¹å¼“ï¼Œæ”»å‡»å‡å°‘10ç‚¹ï¼Œå‘½ä¸­ç‡å‡å°‘10%');
          }
          break;
      }
      
      // ç¡®ä¿çŠ¶æ€å€¼åœ¨åˆç†èŒƒå›´å†…
      for (const stat of ['cold', 'spirit', 'health', 'reputation', 'attack', 'accuracy']) {
        if (gameData.status[stat] !== undefined) {
          gameData.status[stat] = Math.max(0, Math.min(100, gameData.status[stat]));
        }
      }
      
      // æ›´æ–°UI
      updateGameData();
      renderLocations(); // æ›´æ–°åœ°ç‚¹æ˜¾ç¤º
    }

    // ä¿å­˜æ¸¸æˆè¿›åº¦åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆsaveæ–‡ä»¶å¤¹ï¼‰
    function saveGameProgress() {
      try {
        // åˆ›å»ºä¸€ä¸ªæ·±æ‹·è´ä»¥é¿å…å­˜å‚¨å¾ªç¯å¼•ç”¨
        const gameDataToSave = JSON.parse(JSON.stringify(gameData));
        
        // ç§»é™¤ä¸éœ€è¦ä¿å­˜çš„ä¸´æ—¶æ•°æ®
        delete gameDataToSave.uiState;
        delete gameDataToSave.tempData;
        
        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
        const currentDate = new Date();
        const timestamp = `${currentDate.getFullYear()}${String(currentDate.getMonth() + 1).padStart(2, '0')}${String(currentDate.getDate()).padStart(2, '0')}_${String(currentDate.getHours()).padStart(2, '0')}${String(currentDate.getMinutes()).padStart(2, '0')}`;
        const fileName = `beggar_save_${timestamp}.json`;
        
        // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
        localStorage.setItem('beggarSurvivalGameSave', JSON.stringify(gameDataToSave));
        
        // åˆ›å»ºå¯ä¸‹è½½çš„æ–‡ä»¶
        const jsonString = JSON.stringify(gameDataToSave, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = fileName;
        
        // è§¦å‘ä¸‹è½½
        document.body.appendChild(downloadLink);
        downloadLink.click();
        if (downloadLink.parentNode === document.body) {
        document.body.removeChild(downloadLink);
      }
        
        // æ¸…ç†URLå¯¹è±¡
        URL.revokeObjectURL(url);
        
        console.log('æ¸¸æˆè¿›åº¦å·²ä¿å­˜');
        showNotification('ä¿å­˜æˆåŠŸ', 'è¯·å°†æ–‡ä»¶ä¿å­˜åˆ°æ¸¸æˆç›®å½•ä¸‹çš„saveæ–‡ä»¶å¤¹ä¸­');
        
        return true;
      } catch (error) {
        console.error('ä¿å­˜æ¸¸æˆè¿›åº¦å¤±è´¥:', error);
        showNotification('ä¿å­˜å¤±è´¥', 'æ— æ³•ä¿å­˜æ¸¸æˆè¿›åº¦ï¼Œè¯·é‡è¯•');
        return false;
      }
    }
    
    // å¤„ç†å¼€å§‹ç•Œé¢çš„æ¸¸æˆåŠ è½½åŠŸèƒ½
    function handleLoadGame() {
      try {
        // å°è¯•ä½¿ç”¨Directory APIç›´æ¥é€‰æ‹©æ–‡ä»¶å¤¹
        if ('showDirectoryPicker' in window) {
          // ç›´æ¥è°ƒç”¨Directory APIé€‰æ‹©é»˜è®¤çš„saveæ–‡ä»¶å¤¹
          handleDirectorySelection('save').catch(error => {
            console.log('æ–‡ä»¶å¤¹é€‰æ‹©å¤±è´¥æˆ–å–æ¶ˆï¼Œåˆ‡æ¢åˆ°æ–‡ä»¶é€‰æ‹©æ¨¡å¼:', error);
            // é™çº§åˆ°ä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
            showTraditionalFilePicker();
          });
        } else {
          // ä¸æ”¯æŒDirectory APIï¼Œä½¿ç”¨ä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
          showTraditionalFilePicker();
        }
      } catch (error) {
        console.error('åŠ è½½æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
        showNotification('æ“ä½œå¤±è´¥', 'æ— æ³•åˆå§‹åŒ–æ¸¸æˆåŠ è½½åŠŸèƒ½');
        // ä½œä¸ºæœ€åçš„é™çº§æ–¹æ¡ˆï¼Œæ˜¾ç¤ºä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
        setTimeout(() => {
          showTraditionalFilePicker();
        }, 1000);
      }
    }
    
    // ä½¿ç”¨Directory APIå¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©
    async function handleDirectorySelection(defaultFolderName = null) {
      try {
        // è¯·æ±‚è®¿é—®æ–‡ä»¶å¤¹æƒé™
        const options = {
          mode: 'read'
        };
        
        // å¦‚æœæŒ‡å®šäº†é»˜è®¤æ–‡ä»¶å¤¹åç§°ï¼Œå°è¯•æ‰“å¼€è¯¥æ–‡ä»¶å¤¹
        if (defaultFolderName) {
          options.startIn = 'documents';
          options.suggestedName = defaultFolderName;
        } else {
          options.startIn = 'documents';
        }
        
        const directoryHandle = await window.showDirectoryPicker(options);
        
        console.log('å·²é€‰æ‹©æ–‡ä»¶å¤¹:', directoryHandle.name);
        showNotification('æ‰«æä¸­', 'æ­£åœ¨æ‰«ææ–‡ä»¶å¤¹ä¸­çš„å­˜æ¡£æ–‡ä»¶...');
        
        // è·å–æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰JSONæ–‡ä»¶
        const saveFiles = [];
        for await (const [name, handle] of directoryHandle.entries()) {
          if (handle.kind === 'file' && name.endsWith('.json')) {
            saveFiles.push({ name, handle });
          }
        }
        
        // æŒ‰æ–‡ä»¶åæ’åºï¼ˆå‡è®¾æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼Œæœ€æ–°çš„åº”è¯¥åœ¨æœ€åï¼‰
        saveFiles.sort((a, b) => a.name.localeCompare(b.name));
        
        if (saveFiles.length === 0) {
          showNotification('æœªæ‰¾åˆ°å­˜æ¡£', 'åœ¨é€‰æ‹©çš„æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°JSONå­˜æ¡£æ–‡ä»¶');
          return;
        }
        
        // æ„å»ºå­˜æ¡£é€‰æ‹©èœå•çš„HTML
        let saveOptions = '';
        saveFiles.forEach((file, index) => {
          saveOptions += `<option value="${index}">${file.name}</option>`;
        });
        
        // åˆ›å»ºä¸´æ—¶è¡¨å•è¿›è¡Œå­˜æ¡£é€‰æ‹©
        const selectionHTML = `
          <div style="padding: 15px;">
            <h3>é€‰æ‹©å­˜æ¡£æ–‡ä»¶</h3>
            <p>åœ¨ ${directoryHandle.name} æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ° ${saveFiles.length} ä¸ªå­˜æ¡£æ–‡ä»¶ï¼š</p>
            <select id="saveFileSelect" style="width: 100%; padding: 10px; margin: 10px 0;">
              ${saveOptions}
            </select>
            <p style="font-size: 0.9em; color: gray;">æç¤ºï¼šå¦‚æœéœ€è¦æµè§ˆå…¶ä»–æ–‡ä»¶å¤¹ï¼Œè¯·ç‚¹å‡»å–æ¶ˆåé‡æ–°å°è¯•</p>
          </div>
        `;
        
        // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†é€‰æ‹©å­˜æ¡£
        const userChoice = await showCustomConfirm('é€‰æ‹©å­˜æ¡£', selectionHTML);
        
        if (userChoice.confirmed && userChoice.selectedIndex >= 0) {
          const selectedIndex = userChoice.selectedIndex;
          const selectedFile = saveFiles[selectedIndex];
          
          // è·å–æ–‡ä»¶å¯¹è±¡å¹¶ä¼ é€’ç»™processSaveFile
          const file = await selectedFile.handle.getFile();
          
          // å¤„ç†é€‰ä¸­çš„å­˜æ¡£æ–‡ä»¶
          processSaveFile(file);
          
          console.log('å·²æˆåŠŸåŠ è½½å­˜æ¡£:', selectedFile.name);
        }
      } catch (error) {
        // å¦‚æœæ˜¯ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œä¸è®°å½•ä¸ºé”™è¯¯
        if (error.name === 'AbortError') {
          console.log('ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶å¤¹é€‰æ‹©');
          showNotification('æ“ä½œå–æ¶ˆ', 'æ‚¨å·²å–æ¶ˆæ–‡ä»¶å¤¹é€‰æ‹©');
          return; // é™é»˜è¿”å›ï¼Œä¸è§¦å‘é™çº§
        }
        // å¯¹äºå…¶ä»–é”™è¯¯ï¼Œè®°å½•é”™è¯¯æ—¥å¿—
        console.error('å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©æ—¶å‡ºé”™:', error);
        // æ˜¾ç¤ºé€šçŸ¥å¹¶é‡æ–°æŠ›å‡ºä»¥è§¦å‘é™çº§
        showNotification('æ“ä½œå¤±è´¥', 'æ–‡ä»¶å¤¹é€‰æ‹©è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
        throw error;
      }
    }
    
    // æ˜¾ç¤ºä¼ ç»Ÿçš„æ–‡ä»¶é€‰æ‹©å™¨
    function showTraditionalFilePicker() {
      // é¦–å…ˆæ˜¾ç¤ºæŒ‡å¼•ä¿¡æ¯ï¼Œå¸®åŠ©ç”¨æˆ·æ‰¾åˆ°saveæ–‡ä»¶å¤¹
      const saveFolderPath = 'beggar_survival_game\\save';
      const guidanceMessage = `è¯·åœ¨æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ä¸­å¯¼èˆªåˆ°ä»¥ä¸‹è·¯å¾„é€‰æ‹©å­˜æ¡£æ–‡ä»¶ï¼š\n\n${saveFolderPath}\n\næ­¥éª¤ï¼š\n1. åœ¨æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ä¸­å¯¼èˆªåˆ°æ¸¸æˆæ‰€åœ¨ç›®å½•\n2. æ‰“å¼€"save"æ–‡ä»¶å¤¹\n3. é€‰æ‹©ä¸€ä¸ª.jsonå­˜æ¡£æ–‡ä»¶\n\næç¤ºï¼šå¦‚æœä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½ã€‚`;
      
      // æ˜¾ç¤ºæŒ‡å¼•ä¿¡æ¯
      alert(guidanceMessage);
      
      // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      // é™åˆ¶åªèƒ½é€‰æ‹©JSONæ–‡ä»¶
      fileInput.accept = '.json';
      // æ·»åŠ multipleå±æ€§ï¼Œå…è®¸é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼ˆè™½ç„¶æˆ‘ä»¬ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªï¼‰
      fileInput.multiple = false;
      
      // æ·»åŠ æ–‡ä»¶é€‰æ‹©åçš„å¤„ç†é€»è¾‘
      fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          processSaveFile(file);
        }
      };
      
      // è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨
      fileInput.click();
    }
    
    // å¤„ç†é€‰ä¸­çš„å­˜æ¡£æ–‡ä»¶
    function processSaveFile(file) {
      console.log('é€‰æ‹©çš„æ–‡ä»¶:', file.name);
      // æ˜¾ç¤ºåŠ è½½ä¸­çš„æç¤º
      showNotification('åŠ è½½ä¸­', `æ­£åœ¨è¯»å–å­˜æ¡£æ–‡ä»¶: ${file.name}...`);
      
      // è¯»å–æ–‡ä»¶å†…å®¹
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          // è§£æJSONå†…å®¹
          const loadedGameData = JSON.parse(e.target.result);
          
          // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
          if (!loadedGameData.day || !loadedGameData.resources || !loadedGameData.status) {
            throw new Error('å­˜æ¡£æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œç¼ºå°‘å¿…è¦å­—æ®µ');
          }
          
          // æ¸…ç©ºå½“å‰gameDataå¹¶åŠ è½½ä¿å­˜çš„æ•°æ®ï¼ˆä¿ç•™uiStateå’ŒtempDataï¼‰
          Object.keys(gameData).forEach(key => {
            if (key !== 'uiState' && key !== 'tempData') {
              delete gameData[key];
            }
          });
          
          // åˆå¹¶åŠ è½½çš„æ•°æ®åˆ°gameData
          Object.assign(gameData, loadedGameData);
          
          // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
          localStorage.setItem('beggarSurvivalGameSave', JSON.stringify(gameData));
          
          // æ˜¾ç¤ºåŠ è½½æˆåŠŸæç¤º
          showNotification('åŠ è½½æˆåŠŸ', `æˆåŠŸåŠ è½½å­˜æ¡£: ${file.name}`);
          
          // åˆ‡æ¢åˆ°æ¸¸æˆç•Œé¢
          switchToGameView();
          
          // é‡æ–°åˆå§‹åŒ–æ¸¸æˆï¼Œåº”ç”¨åŠ è½½çš„æ•°æ®
          initGame();
          
        } catch (parseError) {
          console.error('è§£æå­˜æ¡£æ–‡ä»¶å¤±è´¥:', parseError);
          showNotification('åŠ è½½å¤±è´¥', 'æ— æ³•è§£æå­˜æ¡£æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
        }
      };
      
      reader.onerror = function() {
        console.error('è¯»å–æ–‡ä»¶å¤±è´¥');
        showNotification('è¯»å–å¤±è´¥', 'æ— æ³•è¯»å–å­˜æ¡£æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå');
      };
            
      reader.readAsText(file);
    }
    
    // åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾å‡½æ•°
    function switchToGameView() {
      try {
        debugLog('åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾');
        // å¦‚æœå¼€å§‹å±å¹•å­˜åœ¨ï¼Œéšè—å®ƒ
        if (elements.startScreen) {
          elements.startScreen.style.opacity = '0';
          elements.startScreen.style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ¸¸æˆå®¹å™¨
        if (elements.gameContainer) {
          elements.gameContainer.style.display = 'block';
        }
        
        debugLog('å·²åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾');
      } catch (error) {
        console.error('åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾æ—¶å‡ºé”™:', error);
        showNotification('åˆ‡æ¢å¤±è´¥', 'æ— æ³•åˆ‡æ¢åˆ°æ¸¸æˆè§†å›¾');
      }
    }

    // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
    function showCustomConfirm(title, contentHTML) {
      return new Promise((resolve) => {
        // åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #fff;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.2);
          z-index: 10000;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          font-family: Arial, sans-serif;
        `;
        
        // åˆ›å»ºæ ‡é¢˜
        const dialogTitle = document.createElement('h2');
        dialogTitle.textContent = title;
        dialogTitle.style.cssText = 'margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;';
        
        // åˆ›å»ºå†…å®¹å®¹å™¨
        const contentContainer = document.createElement('div');
        contentContainer.innerHTML = contentHTML;
        
        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'margin-top: 20px; text-align: right;';
        
        // åˆ›å»ºå–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.style.cssText = `
          padding: 10px 20px;
          margin-right: 10px;
          background-color: #f0f0f0;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 16px;
        `;
        
        // åˆ›å»ºç¡®è®¤æŒ‰é’®
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®è®¤';
        confirmButton.style.cssText = `
          padding: 10px 20px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 16px;
        `;
        
        // åˆ›å»ºèƒŒæ™¯é®ç½©
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 9999;
        `;
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬
        cancelButton.addEventListener('click', () => {
          if (dialog.parentNode === document.body) {
        document.body.removeChild(dialog);
      }
      if (overlay.parentNode === document.body) {
        document.body.removeChild(overlay);
      }
          resolve({ confirmed: false, selectedIndex: -1 });
        });
        
        confirmButton.addEventListener('click', () => {
          const selectElement = document.getElementById('saveFileSelect');
          const selectedIndex = selectElement ? parseInt(selectElement.value, 10) : -1;
          if (dialog.parentNode === document.body) {
        document.body.removeChild(dialog);
      }
      if (overlay.parentNode === document.body) {
        document.body.removeChild(overlay);
      }
          resolve({ confirmed: true, selectedIndex });
        });
        
        // æ·»åŠ é”®ç›˜äº‹ä»¶
        dialog.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            cancelButton.click();
          } else if (event.key === 'Enter') {
            confirmButton.click();
          }
        });
        
        // ç»„è£…å¯¹è¯æ¡†
        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(confirmButton);
        dialog.appendChild(dialogTitle);
        dialog.appendChild(contentContainer);
        dialog.appendChild(buttonContainer);
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);
        
        // èšç„¦åˆ°ç¡®è®¤æŒ‰é’®
        confirmButton.focus();
      });
    }
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆè¿›åº¦
    function loadGameProgress() {
      try {
        const savedGameData = localStorage.getItem('beggarSurvivalGameSave');
        
        if (!savedGameData) {
          console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆè¿›åº¦');
          showNotification('æœªæ‰¾åˆ°å­˜æ¡£', 'æ²¡æœ‰æ£€æµ‹åˆ°å·²ä¿å­˜çš„æ¸¸æˆè¿›åº¦');
          return false;
        }
        
        const parsedData = JSON.parse(savedGameData);
        
        // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
        if (!parsedData.day || !parsedData.resources || !parsedData.status) {
          throw new Error('ä¿å­˜çš„æ•°æ®æ ¼å¼æ— æ•ˆ');
        }
        
        // æ¸…ç©ºå½“å‰gameDataå¹¶åŠ è½½ä¿å­˜çš„æ•°æ®
        Object.keys(gameData).forEach(key => {
          if (key !== 'uiState' && key !== 'tempData') {
            delete gameData[key];
          }
        });
        
        // åˆå¹¶ä¿å­˜çš„æ•°æ®åˆ°gameData
        Object.assign(gameData, parsedData);
        
        console.log('æ¸¸æˆè¿›åº¦å·²åŠ è½½');
        showNotification('åŠ è½½æˆåŠŸ', 'æ¸¸æˆè¿›åº¦å·²æˆåŠŸåŠ è½½');
        
        // æ›´æ–°UIä»¥åæ˜ åŠ è½½çš„æ¸¸æˆçŠ¶æ€
        updateGameData();
        renderResources();
        renderLocations();
        renderActions();
        renderEquipmentSlots();
        
        return true;
      } catch (error) {
        console.error('åŠ è½½æ¸¸æˆè¿›åº¦å¤±è´¥:', error);
        showNotification('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½æ¸¸æˆè¿›åº¦ï¼Œå­˜æ¡£å¯èƒ½å·²æŸå');
        return false;
      }
    }
    
    // æ›´æ–°æ¸¸æˆæ•°æ®
    function updateGameData() {
      elements.dayNumber.textContent = gameData.day;
      
      // æ›´æ–°æ—¶é—´æ®µ
      const timeOfDayMap = {
        early_morning: 'æ¸…æ™¨',
        morning: 'ä¸Šåˆ',
        afternoon: 'ä¸‹åˆ',
        evening: 'å‚æ™š',
        night: 'å¤œæ™š'
      };
      elements.timeOfDay.textContent = timeOfDayMap[gameData.timeOfDay];
      
      // æ›´æ–°çŠ¶æ€ç™¾åˆ†æ¯”æ˜¾ç¤º
      elements.hungerPercentage.textContent = `${100 - gameData.status.hunger}%`;
      elements.coldPercentage.textContent = `${gameData.status.cold}%`;
      elements.healthPercentage.textContent = `${gameData.status.health}%`;
      elements.spiritPercentage.textContent = `${gameData.status.spirit}%`;
      elements.reputationPercentage.textContent = `${gameData.status.reputation}%`;
      elements.thirstPercentage.textContent = `${gameData.status.thirst}%`;
      elements.actionPointsValue.textContent = `${gameData.status.actionPoints}/20`;
      
      // æ›´æ–°å­£èŠ‚
      const seasons = {
        spring: { icon: 'ğŸŒ±', name: 'æ˜¥å­£' },
        summer: { icon: 'â˜€ï¸', name: 'å¤å­£' },
        autumn: { icon: 'ğŸ‚', name: 'ç§‹å­£' },
        winter: { icon: 'â„ï¸', name: 'å†¬å­£' }
      };
      
      elements.seasonIcon.textContent = seasons[gameData.season].icon;
      elements.seasonName.textContent = seasons[gameData.season].name;
      

      // æ›´æ–°è¿›åº¦æ¡
      elements.hungerBar.style.width = `${100 - gameData.status.hunger}%`;
      elements.coldBar.style.width = `${gameData.status.cold}%`;
      elements.healthBar.style.width = `${gameData.status.health}%`;
      elements.spiritBar.style.width = `${gameData.status.spirit}%`;
      elements.reputationBar.style.width = `${gameData.status.reputation}%`;
      elements.thirstBar.style.width = `${gameData.status.thirst}%`;
      elements.actionPointsBar.style.width = `${(gameData.status.actionPoints / 20) * 100}%`;
      
      // æ›´æ–°ç»Ÿè®¡æ•°æ®
      gameData.stats.daysSurvived = gameData.day - 1;
      gameData.stats.maxReputation = Math.max(gameData.stats.maxReputation, gameData.status.reputation);
    }
    
    // æ›´æ–°å•ä¸ªèµ„æºå¡ç‰Œçš„æ˜¾ç¤º
    function updateResourceCard(resourceId) {
      const resource = gameData.resources[resourceId];
      
      // å¦‚æœèµ„æºæ•°é‡ä¸º0ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥ä¸¢å¼ƒ
      if (resource.amount <= 0) {
        // ç‰¹æ®Šå­¦ä¹ ç‰©å“(type: 'learnable')å³ä½¿æ ‡è®°ä¸ºä¸å¯ä¸¢å¼ƒï¼Œä½¿ç”¨åä¹Ÿåº”ç§»é™¤
        // å…¶ä»–ä¸å¯ä¸¢å¼ƒç‰©å“(cannotDrop)å³ä½¿æ•°é‡ä¸º0ä¹Ÿä¸ç§»é™¤å¡ç‰Œ
        if (resource.type !== 'learnable' && resource.cannotDrop) {
          // ç»§ç»­æ‰§è¡Œåç»­ä»£ç ä»¥æ›´æ–°å¡ç‰Œæ˜¾ç¤ºä¸ºæ•°é‡0
        } else {
          // å¯ä¸¢å¼ƒç‰©å“å’Œå­¦ä¹ ç‰©å“æ•°é‡ä¸º0æ—¶ç§»é™¤å¡ç‰Œ
          const card = document.querySelector(`.resource-card[data-resource="${resourceId}"]`);
          if (card) {
            card.remove();
          }
          return;
        }
      }
      
      // æŸ¥æ‰¾ç°æœ‰çš„å¡ç‰Œ
      let card = document.querySelector(`.resource-card[data-resource="${resourceId}"]`);
      
      // å¦‚æœå¡ç‰Œä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
      if (!card) {
        card = document.createElement('div');
        card.className = 'card resource resource-card';
        card.setAttribute('draggable', 'true');
        card.setAttribute('data-resource', resourceId);
        elements.resourceGrid.appendChild(card);
      }
      
      // æ›´æ–°å¡ç‰Œå†…å®¹
      card.innerHTML = `
        <div class="card-image" style="background-image: url('${resource.image}'); background-size: cover; background-position: center; position: relative; display: flex;">
            <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
            <div class="image-fallback" style="display: flex; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
          ${resource.equipped ? `
            <div class="equipped-badge" style="position: absolute; top: 0.25rem; right: 0.25rem; background-color: #805AD5; color: white; border-radius: 50%; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">
              å·²ç©¿
            </div>
          ` : ''}
        </div>
        <div class="card-content">
          <div class="card-title">${resource.name}</div>
          <div class="resource-count">${resource.amount}</div>
          ${resource.durability !== undefined ? `
            <div class="card-durability" style="margin-top: 0.25rem;">
              <div class="durability-bar-container" style="height: 4px; background-color: #E2E8F0; border-radius: 2px; overflow: hidden;">
                <div class="durability-bar" style="height: 100%; width: ${resource.durability}%; background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'};"></div>
              </div>
              <div class="durability-text" style="font-size: 0.75rem; text-align: right; margin-top: 0.125rem;">${resource.durability}%</div>
            </div>
          ` : ''}
        </div>
      `;
      
      // ç§»é™¤ç°æœ‰çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
      const newCard = card.cloneNode(true);
      card.parentNode.replaceChild(newCard, card);
      
      // ä¸ºæ°´è¢‹ï¼ˆæ»¡ï¼‰æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
      if (resourceId === 'water_bag') {
        newCard.addEventListener('click', function() {
          showWaterBagConfirmWindow(resourceId);
        });
      } else if (resourceId === 'dirty_water_bowl' || resourceId === 'clean_water_bowl') {
        // ä¿ç•™åŸæœ‰çš„æ°´ç¢—ç‚¹å‡»é€»è¾‘
        newCard.addEventListener('click', function() {
          handleResourceClick(resourceId);
        });
      }
    }

    // æ˜¾ç¤ºæ°´è¢‹é¥®ç”¨ç¡®è®¤å¼¹çª—
    function showWaterBagConfirmWindow(resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (!resource || resource.amount <= 0) return;
      
      // åˆ›å»ºæ¨¡æ€çª—å£å®¹å™¨
      const modalContainer = document.createElement('div');
      modalContainer.className = 'modal-overlay';
      modalContainer.style.position = 'fixed';
      modalContainer.style.top = '0';
      modalContainer.style.left = '0';
      modalContainer.style.width = '100%';
      modalContainer.style.height = '100%';
      modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
      modalContainer.style.display = 'flex';
      modalContainer.style.alignItems = 'center';
      modalContainer.style.justifyContent = 'center';
      modalContainer.style.zIndex = '1000';
      
      // åˆ›å»ºæ¨¡æ€çª—å£å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.style.backgroundColor = 'white';
      modalContent.style.borderRadius = '8px';
      modalContent.style.padding = '1.5rem';
      modalContent.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
      modalContent.style.maxWidth = '300px';
      modalContent.style.width = '100%';
      
      // æ·»åŠ æ ‡é¢˜
      const title = document.createElement('h3');
      title.textContent = 'ç¡®è®¤é¥®ç”¨';
      title.style.marginTop = '0';
      title.style.marginBottom = '1rem';
      title.style.fontSize = '1.25rem';
      title.style.fontWeight = 'bold';
      title.style.color = '#1A202C';
      modalContent.appendChild(title);
      
      // æ·»åŠ å†…å®¹
      const content = document.createElement('p');
      content.textContent = 'ä½ ç¡®å®šè¦é¥®ç”¨è¿™ä¸ªæ°´è¢‹é‡Œçš„æ°´å—ï¼Ÿé¥®ç”¨åæ°´è¢‹ä¼šå˜æˆç©ºçš„ï¼Œä½†å¯ä»¥å†æ¬¡è£…æ»¡ã€‚';
      content.style.marginBottom = '1.5rem';
      content.style.color = '#4A5568';
      modalContent.appendChild(content);
      
      // åˆ›å»ºæŒ‰é’®å®¹å™¨
      const buttonContainer = document.createElement('div');
      buttonContainer.style.display = 'flex';
      buttonContainer.style.justifyContent = 'flex-end';
      buttonContainer.style.gap = '0.75rem';
      modalContent.appendChild(buttonContainer);
      
      // åˆ›å»ºå–æ¶ˆæŒ‰é’®
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'å–æ¶ˆ';
      cancelButton.style.padding = '0.5rem 1rem';
      cancelButton.style.backgroundColor = '#E2E8F0';
      cancelButton.style.color = '#4A5568';
      cancelButton.style.border = 'none';
      cancelButton.style.borderRadius = '4px';
      cancelButton.style.fontSize = '0.875rem';
      cancelButton.style.cursor = 'pointer';
      cancelButton.style.transition = 'background-color 0.2s';
      
      cancelButton.addEventListener('mouseover', function() {
        cancelButton.style.backgroundColor = '#CBD5E0';
      });
      
      cancelButton.addEventListener('mouseout', function() {
        cancelButton.style.backgroundColor = '#E2E8F0';
      });
      
      cancelButton.addEventListener('click', function() {
        if (modalContainer.parentNode === document.body) {
        if (modalContainer.parentNode === document.body) {
        document.body.removeChild(modalContainer);
      }
      }
      });
      
      buttonContainer.appendChild(cancelButton);
      
      // åˆ›å»ºç¡®è®¤æŒ‰é’®
      const confirmButton = document.createElement('button');
      confirmButton.textContent = 'ç¡®å®š';
      confirmButton.style.padding = '0.5rem 1rem';
      confirmButton.style.backgroundColor = '#805AD5';
      confirmButton.style.color = 'white';
      confirmButton.style.border = 'none';
      confirmButton.style.borderRadius = '4px';
      confirmButton.style.fontSize = '0.875rem';
      confirmButton.style.cursor = 'pointer';
      confirmButton.style.transition = 'background-color 0.2s';
      
      confirmButton.addEventListener('mouseover', function() {
        confirmButton.style.backgroundColor = '#6B46C1';
      });
      
      confirmButton.addEventListener('mouseout', function() {
        confirmButton.style.backgroundColor = '#805AD5';
      });
      
      confirmButton.addEventListener('click', function() {
        document.body.removeChild(modalContainer);
        drinkWaterBag();
      });
      
      buttonContainer.appendChild(confirmButton);
      
      // æ·»åŠ æ¨¡æ€çª—å£åˆ°æ–‡æ¡£
      modalContainer.appendChild(modalContent);
      document.body.appendChild(modalContainer);
    }
    
    // å¤„ç†èµ„æºç‚¹å‡»
    function handleResourceClick(resourceId) {
      const resource = gameData.resources[resourceId];
      
      if (!resource || resource.amount <= 0) return;
      
      // å¤„ç†æ°´ç±»å¡ç‰Œçš„é¥®ç”¨
      if (resourceId === 'dirty_water_bowl') {
        // é¥®ç”¨è„æ°´
        resource.amount--;
        gameData.status.thirst = Math.min(100, gameData.status.thirst + 30); // å¢åŠ 30ç‚¹å£æ¸´å€¼
        gameData.status.health = Math.max(0, gameData.status.health - 15);   // å‡å°‘15ç‚¹å¥åº·å€¼
        showNotification('é¥®ç”¨è„æ°´', 'ä½ å–äº†ä¸€å£è„æ°´ï¼Œè™½ç„¶è§£æ¸´ä½†æ„Ÿè§‰ä¸å¤ªèˆ’æœï¼Œå¥åº·æœ‰æ‰€ä¸‹é™ã€‚');
        updateResourceCard(resourceId);
        updateGameData();
      } else if (resourceId === 'clean_water_bowl') {
        // é¥®ç”¨å¹²å‡€æ°´
        resource.amount--;
        gameData.status.thirst = Math.min(100, gameData.status.thirst + 50); // å¢åŠ 50ç‚¹å£æ¸´å€¼
        showNotification('é¥®ç”¨å¹²å‡€æ°´', 'ä½ å–äº†ä¸€ç¢—å¹²å‡€çš„æ°´ï¼Œæ„Ÿè§‰å¥½å¤šäº†ï¼');
        updateResourceCard(resourceId);
        updateGameData();
      }
    }
    
    // é¥®ç”¨æ»¡æ°´è¢‹
    function drinkWaterBag() {
      const waterBag = gameData.resources['water_bag'];
      const emptyWaterBag = gameData.resources['empty_water_bag'];
      
      if (!waterBag || waterBag.amount <= 0) {
        showNotification('é”™è¯¯', 'ä½ æ²¡æœ‰å¯ä»¥é¥®ç”¨çš„æ°´è¢‹ã€‚');
        return;
      }
      
      // å‡å°‘æ»¡æ°´è¢‹æ•°é‡
      waterBag.amount--;
      
      // å¢åŠ ç©ºæ°´è¢‹æ•°é‡
      emptyWaterBag.amount++;
      
      // å¢åŠ å£æ¸´å€¼50ç‚¹
      gameData.status.thirst = Math.min(100, gameData.status.thirst + 50);
      
      // æ˜¾ç¤ºé€šçŸ¥
      showNotification('é¥®ç”¨äº†æ°´è¢‹é‡Œçš„æ°´', 'ä½ å–äº†æ°´è¢‹é‡Œçš„æ°´ï¼Œå£æ¸´æ„Ÿå¾—åˆ°äº†ç¼“è§£ã€‚æ°´è¢‹å˜æˆäº†ç©ºçš„ã€‚');
      
      // æ›´æ–°UIå’Œæ¸¸æˆæ•°æ®
      updateResourceCard('water_bag');
      updateResourceCard('empty_water_bag');
      updateGameData();
    }
    
    // å…¨å±€å˜é‡ç”¨äºè·Ÿè¸ªå½“å‰åˆ†ç±»å’Œé¡µç 
    let currentCategory = 'all';
    let currentPage = 1;
    const itemsPerPage = 20;
    
    // æ·»åŠ ç¼ºå¤±çš„åˆ†ç±»å±æ€§çš„å‡½æ•°
    function ensureResourceCategories() {
        for (const [id, resource] of Object.entries(gameData.resources)) {
            if (!resource.category) {
                // é»˜è®¤åˆ†ç±»ä¸ºææ–™
                gameData.resources[id].category = 'material';
            }
        }
    }
    
    // æ¸²æŸ“èµ„æº
    function renderResources() {
      // ç¡®ä¿æ‰€æœ‰èµ„æºéƒ½æœ‰åˆ†ç±»
      ensureResourceCategories();
      
      elements.resourceGrid.innerHTML = '';
      
      // ç­›é€‰èµ„æº - åªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„èµ„æº
      let filteredResources = [];
      for (const [id, resource] of Object.entries(gameData.resources)) {
        // åªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„èµ„æºï¼Œå¹¶ä¸”ç¬¦åˆå½“å‰é€‰ä¸­çš„åˆ†ç±»
        if ((currentCategory === 'all' || resource.category === currentCategory) && resource.amount > 0) {
            filteredResources.push({ id, resource });
        }
      }
      
      // è®¡ç®—æ€»é¡µæ•°
      const totalPages = Math.ceil(filteredResources.length / itemsPerPage);
      
      // æ›´æ–°å½“å‰é¡µç ï¼ˆå¦‚æœè¶…å‡ºèŒƒå›´ï¼‰
      if (currentPage > totalPages && totalPages > 0) {
          currentPage = totalPages;
      } else if (currentPage < 1) {
          currentPage = 1;
      }
      
      // æ›´æ–°é¡µç æ˜¾ç¤º
      const pageInfo = document.getElementById('pageInfo');
      if (pageInfo) {
          pageInfo.textContent = `ç¬¬ ${currentPage}/${totalPages} é¡µ`;
      }
      
      // æ›´æ–°ç¿»é¡µæŒ‰é’®çŠ¶æ€
      const prevButton = document.getElementById('prevPage');
      const nextButton = document.getElementById('nextPage');
      if (prevButton) prevButton.disabled = currentPage <= 1;
      if (nextButton) nextButton.disabled = currentPage >= totalPages;
      
      // æ›´æ–°åˆ†ç±»æ ‡ç­¾æ ·å¼
      document.querySelectorAll('.inventory-tab').forEach(tab => {
          // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„èƒŒæ™¯è‰²ç±»å’Œå¼ºè°ƒæ ·å¼
          tab.classList.remove('bg-purple-600', 'bg-green-600', 'bg-blue-600', 'bg-yellow-600', 'bg-gray-100', 'text-white', 'text-gray-600', 'border-purple-700', 'border-green-700', 'border-blue-700', 'border-yellow-700');
          
          // é‡ç½®å†…è”æ ·å¼
          tab.style.borderWidth = '';
          tab.style.fontWeight = '';
          tab.style.boxShadow = '';
          tab.style.transform = '';
          
          if (tab.dataset.category === currentCategory) {
              tab.classList.add('active', 'text-white');
              // ä¸ºä¸åŒåˆ†ç±»è®¾ç½®ä¸åŒçš„èƒŒæ™¯é¢œè‰²å’Œå¼ºè°ƒæ ·å¼
              switch(tab.dataset.category) {
                  case 'all':
                      tab.classList.add('bg-purple-600', 'border-purple-700'); // å…¨éƒ¨ - ç´«è‰²
                      break;
                  case 'food':
                      tab.classList.add('bg-green-600', 'border-green-700'); // é£Ÿç‰© - ç»¿è‰²
                      break;
                  case 'material':
                      tab.classList.add('bg-blue-600', 'border-blue-700'); // åŸºç¡€ææ–™ - è“è‰²
                      break;
                  case 'equipment':
                      tab.classList.add('bg-yellow-600', 'border-yellow-700'); // è£…å¤‡ - é»„è‰²
                      break;
                  default:
                      tab.classList.add('bg-purple-600', 'border-purple-700'); // é»˜è®¤ - ç´«è‰²
              }
              // æ·»åŠ å¼ºè°ƒæ•ˆæœ
              tab.style.borderWidth = '2px';
              tab.style.fontWeight = 'bold';
              tab.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
              tab.style.transform = 'translateY(-1px) scale(1.05)';
              tab.style.transition = 'all 0.2s ease';
          } else {
              tab.classList.remove('active');
              tab.classList.add('bg-gray-100', 'text-gray-600');
          }
      });
      
      // è®¡ç®—å½“å‰é¡µæ˜¾ç¤ºçš„èµ„æº
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, filteredResources.length);
      const currentPageResources = filteredResources.slice(startIndex, endIndex);
      
      // æ˜¾ç¤ºå½“å‰é¡µçš„èµ„æºé¡¹
      for (const { id, resource } of currentPageResources) {
        const resourceCard = document.createElement('div');
      resourceCard.className = 'card resource resource-card';
      resourceCard.setAttribute('draggable', 'true');
      resourceCard.setAttribute('data-resource', id);
        
        resourceCard.innerHTML = `
          <div class="card-image" style="background-image: url('${resource.image}'); background-size: cover; background-position: center; position: relative; min-height: 100px; display: flex;">
            <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
            <div class="image-fallback" style="display: flex; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
            ${resource.equipped ? `
              <div class="equipped-badge" style="position: absolute; top: 0.25rem; right: 0.25rem; background-color: #805AD5; color: white; border-radius: 50%; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">
                å·²ç©¿
              </div>
            ` : ''}
          </div>
          <div class="card-content">
            <div class="card-title">${resource.name}</div>
            <div class="resource-count">${resource.amount}</div>
            ${resource.durability !== undefined ? `
              <div class="card-durability" style="margin-top: 0.25rem;">
                <div class="durability-bar-container" style="height: 4px; background-color: #E2E8F0; border-radius: 2px; overflow: hidden;">
                  <div class="durability-bar" style="height: 100%; width: ${resource.durability}%; background-color: ${resource.durability > 50 ? '#38A169' : resource.durability > 20 ? '#D69E2E' : '#E53E3E'};"></div>
                </div>
                <div class="durability-text" style="font-size: 0.75rem; text-align: right; margin-top: 0.125rem;">${resource.durability}%</div>
              </div>
            ` : ''}
          </div>
        `;
        
        elements.resourceGrid.appendChild(resourceCard);
        
        // å®Œå…¨é‡å†™çš„å›¾ç‰‡åŠ è½½æœºåˆ¶ï¼Œä¿®å¤å¼‚æ­¥é—®é¢˜å’Œæ·»åŠ æ›´å¤šå®¹é”™
        const imgUrl = resource.image;
        const img = new Image();
        
        // ç«‹å³è®¾ç½®åˆå§‹å›¾ç‰‡è·¯å¾„ï¼ˆä¸å†ç­‰å¾…åŠ è½½æˆåŠŸï¼‰
        const cardImage = resourceCard.querySelector('.card-image');
        const fallback = resourceCard.querySelector('.image-fallback');
        
        // ç›´æ¥è®¾ç½®èƒŒæ™¯å›¾ç‰‡ï¼Œè¿™æ ·å³ä½¿åŠ è½½å¤±è´¥ï¼Œåç»­ä»£ç ä»ä¼šå°è¯•ä¿®å¤
        cardImage.style.backgroundImage = `url('${imgUrl}')`;
        
        // ä¸ºæ°´è¢‹ï¼ˆæ»¡ï¼‰å¡ç‰Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        if (id === 'water_bag') {
          resourceCard.addEventListener('click', function() {
            showWaterBagConfirmWindow(id);
          });
        }
        
        // å°è¯•åŠ è½½å›¾ç‰‡çš„å‡½æ•° - åŒæ­¥æ–¹å¼
        function tryLoadImageSync(url) {
          return new Promise((resolve) => {
            const testImg = new Image();
            testImg.onload = function() {
              console.log(`æˆåŠŸåŠ è½½å›¾ç‰‡: ${url} ä¸ºèµ„æº: ${resource.name}`);
              cardImage.style.backgroundImage = `url('${url}')`;
              if (fallback) fallback.style.display = 'none';
              resolve(true);
            };
            testImg.onerror = function() {
              console.log(`å°è¯•åŠ è½½å›¾ç‰‡å¤±è´¥: ${url}`);
              resolve(false);
            };
            testImg.src = url;
          });
        }
        
        // å¤„ç†å›¾ç‰‡åŠ è½½å¤±è´¥çš„å‡½æ•°
        function handleImageLoadFailure() {
          console.log(`èµ„æº ${resource.name} çš„åŸå§‹å›¾ç‰‡ ${imgUrl} åŠ è½½å¤±è´¥ï¼Œå°è¯•å…¶ä»–è·¯å¾„...`);
          
          // æ˜¾ç¤ºå¤‡ç”¨å†…å®¹
          if (fallback) {
            fallback.style.display = 'flex';
          }
          
          // åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„è·¯å¾„å˜ä½“
          const allPossibleUrls = [];
          
          // 1. è·å–åŸºç¡€ä¿¡æ¯
          const hasSlash = imgUrl.includes('/');
          let directory = '';
          let filename = imgUrl;
          let baseName = imgUrl;
          let extension = '';
          
          // æå–ç›®å½•å’Œæ–‡ä»¶å
          if (hasSlash) {
            const lastSlashIndex = imgUrl.lastIndexOf('/');
            directory = imgUrl.substring(0, lastSlashIndex);
            filename = imgUrl.substring(lastSlashIndex + 1);
          }
          
          // æå–åŸºç¡€åç§°å’Œæ‰©å±•å
          const lastDotIndex = filename.lastIndexOf('.');
          if (lastDotIndex > 0) {
            baseName = filename.substring(0, lastDotIndex);
            extension = filename.substring(lastDotIndex);
          }
          
          // 2. å°è¯•ä¸åŒçš„æ–‡ä»¶æ‰©å±•å
          const possibleExtensions = ['.jpg', '.png', '.jpeg', '.gif'];
          possibleExtensions.forEach(ext => {
            if (directory) {
              allPossibleUrls.push(`${directory}/${baseName}${ext}`);
            } else {
              allPossibleUrls.push(`${baseName}${ext}`);
            }
          });
          
          // 3. å¤§å°å†™å˜ä½“ - æ›´å…¨é¢çš„å®ç°
          const lowercaseFilename = filename.toLowerCase();
          const uppercaseFilename = filename.toUpperCase();
          const lowercaseDirectory = directory.toLowerCase();
          const uppercaseDirectory = directory.toUpperCase();
          
          // æ·»åŠ æ‰€æœ‰å¯èƒ½çš„å¤§å°å†™ç»„åˆ
          if (directory) {
            allPossibleUrls.push(
              `${directory}/${lowercaseFilename}`,
              `${directory}/${uppercaseFilename}`,
              `${lowercaseDirectory}/${filename}`,
              `${uppercaseDirectory}/${filename}`,
              `${lowercaseDirectory}/${lowercaseFilename}`,
              `${uppercaseDirectory}/${uppercaseFilename}`
            );
          } else {
            allPossibleUrls.push(
              lowercaseFilename,
              uppercaseFilename
            );
          }
          
          // 4. ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶å
          if (directory) {
            allPossibleUrls.push(`${directory}/${baseName}`);
          } else {
            allPossibleUrls.push(baseName);
          }
          
          // 5. ç‰¹æ®Šå¤„ç†ï¼šæ£€æŸ¥èµ„æºåç§°ä¸æ–‡ä»¶åçš„ç›´æ¥å¯¹åº”
          // ç‰¹åˆ«æ˜¯é’ˆå¯¹"é»‘è‰²æ–—ç¯·"è¿™æ ·åç§°ä¸å›¾ç‰‡æ–‡ä»¶åä¸å®Œå…¨åŒ¹é…çš„æƒ…å†µ
          const resourceName = resource.name;
          allPossibleUrls.push(
            `UI/${resourceName}.jpg`,
            `UI/${resourceName}.png`,
            `UI/${resourceName}`
          );
          
          // 6. æ£€æŸ¥"UIé«˜æ¸…ç‰ˆæœ¬"æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡
          if (baseName && directory === 'UI') {
            possibleExtensions.forEach(ext => {
              allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${baseName}${ext}`);
              allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${resourceName}${ext}`);
            });
            allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${baseName}`);
            allPossibleUrls.push(`UIé«˜æ¸…ç‰ˆæœ¬/${resourceName}`);
          }
          
          // 7. å°è¯•åŸºç¡€æ–‡ä»¶åä¸èµ„æºåçš„å„ç§ç»„åˆ
          // ç‰¹åˆ«æ˜¯å¤„ç†"é»‘è‰²æ–—ç¯·"å¯¹åº”"é»‘è¡£æ–—ç¯·.jpg"çš„æƒ…å†µ
          const variations = [
            resourceName.replace(/é»‘è‰²/, 'é»‘è¡£'),  // é»‘è‰²æ–—ç¯· -> é»‘è¡£æ–—ç¯·
            resourceName.replace(/é»‘è¡£/, 'é»‘è‰²'),  // åå‘è½¬æ¢
            resourceName.replace(/ç ´/, ''),        // ç§»é™¤"ç ´"å­—
            resourceName.replace(/ /g, '')         // ç§»é™¤ç©ºæ ¼
          ];
          
          variations.forEach(variation => {
            possibleExtensions.forEach(ext => {
              if (variation && variation !== resourceName) {
                allPossibleUrls.push(`UI/${variation}${ext}`);
              }
            });
          });
          
          // å»é‡
          const uniqueUrls = [...new Set(allPossibleUrls)];
          
          // å°è¯•æ‰€æœ‰å¯èƒ½çš„URLï¼ˆåŒæ­¥æ–¹å¼ï¼‰
          function tryNextUrl(index) {
            if (index >= uniqueUrls.length) {
              console.log(`å°è¯•äº†æ‰€æœ‰å¯èƒ½çš„URLï¼Œä»æ— æ³•åŠ è½½èµ„æº ${resource.name} çš„å›¾ç‰‡`);
              return;
            }
            
            const url = uniqueUrls[index];
            tryLoadImageSync(url).then(success => {
              if (success) {
                console.log(`æˆåŠŸé€šè¿‡å¤‡ç”¨è·¯å¾„åŠ è½½å›¾ç‰‡: ${url}`);
              } else {
                tryNextUrl(index + 1); // å°è¯•ä¸‹ä¸€ä¸ªURL
              }
            });
          }
          
          // å¼€å§‹å°è¯•å¤‡ç”¨URLs
          tryNextUrl(0);
        }
        
        // è®¾ç½®å›¾ç‰‡åŠ è½½äº‹ä»¶
        img.onload = function() {
          console.log(`èµ„æº ${resource.name} çš„å›¾ç‰‡åŠ è½½æˆåŠŸ`);
          if (fallback) fallback.style.display = 'none';
        };
        
        // è®¾ç½®å›¾ç‰‡åŠ è½½å¤±è´¥äº‹ä»¶
        img.onerror = function() {
          handleImageLoadFailure();
        };
        
        // è§¦å‘å›¾ç‰‡åŠ è½½
        img.src = imgUrl;
      }
    }
    
    // æ·»åŠ åˆ†ç±»åˆ‡æ¢äº‹ä»¶
    function setupCategoryTabs() {
        document.querySelectorAll('.inventory-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentCategory = tab.dataset.category;
                currentPage = 1; // åˆ‡æ¢åˆ†ç±»æ—¶é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                renderResources();
            });
        });
    }
    
    // æ·»åŠ åˆ†é¡µæŒ‰é’®äº‹ä»¶
    function setupPaginationButtons() {
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');
        
        if (prevButton) {
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderResources();
                }
            });
        }
        
        if (nextButton) {
            nextButton.addEventListener('click', () => {
                // è®¡ç®—æœ€å¤§é¡µæ•°
                ensureResourceCategories();
                let filteredResources = [];
                for (const [id, resource] of Object.entries(gameData.resources)) {
                    // ä¸renderResourceså‡½æ•°ä¿æŒä¸€è‡´çš„ç­›é€‰é€»è¾‘ï¼Œåªæ˜¾ç¤ºæ•°é‡å¤§äº0çš„èµ„æº
                    if ((currentCategory === 'all' || resource.category === currentCategory) && resource.amount > 0) {
                        filteredResources.push(resource);
                    }
                }
                const totalPages = Math.ceil(filteredResources.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    renderResources();
                }
            });
        }
    }

    // æ¸²æŸ“åœ°ç‚¹
    function renderLocations() {
      elements.locationGrid.innerHTML = '';
      
      for (const location of gameData.locations) {
        if (location.available) {
          const locationCard = document.createElement('div');
          locationCard.className = `card location location-card ${location.currentLocation ? 'current' : ''}`;
          locationCard.setAttribute('data-location', location.id);
          
          // å¯¹äºå¯ºåº™ï¼Œä¸æ˜¾ç¤ºæ˜æ˜¾æ ‡è¯†
          const showLocationIcon = location.id !== 'temple';
          
          locationCard.innerHTML = `
            <div class="card-content">
              <div class="card-title">${location.name}</div>
              <div class="card-description">${location.description}</div>
              <div class="location-details">
                <!-- å·²ç§»é™¤å±é™©ç­‰çº§æ˜¾ç¤º -->
              </div>
            </div>
          `;
          
          elements.locationGrid.appendChild(locationCard);
        }
      }
    }

    // æ¸²æŸ“è¡ŒåŠ¨
    function renderActions() {
      elements.actionGrid.innerHTML = '';
      
      // è·å–å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      
      if (!currentLocation) {
        return;
      }
      
      // æ ¹æ®æ—¶é—´å’Œåœ°ç‚¹é€‰æ‹©è¡ŒåŠ¨åˆ—è¡¨
      let actionsToRender = [...currentLocation.actions];
      
      // å¦‚æœæ˜¯å¤œæ™šä¸”åœ¨è¡—è§’ï¼Œä½¿ç”¨å¤œæ™šè¡ŒåŠ¨åˆ—è¡¨
      if (gameData.timeOfDay === 'night' && currentLocation.id === 'street' && currentLocation.nightActions) {
        actionsToRender = [...currentLocation.nightActions];
        
        // å¦‚æœé»‘å¸‚å·²è§£é”ï¼Œç§»é™¤ä¸ç¥ç§˜äººå¯¹è¯è¡ŒåŠ¨
        const blackMarketLocation = gameData.locations.find(loc => loc.id === 'black_market');
        if (blackMarketLocation && blackMarketLocation.available) {
          actionsToRender = actionsToRender.filter(actionId => actionId !== 'talk_mystery');
        }
      }
      
      // å¦‚æœæ˜¯å¯ºåº™ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©å¼€å§‹ï¼Œæ¯4å¤©ä¸€æ¬¡ï¼‰
      if (currentLocation.id === 'temple') {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©ã€ç¬¬6å¤©ã€ç¬¬10å¤©...ï¼‰
        if (gameData.day % 4 !== 2) {
          // ä¸æ˜¯æ”¾æ–‹æ—¥ï¼Œç§»é™¤æ”¾æ–‹æ—¥è¡ŒåŠ¨
          actionsToRender = actionsToRender.filter(actionId => actionId !== 'fasting_day');
        }
      }
      
      // æ ¹æ®å½“å‰åœ°ç‚¹çš„è¡ŒåŠ¨åˆ—è¡¨æ¸²æŸ“è¡ŒåŠ¨å¡ç‰Œ
      for (const actionId of actionsToRender) {
        const action = gameData.actions.find(act => act.id === actionId);
        
        if (!action) continue;
        
        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³è¡ŒåŠ¨æ‰€éœ€çš„èµ„æº
        let canPerform = true;
        if (action.requires) {
          for (const [resource, amount] of Object.entries(action.requires)) {
            if (!gameData.resources[resource] || gameData.resources[resource].amount < amount) {
              canPerform = false;
              break;
            }
          }
        }
        
        const actionCard = document.createElement('div');
        actionCard.className = `card action action-card ${canPerform ? '' : 'opacity-50'}`;
        actionCard.setAttribute('data-action', action.id);
        actionCard.setAttribute('data-can-perform', canPerform);
        
        actionCard.innerHTML = `
          <div class="card-content">
            <div class="card-title">${action.name}</div>
            <div class="card-description">${action.description}</div>
          </div>
        `;
        
        elements.actionGrid.appendChild(actionCard);
      }
    }

    // æ¸²æŸ“é…æ–¹
    function renderRecipes() {
      elements.recipeGrid.innerHTML = '';
      
      for (const recipe of gameData.recipes) {
        const isDiscovered = gameData.discoveredRecipes.includes(recipe.id);
        
        const recipeCard = document.createElement('div');
        recipeCard.className = 'recipe-card';
        
        if (!isDiscovered) {
          // æœªè§£é”çš„é…æ–¹æ˜¾ç¤ºä¸ºé—®å·
          recipeCard.innerHTML = `
            <h3 class="recipe-card-title">???</h3>
            <div class="recipe-card-ingredients">
              <span class="recipe-card-ingredient">???</span>
              <span class="recipe-card-ingredient">???</span>
            </div>
            <p class="recipe-card-description">æœªè§£é”çš„é…æ–¹</p>
            <p class="recipe-card-undiscovered">æœªå‘ç°</p>
          `;
        } else {
          // å·²è§£é”çš„é…æ–¹æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          let ingredientsHtml = '';
          for (const [resource, amount] of Object.entries(recipe.ingredients)) {
            const resourceName = gameData.resources[resource] ? gameData.resources[resource].name : resource;
            ingredientsHtml += `<span class="recipe-card-ingredient">${resourceName} x${amount}</span>`;
          }
          
          recipeCard.innerHTML = `
            <h3 class="recipe-card-title">${recipe.name}</h3>
            <div class="recipe-card-ingredients">
              ${ingredientsHtml}
            </div>
            <p class="recipe-card-description">${recipe.description}</p>
            <p class="recipe-card-discovered">å·²å‘ç°</p>
          `;
        }
        
        elements.recipeGrid.appendChild(recipeCard);
      }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // å¸ä¸‹è£…å¤‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('unequip-button')) {
          const slot = e.target.getAttribute('data-slot');
          const resourceId = e.target.getAttribute('data-resource');
          unequipItem(slot, resourceId);
        }
      });
      
      // è£…å¤‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const equipmentButton = document.getElementById('equipmentButton');
      if (equipmentButton) {
        equipmentButton.addEventListener('click', function() {
          openEquipmentWindow();
        });
      }
      
      // æŠ€èƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const skillsButton = document.getElementById('skillsButton');
      if (skillsButton) {
        skillsButton.addEventListener('click', function() {
          openSkillsWindow();
        });
      }
      
      // å¼€å§‹æ¸¸æˆæŒ‰é’®
      elements.startGameButton.addEventListener('click', () => {
        debugLog('å¼€å§‹æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»');
        try {
          debugLog('è®¾ç½®å¼€å§‹å±å¹•æ·¡å‡ºåŠ¨ç”»');
          elements.startScreen.style.opacity = '0';
          
          setTimeout(() => {
            try {
              debugLog('éšè—å¼€å§‹å±å¹•');
              elements.startScreen.style.display = 'none';
              
              debugLog('æ˜¾ç¤ºæ¸¸æˆå®¹å™¨');
              elements.gameContainer.style.display = 'block';
              
              debugLog('è°ƒç”¨initGame()åˆå§‹åŒ–æ¸¸æˆ');
              initGame();
              debugLog('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
              console.error('å¼€å§‹æ¸¸æˆåŠ¨ç”»åé”™è¯¯:', error);
              let errorDiv = document.getElementById('error-display');
              if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'error-display';
                errorDiv.style.cssText = 'position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 10px; z-index: 9999; font-size: 14px;';
                document.body.appendChild(errorDiv);
              }
              errorDiv.innerHTML += `<p>å¼€å§‹æ¸¸æˆé”™è¯¯: ${error.message}</p>`;
            }
          }, 500);
        } catch (error) {
          console.error('å¼€å§‹æ¸¸æˆæŒ‰é’®ç‚¹å‡»é”™è¯¯:', error);
          let errorDiv = document.getElementById('error-display');
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'error-display';
            errorDiv.style.cssText = 'position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 10px; z-index: 9999; font-size: 14px;';
            document.body.appendChild(errorDiv);
          }
          errorDiv.innerHTML += `<p>å¼€å§‹æ¸¸æˆæŒ‰é’®é”™è¯¯: ${error.message}</p>`;
        }
      });
      
      // æ•™ç¨‹æ¨¡æ€æ¡†
      if (elements.closeTutorialButton) {
        elements.closeTutorialButton.addEventListener('click', () => {
          elements.tutorialModal.classList.remove('active');
        });
      }
      
      // å¸®åŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - è¿™é‡Œæ³¨é‡Šæ‰ï¼Œå› ä¸ºå·²ç»åœ¨setupHelpButton()å‡½æ•°ä¸­è®¾ç½®äº†
      // if (elements.helpButton) {
      //   elements.helpButton.addEventListener('click', () => {
      //     elements.tutorialModal.classList.add('active');
      //   });
      // }
      
      // æ•™ç¨‹å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if (elements.closeTutorialButton) {
        elements.closeTutorialButton.addEventListener('click', () => {
          elements.tutorialModal.classList.remove('active');
        });
      }
      
      // åœ°ç‚¹å¡ç‰Œç‚¹å‡»
      elements.locationGrid.addEventListener('click', (e) => {
        const locationCard = e.target.closest('.location-card');
        if (locationCard) {
          const locationId = locationCard.getAttribute('data-location');
          visitLocation(locationId);
        }
      });
      
      // è¡ŒåŠ¨å¡ç‰Œç‚¹å‡»
      elements.actionGrid.addEventListener('click', (e) => {
        const actionCard = e.target.closest('.action-card');
        if (actionCard) {
          const actionId = actionCard.getAttribute('data-action');
          const canPerform = actionCard.getAttribute('data-can-perform') === 'true';
          
          if (canPerform) {
            performAction(actionId);
          } else {
            showNotification('æ¡ä»¶ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºæ¥æ‰§è¡Œæ­¤è¡ŒåŠ¨ã€‚');
          }
        }
      });
      
      // é…æ–¹æŒ‰é’®ç‚¹å‡»
      const recipeButton = document.getElementById('recipeButton');
      if (recipeButton) {
        recipeButton.addEventListener('click', () => {
          renderRecipes();
          elements.recipeModal.classList.add('active');
        });
      }
      
      // èµ„æºå¡ç‰Œæ‹–æ‹½
      if (elements.resourceGrid) {
        elements.resourceGrid.addEventListener('dragstart', (e) => {
          if (e.target.classList.contains('resource-card')) {
            const resourceId = e.target.getAttribute('data-resource');
            e.dataTransfer.setData('text/plain', resourceId);
            e.target.classList.add('dragging');
          }
        });
      }
      
      if (elements.resourceGrid) {
        elements.resourceGrid.addEventListener('dragend', (e) => {
          if (e.target.classList.contains('resource-card')) {
            e.target.classList.remove('dragging');
          }
        });
      }
      
      // ç»„åˆæ§½æ‹–æ”¾ - åªé€‰æ‹©å¡ç‰Œç»„åˆåŒºåŸŸçš„æ§½ä½
      const combinationSlots = document.querySelectorAll('#combinationSlots .combination-slot');
      combinationSlots.forEach(slot => {
        slot.addEventListener('dragover', (e) => {
          e.preventDefault();
          slot.classList.add('active');
        });
        
        slot.addEventListener('dragleave', () => {
          slot.classList.remove('active');
        });
        
        slot.addEventListener('drop', (e) => {
          e.preventDefault();
          slot.classList.remove('active');
          
          const resourceId = e.dataTransfer.getData('text/plain');
          if (resourceId && gameData.resources[resourceId].amount > 0) {
            const slotNumber = slot.getAttribute('data-slot');
            
            // å¦‚æœæ§½ä½å·²æœ‰èµ„æºï¼Œå°†å…¶è¿”å›èƒŒåŒ…
            if (gameData.combinationSlots[slotNumber]) {
              const prevResourceId = gameData.combinationSlots[slotNumber];
              // ä¸éœ€è¦å¢å‡æ•°é‡ï¼Œå› ä¸ºåªæ˜¯ç§»åŠ¨ä½ç½®
            }
            
            // æ”¾ç½®æ–°èµ„æº
            gameData.combinationSlots[slotNumber] = resourceId;
            
            // æ›´æ–°UI
            updateCombinationSlots();
            renderResources();
            checkCombination();
          }
        });
        
        slot.addEventListener('click', () => {
          const slotNumber = slot.getAttribute('data-slot');
          if (gameData.combinationSlots[slotNumber]) {
            const resourceId = gameData.combinationSlots[slotNumber];
            // ä¸éœ€è¦å¢å‡æ•°é‡ï¼Œå› ä¸ºåªæ˜¯ç§»åŠ¨ä½ç½®
            gameData.combinationSlots[slotNumber] = null;
            
            updateCombinationSlots();
            renderResources();
            checkCombination();
          }
        });
      });
      
      // ç»„åˆæŒ‰é’®
      if (elements.craftButton) {
        elements.craftButton.addEventListener('click', () => {
          combineCards();
        });
      }
      
      // äº‹ä»¶æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
      elements.closeEventButton.addEventListener('click', () => {
        elements.eventModal.classList.remove('active');
        endTurn();
      });
      
      // é…æ–¹æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
      elements.closeRecipeButton.addEventListener('click', () => {
        elements.recipeModal.classList.remove('active');
      });
      
      // é…æ–¹æ¨¡æ€æ¡†ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­
      elements.recipeModal.addEventListener('click', (e) => {
        if (e.target === elements.recipeModal) {
          elements.recipeModal.classList.remove('active');
        }
      });
      
      // æ¸¸æˆç»“æŸæ¨¡æ€æ¡†æŒ‰é’®
      elements.restartGameButton.addEventListener('click', () => {
        resetGame();
        elements.gameOverModal.classList.remove('active');
        elements.gameContainer.style.display = 'block';
      });
      
      elements.exitGameButton.addEventListener('click', () => {
        elements.gameOverModal.classList.remove('active');
        elements.gameContainer.style.display = 'none';
        elements.startScreen.style.display = 'flex';
        elements.startScreen.style.opacity = '1';
      });
      
      // é€šçŸ¥å…³é—­æŒ‰é’®
      elements.closeNotificationButton.addEventListener('click', () => {
        elements.notification.classList.remove('active');
      });
      
      // æˆå°±é€šçŸ¥å…³é—­æŒ‰é’®
      elements.closeAchievementButton.addEventListener('click', () => {
        elements.achievementModal.classList.remove('active');
      });
    }

    // ç»„åˆå¡ç‰Œ
    function combineCards() {
      const slots = Object.values(gameData.combinationSlots).filter(Boolean);
      
      if (slots.length < 2) {
        showNotification('ç»„åˆå¤±è´¥', 'éœ€è¦è‡³å°‘ä¸¤å¼ å¡ç‰Œæ‰èƒ½ç»„åˆã€‚');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•é…æ–¹
      let matchedRecipe = null;
      
      for (const recipe of gameData.recipes) {
        const ingredients = Object.keys(recipe.ingredients);
        
        // æ£€æŸ¥é…æ–¹æ‰€éœ€çš„æ‰€æœ‰èµ„æºæ˜¯å¦éƒ½åœ¨ç»„åˆæ§½ä¸­
        let hasAllIngredients = true;
        const slotCounts = {};
        
        // è®¡ç®—ç»„åˆæ§½ä¸­æ¯ç§èµ„æºçš„æ•°é‡
        slots.forEach(resourceId => {
          slotCounts[resourceId] = (slotCounts[resourceId] || 0) + 1;
        });
        
        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³é…æ–¹è¦æ±‚
        for (const [resource, requiredAmount] of Object.entries(recipe.ingredients)) {
          if (!slotCounts[resource] || slotCounts[resource] < requiredAmount) {
            hasAllIngredients = false;
            break;
          }
        }
        
        if (hasAllIngredients) {
          matchedRecipe = recipe;
          break;
        }
      }
      
      if (matchedRecipe) {
        // å‡†å¤‡ç»“æœå¯¹è±¡
        const results = {
          resources: {},
          status: {},
          effects: []
        };
        
        // æ¶ˆè€—èƒŒåŒ…ä¸­çš„èµ„æº
        for (const [resource, requiredAmount] of Object.entries(matchedRecipe.ingredients)) {
          if (resource in gameData.resources) {
            const originalAmount = gameData.resources[resource].amount;
            gameData.resources[resource].amount = Math.max(0, originalAmount - requiredAmount);
            
            // æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦æ­£åœ¨è£…å¤‡ä¸­
            if (gameData.resources[resource].equipped) {
              // å¦‚æœç‰©å“æ•°é‡å˜ä¸º0ï¼Œè‡ªåŠ¨å¸ä¸‹è£…å¤‡
              if (gameData.resources[resource].amount === 0) {
                // ç§»é™¤è£…å¤‡æ•ˆæœ
                applyEquipmentEffect(resource, 'unequip');
                // ç§»é™¤è£…å¤‡çŠ¶æ€
                gameData.resources[resource].equipped = false;
                results.effects.push(`ä½ çš„${gameData.resources[resource].name}è¢«æ¶ˆè€—äº†ï¼Œå·²è‡ªåŠ¨å¸ä¸‹ã€‚`);
              }
            }
          }
        }
        
        // åº”ç”¨é…æ–¹ç»“æœ
        let resourceChanged = false;
        for (const [resource, amount] of Object.entries(matchedRecipe.result)) {
          if (resource in gameData.resources) {
            // è®°å½•èµ„æºæ˜¯å¦æœ‰å˜åŒ–
            if (gameData.resources[resource].amount !== gameData.resources[resource].amount + amount) {
              resourceChanged = true;
            }
            gameData.resources[resource].amount += amount;
          } else if (resource in gameData.status) {
            const newStatus = Math.min(100, Math.max(0, gameData.status[resource] + amount));
            if (gameData.status[resource] !== newStatus) {
              resourceChanged = true;
            }
            gameData.status[resource] = newStatus;
          } else if (resource === 'begging_chance') {
            // å¤„ç†ä¹è®¨æˆåŠŸç‡åŠ æˆ
            gameData.begging_chance = (gameData.begging_chance || 0) + amount;
            resourceChanged = true;
            showNotification('åˆ¶ä½œæˆåŠŸ', `ä½ çš„ä¹è®¨æˆåŠŸç‡æé«˜äº†${amount}%ï¼`);
          } else {
            // å¦‚æœæ˜¯æ–°çš„èµ„æºï¼Œåˆ›å»ºå®ƒ
            gameData.resources[resource] = {
              name: resource.charAt(0).toUpperCase() + resource.slice(1).replace('_', ' '),
              amount: amount,
              image: '' // é»˜è®¤ä¸ºç©ºå›¾ç‰‡ï¼Œå®é™…æ¸¸æˆä¸­åº”è¯¥è®¾ç½®æ­£ç¡®çš„å›¾ç‰‡
            };
            
            // å¦‚æœæ˜¯å¯åˆ¶ä½œçš„ç‰©å“ï¼Œè®¾ç½®åˆå§‹è€ä¹…åº¦
            if (['simple_clothes', 'fire', 'clay_bowl', 'crutch', 'black_cloak'].includes(resource)) {
              gameData.resources[resource].durability = 100;
            }
            resourceChanged = true;
          }
        }
        
        // æ ‡è®°é…æ–¹ä¸ºå·²å‘ç°
        if (!gameData.discoveredRecipes.includes(matchedRecipe.id)) {
          gameData.discoveredRecipes.push(matchedRecipe.id);
          gameData.stats.recipesDiscovered++;
          showAchievement('æ–°é…æ–¹å‘ç°', `ä½ å‘ç°äº†å¦‚ä½•åˆ¶ä½œ${matchedRecipe.name}ï¼`);
        }
        
        // å¦‚æœåˆ¶ä½œçš„æ˜¯æ³¥ç¢—ï¼Œç¡®ä¿èƒŒåŒ…ä¸­æ²¡æœ‰ç ´ç¢—
        if (matchedRecipe.id === 'clay_bowl') {
          gameData.resources.bowl.amount = 0;
        }
        
        // æ¸…ç©ºç»„åˆæ§½
        for (const slot in gameData.combinationSlots) {
          gameData.combinationSlots[slot] = null;
        }
        
        // æ›´æ–°UI
        updateCombinationSlots();
        updateGameData();
        checkCombination();
        
        // å¦‚æœèµ„æºæœ‰å˜åŒ–ï¼Œæ›´æ–°ç›¸å…³èµ„æºå¡ç‰Œ
        if (resourceChanged) {
          // æ›´æ–°æ¶ˆè€—çš„èµ„æº
          for (const [resource, requiredAmount] of Object.entries(matchedRecipe.ingredients)) {
            updateResourceCard(resource);
          }
          
          // æ›´æ–°ç”Ÿæˆçš„èµ„æº
          for (const [resource, amount] of Object.entries(matchedRecipe.result)) {
            if (resource in gameData.resources) {
              updateResourceCard(resource);
            }
          }
          
          // åªæœ‰å½“æœ‰è£…å¤‡ç‰©å“è¢«æ¶ˆè€—æ—¶æ‰æ›´æ–°è£…å¤‡æ 
          if (results.effects.length > 0) {
            renderEquipmentSlots(); // æ›´æ–°è£…å¤‡æ 
          }
        }
        
        // å¦‚æœæœ‰è£…å¤‡ç‰©å“è¢«æ¶ˆè€—ï¼Œæ˜¾ç¤ºé€šçŸ¥
        if (results.effects.length > 0) {
          showEventResult('ç»„åˆç»“æœ', results);
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        elements.combinationResult.innerHTML = `
          <div class="text-green-600">
            <i class="fa fa-check-circle" aria-hidden="true"></i>
            æˆåŠŸåˆ¶ä½œäº† ${matchedRecipe.name}ï¼
          </div>
        `;
        
        showNotification('åˆ¶ä½œæˆåŠŸ', `ä½ æˆåŠŸåˆ¶ä½œäº†${matchedRecipe.name}ï¼`);
      } else {
        // æ˜¾ç¤ºå¤±è´¥æ¶ˆæ¯
        elements.combinationResult.innerHTML = `
          <div class="text-red-600">
            <i class="fa fa-times-circle" aria-hidden="true"></i>
            è¿™äº›å¡ç‰Œæ— æ³•ç»„åˆã€‚
          </div>
        `;
        
        showNotification('ç»„åˆå¤±è´¥', 'è¿™äº›å¡ç‰Œæ— æ³•ç»„åˆï¼Œè¯·å°è¯•å…¶ä»–ç»„åˆã€‚');
      }
    }

    // æ›´æ–°ç»„åˆæ§½ - åªæ›´æ–°å¡ç‰Œç»„åˆåŒºåŸŸçš„æ§½ä½


    // æ£€æŸ¥åœ°ç‚¹è¿›å…¥æ¡ä»¶
    function checkEntryConditions(location) {
      // ç‰¹æ®Šæ£€æŸ¥ï¼šé»‘å¸‚éœ€è¦é»‘è‰²æ–—ç¯·
      if (location.id === 'black_market') {
        // æ£€æŸ¥æ˜¯å¦ç©¿æˆ´äº†é»‘è‰²æ–—ç¯·
        let hasBlackCloakEquipped = false;
        
        // æ–¹æ³•1ï¼šé€šè¿‡DOMæ£€æŸ¥ç‰¹æ®Šæ§½ä½æ˜¯å¦æœ‰é»‘è‰²æ–—ç¯·
        const specialSlot = document.querySelector('.equipment-slots .combination-slot[data-slot="special"]');
        if (specialSlot) {
          const equipmentItem = specialSlot.querySelector('.equipment-item');
          if (equipmentItem && (equipmentItem.getAttribute('data-resource') === 'black_cloak' || 
              equipmentItem.innerHTML.includes('é»‘è‰²æ–—ç¯·'))) {
            hasBlackCloakEquipped = true;
          }
        }
        
        // æ–¹æ³•2ï¼šé€šè¿‡æ¸¸æˆæ•°æ®æ£€æŸ¥é»‘è‰²æ–—ç¯·æ˜¯å¦å·²è£…å¤‡
        if (gameData.resources.black_cloak && gameData.resources.black_cloak.equipped) {
          hasBlackCloakEquipped = true;
        }
        
        if (!hasBlackCloakEquipped) {
          // æ˜¾ç¤ºæç¤ºï¼šä¸ç¬¦åˆè¿›å…¥æ¡ä»¶
          showEventResult('ä¸ç¬¦åˆè¿›å…¥æ¡ä»¶', {
            effects: ['è¿›å…¥é»‘å¸‚éœ€è¦ç©¿æˆ´é»‘è‰²æ–—ç¯·ï¼Œä½ ç›®å‰æ²¡æœ‰ç©¿æˆ´ã€‚']
          });
          return false;
        }
      }
      
      if (!location.entryCondition) return true;
      
      for (const [status, condition] of Object.entries(location.entryCondition)) {
        if (condition.min !== undefined && gameData.status[status] < condition.min) {
          showNotification('æ¡ä»¶ä¸è¶³', `è¿›å…¥${location.name}éœ€è¦${status}è‡³å°‘${condition.min}%ï¼Œä½ ç›®å‰åªæœ‰${gameData.status[status]}%ã€‚`);
          return false;
        }
        if (condition.max !== undefined && gameData.status[status] > condition.max) {
          showNotification('æ¡ä»¶ä¸ç¬¦', `è¿›å…¥${location.name}éœ€è¦${status}ä¸è¶…è¿‡${condition.max}%ï¼Œä½ ç›®å‰æœ‰${gameData.status[status]}%ã€‚`);
          return false;
        }
      }
      
      return true;
    }
    
    // é€€å‡ºåœ°ç‚¹
    function exitLocation() {
      // è·å–å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      
      if (!currentLocation) return;
      
      // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¢æˆ¿ä¸­ä¸”è¿˜æœ‰åˆ‘æœŸ
      if (currentLocation.id === 'prison') {
        const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
        if (prisonLocation && prisonLocation.sentenceDays > 0) {
          showNotification('æ— æ³•ç¦»å¼€', 'ä½ è¿˜åœ¨æœåˆ‘æœŸé—´ï¼Œæ— æ³•ç¦»å¼€ç‰¢æˆ¿ï¼');
          return;
        }
      }
      
      // æ£€æŸ¥è¡ŒåŠ¨ç‚¹æ˜¯å¦è¶³å¤Ÿ
      if (gameData.status.actionPoints < currentLocation.actionPointCost) {
        showNotification('è¡ŒåŠ¨ç‚¹ä¸è¶³', `é€€å‡º${currentLocation.name}éœ€è¦${currentLocation.actionPointCost}ç‚¹è¡ŒåŠ¨ç‚¹ï¼Œä½ ç›®å‰åªæœ‰${gameData.status.actionPoints}ç‚¹ã€‚`);
        return;
      }
      
      // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
      gameData.status.actionPoints -= currentLocation.actionPointCost;
      
      // æ—¶é—´æµé€ - æ¶ˆè€—1ä¸ªå›åˆ
      gameData.timeTurns++;
      
      // æ˜¾ç¤ºé€€å‡ºé€šçŸ¥
      showNotification('ç¦»å¼€åœ°ç‚¹', `ä½ ç¦»å¼€äº†${currentLocation.name}ã€‚`);
      
      // æ›´æ–°UI
      renderLocations();
      updateGameData();
      
      // æ¨è¿›æ—¶é—´
      advanceTime();
    }
    
    // è®¿é—®åœ°ç‚¹
    function visitLocation(locationId) {
      // æ ¹æ®åœ°ç‚¹IDè·å–åœ°ç‚¹æ•°æ®
      const location = gameData.locations.find(loc => loc.id === locationId);
      
      if (!location) return;
      
      // æ£€æŸ¥æ˜¯å¦å·²åœ¨å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      if (currentLocation && currentLocation.id === locationId) {
        showNotification('å·²åœ¨è¯¥åœ°ç‚¹', `ä½ å·²ç»åœ¨${location.name}äº†ã€‚`);
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¢æˆ¿ä¸­ä¸”è¿˜æœ‰åˆ‘æœŸï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å…è®¸åˆ‡æ¢åˆ°å…¶ä»–åœ°ç‚¹
      if (currentLocation && currentLocation.id === 'prison') {
        const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
        if (prisonLocation && prisonLocation.sentenceDays > 0 && locationId !== 'prison') {
          showNotification('æ— æ³•ç¦»å¼€', 'ä½ è¿˜åœ¨æœåˆ‘æœŸé—´ï¼Œæ— æ³•ç¦»å¼€ç‰¢æˆ¿ï¼');
          return;
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦æ»¡è¶³è¿›å…¥æ¡ä»¶
      if (!checkEntryConditions(location)) {
        return;
      }
      
      // è®¡ç®—æ€»è¡ŒåŠ¨ç‚¹æ¶ˆè€—ï¼ˆç¦»å¼€å½“å‰åœ°ç‚¹ + è¿›å…¥æ–°åœ°ç‚¹ï¼‰
      let totalActionCost = location.actionPointCost;
      if (currentLocation) {
        totalActionCost += currentLocation.actionPointCost;
      }
      
      // æ£€æŸ¥è¡ŒåŠ¨ç‚¹æ˜¯å¦è¶³å¤Ÿ
      if (gameData.status.actionPoints < totalActionCost) {
        showNotification('è¡ŒåŠ¨ç‚¹ä¸è¶³', `å‰å¾€${location.name}éœ€è¦${totalActionCost}ç‚¹è¡ŒåŠ¨ç‚¹ï¼Œä½ ç›®å‰åªæœ‰${gameData.status.actionPoints}ç‚¹ã€‚`);
        return;
      }
      
      // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
      gameData.status.actionPoints -= totalActionCost;
      
      // æ›´æ–°å½“å‰åœ°ç‚¹
      if (currentLocation) {
        currentLocation.currentLocation = false;
      }
      location.currentLocation = true;
      
      // æ—¶é—´æµé€ - æ¶ˆè€—1ä¸ªå›åˆ
      gameData.timeTurns++;
      
      // æ˜¾ç¤ºè¿›å…¥é€šçŸ¥
      showNotification('è¿›å…¥åœ°ç‚¹', `ä½ è¿›å…¥äº†${location.name}ã€‚`);
      
      // æ›´æ–°UI
      renderResources();
      renderLocations(); // ç¡®ä¿åœ°ç‚¹æ ‡è¯†æ­£ç¡®æ›´æ–°
      updateGameData();
      
      // æ¶ˆè€—æ—¶é—´
      advanceTime();
    }

    // æ‰§è¡Œè¡ŒåŠ¨
    function performAction(actionId) {
      
      // æ ¹æ®è¡ŒåŠ¨IDè·å–è¡ŒåŠ¨æ•°æ®
      const action = gameData.actions.find(act => act.id === actionId);
      
      if (!action) return;
      
      // æ¶ˆè€—æ‰€éœ€èµ„æº
      if (action.requires) {
        for (const [resource, amount] of Object.entries(action.requires)) {
          gameData.resources[resource].amount -= amount;
        }
      }
      
      // æ ¹æ®è¡ŒåŠ¨ç±»å‹ç”Ÿæˆä¸åŒçš„ç»“æœ
      switch (actionId) {
        case 'beg':
          // ä¹è®¨
          let baseChance = 0.3; // åŸºç¡€å¤±è´¥æ¦‚ç‡ä¸º30%ï¼ŒæˆåŠŸç‡70%
          let successMultiplier = 1;
          const begResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          // æ ¹æ®ç©å®¶æ‹¥æœ‰çš„ç¢—ç±»å‹è‡ªåŠ¨è°ƒæ•´ä¹è®¨æˆåŠŸç‡
          // ç¢—çš„ç­‰çº§ä»ä½åˆ°é«˜: ç ´ç¢—(bowl)ã€æ³¥ç¢—(clay_bowl)ã€é™¶ç¢—(pottery_bowl)ã€é“¶ç¢—(silver_bowl)ã€é‡‘ç¢—(gold_bowl)
          let bowlBonus = 0;
          let bowlName = '';
          
          if (gameData.resources.gold_bowl.amount > 0) {
            bowlBonus = 50; // é‡‘ç¢—æä¾›50%æˆåŠŸç‡åŠ æˆ
        bowlName = 'é‡‘ç¢—';
          } else if (gameData.resources.silver_bowl.amount > 0) {
            bowlBonus = 30; // é“¶ç¢—æä¾›30%æˆåŠŸç‡åŠ æˆ
        bowlName = 'é“¶ç¢—';
          } else if (gameData.resources.pottery_bowl.amount > 0) {
            bowlBonus = 20; // é™¶ç¢—æä¾›20%æˆåŠŸç‡åŠ æˆ
        bowlName = 'é™¶ç¢—';
          } else if (gameData.resources.clay_bowl.amount > 0) {
            bowlBonus = 10; // æ³¥ç¢—æä¾›10%æˆåŠŸç‡åŠ æˆ
        bowlName = 'æ³¥ç¢—';
          } else if (gameData.resources.bowl.amount > 0) {
            bowlBonus = 5; // ç ´ç¢—æä¾›5%æˆåŠŸç‡åŠ æˆ
        bowlName = 'ç ´ç¢—';
          }
          
          // åˆå¹¶åŸºç¡€åŠ æˆå’Œç¢—åŠ æˆ
          const totalBeggingChance = gameData.begging_chance + bowlBonus;
          
          if (totalBeggingChance > 0) {
            // æ¯10ç‚¹ä¹è®¨æˆåŠŸç‡é™ä½10%çš„å¤±è´¥æ¦‚ç‡
            baseChance = Math.max(0.1, 0.3 - (totalBeggingChance / 100));
            // åŒæ—¶å¢åŠ æˆåŠŸæ—¶çš„æ”¶ç›Š
            successMultiplier = 1 + (totalBeggingChance / 20);
            begResults.effects.push(`ä½¿ç”¨${bowlName}ï¼Œä¹è®¨æˆåŠŸç‡æå‡${totalBeggingChance}%`);
          }
          
          const begSuccess = Math.random() > baseChance;
          
          if (begSuccess) {
            if (action.success) {
              // æœ‰30%çš„æ¦‚ç‡è·å¾—çªçªå¤´è€Œä¸æ˜¯æ®‹ç¾¹å‰©é¥­
              const getCornbread = Math.random() < 0.3;
              
              if (getCornbread) {
                // è·å¾—çªçªå¤´
                const adjustedAmount = Math.max(1, Math.round(action.success.cornbread * successMultiplier));
                gameData.resources.cornbread.amount += adjustedAmount;
                begResults.resources.cornbread = adjustedAmount;
                
                // è·å¾—é’±å¸
                const moneyAmount = Math.max(1, Math.round(action.success.money * successMultiplier));
                gameData.resources.money.amount += moneyAmount;
                begResults.resources.money = moneyAmount;
                
                showNotification('ä¹è®¨æˆåŠŸ', `ä½ æˆåŠŸä¹è®¨åˆ°äº†ä¸€ä¸ªçªçªå¤´å’Œä¸€äº›é’±å¸ã€‚${gameData.begging_chance ? `(æˆåŠŸç‡æå‡${gameData.begging_chance}%)` : ''}`);
              } else {
                // è·å¾—æ®‹ç¾¹å‰©é¥­
                const adjustedAmount = Math.max(1, Math.round(action.success.food * successMultiplier));
                gameData.resources.food.amount += adjustedAmount;
                begResults.resources.food = adjustedAmount;
                
                // è·å¾—é’±å¸
                const moneyAmount = Math.max(1, Math.round(action.success.money * successMultiplier));
                gameData.resources.money.amount += moneyAmount;
                begResults.resources.money = moneyAmount;
                
                showNotification('ä¹è®¨æˆåŠŸ', `ä½ æˆåŠŸä¹è®¨åˆ°äº†ä¸€äº›é£Ÿç‰©å’Œé’±å¸ã€‚${gameData.begging_chance ? `(æˆåŠŸç‡æå‡${gameData.begging_chance}%)` : ''}`);
              }
            }
            showEventResult('ä¹è®¨ç»“æœ', begResults);
          } else {
            if (action.failure) {
              for (const [status, amount] of Object.entries(action.failure)) {
                gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                begResults.status[status] = amount;
              }
            }
            showNotification('ä¹è®¨å¤±è´¥', 'æ²¡æœ‰äººæ„¿æ„æ–½èˆä½ ï¼Œä½ çš„ç²¾ç¥çŠ¶æ€ä¸‹é™äº†ã€‚');
            showEventResult('ä¹è®¨ç»“æœ', begResults);
          }
          break;
          
        case 'search':
          // æœå¯»
          const searchSuccess = Math.random() > 0.4; // 60% æˆåŠŸç‡
          const searchResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          if (searchSuccess) {
            if (action.success) {
              let itemsFound = 0;
              const maxItems = 2;
              
              // åˆ›å»ºèµ„æºæ•°ç»„å¹¶éšæœºæ’åºï¼Œç¡®ä¿ç‰©å“è·å¾—çš„éšæœºæ€§
              const resourcesArray = Object.entries(action.success);
              for (let i = resourcesArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [resourcesArray[i], resourcesArray[j]] = [resourcesArray[j], resourcesArray[i]];
              }
              
              // éå†éšæœºæ’åºåçš„èµ„æºï¼Œæœ€å¤šè·å¾—maxItemsä¸ªç‰©å“
              for (const [resource, amount] of resourcesArray) {
                if (itemsFound < maxItems && Math.random() > 0.6) { // 40% å‡ ç‡è·å¾—æ¯ç§èµ„æº
                  gameData.resources[resource].amount += amount;
                  gameData.stats.resourcesCollected++;
                  searchResults.resources[resource] = amount;
                  itemsFound++;
                }
              }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è‰è¯è¯†åˆ«èƒ½åŠ›ï¼ˆå­¦ä¹ è¿‡æœ¬è‰çº²ç›®ï¼‰
            if (gameData.skills.herbal && gameData.skills.herbal.level > 0) {
              // æ¯æ¬¡æˆåŠŸæœå¯»æœ‰30%å‡ ç‡é¢å¤–è·å¾—è‰è¯
              if (Math.random() < 0.3) {
                const herbTypes = ['ginseng', 'licorice', 'chrysanthemum']; // è‰è¯ç±»å‹
                const randomHerb = herbTypes[Math.floor(Math.random() * herbTypes.length)];
                gameData.resources[randomHerb].amount += 1;
                gameData.stats.resourcesCollected++;
                searchResults.resources[randomHerb] = 1;
                searchResults.effects.push('è¯†åˆ«åˆ°è‰è¯');
              }
            }
            
            // æœå¯»æˆåŠŸï¼Œå¢åŠ æœå¯»æŠ€èƒ½ç»éªŒå€¼
            if (gameData.skills.search) {
              const experienceGain = 1;
              gameData.skills.search.experience = (gameData.skills.search.experience || 0) + experienceGain;
              searchResults.effects.push(`æœå¯»æŠ€èƒ½ç»éªŒ +${experienceGain}`);
              
              // æ£€æŸ¥æ˜¯å¦å‡çº§
              checkSkillLevelUp('search', searchResults);
            }
            
            showNotification('æœå¯»æˆåŠŸ', 'ä½ æ‰¾åˆ°äº†ä¸€äº›æœ‰ç”¨çš„ç‰©å“ã€‚' + (searchResults.effects.includes('è¯†åˆ«åˆ°è‰è¯') ? 'ä½ è¯†åˆ«å‡ºäº†ä¸€äº›è‰è¯ï¼' : ''));
            showEventResult('æœå¯»ç»“æœ', searchResults);
          } else {
            if (action.failure) {
              for (const [status, amount] of Object.entries(action.failure)) {
                gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                searchResults.status[status] = amount;
              }
            }
            showNotification('æœå¯»å¤±è´¥', 'ä½ åœ¨æœå¯»è¿‡ç¨‹ä¸­å—ä¼¤äº†ã€‚');
            showEventResult('æœå¯»ç»“æœ', searchResults);
          }
          break;
          
        case 'loot':
            // ç¿»åƒåœ¾
            // æ˜¾ç¤ºç¿»åƒåœ¾æ¸¸æˆçª—å£
            showGarbageGame();
            break;
          
        case 'rest':
          // ä¼‘æ¯ (å¿…å®šæˆåŠŸ)
          const restResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          if (action.success) {
            for (const [status, amount] of Object.entries(action.success)) {
              gameData.status[status] = Math.min(100, gameData.status[status] + amount);
              restResults.status[status] = amount;
            }
          }
          showNotification('ä¼‘æ¯æˆåŠŸ', 'ä½ å¾—åˆ°äº†å……åˆ†çš„ä¼‘æ¯ï¼Œç²¾ç¥å’Œå¥åº·éƒ½æœ‰æ‰€æ¢å¤ã€‚');
          showEventResult('ä¼‘æ¯ç»“æœ', restResults);
          break;
          
        case 'fasting_day':
          // æ”¾æ–‹æ—¥è¡ŒåŠ¨ - æ€»æ˜¯æˆåŠŸè·å¾—æ–‹é¥­
          const fastingResults = {
            resources: {
              cornbread: 1,
              porridge: 1
            },
            status: {},
            effects: []
          };
          
          // åº”ç”¨èµ„æºè·å¾—
          gameData.resources.cornbread.amount += 1;
          gameData.resources.porridge.amount += 1;
          
          // æ ‡è®°æ”¾æ–‹æ—¥å·²é¢†å–
          gameData.fastingDayClaimed = true;
          
          // ç§»é™¤æ”¾æ–‹æ—¥è¡ŒåŠ¨ï¼Œé˜²æ­¢å†æ¬¡ç‚¹å‡»
          const templeLocation = gameData.locations.find(loc => loc.id === 'temple');
          if (templeLocation) {
            templeLocation.actions = templeLocation.actions.filter(action => action !== 'fasting_day');
            if (typeof renderActions === 'function') renderActions(); // æ›´æ–°ç•Œé¢ä¸Šçš„è¡ŒåŠ¨åˆ—è¡¨
          }
          
          // æ˜¾ç¤ºè·å¾—ç‰©å“çš„ç»“æœ
          showEventResult('æ”¾æ–‹æ—¥', fastingResults);
          break;
          
        case 'steal':
          // å·çªƒ
          const stealResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          // è·å–å½“å‰ä½ç½®
          const currentLocation = gameData.locations.find(loc => loc.currentLocation);
          const isRichArea = currentLocation && currentLocation.id === 'rich_area';
          
          // è®¡ç®—å·çªƒæˆåŠŸç‡ï¼ˆåŸºç¡€40%ï¼‰
          const baseStealChance = 0.4;
          // æŠ€èƒ½åŠ æˆï¼šæ¯çº§+5%æˆåŠŸç‡
          const skillBonus = gameData.skills.steal.level * 0.05;
          // å·å¤©æ¢æ—¥å­¦ä¹ åé¢å¤–+30%æˆåŠŸç‡
          const dayStealingBonus = gameData.skills.steal.specialAbilities?.includes('dayStealing') ? 0.3 : 0;
          // "å°å¿ƒä¸€ç‚¹"buffæƒ©ç½šï¼š-20%æˆåŠŸç‡
          const carefulBuffPenalty = gameData.buffs?.careful?.active ? 0.2 : 0;
          // è®¡ç®—æœ€ç»ˆæˆåŠŸç‡ï¼Œç¡®ä¿ä¸ä½äº0.1
          let totalStealChance = Math.min(0.95, baseStealChance + skillBonus + dayStealingBonus - carefulBuffPenalty);
          totalStealChance = Math.max(0.1, totalStealChance);
          
          const stealSuccess = Math.random() < totalStealChance;
          
          if (isRichArea) {
            // å¯ŒäººåŒºå·çªƒé€»è¾‘ - åªæœ‰æˆåŠŸå’Œå¤±è´¥ä¸¤ç§ç»“æœ
            if (stealSuccess) {
              // å·çªƒæˆåŠŸï¼Œè·å¾—ç‰©å“ - ç¡®ä¿è‡³å°‘è·å¾—1ä»¶ç‰©å“
              
              // å¯ŒäººåŒºå¯èƒ½å‡ºç°çš„ç‰©å“åŠå…¶æƒé‡
              const richAreaLootTable = [
                { resource: 'money', minAmount: 5, maxAmount: 20, weight: 3 },
                { resource: 'gold_bar', minAmount: 1, maxAmount: 2, weight: 1 },
                { resource: 'black_cloth', minAmount: 1, maxAmount: 3, weight: 2 },
                { resource: 'thread', minAmount: 2, maxAmount: 5, weight: 2 },
                { resource: 'jewelry', minAmount: 1, maxAmount: 2, weight: 1 },
                { resource: 'luxury_item', minAmount: 1, maxAmount: 1, weight: 1 }
              ];
              
              // åŠ æƒéšæœºé€‰æ‹©ç‰©å“
              let totalWeight = richAreaLootTable.reduce((sum, item) => sum + item.weight, 0);
              let random = Math.random() * totalWeight;
              let selectedItem = null;
              
              for (const item of richAreaLootTable) {
                random -= item.weight;
                if (random <= 0) {
                  selectedItem = item;
                  break;
                }
              }
              
              // ç¡®ä¿è‡³å°‘è·å¾—1ä»¶ç‰©å“
              if (selectedItem && selectedItem.resource in gameData.resources) {
                // è®¡ç®—ç‰©å“æ•°é‡
                const amount = Math.floor(Math.random() * (selectedItem.maxAmount - selectedItem.minAmount + 1)) + selectedItem.minAmount;
                
                // å¢åŠ ç©å®¶èµ„æº
                gameData.resources[selectedItem.resource].amount += amount;
                stealResults.resources[selectedItem.resource] = amount;
                
                // è·å–ç‰©å“åç§°ç”¨äºé€šçŸ¥
                const itemName = gameData.resources[selectedItem.resource].name || selectedItem.resource;
                showNotification('å·çªƒæˆåŠŸ', `ä½ åœ¨å¯ŒäººåŒºæˆåŠŸå·åˆ°äº† ${amount} ä¸ª ${itemName}ï¼`);
              } else {
                // ä¿åº•é€»è¾‘ - å¦‚æœä»¥ä¸Šé€»è¾‘å¤±è´¥ï¼Œè‡³å°‘ç»™1ä¸ªé‡‘å¸
                if ('money' in gameData.resources) {
                  gameData.resources.money.amount += 5;
                  stealResults.resources.money = 5;
                  showNotification('å·çªƒæˆåŠŸ', 'ä½ åœ¨å¯ŒäººåŒºæˆåŠŸå·åˆ°äº† 5 ä¸ªé‡‘å¸ï¼');
                } else {
                  showNotification('å·çªƒæˆåŠŸ', 'ä½ åœ¨å¯ŒäººåŒºæˆåŠŸå·åˆ°äº†ä¸€äº›è´µé‡ç‰©å“ï¼');
                }
              }
              
              // æˆåŠŸå¥–åŠ±å·²ç»åœ¨å‰é¢çš„é€»è¾‘ä¸­å¤„ç†
                
              // å¢åŠ å·çªƒæŠ€èƒ½ç»éªŒ - æˆåŠŸæ—¶å¢åŠ 2ç‚¹
              if (gameData.skills.steal) {
                const experienceGain = 2;
                gameData.skills.steal.experience = (gameData.skills.steal.experience || 0) + experienceGain;
                
                // æ·»åŠ ç»éªŒå¢åŠ åˆ°ç»“æœä¸­
                stealResults.effects = stealResults.effects || [];
                stealResults.effects.push(`å·çªƒæŠ€èƒ½ç»éªŒ +${experienceGain}`);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§
                checkSkillLevelUp('steal', stealResults);
                
                updateSkillDisplay(); // æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºUI
              }
              showEventResult('å·çªƒæˆåŠŸ', stealResults);
            } else {
              // å¯ŒäººåŒºå·çªƒå¤±è´¥ - ç›´æ¥è¢«æŠ“
              showNotification('å·çªƒå¤±è´¥', 'ä½ åœ¨å¯ŒäººåŒºå·çªƒæ—¶è¢«å‘ç°å¹¶è¢«å·¡é€»é˜ŸæŠ“ä½äº†ï¼');
              
              // æ·»åŠ å…³æŠ¼ä¿¡æ¯åˆ°äº‹ä»¶ç»“æœ
              stealResults.effects.push('è¢«å·¡é€»é˜ŸæŠ“ä½é€è¿›ç‰¢æˆ¿ï¼Œå…³æŠ¼4å¤©');
              
              showEventResult('å·çªƒå¤±è´¥', stealResults);
              
              // å°†ç©å®¶é€å¾€ç‰¢æˆ¿
              sendToPrison();
              return; // ä¸ç»§ç»­æ‰§è¡Œåç»­ä»£ç 
            }
          } else {
            // éå¯ŒäººåŒºçš„æ™®é€šå·çªƒé€»è¾‘
            if (stealSuccess) {
              // å·çªƒæˆåŠŸï¼Œä¸å‡å°‘å£°æœ›
              
              // æ·»åŠ é‡‘æ¡
              gameData.resources.gold_bar.amount += 1;
              stealResults.resources.gold_bar = 1;
              
              // å¢åŠ å·çªƒæŠ€èƒ½ç»éªŒ - æˆåŠŸæ—¶å¢åŠ 2ç‚¹
              if (gameData.skills.steal) {
                const experienceGain = 2;
                gameData.skills.steal.experience = (gameData.skills.steal.experience || 0) + experienceGain;
                
                // æ·»åŠ ç»éªŒå¢åŠ åˆ°ç»“æœä¸­
                stealResults.effects = stealResults.effects || [];
                stealResults.effects.push(`å·çªƒæŠ€èƒ½ç»éªŒ +${experienceGain}`);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§
                checkSkillLevelUp('steal', stealResults);
                
                updateSkillDisplay(); // æ›´æ–°æŠ€èƒ½æ˜¾ç¤ºUI
              }
              
              showNotification('å·çªƒæˆåŠŸ', 'ä½ æˆåŠŸå·åˆ°äº†ä¸€äº›è´¢ç‰©å’Œä¸€æ ¹é‡‘æ¡ï¼');
              showEventResult('å·çªƒæˆåŠŸ', stealResults);
            } else {
              // å·çªƒå¤±è´¥ï¼Œæœ‰æ¦‚ç‡è¢«æŠ“
              const caughtChance = 0.7; // 70%æ¦‚ç‡è¢«æŠ“
              const isCaught = Math.random() < caughtChance;
              
              if (isCaught) {
                // è¢«æŠ“ä½ï¼Œé€è¿›ç‰¢æˆ¿
                showNotification('å·çªƒå¤±è´¥', 'ä½ åœ¨å·çªƒæ—¶è¢«å·¡é€»å£«å…µå‘ç°å¹¶è¢«æŠ“ä½äº†ï¼');
                
                // æ·»åŠ å…³æŠ¼ä¿¡æ¯åˆ°äº‹ä»¶ç»“æœ
                stealResults.effects.push('è¢«å·¡é€»é˜ŸæŠ“ä½é€è¿›ç‰¢æˆ¿ï¼Œå…³æŠ¼4å¤©');
                
                showEventResult('å·çªƒå¤±è´¥', stealResults);
                
                // å°†ç©å®¶é€å¾€ç‰¢æˆ¿
                sendToPrison();
                return; // ä¸ç»§ç»­æ‰§è¡Œåç»­ä»£ç 
              } else {
                // æ²¡è¢«æŠ“ä½ï¼Œä½†å£°æœ›é™ä½
                if (action.failure) {
                  for (const [status, amount] of Object.entries(action.failure)) {
                    if (status !== 'reputation') { // ä¸å‡å°‘å£°æœ›
                      gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                      stealResults.status[status] = amount;
                    }
                  }
                }
                // é¢å¤–å‡å°‘å£°æœ›
                const reputationLoss = -15;
                gameData.status.reputation = Math.max(-49, gameData.status.reputation + reputationLoss);
                stealResults.status.reputation = reputationLoss;
                
                showNotification('å·çªƒå¤±è´¥', 'ä½ åœ¨å·çªƒæ—¶å·®ç‚¹è¢«å‘ç°ï¼Œä¾¥å¹¸é€ƒè„±ï¼Œä½†å£°æœ›é™ä½äº†ã€‚');
                showEventResult('å·çªƒå¤±è´¥', stealResults);
              }
            }
          }
          break;
          
        case 'donate':
          // æ•‘æµ
          const donateSuccess = Math.random() > 0.1; // 90% æˆåŠŸç‡
          const donateResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          if (donateSuccess) {
            if (action.success) {
              for (const [resource, amount] of Object.entries(action.success)) {
                if (resource in gameData.resources) {
                  gameData.resources[resource].amount += amount;
                  donateResults.resources[resource] = amount;
                } else if (resource in gameData.status) {
                  gameData.status[resource] = Math.min(100, gameData.status[resource] + amount);
                  donateResults.status[resource] = amount;
                }
              }
            }
            showNotification('æ•‘æµæˆåŠŸ', 'å¯ºåº™ä¸ºä½ æä¾›äº†é£Ÿç‰©å’Œä½å®¿ï¼Œä½ çš„å¥åº·å’Œç²¾ç¥éƒ½æœ‰æ‰€æ¢å¤ã€‚');
            showEventResult('æ•‘æµç»“æœ', donateResults);
          } else {
            showNotification('æ•‘æµå¤±è´¥', 'ä»Šå¤©å¯ºåº™æ²¡æœ‰æä¾›æ•‘æµã€‚');
            showEventResult('æ•‘æµç»“æœ', donateResults);
          }
          break;
          
        case 'pray':
          // ç¥ˆç¦
          const praySuccess = Math.random() > 0.3; // 70% æˆåŠŸç‡
          const prayResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          if (praySuccess) {
            if (action.success) {
              for (const [status, amount] of Object.entries(action.success)) {
                gameData.status[status] = Math.min(100, gameData.status[status] + amount);
                prayResults.status[status] = amount;
              }
            }
            showNotification('ç¥ˆç¦æˆåŠŸ', 'ä½ çš„ç¥ˆç¥·å¾—åˆ°äº†å›åº”ï¼Œç²¾ç¥å’Œå£°æœ›éƒ½æœ‰æ‰€æå‡ã€‚');
            showEventResult('ç¥ˆç¦ç»“æœ', prayResults);
          } else {
            if (action.failure) {
              for (const [status, amount] of Object.entries(action.failure)) {
                gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                prayResults.status[status] = amount;
              }
            }
            showNotification('ç¥ˆç¦å¤±è´¥', 'ä½ çš„ç¥ˆç¥·æ²¡æœ‰å¾—åˆ°å›åº”ï¼Œç²¾ç¥çŠ¶æ€ä¸‹é™äº†ã€‚');
            showEventResult('ç¥ˆç¦ç»“æœ', prayResults);
          }
          break;
          
        /* case 'trade':
          // äº¤æ˜“ - æš‚æ—¶æ³¨é‡Šæ‰ï¼ŒåæœŸå†è¡¥å……
          const tradeSuccess = Math.random() > 0.4; // 60% æˆåŠŸç‡
          const tradeResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          if (tradeSuccess) {
            if (action.success) {
              for (const [resource, amount] of Object.entries(action.success)) {
                gameData.resources[resource].amount += amount;
                tradeResults.resources[resource] = amount;
              }
            }
            showNotification('äº¤æ˜“æˆåŠŸ', 'ä½ æˆåŠŸä¸å…¶ä»–ä¹ä¸äº¤æ¢äº†ç‰©èµ„ã€‚');
            showEventResult('äº¤æ˜“ç»“æœ', tradeResults);
          } else {
            if (action.failure) {
              for (const [resource, amount] of Object.entries(action.failure)) {
                gameData.resources[resource].amount = Math.max(0, gameData.resources[resource].amount + amount);
                tradeResults.resources[resource] = amount;
              }
            }
            showNotification('äº¤æ˜“å¤±è´¥', 'ä½ åœ¨äº¤æ˜“ä¸­è¢«éª—ï¼ŒæŸå¤±äº†ä¸€äº›ç‰©èµ„ã€‚');
            showEventResult('äº¤æ˜“ç»“æœ', tradeResults);
          }
          break; */
          
        case 'learn':
          // å­¦ä¹ 
          const learnSuccess = Math.random() > 0.3; // 70% æˆåŠŸç‡
          const learnResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          if (learnSuccess) {
            if (action.success) {
              for (const [status, amount] of Object.entries(action.success)) {
                gameData.status[status] = Math.min(100, gameData.status[status] + amount);
                learnResults.status[status] = amount;
              }
            }
            
            // éšæœºè§£é”ä¸€ä¸ªæœªè§£é”çš„é…æ–¹
            const undiscoveredRecipes = gameData.recipes.filter(recipe => !gameData.discoveredRecipes.includes(recipe.id));
            if (undiscoveredRecipes.length > 0) {
              const recipeToDiscover = undiscoveredRecipes[Math.floor(Math.random() * undiscoveredRecipes.length)];
              gameData.discoveredRecipes.push(recipeToDiscover.id);
              gameData.stats.recipesDiscovered++;
              learnResults.effects.push(`è§£é”äº†æ–°é…æ–¹: ${recipeToDiscover.name}`);
              showNotification('å­¦ä¹ æˆåŠŸ', `ä½ å­¦ä¼šäº†æ–°çš„åˆ¶ä½œæŠ€èƒ½ï¼Œè§£é”äº†${recipeToDiscover.name}çš„é…æ–¹ï¼`);
            } else {
              showNotification('å­¦ä¹ æˆåŠŸ', 'ä½ å­¦ä¹ äº†æ–°çš„æŠ€èƒ½ï¼Œå£°æœ›æœ‰æ‰€æå‡ã€‚');
            }
            
            showEventResult('å­¦ä¹ ç»“æœ', learnResults);
          } else {
            if (action.failure) {
              for (const [status, amount] of Object.entries(action.failure)) {
                gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                learnResults.status[status] = amount;
              }
            }
            showNotification('å­¦ä¹ å¤±è´¥', 'ä½ æ²¡æœ‰å­¦åˆ°æœ‰ç”¨çš„æŠ€èƒ½ï¼Œç²¾ç¥çŠ¶æ€ä¸‹é™äº†ã€‚');
            showEventResult('å­¦ä¹ ç»“æœ', learnResults);
          }
          break;
          

          
        case 'work':
          // åŠ³ä½œï¼ˆæ¶ˆè€—åŠå¤©æ—¶é—´ï¼‰
          const workSuccess = Math.random() > 0.4; // 60% æˆåŠŸç‡
          const workResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          // æ¶ˆè€—åŠå¤©æ—¶é—´ï¼ˆå¢åŠ 1.5ä¸ªå›åˆï¼‰
          gameData.timeTurns += 1.5;
          advanceTime(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¨è¿›æ—¶é—´æ®µ
          
          if (workSuccess) {
            if (action.success) {
              for (const [resource, amount] of Object.entries(action.success)) {
                if (resource in gameData.resources) {
                  gameData.resources[resource].amount += amount;
                  workResults.resources[resource] = amount;
                }
              }
            }
            
            showNotification('åŠ³ä½œæˆåŠŸ', 'ä½ å®Œæˆäº†ä»Šå¤©çš„åŠ³åŠ¨ï¼Œè·å¾—äº†å°‘é‡æŠ¥é…¬ã€‚');
            showEventResult('åŠ³ä½œç»“æœ', workResults);
          } else {
            if (action.failure) {
              for (const [status, amount] of Object.entries(action.failure)) {
                gameData.status[status] = Math.max(0, gameData.status[status] + amount);
                workResults.status[status] = amount;
              }
            }
            
            showNotification('åŠ³ä½œå¤±è´¥', 'ä½ åœ¨åŠ³åŠ¨ä¸­å—ä¼¤äº†ï¼Œæ²¡æœ‰è·å¾—ä»»ä½•æŠ¥é…¬ã€‚');
            showEventResult('åŠ³ä½œç»“æœ', workResults);
          }
          break;
          
        case 'gamble':
          // èµŒåš
          const gambleSuccess = Math.random() > 0.6; // 40% æˆåŠŸç‡
          const gambleResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          if (gambleSuccess) {
            if (action.success) {
              for (const [resource, amount] of Object.entries(action.success)) {
                if (resource in gameData.resources) {
                  gameData.resources[resource].amount += amount;
                  gambleResults.resources[resource] = amount;
                }
              }
            }
            
            showNotification('èµŒåšæˆåŠŸ', 'ä½ åœ¨èµŒåšä¸­èµ¢äº†ï¼');
            showEventResult('èµŒåšç»“æœ', gambleResults);
          } else {
            if (action.failure) {
              for (const [resource, amount] of Object.entries(action.failure)) {
                if (resource in gameData.resources) {
                  gameData.resources[resource].amount = Math.max(0, gameData.resources[resource].amount + amount);
                  gambleResults.resources[resource] = amount;
                } else if (resource in gameData.status) {
                  gameData.status[resource] = Math.max(0, gameData.status[resource] + amount);
                  gambleResults.status[resource] = amount;
                }
              }
            }
            
            showNotification('èµŒåšå¤±è´¥', 'ä½ åœ¨èµŒåšä¸­è¾“äº†ï¼ŒæŸå¤±äº†ä¸€äº›é’±å¸ï¼Œç²¾ç¥çŠ¶æ€ä¹Ÿä¸‹é™äº†ã€‚');
            showEventResult('èµŒåšç»“æœ', gambleResults);
          }
          break;
          
        case 'buy_goods':
          // æ‰“å¼€é»‘å¸‚è´§æ¶
          openBlackMarketShelf();
          return; // ä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼Œä¸ç»“æŸå›åˆ
          break;
          
        case 'buy_slave':
          // è´­ä¹°å¥´éš¶
          const buySlaveResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘æ¡
          if (gameData.resources.gold_bar.amount >= 3) {
            // æ¶ˆè€—é‡‘æ¡
            gameData.resources.gold_bar.amount -= 3;
            buySlaveResults.resources.gold_bar = -3;
            
            // æ·»åŠ å¥´éš¶
            gameData.resources.slave.amount += 1;
            buySlaveResults.resources.slave = 1;
            
            showNotification('è´­ä¹°æˆåŠŸ', 'ä½ ç”¨3å¼ é»„é‡‘å¡ç‰Œè´­ä¹°äº†ä¸€ä¸ªå¥´éš¶ï¼å¥´éš¶æ¯å¤©ä¼šè‡ªåŠ¨å¸®ä½ æ”¶é›†èµ„æºã€‚');
            showEventResult('è´­ä¹°ç»“æœ', buySlaveResults);
          } else {
            showNotification('è´­ä¹°å¤±è´¥', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„é»„é‡‘å¡ç‰Œï¼éœ€è¦3å¼ æ‰èƒ½è´­ä¹°å¥´éš¶ã€‚');
            showEventResult('è´­ä¹°ç»“æœ', buySlaveResults);
          }
          break;
          

          
        case 'open_black_market_shelf':
          // æ‰“å¼€é»‘å¸‚è´§æ¶
          openBlackMarketShelf();
          return; // ä¸ç»“æŸå›åˆ
          
        case 'talk_mystery':
          // ä¸ç¥ç§˜äººå¯¹è¯
          const talkMysteryResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          // æ£€æŸ¥æ˜¯å¦å·²ç»è§£é”é»‘å¸‚
          const blackMarketLocation = gameData.locations.find(loc => loc.id === 'black_market');
          if (blackMarketLocation && blackMarketLocation.available) {
            showNotification('å·²è§£é”é»‘å¸‚', 'ä½ å·²ç»çŸ¥é“äº†é»‘å¸‚çš„æ¶ˆæ¯ï¼Œå¯ä»¥éšæ—¶å‰å¾€ã€‚');
            showEventResult('å¯¹è¯ç»“æœ', talkMysteryResults);
            break;
          }
          
          // åˆ›å»ºå¯¹è¯æ¡†ï¼Œè¯¢é—®æ˜¯å¦æ„¿æ„èŠ±è´¹10ä¸ªé’±å¸è·å¾—é»‘å¸‚æ¶ˆæ¯
          elements.eventTitle.textContent = 'ç¥ç§˜äººçš„æè®®';
          elements.eventText.textContent = 'ã€Œæƒ³è¦çŸ¥é“é»‘å¸‚çš„ä½ç½®å—ï¼Ÿè¿™å¯æ˜¯ä¸ªç§˜å¯†ï¼Œéœ€è¦èŠ±è´¹10ä¸ªé’±å¸æ‰èƒ½å‘Šè¯‰ä½ ...ã€';
          
          // æ¸…ç©ºå¹¶æ·»åŠ é€‰é¡¹
          elements.eventOptions.innerHTML = '';
          
          // åŒæ„é€‰é¡¹
          const agreeOption = document.createElement('div');
          agreeOption.className = 'event-modal-option';
          agreeOption.innerHTML = `
            <div class="event-modal-option-text">åŒæ„èŠ±è´¹10ä¸ªé’±å¸</div>
            <div class="event-modal-option-description">æ”¯ä»˜10ä¸ªé’±å¸ä»¥è·å–é»‘å¸‚ä½ç½®</div>
          `;
          
          agreeOption.addEventListener('click', () => {
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é’±å¸
            if (gameData.resources.money.amount >= 10) {
              // æ¶ˆè€—10ä¸ªé’±å¸
              gameData.resources.money.amount -= 10;
              talkMysteryResults.resources.money = -10;
              
              // è§£é”é»‘å¸‚
              if (blackMarketLocation) {
                blackMarketLocation.available = true;
                talkMysteryResults.effects.push('è§£é”äº†é»‘å¸‚åœ°ç‚¹');
              }
              
              // é‡æ–°æ¸²æŸ“åœ°ç‚¹æ ï¼Œæ˜¾ç¤ºé»‘å¸‚
              renderLocations();
              
              showNotification('äº¤æ˜“æˆåŠŸ', 'ä½ æ”¯ä»˜äº†10ä¸ªé’±å¸ï¼Œç¥ç§˜äººå‘Šè¯‰ä½ äº†é»‘å¸‚çš„ä½ç½®ã€‚');
              showEventResult('å¯¹è¯ç»“æœ', talkMysteryResults);
              
              // æ›´æ–°UI
              renderResources();
              updateGameData();
              
              // æ¶ˆè€—æ—¶é—´
              advanceTime();
            } else {
              // æ˜¾ç¤ºé’±å¸ä¸è¶³çš„å¼¹çª—æç¤º
              showNoMoneyModal();
              // ä¸å†æ˜¾ç¤ºå¯¹è¯ç»“æœçª—å£ï¼Œé¿å…ä¸¤ä¸ªçª—å£åŒæ—¶å¼¹å‡º
            }
            
            elements.eventModal.classList.remove('active');
          });
          
          // æ·»åŠ æ‹’ç»æè®®æŒ‰é’®
          const closeButton = document.createElement('div');
          closeButton.className = 'event-modal-option';
          closeButton.style.backgroundColor = 'white'; // ç™½è‰²èƒŒæ™¯
          closeButton.innerHTML = `
            <div class="event-modal-option-text">æ‹’ç»æè®®</div>
            <div class="event-modal-option-description">ä¸æ”¯ä»˜é’±å¸ï¼Œç»“æŸå¯¹è¯</div>
          `;
          
          closeButton.addEventListener('click', () => {
            // ç›´æ¥å…³é—­å¯¹è¯çª—å£ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
            elements.eventModal.classList.remove('active');
          });
          
          // æ·»åŠ åŒæ„é€‰é¡¹å’Œå…³é—­æŒ‰é’®åˆ°é€‰é¡¹å®¹å™¨
          elements.eventOptions.appendChild(agreeOption);
          elements.eventOptions.appendChild(closeButton);
          
          // æ˜¾ç¤ºäº‹ä»¶æ¨¡æ€æ¡†
          elements.eventModal.classList.add('active');
          return; // ä¸ç»“æŸå›åˆ
          break;
          
        case 'craft':
          // åˆ¶ä½œ
          renderRecipes();
          elements.recipeModal.classList.add('active');
          return; // ä¸ç»“æŸå›åˆ
          
        case 'get_water':
          // æ£€æŸ¥æ˜¯å¦æ»¡è¶³è¡ŒåŠ¨æ‰€éœ€çš„èµ„æºï¼ˆè™½ç„¶UIä¸Šå·²ç»æ§åˆ¶ï¼Œä½†è¿™é‡Œå†æ¬¡æ£€æŸ¥ç¡®ä¿å®‰å…¨ï¼‰
          const waterAction = gameData.actions.find(act => act.id === 'get_water');
          let canPerformWaterAction = true;
          
          if (waterAction && waterAction.requires) {
            for (const [resource, amount] of Object.entries(waterAction.requires)) {
              if (!gameData.resources[resource] || gameData.resources[resource].amount < amount) {
                canPerformWaterAction = false;
                break;
              }
            }
          }
          
          if (canPerformWaterAction) {
            // æ˜¾ç¤ºæ‰“æ°´é€‰é¡¹å¼¹çª—
            showWaterOptionsModal();
          } else {
            showNotification('æ¡ä»¶ä¸è¶³', 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºæ¥æ‰§è¡Œè¿™ä¸ªè¡ŒåŠ¨ã€‚');
          }
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          
        case 'stream_action':
          // æ˜¾ç¤ºæºªè¾¹é€‰é¡¹å¼¹çª—
          showStreamOptionsModal();
          return; // ä¸ç»“æŸå›åˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
          
        case 'mountain_action':
          // è¿›å±±è¡ŒåŠ¨çš„ç®€å•å®ç°ï¼ˆåç»­å¯ä»¥æ‰©å±•æ›´å¤æ‚çš„é€»è¾‘ï¼‰
          const mountainResults = {
            resources: {},
            status: {},
            effects: []
          };
          
          // éšæœºè·å¾—ä¸€äº›è‰è¯ã€ç«¹å­æˆ–å…¶ä»–èµ„æº
          const rand = Math.random();
          if (rand < 0.4) {
            gameData.resources.herb.amount += 1;
            mountainResults.resources.herb = 1;
            mountainResults.effects.push('æ‰¾åˆ°äº†ä¸€äº›è‰è¯');
          } else if (rand < 0.6) {
            gameData.resources.stick.amount += 1;
            mountainResults.resources.stick = 1;
            mountainResults.effects.push('æ‰¾åˆ°äº†ä¸€æ ¹æœ¨æ£');
          } else if (rand < 0.8) {
            gameData.resources.bamboo.amount = (gameData.resources.bamboo.amount || 0) + 1;
            mountainResults.resources.bamboo = 1;
            mountainResults.effects.push('æ‰¾åˆ°äº†ä¸€æ ¹ç«¹å­');
          } else {
            gameData.resources.hide.amount += 1;
            mountainResults.resources.hide = 1;
            mountainResults.effects.push('å‘ç°äº†ä¸€å¼ å…½çš®');
          }
          
          // æ¶ˆè€—å°‘é‡å¥åº·å€¼
          gameData.status.health = Math.max(0, gameData.status.health - 5);
          mountainResults.status.health = -5;
          mountainResults.effects.push('åœ¨å±±æ—ä¸­è¡Œèµ°æ¶ˆè€—äº†ä½“åŠ›');
          
          // ä¿å­˜æ¸¸æˆæ•°æ®
          updateGameData();
          
          showNotification('è¿›å±±æ¢ç´¢', 'ä½ åœ¨å±±æ—ä¸­æ¢ç´¢äº†ä¸€ç•ªã€‚');
          showEventResult('æ¢ç´¢ç»“æœ', mountainResults);
          
          // æ›´æ–°UI
          renderResources();
          renderActions();
          
          // æ¶ˆè€—æ—¶é—´
          advanceTime();
          break;
          
      // æ‰“æ°´é€‰é¡¹å¼¹çª—å‡½æ•°
      function showWaterOptionsModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;
        
        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 300px;
          position: relative;
        `;
        
        // æ·»åŠ å…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.textContent = 'Ã—';
        closeButton.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          width: 30px;
          height: 30px;
          border: none;
          background-color: #8b5a2b;
          color: white;
          border-radius: 50%;
          font-size: 20px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          justify-content: center;
          align-items: center;
          line-height: 1;
          padding: 0;
        `;
        closeButton.onclick = function() {
          modalContainer.remove();
        };
        modalContent.appendChild(closeButton);
        
        // æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'é€‰æ‹©å–æ°´æ–¹å¼';
        title.style.marginBottom = '20px';
        modalContent.appendChild(title);
        
        // æ·»åŠ æè¿°
        const description = document.createElement('p');
        description.textContent = 'ä½ æ¥åˆ°æ°´äº•è¾¹ï¼Œæƒ³è¦å–ç‚¹æ°´...';
        description.style.marginBottom = '20px';
        modalContent.appendChild(description);
        
        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.justifyContent = 'center';
        buttonContainer.style.gap = '15px';
        
        // åˆ›å»ºç”¨æ‰‹æ§ç€å–æŒ‰é’®
        const handDrinkButton = document.createElement('button');
        handDrinkButton.textContent = 'ç”¨æ‰‹æ§ç€å–';
        handDrinkButton.style.cssText = `
          padding: 10px 20px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        handDrinkButton.onclick = function() {
          modalContainer.remove();
          drinkWaterWithHands();
        };
        
        // åˆ›å»ºç”¨æ°´è¢‹è£…æŒ‰é’®
        const waterBagButton = document.createElement('button');
        waterBagButton.textContent = 'ç”¨æ°´è¢‹è£…';
        waterBagButton.style.cssText = `
          padding: 10px 20px;
          background-color: #4a6fa5;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        waterBagButton.onclick = function() {
          modalContainer.remove();
          
          // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
          ensureWaterBagResources();
          
          // æ£€æµ‹èƒŒåŒ…ä¸­æ°´è¢‹çŠ¶æ€
          const hasEmptyWaterBag = gameData.resources.empty_water_bag && gameData.resources.empty_water_bag.amount > 0;
        // å…ˆå®šä¹‰å‡½æ•°ï¼Œé¿å…å¼•ç”¨é”™è¯¯
        function showNoWaterBagModal() {
          // åˆ›å»ºå¼¹çª—å®¹å™¨
          const modalContainer = document.createElement('div');
          modalContainer.className = 'modal';
          modalContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
          `;
          
          // åˆ›å»ºå¼¹çª—å†…å®¹
          const modalContent = document.createElement('div');
          modalContent.style.cssText = `
            background-color: #f0e6d6;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            min-width: 300px;
          `;
          
          // æ·»åŠ æ ‡é¢˜
          const title = document.createElement('h3');
          title.textContent = 'æ— æ³•è£…æ°´';
          title.style.marginBottom = '15px';
          modalContent.appendChild(title);
          
          // æ·»åŠ æç¤ºä¿¡æ¯
          const message = document.createElement('p');
          message.textContent = 'ä½ è¿˜æ²¡æœ‰æ°´è¢‹ï¼Œæ— æ³•æ‰“æ°´';
          message.style.marginBottom = '20px';
          modalContent.appendChild(message);
          
          // åˆ›å»ºå…³é—­æŒ‰é’®
          const closeButton = document.createElement('button');
          closeButton.textContent = 'å…³é—­';
          closeButton.style.cssText = `
            padding: 8px 16px;
            background-color: #8b5a2b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
          `;
          closeButton.onclick = function() {
            modalContainer.remove();
          };
          
          modalContent.appendChild(closeButton);
          modalContainer.appendChild(modalContent);
          document.body.appendChild(modalContainer);
        
        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function() {
          modalContainer.remove();
        };
        
        // é˜²æ­¢ç‚¹å‡»å¼¹çª—å†…å®¹æ—¶è§¦å‘å…³é—­
        modalContent.onclick = function(e) {
          e.stopPropagation();
        };
        }
        
        // ä½¿ç”¨å·²å£°æ˜çš„å˜é‡
        const hasFullWaterBag = gameData.resources.water_bag && gameData.resources.water_bag.amount > 0;
        
        if (hasEmptyWaterBag) {
          // æœ‰ç©ºæ°´è¢‹ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
          fillWaterBag();
        } else if (hasFullWaterBag) {
          // æœ‰æ°´è¢‹ï¼ˆæ»¡ï¼‰ï¼Œæ˜¾ç¤ºæ°´è¢‹å·²æ»¡æç¤º
          showWaterBagFullModal();
        } else {
          // æ²¡æœ‰æ°´è¢‹ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
          showNoWaterBagModal();
        }
      }
      
      buttonContainer.appendChild(handDrinkButton);
      buttonContainer.appendChild(waterBagButton);
      modalContent.appendChild(buttonContainer);
      
      modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
        
        // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
        modalContainer.onclick = function() {
          modalContainer.remove();
        };
        
        // é˜²æ­¢ç‚¹å‡»å¼¹çª—å†…å®¹æ—¶è§¦å‘å…³é—­
        modalContent.onclick = function(e) {
          e.stopPropagation();
        };
      }
      
      // æºªè¾¹é€‰é¡¹å¼¹çª—å‡½æ•°
      function showStreamOptionsModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;
        
        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 300px;
          position: relative;
        `;
        
        // æ·»åŠ å…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.textContent = 'Ã—';
        closeButton.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          width: 30px;
          height: 30px;
          border: none;
          background-color: #8b5a2b;
          color: white;
          border-radius: 50%;
          font-size: 20px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          justify-content: center;
          align-items: center;
          line-height: 1;
          padding: 0;
        `;
        closeButton.onclick = function() {
          modalContainer.remove();
        };
        modalContent.appendChild(closeButton);
        
        // æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'æ¸…æ¾ˆçš„æºªæ°´';
        title.style.marginBottom = '20px';
        modalContent.appendChild(title);
        
        // æ·»åŠ æè¿°
        const description = document.createElement('p');
        description.textContent = 'ä½ æ¥åˆ°ä¸€æ¡æ¸…æ¾ˆçš„å°æºªè¾¹ï¼Œæºªæ°´æ½ºæ½ºæµåŠ¨...';
        description.style.marginBottom = '20px';
        modalContent.appendChild(description);
        
        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.flexDirection = 'column';
        buttonContainer.style.gap = '10px';
        
        // åˆ›å»ºç”¨æ‰‹æ§ç€å–æŒ‰é’®
        const handDrinkButton = document.createElement('button');
        handDrinkButton.textContent = 'ç”¨æ‰‹æ§ç€å–';
        handDrinkButton.style.cssText = `
          padding: 10px 20px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        handDrinkButton.onclick = function() {
          modalContainer.remove();
          drinkWaterWithHands();
        };
        
        // åˆ›å»ºç”¨æ°´è¢‹è£…æŒ‰é’®
        const waterBagButton = document.createElement('button');
        waterBagButton.textContent = 'ç”¨æ°´è¢‹è£…';
        waterBagButton.style.cssText = `
          padding: 10px 20px;
          background-color: #4a6fa5;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        waterBagButton.onclick = function() {
          modalContainer.remove();
          
          // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
          ensureWaterBagResources();
          
          // æ£€æµ‹èƒŒåŒ…ä¸­æ°´è¢‹çŠ¶æ€
          const hasEmptyWaterBag = gameData.resources.empty_water_bag && gameData.resources.empty_water_bag.amount > 0;
          const hasFullWaterBag = gameData.resources.water_bag && gameData.resources.water_bag.amount > 0;
          
          if (hasEmptyWaterBag) {
            // æœ‰ç©ºæ°´è¢‹ï¼Œæ‰§è¡Œè£…æ°´é€»è¾‘
            fillWaterBag();
          } else if (hasFullWaterBag) {
            // æœ‰æ°´è¢‹ï¼ˆæ»¡ï¼‰ï¼Œæ˜¾ç¤ºæ°´è¢‹å·²æ»¡æç¤º
            showWaterBagFullModal();
          } else {
            // æ²¡æœ‰æ°´è¢‹ï¼Œæ˜¾ç¤ºæç¤ºçª—å£
            showNoWaterBagModal();
          }
        };
        
        // åˆ›å»ºä¸‹æ°´æ‘¸é±¼æŒ‰é’®
        const fishButton = document.createElement('button');
        fishButton.textContent = 'ä¸‹æ°´æ‘¸é±¼';
        fishButton.style.cssText = `
          padding: 10px 20px;
          background-color: #2e8b57;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        fishButton.onclick = function() {
          modalContainer.remove();
          catchFishInStream();
        };
        
        buttonContainer.appendChild(handDrinkButton);
        buttonContainer.appendChild(waterBagButton);
        buttonContainer.appendChild(fishButton);
        modalContent.appendChild(buttonContainer);
        
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
      }
      
      // ç”¨æ‰‹æ§ç€å–çš„é€»è¾‘
      function drinkWaterWithHands() {
        const getWaterResults = {
          resources: {},
          status: {},
          effects: []
        };
        
        // å¢åŠ å£æ¸´å€¼ï¼Œä½†æ¯”ç”¨ç¢—å°‘ä¸€äº›
        gameData.status.thirst = Math.min(100, gameData.status.thirst + 5);
        getWaterResults.status.thirst = 5;
        
        // æ·»åŠ è¡ŒåŠ¨æ•ˆæœè¯´æ˜
        getWaterResults.effects.push('ç”¨æ‰‹æ§ç€å–äº†ä¸€äº›æ°´');
        
        // ä¿å­˜æ¸¸æˆæ•°æ®
        updateGameData();
        
        showNotification('å–æ°´æˆåŠŸ', 'ä½ ç”¨æ‰‹æ§ç€å–äº†ä¸€äº›æ°´ï¼Œæ„Ÿè§‰ç¨å¾®æ²¡é‚£ä¹ˆæ¸´äº†ã€‚');
        showEventResult('å–æ°´ç»“æœ', getWaterResults);
        
        // æ›´æ–°UI
        renderResources();
        renderActions();
        
        // æ¶ˆè€—æ—¶é—´
        advanceTime();
      }
      
      // ç”¨æ°´è¢‹è£…æ°´çš„é€»è¾‘
      function fillWaterBag() {
        const getWaterResults = {
          resources: {},
          status: {},
          effects: []
        };
        
        // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
        ensureWaterBagResources();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ°´è¢‹ï¼ˆæ»¡ï¼‰
        if (gameData.resources.water_bag && gameData.resources.water_bag.amount > 0) {
          // æ˜¾ç¤ºæ°´è¢‹å·²æ»¡æç¤º
          showWaterBagFullModal();
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ°´è¢‹ï¼ˆç©ºï¼‰
        if (gameData.resources.empty_water_bag && gameData.resources.empty_water_bag.amount > 0) {
          // æ¶ˆè€—ä¸€ä¸ªæ°´è¢‹ï¼ˆç©ºï¼‰
          gameData.resources.empty_water_bag.amount -= 1;
          getWaterResults.resources.empty_water_bag = -1;
          
          // å¦‚æœæ°´è¢‹ï¼ˆç©ºï¼‰æ•°é‡ä¸º0ï¼Œä¿æŒèµ„æºå­˜åœ¨ä½†amountä¸º0
          // å¢åŠ ä¸€ä¸ªæ°´è¢‹ï¼ˆæ»¡ï¼‰
          gameData.resources.water_bag.amount += 1;
          getWaterResults.resources.water_bag = 1;
          
          // æ·»åŠ è¡ŒåŠ¨æ•ˆæœè¯´æ˜
          getWaterResults.effects.push('å°†æ°´è¢‹ï¼ˆç©ºï¼‰è£…æ»¡äº†æ°´');
          
          // ä¿å­˜æ¸¸æˆæ•°æ®
          updateGameData();
          
          showNotification('è£…æ°´æˆåŠŸ', 'ä½ æˆåŠŸå°†æ°´è¢‹è£…æ»¡äº†æ°´ã€‚');
        } else {
          // æ²¡æœ‰æ°´è¢‹ï¼ˆç©ºï¼‰
          showNotification('è£…æ°´å¤±è´¥', 'ä½ æ²¡æœ‰ç©ºæ°´è¢‹ï¼Œæ— æ³•è£…æ°´ã€‚');
        }
        
        if (getWaterResults.effects.length > 0) {
          showEventResult('è£…æ°´ç»“æœ', getWaterResults);
        }
        
        // æ›´æ–°UI
        renderResources();
        renderActions();
        
        // æ¶ˆè€—æ—¶é—´
        advanceTime();
      }
      
      // ç¡®ä¿æ°´è¢‹èµ„æºæ­£ç¡®åˆå§‹åŒ–
      function ensureWaterBagResources() {
        // åˆå§‹åŒ–æ°´è¢‹ï¼ˆç©ºï¼‰
        if (!gameData.resources.empty_water_bag) {
          gameData.resources.empty_water_bag = {
            name: 'æ°´è¢‹ï¼ˆç©ºï¼‰',
            description: 'ä¸€ä¸ªç©ºçš„æ°´è¢‹ï¼Œå¯ä»¥ç”¨æ¥è£…æ°´',
            amount: 0,
            image: 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg',
            type: 'tool',
            category: 'material',
            id: 'empty_water_bag',
            cannotDrop: false
          };
        }
        
        // ç¡®ä¿æ°´è¢‹ï¼ˆç©ºï¼‰çš„å±æ€§æ­£ç¡®è®¾ç½®
        gameData.resources.empty_water_bag.name = 'æ°´è¢‹ï¼ˆç©ºï¼‰';
        gameData.resources.empty_water_bag.category = 'material';
        gameData.resources.empty_water_bag.type = 'container';
        
        // åˆå§‹åŒ–æ°´è¢‹ï¼ˆæ»¡ï¼‰
        if (!gameData.resources.water_bag) {
          gameData.resources.water_bag = {
            name: 'æ°´è¢‹ï¼ˆæ»¡ï¼‰',
            description: 'ä¸€ä¸ªè£…æ»¡æ°´çš„æ°´è¢‹ï¼Œå¯ä»¥é¥®ç”¨',
            amount: 0,
            image: 'UI/æ°´è¢‹ï¼ˆæ»¡ï¼‰.jpg',
            type: 'consumable',
            category: 'food',
            id: 'water_bag',
            cannotDrop: false,
            // é¥®ç”¨æ•ˆæœ
            useEffect: function() {
              gameData.status.thirst = Math.min(100, gameData.status.thirst + 20);
              return { thirst: 20 };
            }
          };
        }
        
        // ç¡®ä¿æ°´è¢‹ï¼ˆæ»¡ï¼‰çš„å±æ€§æ­£ç¡®è®¾ç½®
        gameData.resources.water_bag.name = 'æ°´è¢‹ï¼ˆæ»¡ï¼‰';
        gameData.resources.water_bag.category = 'food';
        gameData.resources.water_bag.type = 'consumable';
        // ç¡®ä¿ä¸å…·æœ‰è£…å¤‡å±æ€§
        delete gameData.resources.water_bag.equipmentSlot;
        
        // ç¡®ä¿amountæ˜¯æ•°å­—ç±»å‹
        if (typeof gameData.resources.empty_water_bag.amount !== 'number') {
          gameData.resources.empty_water_bag.amount = 0;
        }
        if (typeof gameData.resources.water_bag.amount !== 'number') {
          gameData.resources.water_bag.amount = 0;
        }
      }
      
      // ä¸‹æ°´æ‘¸é±¼çš„é€»è¾‘
      function catchFishInStream() {
        const fishResults = {
          resources: {},
          status: {},
          effects: []
        };
        
        // ç¡®ä¿é±¼èµ„æºå­˜åœ¨
        ensureFishResource();
        
        // éšæœºåˆ¤æ–­æ˜¯å¦æ‘¸åˆ°é±¼ï¼ˆ50%å‡ ç‡ï¼‰
        const catchSuccess = Math.random() < 0.5;
        
        if (catchSuccess) {
          // æˆåŠŸæ‘¸åˆ°é±¼
          gameData.resources.fish.amount += 1;
          fishResults.resources.fish = 1;
          fishResults.effects.push('æˆåŠŸæ‘¸åˆ°ä¸€æ¡é±¼ï¼');
          
          showNotification('æ‘¸é±¼æˆåŠŸ', 'ä½ æˆåŠŸä»æºªæ°´ä¸­æ‘¸åˆ°ä¸€æ¡é±¼ï¼');
        } else {
          // æ²¡æœ‰æ‘¸åˆ°é±¼
          fishResults.effects.push('è¿™æ¬¡æ²¡æœ‰æ‘¸åˆ°é±¼');
          showNotification('æ‘¸é±¼å¤±è´¥', 'ä½ åœ¨æ°´ä¸­æ‘¸ç´¢äº†åŠå¤©ï¼Œä½†æ²¡æœ‰æ‘¸åˆ°é±¼ã€‚');
        }
        
        // ä¸‹æ°´æ‘¸é±¼ä¼šæ¶ˆè€—ä½“åŠ›å’Œå¯’å†·å€¼
        gameData.status.health = Math.max(0, gameData.status.health - 3);
        gameData.status.cold = Math.max(0, gameData.status.cold - 5);
        fishResults.status.health = -3;
        fishResults.status.cold = -5;
        fishResults.effects.push('é•¿æ—¶é—´åœ¨æ°´ä¸­è®©ä½ æ„Ÿåˆ°å¯’å†·å’Œç–²æƒ«');
        
        // ä¿å­˜æ¸¸æˆæ•°æ®
        updateGameData();
        
        showEventResult('æ‘¸é±¼ç»“æœ', fishResults);
        
        // æ›´æ–°UI
        renderResources();
        renderActions();
        
        // æ¶ˆè€—æ—¶é—´
        advanceTime();
      }
      
      // ç¡®ä¿é±¼èµ„æºæ­£ç¡®åˆå§‹åŒ–
      function ensureFishResource() {
        if (!gameData.resources.fish) {
          gameData.resources.fish = {
            name: 'é±¼',
            description: 'æ–°é²œçš„é±¼ï¼Œå¯ä»¥çƒ¹é¥ªåé£Ÿç”¨',
            amount: 0,
            image: 'UI/é±¼.jpg',
            type: 'consumable',
            category: 'food',
            id: 'fish',
            cannotDrop: false,
            // ç›´æ¥é£Ÿç”¨ç”Ÿé±¼çš„æ•ˆæœ
            useEffect: function() {
              gameData.status.hunger = Math.min(100, gameData.status.hunger + 15);
              gameData.status.health = Math.max(0, gameData.status.health - 10); // ç”Ÿåƒæœ‰é£é™©
              return { hunger: 15, health: -10 };
            }
          };
        }
        
        // ç¡®ä¿amountæ˜¯æ•°å­—ç±»å‹
        if (typeof gameData.resources.fish.amount !== 'number') {
          gameData.resources.fish.amount = 0;
        }
      }
      
      // æ°´è¢‹å·²æ»¡æç¤ºå¼¹çª—
      function showWaterBagFullModal() {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        const modalContainer = document.createElement('div');
        modalContainer.className = 'modal';
        modalContainer.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1001; /* æ¯”ä¹‹å‰çš„å¼¹çª—å±‚çº§æ›´é«˜ */
        `;
        
        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #f0e6d6;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          min-width: 280px;
        `;
        
        // æ·»åŠ æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'æç¤º';
        title.style.marginBottom = '15px';
        modalContent.appendChild(title);
        
        // æ·»åŠ æç¤ºä¿¡æ¯
        const message = document.createElement('p');
        message.textContent = 'æ°´è¢‹å·²ç»è£…æ»¡äº†ï¼Œæ— æ³•ç»§ç»­è£…æ°´ã€‚';
        message.style.marginBottom = '20px';
        modalContent.appendChild(message);
        
        // åˆ›å»ºç¡®å®šæŒ‰é’®
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®å®š';
        confirmButton.style.cssText = `
          padding: 10px 30px;
          background-color: #8b5a2b;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        `;
        
        confirmButton.onclick = function() {
          // ç§»é™¤æ‰€æœ‰æ¨¡æ€çª—å£
          const allModals = document.querySelectorAll('.modal');
          allModals.forEach(modal => modal.remove());
          
          // æ›´æ–°UIå¹¶æ¶ˆè€—æ—¶é—´
          renderResources();
          renderActions();
          advanceTime();
        };
        
        modalContent.appendChild(confirmButton);
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
      }
      
      break;
      }
      
      // æ›´æ–°UI
      renderResources();
      renderActions();
      updateGameData();
      
      // æ¶ˆè€—æ—¶é—´
      advanceTime();
    }

    // è§¦å‘éšæœºäº‹ä»¶
    function triggerRandomEvent() {
      const event = gameData.events[Math.floor(Math.random() * gameData.events.length)];
      
      elements.eventTitle.textContent = event.name;
      elements.eventText.textContent = event.text;
      
      // æ¸…ç©ºå¹¶æ·»åŠ é€‰é¡¹
      elements.eventOptions.innerHTML = '';
      
      for (const option of event.options) {
        const optionElement = document.createElement('div');
        optionElement.className = 'event-modal-option';
        
        optionElement.innerHTML = `
          <div class="event-modal-option-text">${option.text}</div>
          <div class="event-modal-option-description">${option.description}</div>
        `;
        
        optionElement.addEventListener('click', () => {
          // åº”ç”¨é€‰é¡¹ç»“æœ
          for (const [resource, amount] of Object.entries(option.result)) {
            if (resource in gameData.resources) {
              gameData.resources[resource].amount = Math.max(0, gameData.resources[resource].amount + amount);
            } else if (resource in gameData.status) {
              gameData.status[resource] = Math.min(100, Math.max(0, gameData.status[resource] + amount));
            }
          }
          
          // ç‰¹æ®Šå¤„ç†ï¼šå½“é€‰æ‹©"åæŠ—"é€‰é¡¹æ—¶ï¼Œå¢åŠ æ­¦æœ¯æŠ€èƒ½ç»éªŒå€¼
          if (option.text === 'åæŠ—') {
            gameData.skills.martial.experience += 1;
            checkSkillLevelUp('martial');
          }
          
          // æ›´æ–°UI
          renderResources();
          updateGameData();
          
          elements.eventModal.classList.remove('active');
          endTurn();
        });
        
        elements.eventOptions.appendChild(optionElement);
      }
      
      elements.eventModal.classList.add('active');
    }

    // é€è¿›ç‰¢æˆ¿
    function sendToPrison() {
      // è·å–å½“å‰åœ°ç‚¹
      const currentLocation = gameData.locations.find(loc => loc.currentLocation);
      
      if (currentLocation) {
        currentLocation.currentLocation = false;
      }
      
      // æ‰¾åˆ°ç‰¢æˆ¿åœ°ç‚¹å¹¶è®¾ç½®ä¸ºå½“å‰åœ°ç‚¹
      const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
      if (prisonLocation) {
        prisonLocation.currentLocation = true;
        prisonLocation.available = true;
        
        // è®¾ç½®åˆ‘æœŸï¼ˆ4å¤©ï¼‰
        prisonLocation.sentenceDays = 4;
        
        // æ˜¾ç¤ºè¢«æ•é€šçŸ¥
        showNotification('è¢«æ•å…¥ç‹±', `ä½ å› å·çªƒè¢«æŠ“ï¼Œè¢«åˆ¤å¤„ç›‘ç¦4å¤©ï¼`);
        
        // å‡å°‘å¥åº·å’Œç²¾ç¥
        gameData.status.health -= 20;
        gameData.status.spirit -= 30;
        
        // æ›´æ–°UI
        renderLocations();
        renderActions();
        updateGameData();
      }
    }
    
    // æ¨è¿›æ—¶é—´
    function advanceTime() {
      const timeOrder = ['early_morning', 'morning', 'afternoon', 'evening', 'night'];
      const currentTimeIndex = timeOrder.indexOf(gameData.timeOfDay);
      
      // å¢åŠ å½“å‰æ—¶é—´æ®µçš„å›åˆæ•°
      gameData.timeTurns++;
      
      // å¦‚æœå½“å‰æ—¶é—´æ®µå·²è¿›è¡Œ3ä¸ªå›åˆï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ®µ
      if (gameData.timeTurns >= 3) {
        const nextTimeIndex = (currentTimeIndex + 1) % timeOrder.length;
        gameData.timeOfDay = timeOrder[nextTimeIndex];
        gameData.timeTurns = 0; // é‡ç½®å›åˆæ•°
        
        // å¦‚æœæ—¶é—´ä»æ™šä¸Šå˜ä¸ºæ¸…æ™¨ï¼Œå¢åŠ ä¸€å¤©
        if (gameData.timeOfDay === 'early_morning' && timeOrder[currentTimeIndex] === 'night') {
          gameData.day++;
          
          // æ£€æŸ¥BUFFæ˜¯å¦è¿‡æœŸ
          if (gameData.buffs && gameData.buffs.careful && gameData.buffs.careful.active) {
            if (gameData.day > gameData.buffs.careful.endDay) {
              gameData.buffs.careful.active = false;
              showNotification('BUFFæ¶ˆå¤±', '"å°å¿ƒä¸€ç‚¹"çŠ¶æ€æ•ˆæœå·²è¿‡æœŸã€‚');
            }
          }
          
          // é‡ç½®æ”¾æ–‹æ—¥é¢†å–çŠ¶æ€
          gameData.fastingDayClaimed = false;
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¾æ–‹æ—¥ï¼ˆç¬¬2å¤©å¼€å§‹ï¼Œæ¯4å¤©ä¸€æ¬¡ï¼‰
          if (gameData.day % 4 === 2) {
            showNotification('æ”¾æ–‹æ—¥æç¤º', 'ä»Šæ—¥æ˜¯å¯ºåº™æ”¾æ–‹æ—¥ï¼Œå¯ä»¥å»å¯ºåº™å¯»æ–‹é¥­ã€‚', true, true);
            
            // æ·»åŠ æ”¾æ–‹æ—¥è¡ŒåŠ¨åˆ°å¯ºåº™
            const templeLocation = gameData.locations.find(loc => loc.id === 'temple');
            if (templeLocation && !templeLocation.actions.includes('fasting_day')) {
              templeLocation.actions.push('fasting_day');
              if (typeof renderActions === 'function') renderActions(); // æ›´æ–°ç•Œé¢ä¸Šçš„è¡ŒåŠ¨åˆ—è¡¨
            }
          } else {
            // éæ”¾æ–‹æ—¥ï¼Œç§»é™¤æ”¾æ–‹æ—¥è¡ŒåŠ¨
            const templeLocation = gameData.locations.find(loc => loc.id === 'temple');
            if (templeLocation) {
              templeLocation.actions = templeLocation.actions.filter(action => action !== 'fasting_day');
              if (typeof renderActions === 'function') renderActions(); // æ›´æ–°ç•Œé¢ä¸Šçš„è¡ŒåŠ¨åˆ—è¡¨
            }
          }
          
          // é‡ç½®è¡ŒåŠ¨ç‚¹ä¸ºæ»¡å€¼
          gameData.status.actionPoints = 20;
          
          // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¢æˆ¿ä¸­
            const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
            if (prisonLocation && prisonLocation.currentLocation) {
              // å‡å°‘åˆ‘æœŸ
              prisonLocation.sentenceDays--;
              
              if (prisonLocation.sentenceDays <= 0) {
                // åˆ‘æœŸç»“æŸï¼Œé‡Šæ”¾å‡ºç‹±
                releaseFromPrison();
              } else {
                // æ˜¾ç¤ºå‰©ä½™åˆ‘æœŸé€šçŸ¥ï¼Œå‰©ä½™1å¤©æ˜¾ç¤ºä¸º"æœ€åä¸€å¤©"
                const daysMessage = prisonLocation.sentenceDays === 1 ? 'æœ€åä¸€å¤©' : `${prisonLocation.sentenceDays}å¤©`;
                showNotification('åˆ‘æœŸé€šçŸ¥', `ä½ è¿˜éœ€è¦åœ¨ç‰¢æˆ¿ä¸­åº¦è¿‡${daysMessage}ã€‚`);
                
                // åœ¨ç‰¢æˆ¿ä¸­æ¯å¤©å‡å°‘å¥åº·å’Œç²¾ç¥
                gameData.status.health -= 5;
                gameData.status.spirit -= 5;
              }
            }
          
          // æ›´æ–°å­£èŠ‚
          if (gameData.day % 10 === 1) {
            const seasons = ['spring', 'summer', 'autumn', 'winter'];
            const currentSeasonIndex = seasons.indexOf(gameData.season);
            gameData.season = seasons[(currentSeasonIndex + 1) % 4];
            
            showNotification('å­£èŠ‚å˜åŒ–', `ç°åœ¨æ˜¯${gameData.season === 'spring' ? 'æ˜¥å­£' : gameData.season === 'summer' ? 'å¤å­£' : gameData.season === 'autumn' ? 'ç§‹å­£' : 'å†¬å­£'}äº†ã€‚`);
          }
          
          // æ ¹æ®å­£èŠ‚æ¶ˆè€—èµ„æº
          switch (gameData.season) {
            case 'spring':
              gameData.status.hunger += 5;  // é¥¥é¥¿å¢åŠ 
              gameData.status.cold += 5;    // å¯’å†·å‡å°‘
              break;
            case 'summer':
              gameData.status.hunger += 8;  // é¥¥é¥¿å¢åŠ æ›´å¤š
              gameData.status.cold += 10;   // å¯’å†·å‡å°‘æ›´å¤š
              gameData.status.health -= 3;  // å¤å­£å®¹æ˜“ç”Ÿç—…
              break;
            case 'autumn':
              gameData.status.hunger += 7;  // é¥¥é¥¿å¢åŠ 
              gameData.status.cold -= 5;    // å¯’å†·å¢åŠ 
              break;
            case 'winter':
              gameData.status.hunger += 10; // é¥¥é¥¿å¢åŠ æœ€å¤š
              gameData.status.cold -= 15;   // å¯’å†·å¢åŠ æœ€å¤š
              gameData.status.health -= 5;  // å†¬å­£å®¹æ˜“ç”Ÿç—…
              break;
          }
          
          // ç‰©å“è€ä¹…åº¦å‡å°‘
          decreaseItemDurability();
          
          // å¥´éš¶è‡ªåŠ¨æ”¶é›†èµ„æº
          if (gameData.resources.slave.amount > 0) {
            const slaveResults = {
              resources: {},
              status: {},
              effects: []
            };
            
            // æ¯ä¸ªå¥´éš¶æ¯å¤©éšæœºæ”¶é›†ä¸€äº›èµ„æº
            for (let i = 0; i < gameData.resources.slave.amount; i++) {
              const resources = ['food', 'money', 'cloth', 'stick', 'black_cloth', 'thread'];
              const resource = resources[Math.floor(Math.random() * resources.length)];
              const amount = Math.floor(Math.random() * 2) + 1; // 1-2ä¸ªèµ„æº
              
              gameData.resources[resource].amount += amount;
              slaveResults.resources[resource] = (slaveResults.resources[resource] || 0) + amount;
            }
            
            // æ˜¾ç¤ºå¥´éš¶æ”¶é›†èµ„æºçš„é€šçŸ¥
            if (Object.keys(slaveResults.resources).length > 0) {
              let message = `ä½ çš„${gameData.resources.slave.amount}ä¸ªå¥´éš¶ä¸ºä½ æ”¶é›†äº†ï¼š`;
              for (const [resource, amount] of Object.entries(slaveResults.resources)) {
                message += `${gameData.resources[resource].name}x${amount}ï¼Œ`;
              }
              message = message.slice(0, -1) + 'ã€‚';
              
              showNotification('å¥´éš¶çš„æ”¶è·', message);
              showEventResult('å¥´éš¶æ”¶è·', slaveResults);
            }
          }
          
          // ä¸å†æ˜¾ç¤ºæ–°çš„ä¸€å¤©é€šçŸ¥
        } else {
          // æ ¹æ®æ—¶é—´æ®µæ˜¾ç¤ºä¸åŒçš„é€šçŸ¥
          const timeMessages = {
            early_morning: 'æ¸…æ™¨',
            morning: 'ä¸Šåˆ',
            afternoon: 'ä¸‹åˆ',
            evening: 'å‚æ™š',
            night: 'å¤œæ™š'
          };
          
          // ä¸å†æ˜¾ç¤ºæ—¶é—´æµé€é€šçŸ¥
        }
      } else {
        // æ ¹æ®æ—¶é—´æ®µæ˜¾ç¤ºä¸åŒçš„é€šçŸ¥
        const timeMessages = {
          early_morning: 'æ¸…æ™¨',
          morning: 'ä¸Šåˆ',
          afternoon: 'ä¸‹åˆ',
          evening: 'å‚æ™š',
          night: 'å¤œæ™š'
        };
        
        // ä¸å†æ˜¾ç¤ºæ—¶é—´æµé€é€šçŸ¥
      }
      
      // æ— é™æ¨¡å¼ - ç§»é™¤æ‰€æœ‰æ¸¸æˆç»“æŸæ¡ä»¶
      // çŠ¶æ€å€¼ä¸ä¼šå¯¼è‡´æ¸¸æˆç»“æŸï¼Œä½†ä¼šå½±å“æ¸¸æˆä½“éªŒ
      // ä¿æŒçŠ¶æ€å€¼åœ¨åˆç†èŒƒå›´å†…
      gameData.status.health = Math.max(1, Math.min(100, gameData.status.health));
      gameData.status.hunger = Math.max(0, Math.min(99, gameData.status.hunger));
      gameData.status.cold = Math.max(1, Math.min(100, gameData.status.cold));
      gameData.status.spirit = Math.max(1, Math.min(100, gameData.status.spirit));
      gameData.status.reputation = Math.max(-49, Math.min(99, gameData.status.reputation));
      
      // æ›´æ–°UI
      updateGameData();
      renderActions();
      
      return false;
    }
    
    // æ‰“å¼€é»‘å¸‚è´§æ¶
    function openBlackMarketShelf() {
      // åˆ›å»ºè´§æ¶å¼¹çª—
      const shelfModal = document.createElement('div');
      shelfModal.className = 'shelf-modal';
      shelfModal.id = 'blackMarketShelfModal';
      shelfModal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #1A202C;
        border: 2px solid #4A5568;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        width: 90%;
        max-width: 900px;
        max-height: 85vh;
        overflow-y: auto;
        transition: all 0.3s ease;
        background-image: linear-gradient(135deg, #1A202C 0%, #2D3748 100%);
      `;
      
      // è´§æ¶å•†å“åˆ—è¡¨
      const shelfItems = [
        { id: 'medicine', name: 'çµè¯', price: 1, description: 'çè´µçš„è‰è¯ï¼Œèƒ½æ¢å¤å¤§é‡å¥åº·' },
        { id: 'house_deed', name: 'æˆ¿å±‹åœ°å¥‘', price: 1, description: 'æ‹¥æœ‰è‡ªå·±çš„æˆ¿äº§ï¼Œæé«˜å£°æœ›å’Œç²¾ç¥çŠ¶æ€' },
        { id: 'fine_clothes', name: 'ç²¾ç¾åæœ', price: 1, description: 'åä¸½çš„æœè£…ï¼Œå¤§å¹…æé«˜å£°æœ›å’Œä¿æš–åº¦' },
        { id: 'silk_shoes', name: 'ç¼é‹', price: 1, description: 'ç²¾è‡´çš„ç¼é¢é‹å­ï¼Œæé«˜å£°æœ›å’Œå¥åº·' },
        { id: 'dog_beating_stick', name: 'æ‰“ç‹—æ£’æ³•', price: 1, description: 'ä¸å¸®ç»æŠ€ï¼Œæé«˜æˆ˜æ–—åŠ›å’Œå£°æœ›', special: true },
        { id: 'herbal_manual', name: 'æœ¬è‰çº²ç›®', price: 1, description: 'åŒ»å­¦ç»å…¸ï¼Œæé«˜å¥åº·æ¢å¤é€Ÿåº¦', special: true },
        { id: 'huangdi_canon', name: 'é»„å¸å†…ç»', price: 1, description: 'åŒ»å­¦ç»å…¸ï¼Œå¤§å¹…æé«˜å¥åº·ä¸Šé™', special: true },
        { id: 'stealth_book', name: 'å·å¤©æ¢æ—¥', price: 1, description: 'ç›—çªƒæŠ€å·§ï¼Œæé«˜å·çªƒæˆåŠŸç‡', special: true }
      ];
      
      // å¼¹çª—å†…å®¹
      shelfModal.innerHTML = `
        <div class="shelf-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #4A5568;">
          <h3 style="font-size: 1.5rem; font-weight: 700; color: #EDF2F7; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">é»‘å¸‚è´§æ¶</h3>
          <button id="closeShelfButton" style="background: #4A5568; border: none; font-size: 1.25rem; cursor: pointer; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">&times;</button>
        </div>
        <div class="shelf-modal-body">
          <div class="current-gold" style="margin-bottom: 1.5rem; text-align: center; font-size: 1.25rem; font-weight: 600; color: #E2E8F0;">
            <span style="background: linear-gradient(45deg, #D69E2E, #FBBF24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">ğŸ’°</span> å½“å‰é‡‘æ¡: <span id="currentGoldAmount" style="font-weight: bold; color: #D69E2E;">${gameData.resources.gold_bar.amount}</span> æ ¹
          </div>
          <div class="shelf-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem;">
            ${shelfItems.map(item => {
              const resource = gameData.resources[item.id];
              return `
                <div class="shelf-item" style="background-color: #2D3748; border: 1px solid #4A5568; border-radius: 0.75rem; padding: 1.25rem; display: flex; flex-direction: column; align-items: center; text-align: center; transition: all 0.3s ease; transform: translateY(0); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
                  <div class="item-image" style="width: 120px; height: 120px; margin-bottom: 0.75rem; background-color: #1A202C; border: 2px solid #4A5568; border-radius: 0.5rem; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                    <img src="${resource ? resource.image : ''}" alt="${resource ? resource.name : item.name}" style="width: 100%; height: 100%; object-fit: contain; padding: 8px;">
                  </div>
                  <div class="item-name" style="font-weight: 700; margin-bottom: 0.5rem; color: #EDF2F7; font-size: 1.1rem;">${resource ? resource.name : item.name}</div>
                  <div class="item-description" style="font-size: 0.875rem; color: #A0AEC0; margin-bottom: 0.75rem; line-height: 1.4; min-height: 40px;">${resource ? resource.description : item.description}</div>
                  <div class="item-price" style="font-weight: 700; color: #FBBF24; margin-bottom: 1rem; font-size: 1.1rem; display: flex; align-items: center; gap: 4px;">
                    <span>ğŸ’°</span> ä»·æ ¼: ${item.price} é‡‘æ¡
                  </div>
                  <button class="buy-button" data-item="${item.id}" data-price="${item.price}" ${item.special && resource.amount > 0 ? 'disabled' : ''} style="background-color: ${item.special && resource.amount > 0 ? '#4A5568' : '#805AD5'}; color: white; border: none; border-radius: 0.5rem; padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 600; cursor: ${item.special && resource.amount > 0 ? 'not-allowed' : 'pointer'}; transition: all 0.3s ease; width: 100%;">
                    ${item.special && resource.amount > 0 ? 'å·²è´­ä¹°' : 'è´­ä¹°'}
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      // æ·»åŠ åˆ°æ–‡æ¡£
      document.body.appendChild(shelfModal);
      
      // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶å’Œæ‚¬åœæ•ˆæœ
      const closeButton = document.getElementById('closeShelfButton');
      closeButton.addEventListener('click', function() {
        // æ·»åŠ å…³é—­åŠ¨ç”»
        shelfModal.style.opacity = '0';
        shelfModal.style.transform = 'translate(-50%, -50%) scale(0.95)';
        setTimeout(() => {
          if (shelfModal.parentNode === document.body) {
            document.body.removeChild(shelfModal);
          }
        }, 200);
      });
      
      closeButton.addEventListener('mouseover', function() {
        this.style.backgroundColor = '#718096';
      });
      
      closeButton.addEventListener('mouseout', function() {
        this.style.backgroundColor = '#4A5568';
      });
      
      // æ·»åŠ å•†å“å¡ç‰‡æ‚¬åœæ•ˆæœ
      const shelfItemElements = shelfModal.querySelectorAll('.shelf-item');
      shelfItemElements.forEach(item => {
        item.addEventListener('mouseover', function() {
          this.style.transform = 'translateY(-5px)';
          this.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.25)';
          this.style.borderColor = '#63B3ED';
        });
        
        item.addEventListener('mouseout', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
          this.style.borderColor = '#4A5568';
        });
      });
      
      // æ·»åŠ è´­ä¹°æŒ‰é’®æ‚¬åœæ•ˆæœ
      const buyButtons = shelfModal.querySelectorAll('.buy-button:not(:disabled)');
      buyButtons.forEach(button => {
        button.addEventListener('mouseover', function() {
          this.style.backgroundColor = '#9F7AEA';
          this.style.transform = 'scale(1.05)';
        });
        
        button.addEventListener('mouseout', function() {
          this.style.backgroundColor = '#805AD5';
          this.style.transform = 'scale(1)';
        });
      });
      
      // æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶
      const allBuyButtons = shelfModal.querySelectorAll('.buy-button');
      allBuyButtons.forEach(button => {
        button.addEventListener('click', function() {
          const itemId = this.getAttribute('data-item');
          const price = parseInt(this.getAttribute('data-price'));
          
          // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘æ¡
          if (gameData.resources.gold_bar.amount >= price) {
            // æ¶ˆè€—é‡‘æ¡
            gameData.resources.gold_bar.amount -= price;
            
            // æ·»åŠ å•†å“åˆ°èƒŒåŒ…
            gameData.resources[itemId].amount += 1;
            
            // ç‰¹æ®Šå­¦ä¹ ç‰©å“å·²åœ¨å®šä¹‰ä¸­è®¾ç½®äº†cannotDropå±æ€§ï¼Œç¡®ä¿è´­ä¹°é™åˆ¶æ­£ç¡®åº”ç”¨
            // æ‰€æœ‰ç‰¹æ®Šå­¦ä¹ ç‰©å“åœ¨è´§æ¶ä¸Šåªèƒ½è´­ä¹°ä¸€æ¬¡
            
            // æ›´æ–°é‡‘æ¡æ˜¾ç¤º
            document.getElementById('currentGoldAmount').textContent = gameData.resources.gold_bar.amount;
            
            // æ›´æ–°èƒŒåŒ…UI
            renderResources();
            updateResourceCard('gold_bar');
            
            // æ˜¾ç¤ºè´­ä¹°æˆåŠŸé€šçŸ¥
            showNotification('è´­ä¹°æˆåŠŸ', `ä½ ç”¨${price}å¼ é‡‘æ¡è´­ä¹°äº†${gameData.resources[itemId].name}ï¼`);
            // æ˜¾ç¤ºæ›´é†’ç›®çš„è´­ä¹°æˆåŠŸå¼¹çª—
            showPurchaseResult('è´­ä¹°æˆåŠŸ', `ä½ ç”¨${price}å¼ é‡‘æ¡è´­ä¹°äº†${gameData.resources[itemId].name}ï¼`, true);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯çµè¯ï¼Œå¦‚æœæ˜¯ï¼Œç¡®ä¿æœ‰durabilityå±æ€§
            if (itemId === 'medicine') {
              if (!('durability' in gameData.resources.medicine)) {
                gameData.resources.medicine.durability = 100;
              }
            }
          } else {
            // æ˜¾ç¤ºé‡‘æ¡ä¸è¶³é€šçŸ¥
            showNotification('è´­ä¹°å¤±è´¥', `ä½ æ²¡æœ‰è¶³å¤Ÿçš„é‡‘æ¡ï¼éœ€è¦${price}æ ¹ï¼Œä½ åªæœ‰${gameData.resources.gold_bar.amount}æ ¹ã€‚`);
            // æ˜¾ç¤ºæ›´é†’ç›®çš„è´­ä¹°å¤±è´¥å¼¹çª—
            showPurchaseResult('è´­ä¹°å¤±è´¥', `ä½ æ²¡æœ‰è¶³å¤Ÿçš„é‡‘æ¡ï¼éœ€è¦${price}æ ¹ï¼Œä½ åªæœ‰${gameData.resources.gold_bar.amount}æ ¹ã€‚`, false);
          }
        });
      });
      
      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      shelfModal.addEventListener('click', function(e) {
        if (e.target === shelfModal && shelfModal.parentNode === document.body) {
          document.body.removeChild(shelfModal);
        }
      });
    }
    
    // ä»ç‰¢æˆ¿é‡Šæ”¾
    function releaseFromPrison() {
      // è·å–ç‰¢æˆ¿åœ°ç‚¹
      const prisonLocation = gameData.locations.find(loc => loc.id === 'prison');
      
      if (prisonLocation) {
        prisonLocation.currentLocation = false;
        prisonLocation.available = false;
        
        // å°†ç©å®¶é€å›è¡—è§’
        const streetLocation = gameData.locations.find(loc => loc.id === 'street');
        if (streetLocation) {
          streetLocation.currentLocation = true;
        }
        
        // å‡å°‘å£°æœ›
        gameData.status.reputation -= 20;
        
        // æ·»åŠ "å°å¿ƒä¸€ç‚¹"buffï¼ˆæŒç»­2å¤©ï¼‰
        gameData.buffs.careful = {
          active: true,
          startDay: gameData.day,
          endDay: gameData.day + 2,
          description: 'åˆ‘æ»¡é‡Šæ”¾åçŠ¶æ€ï¼Œå·çªƒæˆåŠŸç‡-20%'
        };
        
        // æ›´æ–°UI
        renderLocations();
        renderActions();
        updateGameData();
        
        // æ˜¾ç¤ºåˆ‘æ»¡é‡Šæ”¾å¼¹çª—
        showReleaseModal();
      }
    }
    
    // æ˜¾ç¤ºåˆ‘æ»¡é‡Šæ”¾å¼¹çª—
    function showReleaseModal() {
      const modal = document.createElement('div');
      modal.className = 'release-modal active';
      modal.innerHTML = `
        <div class="release-modal-content">
          <h2 class="release-modal-title">åˆ‘æ»¡é‡Šæ”¾</h2>
          <p class="release-modal-text">ä½ çš„åˆ‘æœŸå·²æ»¡ï¼Œè¢«é‡Šæ”¾å‡ºç‹±ï¼</p>
          <p class="release-modal-text">ç”±äºä½ çš„çŠ¯ç½ªè®°å½•ï¼Œå£°æœ›é™ä½äº†20ç‚¹ã€‚</p>
          <p class="release-modal-text">å‡ºå»ä¹‹åä¸€å®šè¦å¥½å¥½åšäººï¼è·å¾—"å°å¿ƒä¸€ç‚¹"BUFF</p>
          <div class="release-modal-button" id="closeReleaseModal">ç»§ç»­</div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .release-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 500;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }
        
        .release-modal.active {
          opacity: 1;
          pointer-events: auto;
        }
        
        .release-modal-content {
          background-color: #fff;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          max-width: 400px;
          width: 90%;
          text-align: center;
          background-image: url('UI/ç›‘ç‹±.png');
          background-size: cover;
          background-position: center;
          color: #ff0000;
          font-weight: bold;
        }
        
        .release-modal-title {
          font-size: 24px;
          margin-bottom: 10px;
          color: #ff0000;
          font-weight: bold;
        }
        
        .release-modal-text {
          font-size: 16px;
          margin-bottom: 15px;
          line-height: 1.5;
          color: #ff0000;
          font-weight: bold;
        }
        
        .release-modal-button {
          background-color: #8B0000;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
          margin-top: 10px;
        }
        
        .release-modal-button:hover {
          background-color: #B22222;
        }
      `;
      
      document.head.appendChild(style);
      
      // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
      const closeReleaseModal = document.getElementById('closeReleaseModal');
      if (closeReleaseModal) {
        closeReleaseModal.addEventListener('click', () => {
          modal.classList.remove('active');
          setTimeout(() => {
            if (modal.parentNode === document.body) {
        document.body.removeChild(modal);
      }
      if (style.parentNode === document.head) {
        document.head.removeChild(style);
      }
          }, 300);
        });
      }
    }
    
    // æ£€æŸ¥å¹¶ç§»é™¤è¿‡æœŸçš„buff
    function checkAndRemoveExpiredBuffs() {
      if (!gameData.buffs) return;
      
      for (const [buffId, buff] of Object.entries(gameData.buffs)) {
        if (buff.active && buff.endDay && buff.endDay <= gameData.day) {
          // ç§»é™¤è¿‡æœŸçš„buff
          buff.active = false;
          showNotification('çŠ¶æ€æ¶ˆå¤±', `${buff.description || buffId}æ•ˆæœå·²ç»“æŸã€‚`);
        }
      }
    }
    
    // ç»“æŸå›åˆï¼ˆç°åœ¨æ”¹ä¸ºæ¨è¿›æ—¶é—´ï¼‰
    function endTurn() {
      // æ£€æŸ¥è¿‡æœŸbuff
      checkAndRemoveExpiredBuffs();
      
      // éšæœºè§¦å‘äº‹ä»¶
      if (Math.random() > 0.7) {
        triggerRandomEvent();
      } else {
        advanceTime();
      }
    }

    // æ¸¸æˆç»“æŸ
    function gameOver(message, isVictory = false) {
      // æ— é™æ¨¡å¼ - æ¸¸æˆä¸ä¼šç»“æŸï¼Œåªæ˜¾ç¤ºé€šçŸ¥
      showNotification(isVictory ? 'é‡Œç¨‹ç¢‘è¾¾æˆ' : 'è­¦å‘Š', message);
    }

    // è¿”å›å¼€å§‹ç•Œé¢å¤„ç†å‡½æ•° - å¢å¼ºç‰ˆ
    // æ·»åŠ çŠ¶æ€æ ‡å¿—é˜²æ­¢é‡å¤è°ƒç”¨
    let isReturningToStart = false;
    
    // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ï¼Œæ•è·æœªå¤„ç†çš„å¼‚å¸¸
    window.addEventListener('error', function(event) {
      console.error('æœªæ•è·çš„å…¨å±€é”™è¯¯:', event.error);
      // ç¡®ä¿çŠ¶æ€æ ‡å¿—è¢«é‡ç½®ï¼Œé˜²æ­¢ç•Œé¢å¡ä½
      if (isReturningToStart) {
        isReturningToStart = false;
        console.warn('å·²é‡ç½®è¿”å›å¼€å§‹ç•Œé¢çŠ¶æ€æ ‡å¿—');
      }
    });
    
    function handleBackToStart() {
      // é˜²æ­¢é‡å¤è°ƒç”¨
      if (isReturningToStart) {
        console.warn('è¿”å›å¼€å§‹ç•Œé¢æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
        return;
      }
      
      // ç¡®ä¿documentå’Œbodyå­˜åœ¨ï¼Œé˜²æ­¢åœ¨æç«¯æƒ…å†µä¸‹å‡ºé”™
      if (!document || !document.body) {
        console.error('æ–‡æ¡£å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¿”å›å¼€å§‹ç•Œé¢æ“ä½œ');
        alert('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•è®¿é—®é¡µé¢å…ƒç´ ');
        return;
      }
      
      // åªæœ‰åœ¨ç”¨æˆ·ç¡®è®¤åæ‰æ‰§è¡Œæ“ä½œ
      if(confirm('ç¡®å®šè¦è¿”å›å¼€å§‹ç•Œé¢å—ï¼Ÿå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¼šä¸¢å¤±ã€‚')) {
        isReturningToStart = true;
        console.log('å¼€å§‹è¿”å›å¼€å§‹ç•Œé¢å¤„ç†...');
        
        try {
          // 1. æ¸…ç†æ—§çš„äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
          console.log('æ‰§è¡Œæ¸…ç†æ“ä½œ...');
          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ¸¸æˆå®šæ—¶å™¨å’Œå…¶ä»–å¾ªç¯å¼•ç”¨
          if (window.gameInterval) {
            clearInterval(window.gameInterval);
            window.gameInterval = null;
            console.log('æ¸¸æˆå®šæ—¶å™¨å·²æ¸…é™¤');
          }
          
          // æ¸…ç†å¯èƒ½å­˜åœ¨çš„å…¶ä»–å¾ªç¯å¼•ç”¨
          if (window.gameLoop) {
            if (typeof window.gameLoop === 'function') {
              try {
                window.gameLoop = null;
                console.log('æ¸¸æˆå¾ªç¯å‡½æ•°å·²æ¸…ç†');
              } catch (e) {
                console.warn('æ¸…ç†æ¸¸æˆå¾ªç¯å‡½æ•°å¤±è´¥:', e);
              }
            }
          }
          
          // 2. ç¡®ä¿DOMå…ƒç´ å­˜åœ¨å¹¶æ­£ç¡®å¤„ç†
          console.log('æ£€æŸ¥DOMå…ƒç´ ...');
          let startScreenElement = null;
          let gameContainerElement = null;
          
          try {
            startScreenElement = document.getElementById('startScreen');
            gameContainerElement = document.getElementById('gameContainer');
          } catch (domError) {
            console.error('è·å–DOMå…ƒç´ æ—¶å‡ºé”™:', domError);
          }
          
          // å¼ºåˆ¶æ£€æŸ¥å¹¶å¤„ç†DOMå…ƒç´  - ä¼˜åŒ–ç‰ˆæœ¬
          if (!startScreenElement) {
            console.error('ä¸¥é‡é”™è¯¯: å¼€å§‹ç•Œé¢å…ƒç´ ä¸å­˜åœ¨ï¼åˆ›å»ºä¸´æ—¶å…ƒç´ ');
            try {
              // åˆ›å»ºä¸€ä¸ªæ›´å®Œå–„çš„ä¸´æ—¶å¼€å§‹ç•Œé¢ï¼Œé¿å…å®Œå…¨æ¸…ç©ºbody
              startScreenElement = document.createElement('div');
              startScreenElement.id = 'startScreen';
              startScreenElement.className = 'start-screen';
              startScreenElement.style.display = 'flex';
              startScreenElement.style.position = 'fixed';
              startScreenElement.style.top = '0';
              startScreenElement.style.left = '0';
              startScreenElement.style.width = '100%';
              startScreenElement.style.height = '100%';
              startScreenElement.style.zIndex = '9999';
              startScreenElement.style.backgroundColor = '#f0e6d2';
              startScreenElement.style.color = '#333';
              startScreenElement.style.flexDirection = 'column';
              startScreenElement.style.alignItems = 'center';
              startScreenElement.style.justifyContent = 'center';
              startScreenElement.innerHTML = `
                <div class="start-screen-content" style="text-align: center; padding: 2rem;">
                  <h1 class="start-screen-title ink-text" style="font-size: 2.5em; margin-bottom: 20px;">ä¹ä¸æ±‚ç”Ÿ</h1>
                  <p class="start-screen-subtitle" style="font-size: 1.2em; margin-bottom: 30px;">æ°´å¢¨ç”»é£æ ¼çš„å¡ç‰Œç”Ÿå­˜æ¸¸æˆ</p>
                  <p class="start-screen-description" style="max-width: 600px; margin-bottom: 30px;">
                    åœ¨è¿™ä¸ªæ®‹é…·çš„å¤ä»£ä¸–ç•Œä¸­ï¼Œä½ æ‰®æ¼”ä¸€åä¹ä¸ï¼ŒæŒ£æ‰æ±‚ç”Ÿã€‚é€šè¿‡æ”¶é›†èµ„æºã€åˆ¶ä½œå·¥å…·ã€æ¢ç´¢åœ°ç‚¹å’Œåº”å¯¹äº‹ä»¶ï¼ŒåŠªåŠ›æ´»ä¸‹å»å¹¶å¯»æ‰¾æ”¹å˜å‘½è¿çš„æœºä¼šã€‚
                  </p>
                  <button id="startButton" class="start-screen-button" style="padding: 10px 30px; font-size: 1.2em; background: #8B4513; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    å¼€å§‹æ¸¸æˆ
                  </button>
                </div>
              `;
              
              // æ·»åŠ åˆ°bodyè€Œä¸æ˜¯æ¸…ç©ºbody
              document.body.appendChild(startScreenElement);
              console.log('ä¸´æ—¶å¼€å§‹ç•Œé¢å·²åˆ›å»º');
            } catch (createError) {
              console.error('åˆ›å»ºä¸´æ—¶å¼€å§‹ç•Œé¢å¤±è´¥:', createError);
              // å³ä½¿åˆ›å»ºå¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œå°è¯•å…¶ä»–æ¢å¤æ–¹æ³•
            }
          } else {
            // æ˜¾ç¤ºå¼€å§‹ç•Œé¢å¹¶éšè—æ¸¸æˆå®¹å™¨
            try {
              startScreenElement.style.display = 'flex';
              console.log('å¼€å§‹ç•Œé¢æ˜¾ç¤ºæˆåŠŸ');
            } catch (styleError) {
              console.error('è®¾ç½®å¼€å§‹ç•Œé¢æ ·å¼å¤±è´¥:', styleError);
            }
          }
          
          if (gameContainerElement) {
            try {
              gameContainerElement.style.display = 'none';
              console.log('æ¸¸æˆå®¹å™¨éšè—æˆåŠŸ');
            } catch (styleError) {
              console.error('è®¾ç½®æ¸¸æˆå®¹å™¨æ ·å¼å¤±è´¥:', styleError);
            }
          } else {
            console.warn('æ¸¸æˆå®¹å™¨å…ƒç´ æœªæ‰¾åˆ°ï¼Œå¯èƒ½å·²éšè—');
          }
          
          // 3. å®Œæ•´é‡ç½®æ¸¸æˆæ•°æ®
          try {
            console.log('é‡ç½®æ¸¸æˆæ•°æ®...');
            // å°è¯•é‡æ–°åˆå§‹åŒ–gameData
            if (typeof resetGame === 'function') {
              try {
                console.log('è°ƒç”¨resetGameå‡½æ•°é‡ç½®æ¸¸æˆ');
                resetGame();
              } catch (resetFuncError) {
                console.error('è°ƒç”¨resetGameå‡½æ•°å¤±è´¥:', resetFuncError);
                // é‡ç½®å¤±è´¥æ—¶è¿›è¡Œæ‰‹åŠ¨é‡ç½®
                performManualGameReset();
              }
            } else {
              console.log('resetGameå‡½æ•°ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨é‡ç½®åŸºæœ¬æ•°æ®');
              performManualGameReset();
            }
            
            // å°è¯•è°ƒç”¨initGameé‡æ–°åˆå§‹åŒ–
            if (typeof initGame === 'function') {
              console.log('å°è¯•è°ƒç”¨initGameå‡½æ•°é‡æ–°åˆå§‹åŒ–æ¸¸æˆ');
              try {
                initGame();
              } catch(initError) {
                console.warn('initGameè°ƒç”¨å¤±è´¥ï¼Œä½†ä¸å½±å“è¿”å›å¼€å§‹ç•Œé¢:', initError);
              }
            }
          } catch(resetError) {
            console.error('é‡ç½®æ¸¸æˆæ•°æ®æ—¶å‡ºé”™:', resetError);
          }
          
          // 4. æ·»åŠ å¼€å§‹æ¸¸æˆå‡½æ•°çš„æ›¿ä»£å®ç°
          // å¦‚æœstartGameå‡½æ•°ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ
          if (typeof window.startGame !== 'function') {
            console.log('åˆ›å»ºä¸´æ—¶çš„startGameå‡½æ•°æ›¿ä»£å®ç°');
            window.startGame = function() {
              console.log('ä¸´æ—¶startGameå‡½æ•°è¢«è°ƒç”¨');
              try {
                // éšè—å¼€å§‹ç•Œé¢
                const startScreen = document.getElementById('startScreen');
                if (startScreen) {
                  startScreen.style.display = 'none';
                }
                
                // æ˜¾ç¤ºæ¸¸æˆå®¹å™¨
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                  gameContainer.style.display = 'block';
                } else {
                  console.error('æ¸¸æˆå®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
                  alert('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥ï¼šæœªæ‰¾åˆ°æ¸¸æˆå®¹å™¨');
                  return;
                }
                
                // å°è¯•é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                if (typeof resetGame === 'function') {
                  try {
                    resetGame();
                  } catch (e) {
                    console.error('é‡ç½®æ¸¸æˆå¤±è´¥:', e);
                    performManualGameReset();
                  }
                } else {
                  performManualGameReset();
                }
                
                if (typeof initGame === 'function') {
                  try {
                    initGame();
                  } catch (e) {
                    console.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥:', e);
                    // å°è¯•åŸºæœ¬æ˜¾ç¤ºé€»è¾‘
                    performBasicGameRender();
                  }
                } else {
                  console.warn('initGameå‡½æ•°ä¸å­˜åœ¨ï¼Œæ¸¸æˆå¯èƒ½æ— æ³•æ­£å¸¸è¿è¡Œ');
                  performBasicGameRender();
                }
              } catch (error) {
                console.error('æ¸¸æˆå¯åŠ¨è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                alert('æ¸¸æˆå¯åŠ¨å¤±è´¥ï¼š' + error.message);
              }
            };
          }
          
          // 5. é‡æ–°ç»‘å®šå¼€å§‹æ¸¸æˆäº‹ä»¶
          setTimeout(() => {
            try {
              // ç¡®ä¿startScreenElementä»ç„¶å­˜åœ¨
              if (!startScreenElement) {
                startScreenElement = document.getElementById('startScreen');
              }
              
              if (startScreenElement) {
                const startGameButton = document.querySelector('#startScreen button, #startButton');
                if (startGameButton) {
                  // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                  const newButton = startGameButton.cloneNode(true);
                  startGameButton.parentNode.replaceChild(newButton, startGameButton);
                  
                  // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œç›´æ¥è°ƒç”¨window.startGameï¼ˆæˆ‘ä»¬åˆšåˆšç¡®ä¿å®ƒå­˜åœ¨ï¼‰
                  newButton.onclick = function() {
                    console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»');
                    // å†æ¬¡ç¡®è®¤startGameå‡½æ•°å­˜åœ¨
                    if (typeof window.startGame === 'function') {
                      window.startGame();
                    } else {
                      console.error('ä¸¥é‡é”™è¯¯ï¼šstartGameå‡½æ•°ä¸å­˜åœ¨');
                      alert('æ¸¸æˆåŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    }
                  };
                  console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®äº‹ä»¶å·²é‡æ–°ç»‘å®š');
                } else {
                  console.warn('æœªæ‰¾åˆ°å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼Œåˆ›å»ºä¸€ä¸ª');
                  try {
                    const button = document.createElement('button');
                    button.textContent = 'å¼€å§‹æ¸¸æˆ';
                    button.style.padding = '10px 20px';
                    button.onclick = function() {
                      if (typeof window.startGame === 'function') {
                        window.startGame();
                      } else {
                        alert('æ¸¸æˆåŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢');
                      }
                    };
                    startScreenElement.appendChild(button);
                  } catch (createButtonError) {
                    console.error('åˆ›å»ºå¼€å§‹æ¸¸æˆæŒ‰é’®å¤±è´¥:', createButtonError);
                  }
                }
              } else {
                console.error('å¼€å§‹ç•Œé¢å…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');
              }
            } catch(bindError) {
              console.error('ç»‘å®šå¼€å§‹æ¸¸æˆäº‹ä»¶å¤±è´¥:', bindError);
            } finally {
              // æ“ä½œå®Œæˆï¼Œé‡ç½®çŠ¶æ€æ ‡å¿—
              isReturningToStart = false;
              console.log('è¿”å›å¼€å§‹ç•Œé¢å¤„ç†å®Œæˆï¼ŒçŠ¶æ€æ ‡å¿—å·²é‡ç½®');
            }
          }, 300);
          
        } catch(error) {
          console.error('è¿”å›å¼€å§‹ç•Œé¢è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯:', error);
          // ç¡®ä¿çŠ¶æ€æ ‡å¿—è¢«é‡ç½®
          isReturningToStart = false;
          
          // æ˜¾ç¤ºä¸€ä¸ªåŸºæœ¬çš„æ¢å¤ç•Œé¢ï¼Œä½†ä¸ä½¿ç”¨innerHTMLè¦†ç›–æ•´ä¸ªbody
          try {
            const recoveryDiv = document.createElement('div');
            recoveryDiv.style.position = 'fixed';
            recoveryDiv.style.top = '0';
            recoveryDiv.style.left = '0';
            recoveryDiv.style.width = '100%';
            recoveryDiv.style.height = '100%';
            recoveryDiv.style.backgroundColor = '#f0e6d2';
            recoveryDiv.style.color = '#333';
            recoveryDiv.style.textAlign = 'center';
            recoveryDiv.style.padding = '50px';
            recoveryDiv.style.zIndex = '99999';
            recoveryDiv.style.boxSizing = 'border-box';
            recoveryDiv.innerHTML = '<h1>å‡ºç°é—®é¢˜</h1>' +
              '<p>è¿”å›å¼€å§‹ç•Œé¢æ—¶å‡ºé”™: ' + (error.message || 'æœªçŸ¥é”™è¯¯') + '</p>' +
              '<button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">åˆ·æ–°é¡µé¢é‡è¯•</button>';
            document.body.appendChild(recoveryDiv);
          } catch (recoveryError) {
            console.error('åˆ›å»ºæ¢å¤ç•Œé¢å¤±è´¥:', recoveryError);
            // æœ€åæ‰‹æ®µï¼šå°è¯•ä½¿ç”¨alerté€šçŸ¥ç”¨æˆ·
            alert('ä¸¥é‡é”™è¯¯ï¼šæ— æ³•æ˜¾ç¤ºæ¢å¤ç•Œé¢ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢');
          }
        }
      }
      // ç‚¹å‡»å–æ¶ˆæ—¶ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›
      console.log('ç”¨æˆ·å–æ¶ˆè¿”å›å¼€å§‹ç•Œé¢æ“ä½œ');
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šæ‰‹åŠ¨é‡ç½®æ¸¸æˆæ•°æ®
    function performManualGameReset() {
      try {
        // ç¡®ä¿windowå¯¹è±¡å­˜åœ¨
        if (!window) {
          console.error('windowå¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•é‡ç½®æ¸¸æˆæ•°æ®');
          return;
        }
        
        // ç¡®ä¿gameDataå­˜åœ¨å¹¶å®Œå…¨é‡ç½®
        window.gameData = {
          day: 1,
          timeOfDay: 'early_morning',
          timeTurns: 0,
          season: 'spring',
          status: {
            hunger: 50,
            cold: 60,
            health: 80,
            spirit: 70,
            reputation: 20
          },
          discoveredRecipes: [],
          combinationSlots: {
            1: null,
            2: null
          },
          stats: {},
          gameOver: false,
          resources: {}
        };
        console.log('æ¸¸æˆæ•°æ®å·²æ‰‹åŠ¨é‡ç½®');
      } catch (e) {
        console.error('æ‰‹åŠ¨é‡ç½®æ¸¸æˆæ•°æ®å¤±è´¥:', e);
      }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šæ‰§è¡ŒåŸºæœ¬çš„æ¸¸æˆæ¸²æŸ“
    function performBasicGameRender() {
      try {
        // å°è¯•è°ƒç”¨å¯èƒ½å­˜åœ¨çš„æ¸²æŸ“å‡½æ•°
        const renderFunctions = [
          { name: 'renderResources', func: renderResources },
          { name: 'renderLocations', func: renderLocations },
          { name: 'renderActions', func: renderActions },
          { name: 'updateGameData', func: updateGameData },
          { name: 'updateStatusDisplay', func: updateStatusDisplay }
        ];
        
        renderFunctions.forEach(({ name, func }) => {
          if (typeof func === 'function') {
            try {
              func();
              console.log(`æˆåŠŸè°ƒç”¨${name}å‡½æ•°`);
            } catch (e) {
              console.warn(`è°ƒç”¨${name}å‡½æ•°å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•å…¶ä»–æ¸²æŸ“å‡½æ•°:`, e);
            }
          }
        });
      } catch (e) {
        console.error('æ‰§è¡ŒåŸºæœ¬æ¸¸æˆæ¸²æŸ“å¤±è´¥:', e);
      }
    }

    // é‡ç½®æ¸¸æˆ
    function resetGame() {
      gameData.day = 1;
      gameData.timeOfDay = 'early_morning';
      gameData.timeTurns = 0;
      gameData.season = 'spring';
      gameData.resources = {
        'food': { name: 'é£Ÿç‰©', amount: 3, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/f4c7301991ab401283b4e2cc2d24356a~tplv-a9rns2rl98-image.image?rcl=2025112713573750E6BFCA1E0AE0134FF3&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1766815097&x-signature=mIgvuq5g4eSEfvQyoQS%2FV3qaGK4%3D' },
        'money': { name: 'é’±å¸', amount: 2, image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/a97938c414534765acab687a6f1d646d.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=20251129205037E8610DA7543A51DB8281&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765025437&x-signature=%2B6qCylajyUoWz1DvUjy8lktowfk%3D' },
        'cloth': { name: 'ç ´å¸ƒ', amount: 5, image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/f7c4f2cee91e416d8ab8a628d7000d79.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=20251129205037E8610DA7543A51DB8281&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765025437&x-signature=XPQph6P99%2BZwrztNHBIJcjxsOAU%3D' },
        'stick': { name: 'æœ¨æ£', amount: 4, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/f29290bc8c9140ea9065db8b3133d231.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=202511292132282661D8856AC003F2E823&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765027948&x-signature=AN6DZ0tbJLmZN7p2UCol%2FiWoXiU%3D' },
        'paper': { name: 'åºŸçº¸', amount: 3, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/2542a276bd27446f9e1a0f55d015fd4f.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=202511292132282661D8856AC003F2E823&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765027948&x-signature=hHFsfBXhWSuvwrClyWl7ra%2F7hdE%3D' },
        'bowl': { name: 'ç ´ç¢—', amount: 1, image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/149074d273dd42c0aa7b766a7864eed7.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=20251129205037E8610DA7543A51DB8281&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765025437&x-signature=D4WFsJ4%2B6SrdPdxMdZqs6k8Sdtw%3D' },
        'medicine': { name: 'çµè¯', description: 'çè´µçš„è‰è¯ï¼Œèƒ½æ¢å¤å¤§é‡å¥åº·', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/b69aa2cff4e740598fbac832b4965253.png~tplv-a9rns2rl98-24:720:720.image?rcl=202511292132282661D8856AC003F2E823&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765027948&x-signature=ceGG%2F6lvBQ4Wg412pdZVzpZVYVM%3D', type: 'consumable' },
          'house_deed': { name: 'æˆ¿å±‹åœ°å¥‘', description: 'æ‹¥æœ‰ä¸€å¤„æˆ¿äº§çš„è¯æ˜ï¼Œæå‡å£°æœ›å’Œç²¾ç¥çŠ¶æ€', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/81afdefeb9cf4074866a9aa90480e0d2~tplv-a9rns2rl98-image.image?rcl=202511301135088D5B8BF748021234F67A&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066061&x-signature=ZleciQAWJduJDmoMCvvxh8WAXvY%3D', durability: 100, category: 'other' },
          'fine_clothes': { name: 'ç²¾ç¾åæœ', description: 'é«˜æ¡£çš„ä¸ç»¸æœè£…ï¼Œå¤§å¹…æå‡å£°æœ›å’Œä¿æš–åº¦', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/499ce791f4244a349da0e5c07f411759~tplv-a9rns2rl98-image.image?rcl=202511301135088D5B8BF748021234F67A&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066106&x-signature=z%2B8F%2FTbaRrwSGNsYYOV%2BlbvS6fg%3D', equipmentSlot: 'clothes', durability: 100 },
          'silk_shoes': { name: 'ç¼é‹', description: 'ç²¾è‡´çš„ä¸ç¼é‹å­ï¼Œæå‡å¥åº·åº¦å’Œä¿æš–åº¦', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/519a359bc40d446e96b3722912eefe22~tplv-a9rns2rl98-image.image?rcl=202511301135088D5B8BF748021234F67A&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066159&x-signature=SJ1pIyIHM0i1yDTw7EIxobHTtcQ%3D', equipmentSlot: 'shoes', durability: 100 },
          'dog_beating_stick': { name: 'æ‰“ç‹—æ£’æ³•', description: 'ä¸å¸®é•‡å¸®ä¹‹å®ï¼Œæå‡å¥åº·åº¦å’Œå£°æœ›', amount: 0, image: 'https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/2aeab037759047558970b6bc106eede9~tplv-a9rns2rl98-image.image?rcl=202511301135088D5B8BF748021234F67A&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066205&x-signature=BNT0ywPKQJpHRlBhgOCs9xy8e5o%3D', equipmentSlot: 'weapon', durability: 100, category: 'other' },
          'herbal_manual': { name: 'æœ¬è‰çº²ç›®', description: 'å¤ä»£åŒ»å­¦åè‘—ï¼Œæå‡å¥åº·åº¦å’Œç²¾ç¥çŠ¶æ€', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/bb3a2dfed0b84e9288f44ee641206c34~tplv-a9rns2rl98-image.image?rcl=202511301135088D5B8BF748021234F67A&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066242&x-signature=ZBm9LjKtRzHuE%2BiRoEsiCMZiB3E%3D', durability: 100, category: 'other' },
          'huangdi_canon': { name: 'é»„å¸å†…ç»', description: 'ä¸­åŒ»ç»å…¸è‘—ä½œï¼Œå¤§å¹…æå‡å¥åº·åº¦', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/7ad31567d30840acbeee917f1438e245~tplv-a9rns2rl98-image.image?rcl=202511301135088D5B8BF748021234F67A&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066281&x-signature=NfgvxgoCAXLkr2%2BOOn8xg2qiepc%3D', durability: 100, category: 'other' },
          'stealth_book': { name: 'å·å¤©æ¢æ—¥', description: 'ç›—çªƒæŠ€å·§ç§˜ç±ï¼Œæé«˜å·çªƒæˆåŠŸç‡', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/1e3f6a2c0b224112ba52173aef3cc2d8~tplv-a9rns2rl98-image.image?rcl=202511301135088D5B8BF748021234F67A&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066329&x-signature=sfh6T8o1olSVItjRzPWM1nE%2FDlE%3D', durability: 100, category: 'other' },
          'house_deed': { name: 'æˆ¿å±‹åœ°å¥‘', description: 'æ‹¥æœ‰è‡ªå·±çš„æˆ¿äº§ï¼Œæé«˜å£°æœ›å’Œç²¾ç¥çŠ¶æ€', amount: 0, image: 'https://p11-doubao-search-sign.byteimg.com/labis/d36b4767c04891c63b2fe5277e5aa0f7~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1780026189&x-signature=4W8MuoilO4yqwb10Q7r6JN9wOwo%3D', equipmentSlot: 'special', category: 'other' },
          'fine_clothes': { name: 'ç²¾ç¾åæœ', description: 'åä¸½çš„æœè£…ï¼Œå¤§å¹…æé«˜å£°æœ›å’Œä¿æš–åº¦', amount: 0, image: 'https://p11-doubao-search-sign.byteimg.com/ecom-shop-material/jpeg_m_a16025c6cf5fed6a5a1f389b30dee776_sx_531572_www640-640~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1780026149&x-signature=mpksRQoT3DGUtg%2BCWvX2ld6zvU8%3D', equipmentSlot: 'clothes' },
          'silk_shoes': { name: 'ç¼é‹', description: 'ç²¾è‡´çš„ç¼é¢é‹å­ï¼Œæé«˜å£°æœ›å’Œå¥åº·', amount: 0, image: 'https://p3-doubao-search-sign.byteimg.com/labis/fe9ac09f236960a63d6d1b98510ef90f~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1780026189&x-signature=PvMOwB%2FIizAA%2Fw89Jw8N8iV8bJw%3D', equipmentSlot: 'shoes' },
          'dog_beating_stick': { name: 'æ‰“ç‹—æ£’æ³•', description: 'ä¸å¸®ç»æŠ€ï¼Œæé«˜æˆ˜æ–—åŠ›å’Œå£°æœ›', amount: 0, image: 'https://p26-doubao-search-sign.byteimg.com/labis/6f890dd822f2837539fed09ff7273b07~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1780026239&x-signature=BiQ6x3i%2FfP1hzPJ5XEaNhivQq08%3D', equipmentSlot: 'weapon', category: 'other' },
          'herbal_medicine_book': { name: 'æœ¬è‰çº²ç›®', description: 'åŒ»å­¦ç»å…¸ï¼Œæé«˜å¥åº·æ¢å¤é€Ÿåº¦', amount: 0, image: 'https://p3-doubao-search-sign.byteimg.com/labis/cbf85a6536ec3a2b6490dd8adc483064~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1780026189&x-signature=chZXRJzKvzCNOVOhgwEcNBfwIFU%3D', equipmentSlot: 'special', category: 'other' },
          'huangdi_neijing': { name: 'é»„å¸å†…ç»', description: 'åŒ»å­¦ç»å…¸ï¼Œå¤§å¹…æé«˜å¥åº·ä¸Šé™', amount: 0, image: 'https://p26-doubao-search-sign.byteimg.com/ecom-shop-material/mQZXiUA_m_e50a37f3765b1af266dfa742b2d45999_sx_82512_www800-800~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1780026189&x-signature=2894xPwUF2h7f6lma%2BU%2FZg1XCjg%3D', equipmentSlot: 'special', category: 'other' },
          'stealth_book': { name: 'å·å¤©æ¢æ—¥', description: 'ç›—çªƒæŠ€å·§ï¼Œæé«˜å·çªƒæˆåŠŸç‡', amount: 0, image: 'https://p26-doubao-search-sign.byteimg.com/tos-cn-i-xv4ileqgde/1853b1f2552e4b1aa6331d345e177bd8~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1780026239&x-signature=ZCpgtxe1PhyixP6iFruNlaYpEFs%3D', equipmentSlot: 'special' },
        
        'simple_clothes': { name: 'ç ´è¡£æœ', amount: 0, image: 'https://p11-doubao-search-sign.byteimg.com/labis/05dd1661880e84d851a3eddf46e5ab2a~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779797953&x-signature=J6qsqV8dChplYTRgL3Rw5GWkqLk%3D', equipmentSlot: 'clothes' },
        'flint': { name: 'ç‡§çŸ³', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/95aa9c2aec5b4178b8791a733761ba97.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=202511292132282661D8856AC003F2E823&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765027948&x-signature=ru5fDrQxjdJ38AnnhJOJ3Qvq8p0%3D' },
        'mud': { name: 'æ³¥å·´', amount: 0, image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/ea48fcaba9d94fb19938e8c03b0303f6.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=20251129205037E8610DA7543A51DB8281&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765025437&x-signature=jcdtFDBSfpM4iZLNxXecYJeZF7U%3D' },
        'fire': { name: 'ç¯ç«', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/0b4a538181e345018d8f0c9b9068804e.png~tplv-a9rns2rl98-24:720:720.png?rcl=202511300854180D9F280600AFF2D54ED4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765068859&x-signature=nFSyyffwTdx8eSALNVNOiu5%2B%2Bo4%3D', durability: 100 },
        'clay_bowl': { name: 'æ³¥ç¢—', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/f8c6ad6c7611425eaf5803896468ae1f.png~tplv-a9rns2rl98-24:720:720.image?rcl=202511292132282661D8856AC003F2E823&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765027948&x-signature=soUOX%2BDUuS2OunIbRA%2F2d5a6Hoo%3D' },
        'crutch': { name: 'æ‹æ–', amount: 0, image: 'UI/æ‹æ–.jpg', equipmentSlot: 'weapon' },
        'gold_bar': { name: 'é‡‘æ¡', amount: 0, image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/fa14f32de0f14a1885b67e18935e4b19.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=20251129205037E8610DA7543A51DB8281&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765025437&x-signature=zS8LKz0g61epwG9LFt8%2BEvbFrgA%3D' },
        'black_cloth': { name: 'é»‘å¸ƒ', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/d8141656a7b34ec583d0218ae3e2ef3c.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=202511292132282661D8856AC003F2E823&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765027948&x-signature=UO1Z9h8jkInoUc4twKgQguRgcHY%3D' },
        'hide': { name: 'å…½çš®', description: 'åŠ¨ç‰©çš„çš®æ¯›ï¼Œå¯ä»¥ç”¨æ¥åˆ¶ä½œä¿æš–è¡£ç‰©å’Œå®¹å™¨', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/23b2da9439cb4906bb1b7ace8614e502.png~tplv-a9rns2rl98-24:720:720.png?rcl=202511300854180D9F280600AFF2D54ED4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765068859&x-signature=tWHQ01u7WfnhYfcqqsZYnRpFhUA%3D' },
        'thread': { name: 'çº¿å›¢', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/211cc03732aa44a8828108d38b1d61f4.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=202511292132282661D8856AC003F2E823&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765027948&x-signature=n456QRjuPs7Z2p8IB%2Bqw3FBAhOI%3D' },
        'water_bag': { name: 'æ°´è¢‹ï¼ˆæ»¡ï¼‰', description: 'å¯ä»¥å‚¨å­˜æ°´åˆ†ï¼Œå‡å°‘å£æ¸´å¸¦æ¥çš„è´Ÿé¢å½±å“', amount: 0, image: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/1672d267bd0040e5a9f2e239f987199b.png~tplv-a9rns2rl98-24:720:720.png?rcl=202511300854180D9F280600AFF2D54ED4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765068859&x-signature=fU6RBbt6lZUl7H6Cn%2FIOpXm%2BUDI%3D', durability: 100 },
        'empty_water_bag': { name: 'æ°´è¢‹ï¼ˆç©ºï¼‰', description: 'ç©ºçš„æ°´è¢‹ï¼Œéœ€è¦å¯»æ‰¾æ°´æºæ¥è£…æ»¡å®ƒ', amount: 0, image: 'UI/æ°´è¢‹ï¼ˆç©ºï¼‰.jpg', durability: 100 },
        'black_cloak': { name: 'é»‘è‰²æ–—ç¯·', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/b18019591c1648a692981aaf880a32c6~tplv-a9rns2rl98-image.image?rcl=2025112713573750E6BFCA1E0AE0134FF3&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1766815092&x-signature=UzZghS8vYxRjp1eeDG1KU5PfY4Y%3D', equipmentSlot: 'special' },
        'slave': { name: 'å¥´éš¶', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/f07095c0845f45eb8418958180ca3e77~tplv-a9rns2rl98-image.image?rcl=2025112713573750E6BFCA1E0AE0134FF3&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1766815101&x-signature=dENyJs1JB5ZSEtSIkWe9oq4a8us%3D' },
        'shoes': { name: 'ç ´é‹', description: 'ç ´æ—§çš„é‹å­ï¼Œæä¾›åŸºæœ¬çš„è„šéƒ¨ä¿æŠ¤', amount: 0, image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/d9d29cdf47cb43e7a99a33378e91189a.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=20251129205037E8610DA7543A51DB8281&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765025437&x-signature=6SuTfu1JBvlUo4IZlVIZ7M%2BghhQ%3D', equipmentSlot: 'shoes', durability: 100 },
        'cornbread': { name: 'çªçªå¤´', description: 'ç²—ç³™çš„è°·ç‰©åˆ¶å“ï¼Œèƒ½æä¾›è¾ƒå¥½çš„é¥±è…¹æ„Ÿ', amount: 0, image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/3455faf8845c4a5185508d54822b3f07.jpg~tplv-a9rns2rl98-24:720:720.image?rcl=20251129205037E8610DA7543A51DB8281&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1765025437&x-signature=c4Hn%2BaHveLGPL%2FZKpCkx8AzwON0%3D', type: 'consumable' },
          'land_deed': { name: 'æˆ¿å±‹åœ°å¥‘', description: 'æ‹¥æœ‰æˆ¿äº§çš„è¯æ˜ï¼Œå¯å¤§å¹…æå‡å£°æœ›', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/aa666fbdcce24f31aec0456144be38ab~tplv-a9rns2rl98-image.image?rcl=2025113011361694EBD2F60C8F34FE2A69&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066166&x-signature=A%2BFXA7SQ4Fpeqpx82HZ5x59K%2BKM%3D' },
          'fine_clothes': { name: 'ç²¾ç¾åæœ', description: 'åä¸½çš„æœé¥°ï¼Œæå‡å£°æœ›å’Œä¿æš–åº¦', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/7b6ee860c8914308aa179f2695a7601d~tplv-a9rns2rl98-image.image?rcl=2025113011361694EBD2F60C8F34FE2A69&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066164&x-signature=9pPgoLabRa2gxNV8kWhwCVKIOQI%3D', equipmentSlot: 'clothes', durability: 100 },
          'silk_shoes': { name: 'ç¼é‹', description: 'ç²¾è‡´çš„ç¼é¢é‹å­ï¼Œæå‡å¥åº·å’Œä¿æš–åº¦', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/8114bb57cedc411eb5f0b5a9975b4c9f~tplv-a9rns2rl98-image.image?rcl=2025113011361694EBD2F60C8F34FE2A69&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066164&x-signature=Q66eP%2BSs4LiXfBLVBINEf%2BrvXT0%3D', equipmentSlot: 'shoes', durability: 100 },
          'dog_beating_stick': { name: 'æ‰“ç‹—æ£’æ³•', description: 'ä¸å¸®é•‡å¸®ä¹‹å®ï¼Œæå‡å£°æœ›å’Œå¥åº·', amount: 0, image: 'https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/7ec1b3e80fb24aeab14441e698b74b37~tplv-a9rns2rl98-image.image?rcl=2025113011361694EBD2F60C8F34FE2A69&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066167&x-signature=LESWV5HGStyN0kAki7i7R7pUjDA%3D', equipmentSlot: 'weapon', durability: 100 },
          'herbal_canon': { name: 'æœ¬è‰çº²ç›®', description: 'å¤ä»£åŒ»å­¦ç»å…¸ï¼Œæå‡å¥åº·å’Œç²¾ç¥', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/82b6ab38d6ef419292e938a97c35ef8c~tplv-a9rns2rl98-image.image?rcl=2025113011361694EBD2F60C8F34FE2A69&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066164&x-signature=adRGAC8Fjj3Jdq6zvR1%2Bjuh8sBg%3D' },
          'huangdi_canon': { name: 'é»„å¸å†…ç»', description: 'ä¸­åŒ»ç»å…¸è‘—ä½œï¼Œå¤§å¹…æå‡å¥åº·å’Œç²¾ç¥', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/905aa9e0f773498f91b2be7b803d3f0e~tplv-a9rns2rl98-image.image?rcl=2025113011361694EBD2F60C8F34FE2A69&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066167&x-signature=VLLEJ5wpQrWNkSP%2Bw6Ac3Mvcz5A%3D' },
          'day_stealing': { name: 'å·å¤©æ¢æ—¥', description: 'ç¥ç§˜çš„ç›—çªƒæŠ€å·§ç§˜ç±ï¼Œæå‡å·çªƒæˆåŠŸç‡', amount: 0, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/007a2870a64d49e9b759720409e3f915~tplv-a9rns2rl98-image.image?rcl=2025113011361694EBD2F60C8F34FE2A69&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767066215&x-signature=kLjMdV6hFaucqGaKyzmsD98IA5A%3D' },
      };
      gameData.status = {
        hunger: 50,
        cold: 60,
        health: 80,
        spirit: 70,
        reputation: 20,
        strength: 50,
        isSick: false
      };
      gameData.discoveredRecipes = [];
      gameData.combinationSlots = {
        1: null,
        2: null,
        3: null
      };
      gameData.stats = {
        daysSurvived: 0,
        maxReputation: 0,
        resourcesCollected: 0,
        recipesDiscovered: 0
      };
      gameData.gameOver = false;
      
      // æ¸…ç©ºç»„åˆæ§½
      updateCombinationSlots();
      
      // æ›´æ–°UI
      initGame();
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(title, message, isCentral = false, manualCloseOnly = false) {
      // åªæ˜¾ç¤ºä¸­å¤®é€šçŸ¥ï¼Œéä¸­å¤®é€šçŸ¥ä¸æ˜¾ç¤º
      if (!isCentral) {
        return;
      }
      
      elements.notificationTitle.textContent = title;
      elements.notificationMessage.textContent = message;
      
      // æ¸…é™¤ä¹‹å‰çš„ç±»å’Œäº‹ä»¶ç›‘å¬å™¨
      elements.notification.classList.remove('active', 'central');
      
      // æ ¹æ®isCentralå‚æ•°å†³å®šæ˜¯å¦ä½¿ç”¨ä¸­å¤®æ˜¾ç¤º
      if (isCentral) {
        elements.notification.classList.add('central');
      }
      
      // æ˜¾ç¤ºé€šçŸ¥ - ä½¿ç”¨activeç±»æ¥è§¦å‘CSSåŠ¨ç”»
      elements.notification.classList.add('active');
      
      // ç‚¹å‡»"çŸ¥é“äº†"æŒ‰é’®å…³é—­
      function closeNotification() {
        elements.notification.classList.remove('active', 'central');
      }
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      elements.closeNotificationButton.addEventListener('click', closeNotification);
      elements.notificationOKButton.addEventListener('click', closeNotification);
      
      // å¦‚æœä¸æ˜¯æ‰‹åŠ¨å…³é—­æ¨¡å¼ï¼Œæ·»åŠ è‡ªåŠ¨å…³é—­å’Œç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
      if (!manualCloseOnly) {
        // ç‚¹å‡»é€šçŸ¥å¤–éƒ¨åŒºåŸŸå…³é—­
        document.addEventListener('click', function(e) {
          if (e.target === elements.notification) {
            closeNotification();
          }
        });
        
        // 3ç§’åè‡ªåŠ¨å…³é—­
        setTimeout(() => {
          elements.notification.classList.remove('active', 'central');
        }, 3000);
      }
    }
    
    // å·²åˆ é™¤æ—¶é—´æç¤ºå‡½æ•°
    
    // æ˜¾ç¤ºè´­ä¹°ç»“æœå¼¹çª—
    function showPurchaseResult(title, message, isSuccess) {
      // åˆ›å»ºæ¨¡æ€æ¡†
      const purchaseModal = document.createElement('div');
      purchaseModal.className = 'purchase-result-modal';
      purchaseModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1500;
        animation: fadeIn 0.3s ease;
      `;
      
      // å¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'purchase-result-content';
      modalContent.style.cssText = `
        background-color: ${isSuccess ? '#1A202C' : '#2D3748'};
        border: 2px solid ${isSuccess ? '#38A169' : '#E53E3E'};
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease;
        background-image: linear-gradient(135deg, ${isSuccess ? '#1A202C 0%, #2D3748 100%' : '#2D3748 0%, #1A202C 100%'});
      `;
      
      // æ ‡é¢˜
      const modalTitle = document.createElement('h3');
      modalTitle.className = 'purchase-result-title';
      modalTitle.style.cssText = `
        font-size: 1.5rem;
        font-weight: 700;
        color: ${isSuccess ? '#38A169' : '#E53E3E'};
        margin-bottom: 1rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      `;
      modalTitle.textContent = title;
      
      // æ¶ˆæ¯
      const modalMessage = document.createElement('p');
      modalMessage.className = 'purchase-result-message';
      modalMessage.style.cssText = `
        font-size: 1.1rem;
        color: #EDF2F7;
        margin-bottom: 1.5rem;
        line-height: 1.6;
      `;
      modalMessage.textContent = message;
      
      // å›¾æ ‡
      const iconContainer = document.createElement('div');
      iconContainer.style.cssText = `
        font-size: 3rem;
        margin-bottom: 1rem;
      `;
      iconContainer.textContent = isSuccess ? 'âœ“' : 'âœ—';
      
      // ç¡®è®¤æŒ‰é’®
      const confirmButton = document.createElement('button');
      confirmButton.className = 'purchase-result-button';
      confirmButton.style.cssText = `
        background-color: ${isSuccess ? '#38A169' : '#E53E3E'};
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      `;
      confirmButton.textContent = 'ç¡®è®¤';
      
      // æ·»åŠ æ‚¬åœæ•ˆæœ
      confirmButton.addEventListener('mouseover', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
      });
      
      confirmButton.addEventListener('mouseout', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
      });
      
      // å…³é—­å¼¹çª—
      confirmButton.addEventListener('click', function() {
        purchaseModal.style.animation = 'fadeOut 0.3s ease';
        modalContent.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (purchaseModal.parentNode === document.body) {
            document.body.removeChild(purchaseModal);
          }
        }, 300);
      });
      
      // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­
      purchaseModal.addEventListener('click', function(e) {
        if (e.target === purchaseModal) {
          purchaseModal.style.animation = 'fadeOut 0.3s ease';
          modalContent.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (purchaseModal.parentNode === document.body) {
              document.body.removeChild(purchaseModal);
            }
          }, 300);
        }
      });
      
      // ç»„è£…å¼¹çª—
      modalContent.appendChild(iconContainer);
      modalContent.appendChild(modalTitle);
      modalContent.appendChild(modalMessage);
      modalContent.appendChild(confirmButton);
      purchaseModal.appendChild(modalContent);
      
      // æ·»åŠ åŠ¨ç”»æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
        @keyframes slideIn {
          from { transform: translateY(-50px) scale(0.9); opacity: 0; }
          to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateY(0) scale(1); opacity: 1; }
          to { transform: translateY(50px) scale(0.9); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(purchaseModal);
    }
    
    // æ˜¾ç¤ºäº‹ä»¶ç»“æœæç¤º
    function showEventResult(title, results) {
      // åˆ›å»ºç»“æœè¯¦æƒ…å­—ç¬¦ä¸²
      let details = '';
      
      // æ·»åŠ èµ„æºå˜åŒ–
      if (results.resources && Object.keys(results.resources).length > 0) {
        details += '<div class="event-result-section"><ul class="event-result-list">';
        for (const [resource, amount] of Object.entries(results.resources)) {
          if (amount > 0) {
            const resourceName = gameData.resources[resource].name;
            details += `<li>+${amount} ${resourceName}</li>`;
          }
        }
        details += '</ul></div>';
      }
      
      // æ·»åŠ çŠ¶æ€å˜åŒ–
      if (results.status && Object.keys(results.status).length > 0) {
        details += '<div class="event-result-section"><strong>çŠ¶æ€å˜åŒ–ï¼š</strong><ul class="event-result-list">';
        const statusNames = {
          hunger: 'é¥¥é¥¿',
          cold: 'å¯’å†·',
          health: 'å¥åº·',
          spirit: 'ç²¾ç¥',
          reputation: 'å£°æœ›'
        };
        
        for (const [status, amount] of Object.entries(results.status)) {
          const statusName = statusNames[status] || status;
          const changeSign = amount >= 0 ? '+' : '';
          details += `<li>${statusName}: ${changeSign}${amount}%</li>`;
        }
        details += '</ul></div>';
      }
      
      // æ·»åŠ ç‰¹æ®Šæ•ˆæœ
      if (results.effects && results.effects.length > 0) {
        details += '<div class="event-result-section"><strong>ç‰¹æ®Šæ•ˆæœï¼š</strong><ul class="event-result-list">';
        for (const effect of results.effects) {
          details += `<li>${effect}</li>`;
        }
        details += '</ul></div>';
        
        // æ£€æŸ¥æ˜¯å¦è§£é”äº†é»‘å¸‚åœ°ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œæ·»åŠ é¢å¤–æç¤º
        if (results.effects.includes('è§£é”äº†é»‘å¸‚åœ°ç‚¹')) {
          details += '<div class="event-result-section">ä½ éœ€è¦ç©¿æˆ´é»‘è¡£æ–—ç¯·ï¼Œæ‰èƒ½è¿›å…¥é»‘å¸‚ï¼Œé»‘è¡£æ–—ç¯·çš„é…æ–¹æ˜¯ï¼š2ä¸ªé»‘å¸ƒåŠ 1ä¸ªçº¿å›¢</div>';
        }
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç‰©å“ä¸”æ˜¯æœå¯»ç»“æœï¼Œæ˜¾ç¤ºç‰¹å®šæ–‡å­—
      if (title === 'æœå¯»ç»“æœ' && (!results.resources || Object.keys(results.resources).length === 0)) {
        // å¦‚æœdetailsä¸ä¸ºç©ºï¼ˆæœ‰çŠ¶æ€å˜åŒ–æˆ–ç‰¹æ®Šæ•ˆæœï¼‰ï¼Œåˆ™åœ¨å…¶å‰é¢æ·»åŠ æ–‡å­—
        if (details) {
          details = '<div class="event-result-empty">ä½ çš„è¿æ°”ä¼¼ä¹ä¸å¤ªå¥½å“¦ï¼Œå•¥ä¹Ÿæ²¡ç¿»åˆ°ï¼å˜»å˜»~</div><br/>' + details;
        } else {
          details = '<div class="event-result-empty">ä½ çš„è¿æ°”ä¼¼ä¹ä¸å¤ªå¥½å“¦ï¼Œå•¥ä¹Ÿæ²¡ç¿»åˆ°ï¼å˜»å˜»~</div>';
        }
      }
      
      // å¦‚æœæ²¡æœ‰ä¹è®¨åˆ°ä»»ä½•ç‰©å“ä¸”æ˜¯ä¹è®¨ç»“æœï¼Œæ˜¾ç¤ºç‰¹å®šæ–‡å­—
      if (title === 'ä¹è®¨ç»“æœ' && (!results.resources || Object.keys(results.resources).length === 0)) {
        // å¦‚æœdetailsä¸ä¸ºç©ºï¼ˆæœ‰çŠ¶æ€å˜åŒ–æˆ–ç‰¹æ®Šæ•ˆæœï¼‰ï¼Œåˆ™åœ¨å…¶å‰é¢æ·»åŠ æ–‡å­—
        if (details) {
          details = '<div class="event-result-empty">è·¯äººå«Œå¼ƒçš„ä¸Šä¸‹çœ‹äº†çœ‹ä½ ï¼Œç´§å¿™å¾€å‰èµ°äº†ï¼å“ˆå“ˆï¼Œä½ å•¥ä¹Ÿæ²¡æœ‰è®¨åˆ°ã€‚</div><br/>' + details;
        } else {
          details = '<div class="event-result-empty">è·¯äººå«Œå¼ƒçš„ä¸Šä¸‹çœ‹äº†çœ‹ä½ ï¼Œç´§å¿™å¾€å‰èµ°äº†ï¼å“ˆå“ˆï¼Œä½ å•¥ä¹Ÿæ²¡æœ‰è®¨åˆ°ã€‚</div>';
        }
      }
      
      // åˆ›å»ºæ¨¡æ€æ¡†
      const eventResultModal = document.createElement('div');
      eventResultModal.className = 'event-result-modal';
      eventResultModal.innerHTML = `
        <div class="event-result-modal-content">
          <div class="event-result-modal-header">
            <h3 class="event-result-modal-title">${title}</h3>
            <button class="event-result-modal-close">&times;</button>
          </div>
          <div class="event-result-modal-body">
            ${details}
          </div>
        </div>
      `;
      
      document.body.appendChild(eventResultModal);
      
      // æ·»åŠ activeç±»ä»¥æ˜¾ç¤ºå¼¹çª—
      eventResultModal.classList.add('active');
      
      // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
      const closeButton = eventResultModal.querySelector('.event-result-modal-close');
      closeButton.addEventListener('click', () => {
        eventResultModal.classList.add('closing');
        setTimeout(() => {
          if (eventResultModal.parentNode === document.body) {
            document.body.removeChild(eventResultModal);
          }
        }, 300);
      });
      
      // æ·»åŠ ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­
      eventResultModal.addEventListener('click', (e) => {
        if (e.target === eventResultModal) {
          eventResultModal.classList.add('closing');
          setTimeout(() => {
            if (eventResultModal.parentNode === document.body) {
              document.body.removeChild(eventResultModal);
            }
          }, 300);
        }
      });
      
      // æ·»åŠ åŠ¨ç”»ç±»
      setTimeout(() => {
        eventResultModal.classList.add('active');
      }, 10);
    }

    // æ˜¾ç¤ºæˆå°±
    function showAchievement(title, description) {
      elements.achievementTitle.textContent = title;
      elements.achievementDescription.textContent = description;
      
      elements.achievementModal.classList.add('active');
      
      setTimeout(() => {
        elements.achievementModal.classList.remove('active');
      }, 7000);
    }
    
    // å‡å°‘ç‰©å“è€ä¹…åº¦
    function decreaseItemDurability() {
      const results = {
        resources: {},
        status: {},
        effects: []
      };
      
      // éå†æ‰€æœ‰èµ„æºï¼Œå‡å°‘è€ä¹…åº¦
      for (const [id, resource] of Object.entries(gameData.resources)) {
        // åªå¤„ç†æœ‰è€ä¹…åº¦å±æ€§çš„ç‰©å“
        if (resource.durability !== undefined && resource.amount > 0) {
          // æ¯å¤©å‡å°‘10ç‚¹è€ä¹…åº¦
          resource.durability -= 10;
          
          // å¦‚æœè€ä¹…åº¦é™è‡³0æˆ–ä»¥ä¸‹ï¼Œç‰©å“æŸå
          if (resource.durability <= 0) {
            // è®°å½•æŸåçš„ç‰©å“
            results.resources[id] = -resource.amount;
            
            // æ£€æŸ¥ç‰©å“æ˜¯å¦æ­£åœ¨è£…å¤‡ä¸­
            if (resource.equipped) {
              // ç§»é™¤è£…å¤‡æ•ˆæœ
              applyEquipmentEffect(id, 'unequip');
              // ç§»é™¤è£…å¤‡çŠ¶æ€
              resource.equipped = false;
              results.effects.push(`ä½ çš„${resource.name}æŸåäº†ï¼Œå·²è‡ªåŠ¨å¸ä¸‹ã€‚`);
            }
            
            // ç§»é™¤æŸåçš„ç‰©å“
            resource.amount = 0;
            resource.durability = 100; // é‡ç½®è€ä¹…åº¦ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ¶ä½œæ—¶ä½¿ç”¨
          }
        }
      }
      
      // å¦‚æœæœ‰ç‰©å“æŸåï¼Œæ˜¾ç¤ºé€šçŸ¥
      if (Object.keys(results.resources).length > 0) {
        let message = 'ç‰©å“æŸåï¼š';
        for (const [resource, amount] of Object.entries(results.resources)) {
          message += `${gameData.resources[resource].name}x${Math.abs(amount)}ï¼Œ`;
          
          // æ›´æ–°æŸåç‰©å“çš„æ˜¾ç¤º
          updateResourceCard(resource);
        }
        message = message.slice(0, -1) + 'ã€‚';
        
        showNotification('ç‰©å“æŸå', message);
      }
    }
    
    // ç«¹å¼“ä½¿ç”¨æ—¶æ¶ˆè€—è€ä¹…åº¦
    function decreaseBambooBowDurability() {
      const bambooBow = gameData.resources.bamboo_bow;
      if (bambooBow && bambooBow.equipped && bambooBow.durability !== undefined) {
        // æ¯æ¬¡ä½¿ç”¨æ¶ˆè€—2ç‚¹è€ä¹…åº¦
        bambooBow.durability -= 2;
        
        // å¦‚æœè€ä¹…åº¦é™è‡³0æˆ–ä»¥ä¸‹ï¼Œç‰©å“æŸå
        if (bambooBow.durability <= 0) {
          // ç§»é™¤è£…å¤‡æ•ˆæœ
          applyEquipmentEffect('bamboo_bow', 'unequip');
          // ç§»é™¤è£…å¤‡çŠ¶æ€
          bambooBow.equipped = false;
          // ç§»é™¤æŸåçš„ç‰©å“
          bambooBow.amount = 0;
          bambooBow.durability = 100; // é‡ç½®è€ä¹…åº¦ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ¶ä½œæ—¶ä½¿ç”¨
          showNotification('è£…å¤‡æŸå', 'ä½ çš„ç«¹å¼“è€ä¹…åº¦è€—å°½ï¼Œå·²æŸåå¹¶è‡ªåŠ¨å¸ä¸‹ã€‚');
        } else if (bambooBow.durability <= 20) {
          // è€ä¹…åº¦ä½æ—¶æé†’
          showNotification('è€ä¹…åº¦è­¦å‘Š', `ç«¹å¼“è€ä¹…åº¦å·²ä½è‡³${bambooBow.durability}%ï¼Œè¯·æ³¨æ„ï¼`);
        }
        
        // æ›´æ–°UI
        updateResourceCard('bamboo_bow');
      }
    }
    
    // æ˜¾ç¤ºé’±å¸ä¸è¶³å¼¹çª—
    function showNoMoneyModal() {
      const modal = document.createElement('div');
      modal.className = 'no-money-modal active';
      modal.innerHTML = `
        <div class="no-money-modal-content">
          <h2 class="no-money-modal-title">é’±å¸ä¸è¶³</h2>
          <p class="no-money-modal-text">ä½ è¿˜æ²¡æœ‰10ä¸ªé’±å¸ï¼Œæ— æ³•è·å¾—çº¿ç´¢</p>
          <div class="no-money-modal-button" id="closeNoMoneyModal">å…³é—­</div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .no-money-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }
        
        .no-money-modal.active {
          opacity: 1;
          pointer-events: auto;
        }
        
        .no-money-modal-content {
          background-color: #F7FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 0.5rem;
          padding: 2rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
          width: 300px;
          text-align: center;
        }
        
        .no-money-modal-title {
          font-size: 1.5rem;
          font-weight: 700;
          color: #2D3748;
          margin-bottom: 1rem;
        }
        
        .no-money-modal-text {
          color: #4A5568;
          margin-bottom: 1.5rem;
          line-height: 1.5;
        }
        
        .no-money-modal-button {
          background-color: #3182CE;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: 500;
          transition: background-color 0.2s;
          display: inline-block;
        }
        
        .no-money-modal-button:hover {
          background-color: #2C5282;
        }
      `;
      
      document.head.appendChild(style);
      
      // å…³é—­æŒ‰é’®äº‹ä»¶
      const closeNoMoneyModal2 = document.getElementById('closeNoMoneyModal');
      if (closeNoMoneyModal2) {
        closeNoMoneyModal2.addEventListener('click', function() {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        });
      }
      
      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
          setTimeout(function() {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
            if (style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        }
      });
    }
    
    // åˆ¶ä½œçª—å£åŠŸèƒ½
    const craftingModal = document.getElementById('craftingModal');
    const craftingButton = document.getElementById('craftingButton');
    const closeCraftingModal = document.getElementById('closeCraftingButton');
    const craftingInventory = document.getElementById('craftingInventory');
    const craftingSlots = document.querySelectorAll('#craftingModal .crafting-slot');
    const craftingCombineButton = document.getElementById('craftButton');
    const craftingRecipeButton = document.getElementById('craftRecipeButton');
    
    // åˆ¶ä½œçª—å£çš„ç»„åˆæ§½æ•°æ®
    const craftingSlotsData = {1: null, 2: null, 3: null};
    
    // æ‰“å¼€åˆ¶ä½œçª—å£
    craftingButton.addEventListener('click', function() {
      craftingModal.classList.add('active');
      renderCraftingInventory();
      updateCraftingSlots();
    });
    
    // å…³é—­åˆ¶ä½œçª—å£
    closeCraftingModal.addEventListener('click', function() {
      craftingModal.classList.remove('active');
      clearCraftingSlots();
    });
    
    // ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­
    craftingModal.addEventListener('click', function(e) {
      if (e.target === craftingModal) {
        craftingModal.classList.remove('active');
        clearCraftingSlots();
      }
    });
    
    // æ¸²æŸ“åˆ¶ä½œçª—å£çš„å·¦ä¾§å¡ç‰Œåˆ—è¡¨
    function renderCraftingInventory() {
      craftingInventory.innerHTML = '';
      
      // è·å–æ‰€æœ‰æ•°é‡å¤§äº0çš„èµ„æº
      const ownedResources = [];
      for (const [id, resource] of Object.entries(gameData.resources)) {
        if (resource.amount > 0) {
          ownedResources.push({ id, resource });
        }
      }
      
      // åˆ›å»ºå¡ç‰Œå…ƒç´ 
      ownedResources.forEach(({ id, resource }) => {
        const card = document.createElement('div');
        card.className = 'crafting-inventory-card';
        card.dataset.resourceId = id;
        
        card.innerHTML = `
          <div class="crafting-card-image" style="background-image: url('${resource.image}');"></div>
          <div class="crafting-card-title">${resource.name}</div>
          <div class="crafting-card-count">x${resource.amount}</div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        card.addEventListener('click', function() {
          addToCraftingSlot(id);
        });
        
        craftingInventory.appendChild(card);
      });
    }
    
    // å°†å¡ç‰Œæ·»åŠ åˆ°åˆ¶ä½œçª—å£çš„ç»„åˆæ§½
    function addToCraftingSlot(resourceId) {
      // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æº
      if (gameData.resources[resourceId].amount <= 0) {
        return;
      }
      
      // å¯»æ‰¾ç¬¬ä¸€ä¸ªç©ºæ§½ä½
      for (const slotNumber in craftingSlotsData) {
        if (craftingSlotsData[slotNumber] === null) {
          craftingSlotsData[slotNumber] = resourceId;
          // å‡å°‘èƒŒåŒ…ä¸­çš„èµ„æºæ•°é‡
          gameData.resources[resourceId].amount--;
          break;
        }
      }
      
      // é‡æ–°æ¸²æŸ“åˆ¶ä½œçª—å£çš„å·¦ä¾§å¡ç‰Œåˆ—è¡¨ï¼ˆæ•°é‡å˜åŒ–åå¯èƒ½éœ€è¦éšè—æŸäº›å¡ç‰Œï¼‰
      renderCraftingInventory();
      updateCraftingSlots();
      checkCraftingCombination();
    }
    
    // æ›´æ–°åˆ¶ä½œçª—å£çš„ç»„åˆæ§½æ˜¾ç¤º
    function updateCraftingSlots() {
      craftingSlots.forEach(slot => {
        const slotNumber = slot.getAttribute('data-slot');
        const resourceId = craftingSlotsData[slotNumber];
        
        slot.innerHTML = '';
        
        if (resourceId) {
          const resource = gameData.resources[resourceId];
          const resourceCard = document.createElement('div');
          resourceCard.className = 'card resource combination-card';
          
          resourceCard.innerHTML = `
            <div class="card-image" style="background-image: url('${resource.image}'); background-size: cover; background-position: center; display: flex;">
              <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
              <div class="image-fallback" style="display: flex; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
            </div>
            <div class="card-content">
              <div class="card-title">${resource.name}</div>
            </div>
          `;
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç§»é™¤å¡ç‰Œ
          resourceCard.addEventListener('click', function(e) {
            e.stopPropagation();
            // å°†èµ„æºæ”¾å›èƒŒåŒ…
            gameData.resources[resourceId].amount++;
            // æ¸…ç©ºæ§½ä½
            craftingSlotsData[slotNumber] = null;
            // é‡æ–°æ¸²æŸ“å·¦ä¾§å¡ç‰Œåˆ—è¡¨å’Œå³ä¾§æ§½ä½
            renderCraftingInventory();
            updateCraftingSlots();
            checkCraftingCombination();
          });
          
          slot.appendChild(resourceCard);
        }
      });
    }
    
    // æ£€æŸ¥åˆ¶ä½œçª—å£çš„ç»„åˆ
    function checkCraftingCombination() {
      const slots = Object.values(craftingSlotsData).filter(Boolean);
      
      if (slots.length >= 2) {
        craftingCombineButton.disabled = false;
      } else {
        craftingCombineButton.disabled = true;
      }
    }
    
    // åˆ¶ä½œçª—å£çš„ç»„åˆåŠŸèƒ½
    craftingCombineButton.addEventListener('click', function() {
      const slots = Object.values(craftingSlotsData).filter(Boolean);
      
      if (slots.length < 2) {
        showNotification('ç»„åˆå¤±è´¥', 'éœ€è¦è‡³å°‘ä¸¤å¼ å¡ç‰Œæ‰èƒ½ç»„åˆã€‚');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•é…æ–¹
      let matchedRecipe = null;
      
      for (const recipe of gameData.recipes) {
        const ingredients = Object.keys(recipe.ingredients);
        
        // æ£€æŸ¥é…æ–¹æ‰€éœ€çš„æ‰€æœ‰èµ„æºæ˜¯å¦éƒ½åœ¨ç»„åˆæ§½ä¸­
        let hasAllIngredients = true;
        const slotCounts = {};
        
        // ç»Ÿè®¡æ§½ä½ä¸­æ¯ç§èµ„æºçš„æ•°é‡
        slots.forEach(resourceId => {
          slotCounts[resourceId] = (slotCounts[resourceId] || 0) + 1;
        });
        
        // æ£€æŸ¥æ¯ç§æˆåˆ†æ˜¯å¦è¶³å¤Ÿ
        for (const ingredientId of ingredients) {
          const requiredAmount = recipe.ingredients[ingredientId];
          const availableAmount = slotCounts[ingredientId] || 0;
          
          if (availableAmount < requiredAmount) {
            hasAllIngredients = false;
            break;
          }
        }
        
        if (hasAllIngredients) {
          matchedRecipe = recipe;
          break;
        }
      }
      
      if (matchedRecipe) {
        // æ¶ˆè€—ææ–™
        for (const [ingredientId, amount] of Object.entries(matchedRecipe.ingredients)) {
          let used = 0;
          for (let i = 1; i <= 3; i++) {
            if (craftingSlotsData[i] === ingredientId && used < amount) {
              craftingSlotsData[i] = null;
              used++;
            }
          }
        }
        
        // å¢åŠ äº§ç‰©
        let firstResultId = null;
        if (matchedRecipe.result) {
          // å¤„ç†resultå¯¹è±¡ - å®ƒçš„ç»“æ„æ˜¯{ resourceId: amount }ï¼Œä¾‹å¦‚{ pill: 1 }
          for (const [resultId, resultAmount] of Object.entries(matchedRecipe.result)) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯èµ„æºIDè¿˜æ˜¯ç‰¹æ®Šå±æ€§ï¼ˆæ’é™¤æ¸¸æˆå±æ€§å’Œéèµ„æºé¡¹ï¼‰
            if (resultId === 'name' || resultId === 'description' || 
                resultId === 'reputation' || resultId === 'begging_chance' ||
                resultId === 'begging_level' || resultId === 'max_hunger' ||
                resultId === 'max_thirst' || resultId === 'max_health' ||
                resultId === 'hunger_rate' || resultId === 'thirst_rate' ||
                resultId === 'health_rate' || resultId === 'cold' || resultId === 'health') {
              // è¿™äº›æ˜¯æ¸¸æˆå±æ€§ï¼Œç›´æ¥åº”ç”¨åˆ°gameData
              if (resultId in gameData.status) {
                gameData.status[resultId] = Math.min(100, Math.max(0, gameData.status[resultId] + resultAmount));
              } else if (resultId in gameData) {
                gameData[resultId] += resultAmount;
              }
              continue;
            }
            
            // è®°å½•ç¬¬ä¸€ä¸ªç»“æœIDç”¨äºæ˜¾ç¤º
            if (!firstResultId) firstResultId = resultId;
            
            // ç¡®ä¿äº§ç‰©èµ„æºå­˜åœ¨äºgameData.resourcesä¸­
            if (gameData.resources[resultId]) {
              gameData.resources[resultId].amount += resultAmount;
            } else {
              // å¦‚æœèµ„æºä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
              gameData.resources[resultId] = {
                id: resultId,
                name: resultId.charAt(0).toUpperCase() + resultId.slice(1).replace('_', ' '), // ä½¿ç”¨èµ„æºIDç”Ÿæˆåç§°
                amount: resultAmount,
                image: `UI/${resultId}.png` // å°è¯•ä½¿ç”¨èµ„æºIDä½œä¸ºå›¾ç‰‡è·¯å¾„
              };
            }
          }
        }
        

        
        // æ˜¾ç¤ºè·å¾—æ–°å¡ç‰Œçš„å¼¹çª—
        if (firstResultId) {
          showCardAcquiredModal(gameData.resources[firstResultId]);
        }
        
        // æ˜¾ç¤ºè·å¾—æ–°å¡ç‰Œçš„å¼¹çª—å‡½æ•°
        function showCardAcquiredModal(resource) {
          // åˆ›å»ºæ¨¡æ€æ¡†å…ƒç´ 
          const cardModal = document.createElement('div');
          cardModal.className = 'card-acquired-modal';
          cardModal.innerHTML = `
            <div class="card-acquired-modal-content">
              <div class="card-acquired-modal-header">
                <h3 class="card-acquired-modal-title">æ­å–œä½ ï¼Œè·å¾—æ–°çš„å¡ç‰Œ</h3>
                <button class="card-acquired-modal-close">&times;</button>
              </div>
              <div class="card-acquired-modal-body">
                <div class="acquired-card">
                  <div class="card-image" style="background-image: url('${resource.image}'); background-size: cover; background-position: center; display: flex;">
                    <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
                    <div class="image-fallback" style="display: flex; width: 100%; height: 100%; background-color: #E2E8F0; align-items: center; justify-content: center; color: #718096; font-size: 12px; z-index: 1;">å›¾ç‰‡</div>
                  </div>
                  <div class="card-info">
                    <div class="card-name">${resource.name}</div>
                    <div class="card-amount">è·å¾—æ•°é‡: ${resource.amount > 1 ? resource.amount : 1}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // æ·»åŠ æ ·å¼
          const style = document.createElement('style');
          style.textContent = `
            .card-acquired-modal {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0, 0, 0, 0.5);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 1500;
              opacity: 0;
              pointer-events: none;
              transition: opacity 0.3s ease;
            }
            
            .card-acquired-modal.active {
              opacity: 1;
              pointer-events: auto;
            }
            
            .card-acquired-modal.closing {
              opacity: 0;
            }
            
            .card-acquired-modal-content {
              background-color: white;
              border-radius: 8px;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
              max-width: 400px;
              width: 90%;
              transform: translateY(-20px);
              transition: transform 0.3s ease;
            }
            
            .card-acquired-modal.active .card-acquired-modal-content {
              transform: translateY(0);
            }
            
            .card-acquired-modal.closing .card-acquired-modal-content {
              transform: translateY(-20px);
            }
            
            .card-acquired-modal-header {
              padding: 16px 20px;
              border-bottom: 1px solid #e0e0e0;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            
            .card-acquired-modal-title {
              font-size: 20px;
              font-weight: bold;
              margin: 0;
              color: #333;
            }
            
            .card-acquired-modal-close {
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #999;
              line-height: 1;
              padding: 0;
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 4px;
              transition: background-color 0.2s ease, color 0.2s ease;
            }
            
            .card-acquired-modal-close:hover {
              background-color: #f0f0f0;
              color: #333;
            }
            
            .card-acquired-modal-body {
              padding: 20px;
            }
            
            .acquired-card {
              display: flex;
              flex-direction: column;
              align-items: center;
            }
            
            .card-image {
              width: 180px;
              height: 250px;
              border-radius: 8px;
              margin-bottom: 16px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            }
            
            .card-info {
              text-align: center;
            }
            
            .card-name {
              font-size: 18px;
              font-weight: bold;
              margin-bottom: 8px;
              color: #333;
            }
            
            .card-amount {
              font-size: 14px;
              color: #666;
            }
          `;
          
          // æ·»åŠ åˆ°DOM
          document.head.appendChild(style);
          document.body.appendChild(cardModal);
          
          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          setTimeout(() => {
            cardModal.classList.add('active');
          }, 10);
          
          // å…³é—­æŒ‰é’®äº‹ä»¶
          const closeButton = cardModal.querySelector('.card-acquired-modal-close');
          closeButton.addEventListener('click', closeModal);
          
          // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
          cardModal.addEventListener('click', (e) => {
            if (e.target === cardModal) {
              closeModal();
            }
          });
          
          // å…³é—­æ¨¡æ€æ¡†å‡½æ•°
          function closeModal() {
            cardModal.classList.add('closing');
            setTimeout(() => {
              if (cardModal.parentNode === document.body) {
        document.body.removeChild(cardModal);
      }
      if (style.parentNode === document.head) {
        document.head.removeChild(style);
      }
            }, 300);
          }
        }
        // æ›´æ–°ç•Œé¢
        renderResources();
        renderCraftingInventory();
        updateCraftingSlots();
        checkCraftingCombination();
      } else {
        // ç»„åˆå¤±è´¥å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼æç¤ºï¼Œä¾‹å¦‚é€šçŸ¥ç³»ç»Ÿ
        showNotification('å½“å‰ææ–™æ— æ³•ç»„åˆå‡ºä»»ä½•ç‰©å“', 'error');
      }
    });
    
    // åˆ¶ä½œçª—å£çš„é…æ–¹åŠŸèƒ½
    function showRecipeModal() {
      renderRecipes();
      elements.recipeModal.classList.add('active');
    }
    
    craftingRecipeButton.addEventListener('click', function() {
      showRecipeModal();
    });
    
    // æ¸…ç©ºåˆ¶ä½œçª—å£çš„ç»„åˆæ§½
    function clearCraftingSlots() {
      for (const slotNumber in craftingSlotsData) {
        const resourceId = craftingSlotsData[slotNumber];
        if (resourceId) {
          // å°†èµ„æºæ”¾å›èƒŒåŒ…
          gameData.resources[resourceId].amount++;
          // æ¸…ç©ºæ§½ä½
          craftingSlotsData[slotNumber] = null;
        }
      }
      // é‡æ–°æ¸²æŸ“å·¦ä¾§å¡ç‰Œåˆ—è¡¨å’Œå³ä¾§æ§½ä½
      renderCraftingInventory();
      updateCraftingSlots();
    }

    // ç¿»æ‰¾æ¸¸æˆç›¸å…³ä»£ç 
    function showGarbageGame() {
      const garbageModal = document.createElement('div');
      garbageModal.className = 'garbage-game-modal';
      garbageModal.innerHTML = `
        <div class="garbage-game-content">
          <div class="garbage-grid-container">
            <div class="garbage-grid" id="garbageGrid"></div>
          </div>
          <button class="garbage-game-end-btn" id="garbageGameEndBtn">ç»“æŸç¿»åƒåœ¾</button>
        </div>
      `;

      // æ·»åŠ CSSæ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .garbage-game-modal {
          display: flex;
          justify-content: center;
          align-items: center;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          animation: fadeIn 0.3s ease;
        }

        .garbage-game-content {
          background-color: #F7FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 0.5rem;
          padding: 2rem;
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
          text-align: center;
          max-width: 500px;
          width: 90%;
        }



        .garbage-grid-container {
          display: flex;
          justify-content: center;
          margin-bottom: 2rem;
        }

        .garbage-grid {
          display: grid;
          grid-template-columns: repeat(5, 1fr);
          grid-template-rows: repeat(5, 1fr);
          gap: 0.375rem;
          width: 250px;
          height: 250px;
        }

        .garbage-grid-item {
          background-color: #E2E8F0;
          border: 1px solid #CBD5E0;
          border-radius: 0.375rem;
          cursor: pointer;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 1.5rem;
          font-weight: 600;
          transition: all 0.2s ease;
          position: relative;
          overflow: hidden;
        }

        .loot-grid-item:hover {
          background-color: #CBD5E0;
          transform: translateY(-2px);
        }

        .garbage-grid-item.flipped {
          background-color: #FFFFFF;
          cursor: default;
          transform: scale(0.95);
        }

        /* å½“å‰é€‰ä¸­æ ¼å­çš„ç»¿è‰²è¾¹æ¡†å’Œé˜´å½±æ•ˆæœ */
        .garbage-grid-item.current {
          border: 2px solid #48BB78;
          box-shadow: 0 0 10px rgba(72, 187, 120, 0.7);
          transform: scale(1.05);
        }
        
        /* çº¢è‰²è¾¹æ¡†é˜´å½±è­¦ç¤ºæ ·å¼ */
        .garbage-grid-item.danger-tip {
          box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3) !important;
          border: 3px solid red !important;
          animation: danger-pulse 1.5s infinite !important;
          z-index: 10 !important;
        }
        
        /* å±é™©è­¦ç¤ºåŠ¨ç”»æ•ˆæœ */
        @keyframes danger-pulse {
          0% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3) !important; }
          50% { box-shadow: 0 0 15px 5px red, inset 0 0 15px 5px rgba(255, 0, 0, 0.5) !important; }
          100% { box-shadow: 0 0 10px 3px red, inset 0 0 10px 3px rgba(255, 0, 0, 0.3) !important; }
        }

        .garbage-grid-item.flipped .item-content {
          animation: flipIn 0.3s ease;
        }

        .garbage-game-end-btn {
          background-color: #3182CE;
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 0.375rem;
          cursor: pointer;
          font-weight: 500;
          transition: background-color 0.2s;
          border: none;
          font-size: 1rem;
          margin-bottom: 1.5rem;
        }

        .garbage-game-end-btn:hover {
          background-color: #2C5282;
        }



        /* ç‰©å“å¡ç‰‡æ ·å¼ */
        .item-card {
          background-color: white;
          border-radius: 0.25rem;
          padding: 0.25rem;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        }

        /* éç©ºå¡ç‰Œç‰¹æ®Šæ ·å¼ - å¢åŠ å®½åº¦ä»¥é€‚åº”æ ¼å­å¹¶ç§»é™¤è¾¹æ¡† */
        .garbage-grid-item.flipped .item-card:not(:has(.loot-item-neutral)) {
          padding: 0.125rem;
          width: 100%;
          height: 100%;
          border: none;
          box-shadow: none;
        }

        /* éç©ºå¡ç‰Œå›¾ç‰‡æ ·å¼ - è°ƒæ•´å¤§å°ä»¥é€‚åº”æ›´å¤§çš„å¡ç‰Œ */
        .garbage-grid-item.flipped .item-card:not(:has(.loot-item-neutral)) img {
          width: 32px;
          height: 32px;
          margin-bottom: 0.125rem;
        }

        /* ç©ºå¡ç‰Œç‰¹æ®Šæ ·å¼ - ä¸æ˜¾ç¤ºè¾¹æ¡†ï¼Œä»…æ”¾å¤§å­—ä½“ */
        .item-card .item-name.loot-item-neutral {
          font-size: 1.5rem; /* æ”¾å¤§å­—ä½“å¤§å°ä»¥é€‚åº”æ ¼å­ */
        }

        /* ç©ºå¡ç‰Œçš„item-cardä¸æ˜¾ç¤ºè¾¹æ¡† */
        .garbage-grid-item.flipped .item-card:has(.loot-item-neutral) {
          border: none;
          box-shadow: none;
          padding: 0;
        }
        


        .item-card .item-name {
          font-size: 0.75rem;
          font-weight: 600;
          text-align: center;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          margin-bottom: 0;
        }

        .item-card .item-effect {
          font-size: 0.75rem;
          color: #4A5568;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes flipIn {
          from {
            transform: rotateY(90deg);
            opacity: 0;
          }
          to {
            transform: rotateY(0deg);
            opacity: 1;
          }
        }

        /* ä¸åŒç±»å‹ç‰©å“çš„æ ·å¼ */
        .loot-item-positive {
          color: #38A169;
        }

        .loot-item-negative {
          color: #E53E3E;
        }

        .loot-item-neutral {
          color: #718096;
        }
        

        }
        

          }
        }
      `;

      document.body.appendChild(garbageModal);
      document.head.appendChild(style);

      // åˆå§‹åŒ–ç¿»æ‰¾æ¸¸æˆ
      initGarbageGame();

      // æ¸¸æˆç»“æŸæŒ‰é’®äº‹ä»¶
      const garbageGameEndBtn = document.getElementById('garbageGameEndBtn');
      garbageGameEndBtn.addEventListener('click', function() {
        endGarbageGame();
      });

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      garbageModal.addEventListener('click', function(e) {
        if (e.target === garbageModal) {
          endGarbageGame();
        }
      });

      // é”®ç›˜æ§åˆ¶åŠŸèƒ½
      // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
      let currentSelectedRow = 0;
      let currentSelectedCol = 0;
      
      // åˆå§‹åŒ–å½“å‰ä½ç½®ä¸ºä¸­å¿ƒ
      function initializePosition() {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');
        const gridSize = Math.sqrt(allItems.length);
        const centerRow = Math.floor(gridSize / 2);
        const centerCol = Math.floor(gridSize / 2);
        
        currentSelectedRow = centerRow;
        currentSelectedCol = centerCol;
        
        // ä¸ºåˆå§‹ä½ç½®æ·»åŠ ç»¿è‰²è¾¹æ¡†å’Œé˜´å½±
        const centerItem = Array.from(allItems).find(item => {
          return parseInt(item.dataset.row) === centerRow && parseInt(item.dataset.col) === centerCol;
        });
        
        if (centerItem) {
          // ç§»é™¤æ‰€æœ‰æ ¼å­çš„currentç±»
          allItems.forEach(item => item.classList.remove('current'));
          // ä¸ºä¸­å¿ƒæ ¼å­æ·»åŠ currentç±»
          centerItem.classList.add('current');
        }
      }
      
      // åˆå§‹åŒ–ä½ç½®
      initializePosition();
      
      // é”®ç›˜äº‹ä»¶å¤„ç†å‡½æ•°
      function handleKeyboard(event) {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');
        const gridSize = Math.sqrt(allItems.length);
        
        // è®¡ç®—æ–°ä½ç½®
        let newRow = currentSelectedRow;
        let newCol = currentSelectedCol;
        
        switch (event.key.toLowerCase()) {
          case 'w': // ä¸Š
            newRow = currentSelectedRow > 0 ? currentSelectedRow - 1 : currentSelectedRow;
            break;
          case 'a': // å·¦
            newCol = currentSelectedCol > 0 ? currentSelectedCol - 1 : currentSelectedCol;
            break;
          case 's': // ä¸‹
            newRow = currentSelectedRow < gridSize - 1 ? currentSelectedRow + 1 : currentSelectedRow;
            break;
          case 'd': // å³
            newCol = currentSelectedCol < gridSize - 1 ? currentSelectedCol + 1 : currentSelectedCol;
            break;
          default:
            return;
        }
        
        // å¦‚æœä½ç½®æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
        if (newRow === currentSelectedRow && newCol === currentSelectedCol) {
          return;
        }
        
        // æ‰¾åˆ°æ–°ä½ç½®çš„æ ¼å­
        const targetItem = Array.from(allItems).find(item => {
          return parseInt(item.dataset.row) === newRow && parseInt(item.dataset.col) === newCol;
        });
        
        if (!targetItem) return;
        
        // è·å–æ ¼å­ç‰©å“æ•°æ®
        const item = JSON.parse(targetItem.dataset.item);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å±é™©ç‰©å“
        const isDanger = item.name === 'å—ä¼¤' || item.name === 'å‘•å';
        
        // æ£€æŸ¥æ˜¯å¦å·²æ˜¾ç¤ºè­¦ç¤º
        const hasWarning = targetItem.classList.contains('danger-tip');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®è¯¥æ ¼å­
        const firstVisit = targetItem.dataset.firstVisit === 'false';
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ˜¾ç¤ºè­¦ç¤ºï¼ˆæ ¹æ®å·²æ˜¾ç¤ºçš„è­¦ç¤ºæ•°é‡å’Œæœ€å¤§è­¦ç¤ºæ•°é‡ï¼‰
        const canShowWarning = window.garbageGameWarningCount < window.garbageGameMaxWarningCount;
        
        console.log('é”®ç›˜å¤„ç†æ ¼å­:', newRow, newCol, 'ç‰©å“:', item.name, 'å±é™©:', isDanger, 'å·²è­¦ç¤º:', hasWarning, 'å¯æ˜¾ç¤ºè­¦ç¤º:', canShowWarning, 'é¦–æ¬¡è®¿é—®:', firstVisit);
        
        // å¦‚æœæ˜¯å±é™©ç‰©å“ä¸”å°šæœªæ˜¾ç¤ºè­¦ç¤ºä¸”æ˜¯é¦–æ¬¡è®¿é—®
        if (isDanger && !hasWarning && firstVisit) {
          // æ ‡è®°ä¸ºå·²è®¿é—®
          targetItem.dataset.firstVisit = 'true';
          
          // å¦‚æœå…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œåˆ™æ˜¾ç¤ºè­¦ç¤º
          if (canShowWarning) {
            // å¢åŠ è­¦ç¤ºè®¡æ•°
            window.garbageGameWarningCount++;
            console.log('å½“å‰è­¦ç¤ºè®¡æ•°:', window.garbageGameWarningCount, 'æœ€å¤§è­¦ç¤ºæ•°é‡:', window.garbageGameMaxWarningCount);
            
            // æ˜¾ç¤ºè­¦ç¤º
            targetItem.classList.add('danger-tip');
            
            console.log('é”®ç›˜é¢„è§ˆï¼šå³å°†ç§»åŠ¨åˆ°å±é™©æ ¼å­', newRow, newCol, 'ç‰©å“:', item.name, 'å·²æ˜¾ç¤ºè­¦ç¤º');
          } else {
            // ä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ‰§è¡Œç¿»ç‰Œ
            console.log('é”®ç›˜æ§åˆ¶ï¼šä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ‰§è¡Œç¿»ç‰Œ');
            // å®é™…ç§»åŠ¨åˆ°æ–°ä½ç½®
            currentSelectedRow = newRow;
            currentSelectedCol = newCol;
            
            // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
            flipCurrentPosition();
          }
        } 
        // å¦‚æœå·²æ˜¾ç¤ºè­¦ç¤ºæˆ–ä¸æ˜¯å±é™©ç‰©å“
        else {
          // ç§»é™¤è­¦ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
          targetItem.classList.remove('danger-tip');
          
          // å®é™…ç§»åŠ¨åˆ°æ–°ä½ç½®
          currentSelectedRow = newRow;
          currentSelectedCol = newCol;
          
          // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
          flipCurrentPosition();
        }
        
        // é˜²æ­¢é»˜è®¤è¡Œä¸º
        event.preventDefault();
      }
      
      // å¤„ç†æ ¼å­ç‚¹å‡»çš„å‡½æ•°
      function handleGridItemClick(gridItem) {
        // è·å–æ ¼å­çš„è¡Œå’Œåˆ—
        const itemRow = parseInt(gridItem.dataset.row);
        const itemCol = parseInt(gridItem.dataset.col);
        
        // è·å–æ ¼å­ç‰©å“æ•°æ®
        const item = JSON.parse(gridItem.dataset.item);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å±é™©ç‰©å“
        const isDanger = item.name === 'å—ä¼¤' || item.name === 'å‘•å';
        
        // æ£€æŸ¥æ˜¯å¦å·²æ˜¾ç¤ºè­¦ç¤º
        const hasWarning = gridItem.classList.contains('danger-tip');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®è¯¥æ ¼å­ï¼ˆåˆå§‹å€¼ä¸ºfalseè¡¨ç¤ºæœªè®¿é—®è¿‡ï¼‰
        const firstVisit = gridItem.dataset.firstVisit === 'false';
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ˜¾ç¤ºè­¦ç¤ºï¼ˆæ ¹æ®å·²æ˜¾ç¤ºçš„è­¦ç¤ºæ•°é‡å’Œæœ€å¤§è­¦ç¤ºæ•°é‡ï¼‰
        const canShowWarning = window.garbageGameWarningCount < window.garbageGameMaxWarningCount;
        
        console.log('å¤„ç†æ ¼å­ç‚¹å‡»:', itemRow, itemCol, 'ç‰©å“:', item.name, 'å±é™©:', isDanger, 'å·²è­¦ç¤º:', hasWarning, 'å¯æ˜¾ç¤ºè­¦ç¤º:', canShowWarning, 'é¦–æ¬¡è®¿é—®:', firstVisit);
        
        // å¦‚æœæ˜¯å±é™©ç‰©å“ä¸”å°šæœªæ˜¾ç¤ºè­¦ç¤ºä¸”æ˜¯é¦–æ¬¡è®¿é—®
        if (isDanger && !hasWarning && firstVisit) {
          // æ ‡è®°ä¸ºå·²è®¿é—®
          gridItem.dataset.firstVisit = 'true';
          
          // å¦‚æœå…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œåˆ™æ˜¾ç¤ºè­¦ç¤º
          if (canShowWarning) {
            console.log('æ˜¾ç¤ºå±é™©è­¦ç¤º:', item.name);
            // å¢åŠ è­¦ç¤ºè®¡æ•°
            window.garbageGameWarningCount++;
            console.log('å½“å‰è­¦ç¤ºè®¡æ•°:', window.garbageGameWarningCount, 'æœ€å¤§è­¦ç¤ºæ•°é‡:', window.garbageGameMaxWarningCount);
            // æ·»åŠ çº¢è‰²è¾¹æ¡†é˜´å½±è­¦ç¤ºç±»
            gridItem.classList.add('danger-tip');
          } else {
            // ä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¿»ç‰Œ
            console.log('ä¸å…è®¸æ˜¾ç¤ºè­¦ç¤ºï¼Œç›´æ¥æ£€æŸ¥ç¿»ç‰Œ');
            const canFlip = checkCanFlip(itemRow, itemCol);
            
            if (!canFlip) {
              console.log('æ— æ³•ç¿»ç‰Œï¼Œä½ç½®ä¸åˆæ³•');
              return;
            }
            
            console.log('æ‰§è¡Œç¿»ç‰Œ:', item.name);
            // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
            flipItem(gridItem);
          }
        } 
        // å¦‚æœå·²æ˜¾ç¤ºè­¦ç¤ºæˆ–ä¸æ˜¯å±é™©ç‰©å“
        else {
          // ç§»é™¤è­¦ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
          gridItem.classList.remove('danger-tip');
          
          // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¿»ç‰Œ
          const canFlip = checkCanFlip(itemRow, itemCol);
          
          if (!canFlip) {
            console.log('æ— æ³•ç¿»ç‰Œï¼Œä½ç½®ä¸åˆæ³•');
            return;
          }
          
          console.log('æ‰§è¡Œç¿»ç‰Œ:', item.name);
          // æ‰§è¡Œç¿»ç‰Œé€»è¾‘
          flipItem(gridItem);
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¿»ç‰Œ
      function checkCanFlip(itemRow, itemCol) {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');
        const gridSize = Math.sqrt(allItems.length);
        
        // æ‰¾åˆ°æ‰€æœ‰å·²ç¿»å¼€çš„æ ¼å­
        const flippedItems = Array.from(allItems).filter(gridItem => gridItem.classList.contains('flipped'));
        
        // å¦‚æœæ²¡æœ‰å·²ç¿»å¼€çš„æ ¼å­ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æ˜¯ä¸­å¿ƒæ ¼å­
        if (flippedItems.length === 0) {
          const centerRow = Math.floor(gridSize / 2);
          const centerCol = Math.floor(gridSize / 2);
          return itemRow === centerRow && itemCol === centerCol;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ä»»ä½•å·²ç¿»å¼€çš„æ ¼å­ä¸Šä¸‹å·¦å³ç›¸é‚»
        for (const gridItem of flippedItems) {
          const gridRow = parseInt(gridItem.dataset.row);
          const gridCol = parseInt(gridItem.dataset.col);
          
          // æ£€æŸ¥æ˜¯å¦ä¸Šä¸‹å·¦å³ç›¸é‚»
          const isAdjacent = 
            (Math.abs(gridRow - itemRow) === 1 && gridCol === itemCol) ||
            (Math.abs(gridCol - itemCol) === 1 && gridRow === itemRow);
          
          if (isAdjacent) {
            return true;
          }
        }
        
        return false;
      }
      
      // ç¿»ç‰Œå½“å‰ä½ç½®çš„å‡½æ•°
      function flipCurrentPosition() {
        const garbageGrid = document.getElementById('garbageGrid');
        const allItems = garbageGrid.querySelectorAll('.garbage-grid-item');
        
        // ç§»é™¤æ‰€æœ‰æ ¼å­çš„currentç±»
        allItems.forEach(item => item.classList.remove('current'));
        
        // æ‰¾åˆ°å½“å‰ä½ç½®çš„æ ¼å­
        const targetItem = Array.from(allItems).find(item => {
          return parseInt(item.dataset.row) === currentSelectedRow && parseInt(item.dataset.col) === currentSelectedCol;
        });
        
        if (targetItem) {
          // ä¸ºå½“å‰æ ¼å­æ·»åŠ ç»¿è‰²è¾¹æ¡†å’Œé˜´å½±
          targetItem.classList.add('current');
          
          console.log('é”®ç›˜æ§åˆ¶ï¼šç§»åŠ¨åˆ°æ ¼å­', currentSelectedRow, currentSelectedCol);
          // è°ƒç”¨ç‚¹å‡»å¤„ç†å‡½æ•°
          handleGridItemClick(targetItem);
        }
      }
      
      // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
      document.addEventListener('keydown', handleKeyboard);
      
      // ä¿å­˜ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨ç»“æŸæ¸¸æˆæ—¶ç§»é™¤
      window.currentGarbageGameKeyboardListener = handleKeyboard;

      // åˆå§‹åŒ–ç¿»åƒåœ¾æ¸¸æˆçš„å‡½æ•°
      function initGarbageGame() {
        // éšæœºé€‰æ‹©3x3æˆ–5x5ç½‘æ ¼
        const gridSize = Math.random() > 0.5 ? 3 : 5;
        const garbageGrid = document.getElementById('garbageGrid');
        garbageGrid.innerHTML = '';

        // è®¾ç½®ç½‘æ ¼å¤§å°
        garbageGrid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
        garbageGrid.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;

        // åˆ›å»ºç‰©å“æ± 
        const items = generateGarbageItems(gridSize * gridSize);

        // æ‰“ä¹±ç‰©å“é¡ºåº
        shuffleArray(items);

        // åˆ›å»ºç½‘æ ¼é¡¹
        const gridItems = [];
        items.forEach((item, index) => {
          const gridItem = document.createElement('div');
          gridItem.className = 'garbage-grid-item';
          gridItem.dataset.item = JSON.stringify(item);
          gridItem.dataset.index = index;
          gridItem.dataset.row = Math.floor(index / gridSize);
          gridItem.dataset.col = index % gridSize;
          gridItem.dataset.flipped = 'false';
          gridItem.dataset.firstVisit = 'false'; // æ·»åŠ é¦–æ¬¡è®¿é—®æ ‡è®°

          // è®¡ç®—æ˜¯å¦æ˜¯ä¸­å¿ƒä½ç½®
          const centerRow = Math.floor(gridSize / 2);
          const centerCol = Math.floor(gridSize / 2);
          const isCenter = Math.floor(index / gridSize) === centerRow && index % gridSize === centerCol;

          // å¦‚æœæ˜¯ä¸­å¿ƒä½ç½®ï¼Œç›´æ¥ç¿»å¼€
          if (isCenter) {
            flipItem(gridItem, true);
          }

          // ä¸ºæ¯ä¸ªæ ¼å­æ·»åŠ ç‚¹å‡»äº‹ä»¶
          gridItem.addEventListener('click', function() {
            handleGridItemClick(this);
          });

          garbageGrid.appendChild(gridItem);
          gridItems.push(gridItem);
        });

        // ä¿å­˜å±é™©æ ¼å­åˆ—è¡¨ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
        const dangerItems = gridItems.filter(item => {
          const itemData = JSON.parse(item.dataset.item);
          return itemData.name === 'å—ä¼¤' || itemData.name === 'å‘•å';
        });
        
        // æ ¹æ®æœå¯»æŠ€èƒ½ç­‰çº§ç¡®å®šå¯æç¤ºçš„å±é™©æ ¼å­æ•°é‡
        let maxWarningCount = 0;
        const searchSkill = gameData.skills.search || { level: 0 };
        const searchLevel = searchSkill.level || 0;
        
        if (searchLevel >= 0 && searchLevel <= 4) {
          maxWarningCount = 1;
        } else if (searchLevel >= 5 && searchLevel <= 8) {
          maxWarningCount = 2;
        } else if (searchLevel >= 9) {
          maxWarningCount = 3;
        }
        
        // æ·»åŠ è°ƒè¯•æ—¥å¿—
        console.log('å±é™©æ ¼å­æ€»æ•°:', dangerItems.length);
        console.log('æœå¯»æŠ€èƒ½ç­‰çº§:', searchLevel);
        console.log('æœ€å¤§è­¦ç¤ºæ•°é‡:', maxWarningCount);
        
        // ä¿å­˜å±é™©æ ¼å­ä¿¡æ¯å’Œæœ€å¤§è­¦ç¤ºæ•°é‡åˆ°å…¨å±€å˜é‡
        window.garbageGameDangerItems = dangerItems;
        window.garbageGameMaxWarningCount = maxWarningCount;
        window.garbageGameWarningCount = 0; // è·Ÿè¸ªå·²ç»æ˜¾ç¤ºçš„è­¦ç¤ºæ•°é‡
      }

      // ç”Ÿæˆç¿»åƒåœ¾ç‰©å“
      function generateGarbageItems(totalItems) {
        const items = [];

        // æœ‰ä»·å€¼çš„ç‰©å“å¡ç‰Œ (40%å‡ ç‡)
        const valuableItems = [
          { type: 'positive', name: 'çªçªå¤´', effect: '+1çªçªå¤´' },
          { type: 'positive', name: 'æœ¨æ£', effect: '+1æœ¨æ£' },
          { type: 'positive', name: 'è‰è¯', effect: '+1è‰è¯' },
          { type: 'positive', name: 'é’±å¸', effect: '+1é’±å¸' }
        ];

        // æœ‰å®³çš„ç‰©å“å¡ç‰Œ (20%å‡ ç‡)
        const harmfulItems = [
          { type: 'negative', name: 'å—ä¼¤', effect: 'è·å¾—å—ä¼¤çŠ¶æ€' },
          { type: 'negative', name: 'å‘•å', effect: 'è·å¾—å‘•åçŠ¶æ€' }
        ];

        // ç©ºåŒºåŸŸ (40%å‡ ç‡)
        const emptyItem = { type: 'neutral', name: 'ç©º', effect: 'æ— ' };

        for (let i = 0; i < totalItems; i++) {
          const random = Math.random();
          if (random < 0.3) {
            // æœ‰ä»·å€¼çš„ç‰©å“
            items.push(randomChoice(valuableItems));
          } else if (random < 0.6) {
            // æœ‰å®³çš„ç‰©å“
            items.push(randomChoice(harmfulItems));
          } else {
            // ç©ºåŒºåŸŸ
            items.push(emptyItem);
          }
        }

        return items;
      }

      // éšæœºé€‰æ‹©å‡½æ•°
      function randomChoice(array) {
        return array[Math.floor(Math.random() * array.length)];
      }

      // æ‰“ä¹±æ•°ç»„å‡½æ•°
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }



      // ç¿»åƒåœ¾ç‰©å“
      function flipItem(itemElement, isCenter = false) {
        if (itemElement.classList.contains('flipped')) {
          return;
        }

        // è·å–æ ¼å­çš„è¡Œå’Œåˆ—
        const itemRow = parseInt(itemElement.dataset.row);
        const itemCol = parseInt(itemElement.dataset.col);
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¿»ç‰Œï¼ˆé™¤äº†ä¸­å¿ƒæ ¼å­ï¼Œå…¶ä»–æƒ…å†µç”±è°ƒç”¨æ–¹æ£€æŸ¥ï¼‰
        if (!isCenter && !checkCanFlip(itemRow, itemCol)) {
          return;
        }

        // æ‰§è¡Œç¿»ç‰Œæ“ä½œ
        const item = JSON.parse(itemElement.dataset.item);
        itemElement.classList.add('flipped');
        // ç§»é™¤è­¦ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
        itemElement.classList.remove('danger-tip');
        
        // ç§»é™¤ä¹‹å‰æ·»åŠ çš„æ„Ÿå¹å·å¡ç‰Œå†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const existingContent = itemElement.querySelector('.item-content');
        if (existingContent) {
          itemElement.removeChild(existingContent);
        }

        // æ·»åŠ ç‰©å“å†…å®¹
        const itemContent = document.createElement('div');
        itemContent.className = 'item-content';
        
        // æ·»åŠ å›¾ç‰‡æ˜¾ç¤º
        let itemImage = '';
        // ä¸ºæœ‰ä»·å€¼ç‰©å“å’Œæœ‰å®³ç‰©å“æ·»åŠ å¯¹åº”å¡ç‰Œå›¾ç‰‡
        if (item.type !== 'neutral') {
          // æ ¹æ®ç‰©å“åç§°è·å–å¯¹åº”çš„å¡ç‰Œå›¾ç‰‡
          let imageName = item.name;
          if (item.name === 'é£Ÿç‰©') {
            // é£Ÿç‰©ä½¿ç”¨çªçªå¤´ä½œä¸ºé»˜è®¤å›¾ç‰‡
            imageName = 'çªçªå¤´';
          }
          itemImage = `<img src="UI/${imageName}.jpg" alt="${item.name}" style="width: 25px; height: 25px; object-fit: cover; margin-bottom: 0.25rem;">`;
        }
        
        itemContent.innerHTML = `
          <div class="item-card">
            ${itemImage}
            <div class="item-name loot-item-${item.type}">${item.name}</div>
          </div>
        `;

        itemElement.appendChild(itemContent);

        // åº”ç”¨ç‰©å“æ•ˆæœ
        applyItemEffect(item);
      }

      // åº”ç”¨ç‰©å“æ•ˆæœ
      function applyItemEffect(item) {
        switch (item.name) {
          case 'çªçªå¤´':
            gameData.resources.food.amount++;
            break;
          case 'æœ¨æ£':
            gameData.resources.stick.amount++;
            break;
          case 'è‰è¯':
            gameData.resources.herb.amount++;
            break;
          case 'é’±å¸':
            gameData.resources.money.amount++;
            break;
          case 'å—ä¼¤':
            // æ£€æŸ¥æ¸¸æˆæ•°æ®ä¸­æ˜¯å¦æœ‰å¡ç‰Œç³»ç»Ÿ
            if (gameData.cards && Array.isArray(gameData.cards)) {
              // æ·»åŠ å—ä¼¤å¡ç‰Œ
              gameData.cards.push('å—ä¼¤');
            } else if (gameData.status) {
              // å¦‚æœæ²¡æœ‰å¡ç‰Œç³»ç»Ÿï¼Œç›´æ¥å‡å°‘å¥åº·å€¼
              gameData.status.health -= 3;
            }
            break;
          case 'å‘•å':
            // æ£€æŸ¥æ¸¸æˆæ•°æ®ä¸­æ˜¯å¦æœ‰å¡ç‰Œç³»ç»Ÿ
            if (gameData.cards && Array.isArray(gameData.cards)) {
              // æ·»åŠ å‘•åå¡ç‰Œ
              gameData.cards.push('å‘•å');
            } else if (gameData.status) {
              // å¦‚æœæ²¡æœ‰å¡ç‰Œç³»ç»Ÿï¼Œç›´æ¥å‡å°‘å¥åº·å€¼
              gameData.status.health -= 2;
            }
            break;
          // ç©ºåŒºåŸŸä¸éœ€è¦å¤„ç†
        }

        // æ›´æ–°æ¸¸æˆæ•°æ®
        updateGameData();
      }

      // ç»“æŸç¿»åƒåœ¾æ¸¸æˆ
      function endGarbageGame() {
        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
        if (window.currentGarbageGameKeyboardListener) {
          document.removeEventListener('keydown', window.currentGarbageGameKeyboardListener);
          delete window.currentGarbageGameKeyboardListener;
        }
        
        // æ”¶é›†ç»“æœå¹¶æ˜¾ç¤ºå¼¹çª—
        showLootResultsModal();

        // å…³é—­ç¿»åƒåœ¾æ¸¸æˆçª—å£
        const garbageModal = document.querySelector('.garbage-game-modal');
        const style = document.querySelector('style[innerText*="garbage-game-modal"]');
        if (garbageModal) {
          garbageModal.classList.add('closing');
          setTimeout(() => {
            if (garbageModal.parentNode) {
              garbageModal.parentNode.removeChild(garbageModal);
            }
            if (style && style.parentNode) {
              style.parentNode.removeChild(style);
            }
          }, 300);
        }
      }

      // æ˜¾ç¤ºç¿»åƒåœ¾ç»“æœå¼¹çª—
      function showLootResultsModal() {
        const flippedItems = document.querySelectorAll('.garbage-grid-item.flipped');
        const results = [];

        flippedItems.forEach(item => {
          const itemData = JSON.parse(item.dataset.item);
          results.push(itemData);
        });

        // ç»Ÿè®¡ç»“æœ - åªç»Ÿè®¡æœ‰ä»·å€¼çš„ç‰©å“
        const valuableItems = results.filter(item => item.type === 'positive');
        
        // è®¡ç®—å„ç§æœ‰ä»·å€¼ç‰©å“çš„æ•°é‡
        const itemCounts = {};
        
        valuableItems.forEach(item => {
          // æ ¹æ®ç‰©å“åç§°è·å–å¯¹åº”çš„èµ„æºID
          const resourceId = Object.keys(gameData.resources).find(id => gameData.resources[id].name === item.name);
          
          // å°†ç‰©å“æ·»åŠ åˆ°èƒŒåŒ…ä¸­
          if (resourceId) {
            gameData.resources[resourceId].amount += 1;
          }
          
          // ç»Ÿè®¡æ•°é‡
          itemCounts[item.name] = (itemCounts[item.name] || 0) + 1;
        });
        
        // æ›´æ–°èƒŒåŒ…UI
        renderResources();

        // åˆ›å»ºç»“æœå¼¹çª—
        const resultsModal = document.createElement('div');
        resultsModal.className = 'loot-results-modal';
        
        // æ·»åŠ ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­åŠŸèƒ½
        resultsModal.addEventListener('click', function(e) {
          // å¦‚æœç‚¹å‡»çš„æ˜¯æ¨¡æ€æ¡†æœ¬èº«è€Œä¸æ˜¯å†…å®¹åŒºåŸŸï¼Œåˆ™å…³é—­
          if (e.target === resultsModal) {
            resultsModal.remove();
          }
        });
        
        // ç”Ÿæˆç»“æœHTML
        let resultHTML = `
          <div class="loot-results-content">
            <h3 class="loot-results-title">ç¿»åƒåœ¾æ”¶è·</h3>
            <div class="loot-results-items">
        `;
        
        if (valuableItems.length > 0) {
          Object.entries(itemCounts).forEach(([itemName, count]) => {
            // ç¡®å®šç‰©å“å›¾ç‰‡
            let imageName = itemName;
            
            resultHTML += `
              <div class="loot-result-item">
                <img src="UI/${imageName}.jpg" alt="${itemName}" class="loot-result-image">
                <div class="loot-result-info">
                  <div class="loot-result-name">${itemName}</div>
                  <div class="loot-result-count">Ã— ${count}</div>
                </div>
              </div>
            `;
          });
        } else {
          resultHTML += `
            <div class="loot-no-results">
              <p>æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰ä»·å€¼çš„ç‰©å“ã€‚</p>
            </div>
          `;
        }
        
        resultHTML += `
            </div>
            <button class="loot-results-close" onclick="this.parentNode.parentNode.remove()">ç¡®å®š</button>
          </div>
        `;
        
        resultsModal.innerHTML = resultHTML;
        
        // æ·»åŠ ç»“æœå¼¹çª—CSS
        const resultsStyle = document.createElement('style');
        resultsStyle.textContent = `
          .loot-results-modal {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            animation: fadeIn 0.3s ease;
          }
          
          .loot-results-content {
            background-color: #F7FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            max-width: 400px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            /* ç¡®ä¿æ»šåŠ¨æ¡å¯è§ */
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
          }
          
          /* Webkitæ»šåŠ¨æ¡æ ·å¼ */
          .loot-results-content::-webkit-scrollbar {
            width: 8px;
          }
          
          .loot-results-content::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 4px;
          }
          
          .loot-results-content::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 4px;
          }
          
          .loot-results-content::-webkit-scrollbar-thumb:hover {
            background-color: #a0aec0;
          }
          
          .loot-results-title {
            color: #1A202C;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
          }
          
          .loot-results-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
          }
          
          .loot-result-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: #EDF2F7;
            border-radius: 0.375rem;
          }
          
          .loot-result-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.25rem;
          }
          
          .loot-result-info {
            flex: 1;
            text-align: left;
          }
          
          .loot-result-name {
            color: #2D3748;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
          }
          
          .loot-result-count {
            color: #4A5568;
            font-size: 0.75rem;
          }
          
          .loot-no-results {
            padding: 1.5rem;
            color: #4A5568;
            font-size: 0.875rem;
          }
          
          .loot-results-close {
            background-color: #3182CE;
            color: white;
            padding: 0.5rem 1.25rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
            border: none;
            font-size: 0.875rem;
          }
          
          .loot-results-close:hover {
            background-color: #2C5282;
          }
        `;
        
        // å°†å¼¹çª—å’Œæ ·å¼æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(resultsStyle);
        document.body.appendChild(resultsModal);
      }
    }
</script>
</body>
</html>
